<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-shell-state-provider-guide" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Shell State Provider Integration Guide | Idle Engine Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hansjm10.github.io/Idle-Game-Engine/shell-state-provider-guide"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Shell State Provider Integration Guide | Idle Engine Docs"><meta data-rh="true" name="description" content="How presentation-shell modules consume ShellStateProvider hooks, diagnostics, and social command flows."><meta data-rh="true" property="og:description" content="How presentation-shell modules consume ShellStateProvider hooks, diagnostics, and social command flows."><link data-rh="true" rel="icon" href="/Idle-Game-Engine/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hansjm10.github.io/Idle-Game-Engine/shell-state-provider-guide"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/shell-state-provider-guide" hreflang="en"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/shell-state-provider-guide" hreflang="x-default"><link rel="stylesheet" href="/Idle-Game-Engine/assets/css/styles.ddf7989c.css">
<script src="/Idle-Game-Engine/assets/js/runtime~main.9d885ff1.js" defer="defer"></script>
<script src="/Idle-Game-Engine/assets/js/main.5f01a812.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Idle-Game-Engine/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_li4T" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Idle-Game-Engine/"><div class="navbar__logo"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--light_vaEm"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--dark_axH8"></div><b class="navbar__title text--truncate">Idle Engine</b></a><a class="navbar__item navbar__link" href="/Idle-Game-Engine/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle__Exw colorModeToggle_Lslw"><button class="clean-btn toggleButton_AMBK toggleButtonDisabled_p4Bd" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 lightToggleIcon_p2sk"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 darkToggleIcon_B2qX"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 systemToggleIcon_PWgn"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_RKai"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_nqaE"><div class="docsWrapper_CSLE"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sOWX" type="button"></button><div class="docRoot_qxtV"><main class="docMainContainer_tfRv docMainContainerEnhanced_qAvX"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_hyci"><div class="docItemContainer_tcAC"><article><div class="tocCollapsible_WMbj theme-doc-toc-mobile tocMobile_wI3e"><button type="button" class="clean-btn tocCollapsibleButton_rjEa">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Shell State Provider Integration Guide</h1></header>
<p>This guide fulfils the documentation follow-up in <a class="" href="/Idle-Game-Engine/shell-state-provider-design#14-follow-up-work">docs/shell-state-provider-design.md §14</a>. It explains how React modules integrate with the shared Shell state context, tying every step back to the approved design so contributors can migrate safely.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="before-you-start">Before You Start<a href="#before-you-start" class="hash-link" aria-label="Direct link to Before You Start" title="Direct link to Before You Start" translate="no">​</a></h2>
<ul>
<li class="">Review the design’s architecture notes, especially <a class="" href="/Idle-Game-Engine/shell-state-provider-design#62-detailed-design">§6.2 Detailed Design</a> for API contracts and <a class="" href="/Idle-Game-Engine/shell-state-provider-design#73-coordination-notes">§7.3 Coordination Notes</a> for affected modules.</li>
<li class="">Scan the migration expectations in <a class="" href="/Idle-Game-Engine/shell-state-provider-design#12-rollout-plan">§12 Rollout Plan</a> so your rollout matches the planned sequencing.</li>
<li class="">Ensure local setup matches the repository guidelines (Node ≥20.10, pnpm ≥8) and that you can run <code>pnpm lint</code>, <code>pnpm test</code>, and <code>pnpm test:a11y</code> without failures.</li>
<li class="">Keep these files handy while implementing:<!-- -->
<ul>
<li class=""><code>packages/shell-web/src/modules/ShellStateProvider.tsx</code></li>
<li class=""><code>packages/shell-web/src/modules/shell-state.types.ts</code></li>
<li class=""><code>packages/shell-web/src/modules/shell-state-store.ts</code></li>
<li class=""><code>packages/shell-web/src/modules/App.tsx</code> (reference implementation)</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="1-map-the-provider-surface">1. Map the Provider Surface<a href="#1-map-the-provider-surface" class="hash-link" aria-label="Direct link to 1. Map the Provider Surface" title="Direct link to 1. Map the Provider Surface" translate="no">​</a></h2>
<p>The provider colocates runtime snapshots, bridge commands, diagnostics, and social metadata behind a trio of hooks. Each hook throws if used outside the provider boundary, so ensure your component tree mounts <code>&lt;ShellStateProvider&gt;</code> near the shell root.</p>
<table><thead><tr><th>Hook</th><th>Purpose</th><th>Common Uses</th></tr></thead><tbody><tr><td><code>useShellState()</code></td><td>Exposes aggregated runtime, bridge, social, and diagnostics state.</td><td>Rendering ticks, event history, back-pressure metrics, pending social requests.</td></tr><tr><td><code>useShellBridge()</code></td><td>Wraps worker bridge commands (<code>awaitReady</code>, <code>sendCommand</code>, <code>sendSocialCommand</code>, <code>restoreSession</code>, <code>isSocialFeatureEnabled</code>).</td><td>Dispatch runtime commands, kick off session restore, gate social UI.</td></tr><tr><td><code>useShellDiagnostics()</code></td><td>Manages diagnostics subscription lifecycle and mirrors diagnostics timeline state.</td><td>Enable profiling panels, stream timeline updates to charts.</td></tr></tbody></table>
<blockquote>
<p><strong>Design tie-back:</strong> These hooks implement the API contract committed in <a class="" href="/Idle-Game-Engine/shell-state-provider-design#62-detailed-design">design §6.2</a>. Avoid importing <code>useWorkerBridge</code> directly—doing so reintroduces the fragmentation called out in the problem statement.</p>
</blockquote>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="provider-configuration">Provider Configuration<a href="#provider-configuration" class="hash-link" aria-label="Direct link to Provider Configuration" title="Direct link to Provider Configuration" translate="no">​</a></h3>
<p><code>ShellStateProvider</code> accepts optional configuration that mirrors the reducer defaults in <code>shell-state-store.ts</code>:</p>
<div class="language-tsx codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_mZSc">packages/shell-web/src/modules/App.tsx</div><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-tsx codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">EVENT_HISTORY_LIMIT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">App</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">ShellStateProvider</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">maxEventHistory</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript constant" style="color:#36acaa">EVENT_HISTORY_LIMIT</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">ShellAppSurface</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag class-name" style="color:#00009f">ShellStateProvider</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ul>
<li class=""><code>maxEventHistory</code> defaults to <code>DEFAULT_MAX_EVENT_HISTORY</code> (200) and bounds the FIFO snapshot window (see <a class="" href="/Idle-Game-Engine/shell-state-provider-design#13-resolved-questions">design §13</a>).</li>
<li class=""><code>maxErrorHistory</code> defaults to <code>DEFAULT_MAX_ERROR_HISTORY</code> and caps telemetry-visible bridge errors.</li>
<li class="">Only tune these limits when UX requirements demand it; keep the defaults aligned with runtime determinism guarantees.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="restore-payloads">Restore Payloads<a href="#restore-payloads" class="hash-link" aria-label="Direct link to Restore Payloads" title="Direct link to Restore Payloads" translate="no">​</a></h3>
<p>If you need to hydrate from a saved session, pass a <code>restorePayload</code> prop. The provider invokes <code>restoreSession(payload)</code> on mount and again whenever the <code>restorePayload</code> reference changes, surfacing loading state through <code>ShellState.bridge.isRestoring</code>. Keep the payload stable (e.g., via <code>useMemo</code>) unless you intend to trigger another restore. Catch errors via telemetry (<code>ShellStateProviderRestoreFailed</code> / <code>ShellStateProviderRestoreEffectFailed</code>) instead of wrapping restore in component-level try/catch. This behaviour matches the session flow described in <a class="" href="/Idle-Game-Engine/shell-state-provider-design#62-detailed-design">design §6.2 APIs &amp; Contracts</a>.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="2-consume-runtime-state">2. Consume Runtime State<a href="#2-consume-runtime-state" class="hash-link" aria-label="Direct link to 2. Consume Runtime State" title="Direct link to 2. Consume Runtime State" translate="no">​</a></h2>
<p><code>ShellState.runtime</code> exposes a derived snapshot assembled in the reducer. Typical patterns:</p>
<div class="language-tsx codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-tsx codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports"> useShellState </span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;@idle-engine/shell-web&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">TickCounter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">JSX</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">Element</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    runtime</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> currentStep</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> events</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> backPressure </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useShellState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">section</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">h2</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">Runtime</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">h2</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">p</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">Current deterministic step: </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">currentStep</span><span class="token punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">p</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">p</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">Events in buffer: </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">events</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">length</span><span class="token punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">p</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">backPressure </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">p</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">Soft limited channels: </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">backPressure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">counters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">softLimited</span><span class="token punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">p</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">section</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ul>
<li class="">Treat values as read-only snapshots. Mutating event payloads breaks determinism.</li>
<li class="">When you need the latest worker frame, rely on <code>runtime.lastSnapshot</code> rather than storing your own reference.</li>
<li class="">Use the existing selectors or derive new data in memoised components—avoid extending the reducer unless the design explicitly calls for it.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="3-dispatch-commands-through-the-bridge">3. Dispatch Commands Through the Bridge<a href="#3-dispatch-commands-through-the-bridge" class="hash-link" aria-label="Direct link to 3. Dispatch Commands Through the Bridge" title="Direct link to 3. Dispatch Commands Through the Bridge" translate="no">​</a></h2>
<p><code>useShellBridge()</code> wraps <code>useWorkerBridge</code> with telemetry-aware helpers:</p>
<div class="language-tsx codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-tsx codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> bridge </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useShellBridge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">handlePing</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> bridge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">awaitReady</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bridge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">sendCommand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;PING&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> issuedAt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">performance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<ul>
<li class="">Always call <code>awaitReady()</code> before the first command or social operation to honour the worker handshake. Failed awaits raise <code>ShellStateProviderAwaitReadyFailed</code>.</li>
<li class="">For social operations, prefer <code>sendSocialCommand(kind, payload)</code>. The provider tracks optimistic state in <code>ShellState.social.pendingRequests</code> and records telemetry if the worker responds with domain-specific errors (<code>ShellStateProviderSocialCommandFailed</code>). Display <code>ShellState.social.lastFailure</code> to keep the operator informed.</li>
<li class="">When gating UI on feature availability, use <code>bridge.isSocialFeatureEnabled()</code> rather than importing feature flags manually—the bridge reflects the env toggle documented in <a class="" href="/Idle-Game-Engine/runtime-worker-bridge-runbook#33-configuration-knobs">Runtime-&gt;React Worker Bridge Runbook §3.3 Configuration Knobs</a>.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="4-integrate-diagnostics">4. Integrate Diagnostics<a href="#4-integrate-diagnostics" class="hash-link" aria-label="Direct link to 4. Integrate Diagnostics" title="Direct link to 4. Integrate Diagnostics" translate="no">​</a></h2>
<p>Diagnostics fan out to subscribers while the provider manages worker reference counting:</p>
<div class="language-tsx codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-tsx codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> latest</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> subscribe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> isEnabled </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useShellDiagnostics</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">useEffect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> unsubscribe </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timeline</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Render charts or persist snapshots.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> unsubscribe</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">subscribe</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<ul>
<li class="">Subscribing automatically calls <code>bridge.enableDiagnostics()</code> when the first listener registers and disables diagnostics when the last listener unsubscribes (guarding the risk listed in <a class="" href="/Idle-Game-Engine/shell-state-provider-design#11-risks--mitigations">design §11</a>). Use <code>isEnabled</code> to reflect UI state, not to skip subscription.</li>
<li class="">Guard subscription callbacks; exceptions are reported as <code>ShellStateProviderDiagnosticsSubscriberError</code> with phase metadata.</li>
<li class="">Access <code>latest</code> for immediate renders—<code>subscribe</code> emits the current timeline before the worker sends updates.</li>
</ul>
<p>Implementation notes</p>
<ul>
<li class="">Do not dispatch or call setState from effect cleanup functions. The provider reconciles diagnostics subscriber membership after commit using a deferred effect keyed by an internal epoch, then toggles diagnostics only on 0↔1 transitions. This avoids React’s “Maximum update depth exceeded” loop when panels mount/unmount quickly.</li>
<li class="">The a11y smoke suite includes a diagnostics toggle test that repeatedly opens/closes the panel and asserts no console errors. Run <code>pnpm test:a11y</code> after changing diagnostics UI or provider internals.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="5-migration-checklist">5. Migration Checklist<a href="#5-migration-checklist" class="hash-link" aria-label="Direct link to 5. Migration Checklist" title="Direct link to 5. Migration Checklist" translate="no">​</a></h2>
<p>When upgrading an existing module:</p>
<ol>
<li class="">Wrap the surface with <code>&lt;ShellStateProvider&gt;</code> (usually in <code>App.tsx</code>) and remove direct calls to <code>useWorkerBridge</code>.</li>
<li class="">Replace custom state stores with <code>useShellState()</code> selectors. Keep derived state colocated with components to avoid reintroducing shared mutable caches.</li>
<li class="">Swap manual telemetry hooks for the provider-managed versions—telemetry payload keys already match the design’s schema.</li>
<li class="">Confirm diagnostics panels use <code>useShellDiagnostics()</code> and drop obsolete bridge <code>enableDiagnostics()/disableDiagnostics()</code> wiring.</li>
<li class="">Update tests to mount the provider around components under test. Reuse helpers from <code>ShellStateProvider.telemetry.test.tsx</code> when mocking the worker.</li>
</ol>
<p>This sequence mirrors the rollout plan in <a class="" href="/Idle-Game-Engine/shell-state-provider-design#12-rollout-plan">design §12</a> and the coordination guidance in <a class="" href="/Idle-Game-Engine/shell-state-provider-design#73-coordination-notes">§7.3</a>.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="6-validation--tooling">6. Validation &amp; Tooling<a href="#6-validation--tooling" class="hash-link" aria-label="Direct link to 6. Validation &amp; Tooling" title="Direct link to 6. Validation &amp; Tooling" translate="no">​</a></h2>
<p>After changes:</p>
<div class="language-bash codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-bash codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token plain">pnpm lint --filter shell-web</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pnpm test --filter shell-web</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Run when diagnostics or UI flows change per design guardrails.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pnpm test:a11y</span><br></span></code></pre></div></div>
<ul>
<li class="">The Vitest suites (e.g., <code>ShellStateProvider.telemetry.test.tsx</code>) assert telemetry coverage promised in <a class="" href="/Idle-Game-Engine/shell-state-provider-design#62-detailed-design">design §6.2</a>. Extend them if you introduce new reducer events or telemetry codes.</li>
<li class="">Keep console output clean so the <code>vitest-llm-reporter</code> summary remains parseable.</li>
</ul>
<p>If you uncover provider gaps (new reducer cases, telemetry fields, or diagnostics channels), document assumptions in your PR and sync with the Presentation Shell Lead as outlined in <a class="" href="/Idle-Game-Engine/shell-state-provider-design#73-coordination-notes">design §7.3 Coordination Notes</a>.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="7-reference-summary">7. Reference Summary<a href="#7-reference-summary" class="hash-link" aria-label="Direct link to 7. Reference Summary" title="Direct link to 7. Reference Summary" translate="no">​</a></h2>
<table><thead><tr><th>Topic</th><th>Source</th></tr></thead><tbody><tr><td>Provider architecture, APIs, risks</td><td><a class="" href="/Idle-Game-Engine/shell-state-provider-design">Shell State Provider Design</a></td></tr><tr><td>Worker bridge contracts</td><td><a class="" href="/Idle-Game-Engine/runtime-react-worker-bridge-design">Runtime React Worker Bridge Design</a></td></tr><tr><td>Accessibility smoke expectations</td><td><a class="" href="/Idle-Game-Engine/accessibility-smoke-tests-design">Accessibility Smoke Tests Design</a></td></tr><tr><td>Existing provider usage</td><td><code>packages/shell-web/src/modules/App.tsx</code>, <code>packages/shell-web/src/modules/EventInspector.tsx</code>, <code>packages/shell-web/src/modules/SocialDevPanel.tsx</code></td></tr></tbody></table>
<p>Keep this guide updated as the provider evolves so future contributors inherit current integration practices.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_QKxP"><a href="https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/shell-state-provider-guide.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_wOWh" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_Basj"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_AUZ0 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#before-you-start" class="table-of-contents__link toc-highlight">Before You Start</a></li><li><a href="#1-map-the-provider-surface" class="table-of-contents__link toc-highlight">1. Map the Provider Surface</a><ul><li><a href="#provider-configuration" class="table-of-contents__link toc-highlight">Provider Configuration</a></li><li><a href="#restore-payloads" class="table-of-contents__link toc-highlight">Restore Payloads</a></li></ul></li><li><a href="#2-consume-runtime-state" class="table-of-contents__link toc-highlight">2. Consume Runtime State</a></li><li><a href="#3-dispatch-commands-through-the-bridge" class="table-of-contents__link toc-highlight">3. Dispatch Commands Through the Bridge</a></li><li><a href="#4-integrate-diagnostics" class="table-of-contents__link toc-highlight">4. Integrate Diagnostics</a></li><li><a href="#5-migration-checklist" class="table-of-contents__link toc-highlight">5. Migration Checklist</a></li><li><a href="#6-validation--tooling" class="table-of-contents__link toc-highlight">6. Validation &amp; Tooling</a></li><li><a href="#7-reference-summary" class="table-of-contents__link toc-highlight">7. Reference Summary</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/contributor-handbook">Contributor Handbook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Idle Engine.</div></div></div></footer></div>
</body>
</html>