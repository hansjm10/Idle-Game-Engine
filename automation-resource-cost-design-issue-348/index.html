<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-automation-resource-cost-design-issue-348" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Automation System — Enforce and Deduct Automation resourceCost (issue-348) | Idle Engine Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hansjm10.github.io/Idle-Game-Engine/automation-resource-cost-design-issue-348"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Automation System — Enforce and Deduct Automation resourceCost (issue-348) | Idle Engine Docs"><meta data-rh="true" name="description" content="Document Control"><meta data-rh="true" property="og:description" content="Document Control"><link data-rh="true" rel="icon" href="/Idle-Game-Engine/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hansjm10.github.io/Idle-Game-Engine/automation-resource-cost-design-issue-348"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/automation-resource-cost-design-issue-348" hreflang="en"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/automation-resource-cost-design-issue-348" hreflang="x-default"><link rel="stylesheet" href="/Idle-Game-Engine/assets/css/styles.ddf7989c.css">
<script src="/Idle-Game-Engine/assets/js/runtime~main.38f92bbd.js" defer="defer"></script>
<script src="/Idle-Game-Engine/assets/js/main.267f9d33.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Idle-Game-Engine/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_li4T" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Idle-Game-Engine/"><div class="navbar__logo"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--light_vaEm"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--dark_axH8"></div><b class="navbar__title text--truncate">Idle Engine</b></a><a class="navbar__item navbar__link" href="/Idle-Game-Engine/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle__Exw colorModeToggle_Lslw"><button class="clean-btn toggleButton_AMBK toggleButtonDisabled_p4Bd" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 lightToggleIcon_p2sk"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 darkToggleIcon_B2qX"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 systemToggleIcon_PWgn"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_RKai"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_nqaE"><div class="docsWrapper_CSLE"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sOWX" type="button"></button><div class="docRoot_qxtV"><main class="docMainContainer_tfRv docMainContainerEnhanced_qAvX"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_hyci"><div class="docItemContainer_tcAC"><article><div class="tocCollapsible_WMbj theme-doc-toc-mobile tocMobile_wI3e"><button type="button" class="clean-btn tocCollapsibleButton_rjEa">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Automation System — Enforce and Deduct Automation resourceCost (issue-348)</h1></header><h2 class="anchor anchorTargetStickyNavbar_EdDC" id="document-control">Document Control<a href="#document-control" class="hash-link" aria-label="Direct link to Document Control" title="Direct link to Document Control" translate="no">​</a></h2>
<ul>
<li class="">Title: Enforce and deduct automation resourceCost at trigger time (issue-348)</li>
<li class="">Authors: Design-Authoring Agent (AI)</li>
<li class="">Reviewers: Jordan Hans (hansjm10), Core Runtime Maintainers</li>
<li class="">Status: Draft</li>
<li class="">Last Updated: 2025-11-09</li>
<li class="">Related Issues: <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/348" target="_blank" rel="noopener noreferrer" class="">https://github.com/hansjm10/Idle-Game-Engine/issues/348</a></li>
<li class="">Execution Mode: AI-led</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="1-summary">1. Summary<a href="#1-summary" class="hash-link" aria-label="Direct link to 1. Summary" title="Direct link to 1. Summary" translate="no">​</a></h2>
<p>issue-348 addresses a gap in the automation system: automations that declare a resourceCost currently fire regardless of player resources and never deduct the cost. This design introduces deterministic, atomic cost validation and deduction at automation fire-time. When a trigger evaluates true, the runtime will compute the cost (supporting constant numeric formulas initially), check affordability, and either spend and schedule the command (success) or skip without cooldown (insufficient funds). For event-triggered automations, a failed spend preserves the pending event (it is not cleared), so the automation can retry automatically on the next tick once resources exist. For resource-threshold automations, a failed spend must not consume the false→true crossing; the runtime defers or reverts the <code>lastThresholdSatisfied</code> update on failure so these automations retrigger automatically while the threshold remains satisfied. The change restores content-author intent, prevents misleading UX, and enables sample content to reintroduce automation costs.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="2-context--problem-statement">2. Context &amp; Problem Statement<a href="#2-context--problem-statement" class="hash-link" aria-label="Direct link to 2. Context &amp; Problem Statement" title="Direct link to 2. Context &amp; Problem Statement" translate="no">​</a></h2>
<ul>
<li class="">Background:<!-- -->
<ul>
<li class="">The automation system supports interval, resourceThreshold, commandQueueEmpty, and event triggers with deterministic step-based evaluation. See packages/core/src/automation-system.ts.</li>
<li class="">A TODO exists to implement resourceCost in the fire path: packages/core/src/automation-system.ts:302.</li>
<li class="">Content schema already defines resourceCost: resourceId + rate (NumericFormula). See packages/content-schema/src/modules/automations.ts:95–110.</li>
<li class="">ResourceState supports atomic spending with guards: packages/core/src/resource-state.ts:136–160.</li>
</ul>
</li>
<li class="">Problem:<!-- -->
<ul>
<li class="">Automations ignore resourceCost; triggers enqueue regardless of resources and never deduct. This breaks author expectations and misleads players. Sample pack removed costed automations to avoid confusion; e.g., sample-pack.auto-reactor-burst (no resourceCost present) in packages/content-sample/content/pack.json:366–380.</li>
</ul>
</li>
<li class="">Forces:<!-- -->
<ul>
<li class="">Determinism: spend + enqueue must be atomic within a tick.</li>
<li class="">Back-compat: existing content without resourceCost must be unaffected.</li>
<li class="">Performance: negligible overhead on tick paths.</li>
<li class="">Scope: issue-348 asks for constant numeric formula evaluation initially; defer advanced formulas and multi-resource costs.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="3-goals--non-goals">3. Goals &amp; Non-Goals<a href="#3-goals--non-goals" class="hash-link" aria-label="Direct link to 3. Goals &amp; Non-Goals" title="Direct link to 3. Goals &amp; Non-Goals" translate="no">​</a></h2>
<ul>
<li class="">Goals:<!-- -->
<ul>
<li class="">Enforce resourceCost semantics for automations (evaluate, afford check, deduct) per issue-348.</li>
<li class="">Maintain deterministic replays: spend and enqueue occur in the same step and are recorded consistently.</li>
<li class="">Skip cooldown on failed spend; update state only on success.</li>
<li class="">Event triggers: preserve pending event on failed spend so it can retry.</li>
<li class="">Unit tests covering success, failure, cooldown, and interaction with existing triggers.</li>
<li class="">Reintroduce resourceCost to sample content once support lands and update authoring docs.</li>
</ul>
</li>
<li class="">Non-Goals:<!-- -->
<ul>
<li class="">Multi-resource or conditional costs (out of scope).</li>
<li class="">Transactional command queue semantics or a generic SPEND_RESOURCE command (deferred).</li>
<li class="">UI changes beyond reflecting behavior through existing runtime state.</li>
<li class="">Extending beyond constant numeric formulas for this iteration.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="4-stakeholders-agents--impacted-surfaces">4. Stakeholders, Agents &amp; Impacted Surfaces<a href="#4-stakeholders-agents--impacted-surfaces" class="hash-link" aria-label="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" title="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" translate="no">​</a></h2>
<ul>
<li class="">Primary Stakeholders:<!-- -->
<ul>
<li class="">Core Runtime Team (packages/core)</li>
<li class="">Content Authors (packages/content-sample)</li>
<li class="">Docs/Developer Experience</li>
</ul>
</li>
<li class="">Agent Roles:<!-- -->
<ul>
<li class="">Runtime Implementation Agent: Implement cost-check/deduct and tests in packages/core.</li>
<li class="">Content Agent: Reintroduce resourceCost to sample automations and validate.</li>
<li class="">Docs Agent: Update docs/automation-authoring-guide.md and references.</li>
<li class="">QA/Test Agent: Ensure deterministic tests and coverage stability.</li>
<li class="">Release/CI Agent: Ensure lint/test/build/coverage pipelines pass and docs coverage regenerate.</li>
</ul>
</li>
<li class="">Affected Packages/Services:<!-- -->
<ul>
<li class="">packages/core (automation system, resource state, adapters)</li>
<li class="">packages/content-sample (restore costed automations)</li>
<li class="">packages/content-schema (already defines resourceCost; no schema change expected)</li>
<li class="">docs (authoring guide; coverage page regen)</li>
</ul>
</li>
<li class="">Compatibility Considerations:<!-- -->
<ul>
<li class="">No breaking changes for content without resourceCost.</li>
<li class="">New optional write access from automation to ResourceState must not leak outside controlled paths.</li>
<li class="">Generated dist/ outputs are not edited directly; build maintains them.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="5-current-state">5. Current State<a href="#5-current-state" class="hash-link" aria-label="Direct link to 5. Current State" title="Direct link to 5. Current State" translate="no">​</a></h2>
<ul>
<li class="">Automation evaluation:<!-- -->
<ul>
<li class="">Triggers and enqueue path implemented with deterministic steps and cooldowns. See packages/core/src/automation-system.ts:250–315 and 620–920.</li>
<li class="">Event trigger plumbing and threshold-crossing logic are implemented; threshold state updates occur during cooldown to avoid missed crossings. Today, threshold state is also updated immediately on detection of a crossing, before any cost deduction.</li>
</ul>
</li>
<li class="">Missing cost enforcement:<!-- -->
<ul>
<li class="">Explicit TODO: packages/core/src/automation-system.ts:302.</li>
<li class="">ResourceStateReader is read-only: packages/core/src/automation-system.ts:504–507.</li>
<li class="">Adapter bridges read-only access: packages/core/src/automation-resource-state-adapter.ts:1–45.</li>
</ul>
</li>
<li class="">Schema and docs:<!-- -->
<ul>
<li class="">resourceCost present in schema (rate: NumericFormula): packages/content-schema/src/modules/automations.ts:95–110, 183.</li>
<li class="">Authoring guide includes resourceCost examples: docs/automation-authoring-guide.md:41–49.</li>
</ul>
</li>
<li class="">Sample content gap:<!-- -->
<ul>
<li class="">Costed automations removed pending engine support: packages/content-sample/content/pack.json:366–399.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="6-proposed-solution">6. Proposed Solution<a href="#6-proposed-solution" class="hash-link" aria-label="Direct link to 6. Proposed Solution" title="Direct link to 6. Proposed Solution" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="61-architecture-overview">6.1 Architecture Overview<a href="#61-architecture-overview" class="hash-link" aria-label="Direct link to 6.1 Architecture Overview" title="Direct link to 6.1 Architecture Overview" translate="no">​</a></h3>
<ul>
<li class="">Narrative:<!-- -->
<ul>
<li class="">Extend automation’s tick path to evaluate automation.resourceCost.rate when a trigger fires. Resolve resourceId → index; if the index is unknown (-1), bail out and treat as unaffordable without attempting to spend. Otherwise, check affordability and attempt an atomic spend via ResourceState. If spend succeeds, enqueue the target command and advance cooldown/lastFired. If spend fails, do not enqueue and do not start cooldown.</li>
</ul>
</li>
<li class="">Diagram:<!-- -->
<ul>
<li class="">Trigger true → Resolve index → [unknown] skip (no cooldown) | [known] Evaluate cost → trySpend (atomic) → [success] enqueue + set lastFired + cooldown | [fail] skip without cooldown.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="62-detailed-design">6.2 Detailed Design<a href="#62-detailed-design" class="hash-link" aria-label="Direct link to 6.2 Detailed Design" title="Direct link to 6.2 Detailed Design" translate="no">​</a></h3>
<ul>
<li class="">Runtime Changes:<!-- -->
<ul>
<li class="">Introduce a write-capable accessor for automation:<!-- -->
<ul>
<li class="">Add an optional method to ResourceStateReader or define a new ResourceStateAccessor with:<!-- -->
<ul>
<li class=""><code>getAmount(index: number): number</code></li>
<li class=""><code>getResourceIndex?(id: string): number</code></li>
<li class=""><code>spendAmount(index: number, amount: number, context?: { systemId?: string; commandId?: string }): boolean</code></li>
</ul>
</li>
<li class="">Preferred: define ResourceStateAccessor and update AutomationSystemOptions.resourceState type to it. Adapter updated to forward spendAmount to ResourceState.spendAmount.</li>
</ul>
</li>
<li class="">Tick path modifications in createAutomationSystem():<!-- -->
<ul>
<li class="">After trigger evaluation and before enqueue (packages/core/src/automation-system.ts:298–309), implement:<!-- -->
<ul>
<li class="">If automation.resourceCost defined:<!-- -->
<ul>
<li class="">Resolve <code>index = getResourceIndex(resourceId)</code>.</li>
<li class="">If <code>index === -1</code> (unknown resource ID or not yet unlocked/initialized): treat as unaffordable and bail out before any spend attempt. Do not call <code>spendAmount</code> with an invalid index.</li>
<li class="">Evaluate <code>amount = evaluateNumericFormula(resourceCost.rate, { variables: { level: 0 } })</code>.</li>
<li class="">Clamp negatives to 0 (safety) and reject NaN/Infinity.</li>
<li class="">Attempt <code>spendAmount(index, amount, { systemId: &#x27;automation&#x27;, commandId: automation.id })</code>.</li>
<li class="">On <code>false</code>: continue without enqueue and without updating cooldown/lastFired.</li>
</ul>
</li>
</ul>
</li>
<li class="">Retry semantics for event and resource-threshold triggers:<!-- -->
<ul>
<li class="">Today, <code>pendingEventTriggers.clear()</code> at end of tick (packages/core/src/automation-system.ts:313) makes event triggers single-shot even if an automation skips due to unaffordable cost. To align with “skip without cooldown (retry when resources exist)”, preserve events that failed to spend.</li>
<li class="">Implementation approach:<!-- -->
<ul>
<li class="">Introduce a local <code>nextPendingEventTriggers = new Set&lt;string&gt;()</code> at the start of <code>tick</code>.</li>
<li class="">When evaluating an <code>event</code> trigger:<!-- -->
<ul>
<li class="">If it triggers and the cost spend succeeds → do not add the ID to <code>nextPendingEventTriggers</code> (event consumed).</li>
<li class="">If it triggers but the cost spend fails (or resource index unknown) → add <code>automation.id</code> to <code>nextPendingEventTriggers</code> (event retained).</li>
<li class="">If it does not trigger → do nothing.</li>
</ul>
</li>
<li class="">Replace the end-of-tick clear with a swap: <code>pendingEventTriggers.clear(); for (const id of nextPendingEventTriggers) pendingEventTriggers.add(id);</code></li>
</ul>
</li>
<li class="">Determinism: The set replacement is deterministic. Because IDs are unique, duplicates are not a concern.</li>
<li class="">Resource-threshold crossing semantics on cost failure:<!-- -->
<ul>
<li class="">Current engine behavior (<code>packages/core/src/automation-system.ts:275–288</code>) updates <code>state.lastThresholdSatisfied = currentlySatisfied</code> before any spend. If spend then fails, the crossing has been consumed and the automation will not fire again until the resource drops below and crosses back above the threshold.</li>
<li class="">Required change: when a crossing is detected (false→true), attempt the cost spend first and only set <code>state.lastThresholdSatisfied = true</code> if the spend succeeds. If the spend fails (or the resource index is unknown), keep <code>state.lastThresholdSatisfied = false</code> so the crossing remains pending and the automation retriggers automatically on subsequent ticks while the threshold remains satisfied. Do not start cooldown on failure.</li>
</ul>
</li>
<li class="">Scope: Interval and queue-empty triggers already naturally retrip; they require no special state handling beyond “skip without cooldown” on cost failure.</li>
<li class="">Else: proceed as today.</li>
</ul>
</li>
<li class="">Rationale:<!-- -->
<ul>
<li class=""><code>ResourceState.spendAmount</code> asserts a valid index and will throw on invalid input (see packages/core/src/resource-state.ts:666–706). The guard ensures invalid content cannot crash automation processing and fulfills the “fail-safe” intent by skipping gracefully.</li>
</ul>
</li>
<li class="">Reference pseudocode (cost + retries):<!-- -->
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Apply to all triggers with a resourceCost</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceCost</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> idx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> resourceState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getResourceIndex</span><span class="token operator" style="color:#393A34">?.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceCost</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">??</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">idx </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Unknown resource → unaffordable; skip without cooldown</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// If this was an event trigger, retain the event for next tick</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trigger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kind </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;event&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      nextPendingEventTriggers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> amount </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateNumericFormula</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceCost</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">Number</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isFinite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">amount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// reject NaN/Infinity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> spendOk </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> resourceState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">spendAmount</span><span class="token operator" style="color:#393A34">?.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">idx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> amount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> systemId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;automation&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> commandId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">spendOk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// unaffordable → skip; retain event if applicable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trigger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kind </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;event&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      nextPendingEventTriggers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// success → enqueue + update cooldown/lastFired</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ul>
<li class="">Resource-threshold state handling (two-phase update around cost):</li>
</ul>
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Before: engine updates lastThresholdSatisfied immediately (consumes crossing)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// After: defer update until after spend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trigger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kind </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;resourceThreshold&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> currently </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateResourceThresholdTrigger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resourceState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> previously </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lastThresholdSatisfied </span><span class="token operator" style="color:#393A34">??</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> crossing </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> currently </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">previously</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// false → true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">crossing</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Not a crossing → track current truth value for future crossings</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lastThresholdSatisfied </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> currently</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// no fire</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Crossing detected → attempt cost first</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> idx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> resourceState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getResourceIndex</span><span class="token operator" style="color:#393A34">?.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceCost</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">resourceId </span><span class="token operator" style="color:#393A34">??</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">??</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> amount </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceCost </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateNumericFormula</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceCost</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> ok </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceCost </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> idx </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> Number</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isFinite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">amount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> resourceState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">spendAmount</span><span class="token operator" style="color:#393A34">?.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">idx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> amount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> systemId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;automation&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> commandId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// no cost → treat as ok</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">ok</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Cost failure → do not consume the crossing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Keep lastThresholdSatisfied = false so it retriggers next tick while condition holds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lastThresholdSatisfied </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// If you also support event retention logic separately, that remains unchanged</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Spend succeeded → consume the crossing and fire</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lastThresholdSatisfied </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// enqueue + start cooldown...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
</li>
</ul>
</li>
<li class="">Determinism:<!-- -->
<ul>
<li class="">Use currentStep-derived timestamp (unchanged) and ensure spend + enqueue run within the same tick. No additional randomness or wall-clock interactions.</li>
</ul>
</li>
</ul>
</li>
<li class="">Data &amp; Schemas:<!-- -->
<ul>
<li class="">No schema changes. Use existing <code>resourceCost: { resourceId, rate: NumericFormula }</code>. Initial scope supports constant formulas.</li>
<li class="">Authoring doc clarifies that <code>rate</code> is interpreted as the per-fire spend amount.</li>
</ul>
</li>
<li class="">APIs &amp; Contracts:<!-- -->
<ul>
<li class="">Expose a new helper to build the accessor from a ResourceState:<!-- -->
<ul>
<li class="">Update packages/core/src/automation-resource-state-adapter.ts to include spendAmount pass-through when available.</li>
</ul>
</li>
<li class="">Backward compatibility: if spendAmount is unavailable (legacy wiring), automations with resourceCost act as if spend fails (skip) to avoid mischarging.</li>
</ul>
</li>
<li class="">Tooling &amp; Automation:<!-- -->
<ul>
<li class="">No CLI changes. Ensure lint and tests updated. Add targeted unit tests in packages/core next to implementation.</li>
<li class="">Tests must add/verify:<!-- -->
<ul>
<li class="">Event triggers are preserved when spend fails and consumed when spend succeeds.</li>
<li class="">Resource-threshold automations: on a false→true crossing with insufficient funds, the crossing is not consumed (retries every tick); once funds are available, the spend succeeds, action enqueues, cooldown starts, and <code>lastThresholdSatisfied</code> becomes true.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="63-operational-considerations">6.3 Operational Considerations<a href="#63-operational-considerations" class="hash-link" aria-label="Direct link to 6.3 Operational Considerations" title="Direct link to 6.3 Operational Considerations" translate="no">​</a></h3>
<ul>
<li class="">Deployment:<!-- -->
<ul>
<li class="">Regular release; no flags needed. Validate via CI. Generated dist/ checked in by build pipeline only (not manual).</li>
</ul>
</li>
<li class="">Telemetry &amp; Observability:<!-- -->
<ul>
<li class="">Optional: emit runtime events for spend success/failure in a future iteration. For now, rely on unit tests and state inspection.</li>
</ul>
</li>
<li class="">Security &amp; Compliance:<!-- -->
<ul>
<li class="">No PII. The change operates within simulation state. Maintain determinism and guard against negative/NaN costs.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="7-work-breakdown--delivery-plan">7. Work Breakdown &amp; Delivery Plan<a href="#7-work-breakdown--delivery-plan" class="hash-link" aria-label="Direct link to 7. Work Breakdown &amp; Delivery Plan" title="Direct link to 7. Work Breakdown &amp; Delivery Plan" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="71-issue-map">7.1 Issue Map<a href="#71-issue-map" class="hash-link" aria-label="Direct link to 7.1 Issue Map" title="Direct link to 7.1 Issue Map" translate="no">​</a></h3>
<table><thead><tr><th>Issue Title</th><th>Scope Summary</th><th>Proposed Assignee/Agent</th><th>Dependencies</th><th>Acceptance Criteria</th></tr></thead><tbody><tr><td>feat(core): automation resourceCost enforcement (issue-348)</td><td>Add cost evaluate+spend in tick before enqueue</td><td>Runtime Implementation Agent</td><td>None</td><td>Automations with insufficient funds do not enqueue; cooldown not started; with funds they spend and enqueue; resource-threshold crossings are not consumed on cost failure; tests pass</td></tr><tr><td>fix(core): retain event triggers on failed spend</td><td>Preserve event IDs across ticks when unaffordable</td><td>Runtime Implementation Agent</td><td>Core feature PR</td><td>Event-triggered automations reattempt once resources exist; tests cover retain/consume paths</td></tr><tr><td>refactor(core): ResourceState accessor + adapter</td><td>Introduce ResourceStateAccessor and update adapter to pass spendAmount</td><td>Runtime Implementation Agent</td><td>Core feature PR</td><td>Accessor wired; legacy read-only paths preserved; types exported; lint passes</td></tr><tr><td>test(core): automation cost unit tests</td><td>Add tests for success/failure, cooldown interaction, upgrade target fee</td><td>QA/Test Agent</td><td>Core feature PR</td><td>New tests in packages/core pass deterministically; coverage stable</td></tr><tr><td>docs: update automation authoring guide</td><td>Clarify resourceCost semantics and examples</td><td>Docs Agent</td><td>Core feature PR</td><td>docs/automation-authoring-guide.md updated; no broken links; a11y docs not impacted</td></tr><tr><td>content: reintroduce resourceCost in sample automations</td><td>Add costs to sample-pack.auto-reactor-burst and autobuy-reactor-insulation</td><td>Content Agent</td><td>Core feature PR</td><td>pack.json validates; tests unaffected; manual sanity via dev shell ok</td></tr><tr><td>chore(docs): regenerate coverage page</td><td>Update docs/coverage/index.md</td><td>Release/CI Agent</td><td>Tests merged</td><td>docs/coverage/index.md regenerated via pnpm coverage<!-- -->:md<!-- --> and committed</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="72-milestones">7.2 Milestones<a href="#72-milestones" class="hash-link" aria-label="Direct link to 7.2 Milestones" title="Direct link to 7.2 Milestones" translate="no">​</a></h3>
<ul>
<li class="">Phase 1: Core runtime change + tests (1–2 days)<!-- -->
<ul>
<li class="">Implement accessor + enforcement; add unit tests; CI green.</li>
</ul>
</li>
<li class="">Phase 2: Docs + content updates (0.5–1 day)<!-- -->
<ul>
<li class="">Update authoring guide; reintroduce sample costs; validate sample pack.</li>
</ul>
</li>
<li class="">Phase 3: Post-merge polish (future)<!-- -->
<ul>
<li class="">Consider telemetry events, multi-resource costs, and transactional SPEND_RESOURCE command.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="73-coordination-notes">7.3 Coordination Notes<a href="#73-coordination-notes" class="hash-link" aria-label="Direct link to 7.3 Coordination Notes" title="Direct link to 7.3 Coordination Notes" translate="no">​</a></h3>
<ul>
<li class="">Hand-off Package:<!-- -->
<ul>
<li class="">Source: packages/core/src/automation-system.ts:250–315, 490–560, 620–920; packages/core/src/automation-resource-state-adapter.ts; packages/core/src/resource-state.ts:136–160.</li>
<li class="">Content: packages/content-sample/content/pack.json:366–399.</li>
<li class="">Docs: docs/automation-authoring-guide.md:41–49.</li>
</ul>
</li>
<li class="">Communication Cadence:<!-- -->
<ul>
<li class="">Daily async status update; PR review within 24 hours; escalate blockers in issue-348 thread.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="8-agent-guidance--guardrails">8. Agent Guidance &amp; Guardrails<a href="#8-agent-guidance--guardrails" class="hash-link" aria-label="Direct link to 8. Agent Guidance &amp; Guardrails" title="Direct link to 8. Agent Guidance &amp; Guardrails" translate="no">​</a></h2>
<ul>
<li class="">Context Packets:<!-- -->
<ul>
<li class="">docs/design-document-template.md, docs/automation-authoring-guide.md, packages/core/src/automation-system.ts, packages/core/src/resource-state.ts, packages/core/src/automation-resource-state-adapter.ts, packages/content-schema/src/modules/automations.ts, packages/content-sample/content/pack.json, pnpm-workspace.yaml.</li>
</ul>
</li>
<li class="">Prompting &amp; Constraints:<!-- -->
<ul>
<li class="">Use Conventional Commits; TypeScript, ES modules, two-space indentation; camelCase; co-locate tests.</li>
<li class="">Follow AGENTS.md: do not edit generated dist/ by hand; keep changes minimal and focused.</li>
</ul>
</li>
<li class="">Safety Rails:<!-- -->
<ul>
<li class="">Do not reset git history or force-push over reviewed changes.</li>
<li class="">Preserve determinism; avoid console noise that could corrupt vitest JSON reporter output.</li>
<li class="">Validate schema invariants; clamp/guard negative, NaN, Infinity costs.</li>
</ul>
</li>
<li class="">Validation Hooks:<!-- -->
<ul>
<li class="">pnpm install</li>
<li class="">pnpm lint</li>
<li class="">pnpm test --filter @idle-engine/core</li>
<li class="">pnpm test</li>
<li class="">pnpm coverage<!-- -->:md<!-- --> (commit docs/coverage/index.md only)</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="9-alternatives-considered">9. Alternatives Considered<a href="#9-alternatives-considered" class="hash-link" aria-label="Direct link to 9. Alternatives Considered" title="Direct link to 9. Alternatives Considered" translate="no">​</a></h2>
<ul>
<li class="">Option B: Pre-enqueue SPEND_RESOURCE command at AUTOMATION priority<!-- -->
<ul>
<li class="">Pros: Centralizes spending semantics; reuse for other systems.</li>
<li class="">Cons: Requires transactional semantics to avoid race conditions; more invasive changes to command execution order and failure handling.</li>
</ul>
</li>
<li class="">Evaluate cost at command-execution time<!-- -->
<ul>
<li class="">Pros: Reuses existing command handlers.</li>
<li class="">Cons: Breaks the author expectation that automation “fires” only when affordable; complicates cooldown semantics and determinism of “did it fire?”.</li>
</ul>
</li>
<li class="">Keep ResourceStateReader read-only and perform “preflight” only<!-- -->
<ul>
<li class="">Pros: Minimal code changes.</li>
<li class="">Cons: Non-atomic; may enqueue while affordability changes between trigger and execution; undermines determinism.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="10-testing--validation-plan">10. Testing &amp; Validation Plan<a href="#10-testing--validation-plan" class="hash-link" aria-label="Direct link to 10. Testing &amp; Validation Plan" title="Direct link to 10. Testing &amp; Validation Plan" translate="no">​</a></h2>
<ul>
<li class="">Unit / Integration:<!-- -->
<ul>
<li class="">Automation with resourceCost and 0 balance: no enqueue; no cooldown; state unchanged.</li>
<li class="">With sufficient balance: spend recorded; enqueue scheduled; lastFired and cooldown updated.</li>
<li class="">Upgrade target: resourceCost treated as additional fee; PURCHASE_UPGRADE still validates upgrade cost separately.</li>
<li class="">resourceThreshold interplay: on cost failure, do not consume the crossing (keep <code>lastThresholdSatisfied = false</code>); no cooldown on failed spend; when cost later succeeds while condition still holds, the automation fires and updates <code>lastThresholdSatisfied = true</code>.</li>
<li class="">Legacy automations (no resourceCost): behavior unchanged.</li>
</ul>
</li>
<li class="">Performance:<!-- -->
<ul>
<li class="">Micro-benchmark: negligible overhead for “no resourceCost” path; cost path 1–2 numeric formula evaluations and 1 spendAmount call.</li>
</ul>
</li>
<li class="">Tooling / A11y:<!-- -->
<ul>
<li class="">No UI changes; a11y tests unaffected. Run pnpm test<!-- -->:a11y<!-- --> if any shell-web changes occur (N/A here).</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="11-risks--mitigations">11. Risks &amp; Mitigations<a href="#11-risks--mitigations" class="hash-link" aria-label="Direct link to 11. Risks &amp; Mitigations" title="Direct link to 11. Risks &amp; Mitigations" translate="no">​</a></h2>
<ul>
<li class="">Risk: Atomicity violations if accessor not wired correctly.<!-- -->
<ul>
<li class="">Mitigation: Spend synchronously inside tick before enqueue; unit tests enforce order.</li>
</ul>
</li>
<li class="">Risk: Determinism drift from time-based calculations.<!-- -->
<ul>
<li class="">Mitigation: Reuse current step timestamping; no wall-clock usage.</li>
</ul>
</li>
<li class="">Risk: Back-compat regressions in content without resourceCost.<!-- -->
<ul>
<li class="">Mitigation: Guard logic branches; existing tests must pass unchanged.</li>
</ul>
</li>
<li class="">Risk: Formula misuse (NaN/negative/Infinity).<!-- -->
<ul>
<li class="">Mitigation: Sanitize and clamp; log telemetry warning on invalid inputs (follow-up).</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="12-rollout-plan">12. Rollout Plan<a href="#12-rollout-plan" class="hash-link" aria-label="Direct link to 12. Rollout Plan" title="Direct link to 12. Rollout Plan" translate="no">​</a></h2>
<ul>
<li class="">Milestones:<!-- -->
<ul>
<li class="">Phase 1 PR (core): merged after approval by Jordan Hans and runtime maintainer.</li>
<li class="">Phase 2 PRs (docs, content): land after core available on main.</li>
</ul>
</li>
<li class="">Migration Strategy:<!-- -->
<ul>
<li class="">No data migration; save/export unaffected.</li>
<li class="">Sample pack updated to include resourceCost.</li>
</ul>
</li>
<li class="">Communication:<!-- -->
<ul>
<li class="">Release notes: “Automations now enforce and deduct resourceCost.”</li>
<li class="">Update docs and point content authors to new semantics.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="13-open-questions">13. Open Questions<a href="#13-open-questions" class="hash-link" aria-label="Direct link to 13. Open Questions" title="Direct link to 13. Open Questions" translate="no">​</a></h2>
<ul>
<li class="">Should resourceCost.rate support non-constant formulas in this iteration? Owner: Runtime Implementation Agent. Status: TODO.</li>
<li class="">Should we reject negative/NaN/Infinity with validation or clamp to 0? Owner: Runtime Implementation Agent. Status: TODO.</li>
<li class="">Do we need telemetry events for spend success/failure now? Owner: Core Runtime Team. Status: TODO.</li>
<li class="">Is a future SPEND_RESOURCE command desirable for cross-system parity? Owner: Core Runtime Team. Status: TODO.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="14-follow-up-work">14. Follow-Up Work<a href="#14-follow-up-work" class="hash-link" aria-label="Direct link to 14. Follow-Up Work" title="Direct link to 14. Follow-Up Work" translate="no">​</a></h2>
<ul>
<li class="">Multi-resource costs and conditional cost expressions. Owner: Core Runtime Team.</li>
<li class="">Telemetry events for automation cost attempts. Owner: Core Runtime Team.</li>
<li class="">Authoring guide improvements (examples for complex formulas). Owner: Docs Agent.</li>
<li class="">Consider transactional command queue patterns for broader atomic sequences. Owner: Core Runtime Team.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="15-references">15. References<a href="#15-references" class="hash-link" aria-label="Direct link to 15. References" title="Direct link to 15. References" translate="no">​</a></h2>
<ul>
<li class="">Issue scope: <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/348" target="_blank" rel="noopener noreferrer" class="">https://github.com/hansjm10/Idle-Game-Engine/issues/348</a></li>
<li class="">TODO in code: packages/core/src/automation-system.ts:302</li>
<li class="">ResourceStateReader interface: packages/core/src/automation-system.ts:504</li>
<li class="">Threshold evaluation: packages/core/src/automation-system.ts:547</li>
<li class="">Enqueue path: packages/core/src/automation-system.ts:620</li>
<li class="">ResourceState API (spendAmount): packages/core/src/resource-state.ts:148 (interface); implementation with index assertion: 666–716</li>
<li class="">Adapter: packages/core/src/automation-resource-state-adapter.ts:1</li>
<li class="">Sample content automations (cost removed): packages/content-sample/content/pack.json:366</li>
<li class="">Authoring guide (resourceCost examples): docs/automation-authoring-guide.md:41</li>
<li class="">Content schema (resourceCost): packages/content-schema/src/modules/automations.ts:95</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-a--glossary">Appendix A — Glossary<a href="#appendix-a--glossary" class="hash-link" aria-label="Direct link to Appendix A — Glossary" title="Direct link to Appendix A — Glossary" translate="no">​</a></h2>
<ul>
<li class="">Automation: A content-defined rule that automatically schedules a runtime command based on a trigger.</li>
<li class="">resourceCost: Optional automation property defining a resource and a formula (rate) to deduct when the automation fires.</li>
<li class="">Determinism: Property ensuring identical inputs produce identical outputs across runs.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-b--change-log">Appendix B — Change Log<a href="#appendix-b--change-log" class="hash-link" aria-label="Direct link to Appendix B — Change Log" title="Direct link to Appendix B — Change Log" translate="no">​</a></h2>
<table><thead><tr><th>Date</th><th>Author</th><th>Change Summary</th></tr></thead><tbody><tr><td>2025-11-09</td><td>Design-Authoring Agent (AI)</td><td>Initial draft aligning to issue-348 and repo state</td></tr></tbody></table></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_QKxP"><a href="https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/automation-resource-cost-design-issue-348.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_wOWh" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_Basj"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_AUZ0 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#document-control" class="table-of-contents__link toc-highlight">Document Control</a></li><li><a href="#1-summary" class="table-of-contents__link toc-highlight">1. Summary</a></li><li><a href="#2-context--problem-statement" class="table-of-contents__link toc-highlight">2. Context &amp; Problem Statement</a></li><li><a href="#3-goals--non-goals" class="table-of-contents__link toc-highlight">3. Goals &amp; Non-Goals</a></li><li><a href="#4-stakeholders-agents--impacted-surfaces" class="table-of-contents__link toc-highlight">4. Stakeholders, Agents &amp; Impacted Surfaces</a></li><li><a href="#5-current-state" class="table-of-contents__link toc-highlight">5. Current State</a></li><li><a href="#6-proposed-solution" class="table-of-contents__link toc-highlight">6. Proposed Solution</a><ul><li><a href="#61-architecture-overview" class="table-of-contents__link toc-highlight">6.1 Architecture Overview</a></li><li><a href="#62-detailed-design" class="table-of-contents__link toc-highlight">6.2 Detailed Design</a></li><li><a href="#63-operational-considerations" class="table-of-contents__link toc-highlight">6.3 Operational Considerations</a></li></ul></li><li><a href="#7-work-breakdown--delivery-plan" class="table-of-contents__link toc-highlight">7. Work Breakdown &amp; Delivery Plan</a><ul><li><a href="#71-issue-map" class="table-of-contents__link toc-highlight">7.1 Issue Map</a></li><li><a href="#72-milestones" class="table-of-contents__link toc-highlight">7.2 Milestones</a></li><li><a href="#73-coordination-notes" class="table-of-contents__link toc-highlight">7.3 Coordination Notes</a></li></ul></li><li><a href="#8-agent-guidance--guardrails" class="table-of-contents__link toc-highlight">8. Agent Guidance &amp; Guardrails</a></li><li><a href="#9-alternatives-considered" class="table-of-contents__link toc-highlight">9. Alternatives Considered</a></li><li><a href="#10-testing--validation-plan" class="table-of-contents__link toc-highlight">10. Testing &amp; Validation Plan</a></li><li><a href="#11-risks--mitigations" class="table-of-contents__link toc-highlight">11. Risks &amp; Mitigations</a></li><li><a href="#12-rollout-plan" class="table-of-contents__link toc-highlight">12. Rollout Plan</a></li><li><a href="#13-open-questions" class="table-of-contents__link toc-highlight">13. Open Questions</a></li><li><a href="#14-follow-up-work" class="table-of-contents__link toc-highlight">14. Follow-Up Work</a></li><li><a href="#15-references" class="table-of-contents__link toc-highlight">15. References</a></li><li><a href="#appendix-a--glossary" class="table-of-contents__link toc-highlight">Appendix A — Glossary</a></li><li><a href="#appendix-b--change-log" class="table-of-contents__link toc-highlight">Appendix B — Change Log</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/contributor-handbook">Contributor Handbook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Idle Engine.</div></div></div></footer></div>
</body>
</html>