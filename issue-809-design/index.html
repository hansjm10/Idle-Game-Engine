<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-issue-809-design" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">renderer-webgpu: Reduce Per-Frame Allocations in Quad/Text Batching (Issue 809) | Idle Engine Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hansjm10.github.io/Idle-Game-Engine/issue-809-design"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="renderer-webgpu: Reduce Per-Frame Allocations in Quad/Text Batching (Issue 809) | Idle Engine Docs"><meta data-rh="true" name="description" content="Document Control"><meta data-rh="true" property="og:description" content="Document Control"><link data-rh="true" rel="icon" href="/Idle-Game-Engine/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hansjm10.github.io/Idle-Game-Engine/issue-809-design"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/issue-809-design" hreflang="en"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/issue-809-design" hreflang="x-default"><link rel="stylesheet" href="/Idle-Game-Engine/assets/css/styles.0ca8729c.css">
<script src="/Idle-Game-Engine/assets/js/runtime~main.aa8ca513.js" defer="defer"></script>
<script src="/Idle-Game-Engine/assets/js/main.4d4cb8d0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Idle-Game-Engine/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_sIzO" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Idle-Game-Engine/"><div class="navbar__logo"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_yXCL themedComponent--light_m26g"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_yXCL themedComponent--dark_DQxa"></div><b class="navbar__title text--truncate">Idle Engine</b></a><a class="navbar__item navbar__link" href="/Idle-Game-Engine/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_zgE_"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_VTTy colorModeToggle_mrTp"><button class="clean-btn toggleButton_Qf8c toggleButtonDisabled_hCyI" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_j9FX lightToggleIcon_i4Ty"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_j9FX darkToggleIcon_B1fV"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_j9FX systemToggleIcon_d9Wq"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_xdO6"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_fCXc"><div class="docsWrapper_oodB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_ZUBg" type="button"></button><div class="docRoot_zYbW"><main class="docMainContainer_BJhZ docMainContainerEnhanced_qZTj"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_NkVs"><div class="docItemContainer_WMJH"><article><div class="tocCollapsible_Kd7K theme-doc-toc-mobile tocMobile_Gv4l"><button type="button" class="clean-btn tocCollapsibleButton_ajnv">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>renderer-webgpu: Reduce Per-Frame Allocations in Quad/Text Batching (Issue 809)</h1></header>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="document-control">Document Control<a href="#document-control" class="hash-link" aria-label="Direct link to Document Control" title="Direct link to Document Control" translate="no">​</a></h2>
<ul>
<li class=""><strong>Title</strong>: Reduce per-frame allocations in WebGPU quad/text batching</li>
<li class=""><strong>Authors</strong>: Codex (AI)</li>
<li class=""><strong>Reviewers</strong>: @hansjm10</li>
<li class=""><strong>Status</strong>: Draft</li>
<li class=""><strong>Last Updated</strong>: 2026-01-21</li>
<li class=""><strong>Related Issues</strong>: <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/809" target="_blank" rel="noopener noreferrer" class="">https://github.com/hansjm10/Idle-Game-Engine/issues/809</a></li>
<li class=""><strong>Execution Mode</strong>: AI-led</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="1-summary">1. Summary<a href="#1-summary" class="hash-link" aria-label="Direct link to 1. Summary" title="Direct link to 1. Summary" translate="no">​</a></h2>
<p>The WebGPU renderer currently accumulates quad instance data in a <code>number[]</code> and allocates a new <code>Float32Array</code> on every batch flush, while text rendering pushes per-glyph instance data into the same hot array path. At higher draw/text volumes this produces avoidable GC pressure and frame-time spikes. This design replaces the hot-path <code>number[]</code> with a reusable, growable <code>Float32Array</code> instance builder (cursor-based writer) that is reused across flushes and frames, and updates the upload path to write only the used byte range without allocating new buffers in steady state.</p>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="2-context--problem-statement">2. Context &amp; Problem Statement<a href="#2-context--problem-statement" class="hash-link" aria-label="Direct link to 2. Context &amp; Problem Statement" title="Direct link to 2. Context &amp; Problem Statement" translate="no">​</a></h2>
<ul>
<li class=""><strong>Background</strong>: <code>@idle-engine/renderer-webgpu</code> renders <code>rect</code>, <code>image</code>, and <code>text</code> draws as instanced quads (<code>INSTANCE_STRIDE_BYTES = 48</code>, i.e. 12 floats per instance) using a single GPU instance buffer updated via <code>device.queue.writeBuffer(...)</code>. Draws are sorted by pass and <code>sortKey</code> (<code>orderDrawsByPassAndSortKey</code>) and then streamed through a quad batching loop that flushes when the pipeline kind changes (rect vs image), the pass changes (world vs ui), or scissor state changes.</li>
<li class=""><strong>Problem</strong>: The quad batching loop builds up <code>WebGpuQuadRenderState.batchInstances: number[]</code> and, on each flush, converts it into <code>new Float32Array(state.batchInstances)</code> before uploading. Additionally, <code>#resetQuadBatch</code> discards the existing array by assigning a new <code>[]</code>. For text draws, <code>appendBitmapTextInstances(...)</code> pushes 12 numbers per glyph into the same array. These repeated allocations and high-frequency <code>push(...)</code> calls can create significant GC pressure and degrade performance.</li>
<li class=""><strong>Forces</strong>:<!-- -->
<ul>
<li class="">Preserve the renderer contract: <code>RenderCommandBuffer</code> inputs and rendering outputs must remain behaviorally identical.</li>
<li class="">Keep batching semantics correct across pipeline/pass/scissor boundaries.</li>
<li class="">Ensure the solution works in both browser WebGPU and the test harness (stub WebGPU environment used by <code>webgpu-renderer.test.ts</code>).</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="3-goals--non-goals">3. Goals &amp; Non-Goals<a href="#3-goals--non-goals" class="hash-link" aria-label="Direct link to 3. Goals &amp; Non-Goals" title="Direct link to 3. Goals &amp; Non-Goals" translate="no">​</a></h2>
<ul>
<li class=""><strong>Goals</strong>:<!-- -->
<ul>
<li class="">Eliminate per-flush allocations in steady state (after buffers grow to the required capacity).</li>
<li class="">Avoid <code>number[]</code> usage on the hot path for quad and text instance accumulation.</li>
<li class="">Maintain the existing instance layout (pos/size, uv rect, color = 12 floats) and draw call behavior.</li>
<li class="">Add a unit test or micro-benchmark that asserts buffer reuse behavior across multiple renders/flushes.</li>
</ul>
</li>
<li class=""><strong>Non-Goals</strong>:<!-- -->
<ul>
<li class="">Redesigning draw ordering/grouping (<code>orderDrawsByPassAndSortKey</code>) or changing batching boundaries.</li>
<li class="">Implementing advanced text shaping/kerning or changing bitmap font layout rules.</li>
<li class="">Eliminating all allocations in <code>render(...)</code> (e.g., <code>#writeGlobals</code> currently allocates small temporary typed arrays); these may be follow-up optimizations.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="4-stakeholders-agents--impacted-surfaces">4. Stakeholders, Agents &amp; Impacted Surfaces<a href="#4-stakeholders-agents--impacted-surfaces" class="hash-link" aria-label="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" title="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" translate="no">​</a></h2>
<ul>
<li class=""><strong>Primary Stakeholders</strong>:<!-- -->
<ul>
<li class="">Renderer maintainers (<code>packages/renderer-webgpu</code>).</li>
<li class="">Desktop shell maintainers relying on stable frame-time (<code>packages/shell-desktop</code>), indirectly.</li>
</ul>
</li>
<li class=""><strong>Agent Roles</strong>:<!-- -->
<ul>
<li class=""><strong>Docs Agent</strong>: Maintain this design doc and track open questions.</li>
<li class=""><strong>Renderer Implementation Agent</strong>: Implement typed buffer builder + refactor quad/text batching to use it.</li>
<li class=""><strong>Test/Perf Agent</strong>: Update/add tests (and optional micro-benchmark) to prove reuse and prevent regressions.</li>
</ul>
</li>
<li class=""><strong>Affected Packages/Services</strong>:<!-- -->
<ul>
<li class=""><code>packages/renderer-webgpu/src/webgpu-renderer.ts</code> (batching + upload path)</li>
<li class=""><code>packages/renderer-webgpu/src/webgpu-renderer.test.ts</code> (tests for buffer uploads and reuse)</li>
<li class="">(Optional) a new helper module under <code>packages/renderer-webgpu/src/</code> (typed buffer builder)</li>
</ul>
</li>
<li class=""><strong>Compatibility Considerations</strong>:<!-- -->
<ul>
<li class="">No changes to <code>@idle-engine/renderer-contract</code> or <code>RenderCommandBuffer</code> formats.</li>
<li class="">The GPU-side instance vertex layout must remain unchanged (attribute order and stride).</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="5-current-state">5. Current State<a href="#5-current-state" class="hash-link" aria-label="Direct link to 5. Current State" title="Direct link to 5. Current State" translate="no">​</a></h2>
<p><code>WebGpuRendererImpl</code> builds and flushes per-batch instance data as follows:</p>
<ul>
<li class="">The render loop streams ordered draws through <code>#renderQuadDrawEntry(...)</code>, which calls:<!-- -->
<ul>
<li class=""><code>#handleRectDraw(...)</code> / <code>#handleImageDraw(...)</code>: pushes 12 values per draw into <code>state.batchInstances</code> and increments <code>state.batchInstanceCount</code>.</li>
<li class=""><code>#handleTextDraw(...)</code>: calls <code>appendBitmapTextInstances({ batchInstances: state.batchInstances, ... })</code>, which pushes 12 values per rendered glyph and returns the number of appended glyph instances.</li>
</ul>
</li>
<li class="">Flushing (<code>#flushQuadBatch(...)</code>) converts the JS array to a typed array (<code>new Float32Array(state.batchInstances)</code>), grows the GPU instance buffer if needed, and uploads the data using <code>device.queue.writeBuffer(...)</code>.</li>
<li class="">Resetting a batch (<code>#resetQuadBatch(...)</code>) discards the prior <code>batchInstances</code> array by assigning <code>state.batchInstances = []</code>, ensuring a new array allocation per flush/batch boundary.</li>
</ul>
<p>The test suite (<code>packages/renderer-webgpu/src/webgpu-renderer.test.ts</code>) currently treats instance uploads as an <code>ArrayBuffer</code> payload passed to <code>queue.writeBuffer(...)</code>, and validates instance content by constructing <code>new Float32Array(data)</code>.</p>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="6-proposed-solution">6. Proposed Solution<a href="#6-proposed-solution" class="hash-link" aria-label="Direct link to 6. Proposed Solution" title="Direct link to 6. Proposed Solution" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="61-architecture-overview">6.1 Architecture Overview<a href="#61-architecture-overview" class="hash-link" aria-label="Direct link to 6.1 Architecture Overview" title="Direct link to 6.1 Architecture Overview" translate="no">​</a></h3>
<ul>
<li class="">Replace the hot <code>number[]</code> accumulation with a reusable typed instance builder:<!-- -->
<ul>
<li class="">A growable <code>Float32Array</code> buffer and a write cursor (float offset).</li>
<li class="">A <code>reset()</code> method to set the cursor back to 0 without allocating.</li>
<li class="">A <code>reserve(requiredFloats)</code> / <code>ensureCapacity(requiredFloats)</code> method to grow geometrically when needed.</li>
</ul>
</li>
<li class="">Keep the current batching boundaries (kind/pass/scissor) but change writes from <code>push(...)</code> to direct indexed writes into the typed buffer.</li>
<li class="">Upload only the used portion of the builder’s underlying <code>ArrayBuffer</code> by using the <code>dataOffset</code>/<code>size</code> parameters of <code>queue.writeBuffer(...)</code> (or equivalent <code>ArrayBufferView</code> upload), avoiding <code>slice(...)</code> allocations.</li>
</ul>
<p><strong>Diagram (conceptual)</strong>:
<code>ordered draws</code> → <code>batch boundary checks</code> → <code>typed instance writer (cursor)</code> → <code>flush</code> → <code>queue.writeBuffer(instanceBuffer, ..., size = usedBytes)</code> → <code>reset cursor</code></p>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="62-detailed-design">6.2 Detailed Design<a href="#62-detailed-design" class="hash-link" aria-label="Direct link to 6.2 Detailed Design" title="Direct link to 6.2 Detailed Design" translate="no">​</a></h3>
<ul>
<li class=""><strong>Runtime Changes</strong>:<!-- -->
<ul>
<li class="">Introduce a <code>Float32ArrayBuilder</code> (name TBD) with:<!-- -->
<ul>
<li class=""><code>buffer: Float32Array</code></li>
<li class=""><code>lengthFloats: number</code> (cursor)</li>
<li class=""><code>reset(): void</code></li>
<li class=""><code>ensureCapacity(requiredFloats: number): void</code> (doubling strategy; copies existing contents on growth)</li>
</ul>
</li>
<li class="">Update <code>WebGpuQuadRenderState</code> to store the builder (or store it on the renderer instance and reference it from render state) instead of <code>batchInstances: number[]</code>.</li>
<li class="">Update <code>#handleRectDraw</code>, <code>#handleImageDraw</code>, and <code>appendBitmapTextInstances</code> to write directly into the typed buffer:<!-- -->
<ul>
<li class="">Write 12 floats per instance in the existing order: <code>[x, y, w, h, u0, v0, u1, v1, r, g, b, a]</code>.</li>
<li class="">Increment <code>batchInstanceCount</code> as today, or derive it from <code>lengthFloats / 12</code> (choose one and add invariants to keep them consistent).</li>
</ul>
</li>
<li class="">Update <code>#flushQuadBatch</code> to:<!-- -->
<ul>
<li class="">Compute <code>usedBytes = lengthFloats * 4</code>.</li>
<li class="">Call <code>#ensureInstanceBuffer(usedBytes)</code>.</li>
<li class="">Upload without allocating:<!-- -->
<ul>
<li class="">Preferred: <code>queue.writeBuffer(instanceBuffer, 0, builder.buffer.buffer, 0, usedBytes)</code> (exact signature TBD per environment/types).</li>
<li class="">Alternative: <code>queue.writeBuffer(instanceBuffer, 0, builder.buffer, 0, usedBytes)</code> (upload view directly).</li>
</ul>
</li>
<li class="">Reset the builder cursor and batch metadata.</li>
</ul>
</li>
</ul>
</li>
<li class=""><strong>Data &amp; Schemas</strong>: N/A.</li>
<li class=""><strong>APIs &amp; Contracts</strong>:<!-- -->
<ul>
<li class="">No external API changes.</li>
<li class="">If tests need visibility into reuse behavior, expose minimal internals via <code>webgpu-renderer.ts</code> <code>__test__</code> exports (e.g., a helper to access the instance builder identity) without making it part of the public renderer interface.</li>
</ul>
</li>
<li class=""><strong>Tooling &amp; Automation</strong>:<!-- -->
<ul>
<li class="">Update <code>webgpu-renderer.test.ts</code> expectations to accept the new <code>writeBuffer</code> call shape (likely including <code>dataOffset</code>/<code>size</code>, and/or a <code>Float32Array</code> payload).</li>
<li class="">Add a unit test that renders twice and asserts the instance upload source buffer is reused once capacity is sufficient.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="63-operational-considerations">6.3 Operational Considerations<a href="#63-operational-considerations" class="hash-link" aria-label="Direct link to 6.3 Operational Considerations" title="Direct link to 6.3 Operational Considerations" translate="no">​</a></h3>
<ul>
<li class=""><strong>Deployment</strong>: No special rollout mechanics; change is internal to the renderer package.</li>
<li class=""><strong>Telemetry &amp; Observability</strong>: N/A in-code. For manual verification, use browser devtools allocation profiling or Node <code>--trace-gc</code> during a high-volume render loop to confirm reduced GC churn.</li>
<li class=""><strong>Security &amp; Compliance</strong>: No new data handling; no user input surfaces added.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="7-work-breakdown--delivery-plan">7. Work Breakdown &amp; Delivery Plan<a href="#7-work-breakdown--delivery-plan" class="hash-link" aria-label="Direct link to 7. Work Breakdown &amp; Delivery Plan" title="Direct link to 7. Work Breakdown &amp; Delivery Plan" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="71-issue-map">7.1 Issue Map<a href="#71-issue-map" class="hash-link" aria-label="Direct link to 7.1 Issue Map" title="Direct link to 7.1 Issue Map" translate="no">​</a></h3>
<table><thead><tr><th>Issue Title</th><th>Scope Summary</th><th>Proposed Assignee/Agent</th><th>Dependencies</th><th>Acceptance Criteria</th></tr></thead><tbody><tr><td><code>feat(renderer-webgpu): add reusable Float32Array builder</code></td><td>Implement growable typed buffer + cursor utility</td><td>Renderer Implementation Agent</td><td>None</td><td>Builder supports reset + growth; no per-reset allocation</td></tr><tr><td><code>refactor(renderer-webgpu): use typed builder for quad/text batching</code></td><td>Replace <code>number[]</code> writes and <code>new Float32Array(...)</code> conversion with builder writes + upload by size</td><td>Renderer Implementation Agent</td><td>Builder utility</td><td>Rendering output matches existing tests; steady-state flushes allocate 0 new arrays</td></tr><tr><td><code>test(renderer-webgpu): assert instance upload buffer reuse</code></td><td>Update/add Vitest case to prove buffer identity reuse across renders/flushes</td><td>Test/Perf Agent</td><td>Refactor</td><td>Test fails if per-flush typed buffers are reallocated</td></tr><tr><td><code>bench(renderer-webgpu): optional micro-benchmark for flush loop</code></td><td>Small benchmark harness (Vitest or script) to quantify allocations/time</td><td>Test/Perf Agent</td><td>Refactor</td><td>Demonstrates reduced allocations in steady state (TBD metrics)</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="72-milestones">7.2 Milestones<a href="#72-milestones" class="hash-link" aria-label="Direct link to 7.2 Milestones" title="Direct link to 7.2 Milestones" translate="no">​</a></h3>
<ul>
<li class=""><strong>Phase 1</strong>: Land builder + refactor + unit test proving reuse.</li>
<li class=""><strong>Phase 2</strong>: Optional follow-ups to reduce other per-frame allocations (e.g., globals scratch buffers) if profiling shows remaining hotspots.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="73-coordination-notes">7.3 Coordination Notes<a href="#73-coordination-notes" class="hash-link" aria-label="Direct link to 7.3 Coordination Notes" title="Direct link to 7.3 Coordination Notes" translate="no">​</a></h3>
<ul>
<li class=""><strong>Hand-off Package</strong>:<!-- -->
<ul>
<li class=""><code>packages/renderer-webgpu/src/webgpu-renderer.ts</code></li>
<li class=""><code>packages/renderer-webgpu/src/webgpu-renderer.test.ts</code></li>
<li class="">(Optional) <code>packages/renderer-webgpu/src/&lt;typed-builder&gt;.ts</code></li>
<li class="">This design doc: <code>docs/issue-809-design.md</code></li>
</ul>
</li>
<li class=""><strong>Communication Cadence</strong>: One reviewer pass after Phase 1; Phase 2 only if profiling data supports it.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="8-agent-guidance--guardrails">8. Agent Guidance &amp; Guardrails<a href="#8-agent-guidance--guardrails" class="hash-link" aria-label="Direct link to 8. Agent Guidance &amp; Guardrails" title="Direct link to 8. Agent Guidance &amp; Guardrails" translate="no">​</a></h2>
<ul>
<li class=""><strong>Context Packets</strong>:<!-- -->
<ul>
<li class="">Issue 809: <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/809" target="_blank" rel="noopener noreferrer" class="">https://github.com/hansjm10/Idle-Game-Engine/issues/809</a></li>
<li class="">Renderer implementation: <code>packages/renderer-webgpu/src/webgpu-renderer.ts</code></li>
<li class="">Existing tests: <code>packages/renderer-webgpu/src/webgpu-renderer.test.ts</code></li>
<li class="">Instance layout constants: <code>INSTANCE_STRIDE_BYTES</code>, shader <code>VertexInput</code> in <code>webgpu-renderer.ts</code></li>
</ul>
</li>
<li class=""><strong>Prompting &amp; Constraints</strong>:<!-- -->
<ul>
<li class="">Do not edit checked-in generated outputs under <code>packages/renderer-webgpu/dist/**</code> by hand.</li>
<li class="">Preserve type-only imports/exports (<code>import type</code> / <code>export type</code>) if adding new modules.</li>
<li class="">Keep <code>INSTANCE_STRIDE_BYTES</code> and attribute ordering unchanged unless the shader + pipeline are updated in lockstep (out of scope).</li>
</ul>
</li>
<li class=""><strong>Safety Rails</strong>:<!-- -->
<ul>
<li class="">Always upload exactly <code>instanceCount * INSTANCE_STRIDE_BYTES</code> bytes (no stale trailing data).</li>
<li class="">Reset cursor and batch metadata on every flush and on early-out cases (empty batch, zero scissor rect).</li>
<li class="">Ensure growth logic is bounded and does not thrash (geometric growth; avoid per-instance reallocations).</li>
</ul>
</li>
<li class=""><strong>Validation Hooks</strong>:<!-- -->
<ul>
<li class=""><code>pnpm test --filter @idle-engine/renderer-webgpu</code></li>
<li class=""><code>pnpm lint --filter @idle-engine/renderer-webgpu</code></li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="9-alternatives-considered">9. Alternatives Considered<a href="#9-alternatives-considered" class="hash-link" aria-label="Direct link to 9. Alternatives Considered" title="Direct link to 9. Alternatives Considered" translate="no">​</a></h2>
<ul>
<li class=""><strong>Reuse <code>number[]</code> instead of reallocating</strong>: Avoids <code>state.batchInstances = []</code>, but still requires allocating a typed array (or copying) to upload to the GPU each flush.</li>
<li class=""><strong>Precompute and allocate per frame</strong>: Build a single typed array for all instances in the frame. This complicates scissor boundaries and mixed rect/image/text batching, and may require extra passes over text to count glyphs.</li>
<li class=""><strong>Pool per-flush typed arrays</strong>: Reduces GC of buffers but still allocates frequently and increases complexity (pool sizing, lifetime, fragmentation).</li>
<li class=""><strong>Mapped GPU buffers</strong>: Using mapped-at-creation buffers or persistent mapping is not broadly viable and complicates WebGPU usage patterns; also likely increases complexity beyond this issue’s scope.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="10-testing--validation-plan">10. Testing &amp; Validation Plan<a href="#10-testing--validation-plan" class="hash-link" aria-label="Direct link to 10. Testing &amp; Validation Plan" title="Direct link to 10. Testing &amp; Validation Plan" translate="no">​</a></h2>
<ul>
<li class=""><strong>Unit / Integration</strong>:<!-- -->
<ul>
<li class="">Update <code>webgpu-renderer.test.ts</code> to validate instance uploads when <code>writeBuffer</code> uses <code>dataOffset</code>/<code>size</code> and/or a typed view payload.</li>
<li class="">Add a new test that:<!-- -->
<ul>
<li class="">renders a scene that triggers at least one flush and grows the instance builder to a non-trivial size,</li>
<li class="">renders the same scene again,</li>
<li class="">asserts the instance upload source buffer identity is reused (same <code>ArrayBuffer</code> or same builder object) and the <code>size</code> argument matches the expected used bytes.</li>
</ul>
</li>
</ul>
</li>
<li class=""><strong>Performance</strong>:<!-- -->
<ul>
<li class="">Optional micro-benchmark that runs a tight loop with many flushes and asserts stable buffer identity; record timing locally (no console output in CI beyond Vitest’s reporter).</li>
</ul>
</li>
<li class=""><strong>Tooling / A11y</strong>: N/A.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="11-risks--mitigations">11. Risks &amp; Mitigations<a href="#11-risks--mitigations" class="hash-link" aria-label="Direct link to 11. Risks &amp; Mitigations" title="Direct link to 11. Risks &amp; Mitigations" translate="no">​</a></h2>
<ul>
<li class=""><strong>Risk</strong>: Upload path writes the full underlying buffer instead of the used range, causing stale data to be rendered.<br>
<strong>Mitigation</strong>: Always pass <code>size = instanceCount * INSTANCE_STRIDE_BYTES</code> (or <code>lengthFloats * 4</code>) to <code>writeBuffer</code>.</li>
<li class=""><strong>Risk</strong>: Cursor/instanceCount drift leads to incorrect <code>drawIndexed</code> instance counts.<br>
<strong>Mitigation</strong>: Derive one from the other (single source of truth), and add assertions in tests (e.g., <code>lengthFloats === instanceCount * 12</code>).</li>
<li class=""><strong>Risk</strong>: Tests become brittle due to different <code>writeBuffer</code> argument types (<code>ArrayBuffer</code> vs <code>ArrayBufferView</code>).<br>
<strong>Mitigation</strong>: Update tests to validate content by constructing a <code>Float32Array</code> view over the provided data with offsets/sizes instead of assuming <code>data.byteLength</code> equals the used bytes.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="12-rollout-plan">12. Rollout Plan<a href="#12-rollout-plan" class="hash-link" aria-label="Direct link to 12. Rollout Plan" title="Direct link to 12. Rollout Plan" translate="no">​</a></h2>
<ul>
<li class=""><strong>Milestones</strong>:<!-- -->
<ul>
<li class="">Merge Phase 1 changes with passing tests.</li>
<li class="">If desired, follow up with Phase 2 allocation reductions based on profiling.</li>
</ul>
</li>
<li class=""><strong>Migration Strategy</strong>: None.</li>
<li class=""><strong>Communication</strong>: Note in the PR description that per-flush allocations were removed and include the new reuse test as evidence.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="13-open-questions">13. Open Questions<a href="#13-open-questions" class="hash-link" aria-label="Direct link to 13. Open Questions" title="Direct link to 13. Open Questions" translate="no">​</a></h2>
<ul>
<li class="">Should Issue 809 also cover the small per-frame allocations in <code>#writeGlobals(...)</code> (currently allocates a <code>Float32Array</code> twice per render), or keep that as follow-up work?</li>
<li class="">What is the preferred test assertion shape for “no per-flush allocation” in this repo: buffer identity reuse, <code>writeBuffer</code> argument inspection, or a dedicated benchmark harness?</li>
<li class="">Should the typed builder live inside <code>webgpu-renderer.ts</code> (minimal surface area) or as a separate module under <code>packages/renderer-webgpu/src/</code> for reuse/testing?</li>
<li class="">Do we want to reserve capacity up-front based on draw counts (and <code>text.length</code> as an upper bound) to reduce growth checks in the tight loop?</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="14-follow-up-work">14. Follow-Up Work<a href="#14-follow-up-work" class="hash-link" aria-label="Direct link to 14. Follow-Up Work" title="Direct link to 14. Follow-Up Work" translate="no">​</a></h2>
<ul>
<li class="">Replace other small per-frame temporary typed arrays (<code>#writeGlobals</code>) with reusable scratch buffers if profiling shows they are meaningful.</li>
<li class="">Consider reusing other transient arrays in render state (<code>scissorStack</code>) if scissor-heavy UIs become a hotspot.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="15-references">15. References<a href="#15-references" class="hash-link" aria-label="Direct link to 15. References" title="Direct link to 15. References" translate="no">​</a></h2>
<ul>
<li class="">Issue 809: <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/809" target="_blank" rel="noopener noreferrer" class="">https://github.com/hansjm10/Idle-Game-Engine/issues/809</a></li>
<li class="">Quad/text batching + flush allocation: <code>packages/renderer-webgpu/src/webgpu-renderer.ts</code></li>
<li class="">Instance upload tests: <code>packages/renderer-webgpu/src/webgpu-renderer.test.ts</code></li>
<li class="">Renderer package overview: <code>packages/renderer-webgpu/README.md</code></li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="appendix-a--glossary">Appendix A — Glossary<a href="#appendix-a--glossary" class="hash-link" aria-label="Direct link to Appendix A — Glossary" title="Direct link to Appendix A — Glossary" translate="no">​</a></h2>
<ul>
<li class=""><strong>Batch flush</strong>: The point where accumulated instances are uploaded to the GPU and drawn (triggered by kind/pass/scissor boundaries).</li>
<li class=""><strong>Instance buffer</strong>: The GPU vertex buffer containing per-quad instance attributes (12 floats per instance).</li>
<li class=""><strong>Steady state</strong>: After the typed builder has grown to accommodate typical peak instance counts, subsequent frames should not allocate new buffers.</li>
<li class=""><strong>Typed buffer builder</strong>: A growable typed array plus cursor used as a reusable write target for instance data.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="appendix-b--change-log">Appendix B — Change Log<a href="#appendix-b--change-log" class="hash-link" aria-label="Direct link to Appendix B — Change Log" title="Direct link to Appendix B — Change Log" translate="no">​</a></h2>
<table><thead><tr><th>Date</th><th>Author</th><th>Change Summary</th></tr></thead><tbody><tr><td>2026-01-21</td><td>Codex (AI)</td><td>Initial draft for Issue 809</td></tr></tbody></table></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_zkN7"><a href="https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/issue-809-design.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_URLU" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_DCA4"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_7BTH thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#document-control" class="table-of-contents__link toc-highlight">Document Control</a></li><li><a href="#1-summary" class="table-of-contents__link toc-highlight">1. Summary</a></li><li><a href="#2-context--problem-statement" class="table-of-contents__link toc-highlight">2. Context &amp; Problem Statement</a></li><li><a href="#3-goals--non-goals" class="table-of-contents__link toc-highlight">3. Goals &amp; Non-Goals</a></li><li><a href="#4-stakeholders-agents--impacted-surfaces" class="table-of-contents__link toc-highlight">4. Stakeholders, Agents &amp; Impacted Surfaces</a></li><li><a href="#5-current-state" class="table-of-contents__link toc-highlight">5. Current State</a></li><li><a href="#6-proposed-solution" class="table-of-contents__link toc-highlight">6. Proposed Solution</a><ul><li><a href="#61-architecture-overview" class="table-of-contents__link toc-highlight">6.1 Architecture Overview</a></li><li><a href="#62-detailed-design" class="table-of-contents__link toc-highlight">6.2 Detailed Design</a></li><li><a href="#63-operational-considerations" class="table-of-contents__link toc-highlight">6.3 Operational Considerations</a></li></ul></li><li><a href="#7-work-breakdown--delivery-plan" class="table-of-contents__link toc-highlight">7. Work Breakdown &amp; Delivery Plan</a><ul><li><a href="#71-issue-map" class="table-of-contents__link toc-highlight">7.1 Issue Map</a></li><li><a href="#72-milestones" class="table-of-contents__link toc-highlight">7.2 Milestones</a></li><li><a href="#73-coordination-notes" class="table-of-contents__link toc-highlight">7.3 Coordination Notes</a></li></ul></li><li><a href="#8-agent-guidance--guardrails" class="table-of-contents__link toc-highlight">8. Agent Guidance &amp; Guardrails</a></li><li><a href="#9-alternatives-considered" class="table-of-contents__link toc-highlight">9. Alternatives Considered</a></li><li><a href="#10-testing--validation-plan" class="table-of-contents__link toc-highlight">10. Testing &amp; Validation Plan</a></li><li><a href="#11-risks--mitigations" class="table-of-contents__link toc-highlight">11. Risks &amp; Mitigations</a></li><li><a href="#12-rollout-plan" class="table-of-contents__link toc-highlight">12. Rollout Plan</a></li><li><a href="#13-open-questions" class="table-of-contents__link toc-highlight">13. Open Questions</a></li><li><a href="#14-follow-up-work" class="table-of-contents__link toc-highlight">14. Follow-Up Work</a></li><li><a href="#15-references" class="table-of-contents__link toc-highlight">15. References</a></li><li><a href="#appendix-a--glossary" class="table-of-contents__link toc-highlight">Appendix A — Glossary</a></li><li><a href="#appendix-b--change-log" class="table-of-contents__link toc-highlight">Appendix B — Change Log</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/contributor-handbook">Contributor Handbook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_zgE_"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_zgE_"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Idle Engine.</div></div></div></footer></div>
</body>
</html>