sequenceDiagram
  autonumber
  participant React as React Shell
  participant Bridge as WorkerBridge
  participant Worker as Runtime Worker
  participant Runtime as IdleEngineRuntime

  React->>Bridge: instantiate WorkerBridge & awaitReady()
  Bridge->>Worker: create worker(module)
  Worker-->>Bridge: READY {schemaVersion, handshakeId}
  alt Schema mismatch
    Worker-->>Bridge: ERROR {code: SCHEMA_VERSION_MISMATCH}
    Bridge-->>React: fail awaitReady(error)
  else OK
    Bridge-->>React: resolve awaitReady()
  end

  React->>Bridge: sendCommand(type, payload)
  Note right of Bridge: Wraps payload with requestId,<br/>source, issuedAt (performance.now())
  Bridge->>Worker: COMMAND {schemaVersion, requestId, source, command}
  Worker->>Runtime: enqueue(command)

  Worker-->>Bridge: STATE_UPDATE {state snapshot}
  Bridge-->>React: onStateUpdate(state)

  React->>Bridge: enableDiagnostics()
  Bridge->>Worker: DIAGNOSTICS_SUBSCRIBE
  Worker->>Runtime: enableDiagnostics()
  Runtime-->>Worker: diagnostics delta
  Worker-->>Bridge: DIAGNOSTICS_UPDATE {timeline}
  Bridge-->>React: onDiagnosticsUpdate(diagnostics)

  React->>Bridge: requestSessionSnapshot()
  Bridge->>Worker: REQUEST_SESSION_SNAPSHOT {requestId}
  Worker-->>Bridge: SESSION_SNAPSHOT {requestId, snapshot}
  Bridge-->>React: onSessionSnapshot(snapshot)

  React->>Bridge: restoreSession(state, elapsedMs, deltas)
  Bridge->>Worker: RESTORE_SESSION {state, elapsedMs, deltas, savedWorkerStep}
  Worker->>Runtime: hydrate state & catch-up
  Worker-->>Bridge: SESSION_RESTORED
  Bridge-->>React: onSessionRestored()
