---
title: "renderer-webgpu: prevent atlas UV bleeding (Issue 812)"
sidebar_position: 99
---

# renderer-webgpu: prevent atlas UV bleeding (Issue 812)

## Document Control
- **Title**: Prevent sprite atlas UV bleeding (half-texel inset + optional padding extrusion)
- **Authors**: Codex (AI)
- **Reviewers**: @hansjm10
- **Status**: Draft
- **Last Updated**: 2026-01-24
- **Related Issues**: https://github.com/hansjm10/Idle-Game-Engine/issues/812
- **Execution Mode**: AI-led

## 1. Summary
`@idle-engine/renderer-webgpu` currently computes atlas UVs on texel edges for both sprite images and bitmap font glyphs. Under common scaling/transform scenarios, interpolated UVs can drift across atlas entry boundaries, causing visible bleeding/fringing from adjacent atlas entries (even with `nearest` sampling). This design updates UV generation to sample texel centers via a half-texel inset, and optionally extrudes atlas entry edge pixels into the existing packing padding to further reduce bleeding on implementations with different precision/rounding behavior.

## 2. Context & Problem Statement
- **Background**:
  - `packages/renderer-webgpu/src/webgpu-renderer.ts` builds a packed texture atlas (`packAtlas(...)` + `copyExternalImageToTexture`) and renders sprites/text as instanced quads.
  - The quad shader computes per-fragment UVs as `mix(instanceUvRect.xy, instanceUvRect.zw, localUv)` and samples the atlas via `textureSample(...)`.
  - The sprite sampler is configured with `nearest` for both `magFilter` and `minFilter`.
- **Problem**:
  - UV rectangles are currently expressed as exact atlas entry edges (e.g. `u0 = x / atlasWidth`, `u1 = (x + width) / atlasWidth`).
  - When a quad is transformed/scaled, interpolation and floating point error can push fragment UVs across the intended boundary, causing sampling from neighboring atlas entries.
  - Bitmap font glyph UVs have the same edge-based issue at glyph sub-rect boundaries within a font image.
- **Forces**:
  - Keep behavior deterministic across platforms and runs.
  - Avoid changes to the renderer contract; treat this as an internal renderer correctness fix.
  - Maintain support for `paddingPx: 0` (minimal atlas footprint) while still fixing the root cause.

## 3. Goals & Non-Goals
- **Goals**:
  - Compute sprite and glyph UV rectangles using a half-texel inset (texel center coordinates) to avoid sampling outside the intended rectangle.
  - (Optional) Extrude atlas entry edge pixels into padding when available to further reduce bleeding due to precision drift.
  - Add deterministic unit tests that fail if UV rect generation regresses (for both sprite images and bitmap fonts).
  - Keep `WebGpuAtlasLayout` and `atlasLayoutHash` semantics unchanged.
- **Non-Goals**:
  - Switching the default sampler to linear filtering or introducing mipmaps.
  - Introducing a new texture packing format or per-sprite textures/texture arrays.
  - Building a golden-image rendering harness (can be follow-up work).

## 4. Stakeholders, Agents & Impacted Surfaces
- **Primary Stakeholders**:
  - Renderer maintainers (`packages/renderer-webgpu`)
  - Host apps rendering scaled sprites/text (`packages/shell-desktop`, future web shells)
- **Agent Roles**:
  - **Docs Agent**: Maintain this design doc and track decisions/open questions.
  - **Renderer Implementation Agent**: Implement UV inset and (optional) extrusion during atlas upload.
  - **Test Agent**: Add regression tests for UV generation and (if implemented) extrusion behavior.
- **Affected Packages/Services**:
  - `packages/renderer-webgpu/src/webgpu-renderer.ts` (UV math, atlas upload)
  - `packages/renderer-webgpu/src/webgpu-renderer.test.ts` (regression tests)
  - (Optional) `packages/renderer-webgpu/src/atlas-packer.ts` (if extrusion requires packer changes later)
- **Compatibility Considerations**:
  - No renderer-contract changes.
  - Rendered output will change slightly at sprite/glyph edges, but only to eliminate visible artifacts.

## 5. Current State
- Atlas UVs for packed sprite images are generated by `buildUvByAssetId(...)`:
  - `u0 = entry.x / atlasWidthPx`, `u1 = (entry.x + entry.width) / atlasWidthPx` (same for `v`).
- Bitmap font glyph UVs are generated in `buildBitmapFontRuntimeGlyph(...)` using the same edge-based approach after offsetting by the packed font atlas entry.
- Atlas upload (`#createAtlasTextureAndUpload`) copies each external source image directly into the atlas at `(entry.x, entry.y)` and does not populate the surrounding padding pixels (padding is effectively transparent/undefined unless explicitly written).

## 6. Proposed Solution
### 6.1 Architecture Overview
- Replace edge-based UV rectangles with texel-center UV rectangles (half-texel inset) for:
  - sprite atlas entries (`buildUvByAssetId`)
  - bitmap font glyph sub-rects (`buildBitmapFontRuntimeGlyph`)
- Optionally, when the atlas packing `paddingPx` is large enough (default is `2`), extrude each atlas entry’s edge pixels into the padding region during atlas upload. This reduces visible fringes if UVs drift slightly outside the intended rectangle due to interpolation or precision.

### 6.2 Detailed Design
- **Runtime Changes**:
  - Introduce a small pure helper to convert a pixel-space rectangle to a `SpriteUvRect` using half-texel inset:
    - `u0 = (x + 0.5) / atlasWidthPx`
    - `u1 = (x + width - 0.5) / atlasWidthPx`
    - Same for `v0/v1`.
  - For bitmap fonts, handle glyphs with `width <= 1` or `height <= 1` by collapsing the UV range to the glyph center (glyphs with `widthPx <= 0 || heightPx <= 0` are already skipped during instance emission, but UV generation should remain well-defined).
  - **Optional padding extrusion** (recommended when `paddingPx >= 2`):
    - During `#createAtlasTextureAndUpload`, after copying the full source image, additionally copy 1-pixel strips from the source edges into the adjacent padding pixels (where in-bounds).
    - Gate extrusion behind `packed.paddingPx >= 2` to avoid overwriting adjacent entries when packing is dense.
    - Keep UV rects referencing the original image region (not the extruded pixels); extrusion is purely a safety buffer for edge sampling drift.
- **Data & Schemas**:
  - No schema changes. `WebGpuAtlasLayout.schemaVersion` remains `1`; `paddingPx` continues to describe packing gaps.
  - `atlasLayoutHash` remains derived solely from the atlas layout (not UV policies).
- **APIs & Contracts**:
  - No required API changes. If future hosts need to toggle extrusion, add an optional `WebGpuRendererLoadAssetsOptions.extrudePx?: 0 | 1` (TBD; see Open Questions).
- **Tooling & Automation**: N/A.

### 6.3 Operational Considerations
- **Deployment**: Patch-level renderer change.
- **Telemetry & Observability**: N/A (no new logging; keep test output clean for `vitest-llm-reporter`).
- **Security & Compliance**: N/A.

## 7. Work Breakdown & Delivery Plan
### 7.1 Issue Map

| Issue Title | Scope Summary | Proposed Assignee/Agent | Dependencies | Acceptance Criteria |
|-------------|---------------|-------------------------|--------------|---------------------|
| `bug(renderer-webgpu): half-texel inset atlas UVs` | Update sprite + glyph UV rect generation to use texel centers | Renderer Implementation Agent | Design approval | No visible atlas bleeding; unit tests assert inset UV values |
| `test(renderer-webgpu): regression tests for UV rects` | Add deterministic unit coverage for sprite + font UV rects (via instance buffer inspection) | Test Agent | UV implementation | Tests fail on edge-based UVs and pass on inset UVs |
| `bug(renderer-webgpu): (optional) extrude atlas entry padding` | Populate packing padding by extruding entry edge pixels when `paddingPx >= 2` | Renderer Implementation Agent | UV implementation | Manual scaling shows reduced fringes; tests cover copy patterns where feasible |

### 7.2 Milestones
- **Phase 1**: Implement half-texel inset UVs + deterministic tests.
- **Phase 2**: Add padding extrusion (if needed after Phase 1 validation) + targeted tests.

### 7.3 Coordination Notes
- **Hand-off Package**:
  - Issue 812: https://github.com/hansjm10/Idle-Game-Engine/issues/812
  - UV generation sites: `packages/renderer-webgpu/src/webgpu-renderer.ts`
  - Atlas packing: `packages/renderer-webgpu/src/atlas-packer.ts`
  - WebGPU stub harness + tests: `packages/renderer-webgpu/src/webgpu-renderer.test.ts`
- **Communication Cadence**: Single reviewer pass once tests cover the new UV policy.

## 8. Agent Guidance & Guardrails
- **Context Packets**:
  - Read Issue 812 body and inspect the UV generation codepaths for both sprites and bitmap fonts.
  - Verify how instance data is encoded (`QuadInstanceWriter`) so tests can assert UV payloads deterministically.
- **Prompting & Constraints**:
  - Do not edit checked-in `dist/**` outputs by hand.
  - Avoid console output in tests (Vitest LLM reporter requires clean output).
  - Prefer pure functions for UV math; share helper logic between sprite and font paths.
- **Safety Rails**:
  - Ensure UVs remain finite and within `(0, 1)` for valid atlas rectangles.
  - For optional extrusion: only write into padding when it cannot overlap adjacent entries (gate on `paddingPx >= 2` and bounds checks).
- **Validation Hooks**:
  - `pnpm test --filter @idle-engine/renderer-webgpu`
  - `pnpm lint --filter @idle-engine/renderer-webgpu` (or `pnpm lint`)

## 9. Alternatives Considered
1. **Increase `paddingPx` only**: Rejected; does not fix edge-based UV interpolation drift and can still produce sampling artifacts.
2. **Clamp UVs in shader**: Requires per-instance clamp bounds and still doesn’t fully address precision drift; adds shader complexity.
3. **Use separate textures per sprite / texture arrays**: Higher complexity and API surface; undermines the current deterministic atlas design.
4. **Rely on host-side transforms to align pixels**: Not feasible; engine must render correctly under arbitrary transforms/scales.

## 10. Testing & Validation Plan
- **Unit / Integration**:
  - Add tests that render a single sprite and assert the uploaded instance buffer contains inset UVs for a known atlas size.
  - Add tests that render bitmap text and assert glyph UVs are inset for both a glyph at `(0,0)` and a glyph at a non-zero atlas offset.
  - If extrusion is implemented: add tests that assert the WebGPU queue receives additional `copyExternalImageToTexture` calls only when `paddingPx >= 2`.
- **Performance**: N/A (small per-asset-load cost if extrusion is enabled; no per-frame cost).
- **Tooling / A11y**: Manual validation in a WebGPU host (Electron shell) by scaling sprites/text and confirming no visible fringes.

## 11. Risks & Mitigations
- **Off-by-one UV bugs causing cropping**:
  - Mitigation: unit tests for expected UVs with known atlas dimensions; validate both sprites and glyphs.
- **Font glyph edge cases (zero-sized glyphs)**:
  - Mitigation: keep UV generation well-defined for `width/height <= 1` and rely on existing instance emission guards.
- **Optional extrusion overwriting neighboring entries**:
  - Mitigation: gate on `paddingPx >= 2` and perform bounds checks; skip extrusion when unsafe.

## 12. Rollout Plan
- **Milestones**: Land as a patch-level fix to `@idle-engine/renderer-webgpu`.
- **Migration Strategy**: None.
- **Communication**: Note in release notes / issue comment that atlas UVs now use half-texel inset to prevent bleeding.

## 13. Open Questions
1. Should padding extrusion ship as part of Issue 812, or only if half-texel inset alone is insufficient in real hosts?
2. If extrusion is shipped, should it be a fixed internal policy (derived from `paddingPx`) or exposed as an option on `loadAssets(...)`?
3. Do we want to expose the UV policy (inset/extrude) in `WebGpuAtlasLayout` for debugging/inspection, even if it doesn’t affect packing?
4. Is there a preferred manual repro scenario (specific sprites/fonts in `packages/content-sample`) to validate before/after visually?

## 14. Follow-Up Work
- Add a golden-image or GPU-readback based regression harness once a stable rendering test environment exists.
- Consider adding mipmaps + linear filtering support, which would likely require multi-pixel extrusion and/or per-mip border handling.

## 15. References
- Issue 812: https://github.com/hansjm10/Idle-Game-Engine/issues/812
- Renderer UV generation + atlas upload: `packages/renderer-webgpu/src/webgpu-renderer.ts`
- Atlas packing layout: `packages/renderer-webgpu/src/atlas-packer.ts`
- Sprite UV type + batching: `packages/renderer-webgpu/src/sprite-batching.ts`
- Renderer unit tests + WebGPU stubs: `packages/renderer-webgpu/src/webgpu-renderer.test.ts`

## Appendix A — Glossary
- **Atlas**: A single texture that contains multiple sprites/fonts packed into one image.
- **UV**: Normalized texture coordinates in `[0, 1]` used for sampling.
- **Texel**: A single pixel in a texture.
- **Half-texel inset**: Computing UVs using texel centers (`+0.5` and `-0.5` pixel offsets) instead of texel edges.
- **Padding extrusion**: Copying edge texels into the surrounding atlas padding so out-of-bounds sampling still hits a similar color.

## Appendix B — Change Log
| Date       | Author | Change Summary |
|------------|--------|----------------|
| 2026-01-24 | Codex (AI) | Initial draft |
