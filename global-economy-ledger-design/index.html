<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-global-economy-ledger-design" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Stabilise Global Economy with Server-Authoritative Ledger | Idle Engine Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hansjm10.github.io/Idle-Game-Engine/global-economy-ledger-design"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Stabilise Global Economy with Server-Authoritative Ledger | Idle Engine Docs"><meta data-rh="true" name="description" content="Document Control"><meta data-rh="true" property="og:description" content="Document Control"><link data-rh="true" rel="icon" href="/Idle-Game-Engine/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hansjm10.github.io/Idle-Game-Engine/global-economy-ledger-design"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/global-economy-ledger-design" hreflang="en"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/global-economy-ledger-design" hreflang="x-default"><link rel="stylesheet" href="/Idle-Game-Engine/assets/css/styles.ddf7989c.css">
<script src="/Idle-Game-Engine/assets/js/runtime~main.ab48c13f.js" defer="defer"></script>
<script src="/Idle-Game-Engine/assets/js/main.f7253bbf.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Idle-Game-Engine/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_li4T" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Idle-Game-Engine/"><div class="navbar__logo"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--light_vaEm"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--dark_axH8"></div><b class="navbar__title text--truncate">Idle Engine</b></a><a class="navbar__item navbar__link" href="/Idle-Game-Engine/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle__Exw colorModeToggle_Lslw"><button class="clean-btn toggleButton_AMBK toggleButtonDisabled_p4Bd" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 lightToggleIcon_p2sk"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 darkToggleIcon_B2qX"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 systemToggleIcon_PWgn"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_RKai"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_nqaE"><div class="docsWrapper_CSLE"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sOWX" type="button"></button><div class="docRoot_qxtV"><main class="docMainContainer_tfRv docMainContainerEnhanced_qAvX"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_hyci"><div class="docItemContainer_tcAC"><article><div class="tocCollapsible_WMbj theme-doc-toc-mobile tocMobile_wI3e"><button type="button" class="clean-btn tocCollapsibleButton_rjEa">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Stabilise Global Economy with Server-Authoritative Ledger</h1></header>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="document-control">Document Control<a href="#document-control" class="hash-link" aria-label="Direct link to Document Control" title="Direct link to Document Control" translate="no">​</a></h2>
<ul>
<li class=""><strong>Title</strong>: Stabilise Global Economy with Server-Authoritative Ledger (initiative token: <code>GEL-001</code>)</li>
<li class=""><strong>Authors</strong>: Idle Engine design-authoring agent (AI); Jordan Hans (hansjm10)</li>
<li class=""><strong>Reviewers</strong>: Jordan Hans (hansjm10); Runtime Core Maintainers; Social Service Maintainers; Content/Design Maintainers</li>
<li class=""><strong>Status</strong>: Approved (Design Ready for Implementation)</li>
<li class=""><strong>Last Updated</strong>: 2025-11-17</li>
<li class=""><strong>Related Issues</strong>: <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/397" target="_blank" rel="noopener noreferrer" class="">#397</a>, <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/399" target="_blank" rel="noopener noreferrer" class="">#399</a></li>
<li class=""><strong>Execution Mode</strong>: AI-led</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="1-summary">1. Summary<a href="#1-summary" class="hash-link" aria-label="Direct link to 1. Summary" title="Direct link to 1. Summary" translate="no">​</a></h2>
<p>This document specifies the design for the initiative <code>GEL-001</code>: stabilising the Idle Engine’s <strong>global economy</strong> by introducing a <strong>server-authoritative ledger</strong> and economy APIs in <code>services/social</code>, while keeping per-player simulation client-side and deterministic via <code>@idle-engine/core</code>. The proposal formalises a split between <strong>local, client-authoritative soft progression</strong> and <strong>server-authoritative hard economic state</strong> that underpins leaderboards, guilds, and shared world features. Using this design, the social service enforces invariants on spends, trades, and contributions without running a continuous per-player simulation, relying instead on deterministic replay and bounded validation. The impact is a globally consistent economy that tolerates untrusted clients, supports cross-device play, and scales operationally without a full server-side sim for every player.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="2-context--problem-statement">2. Context &amp; Problem Statement<a href="#2-context--problem-statement" class="hash-link" aria-label="Direct link to 2. Context &amp; Problem Statement" title="Direct link to 2. Context &amp; Problem Statement" translate="no">​</a></h2>
<ul>
<li class="">
<p><strong>Background</strong></p>
<ul>
<li class="">The Idle Engine core runtime (<code>packages/core/src/index.ts</code>) implements a deterministic fixed-step loop with a command queue, event bus, and diagnostics timeline suitable for browser and Node execution.</li>
<li class="">The web shell (<code>packages/shell-web</code>) runs the core in a worker and will present resources, upgrades, and social UI.</li>
<li class="">The social backend (<code>services/social/src/index.ts</code>) currently exposes stubbed <code>leaderboard</code> and <code>guild</code> routes but does not own any economic state; responses are placeholder-only.</li>
<li class="">Design goals in <code>docs/idle-engine-design.md</code> emphasise:<!-- -->
<ul>
<li class="">Web-first runtime, portable to Node and native shells.</li>
<li class="">Optional social services for leaderboards and guild coordination.</li>
<li class="">Deterministic, low-overhead simulations and Node-based headless runs (<code>tools/runtime-sim/index.ts</code>) for diagnostics and analytics.</li>
</ul>
</li>
<li class="">In recent discussions, we asserted that the <strong>global economy must be stable</strong>, implying we should not fully trust clients for shared economic state.</li>
</ul>
</li>
<li class="">
<p><strong>Problem</strong></p>
<ul>
<li class="">Today, there is no defined concept of <strong>hard vs soft currencies</strong>, no server-authoritative economic ledger, and no invariants enforced on leaderboard submissions or guild contributions.</li>
<li class="">All social endpoints in <code>services/social</code> are effectively <strong>stateless stubs</strong> returning fixed shapes, providing no real protection against:<!-- -->
<ul>
<li class="">Inflated or forged scores.</li>
<li class="">Illegitimate contributions to shared resources (guild banks, world events).</li>
<li class="">Economic exploits that would destabilise a global market or progression path.</li>
</ul>
</li>
<li class="">Running the entire simulation on the server for every player to address these issues would be <strong>resource-exhaustive and operationally complex</strong>, contradicting the design’s web-first, client-centric runtime.</li>
</ul>
</li>
<li class="">
<p><strong>Forces</strong></p>
<ul>
<li class=""><strong>Constraints</strong>
<ul>
<li class="">Maintain web-first, browser-run simulation per <code>docs/idle-engine-design.md</code>.</li>
<li class="">Avoid per-player continuous server ticks; server CPU budgets should remain bounded and predictable.</li>
<li class="">Preserve deterministic behaviour of <code>IdleEngineRuntime</code> (<code>packages/core/src/index.ts</code>) across client and server.</li>
<li class="">Uphold API stability for social endpoints as they evolve beyond stubs.</li>
</ul>
</li>
<li class=""><strong>External Requirements</strong>
<ul>
<li class="">Global leaderboards and guild features must reflect <strong>canonical, server-validated state</strong>.</li>
<li class="">Clients may be untrusted; malicious actors must not be able to destabilise the global economy.</li>
</ul>
</li>
<li class=""><strong>Timelines</strong>
<ul>
<li class="">Initial implementation must be small, testable, and incrementally deployable (no big-bang migration).</li>
<li class="">The initiative <code>GEL-001</code> should be deliverable in phases that can be executed by AI agents following this document.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="3-goals--non-goals">3. Goals &amp; Non-Goals<a href="#3-goals--non-goals" class="hash-link" aria-label="Direct link to 3. Goals &amp; Non-Goals" title="Direct link to 3. Goals &amp; Non-Goals" translate="no">​</a></h2>
<ul>
<li class="">
<p><strong>Goals</strong></p>
<ol>
<li class="">Define a clear split between <strong>hard, server-authoritative economies</strong> and <strong>soft, client-authoritative progression</strong> within initiative <code>GEL-001</code>.</li>
<li class="">Extend <code>services/social</code> with a <strong>persistent ledger and APIs</strong> for balances, spends, trades, and contributions, enforcing economic invariants.</li>
<li class="">Ensure <strong>leaderboard and guild endpoints</strong> rely on server-authoritative values, not client-reported totals.</li>
<li class="">Provide a <strong>validation model</strong> that uses deterministic replay via <code>IdleEngineRuntime</code> in Node only for bounded, on-demand verification (e.g., suspicious updates), not continuous per-player ticking.</li>
<li class="">Instrument economic flows with <strong>telemetry and diagnostics</strong> (e.g., counters for rejected operations, anomaly flags).</li>
<li class="">Provide an <strong>AI-ready work breakdown</strong> and guardrails so autonomous agents can implement initiative <code>GEL-001</code> safely.</li>
</ol>
</li>
<li class="">
<p><strong>Non-Goals</strong></p>
<ol>
<li class="">Implement a full in-game marketplace, auction house, or complex derivatives systems; this design focuses on linear balances and simple trades.</li>
<li class="">Ship a GUI for economy tuning; balancing remains a content/design activity defined via existing content packs.</li>
<li class="">Overhaul the entire simulation model in <code>@idle-engine/core</code>; we only integrate with it for verification and offline/analytic workloads.</li>
<li class="">Replace or redesign the authentication stack (Keycloak/OIDC) already used in <code>services/social/src/middleware/auth.ts</code>.</li>
<li class="">Guarantee perfect anti-cheat; we target <strong>pragmatic stability of the global economy</strong>, not absolute attack elimination.</li>
</ol>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="4-stakeholders-agents--impacted-surfaces">4. Stakeholders, Agents &amp; Impacted Surfaces<a href="#4-stakeholders-agents--impacted-surfaces" class="hash-link" aria-label="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" title="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" translate="no">​</a></h2>
<ul>
<li class="">
<p><strong>Primary Stakeholders</strong></p>
<ul>
<li class="">Runtime Team: owners of <code>packages/core</code> and deterministic sim semantics.</li>
<li class="">Social Service Team: owners of <code>services/social</code> and economic APIs.</li>
<li class="">Content/Design Team: defines which currencies are “hard” vs “soft” and the intended economic constraints.</li>
<li class="">Dev Experience &amp; Tooling: owners of <code>tools/runtime-sim</code> and CI integration.</li>
</ul>
</li>
<li class="">
<p><strong>Agent Roles</strong></p>
<ul>
<li class=""><strong>Runtime Implementation Agent</strong>
<ul>
<li class="">Modifies <code>packages/core</code> only where needed to support economic verification hooks and diagnostic exports for initiative <code>GEL-001</code>.</li>
<li class="">Maintains determinism and test coverage.</li>
</ul>
</li>
<li class=""><strong>Social Service Implementation Agent</strong>
<ul>
<li class="">Implements ledger schemas, routes, and persistence in <code>services/social</code>.</li>
<li class="">Adds validations and guards to protect the global economy.</li>
</ul>
</li>
<li class=""><strong>Content/Schema Agent</strong>
<ul>
<li class="">Updates <code>content-schema</code> and <code>content-sample</code> if economy classifications (hard/soft currencies) need schema-level representation.</li>
</ul>
</li>
<li class=""><strong>Docs &amp; Design Agent</strong>
<ul>
<li class="">Maintains this design and related docs in <code>docs/</code>, ensuring they track the implementation status of initiative <code>GEL-001</code>.</li>
</ul>
</li>
<li class=""><strong>Testing &amp; Validation Agent</strong>
<ul>
<li class="">Extends Vitest suites in <code>packages/core</code>, <code>services/social</code>, and end-to-end smoke tests under <code>tools/a11y-smoke-tests</code>.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Affected Packages/Services</strong></p>
<ul>
<li class=""><code>packages/core/src/index.ts</code> (runtime interface for diagnostics/verification).</li>
<li class=""><code>services/social/src/index.ts</code>, <code>services/social/src/routes/*</code>, <code>services/social/src/types/*</code>.</li>
<li class=""><code>content-schema</code> and <code>content-sample</code> (if currency classification is exposed to content authors).</li>
<li class=""><code>tools/runtime-sim/index.ts</code> (for reuse or extension in verification flows).</li>
<li class=""><code>docs/idle-engine-design.md</code> and related design docs referencing economy behaviour.</li>
</ul>
</li>
<li class="">
<p><strong>Compatibility Considerations</strong></p>
<ul>
<li class="">Existing stub social endpoints must remain <strong>backward compatible in shape</strong> where external integrations exist; new fields should be additive.</li>
<li class="">Authentication semantics (<code>req.user</code> from <code>createAuthMiddleware</code> in <code>services/social/src/middleware/auth.ts</code>) must remain stable.</li>
<li class="">The runtime’s public API in <code>packages/core/src/index.ts</code> must not silently change semantics (tick behaviour, diagnostics contracts) without versioning.</li>
<li class="">Where breaking changes to social APIs are unavoidable, they must be gated behind versioned paths or feature flags.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="5-current-state">5. Current State<a href="#5-current-state" class="hash-link" aria-label="Direct link to 5. Current State" title="Direct link to 5. Current State" translate="no">​</a></h2>
<ul>
<li class="">
<p><strong>Runtime (<code>@idle-engine/core</code>)</strong></p>
<ul>
<li class="">Implements <code>IdleEngineRuntime</code> in <code>packages/core/src/index.ts</code>, which:<!-- -->
<ul>
<li class="">Runs a fixed-step tick loop (<code>tick(deltaMs)</code>), bounded by <code>maxStepsPerFrame</code>.</li>
<li class="">Uses a <code>CommandQueue</code> and <code>CommandDispatcher</code> to process commands deterministically.</li>
<li class="">Emits diagnostics via <code>createRuntimeDiagnosticsController</code> and <code>getDiagnosticTimelineSnapshot()</code> for offline analysis and CI (<code>tools/runtime-sim/index.ts</code>).</li>
</ul>
</li>
<li class="">No explicit concept of “economy verification” exists; the runtime is agnostic to whether it is used in a client or server context.</li>
</ul>
</li>
<li class="">
<p><strong>Web Shell (<code>packages/shell-web</code>)</strong></p>
<ul>
<li class="">Boots the runtime loop and will render panels for resources and social features (<code>packages/shell-web/README.md</code>).</li>
<li class="">Currently assumes the client owns the moment-to-moment sim and fetches social data from <code>services/social</code>.</li>
</ul>
</li>
<li class="">
<p><strong>Social Service (<code>services/social</code>)</strong></p>
<ul>
<li class="">Express server entrypoint at <code>services/social/src/index.ts</code>:<!-- -->
<ul>
<li class="">Uses Helmet, JSON body parsing, and request logging.</li>
<li class="">Applies <code>createAuthMiddleware</code> to all routes, enforcing OIDC via Keycloak (<code>services/social/src/middleware/auth.ts</code>).</li>
<li class="">Mounts <code>leaderboardRouter</code> and <code>guildRouter</code>.</li>
</ul>
</li>
<li class=""><code>leaderboardRouter</code> (<code>services/social/src/routes/leaderboard.ts</code>):<!-- -->
<ul>
<li class=""><code>GET /leaderboard/:leaderboardId</code>: returns a stub entry for the current user with score 0, no persistence.</li>
<li class=""><code>POST /leaderboard/submit</code>: validates payload using zod but only echoes back a “queued” response, with no ledger update.</li>
</ul>
</li>
<li class=""><code>guildRouter</code> (<code>services/social/src/routes/guild.ts</code>):<!-- -->
<ul>
<li class=""><code>GET /guilds/mine</code>: returns <code>guild: null</code> stub.</li>
<li class=""><code>POST /guilds</code>: validates, generates a synthetic <code>guildId</code>, and returns an accepted response; no persistence or economic rules.</li>
</ul>
</li>
<li class="">No DB or durable storage is configured; <code>docker-compose.yml</code> starts the social service alongside Keycloak but without an attached datastore.</li>
</ul>
</li>
<li class="">
<p><strong>Content &amp; Schema</strong></p>
<ul>
<li class="">Content modules and schemas define resources, generators, upgrades, etc., but there is no explicit notion of <strong>hard</strong> vs <strong>soft</strong> currencies encoded at the schema level (follow-up work may be needed).</li>
</ul>
</li>
<li class="">
<p><strong>Testing &amp; Observability</strong></p>
<ul>
<li class="">Vitest and diagnostics coverage for the runtime and social service exist but are not focused on economic invariants.</li>
<li class=""><code>tools/runtime-sim/index.ts</code> shows how the runtime is executed under Node with a diagnostics timeline.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="6-proposed-solution">6. Proposed Solution<a href="#6-proposed-solution" class="hash-link" aria-label="Direct link to 6. Proposed Solution" title="Direct link to 6. Proposed Solution" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="61-architecture-overview">6.1 Architecture Overview<a href="#61-architecture-overview" class="hash-link" aria-label="Direct link to 6.1 Architecture Overview" title="Direct link to 6.1 Architecture Overview" translate="no">​</a></h3>
<ul>
<li class="">
<p><strong>Narrative</strong></p>
<ul>
<li class="">Initiative `` introduces a <strong>server-authoritative economic ledger</strong> in <code>services/social</code> responsible for:<!-- -->
<ul>
<li class="">Tracking balances of designated <strong>hard currencies</strong> per authenticated user.</li>
<li class="">Applying and validating economic operations (earn, spend, trade, contribute).</li>
<li class="">Powering leaderboards and guild resource views using canonical server values.</li>
</ul>
</li>
<li class="">The <strong>client</strong> (web shell and future native shells):<!-- -->
<ul>
<li class="">Runs the full simulation using <code>IdleEngineRuntime</code> locally.</li>
<li class="">Treats hard currency balances from the social service as authoritative.</li>
<li class="">Performs <strong>optimistic UI updates</strong> but reconciles against server-ledger responses and clamps to server-provided values.</li>
</ul>
</li>
<li class="">The server <strong>does not</strong> tick the simulation for each player:<!-- -->
<ul>
<li class="">Instead, it accepts <strong>commands/events</strong> that mutate the ledger directly.</li>
<li class="">For certain high-risk operations or suspicious patterns, it uses <strong>deterministic replay</strong> of the runtime under Node (borrowing from <code>tools/runtime-sim</code>) to verify plausibility within bounded time windows.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Diagram</strong></p>
</li>
</ul>
<p>Conceptual flow (to be formalised as a diagram in a follow-up PR):</p>
<ul>
<li class="">Client:<!-- -->
<ul>
<li class=""><code>IdleEngineRuntime</code> (local sim) → generates resource deltas and proposed actions (spend/trade/contribute).</li>
<li class="">Actions → <code>services/social</code> API calls with minimal data (operation type, amount, relevant identifiers, client-side state hints).</li>
</ul>
</li>
<li class="">Server:<!-- -->
<ul>
<li class="">Auth middleware attaches <code>user.id</code>.</li>
<li class="">Economy controller validates operation:<!-- -->
<ul>
<li class="">Checks ledger balances and invariants.</li>
<li class="">Optionally triggers deterministic replay verification for flagged cases.</li>
</ul>
</li>
<li class="">Ledger state updated in DB.</li>
<li class="">Responses include authoritative balances and outcome metadata, which the client uses to reconcile.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="62-detailed-design">6.2 Detailed Design<a href="#62-detailed-design" class="hash-link" aria-label="Direct link to 6.2 Detailed Design" title="Direct link to 6.2 Detailed Design" translate="no">​</a></h3>
<ul>
<li class="">
<p><strong>Runtime Changes</strong></p>
<ul>
<li class="">Expose or refine an API in <code>packages/core/src/index.ts</code> to:<!-- -->
<ul>
<li class="">Generate a <strong>compact summary</strong> of a player’s economic state at a given tick (e.g., resource rates, key milestones) for replay scenarios.</li>
<li class="">Initialise <code>IdleEngineRuntime</code> from such a summary for deterministic replay on the server.</li>
</ul>
</li>
<li class="">Provide a <strong>“verification mode”</strong> helper (e.g., <code>createVerificationRuntime</code>) that:<!-- -->
<ul>
<li class="">Runs a truncated number of ticks with specified content configuration.</li>
<li class="">Returns computed expected economic deltas for a given timeframe.</li>
</ul>
</li>
<li class="">Ensure any changes maintain backwards compatibility and determinism across browser and Node.</li>
</ul>
</li>
<li class="">
<p><strong>Data &amp; Schemas</strong></p>
<ul>
<li class="">Introduce an economy schema in <code>services/social/src/types/economy.ts</code> (new file):<!-- -->
<ul>
<li class=""><code>HardCurrencyId</code> enum or string union (e.g., <code>&quot;GEMS&quot;</code>, <code>&quot;BONDS&quot;</code>, <code>&quot;GUILD_TOKENS&quot;</code>).</li>
<li class=""><code>LedgerEntry</code> type: <code>{ userId, currencyId, balance, updatedAt }</code>, representing the latest canonical balance for a given <code>(userId, currencyId)</code> pair.</li>
<li class=""><code>EconomyOperationKind</code> union: <code>&quot;Earn&quot; | &quot;Spend&quot; | &quot;Transfer&quot; | &quot;GuildContribution&quot;</code>.</li>
<li class=""><code>EconomyOperationInput</code> type: request payloads for each operation kind (what the client sends).</li>
<li class=""><code>EconomyOperationRecord</code> type: an immutable, persisted transaction history record:<!-- -->
<ul>
<li class=""><code>{ id, userId, currencyId, kind, amount, source, reason, occurredAt, clientTimestamp?, guildId?, counterpartyUserId?, correlationId?, metadata? }</code>.</li>
<li class=""><code>occurredAt</code> is the server timestamp used for rate limiting and replay windows; <code>clientTimestamp</code> is kept for anomaly detection.</li>
<li class=""><code>source</code>/<code>reason</code> capture where the operation originated (e.g., quest reward, shop purchase) for telemetry.</li>
</ul>
</li>
</ul>
</li>
<li class="">Persistence:<!-- -->
<ul>
<li class="">Represent balances in a table or collection like <code>economy_ledger_entries</code> keyed by <code>(user_id, currency_id)</code>, mapping to <code>LedgerEntry</code>.</li>
<li class="">Represent transaction history in an append-only <code>economy_operations</code> store keyed by <code>id</code>, mapping to <code>EconomyOperationRecord</code> and indexed by <code>user_id</code>, <code>guild_id</code>, <code>currency_id</code>, <code>kind</code>, and <code>occurred_at</code>.</li>
<li class="">Initial implementation may start with an <strong>in-memory store</strong> that still keeps a full per-user operation log alongside ledger entries, with a clear interface that can be backed by a database in a later milestone.</li>
<li class="">The ledger abstraction must compute balances from the ordered <code>EconomyOperationRecord</code> stream and expose helpers for:<!-- -->
<ul>
<li class="">Querying operations for a user/currency/kind over a time window (e.g., “last 24h spends”) to enforce configurable max spend rates.</li>
<li class="">Reconstructing a sequence of operations for deterministic replay and audit (e.g., recomputing expected balances for suspicious submissions).</li>
</ul>
</li>
<li class="">The abstraction boundary should allow swapping implementation without changing route handlers.</li>
</ul>
</li>
<li class="">Optional schema updates in <code>content-schema</code>:<!-- -->
<ul>
<li class="">Flag each resource as <code>hard</code> or <code>soft</code>, so the runtime and social service can agree on which resources must be mediated by the ledger.</li>
<li class="">TODO: Content/Schema Agent to propose specific fields and validations.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>APIs &amp; Contracts</strong></p>
<ul>
<li class="">New endpoints (versioned under <code>/economy</code> in <code>services/social</code>):<!-- -->
<ul>
<li class=""><code>GET /economy/balances</code>
<ul>
<li class="">Returns current balances for all hard currencies for <code>req.user.id</code>.</li>
</ul>
</li>
<li class=""><code>POST /economy/earn</code>
<ul>
<li class="">Payload: <code>{ currencyId, amount, source, clientTimestamp, simMetadata? }</code>.</li>
<li class="">Use primarily for server-driven rewards (events, achievements); client-submitted earns are treated conservatively and often unnecessary if hard currency creation is server-triggered.</li>
</ul>
</li>
<li class=""><code>POST /economy/spend</code>
<ul>
<li class="">Payload: <code>{ currencyId, amount, reason, clientTimestamp, simMetadata? }</code>.</li>
<li class="">Validation: server checks user’s balance and configurable max spend rate, applies spend atomically, returns new balance.</li>
</ul>
</li>
<li class=""><code>POST /economy/transfer</code>
<ul>
<li class="">Payload: <code>{ currencyId, amount, toUserId, reason, clientTimestamp, simMetadata? }</code>.</li>
<li class="">Validation: checks sender’s balance, optional min/max limits, and anti-abuse policies before updating both ledgers.</li>
</ul>
</li>
<li class=""><code>POST /economy/guild-contribute</code>
<ul>
<li class="">Payload: <code>{ currencyId, amount, guildId, clientTimestamp, simMetadata? }</code>.</li>
<li class="">Updates guild bank ledger, powers guild views and shared contributions.</li>
</ul>
</li>
</ul>
</li>
<li class="">Leaderboards and guild routes update:<!-- -->
<ul>
<li class=""><code>GET /leaderboard/:leaderboardId</code>
<ul>
<li class="">Data source: aggregated ledger values and precomputed ranks, not client-submitted scores.</li>
<li class="">In the initial phase, scores may still be stubbed but the shape should anticipate server-authoritative scores.</li>
</ul>
</li>
<li class=""><code>POST /leaderboard/submit</code>
<ul>
<li class="">Transitions from “queued” stub to:<!-- -->
<ul>
<li class="">Validating submissions against known ledger state (e.g., verifying that global scores correlate with ledgered hard currency or key stats).</li>
<li class="">Optionally scheduling asynchronous verification jobs.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="">Request metadata:<!-- -->
<ul>
<li class=""><code>simMetadata</code> field (optional) may contain:<!-- -->
<ul>
<li class=""><code>lastKnownServerBalance</code>, <code>clientClaimedBalance</code>, <code>sessionsSinceLastSync</code>, <code>offlineDurationMs</code>, <code>runtimeVersion</code>.</li>
</ul>
</li>
<li class="">This metadata is used by the server to detect anomalies, not to accept client balances as truth.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Tooling &amp; Automation</strong></p>
<ul>
<li class="">Extend <code>tools/runtime-sim</code> or add a sibling CLI:<!-- -->
<ul>
<li class="">Command: <code>pnpm core:economy-verify --ticks &lt;n&gt; --snapshot &lt;file&gt;</code> (exact API TBD).</li>
<li class="">Given a snapshot describing a player’s state and offline duration, computes the maximum plausible hard currency gain under current content.</li>
</ul>
</li>
<li class="">CI integration:<!-- -->
<ul>
<li class="">Add targeted tests under <code>services/social</code> to ensure invariants:<!-- -->
<ul>
<li class="">Cannot overspend.</li>
<li class="">Cannot transfer more than balance.</li>
<li class="">Rate limits for earns/spends per time window.</li>
</ul>
</li>
</ul>
</li>
<li class="">Developer tooling:<!-- -->
<ul>
<li class="">Scripts to seed test users and ledgers for manual QA and Playwright tests (e.g., <code>tools/scripts/seed-economy-users.ts</code>, TODO).</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="63-operational-considerations">6.3 Operational Considerations<a href="#63-operational-considerations" class="hash-link" aria-label="Direct link to 6.3 Operational Considerations" title="Direct link to 6.3 Operational Considerations" translate="no">​</a></h3>
<ul>
<li class="">
<p><strong>Deployment</strong></p>
<ul>
<li class="">Continue using <code>docker-compose.yml</code> for local Keycloak + social service; extend configuration to include persistent storage for the ledger when adopted.</li>
<li class="">For initial milestones, in-memory ledger is acceptable for development; production deployments MUST configure a persistent store before enabling real economic features (TODO: choose DB technology).</li>
<li class="">CI must run <code>pnpm test --filter @idle-engine/social-service</code> to validate economic routes and invariants.</li>
</ul>
</li>
<li class="">
<p><strong>Telemetry &amp; Observability</strong></p>
<ul>
<li class="">Metrics:<!-- -->
<ul>
<li class="">Count of operations by type: <code>economy.operations_total{type=Earn|Spend|Transfer|GuildContribution}</code>.</li>
<li class="">Count of rejected operations: <code>economy.rejections_total{reason=InsufficientFunds|RateLimit|InvalidPayload|ReplayMismatch}</code>.</li>
<li class="">Anomaly flags: <code>economy.anomalies_total{type=ReplayMismatch|SuspiciousOfflineGain}</code>.</li>
</ul>
</li>
<li class="">Logging:<!-- -->
<ul>
<li class="">Structured logs for each economic operation with user ID, operation type, amounts, and decision outcome.</li>
<li class="">Avoid logging PII beyond stable identifiers (user ID, guild ID).</li>
</ul>
</li>
<li class="">Diagnostics:<!-- -->
<ul>
<li class="">For replay-based verification, log operation IDs and diagnostic summaries without dumping full state.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Security &amp; Compliance</strong></p>
<ul>
<li class="">All economy endpoints must require authentication via Keycloak (<code>createAuthMiddleware</code>).</li>
<li class="">Input must be validated with zod schemas (following existing pattern in <code>leaderboard.ts</code> and <code>guild.ts</code>).</li>
<li class="">Avoid storing sensitive personal data beyond what is already implied by OIDC (user IDs, usernames).</li>
<li class="">Implement basic rate limiting for economic endpoints (middleware or reverse proxy rules; TODO for infra owner).</li>
<li class="">Audit logging should make it possible to trace economic changes per user and per guild by referencing <code>EconomyOperationRecord.id</code> and correlating log entries with stored operations.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="7-work-breakdown--delivery-plan">7. Work Breakdown &amp; Delivery Plan<a href="#7-work-breakdown--delivery-plan" class="hash-link" aria-label="Direct link to 7. Work Breakdown &amp; Delivery Plan" title="Direct link to 7. Work Breakdown &amp; Delivery Plan" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="71-issue-map">7.1 Issue Map<a href="#71-issue-map" class="hash-link" aria-label="Direct link to 7.1 Issue Map" title="Direct link to 7.1 Issue Map" translate="no">​</a></h3>
<p>Populate GitHub issues based on the following table; all issues reference initiative <code>GEL-001</code> in their descriptions.</p>
<table><thead><tr><th>Issue Title</th><th>Scope Summary</th><th>Proposed Assignee/Agent</th><th>Dependencies</th><th>Acceptance Criteria</th></tr></thead><tbody><tr><td>feat(design): formalise global economy stability (<code>GEL-001</code>)</td><td>Capture final design doc in <code>docs/</code> and link to related specs</td><td>Docs &amp; Design Agent</td><td>None</td><td>Design merged; referenced from <code>docs/idle-engine-design.md</code>; reviewers sign off</td></tr><tr><td>feat(schema): classify hard vs soft currencies</td><td>Extend content schema to mark hard currencies and sample content to use them</td><td>Content/Schema Agent</td><td>Design approval</td><td>Schema/docs updated; tests in <code>content-schema</code> pass; sample packs compile</td></tr><tr><td>feat(social): introduce server-authoritative ledger abstraction</td><td>Add in-memory ledger types and interfaces in <code>services/social/src/types</code></td><td>Social Service Implementation Agent</td><td>Schema classification (optional)</td><td>Ledger API supports create/read/update operations; unit tests cover basic operations</td></tr><tr><td>feat(social): implement economy routes (/economy)</td><td>Add balances, spend, transfer, and guild contribution endpoints</td><td>Social Service Implementation Agent</td><td>Ledger abstraction</td><td>Routes validated with zod, protected by auth; tests verify invariants (no overspend, etc.)</td></tr><tr><td>feat(social): wire leaderboards and guilds to ledger</td><td>Drive leaderboard scores and guild resources from ledger data</td><td>Social Service Implementation Agent</td><td>Economy routes</td><td><code>GET /leaderboard/:id</code> and <code>GET /guilds/mine</code> use ledger-derived values; tests updated</td></tr><tr><td>feat(core): add verification runtime helpers</td><td>Expose runtime helpers to support deterministic economy replay</td><td>Runtime Implementation Agent</td><td>Design approval</td><td>New APIs documented; tests confirm deterministic behaviour in Node and browser</td></tr><tr><td>feat(tools): add economy verification CLI</td><td>CLI wrapper around runtime helper for economic replay/validation</td><td>Runtime Implementation Agent</td><td>Verification helpers</td><td>CLI runs on snapshots; emits JSON; used in at least one test</td></tr><tr><td>chore(test): add economic invariants to social tests</td><td>Expand Vitest suites under <code>services/social</code></td><td>Testing &amp; Validation Agent</td><td>Economy routes implemented</td><td>Tests fail on invariant violations; coverage includes all economic operations</td></tr><tr><td>chore(a11y): extend shell-web tests for economy UI</td><td>Ensure economic UI interactions do not regress accessibility</td><td>Testing &amp; Validation Agent</td><td>Basic economy UI implemented in shell</td><td><code>pnpm test:a11y</code> passes for flows involving hard currency displays and errors</td></tr><tr><td>chore(docs): update idle-engine-design.md with economy model</td><td>Summarise hard/soft currency model &amp; ledger in main design doc</td><td>Docs &amp; Design Agent</td><td>Implementation stable</td><td><code>docs/idle-engine-design.md</code> references this document; glossary updated</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="72-milestones">7.2 Milestones<a href="#72-milestones" class="hash-link" aria-label="Direct link to 7.2 Milestones" title="Direct link to 7.2 Milestones" translate="no">​</a></h3>
<ul>
<li class="">
<p><strong>Phase 1: Foundations</strong></p>
<ul>
<li class="">Finalise this design (initiative <code>GEL-001</code>), including updated <code>docs/idle-engine-design.md</code>.</li>
<li class="">Implement ledger abstraction and in-memory store in <code>services/social</code>.</li>
<li class="">Add <code>/economy/balances</code> and <code>/economy/spend</code> endpoints with strong validation.</li>
<li class="">Establish economic tests and metrics.</li>
<li class="">Gating criteria:<!-- -->
<ul>
<li class="">All new tests pass locally and in CI.</li>
<li class="">No breaking changes to existing social routes; stubs still functional.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Phase 2: Integration</strong></p>
<ul>
<li class="">Wire leaderboards and guilds to the ledger.</li>
<li class="">Integrate the web shell with economy endpoints (client reconciliation logic).</li>
<li class="">Introduce optional replay-based verification for high-risk flows.</li>
<li class="">Gating criteria:<!-- -->
<ul>
<li class="">Leaderboard and guild endpoints operate against ledger state.</li>
<li class="">End-to-end flows (client → social → ledger) pass manual and automated QA.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Phase 3: Hardening &amp; Scale</strong></p>
<ul>
<li class="">Move ledger to a persistent store and configure in deployment pipelines.</li>
<li class="">Add rate limiting, anomaly detection, and operational runbooks.</li>
<li class="">Tune economic parameters based on early telemetry and tests.</li>
<li class="">Gating criteria:<!-- -->
<ul>
<li class="">No known class of exploit allows unlimited hard currency creation or transfer.</li>
<li class="">Operational dashboards show stable economic metrics over time.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="73-coordination-notes">7.3 Coordination Notes<a href="#73-coordination-notes" class="hash-link" aria-label="Direct link to 7.3 Coordination Notes" title="Direct link to 7.3 Coordination Notes" translate="no">​</a></h3>
<ul>
<li class="">
<p><strong>Hand-off Package</strong></p>
<ul>
<li class="">This design document (<code>docs/global-economy-ledger-design.md</code>).</li>
<li class="">References to runtime code (<code>packages/core/src/index.ts</code>), social service (<code>services/social/src</code>), and tools (<code>tools/runtime-sim/index.ts</code>).</li>
<li class="">Example payloads and JSON contracts for economy endpoints.</li>
<li class="">Test commands: <code>pnpm test --filter @idle-engine/social-service</code>, <code>pnpm test --filter @idle-engine/core</code>, <code>pnpm test:a11y</code>.</li>
</ul>
</li>
<li class="">
<p><strong>Communication Cadence</strong></p>
<ul>
<li class="">Weekly status update on initiative <code>GEL-001</code> summarising merged PRs and risk items.</li>
<li class="">Design reviews at the end of Phase 1 and Phase 2.</li>
<li class="">Escalation path: runtime lead → social lead → project owner.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="8-agent-guidance--guardrails">8. Agent Guidance &amp; Guardrails<a href="#8-agent-guidance--guardrails" class="hash-link" aria-label="Direct link to 8. Agent Guidance &amp; Guardrails" title="Direct link to 8. Agent Guidance &amp; Guardrails" translate="no">​</a></h2>
<ul>
<li class="">
<p><strong>Context Packets</strong></p>
<ul>
<li class="">Before work on initiative <code>GEL-001</code>, agents must load:<!-- -->
<ul>
<li class=""><code>docs/idle-engine-design.md</code></li>
<li class="">This design document.</li>
<li class=""><code>packages/core/src/index.ts</code> and tests under <code>packages/core/src/__tests__</code>.</li>
<li class=""><code>services/social/src/index.ts</code>, routes, middleware, and types.</li>
<li class=""><code>tools/runtime-sim/index.ts</code>.</li>
</ul>
</li>
<li class="">Environment:<!-- -->
<ul>
<li class="">Use <code>nvm use</code> to adopt <code>.nvmrc</code> Node version.</li>
<li class="">Use <code>pnpm</code> as per <code>package.json</code> and root <code>README.md</code>.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Prompting &amp; Constraints</strong></p>
<ul>
<li class="">Agents must:<!-- -->
<ul>
<li class="">Follow the repository guidelines in <code>AGENTS.md</code>.</li>
<li class="">Use TypeScript with existing lint rules; prefer pure functions for ledger logic.</li>
<li class="">Respect <code>@typescript-eslint/consistent-type-imports</code>/exports.</li>
<li class="">Structure commits as Conventional Commits (e.g., <code>feat(social): add economy routes</code>).</li>
</ul>
</li>
<li class="">Canonical scripting:<!-- -->
<ul>
<li class="">Run <code>pnpm lint</code> and appropriate <code>pnpm test --filter ...</code> before considering work complete.</li>
<li class="">Do not edit generated <code>dist/</code> artifacts by hand.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Safety Rails</strong></p>
<ul>
<li class="">Forbidden:<!-- -->
<ul>
<li class="">Resetting git history or force-pushing without explicit human approval.</li>
<li class="">Bypassing authentication checks on social routes.</li>
<li class="">Logging access tokens or other secrets; log only stable IDs and high-level metadata.</li>
<li class="">Manually editing <code>docs/coverage/index.md</code>; regenerate via <code>pnpm coverage:md</code> only when required.</li>
</ul>
</li>
<li class="">Rollback procedures:<!-- -->
<ul>
<li class="">If a change destabilises tests or lint, agents must revert the specific commit or open a follow-up fix before proceeding.</li>
<li class="">For economic changes, include feature flags or configuration toggles to disable new behaviour if needed.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Validation Hooks</strong></p>
<ul>
<li class="">Required commands before closing issues:<!-- -->
<ul>
<li class=""><code>pnpm lint</code></li>
<li class=""><code>pnpm test --filter @idle-engine/social-service</code></li>
<li class=""><code>pnpm test --filter @idle-engine/core</code></li>
<li class=""><code>pnpm test:a11y</code> when touching shell-web economy UI.</li>
</ul>
</li>
<li class="">For CLI additions:<!-- -->
<ul>
<li class="">Ensure CLIs print final results as single-line JSON when intended for machine consumption (follow <code>tools/runtime-sim/index.ts</code> pattern).</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="9-alternatives-considered">9. Alternatives Considered<a href="#9-alternatives-considered" class="hash-link" aria-label="Direct link to 9. Alternatives Considered" title="Direct link to 9. Alternatives Considered" translate="no">​</a></h2>
<ol>
<li class="">
<p><strong>Fully Client-Authoritative Economy</strong></p>
<ul>
<li class="">Description: All economic values are computed and stored on the client; server only echoes or passively records data.</li>
<li class="">Pros:<!-- -->
<ul>
<li class="">No server CPU or storage requirements for economy.</li>
<li class="">Simplest implementation.</li>
</ul>
</li>
<li class="">Cons:<!-- -->
<ul>
<li class="">Trivially exploitable; players can freely forge balances and destabilise any global system.</li>
<li class="">Incompatible with “global economy must be stable” requirement of initiative <code>GEL-001</code>.</li>
</ul>
</li>
<li class="">Decision: Rejected.</li>
</ul>
</li>
<li class="">
<p><strong>Fully Server-Authoritative Per-Player Simulation</strong></p>
<ul>
<li class="">Description: Move the entire <code>IdleEngineRuntime</code> for each player to a server process, with clients acting as thin terminals.</li>
<li class="">Pros:<!-- -->
<ul>
<li class="">Strong anti-cheat; the server is the single source of truth for all state.</li>
<li class="">Simplifies economic verification (no need for replay; server is always right).</li>
</ul>
</li>
<li class="">Cons:<!-- -->
<ul>
<li class="">Very high resource usage and operational complexity.</li>
<li class="">Latency-sensitive; idle gameplay responsiveness may suffer.</li>
<li class="">Contradicts web-first, offline-capable design goals in <code>docs/idle-engine-design.md</code>.</li>
</ul>
</li>
<li class="">Decision: Rejected as the primary model; may be used selectively for high-value segments in future.</li>
</ul>
</li>
<li class="">
<p><strong>Aggregated Analytics-Only Checks</strong></p>
<ul>
<li class="">Description: Keep economy client-authoritative but use periodic analytics jobs to detect anomalies after the fact.</li>
<li class="">Pros:<!-- -->
<ul>
<li class="">Lower implementation complexity than a full ledger.</li>
<li class="">No need to change social APIs significantly.</li>
</ul>
</li>
<li class="">Cons:<!-- -->
<ul>
<li class="">Detection is reactive; exploits may damage the economy before detection.</li>
<li class="">No guaranteed global consistency at any point in time.</li>
</ul>
</li>
<li class="">Decision: Rejected as primary strategy; some anomaly detection may still be layered on top of the server-authoritative ledger.</li>
</ul>
</li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="10-testing--validation-plan">10. Testing &amp; Validation Plan<a href="#10-testing--validation-plan" class="hash-link" aria-label="Direct link to 10. Testing &amp; Validation Plan" title="Direct link to 10. Testing &amp; Validation Plan" translate="no">​</a></h2>
<ul>
<li class="">
<p><strong>Unit / Integration</strong></p>
<ul>
<li class=""><code>services/social</code>:<!-- -->
<ul>
<li class="">Unit tests for ledger operations: earns, spends, transfers, guild contributions, and edge cases (insufficient funds, rate limits).</li>
<li class="">Route tests for <code>/economy/*</code>, <code>/leaderboard/*</code>, and <code>/guilds/*</code> verifying invariants and error responses.</li>
</ul>
</li>
<li class=""><code>packages/core</code>:<!-- -->
<ul>
<li class="">Tests for any new verification runtime helpers to ensure deterministic replay across Node and browser environments.</li>
</ul>
</li>
<li class="">Integration tests:<!-- -->
<ul>
<li class="">Simulate a full flow where a user earns and spends hard currency via social APIs and confirm ledger consistency.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Performance</strong></p>
<ul>
<li class="">Benchmarks:<!-- -->
<ul>
<li class="">Measure throughput of typical economy operations under load (earn/spend) in <code>services/social</code>.</li>
<li class="">Ensure replay-based verification runs within a bounded time (e.g., &lt; 200ms per operation for typical cases).</li>
</ul>
</li>
<li class="">Targets:<!-- -->
<ul>
<li class="">Economy endpoints should handle at least a baseline of X operations/sec (TODO: define SLO) without degrading latency beyond Y ms at p95.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Tooling / A11y</strong></p>
<ul>
<li class="">Extend Playwright a11y tests (<code>tools/a11y-smoke-tests</code>) to include:<!-- -->
<ul>
<li class="">Display of hard currency balances.</li>
<li class="">Error states when spends are rejected.</li>
</ul>
</li>
<li class="">Ensure new UI elements in <code>packages/shell-web</code> have proper ARIA attributes and keyboard accessibility.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="11-risks--mitigations">11. Risks &amp; Mitigations<a href="#11-risks--mitigations" class="hash-link" aria-label="Direct link to 11. Risks &amp; Mitigations" title="Direct link to 11. Risks &amp; Mitigations" translate="no">​</a></h2>
<ul>
<li class="">
<p><strong>Risk: Misclassification of Currencies</strong></p>
<ul>
<li class="">Hard currency incorrectly modelled as soft (or vice versa) can undermine the ledger.</li>
<li class="">Mitigation:<!-- -->
<ul>
<li class="">Require content/design sign-off on currency classification.</li>
<li class="">Add schema validations and tests to enforce classification for new resources.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Risk: Ledger Implementation Bugs</strong></p>
<ul>
<li class="">Incorrect balance updates could corrupt the global economy.</li>
<li class="">Mitigation:<!-- -->
<ul>
<li class="">Rigorous unit and integration tests.</li>
<li class="">Use transaction-like semantics when transitioning to a real DB.</li>
<li class="">Implement invariants and sanity checks as assertions (with safe handling in production).</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Risk: Replay Verification Cost</strong></p>
<ul>
<li class="">Deterministic replay may be more expensive than anticipated.</li>
<li class="">Mitigation:<!-- -->
<ul>
<li class="">Limit replay to suspicious cases, not all operations.</li>
<li class="">Constrain replay windows (e.g., maximum offline duration).</li>
<li class="">Profile and optimise runtime hotspots if needed.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Risk: Operational Overhead</strong></p>
<ul>
<li class="">Additional metrics, logs, and DB operations may increase operational complexity.</li>
<li class="">Mitigation:<!-- -->
<ul>
<li class="">Start with minimal metrics and controlled logging levels.</li>
<li class="">Provide clear runbooks and dashboards for operators.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Risk: Backwards Compatibility of APIs</strong></p>
<ul>
<li class="">Changing social APIs could break existing clients or test harnesses.</li>
<li class="">Mitigation:<!-- -->
<ul>
<li class="">Maintain additive changes where possible.</li>
<li class="">Version new endpoints if necessary.</li>
<li class="">Update tests and docs concurrently.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="12-rollout-plan">12. Rollout Plan<a href="#12-rollout-plan" class="hash-link" aria-label="Direct link to 12. Rollout Plan" title="Direct link to 12. Rollout Plan" translate="no">​</a></h2>
<ul>
<li class="">
<p><strong>Milestones</strong></p>
<ul>
<li class="">Phase 1:<!-- -->
<ul>
<li class="">Design approval, ledger abstraction, foundational economy routes, baseline tests.</li>
</ul>
</li>
<li class="">Phase 2:<!-- -->
<ul>
<li class="">Leaderboard and guild wiring, client integration, replay-based verification for selected flows.</li>
</ul>
</li>
<li class="">Phase 3:<!-- -->
<ul>
<li class="">Persistent storage integration, hardening, operationalisation (metrics, runbooks).</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Migration Strategy</strong></p>
<ul>
<li class="">Start with stub-compatible changes:<!-- -->
<ul>
<li class="">Keep existing routes functioning with their current shapes while introducing new <code>/economy</code> endpoints.</li>
</ul>
</li>
<li class="">Introduce ledger-backed scoreboard/guild features behind feature flags or config toggles.</li>
<li class="">Once stable, gradually deprecate stub responses and rely solely on ledger-based data.</li>
</ul>
</li>
<li class="">
<p><strong>Communication</strong></p>
<ul>
<li class="">Document user-visible behaviour changes in release notes and game patch notes.</li>
<li class="">Notify internal stakeholders (runtime, social, content) before enabling ledger-backed features.</li>
<li class="">Maintain an internal FAQ and runbooks for incident response involving economic anomalies.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="13-open-questions">13. Open Questions<a href="#13-open-questions" class="hash-link" aria-label="Direct link to 13. Open Questions" title="Direct link to 13. Open Questions" translate="no">​</a></h2>
<ol>
<li class="">What are the exact <strong>hard currency identifiers</strong> to be supported in the first iteration, and how do they map to existing content resources?<!-- -->
<ul>
<li class="">Owner: Content/Design Team.</li>
</ul>
</li>
<li class="">What are the <strong>target SLOs</strong> for economy endpoints (throughput, latency)?<!-- -->
<ul>
<li class="">Owner: Social Service Team / Ops.</li>
</ul>
</li>
<li class="">Which operations warrant <strong>replay-based verification</strong> vs simple heuristic checks?<!-- -->
<ul>
<li class="">Owner: Runtime + Social leads.</li>
</ul>
</li>
<li class="">What <strong>database technology</strong> will back the ledger in production (PostgreSQL, Redis, etc.)?<!-- -->
<ul>
<li class="">Owner: Infra/Ops.</li>
</ul>
</li>
<li class="">Are there regulatory or platform-specific <strong>compliance requirements</strong> (e.g., regional data residency) that affect storage of economic data?<!-- -->
<ul>
<li class="">Owner: Product/Legal.</li>
</ul>
</li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="14-follow-up-work">14. Follow-Up Work<a href="#14-follow-up-work" class="hash-link" aria-label="Direct link to 14. Follow-Up Work" title="Direct link to 14. Follow-Up Work" translate="no">​</a></h2>
<ul>
<li class="">Design and implement a <strong>marketplace/auction house</strong> model on top of the ledger for player-to-player trading (out of scope for initiative <code>GEL-001</code>).</li>
<li class="">Evaluate and, if necessary, implement <strong>currency sinks</strong> to prevent runaway inflation (e.g., sink-only upgrades, fees).</li>
<li class="">Add <strong>economy visualisation tools</strong> (dashboards or exports) for designers to inspect global state and tune parameters.</li>
<li class="">Explore a lightweight <strong>fraud detection/ML layer</strong> using telemetry from economic operations.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="15-references">15. References<a href="#15-references" class="hash-link" aria-label="Direct link to 15. References" title="Direct link to 15. References" translate="no">​</a></h2>
<ul>
<li class=""><code>docs/idle-engine-design.md</code>: Core runtime and social services overview.</li>
<li class=""><code>packages/core/src/index.ts</code>: <code>IdleEngineRuntime</code> implementation and diagnostics API.</li>
<li class=""><code>services/social/src/index.ts</code>: Social service entrypoint and route wiring.</li>
<li class=""><code>services/social/src/routes/leaderboard.ts</code>: Current leaderboard endpoints.</li>
<li class=""><code>services/social/src/routes/guild.ts</code>: Current guild endpoints.</li>
<li class=""><code>services/social/src/middleware/auth.ts</code>: Auth middleware using Keycloak and JOSE.</li>
<li class=""><code>tools/runtime-sim/index.ts</code>: Headless runtime simulator CLI.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-a--glossary">Appendix A — Glossary<a href="#appendix-a--glossary" class="hash-link" aria-label="Direct link to Appendix A — Glossary" title="Direct link to Appendix A — Glossary" translate="no">​</a></h2>
<ul>
<li class=""><strong>Hard Currency</strong>: A resource whose balance is maintained and enforced by the server (social service), e.g., premium currency, guild tokens.</li>
<li class=""><strong>Soft Currency</strong>: Client-local resources that affect personal progression but do not directly impact shared global systems.</li>
<li class=""><strong>Ledger</strong>: A durable record of economic balances and operations per user and/or guild, maintained by the server.</li>
<li class=""><strong>Deterministic Replay</strong>: Re-running the core simulation with a known seed and content configuration to reconstruct expected economic outcomes.</li>
<li class=""><strong>Initiative <code>GEL-001</code></strong>: Token denoting this design’s focus on global economy stability via a server-authoritative ledger.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-b--change-log">Appendix B — Change Log<a href="#appendix-b--change-log" class="hash-link" aria-label="Direct link to Appendix B — Change Log" title="Direct link to Appendix B — Change Log" translate="no">​</a></h2>
<table><thead><tr><th>Date</th><th>Author</th><th>Change Summary</th></tr></thead><tbody><tr><td>2025-11-16</td><td>Idle Engine design-authoring AI</td><td>Initial draft of global economy stability design for <code>GEL-001</code></td></tr><tr><td>2025-11-17</td><td>Idle Engine design-authoring AI</td><td>Mark design as Approved and link initiative <code>GEL-001</code> from <code>docs/idle-engine-design.md</code> (#399)</td></tr></tbody></table></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_QKxP"><a href="https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/global-economy-ledger-design.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_wOWh" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_Basj"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_AUZ0 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#document-control" class="table-of-contents__link toc-highlight">Document Control</a></li><li><a href="#1-summary" class="table-of-contents__link toc-highlight">1. Summary</a></li><li><a href="#2-context--problem-statement" class="table-of-contents__link toc-highlight">2. Context &amp; Problem Statement</a></li><li><a href="#3-goals--non-goals" class="table-of-contents__link toc-highlight">3. Goals &amp; Non-Goals</a></li><li><a href="#4-stakeholders-agents--impacted-surfaces" class="table-of-contents__link toc-highlight">4. Stakeholders, Agents &amp; Impacted Surfaces</a></li><li><a href="#5-current-state" class="table-of-contents__link toc-highlight">5. Current State</a></li><li><a href="#6-proposed-solution" class="table-of-contents__link toc-highlight">6. Proposed Solution</a><ul><li><a href="#61-architecture-overview" class="table-of-contents__link toc-highlight">6.1 Architecture Overview</a></li><li><a href="#62-detailed-design" class="table-of-contents__link toc-highlight">6.2 Detailed Design</a></li><li><a href="#63-operational-considerations" class="table-of-contents__link toc-highlight">6.3 Operational Considerations</a></li></ul></li><li><a href="#7-work-breakdown--delivery-plan" class="table-of-contents__link toc-highlight">7. Work Breakdown &amp; Delivery Plan</a><ul><li><a href="#71-issue-map" class="table-of-contents__link toc-highlight">7.1 Issue Map</a></li><li><a href="#72-milestones" class="table-of-contents__link toc-highlight">7.2 Milestones</a></li><li><a href="#73-coordination-notes" class="table-of-contents__link toc-highlight">7.3 Coordination Notes</a></li></ul></li><li><a href="#8-agent-guidance--guardrails" class="table-of-contents__link toc-highlight">8. Agent Guidance &amp; Guardrails</a></li><li><a href="#9-alternatives-considered" class="table-of-contents__link toc-highlight">9. Alternatives Considered</a></li><li><a href="#10-testing--validation-plan" class="table-of-contents__link toc-highlight">10. Testing &amp; Validation Plan</a></li><li><a href="#11-risks--mitigations" class="table-of-contents__link toc-highlight">11. Risks &amp; Mitigations</a></li><li><a href="#12-rollout-plan" class="table-of-contents__link toc-highlight">12. Rollout Plan</a></li><li><a href="#13-open-questions" class="table-of-contents__link toc-highlight">13. Open Questions</a></li><li><a href="#14-follow-up-work" class="table-of-contents__link toc-highlight">14. Follow-Up Work</a></li><li><a href="#15-references" class="table-of-contents__link toc-highlight">15. References</a></li><li><a href="#appendix-a--glossary" class="table-of-contents__link toc-highlight">Appendix A — Glossary</a></li><li><a href="#appendix-b--change-log" class="table-of-contents__link toc-highlight">Appendix B — Change Log</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/contributor-handbook">Contributor Handbook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Idle Engine.</div></div></div></footer></div>
</body>
</html>