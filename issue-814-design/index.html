<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-issue-814-design" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">renderer-contract/webgpu: include camera state in RCB for replay correctness (Issue 814) | Idle Engine Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hansjm10.github.io/Idle-Game-Engine/issue-814-design"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="renderer-contract/webgpu: include camera state in RCB for replay correctness (Issue 814) | Idle Engine Docs"><meta data-rh="true" name="description" content="Document Control"><meta data-rh="true" property="og:description" content="Document Control"><link data-rh="true" rel="icon" href="/Idle-Game-Engine/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hansjm10.github.io/Idle-Game-Engine/issue-814-design"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/issue-814-design" hreflang="en"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/issue-814-design" hreflang="x-default"><link rel="stylesheet" href="/Idle-Game-Engine/assets/css/styles.0ca8729c.css">
<script src="/Idle-Game-Engine/assets/js/runtime~main.5cb83108.js" defer="defer"></script>
<script src="/Idle-Game-Engine/assets/js/main.1672bcab.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Idle-Game-Engine/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_sIzO" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Idle-Game-Engine/"><div class="navbar__logo"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_yXCL themedComponent--light_m26g"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_yXCL themedComponent--dark_DQxa"></div><b class="navbar__title text--truncate">Idle Engine</b></a><a class="navbar__item navbar__link" href="/Idle-Game-Engine/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_zgE_"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_VTTy colorModeToggle_mrTp"><button class="clean-btn toggleButton_Qf8c toggleButtonDisabled_hCyI" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_j9FX lightToggleIcon_i4Ty"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_j9FX darkToggleIcon_B1fV"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_j9FX systemToggleIcon_d9Wq"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_xdO6"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_fCXc"><div class="docsWrapper_oodB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_ZUBg" type="button"></button><div class="docRoot_zYbW"><main class="docMainContainer_BJhZ docMainContainerEnhanced_qZTj"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_NkVs"><div class="docItemContainer_WMJH"><article><div class="tocCollapsible_Kd7K theme-doc-toc-mobile tocMobile_Gv4l"><button type="button" class="clean-btn tocCollapsibleButton_ajnv">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>renderer-contract/webgpu: include camera state in RCB for replay correctness (Issue 814)</h1></header>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="document-control">Document Control<a href="#document-control" class="hash-link" aria-label="Direct link to Document Control" title="Direct link to Document Control" translate="no">​</a></h2>
<ul>
<li class=""><strong>Title</strong>: Include world camera state in <code>RenderCommandBuffer</code> to make RCB-only visual replay correct and self-contained</li>
<li class=""><strong>Authors</strong>: Codex (AI)</li>
<li class=""><strong>Reviewers</strong>: @hansjm10</li>
<li class=""><strong>Status</strong>: Draft</li>
<li class=""><strong>Last Updated</strong>: 2026-01-24</li>
<li class=""><strong>Related Issues</strong>: <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/814" target="_blank" rel="noopener noreferrer" class="">https://github.com/hansjm10/Idle-Game-Engine/issues/814</a></li>
<li class=""><strong>Execution Mode</strong>: AI-led</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="1-summary">1. Summary<a href="#1-summary" class="hash-link" aria-label="Direct link to 1. Summary" title="Direct link to 1. Summary" translate="no">​</a></h2>
<p><code>RenderCommandBuffer</code> (RCB) is intended to be a self-contained, replayable “how to draw this frame” payload. Today, camera state is held as external renderer instance state (<code>WebGpuRenderer.setWorldCamera(...)</code>) and is not included in the RCB, which makes RCB-only visual replays non-deterministic/incorrect whenever the camera changes. This design adds camera state to the renderer contract under <code>rcb.scene.camera</code>, updates the ViewModel→RCB compiler to copy camera state, updates <code>@idle-engine/renderer-webgpu</code> to render using the camera included in the RCB (including world-pass scissor calculations), and bumps the renderer contract schema version to reflect the breaking contract change.</p>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="2-context--problem-statement">2. Context &amp; Problem Statement<a href="#2-context--problem-statement" class="hash-link" aria-label="Direct link to 2. Context &amp; Problem Statement" title="Direct link to 2. Context &amp; Problem Statement" translate="no">​</a></h2>
<ul>
<li class=""><strong>Background</strong>:<!-- -->
<ul>
<li class=""><code>@idle-engine/renderer-contract</code> defines <code>ViewModel</code> (includes <code>scene.camera</code>) and <code>RenderCommandBuffer</code> (currently: <code>frame</code>, <code>passes</code>, <code>draws</code>). See <code>packages/renderer-contract/src/types.ts</code>.</li>
<li class=""><code>@idle-engine/renderer-webgpu</code> uses camera state to transform world coordinates for world-pass draws and to compute scissor rectangles. Today that camera lives on the renderer instance (<code>#worldCamera</code>) and is mutated via <code>setWorldCamera(...)</code>. See <code>packages/renderer-webgpu/src/webgpu-renderer.ts</code>.</li>
<li class="">The engine’s replay design (Issue 778) relies on hashing ViewModels/RCBs to validate deterministic replay streams and enable “visual replay” without rerunning sim. See <code>docs/desktop-shell-webgpu-renderer-replay-design-issue-778.md</code>.</li>
</ul>
</li>
<li class=""><strong>Problem</strong>:<!-- -->
<ul>
<li class="">RCB-only playback has no authoritative record of the camera transform that was used when the frame was rendered.</li>
<li class="">As a result, world-pass geometry and scissor/clipping are interpreted using whatever camera state happens to be present (often the default <code>{ x: 0, y: 0, zoom: 1 }</code>), producing incorrect visuals during replay (wrong positions, zoom, and clip regions).</li>
<li class="">Because <code>hashRenderCommandBuffer(rcb)</code> only hashes the RCB payload, camera changes are currently invisible to hash comparisons, weakening determinism auditing for visual replays.</li>
</ul>
</li>
<li class=""><strong>Forces</strong>:<!-- -->
<ul>
<li class="">Keep the renderer contract “data-only”, serializable, and hashable (no implicit external state required to interpret the payload).</li>
<li class="">Preserve deterministic hashing requirements (reject NaN/Infinity, stable canonicalization).</li>
<li class="">Treat this as a contract-breaking change and make schema evolution explicit.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="3-goals--non-goals">3. Goals &amp; Non-Goals<a href="#3-goals--non-goals" class="hash-link" aria-label="Direct link to 3. Goals &amp; Non-Goals" title="Direct link to 3. Goals &amp; Non-Goals" translate="no">​</a></h2>
<ul>
<li class=""><strong>Goals</strong>:<!-- -->
<ul>
<li class="">Make RCB-only replay correct with respect to camera (world transforms and world scissor).</li>
<li class="">Ensure camera state is included in the hashed RCB payload so replay validation catches camera mismatches.</li>
<li class="">Keep the contract shape aligned with <code>ViewModel</code> where possible (use <code>scene.camera</code>).</li>
<li class="">Provide clear migration notes and a schema version bump to prevent silent mismatches.</li>
</ul>
</li>
<li class=""><strong>Non-Goals</strong>:<!-- -->
<ul>
<li class="">Redesign the render pass system (e.g., per-pass transform graphs) beyond what is required to carry a single world camera.</li>
<li class="">Solve pixel-identical rendering across different GPU/driver stacks (goal is deterministic inputs + correct camera interpretation).</li>
<li class="">Add interpolation/tweening semantics to the contract (if needed, they should be recorded explicitly or derived deterministically).</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="4-stakeholders-agents--impacted-surfaces">4. Stakeholders, Agents &amp; Impacted Surfaces<a href="#4-stakeholders-agents--impacted-surfaces" class="hash-link" aria-label="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" title="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" translate="no">​</a></h2>
<ul>
<li class=""><strong>Primary Stakeholders</strong>:<!-- -->
<ul>
<li class="">Renderer contract maintainers (<code>packages/renderer-contract</code>)</li>
<li class="">WebGPU renderer maintainers (<code>packages/renderer-webgpu</code>)</li>
<li class="">Replay/diagnostics maintainers (<code>packages/core/src/replay/*</code>)</li>
<li class="">Host applications consuming RCB streams (e.g., <code>packages/shell-desktop</code>, tooling, inspectors)</li>
</ul>
</li>
<li class=""><strong>Agent Roles</strong>:<!-- -->
<ul>
<li class=""><strong>Contract Agent</strong>: Update <code>RenderCommandBuffer</code> types/schema version and publish migration notes.</li>
<li class=""><strong>Compiler Agent</strong>: Update <code>compileViewModelToRenderCommandBuffer(...)</code> to include camera state.</li>
<li class=""><strong>Renderer Agent</strong>: Update <code>WebGpuRenderer.render(rcb)</code> (and related helpers) to consume <code>rcb.scene.camera</code>.</li>
<li class=""><strong>Debug/Validation Agent</strong>: Update <code>@idle-engine/renderer-debug</code> validation and Canvas2D backend to respect <code>rcb.scene.camera</code> (optional but recommended for consistent replay tooling).</li>
<li class=""><strong>Docs Agent</strong>: Update READMEs and replay docs/examples to include the new required field.</li>
</ul>
</li>
<li class=""><strong>Affected Packages/Services</strong>:<!-- -->
<ul>
<li class=""><code>packages/renderer-contract/src/types.ts</code> (contract change + schema bump)</li>
<li class=""><code>packages/renderer-contract/src/render-compiler.ts</code> (copy camera into RCB)</li>
<li class=""><code>packages/renderer-webgpu/src/webgpu-renderer.ts</code> (consume camera from RCB; scissor math + globals)</li>
<li class=""><code>packages/renderer-debug/src/rcb-validation.ts</code> and <code>packages/renderer-debug/src/canvas2d-renderer.ts</code> (optional updates)</li>
<li class=""><code>packages/core/src/replay/*</code> (record/replay fixtures and any hard-coded RCBs)</li>
<li class="">Package docs/examples (e.g., <code>packages/renderer-webgpu/README.md</code>)</li>
</ul>
</li>
<li class=""><strong>Compatibility Considerations</strong>:<!-- -->
<ul>
<li class="">This is a breaking renderer-contract change: it requires bumping <code>RENDERER_CONTRACT_SCHEMA_VERSION</code> and updating all RCB producers/consumers in-tree.</li>
<li class="">Previously recorded RCB streams (e.g., replay files) will require migration or must be treated as incompatible and rejected by schema version checks.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="5-current-state">5. Current State<a href="#5-current-state" class="hash-link" aria-label="Direct link to 5. Current State" title="Direct link to 5. Current State" translate="no">​</a></h2>
<ul>
<li class=""><code>ViewModel</code> includes <code>scene.camera</code>, but <code>compileViewModelToRenderCommandBuffer(...)</code> discards it and only emits <code>frame/passes/draws</code>. See <code>packages/renderer-contract/src/render-compiler.ts</code>.</li>
<li class=""><code>@idle-engine/renderer-webgpu</code> stores camera on the renderer instance (<code>#worldCamera</code>) and uses it for:<!-- -->
<ul>
<li class="">world pass scissor conversion (<code>#toDeviceScissorRect(...)</code>), and</li>
<li class="">writing world globals uniform (<code>#writeGlobals(WORLD_GLOBALS_OFFSET, this.#worldCamera)</code>).
See <code>packages/renderer-webgpu/src/webgpu-renderer.ts</code>.</li>
</ul>
</li>
<li class="">RCB hashing is used for replay validation (<code>hashRenderCommandBuffer(rcb)</code>), but since camera is not inside RCB, camera-dependent visual differences are not reflected in the RCB hash. See <code>packages/renderer-contract/src/hashing.ts</code> and <code>packages/core/src/replay/sim-replay.ts</code>.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="6-proposed-solution">6. Proposed Solution<a href="#6-proposed-solution" class="hash-link" aria-label="Direct link to 6. Proposed Solution" title="Direct link to 6. Proposed Solution" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="61-architecture-overview">6.1 Architecture Overview<a href="#61-architecture-overview" class="hash-link" aria-label="Direct link to 6.1 Architecture Overview" title="Direct link to 6.1 Architecture Overview" translate="no">​</a></h3>
<ul>
<li class="">Treat camera state as per-frame render input, not renderer instance state.</li>
<li class="">Embed world camera state in the RCB so any consumer (WebGPU renderer, debug renderers, tooling) can render the frame correctly without additional ambient state.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="62-detailed-design">6.2 Detailed Design<a href="#62-detailed-design" class="hash-link" aria-label="Direct link to 6.2 Detailed Design" title="Direct link to 6.2 Detailed Design" translate="no">​</a></h3>
<ul>
<li class=""><strong>Runtime Changes</strong>:<!-- -->
<ul>
<li class="">Update RCB generation (<code>compileViewModelToRenderCommandBuffer</code>) to include <code>scene.camera</code> from the input <code>ViewModel</code>.</li>
<li class="">Update renderers to read camera from the RCB during <code>render(rcb)</code>:<!-- -->
<ul>
<li class="">World scissor conversion uses <code>rcb.scene.camera</code>.</li>
<li class="">World globals uniform uses <code>rcb.scene.camera</code>.</li>
<li class="">UI continues to use identity camera <code>{ x: 0, y: 0, zoom: 1 }</code>.</li>
</ul>
</li>
</ul>
</li>
<li class=""><strong>Data &amp; Schemas</strong>:<!-- -->
<ul>
<li class="">Update the renderer contract:<!-- -->
<ul>
<li class="">Add <code>scene: { camera: Camera2D }</code> to <code>RenderCommandBuffer</code>.</li>
<li class="">Bump <code>RENDERER_CONTRACT_SCHEMA_VERSION</code> (currently <code>3</code>) to the next version (expected: <code>4</code>).</li>
</ul>
</li>
<li class="">Camera numeric constraints:<!-- -->
<ul>
<li class=""><code>camera.x</code>, <code>camera.y</code>, <code>camera.zoom</code> must be finite numbers (<code>hashing.normalizeNumbersForHash</code> already rejects NaN/Infinity).</li>
<li class=""><code>camera.zoom</code> should be positive (<code>&gt; 0</code>) for meaningful transforms; enforce in compiler and/or renderers (exact enforcement location is an implementation detail; see Open Questions).</li>
</ul>
</li>
</ul>
</li>
<li class=""><strong>APIs &amp; Contracts</strong>:<!-- -->
<ul>
<li class="">Keep <code>WebGpuRenderer.setWorldCamera(camera)</code> for now, but mark it as deprecated in documentation/JSDoc.<!-- -->
<ul>
<li class="">New invariant: <code>render(rcb)</code> uses <code>rcb.scene.camera</code> and does not require <code>setWorldCamera(...)</code> for correctness.</li>
<li class="">Optional transitional behavior (if desired): <code>render(rcb)</code> may fall back to the instance camera when <code>rcb.scene</code> is missing, but only if we choose to support older schema versions in the renderer. Default expectation is strict schema matching.</li>
</ul>
</li>
</ul>
</li>
<li class=""><strong>Tooling &amp; Automation</strong>:<!-- -->
<ul>
<li class="">Update in-tree fixtures and docs that construct RCB objects manually to include <code>scene.camera</code>.</li>
<li class="">Update replay tooling/docs so recorded RCB frames are self-contained and RCB hashes reflect camera state.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="63-operational-considerations">6.3 Operational Considerations<a href="#63-operational-considerations" class="hash-link" aria-label="Direct link to 6.3 Operational Considerations" title="Direct link to 6.3 Operational Considerations" translate="no">​</a></h3>
<ul>
<li class=""><strong>Deployment</strong>:<!-- -->
<ul>
<li class="">Land contract change + schema bump first, then update all dependents in-tree in the same PR to keep the workspace compiling.</li>
<li class="">Explicitly reject mismatched schema versions at entry points (already present in WebGPU renderer; extend as needed elsewhere).</li>
</ul>
</li>
<li class=""><strong>Telemetry &amp; Observability</strong>:<!-- -->
<ul>
<li class="">No new telemetry required; schema mismatch errors should be descriptive so hosts can instrument them.</li>
</ul>
</li>
<li class=""><strong>Security &amp; Compliance</strong>:<!-- -->
<ul>
<li class="">Improves replay safety by removing reliance on ambient renderer state for interpreting untrusted RCB streams.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="7-work-breakdown--delivery-plan">7. Work Breakdown &amp; Delivery Plan<a href="#7-work-breakdown--delivery-plan" class="hash-link" aria-label="Direct link to 7. Work Breakdown &amp; Delivery Plan" title="Direct link to 7. Work Breakdown &amp; Delivery Plan" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="71-issue-map">7.1 Issue Map<a href="#71-issue-map" class="hash-link" aria-label="Direct link to 7.1 Issue Map" title="Direct link to 7.1 Issue Map" translate="no">​</a></h3>
<table><thead><tr><th>Issue Title</th><th>Scope Summary</th><th>Proposed Assignee/Agent</th><th>Dependencies</th><th>Acceptance Criteria</th></tr></thead><tbody><tr><td><code>feat(renderer-contract): add camera to RenderCommandBuffer</code></td><td>Extend RCB type with <code>scene.camera</code> and bump <code>RENDERER_CONTRACT_SCHEMA_VERSION</code></td><td>Contract Agent</td><td>Design approval</td><td>Types updated; schema version bumped; migration notes captured in doc/PR</td></tr><tr><td><code>feat(renderer-contract): compile camera into RCB</code></td><td>Update <code>compileViewModelToRenderCommandBuffer</code> to copy camera from ViewModel into RCB</td><td>Compiler Agent</td><td>Contract change</td><td>Unit tests updated/added to assert camera is present and stable for hashing</td></tr><tr><td><code>refactor(renderer-webgpu): render using rcb.scene.camera</code></td><td>Replace instance-state camera usage in world scissor and globals with <code>rcb.scene.camera</code></td><td>Renderer Agent</td><td>Contract change</td><td>Existing scissor/camera tests updated; RCB-only render path correct without calling <code>setWorldCamera</code></td></tr><tr><td><code>chore(renderer-debug): respect RCB camera</code></td><td>Update <code>renderRenderCommandBufferToCanvas2d</code> and validation to apply world camera for parity with WebGPU</td><td>Debug/Validation Agent</td><td>Contract change</td><td>Canvas2D output matches WebGPU camera interpretation for the same RCB; tests updated</td></tr><tr><td><code>docs(renderer-webgpu/replay): update examples + migration notes</code></td><td>Update README examples and replay docs to include <code>scene.camera</code></td><td>Docs Agent</td><td>Contract + implementation</td><td>Examples compile; docs explain schema bump and required field</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="72-milestones">7.2 Milestones<a href="#72-milestones" class="hash-link" aria-label="Direct link to 7.2 Milestones" title="Direct link to 7.2 Milestones" translate="no">​</a></h3>
<ul>
<li class=""><strong>Phase 1</strong>: Contract change + schema bump + compiler update (workspace compiles).</li>
<li class=""><strong>Phase 2</strong>: WebGPU renderer update + tests (RCB-only replay correctness).</li>
<li class=""><strong>Phase 3</strong>: Debug tooling parity + docs/migration updates.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="73-coordination-notes">7.3 Coordination Notes<a href="#73-coordination-notes" class="hash-link" aria-label="Direct link to 7.3 Coordination Notes" title="Direct link to 7.3 Coordination Notes" translate="no">​</a></h3>
<ul>
<li class=""><strong>Hand-off Package</strong>:<!-- -->
<ul>
<li class="">Contract types: <code>packages/renderer-contract/src/types.ts</code></li>
<li class="">Compiler: <code>packages/renderer-contract/src/render-compiler.ts</code></li>
<li class="">WebGPU renderer: <code>packages/renderer-webgpu/src/webgpu-renderer.ts</code></li>
<li class="">Existing scissor/camera tests: <code>packages/renderer-webgpu/src/webgpu-renderer.test.ts</code></li>
<li class="">Replay hashing: <code>packages/renderer-contract/src/hashing.ts</code>, <code>packages/core/src/replay/sim-replay.ts</code></li>
<li class="">Prior replay design: <code>docs/desktop-shell-webgpu-renderer-replay-design-issue-778.md</code></li>
</ul>
</li>
<li class=""><strong>Communication Cadence</strong>: Single reviewer pass after implementation + tests, with a follow-up doc pass for migration notes if schema bump impacts existing replay artifacts.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="8-agent-guidance--guardrails">8. Agent Guidance &amp; Guardrails<a href="#8-agent-guidance--guardrails" class="hash-link" aria-label="Direct link to 8. Agent Guidance &amp; Guardrails" title="Direct link to 8. Agent Guidance &amp; Guardrails" translate="no">​</a></h2>
<ul>
<li class=""><strong>Context Packets</strong>:<!-- -->
<ul>
<li class="">Load Issue 814 body for acceptance criteria and file references.</li>
<li class="">Review how camera is used today in WebGPU scissor/global uniforms.</li>
<li class="">Identify any in-tree RCB fixtures/examples that will break when <code>scene.camera</code> becomes required.</li>
</ul>
</li>
<li class=""><strong>Prompting &amp; Constraints</strong>:<!-- -->
<ul>
<li class="">Do not edit checked-in <code>dist/</code> outputs by hand.</li>
<li class="">Use type-only imports/exports (<code>import type { ... }</code>) per workspace lint rules.</li>
<li class="">Keep renderer-contract changes minimal and data-only; avoid adding runtime dependencies for validation.</li>
</ul>
</li>
<li class=""><strong>Safety Rails</strong>:<!-- -->
<ul>
<li class="">Prefer fail-fast behavior on schema mismatch; do not silently assume default camera during replay.</li>
<li class="">Ensure hashing behavior remains deterministic (no NaN/Infinity; stable key ordering).</li>
</ul>
</li>
<li class=""><strong>Validation Hooks</strong>:<!-- -->
<ul>
<li class=""><code>pnpm test --filter @idle-engine/renderer-contract</code></li>
<li class=""><code>pnpm test --filter @idle-engine/renderer-webgpu</code></li>
<li class=""><code>pnpm test --filter @idle-engine/renderer-debug</code></li>
<li class=""><code>pnpm test --filter @idle-engine/core</code> (visual replay tests)</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="9-alternatives-considered">9. Alternatives Considered<a href="#9-alternatives-considered" class="hash-link" aria-label="Direct link to 9. Alternatives Considered" title="Direct link to 9. Alternatives Considered" translate="no">​</a></h2>
<ol>
<li class=""><strong>Keep camera external (require <code>setWorldCamera</code> during replay)</strong>: Rejected; violates the “RCB is self-contained” goal and makes RCB-only replay correctness dependent on caller behavior.</li>
<li class=""><strong>Store camera in <code>FrameHeader</code></strong>: Simpler shape but semantically mixes “frame identity” and “render state”; also less aligned with <code>ViewModel.scene</code>.</li>
<li class=""><strong>Attach camera per pass (<code>RenderPass</code> carries transform)</strong>: More extensible (multiple cameras/passes), but heavier change than needed for Issue 814 and requires larger refactors across compilers/renderers.</li>
<li class=""><strong>Record camera as a draw command (e.g., <code>kind: &#x27;setCamera&#x27;</code>)</strong>: Keeps <code>RenderCommandBuffer</code> flat but complicates ordering rules and makes camera an implicit state machine again; rejected in favor of explicit <code>scene</code> metadata.</li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="10-testing--validation-plan">10. Testing &amp; Validation Plan<a href="#10-testing--validation-plan" class="hash-link" aria-label="Direct link to 10. Testing &amp; Validation Plan" title="Direct link to 10. Testing &amp; Validation Plan" translate="no">​</a></h2>
<ul>
<li class=""><strong>Unit / Integration</strong>:<!-- -->
<ul>
<li class="">Update renderer-contract compiler tests to assert <code>compileViewModelToRenderCommandBuffer(viewModel).scene.camera</code> equals the input camera.</li>
<li class="">Add/adjust hashing tests to confirm that RCB hashes differ when camera differs (even if draws are identical).</li>
<li class="">Update WebGPU renderer tests to remove reliance on <code>renderer.setWorldCamera(...)</code> and instead supply camera via the RCB; ensure scissor conversion matches expected device pixels.</li>
<li class="">Update any replay fixtures/tests that construct RCBs (in <code>packages/core/src/replay/*.test.ts</code>) to include <code>scene.camera</code>.</li>
</ul>
</li>
<li class=""><strong>Performance</strong>:<!-- -->
<ul>
<li class="">Camera adds a tiny constant payload per frame (3 numbers); no measurable perf impact expected.</li>
</ul>
</li>
<li class=""><strong>Tooling / A11y</strong>:<!-- -->
<ul>
<li class="">Manual sanity check in a host (Electron/web) by capturing an RCB stream with camera movement and replaying it without any external camera calls.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="11-risks--mitigations">11. Risks &amp; Mitigations<a href="#11-risks--mitigations" class="hash-link" aria-label="Direct link to 11. Risks &amp; Mitigations" title="Direct link to 11. Risks &amp; Mitigations" translate="no">​</a></h2>
<ul>
<li class=""><strong>Breaking change ripple</strong>: Many fixtures/examples create RCB objects manually and will fail to compile until updated.<!-- -->
<ul>
<li class=""><em>Mitigation</em>: Land schema bump + in-tree updates in one PR; include a checklist of touched packages.</li>
</ul>
</li>
<li class=""><strong>Camera float nondeterminism</strong>: If camera is computed using non-deterministic timing (vsync interpolation), hashes may differ between runs.<!-- -->
<ul>
<li class=""><em>Mitigation</em>: Define where camera comes from for “deterministic replay” mode (derive from sim time or record camera explicitly and treat it as non-authoritative).</li>
</ul>
</li>
<li class=""><strong>Partial adoption</strong>: Some renderers/tooling might ignore camera and remain incorrect.<!-- -->
<ul>
<li class=""><em>Mitigation</em>: Update <code>@idle-engine/renderer-debug</code> as part of the rollout or explicitly document its limitations.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="12-rollout-plan">12. Rollout Plan<a href="#12-rollout-plan" class="hash-link" aria-label="Direct link to 12. Rollout Plan" title="Direct link to 12. Rollout Plan" translate="no">​</a></h2>
<ul>
<li class=""><strong>Milestones</strong>:<!-- -->
<ol>
<li class="">Bump schema version and update contract/compiler (RCB includes camera).</li>
<li class="">Update WebGPU renderer to consume camera from RCB and update tests.</li>
<li class="">Update docs/examples and (optionally) debug tooling parity.</li>
</ol>
</li>
<li class=""><strong>Migration Strategy</strong>:<!-- -->
<ul>
<li class="">Treat pre-bump RCB streams as incompatible and reject them via schema checks.</li>
<li class="">If legacy replay support is required, add an explicit migration step that injects a default camera or reconstructs camera from recorded host input (out of scope for this issue; see Open Questions).</li>
</ul>
</li>
<li class=""><strong>Communication</strong>:<!-- -->
<ul>
<li class="">Include migration notes in PR description:<!-- -->
<ul>
<li class=""><code>RenderCommandBuffer</code> now requires <code>scene.camera</code>.</li>
<li class=""><code>RENDERER_CONTRACT_SCHEMA_VERSION</code> bumped; old replays must be regenerated or migrated.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="13-open-questions">13. Open Questions<a href="#13-open-questions" class="hash-link" aria-label="Direct link to 13. Open Questions" title="Direct link to 13. Open Questions" translate="no">​</a></h2>
<ol>
<li class="">Should <code>camera.zoom</code> be validated as <code>&gt; 0</code> at the contract boundary (compiler/renderer), or left to downstream renderers to interpret?</li>
<li class="">Should <code>WebGpuRenderer.setWorldCamera(...)</code> be removed (breaking API), formally deprecated, or retained as an override for ad-hoc/manual rendering?</li>
<li class="">Do we want per-pass camera transforms soon (making <code>RenderPass</code> carry a transform), or is a single <code>rcb.scene.camera</code> sufficient for the foreseeable roadmap?</li>
<li class="">Do replay file formats need an explicit “RCB schema version” field separate from <code>FrameHeader.schemaVersion</code>, or is the existing schema version sufficient?</li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="14-follow-up-work">14. Follow-Up Work<a href="#14-follow-up-work" class="hash-link" aria-label="Direct link to 14. Follow-Up Work" title="Direct link to 14. Follow-Up Work" translate="no">​</a></h2>
<ul>
<li class="">Expand “RCB is self-contained” to other renderer state currently implicit (e.g., viewport assumptions, devicePixelRatio semantics), if replay correctness requires it.</li>
<li class="">Consider a small migration utility for replay files when contract schema versions change.</li>
<li class="">Consider adding optional quantization rules for camera (fixed-point) if camera hashing proves too sensitive for deterministic validation workflows.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="15-references">15. References<a href="#15-references" class="hash-link" aria-label="Direct link to 15. References" title="Direct link to 15. References" translate="no">​</a></h2>
<ul>
<li class="">Issue 814: <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/814" target="_blank" rel="noopener noreferrer" class="">https://github.com/hansjm10/Idle-Game-Engine/issues/814</a></li>
<li class="">Renderer contract types: <code>packages/renderer-contract/src/types.ts</code></li>
<li class="">ViewModel→RCB compiler: <code>packages/renderer-contract/src/render-compiler.ts</code></li>
<li class="">WebGPU renderer implementation: <code>packages/renderer-webgpu/src/webgpu-renderer.ts</code></li>
<li class="">WebGPU renderer tests (camera/scissor): <code>packages/renderer-webgpu/src/webgpu-renderer.test.ts</code></li>
<li class="">Replay hashing: <code>packages/renderer-contract/src/hashing.ts</code></li>
<li class="">Replay validation logic: <code>packages/core/src/replay/sim-replay.ts</code></li>
<li class="">Prior replay design doc (Issue 778): <code>docs/desktop-shell-webgpu-renderer-replay-design-issue-778.md</code></li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="appendix-a--glossary">Appendix A — Glossary<a href="#appendix-a--glossary" class="hash-link" aria-label="Direct link to Appendix A — Glossary" title="Direct link to Appendix A — Glossary" translate="no">​</a></h2>
<ul>
<li class=""><strong>RCB (RenderCommandBuffer)</strong>: A per-frame, data-only rendering payload describing passes and ordered draws for a renderer backend.</li>
<li class=""><strong>ViewModel</strong>: A higher-level per-frame description (scene + UI) that is compiled into an RCB.</li>
<li class=""><strong>Camera2D</strong>: The world camera transform <code>{ x, y, zoom }</code> used to map world coordinates into device/pixel space.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="appendix-b--change-log">Appendix B — Change Log<a href="#appendix-b--change-log" class="hash-link" aria-label="Direct link to Appendix B — Change Log" title="Direct link to Appendix B — Change Log" translate="no">​</a></h2>
<table><thead><tr><th>Date</th><th>Author</th><th>Change Summary</th></tr></thead><tbody><tr><td>2026-01-24</td><td>Codex (AI)</td><td>Initial draft for Issue 814</td></tr></tbody></table></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_zkN7"><a href="https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/issue-814-design.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_URLU" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_DCA4"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_7BTH thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#document-control" class="table-of-contents__link toc-highlight">Document Control</a></li><li><a href="#1-summary" class="table-of-contents__link toc-highlight">1. Summary</a></li><li><a href="#2-context--problem-statement" class="table-of-contents__link toc-highlight">2. Context &amp; Problem Statement</a></li><li><a href="#3-goals--non-goals" class="table-of-contents__link toc-highlight">3. Goals &amp; Non-Goals</a></li><li><a href="#4-stakeholders-agents--impacted-surfaces" class="table-of-contents__link toc-highlight">4. Stakeholders, Agents &amp; Impacted Surfaces</a></li><li><a href="#5-current-state" class="table-of-contents__link toc-highlight">5. Current State</a></li><li><a href="#6-proposed-solution" class="table-of-contents__link toc-highlight">6. Proposed Solution</a><ul><li><a href="#61-architecture-overview" class="table-of-contents__link toc-highlight">6.1 Architecture Overview</a></li><li><a href="#62-detailed-design" class="table-of-contents__link toc-highlight">6.2 Detailed Design</a></li><li><a href="#63-operational-considerations" class="table-of-contents__link toc-highlight">6.3 Operational Considerations</a></li></ul></li><li><a href="#7-work-breakdown--delivery-plan" class="table-of-contents__link toc-highlight">7. Work Breakdown &amp; Delivery Plan</a><ul><li><a href="#71-issue-map" class="table-of-contents__link toc-highlight">7.1 Issue Map</a></li><li><a href="#72-milestones" class="table-of-contents__link toc-highlight">7.2 Milestones</a></li><li><a href="#73-coordination-notes" class="table-of-contents__link toc-highlight">7.3 Coordination Notes</a></li></ul></li><li><a href="#8-agent-guidance--guardrails" class="table-of-contents__link toc-highlight">8. Agent Guidance &amp; Guardrails</a></li><li><a href="#9-alternatives-considered" class="table-of-contents__link toc-highlight">9. Alternatives Considered</a></li><li><a href="#10-testing--validation-plan" class="table-of-contents__link toc-highlight">10. Testing &amp; Validation Plan</a></li><li><a href="#11-risks--mitigations" class="table-of-contents__link toc-highlight">11. Risks &amp; Mitigations</a></li><li><a href="#12-rollout-plan" class="table-of-contents__link toc-highlight">12. Rollout Plan</a></li><li><a href="#13-open-questions" class="table-of-contents__link toc-highlight">13. Open Questions</a></li><li><a href="#14-follow-up-work" class="table-of-contents__link toc-highlight">14. Follow-Up Work</a></li><li><a href="#15-references" class="table-of-contents__link toc-highlight">15. References</a></li><li><a href="#appendix-a--glossary" class="table-of-contents__link toc-highlight">Appendix A — Glossary</a></li><li><a href="#appendix-b--change-log" class="table-of-contents__link toc-highlight">Appendix B — Change Log</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/contributor-handbook">Contributor Handbook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_zgE_"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_zgE_"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Idle Engine.</div></div></div></footer></div>
</body>
</html>