<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-issue-850-design" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Design: First-Class Input Events for Desktop Shell Controls | Idle Engine Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hansjm10.github.io/Idle-Game-Engine/issue-850-design"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Design: First-Class Input Events for Desktop Shell Controls | Idle Engine Docs"><meta data-rh="true" name="description" content="Issue: #850"><meta data-rh="true" property="og:description" content="Issue: #850"><link data-rh="true" rel="icon" href="/Idle-Game-Engine/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hansjm10.github.io/Idle-Game-Engine/issue-850-design"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/issue-850-design" hreflang="en"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/issue-850-design" hreflang="x-default"><link rel="stylesheet" href="/Idle-Game-Engine/assets/css/styles.0ca8729c.css">
<script src="/Idle-Game-Engine/assets/js/runtime~main.a70c074c.js" defer="defer"></script>
<script src="/Idle-Game-Engine/assets/js/main.f4c47682.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Idle-Game-Engine/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_sIzO" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Idle-Game-Engine/"><div class="navbar__logo"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_yXCL themedComponent--light_m26g"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_yXCL themedComponent--dark_DQxa"></div><b class="navbar__title text--truncate">Idle Engine</b></a><a class="navbar__item navbar__link" href="/Idle-Game-Engine/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_zgE_"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_VTTy colorModeToggle_mrTp"><button class="clean-btn toggleButton_Qf8c toggleButtonDisabled_hCyI" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_j9FX lightToggleIcon_i4Ty"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_j9FX darkToggleIcon_B1fV"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_j9FX systemToggleIcon_d9Wq"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_xdO6"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_fCXc"><div class="docsWrapper_oodB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_ZUBg" type="button"></button><div class="docRoot_zYbW"><main class="docMainContainer_BJhZ docMainContainerEnhanced_qZTj"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_NkVs"><div class="docItemContainer_WMJH"><article><div class="tocCollapsible_Kd7K theme-doc-toc-mobile tocMobile_Gv4l"><button type="button" class="clean-btn tocCollapsibleButton_ajnv">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Design: First-Class Input Events for Desktop Shell Controls</h1></header>
<p><strong>Issue</strong>: #850
<strong>Status</strong>: Draft - Classification Complete
<strong>Feature Types</strong>: Primary: API, Secondary: Workflow, Data Model</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="1-scope">1. Scope<a href="#1-scope" class="hash-link" aria-label="Direct link to 1. Scope" title="Direct link to 1. Scope" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="problem">Problem<a href="#problem" class="hash-link" aria-label="Direct link to Problem" title="Direct link to Problem" translate="no">​</a></h3>
<p>The desktop shell currently forwards unmatched control/pointer events as an ad-hoc <code>SHELL_CONTROL_EVENT</code> runtime command with untyped metadata. This makes input handling harder to reason about, serialize, and replay deterministically.</p>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="goals">Goals<a href="#goals" class="hash-link" aria-label="Direct link to Goals" title="Direct link to Goals" translate="no">​</a></h3>
<ul class="contains-task-list containsTaskList_LGBQ">
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Remove the implicit passthrough behavior and <code>SHELL_CONTROL_EVENT</code> usage from the desktop shell input pipeline.</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Keep pointer-driven UI interactions working in the test-game desktop shell.</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Define a well-typed, serializable payload shape for forwarded input events (including pointer events).</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="pointerui-preservation-concrete-rules">Pointer/UI Preservation (Concrete Rules)<a href="#pointerui-preservation-concrete-rules" class="hash-link" aria-label="Direct link to Pointer/UI Preservation (Concrete Rules)" title="Direct link to Pointer/UI Preservation (Concrete Rules)" translate="no">​</a></h3>
<p>To preserve existing pointer-driven UI behavior while removing implicit passthrough:</p>
<ul>
<li class="">The renderer sends typed input events for canvas pointer + wheel interactions on <code>IPC_CHANNELS.inputEvent</code>.</li>
<li class="">The main process validates and <strong>always</strong> enqueues exactly one <code>INPUT_EVENT</code> runtime command per valid pointer/wheel input event (no control-scheme binding required).</li>
<li class=""><code>idle-engine:control-event</code> remains for non-pointer controls (e.g., Space → <code>collect</code>) and is mapped via <code>@idle-engine/controls</code> bindings; there is no passthrough fallback.</li>
</ul>
<p><strong>Intent mapping (kept stable):</strong> existing <code>mouse-*</code> intent strings are preserved as-is in the new typed schema:</p>
<ul>
<li class=""><code>mouse-down</code> → <code>InputEvent.kind:&#x27;pointer&#x27;</code>, <code>intent:&#x27;mouse-down&#x27;</code>, <code>phase:&#x27;start&#x27;</code></li>
<li class=""><code>mouse-move</code> → <code>InputEvent.kind:&#x27;pointer&#x27;</code>, <code>intent:&#x27;mouse-move&#x27;</code>, <code>phase:&#x27;repeat&#x27;</code></li>
<li class=""><code>mouse-up</code> → <code>InputEvent.kind:&#x27;pointer&#x27;</code>, <code>intent:&#x27;mouse-up&#x27;</code>, <code>phase:&#x27;end&#x27;</code></li>
<li class=""><code>mouse-wheel</code> → <code>InputEvent.kind:&#x27;wheel&#x27;</code>, <code>intent:&#x27;mouse-wheel&#x27;</code>, <code>phase:&#x27;repeat&#x27;</code></li>
</ul>
<p>Implementation touchpoints (exact files):</p>
<ul>
<li class=""><code>packages/core/src/command.ts</code>, <code>packages/core/src/input-event.ts</code></li>
<li class=""><code>packages/shell-desktop/src/ipc.ts</code>, <code>packages/shell-desktop/src/preload.cts</code></li>
<li class=""><code>packages/shell-desktop/src/renderer/index.ts</code>, <code>packages/shell-desktop/src/main.ts</code></li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="non-goals">Non-Goals<a href="#non-goals" class="hash-link" aria-label="Direct link to Non-Goals" title="Direct link to Non-Goals" translate="no">​</a></h3>
<ul>
<li class="">Add support for every possible input device/event type (gamepad, multi-touch gestures, etc.) beyond what is needed to preserve existing pointer UI behavior.</li>
<li class="">Redesign the renderer/UI system or change unrelated runtime command queue semantics.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="boundaries">Boundaries<a href="#boundaries" class="hash-link" aria-label="Direct link to Boundaries" title="Direct link to Boundaries" translate="no">​</a></h3>
<ul>
<li class=""><strong>In scope</strong>: <code>packages/shell-desktop</code> input capture and IPC flow, <code>@idle-engine/controls</code> event→command mapping behavior as needed, and any core/controls contracts required to represent input events deterministically.</li>
<li class=""><strong>Out of scope</strong>: Replay file/container format changes, renderer contract changes, or new UI widgets/interaction patterns beyond maintaining current behavior.</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="2-workflow">2. Workflow<a href="#2-workflow" class="hash-link" aria-label="Direct link to 2. Workflow" title="Direct link to 2. Workflow" translate="no">​</a></h2>
<p>This feature changes the <strong>input event workflow</strong> so that pointer/UI interactions are preserved via <strong>explicit, typed input-event commands</strong> (not implicit <code>metadata.passthrough</code> forwarding and not <code>SHELL_CONTROL_EVENT</code>).</p>
<p><strong>State gates (explicit)</strong>:</p>
<ul>
<li class=""><strong>Initial state</strong>: <code>shell.booting</code> (entered when <code>packages/shell-desktop/src/main.ts</code> is evaluated).</li>
<li class=""><strong>Terminal states</strong>: <code>shell.startup_failed</code> (process exits) and <code>sim.terminated</code> (controller is disposed and owns no worker).</li>
<li class=""><strong>Halted states</strong>: <code>sim.stopped</code> and <code>sim.crashed</code> accept no input and require an explicit restart transition to re-enter <code>sim.initializing</code>.</li>
<li class=""><strong>Reversibility</strong>: No transition is reversible in-place; recovery is via <strong>explicit restart</strong> (<code>sim.* -&gt; sim.initializing</code>) which creates a new sim worker controller and resets nested input state to <code>sim.running.input.idle</code>.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="states">States<a href="#states" class="hash-link" aria-label="Direct link to States" title="Direct link to States" translate="no">​</a></h3>
<table><thead><tr><th>State</th><th>Description</th><th>Entry Condition</th></tr></thead><tbody><tr><td>shell.booting</td><td>Electron main process module is loading; window/IPC may not exist yet.</td><td>Node/Electron loads <code>main.ts</code>.</td></tr><tr><td>shell.startup_failed</td><td>App failed during startup and exits with a non-zero code; no further transitions.</td><td><code>app.whenReady()</code> rejects (startup exception).</td></tr><tr><td>sim.initializing</td><td>Sim worker is spawned; init message sent; waiting for <code>ready</code>. Input events are ignored.</td><td>App is ready and sim worker controller is created (or restarted).</td></tr><tr><td>sim.running.input.idle</td><td>Sim tick loop is active; no pending input work.</td><td>Worker sends <code>ready</code>; tick loop starts; nested input state initialized.</td></tr><tr><td>sim.running.input.pointer_move_coalescing</td><td>Renderer is coalescing pointer-move events to one per animation frame.</td><td>Renderer receives pointer-move and schedules a RAF flush.</td></tr><tr><td>sim.running.input.processing</td><td>Main process is validating an input message and preparing runtime command(s).</td><td>Main receives a candidate input message from renderer IPC.</td></tr><tr><td>sim.running.input.enqueued</td><td>Command(s) were accepted for delivery to the sim worker.</td><td>For <code>idle-engine:input-event</code>: a valid pointer/wheel envelope produced exactly one <code>INPUT_EVENT</code> and <code>worker.postMessage({ kind: &#x27;enqueueCommands&#x27; ... })</code> succeeds. For <code>idle-engine:control-event</code>: mapping produced ≥1 command and <code>postMessage</code> succeeds.</td></tr><tr><td>sim.running.input.dropped</td><td>Control event was valid but produced no commands (unbound).</td><td><code>idle-engine:control-event</code> mapping produced 0 commands for the event.</td></tr><tr><td>sim.running.input.rejected</td><td>Input event was invalid and is not processed.</td><td>Input event fails schema/shape validation at IPC boundary.</td></tr><tr><td>sim.disposing</td><td>Sim worker controller is shutting down; tick loop stopped; no further input accepted.</td><td>Window reload/close, or app shutdown triggers controller dispose.</td></tr><tr><td>sim.terminated</td><td>Sim worker controller is fully disposed; no worker thread is owned.</td><td>Worker is terminated/closed and controller resources are released.</td></tr><tr><td>sim.stopped</td><td>Sim worker exited cleanly (code 0); no further input accepted until restart.</td><td>Worker emits <code>exit</code> with code <code>0</code> while not disposing.</td></tr><tr><td>sim.crashed</td><td>Sim worker or IPC bridge failed; no further input accepted until restart.</td><td>Worker emits <code>error</code>/<code>messageerror</code>, sends <code>kind:&#x27;error&#x27;</code>, or exits non-zero while not disposing.</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="transitions">Transitions<a href="#transitions" class="hash-link" aria-label="Direct link to Transitions" title="Direct link to Transitions" translate="no">​</a></h3>
<table><thead><tr><th>From</th><th>Event/Condition</th><th>To</th><th>Side Effects</th></tr></thead><tbody><tr><td>shell.booting</td><td><code>app.whenReady()</code> resolves.</td><td>sim.initializing</td><td>Register IPC handlers; create window; spawn sim worker; send worker <code>init</code>; (renderer may begin loading independently).</td></tr><tr><td>shell.booting</td><td><code>app.whenReady()</code> rejects.</td><td>shell.startup_failed</td><td><code>console.error(error)</code>; <code>app.exit(1)</code>.</td></tr><tr><td>sim.initializing</td><td>Worker sends <code>kind:&#x27;ready&#x27;</code>.</td><td>sim.running.input.idle</td><td>Persist <code>stepSizeMs</code> + <code>nextStep</code>; start tick interval; begin accepting input events.</td></tr><tr><td>sim.initializing</td><td>Worker sends <code>kind:&#x27;error&#x27;</code> OR emits <code>error</code>/<code>messageerror</code> OR exits non-zero.</td><td>sim.crashed</td><td>Stop tick interval; log failure; notify renderer via <code>simStatus</code> IPC; terminate worker.</td></tr><tr><td>sim.running.input.idle</td><td>Renderer sends a non-coalesced input message (pointer-down/up, wheel, key).</td><td>sim.running.input.processing</td><td>Snapshot current <code>nextStep</code>/<code>stepSizeMs</code>; begin validation and command preparation.</td></tr><tr><td>sim.running.input.idle</td><td>Renderer sends pointer-move; renderer schedules RAF coalescing.</td><td>sim.running.input.pointer_move_coalescing</td><td>Store latest pointer-move; overwrite older move; ensure exactly one RAF is scheduled.</td></tr><tr><td>sim.running.input.pointer_move_coalescing</td><td>RAF flush runs with a pending pointer-move.</td><td>sim.running.input.processing</td><td>Emit exactly one pointer-move input event for the latest pending move; begin validation and command preparation.</td></tr><tr><td>sim.running.input.pointer_move_coalescing</td><td>RAF flush runs with no pending pointer-move.</td><td>sim.running.input.idle</td><td>No-op (state returns to idle).</td></tr><tr><td>sim.running.input.processing</td><td>Input event fails IPC validation / schema checks.</td><td>sim.running.input.rejected</td><td>Drop event; optionally log (dev-only); do not enqueue commands.</td></tr><tr><td>sim.running.input.processing</td><td>Control event is valid; mapping produces 0 commands (unbound).</td><td>sim.running.input.dropped</td><td>Drop event; do not enqueue commands.</td></tr><tr><td>sim.running.input.processing</td><td>Input-event envelope is valid (pointer/wheel) and <code>postMessage</code> succeeds.</td><td>sim.running.input.enqueued</td><td>Enqueue exactly one <code>INPUT_EVENT</code> command for the validated event; no acknowledgment is required.</td></tr><tr><td>sim.running.input.processing</td><td>Control event is valid; mapping produces ≥1 command and <code>postMessage</code> succeeds.</td><td>sim.running.input.enqueued</td><td>Send <code>enqueueCommands</code> to worker; no acknowledgment is required.</td></tr><tr><td>sim.running.input.processing</td><td>Handler/mapping throws OR <code>postMessage</code> throws.</td><td>sim.crashed</td><td>Treat as fatal bridge failure: stop tick interval; log error; notify renderer via <code>simStatus</code>; terminate worker.</td></tr><tr><td>sim.running.input.enqueued</td><td>After <code>postMessage</code> returns.</td><td>sim.running.input.idle</td><td>Clear per-event temporary state; await next input.</td></tr><tr><td>sim.running.input.dropped</td><td>Immediately after dropping.</td><td>sim.running.input.idle</td><td>Clear per-event temporary state; await next input.</td></tr><tr><td>sim.running.input.rejected</td><td>Immediately after rejecting.</td><td>sim.running.input.idle</td><td>Clear per-event temporary state; await next input.</td></tr><tr><td>sim.running.input.*</td><td>Tick interval fires.</td><td>sim.running.input.*</td><td><code>postMessage({ kind:&#x27;tick&#x27;, deltaMs })</code>; no state change for input pipeline.</td></tr><tr><td>sim.running.input.*</td><td>Worker sends <code>kind:&#x27;frame&#x27;</code>.</td><td>sim.running.input.*</td><td>Update <code>nextStep</code>; forward latest frame to renderer via <code>frame</code> IPC; ignore if <code>frame</code> is absent.</td></tr><tr><td>sim.running.input.*</td><td>Worker exits with code <code>0</code> while not disposing.</td><td>sim.stopped</td><td>Stop tick interval; log stop; notify renderer via <code>simStatus</code>; terminate worker.</td></tr><tr><td>sim.running.input.*</td><td>Worker emits <code>error</code>/<code>messageerror</code> OR sends <code>kind:&#x27;error&#x27;</code> OR exits non-zero while not disposing.</td><td>sim.crashed</td><td>Stop tick interval; log crash; notify renderer via <code>simStatus</code>; terminate worker.</td></tr><tr><td>sim.initializing</td><td>Dispose requested (window reload/close) before <code>ready</code>.</td><td>sim.disposing</td><td>Stop tick interval (if started); mark controller disposing; terminate worker.</td></tr><tr><td>sim.running.input.*</td><td>Dispose requested (window reload/close).</td><td>sim.disposing</td><td>Stop tick interval; terminate worker; ignore subsequent input/worker messages.</td></tr><tr><td>sim.disposing</td><td>Worker terminates/closes.</td><td>sim.terminated</td><td>Release controller references; future input is ignored until a new controller is created.</td></tr><tr><td>sim.stopped</td><td>Explicit restart requested (window reload / recreate controller).</td><td>sim.initializing</td><td>Create a new sim worker controller; nested input state resets to <code>sim.running.input.idle</code> after <code>ready</code>.</td></tr><tr><td>sim.crashed</td><td>Explicit restart requested (window reload / recreate controller).</td><td>sim.initializing</td><td>Create a new sim worker controller; nested input state resets to <code>sim.running.input.idle</code> after <code>ready</code>.</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="error-handling">Error Handling<a href="#error-handling" class="hash-link" aria-label="Direct link to Error Handling" title="Direct link to Error Handling" translate="no">​</a></h3>
<p><strong>Handlers</strong>:</p>
<ul>
<li class=""><strong>Global worker/bridge failure handler</strong>: any worker error condition funnels into a single “fail closed” action (stop tick loop, log, send <code>simStatus</code>, terminate worker, ignore future input) and transitions to <code>sim.crashed</code>/<code>sim.stopped</code>.</li>
<li class=""><strong>Per-input-event handling</strong>: IPC payload validation and enqueue/mapping outcomes transition only within <code>sim.running.input.*</code> (reject/drop/enqueue), unless a fatal bridge error occurs.</li>
</ul>
<table><thead><tr><th>State</th><th>Error</th><th>Recovery State</th><th>Actions</th></tr></thead><tbody><tr><td>shell.booting</td><td>Startup promise rejects.</td><td>shell.startup_failed</td><td>Log error; exit process with code <code>1</code>.</td></tr><tr><td>shell.startup_failed</td><td>None (process is exiting).</td><td>shell.startup_failed</td><td>No-op.</td></tr><tr><td>sim.initializing</td><td>Worker thread fails to spawn or init message cannot be sent.</td><td>sim.crashed</td><td>Log error; send <code>simStatus</code> (crashed); terminate/abandon worker handle if present.</td></tr><tr><td>sim.initializing</td><td>Invalid/unsupported worker protocol message.</td><td>sim.initializing</td><td>Ignore message; keep waiting for <code>ready</code> (no retries are performed).</td></tr><tr><td>sim.initializing</td><td>Worker reports <code>kind:&#x27;error&#x27;</code> during init.</td><td>sim.crashed</td><td>Log error; send <code>simStatus</code> (crashed); terminate worker; stop accepting inputs.</td></tr><tr><td>sim.running.input.idle</td><td>Renderer sends malformed input payload.</td><td>sim.running.input.idle</td><td>Drop event at IPC boundary (no state change); do not enqueue commands.</td></tr><tr><td>sim.running.input.pointer_move_coalescing</td><td>RAF is cancelled (e.g., renderer navigation) before flush.</td><td>sim.running.input.idle</td><td>Drop pending pointer-move; do not enqueue commands.</td></tr><tr><td>sim.running.input.processing</td><td>IPC payload is not a valid input event shape.</td><td>sim.running.input.rejected</td><td>Drop event; optionally log in dev to aid diagnosis.</td></tr><tr><td>sim.running.input.processing</td><td>Control-event mapping produces 0 commands (unbound).</td><td>sim.running.input.dropped</td><td>Drop event silently (no implicit forwarding).</td></tr><tr><td>sim.running.input.processing</td><td>Handler/mapping throws (e.g., payload resolver throws).</td><td>sim.crashed</td><td>Treat as fatal bridge failure; log error; stop tick; send <code>simStatus</code> (crashed); terminate worker.</td></tr><tr><td>sim.running.input.processing</td><td><code>worker.postMessage</code> throws.</td><td>sim.crashed</td><td>Treat as fatal bridge failure; log error; stop tick; send <code>simStatus</code> (crashed); terminate worker.</td></tr><tr><td>sim.running.input.enqueued</td><td>None (postMessage has no acknowledgment).</td><td>sim.running.input.idle</td><td>No-op.</td></tr><tr><td>sim.running.input.dropped</td><td>None (event already dropped).</td><td>sim.running.input.idle</td><td>No-op.</td></tr><tr><td>sim.running.input.rejected</td><td>None (event already rejected).</td><td>sim.running.input.idle</td><td>No-op.</td></tr><tr><td>sim.running.input.*</td><td>`webContents.send(frame</td><td>simStatus)` throws (renderer not ready/crashed).</td><td>sim.running.input.*</td></tr><tr><td>sim.running.input.*</td><td>Worker becomes unresponsive (no <code>frame</code>/<code>ready</code>/<code>error</code> messages arrive).</td><td>sim.running.input.*</td><td>No automatic transition; renderer appears stalled; operator recovery is explicit restart (reload).</td></tr><tr><td>sim.running.input.*</td><td>Worker exits with code <code>0</code>.</td><td>sim.stopped</td><td>Log stop; send <code>simStatus</code> (stopped); terminate worker; ignore further input until restart.</td></tr><tr><td>sim.running.input.*</td><td>Worker exits non-zero OR emits <code>error</code>/<code>messageerror</code> OR sends <code>kind:&#x27;error&#x27;</code>.</td><td>sim.crashed</td><td>Log crash; send <code>simStatus</code> (crashed); terminate worker; ignore further input until restart.</td></tr><tr><td>sim.disposing</td><td>Worker termination throws/rejects.</td><td>sim.terminated</td><td>Log error; proceed as terminated (controller must be dead from caller perspective).</td></tr><tr><td>sim.terminated</td><td>Any input/worker message arrives after dispose.</td><td>sim.terminated</td><td>Ignore.</td></tr><tr><td>sim.stopped</td><td>Any input event arrives before restart.</td><td>sim.stopped</td><td>Ignore.</td></tr><tr><td>sim.crashed</td><td>Any input event arrives before restart.</td><td>sim.crashed</td><td>Ignore.</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="crash-recovery">Crash Recovery<a href="#crash-recovery" class="hash-link" aria-label="Direct link to Crash Recovery" title="Direct link to Crash Recovery" translate="no">​</a></h3>
<ul>
<li class=""><strong>Detection</strong>: Recovery is needed if the current controller is in <code>sim.stopped</code> or <code>sim.crashed</code>, if the renderer is reloaded (which disposes and recreates the controller), or if the sim appears stalled (no frames are observed and no crash/stop signal is received).</li>
<li class=""><strong>Recovery state</strong>: <code>sim.initializing</code> (a brand-new sim worker controller; nested input state resets).</li>
<li class=""><strong>Cleanup</strong>: Stop tick interval; clear any pending pointer-move coalescing; terminate/close the previous worker; drop any in-flight input event (no buffering across restarts).</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="subprocesses-if-applicable">Subprocesses (if applicable)<a href="#subprocesses-if-applicable" class="hash-link" aria-label="Direct link to Subprocesses (if applicable)" title="Direct link to Subprocesses (if applicable)" translate="no">​</a></h3>
<table><thead><tr><th>Subprocess</th><th>Receives</th><th>Can Write</th><th>Failure Handling</th></tr></thead><tbody><tr><td>Electron renderer process</td><td><code>IdleEngineApi</code> bridge (send input events; receive frames and sim status).</td><td>IPC messages: input events → main; UI output to DOM/canvas.</td><td>If renderer reloads/crashes: main may fail <code>webContents.send</code> (logged); user reload restarts controller; no queued inputs are replayed.</td></tr><tr><td>Sim worker thread (Node <code>Worker</code>)</td><td><code>init</code>, <code>tick</code>, <code>enqueueCommands</code>, <code>shutdown</code> messages; runtime config (<code>stepSizeMs</code>, <code>maxStepsPerFrame</code>).</td><td>Outbound messages: <code>ready</code>, <code>frame</code>, <code>error</code> back to main; no filesystem writes.</td><td>On <code>error</code>/<code>messageerror</code>/non-zero exit: transition to <code>sim.crashed</code> and terminate worker; on hang/unresponsiveness: no automatic transition, operator restarts via reload.</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="3-interfaces">3. Interfaces<a href="#3-interfaces" class="hash-link" aria-label="Direct link to 3. Interfaces" title="Direct link to 3. Interfaces" translate="no">​</a></h2>
<p>This section defines the <strong>contract surface</strong> for input events across:</p>
<ul>
<li class="">Electron renderer ↔ Electron main (IPC)</li>
<li class="">Main ↔ sim worker (postMessage)</li>
<li class="">Main input mapping → runtime command queue</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="endpoints">Endpoints<a href="#endpoints" class="hash-link" aria-label="Direct link to Endpoints" title="Direct link to Endpoints" translate="no">​</a></h3>
<table><thead><tr><th>Method</th><th>Path</th><th>Input</th><th>Success</th><th>Errors</th></tr></thead><tbody><tr><td>IPC invoke</td><td><code>idle-engine:ping</code></td><td><code>{ message: string }</code></td><td>resolves <code>{ message: string }</code></td><td>rejects if <code>message</code> is not a string</td></tr><tr><td>IPC invoke</td><td><code>idle-engine:read-asset</code></td><td><code>{ url: string }</code></td><td>resolves <code>ArrayBuffer</code></td><td>rejects if url is invalid, non-<code>file:</code>, or escapes compiled asset root</td></tr><tr><td>IPC send</td><td><code>idle-engine:input-event</code></td><td><code>ShellInputEventEnvelope</code></td><td>none (fire-and-forget)</td><td>dropped if payload is invalid or sim is not running; enqueues exactly one <code>INPUT_EVENT</code> per valid pointer/wheel event; <strong>fatal</strong> if handler throws or worker delivery throws</td></tr><tr><td>IPC send</td><td><code>idle-engine:control-event</code></td><td><code>ShellControlEvent</code></td><td>none (fire-and-forget)</td><td>dropped if payload is invalid, sim is not running, or mapping produces 0 commands; <strong>fatal</strong> if mapping throws or worker delivery throws; <code>metadata.passthrough</code> has no effect</td></tr><tr><td>IPC event</td><td><code>idle-engine:frame</code></td><td><code>ShellFramePayload</code></td><td>pushed to listeners</td><td>delivery may fail if renderer is not ready (main logs and continues)</td></tr><tr><td>IPC event</td><td><code>idle-engine:sim-status</code></td><td><code>ShellSimStatusPayload</code></td><td>pushed to listeners</td><td>delivery may fail if renderer is not ready (main logs and continues)</td></tr><tr><td>Worker postMessage</td><td><code>SimWorkerInboundMessage.kind=enqueueCommands</code></td><td><code>{ kind:&#x27;enqueueCommands&#x27;, commands: Command[] }</code></td><td>enqueued for future ticks</td><td><strong>fatal</strong> if <code>postMessage</code> throws → transition to <code>sim.crashed</code> and stop accepting input</td></tr><tr><td>Worker event</td><td><code>SimWorkerOutboundMessage.kind=ready/frame/error</code></td><td>see <code>SimWorkerOutboundMessage</code></td><td>updates main state</td><td>invalid protocol messages are ignored during init; <code>error</code> is <strong>fatal</strong> (crash)</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="cli-commands-if-applicable">CLI Commands (if applicable)<a href="#cli-commands-if-applicable" class="hash-link" aria-label="Direct link to CLI Commands (if applicable)" title="Direct link to CLI Commands (if applicable)" translate="no">​</a></h3>
<p>N/A</p>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="events-if-applicable">Events (if applicable)<a href="#events-if-applicable" class="hash-link" aria-label="Direct link to Events (if applicable)" title="Direct link to Events (if applicable)" translate="no">​</a></h3>
<table><thead><tr><th>Event</th><th>Trigger</th><th>Payload</th><th>Consumers</th></tr></thead><tbody><tr><td><code>idle-engine:frame</code></td><td>Sim worker sends <code>kind:&#x27;frame&#x27;</code> and main forwards the frame.</td><td><code>RenderCommandBuffer</code></td><td>Electron renderer (<code>IdleEngineApi.onFrame</code>)</td></tr><tr><td><code>idle-engine:sim-status</code></td><td>Main enters <code>starting</code>, <code>running</code>, <code>stopped</code>, or <code>crashed</code>.</td><td><code>ShellSimStatusPayload</code></td><td>Electron renderer (<code>IdleEngineApi.onSimStatus</code>)</td></tr><tr><td><code>sim-worker:ready</code></td><td>Sim worker sends <code>kind:&#x27;ready&#x27;</code>.</td><td><code>{ kind:&#x27;ready&#x27;, stepSizeMs:number, nextStep:number }</code></td><td>Electron main controller</td></tr><tr><td><code>sim-worker:frame</code></td><td>Sim worker sends <code>kind:&#x27;frame&#x27;</code>.</td><td><code>{ kind:&#x27;frame&#x27;, frame?:RenderCommandBuffer, droppedFrames:number, nextStep:number }</code></td><td>Electron main controller</td></tr><tr><td><code>sim-worker:error</code></td><td>Sim worker sends <code>kind:&#x27;error&#x27;</code> or worker emits <code>error</code>/<code>messageerror</code>/non-zero exit.</td><td><code>{ kind:&#x27;error&#x27;, error:string }</code> plus worker error/exit metadata</td><td>Electron main controller (transitions to <code>sim.crashed</code>/<code>sim.stopped</code>)</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="runtime-commands">Runtime Commands<a href="#runtime-commands" class="hash-link" aria-label="Direct link to Runtime Commands" title="Direct link to Runtime Commands" translate="no">​</a></h3>
<table><thead><tr><th>Command Type</th><th>Payload</th><th>Producer</th><th>Consumers</th><th>Errors</th></tr></thead><tbody><tr><td><code>INPUT_EVENT</code> (new)</td><td><code>InputEventCommandPayload</code></td><td>Electron main process (<code>idle-engine:input-event</code> handler; 1:1 for valid pointer/wheel events)</td><td>UI/controls systems inside sim runtime</td><td>command is produced for every valid pointer/wheel input-event; handler/worker errors are <strong>fatal</strong> (see workflow)</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="validation-rules">Validation Rules<a href="#validation-rules" class="hash-link" aria-label="Direct link to Validation Rules" title="Direct link to Validation Rules" translate="no">​</a></h3>
<p>All renderer-provided validation is <strong>synchronous</strong> at the IPC boundary (main process). When validation fails:</p>
<ul>
<li class="">IPC invoke endpoints reject with a thrown <code>TypeError</code> (Promise rejects in renderer).</li>
<li class="">IPC send endpoints are dropped (no acknowledgment); main may log in dev builds.</li>
</ul>
<p>Separately, the sim-side <code>INPUT_EVENT</code> command handler validates <code>InputEventCommandPayload.schemaVersion</code> for commands originating from restores/replays; non-<code>1</code> is treated as a fatal incompatibility (crash).</p>
<table><thead><tr><th>Field</th><th>Type</th><th>Constraints</th><th>Error</th></tr></thead><tbody><tr><td><code>PingRequest.message</code></td><td>string</td><td>required</td><td><code>TypeError(&quot;Invalid ping request: expected { message: string }&quot;)</code></td></tr><tr><td><code>ReadAssetRequest.url</code></td><td>string</td><td>required, non-empty; must parse as URL; must be <code>file:</code>; must resolve inside compiled assets root</td><td><code>TypeError(&quot;Invalid read asset request: expected { url: string }&quot;)</code>, <code>TypeError(&quot;Invalid asset url: expected a file:// URL.&quot;)</code>, <code>TypeError(&quot;Invalid asset url: path must be inside compiled assets.&quot;)</code>, or URL parse <code>TypeError</code></td></tr><tr><td><code>ShellControlEvent.intent</code></td><td>string</td><td>required; non-empty after trim</td><td>drop control event</td></tr><tr><td><code>ShellControlEvent.phase</code></td><td>string</td><td>required; one of <code>start</code>, <code>repeat</code>, <code>end</code></td><td>drop control event</td></tr><tr><td><code>ShellControlEvent.value</code></td><td>number</td><td>optional; if present must be finite</td><td>drop control event</td></tr><tr><td><code>ShellControlEvent.metadata</code></td><td>object</td><td>optional; if present must be a non-null object and not an array; keys are not validated; <code>metadata.passthrough</code> is ignored</td><td>drop control event</td></tr><tr><td><code>ShellInputEventEnvelope.schemaVersion</code></td><td>number</td><td>required; must equal <code>1</code></td><td>drop input event</td></tr><tr><td><code>ShellInputEventEnvelope.event</code></td><td>object</td><td>required</td><td>drop input event</td></tr><tr><td><code>InputEvent.kind</code></td><td>string</td><td>required; one of <code>pointer</code>, <code>wheel</code></td><td>drop input event</td></tr><tr><td><code>InputEvent.intent</code></td><td>string</td><td>required; if <code>kind:&#x27;pointer&#x27;</code>: one of <code>mouse-down</code>, <code>mouse-up</code>, <code>mouse-move</code>; if <code>kind:&#x27;wheel&#x27;</code>: must equal <code>mouse-wheel</code></td><td>drop input event</td></tr><tr><td><code>InputEvent.phase</code></td><td>string</td><td>required; if <code>kind:&#x27;pointer&#x27;</code>: must match intent (<code>mouse-down → start</code>, <code>mouse-move → repeat</code>, <code>mouse-up → end</code>); if <code>kind:&#x27;wheel&#x27;</code>: must equal <code>repeat</code></td><td>drop input event</td></tr><tr><td><code>InputEvent.x/y</code></td><td>number</td><td>required; finite; canvas-relative CSS pixel coordinates derived as <code>clientX/Y - canvas.getBoundingClientRect().left/top</code></td><td>drop input event</td></tr><tr><td><code>InputEvent.button</code></td><td>number</td><td>required when <code>kind:&#x27;pointer&#x27;</code>; integer; range <code>-1..32</code></td><td>drop input event</td></tr><tr><td><code>InputEvent.buttons</code></td><td>number</td><td>required when <code>kind:&#x27;pointer&#x27;</code>; integer; range <code>0..0xFFFF</code></td><td>drop input event</td></tr><tr><td><code>InputEvent.pointerType</code></td><td>string</td><td>required when <code>kind:&#x27;pointer&#x27;</code>; one of <code>mouse</code>, <code>pen</code>, <code>touch</code></td><td>drop input event</td></tr><tr><td><code>InputEvent.modifiers</code></td><td>object</td><td>required; <code>{ alt, ctrl, meta, shift }</code> booleans</td><td>drop input event</td></tr><tr><td><code>InputEvent.deltaX/Y/Z</code></td><td>number</td><td>required when <code>kind:&#x27;wheel&#x27;</code>; finite</td><td>drop input event</td></tr><tr><td><code>InputEvent.deltaMode</code></td><td>number</td><td>required when <code>kind:&#x27;wheel&#x27;</code>; one of <code>0</code>, <code>1</code>, <code>2</code></td><td>drop input event</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="ui-interactions-if-applicable">UI Interactions (if applicable)<a href="#ui-interactions-if-applicable" class="hash-link" aria-label="Direct link to UI Interactions (if applicable)" title="Direct link to UI Interactions (if applicable)" translate="no">​</a></h3>
<table><thead><tr><th>Action</th><th>Request</th><th>Loading State</th><th>Success</th><th>Error</th></tr></thead><tbody><tr><td>Press Space (demo “collect”)</td><td><code>IPC send idle-engine:control-event</code></td><td>none</td><td>Sim enqueues <code>COLLECT_RESOURCE</code> and UI updates on next frame</td><td>if sim is stopped/crashed: input is ignored; status text indicates “Reload to restart”</td></tr><tr><td>Pointer down/up/move on canvas</td><td><code>IPC send idle-engine:input-event</code> (<code>kind:&#x27;pointer&#x27;</code>)</td><td>none</td><td>Main enqueues exactly one <code>INPUT_EVENT</code> command per valid pointer event; UI responds deterministically at tick boundaries</td><td>invalid payload is dropped; if handler/bridge crashes, renderer receives <code>sim-status: crashed</code></td></tr><tr><td>Mouse wheel on canvas</td><td><code>IPC send idle-engine:input-event</code> (<code>kind:&#x27;wheel&#x27;</code>)</td><td>none</td><td>Main enqueues exactly one <code>INPUT_EVENT</code> command per valid wheel event</td><td>same as above</td></tr></tbody></table>
<h4 class="anchor anchorTargetStickyNavbar_pQUT" id="contract-gates">Contract gates<a href="#contract-gates" class="hash-link" aria-label="Direct link to Contract gates" title="Direct link to Contract gates" translate="no">​</a></h4>
<ul>
<li class=""><strong>Breaking change</strong>: Yes, behaviorally. <code>metadata.passthrough</code> no longer causes implicit forwarding, and <code>SHELL_CONTROL_EVENT</code> commands are no longer emitted.</li>
<li class=""><strong>Migration</strong>: Pointer/wheel inputs are forwarded by the desktop shell as a 1:1 <code>INPUT_EVENT</code> runtime command (<code>InputEventCommandPayload.event</code>). Any system that previously consumed <code>SHELL_CONTROL_EVENT.payload.event.metadata</code> must consume <code>InputEventCommandPayload.event</code> instead. <code>idle-engine:control-event</code> remains binding-driven; unbound control intents remain dropped (no passthrough).</li>
<li class=""><strong>Versioning</strong>: <code>ShellInputEventEnvelope.schemaVersion</code> starts at <code>1</code>. Main must reject unknown versions (drop) and may support <code>N-1</code> during migrations. <code>INPUT_EVENT</code> payload is versioned via <code>InputEventCommandPayload.schemaVersion</code> (also <code>1</code>).</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_pQUT" id="main-produced-input_event-command-fields">Main-produced <code>INPUT_EVENT</code> command fields<a href="#main-produced-input_event-command-fields" class="hash-link" aria-label="Direct link to main-produced-input_event-command-fields" title="Direct link to main-produced-input_event-command-fields" translate="no">​</a></h4>
<p>When Electron main receives a valid <code>ShellInputEventEnvelope</code>, it enqueues exactly one runtime command with the following fields:</p>
<ul>
<li class=""><code>type</code>: <code>RUNTIME_COMMAND_TYPES.INPUT_EVENT</code></li>
<li class=""><code>priority</code>: <code>CommandPriority.PLAYER</code></li>
<li class=""><code>step</code>: snapshot of the controller’s current <code>nextStep</code> when the IPC message is processed</li>
<li class=""><code>timestamp</code>: <code>step * stepSizeMs</code> (aligned to sim tick time; not wall-clock time)</li>
<li class=""><code>payload</code>: <code>{ schemaVersion: 1, event }</code> where <code>event</code> is the validated <code>InputEvent</code></li>
<li class=""><code>requestId</code>: not set (left <code>undefined</code>)</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_pQUT" id="type-contracts-wire-level">Type contracts (wire-level)<a href="#type-contracts-wire-level" class="hash-link" aria-label="Direct link to Type contracts (wire-level)" title="Direct link to Type contracts (wire-level)" translate="no">​</a></h4>
<div class="language-ts codeBlockContainer_QSSF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_YGpJ"><pre tabindex="0" class="prism-code language-ts codeBlock_Ap7y thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_zA5F"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Canonical input-event types (InputEvent, InputEventCommandPayload) live in @idle-engine/core.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ShellControlEvent remains a shell-desktop-only IPC contract in packages/shell-desktop/src/ipc.ts.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">ShellControlEvent</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  intent</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  phase</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;start&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;repeat&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;end&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * Optional extra event data passed through the IPC boundary.</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   *</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * The main process validates only that `metadata` is a plain object when present</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * (non-null, non-array) and does not validate keys.</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   *</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * Reserved keys:</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   * - `passthrough`: ignored and has no effect.</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metadata</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">unknown</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">InputEvent</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;pointer&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      intent</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;mouse-down&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;mouse-up&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;mouse-move&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      phase</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;start&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;repeat&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;end&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      x</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      y</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      button</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      buttons</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pointerType</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;mouse&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;pen&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;touch&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      modifiers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> alt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> ctrl</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> meta</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> shift</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;wheel&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      intent</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;mouse-wheel&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      phase</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;repeat&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      x</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      y</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      deltaX</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      deltaY</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      deltaZ</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      deltaMode</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      modifiers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> alt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> ctrl</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> meta</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> shift</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// IPC envelope lives in packages/shell-desktop but references the canonical InputEvent type.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">ShellInputEventEnvelope</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  schemaVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  event</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> InputEvent</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">InputEventCommandPayload</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  schemaVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  event</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> InputEvent</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="4-data">4. Data<a href="#4-data" class="hash-link" aria-label="Direct link to 4. Data" title="Direct link to 4. Data" translate="no">​</a></h2>
<p>This feature introduces a <strong>typed, versioned input-event schema</strong> for desktop-shell forwarded inputs and a <strong>typed runtime command payload</strong> for replayable input events. No new on-disk files are created; the only persisted surface area is via existing save/snapshot/replay mechanisms that already serialize command-queue entries as JSON.</p>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="schema-changes">Schema Changes<a href="#schema-changes" class="hash-link" aria-label="Direct link to Schema Changes" title="Direct link to Schema Changes" translate="no">​</a></h3>
<table><thead><tr><th>Location</th><th>Field</th><th>Type</th><th>Required</th><th>Default</th><th>Constraints</th></tr></thead><tbody><tr><td><code>packages/shell-desktop/src/ipc.ts</code></td><td><code>IPC_CHANNELS.inputEvent</code></td><td><code>string</code></td><td>yes</td><td>n/a</td><td>must equal <code>idle-engine:input-event</code></td></tr><tr><td><code>packages/shell-desktop/src/ipc.ts</code></td><td><code>ShellInputEventEnvelope.schemaVersion</code></td><td><code>1</code></td><td>yes</td><td><code>1</code> (when encoding)</td><td>reject/drop if not exactly <code>1</code></td></tr><tr><td><code>packages/shell-desktop/src/ipc.ts</code></td><td><code>ShellInputEventEnvelope.event</code></td><td><code>InputEvent</code></td><td>yes</td><td>n/a</td><td>reject/drop if missing or not an object</td></tr><tr><td><code>packages/core/src/input-event.ts</code></td><td><code>InputEvent.kind</code></td><td><code>&#x27;pointer&#x27; | &#x27;wheel&#x27;</code></td><td>yes</td><td>n/a</td><td>must be one of the listed literals</td></tr><tr><td><code>packages/core/src/input-event.ts</code></td><td><code>InputEvent.intent</code></td><td><code>&#x27;mouse-down&#x27; | &#x27;mouse-up&#x27; | &#x27;mouse-move&#x27; | &#x27;mouse-wheel&#x27;</code></td><td>yes</td><td>n/a</td><td>if <code>kind:&#x27;pointer&#x27;</code>: must be one of <code>mouse-down</code>/<code>mouse-up</code>/<code>mouse-move</code>; if <code>kind:&#x27;wheel&#x27;</code>: must equal <code>mouse-wheel</code></td></tr><tr><td><code>packages/core/src/input-event.ts</code></td><td><code>InputEvent.phase</code></td><td><code>&#x27;start&#x27; | &#x27;repeat&#x27; | &#x27;end&#x27;</code></td><td>yes</td><td>n/a</td><td>if <code>kind:&#x27;pointer&#x27;</code>: must match intent (<code>mouse-down→start</code>, <code>mouse-move→repeat</code>, <code>mouse-up→end</code>); if <code>kind:&#x27;wheel&#x27;</code>: must equal <code>repeat</code></td></tr><tr><td><code>packages/core/src/input-event.ts</code></td><td><code>InputEvent.x</code></td><td><code>number</code></td><td>yes</td><td>n/a</td><td>finite; canvas-relative CSS pixels (<code>clientX - canvas.getBoundingClientRect().left</code>)</td></tr><tr><td><code>packages/core/src/input-event.ts</code></td><td><code>InputEvent.y</code></td><td><code>number</code></td><td>yes</td><td>n/a</td><td>finite; canvas-relative CSS pixels (<code>clientY - canvas.getBoundingClientRect().top</code>)</td></tr><tr><td><code>packages/core/src/input-event.ts</code></td><td><code>InputEvent.button</code></td><td><code>number</code></td><td>yes (kind<!-- -->:pointer<!-- -->)</td><td>n/a</td><td>integer; range <code>-1..32</code></td></tr><tr><td><code>packages/core/src/input-event.ts</code></td><td><code>InputEvent.buttons</code></td><td><code>number</code></td><td>yes (kind<!-- -->:pointer<!-- -->)</td><td>n/a</td><td>integer; range <code>0..0xFFFF</code></td></tr><tr><td><code>packages/core/src/input-event.ts</code></td><td><code>InputEvent.pointerType</code></td><td><code>&#x27;mouse&#x27; | &#x27;pen&#x27; | &#x27;touch&#x27;</code></td><td>yes (kind<!-- -->:pointer<!-- -->)</td><td>n/a</td><td>must be one of the listed literals</td></tr><tr><td><code>packages/core/src/input-event.ts</code></td><td><code>InputEvent.modifiers</code></td><td><code>{ alt, ctrl, meta, shift }</code></td><td>yes</td><td>n/a</td><td>object with all four boolean keys present</td></tr><tr><td><code>packages/core/src/input-event.ts</code></td><td><code>InputEvent.modifiers.alt</code></td><td><code>boolean</code></td><td>yes</td><td>n/a</td><td>-</td></tr><tr><td><code>packages/core/src/input-event.ts</code></td><td><code>InputEvent.modifiers.ctrl</code></td><td><code>boolean</code></td><td>yes</td><td>n/a</td><td>-</td></tr><tr><td><code>packages/core/src/input-event.ts</code></td><td><code>InputEvent.modifiers.meta</code></td><td><code>boolean</code></td><td>yes</td><td>n/a</td><td>-</td></tr><tr><td><code>packages/core/src/input-event.ts</code></td><td><code>InputEvent.modifiers.shift</code></td><td><code>boolean</code></td><td>yes</td><td>n/a</td><td>-</td></tr><tr><td><code>packages/core/src/input-event.ts</code></td><td><code>InputEvent.deltaX</code></td><td><code>number</code></td><td>yes (kind<!-- -->:wheel<!-- -->)</td><td>n/a</td><td>finite</td></tr><tr><td><code>packages/core/src/input-event.ts</code></td><td><code>InputEvent.deltaY</code></td><td><code>number</code></td><td>yes (kind<!-- -->:wheel<!-- -->)</td><td>n/a</td><td>finite</td></tr><tr><td><code>packages/core/src/input-event.ts</code></td><td><code>InputEvent.deltaZ</code></td><td><code>number</code></td><td>yes (kind<!-- -->:wheel<!-- -->)</td><td>n/a</td><td>finite</td></tr><tr><td><code>packages/core/src/input-event.ts</code></td><td><code>InputEvent.deltaMode</code></td><td><code>0 | 1 | 2</code></td><td>yes (kind<!-- -->:wheel<!-- -->)</td><td>n/a</td><td>must be one of the listed literals</td></tr><tr><td><code>packages/core/src/command.ts</code></td><td><code>RUNTIME_COMMAND_TYPES.INPUT_EVENT</code></td><td><code>string</code></td><td>yes</td><td>n/a</td><td>must equal <code>INPUT_EVENT</code></td></tr><tr><td><code>packages/core/src/command.ts</code></td><td><code>RuntimeCommandPayloads.INPUT_EVENT</code></td><td><code>InputEventCommandPayload</code></td><td>yes</td><td>n/a</td><td>payload must be JSON-serializable</td></tr><tr><td><code>packages/core/src/command.ts</code></td><td><code>InputEventCommandPayload.schemaVersion</code></td><td><code>1</code></td><td>yes</td><td><code>1</code> (when encoding)</td><td>validated by the sim-side <code>INPUT_EVENT</code> handler; unknown versions crash the sim worker</td></tr><tr><td><code>packages/core/src/command.ts</code></td><td><code>InputEventCommandPayload.event</code></td><td><code>InputEvent</code></td><td>yes</td><td>n/a</td><td>must satisfy the same variant constraints as IPC <code>ShellInputEventEnvelope.event</code></td></tr><tr><td><code>packages/shell-desktop/src/ipc.ts</code></td><td><code>ShellControlEvent.metadata</code> (legacy; passthrough ignored)</td><td><code>Record&lt;string, unknown&gt;</code></td><td>no</td><td><code>undefined</code></td><td><code>metadata.passthrough</code> is ignored; pointer/wheel metadata must not be relied on</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="command-authorization-command_authorizations">Command Authorization (<code>COMMAND_AUTHORIZATIONS</code>)<a href="#command-authorization-command_authorizations" class="hash-link" aria-label="Direct link to command-authorization-command_authorizations" title="Direct link to command-authorization-command_authorizations" translate="no">​</a></h3>
<p>The <code>INPUT_EVENT</code> command is only allowed in the player priority lane so that UI interactions cannot be synthesized by automation.</p>
<ul>
<li class=""><code>COMMAND_AUTHORIZATIONS[RUNTIME_COMMAND_TYPES.INPUT_EVENT].allowedPriorities</code>: <code>[CommandPriority.PLAYER]</code></li>
<li class=""><code>COMMAND_AUTHORIZATIONS[RUNTIME_COMMAND_TYPES.INPUT_EVENT].rationale</code>: Input events represent player-originated shell interactions; automation must not inject UI inputs.</li>
<li class=""><code>COMMAND_AUTHORIZATIONS[RUNTIME_COMMAND_TYPES.INPUT_EVENT].unauthorizedEvent</code>: <code>UnauthorizedInputEventCommand</code></li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="version-validation-schemaversion">Version Validation (<code>schemaVersion</code>)<a href="#version-validation-schemaversion" class="hash-link" aria-label="Direct link to version-validation-schemaversion" title="Direct link to version-validation-schemaversion" translate="no">​</a></h3>
<ul>
<li class=""><strong>IPC (wire-level)</strong>: <code>ShellInputEventEnvelope.schemaVersion</code> is validated in Electron main in the <code>IPC_CHANNELS.inputEvent</code> handler. Non-<code>1</code> payloads are dropped (no worker enqueue).</li>
<li class=""><strong>Runtime (command payload)</strong>: <code>InputEventCommandPayload.schemaVersion</code> is validated by the sim-side handler for <code>RUNTIME_COMMAND_TYPES.INPUT_EVENT</code> before reading <code>payload.event</code>. If the version is not <code>1</code>, the handler throws and the sim worker transitions to <code>error</code>/<code>crashed</code> (fail-fast for incompatible replays/snapshots).</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="field-definitions">Field Definitions<a href="#field-definitions" class="hash-link" aria-label="Direct link to Field Definitions" title="Direct link to Field Definitions" translate="no">​</a></h3>
<p><strong><code>IPC_CHANNELS.inputEvent</code></strong></p>
<ul>
<li class="">Purpose: Stable channel name for sending typed input events across the Electron IPC boundary (renderer → main).</li>
<li class="">Set by: <code>packages/shell-desktop</code> IPC contract definition.</li>
<li class="">Read by: Renderer sender and main-process receiver.</li>
</ul>
<p><strong><code>ShellInputEventEnvelope.schemaVersion</code></strong></p>
<ul>
<li class="">Purpose: Wire-level version gate for input-event payloads.</li>
<li class="">Set by: Desktop renderer when emitting an input event.</li>
<li class="">Read by: Desktop main process when validating inbound input events.</li>
<li class="">Derived: Constant <code>1</code> for this feature’s initial rollout.</li>
</ul>
<p><strong><code>ShellInputEventEnvelope.event</code></strong></p>
<ul>
<li class="">Purpose: Carries the typed pointer/wheel input event across IPC.</li>
<li class="">Set by: Desktop renderer input capture layer.</li>
<li class="">Read by: Desktop main input handler (enqueues runtime commands).</li>
<li class="">Type ownership: <code>event</code> is the canonical <code>InputEvent</code> type from <code>@idle-engine/core</code> (core owns the variant definitions).</li>
<li class="">References: No foreign keys; <code>intent</code> strings are matched against control/binding intent strings but are not strong references.</li>
</ul>
<p><strong><code>InputEvent.*</code> (variants)</strong></p>
<ul>
<li class="">Purpose: Lossless-but-minimal representation of the input needed for deterministic UI/control handling.</li>
<li class="">Set by: Desktop renderer (source-of-truth is the browser/DOM event data).</li>
<li class="">Read by: Desktop main mapper; optionally embedded into <code>INPUT_EVENT</code> runtime commands for sim-side consumption.</li>
<li class="">Derived fields:<!-- -->
<ul>
<li class="">If <code>kind:&#x27;pointer&#x27;</code>, <code>phase</code> is derived from <code>intent</code> (<code>mouse-down→start</code>, <code>mouse-move→repeat</code>, <code>mouse-up→end</code>) and must remain consistent; mismatches are rejected.</li>
<li class="">If <code>kind:&#x27;wheel&#x27;</code>, <code>phase</code> is always <code>repeat</code>.</li>
<li class=""><code>x/y</code> are derived in the renderer in <strong>CSS pixels</strong> as <code>clientX/Y - canvas.getBoundingClientRect().left/top</code> (no devicePixelRatio scaling).</li>
</ul>
</li>
<li class="">Ordering dependencies: None stored in the payload; ordering is defined by IPC delivery order and the main-process enqueue policy (commands are scheduled at the runtime’s next executable step).</li>
</ul>
<p><strong><code>InputEventCommandPayload.schemaVersion</code></strong></p>
<ul>
<li class="">Purpose: Version gate for runtime command payload evolution independent of IPC evolution.</li>
<li class="">Set by: Desktop main process when producing an <code>INPUT_EVENT</code> command.</li>
<li class="">Read by: Sim-side command handler(s) that consume <code>INPUT_EVENT</code>.</li>
<li class="">Derived: Constant <code>1</code> for this feature’s initial rollout.</li>
</ul>
<p><strong><code>InputEventCommandPayload.event</code></strong></p>
<ul>
<li class="">Purpose: The replayable input event attached to an <code>INPUT_EVENT</code> runtime command.</li>
<li class="">Set by: Desktop main process (copied from a validated <code>ShellInputEventEnvelope.event</code>).</li>
<li class="">Read by: Sim-side controls/UI input system(s).</li>
<li class="">References: No foreign keys; <code>intent</code> is a semantic identifier only.</li>
</ul>
<p><strong><code>ShellControlEvent.metadata</code> (legacy; passthrough ignored)</strong></p>
<ul>
<li class="">Purpose: Extensibility hook for <code>idle-engine:control-event</code>; retained for backwards compatibility with existing control scheme resolvers that read arbitrary metadata.</li>
<li class="">Set by: Legacy control-event senders (renderer or other callers).</li>
<li class="">Read by: Control scheme payload resolvers; desktop shell ignores <code>metadata.passthrough</code> and does not forward raw pointer/wheel metadata via <code>SHELL_CONTROL_EVENT</code>.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="migrations">Migrations<a href="#migrations" class="hash-link" aria-label="Direct link to Migrations" title="Direct link to Migrations" translate="no">​</a></h3>
<table><thead><tr><th>Change</th><th>Existing Data</th><th>Migration</th><th>Rollback</th></tr></thead><tbody><tr><td>Add IPC input-event envelope (<code>ShellInputEventEnvelope</code>, <code>IPC_CHANNELS.inputEvent</code>)</td><td>No records exist; channel absent</td><td>Add new IPC channel and validate on receive; absence means no typed input events are sent</td><td>Remove channel; renderer falls back to legacy control events only</td></tr><tr><td>Add runtime command type <code>INPUT_EVENT</code> with <code>InputEventCommandPayload</code></td><td>Existing command queues/snapshots contain no <code>INPUT_EVENT</code> entries</td><td>Add command handler(s) for <code>INPUT_EVENT</code>; the desktop main process emits exactly one <code>INPUT_EVENT</code> per validated pointer/wheel input-event IPC message</td><td>Remove handler and stop emitting <code>INPUT_EVENT</code></td></tr><tr><td>Deprecate passthrough forwarding and <code>SHELL_CONTROL_EVENT</code> production</td><td>Older saves/snapshots <em>may</em> contain <code>SHELL_CONTROL_EVENT</code> entries</td><td>Do not emit <code>SHELL_CONTROL_EVENT</code> going forward. For compatibility, <strong>keep a no-op handler registered for <code>SHELL_CONTROL_EVENT</code> in the demo sim runtime</strong> so restores do not produce <code>UnknownCommandType</code> errors (<code>packages/shell-desktop/src/sim/sim-runtime.ts</code>).</td><td>Restore legacy behavior only by reintroducing passthrough forwarding and emitting <code>SHELL_CONTROL_EVENT</code> (not recommended)</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="artifacts">Artifacts<a href="#artifacts" class="hash-link" aria-label="Direct link to Artifacts" title="Direct link to Artifacts" translate="no">​</a></h3>
<table><thead><tr><th>Artifact</th><th>Location</th><th>Created</th><th>Updated</th><th>Deleted</th></tr></thead><tbody><tr><td>IPC input-event message</td><td>Electron IPC message on <code>idle-engine:input-event</code></td><td>When renderer captures input</td><td>Never (immutable)</td><td>After message delivery/GC (ephemeral)</td></tr><tr><td><code>INPUT_EVENT</code> command</td><td>In-memory command queue entry</td><td>When main maps a validated <code>InputEvent</code> to <code>INPUT_EVENT</code></td><td>Never (immutable)</td><td>When dequeued/executed or queue is cleared on restart</td></tr><tr><td>Serialized <code>INPUT_EVENT</code> payload</td><td><code>SerializedCommandQueueV1.entries[].payload</code> (inside <code>GameStateSnapshot.commandQueue</code>)</td><td>When a snapshot/save captures the command queue</td><td>Never (immutable)</td><td>When the snapshot/save is discarded by the caller</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="artifact-lifecycle">Artifact Lifecycle<a href="#artifact-lifecycle" class="hash-link" aria-label="Direct link to Artifact Lifecycle" title="Direct link to Artifact Lifecycle" translate="no">​</a></h3>
<table><thead><tr><th>Scenario</th><th>Artifact Behavior</th></tr></thead><tbody><tr><td>Success</td><td>For <code>idle-engine:input-event</code> (pointer/wheel): IPC message is validated and exactly one <code>INPUT_EVENT</code> command is created and enqueued; queued commands execute at tick boundaries and are then removed. For <code>idle-engine:control-event</code>: 0..N commands may be created/enqueued depending on bindings.</td></tr><tr><td>Failure</td><td>Invalid IPC payloads are dropped (no commands created). Unbound control events (binding produces 0 commands) produce no artifacts beyond transient mapping work.</td></tr><tr><td>Crash recovery</td><td>Renderer→main IPC messages in flight are lost. Any <code>INPUT_EVENT</code> commands not yet dequeued are lost if the runtime/controller is restarted without persisting the queue; if a snapshot/save captured them, they persist only within that snapshot/save.</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="5-tasks">5. Tasks<a href="#5-tasks" class="hash-link" aria-label="Direct link to 5. Tasks" title="Direct link to 5. Tasks" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="decomposition-gates">Decomposition Gates<a href="#decomposition-gates" class="hash-link" aria-label="Direct link to Decomposition Gates" title="Direct link to Decomposition Gates" translate="no">​</a></h3>
<ol>
<li class=""><strong>Smallest independently testable unit</strong>: Add the <code>INPUT_EVENT</code> runtime command type + its payload types in <code>@idle-engine/core</code> (verifiable via <code>@idle-engine/core</code> typecheck/tests).</li>
<li class=""><strong>Dependencies</strong>: Yes; shell-desktop IPC/types should depend on the core command/type additions, and main/renderer updates depend on the IPC surface existing.</li>
<li class=""><strong>Parallel work</strong>: Yes; after the IPC surface exists, renderer capture (T3) and main mapping (T4) can proceed in parallel; sim-runtime wiring (T5) can proceed after core types land (T1).</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="ordering-gates">Ordering Gates<a href="#ordering-gates" class="hash-link" aria-label="Direct link to Ordering Gates" title="Direct link to Ordering Gates" translate="no">​</a></h3>
<ol start="7">
<li class=""><strong>Must be done first</strong>: Define shared types + <code>INPUT_EVENT</code> command type in <code>@idle-engine/core</code> (T1).</li>
<li class=""><strong>Must be done last</strong>: Integration checks + coverage/docs regeneration (T6).</li>
<li class=""><strong>Circular dependencies</strong>: None in this breakdown; shared input-event types live in <code>@idle-engine/core</code> to avoid core↔shell cycles.</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="infrastructure-gates">Infrastructure Gates<a href="#infrastructure-gates" class="hash-link" aria-label="Direct link to Infrastructure Gates" title="Direct link to Infrastructure Gates" translate="no">​</a></h3>
<ol start="10">
<li class=""><strong>Build/config changes</strong>: None expected beyond updating TypeScript sources and checked-in <code>dist/</code> outputs via existing <code>pnpm build</code> scripts.</li>
<li class=""><strong>New dependencies</strong>: None.</li>
<li class=""><strong>Env vars/secrets</strong>: None required; optional dev-only <code>IDLE_ENGINE_ENABLE_UNSAFE_WEBGPU=1</code> remains unchanged.</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="task-dependency-graph">Task Dependency Graph<a href="#task-dependency-graph" class="hash-link" aria-label="Direct link to Task Dependency Graph" title="Direct link to Task Dependency Graph" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_QSSF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_YGpJ"><pre tabindex="0" class="prism-code language-text codeBlock_Ap7y thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_zA5F"><span class="token-line" style="color:#393A34"><span class="token plain">T1 (no deps)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">T2 → depends on T1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">T3 → depends on T2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">T4 → depends on T2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">T5 → depends on T1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">T6 → depends on T3, T4, T5</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="task-breakdown">Task Breakdown<a href="#task-breakdown" class="hash-link" aria-label="Direct link to Task Breakdown" title="Direct link to Task Breakdown" translate="no">​</a></h3>
<table><thead><tr><th>ID</th><th>Title</th><th>Summary</th><th>Files</th><th>Acceptance Criteria</th></tr></thead><tbody><tr><td>T1</td><td>Add <code>INPUT_EVENT</code> to core</td><td>Define shared typed input-event contracts and register <code>INPUT_EVENT</code> as a runtime command type.</td><td><code>packages/core/src/command.ts</code></td><td>Core exports <code>RUNTIME_COMMAND_TYPES.INPUT_EVENT</code> + typed payload; <code>pnpm --filter @idle-engine/core typecheck</code> passes.</td></tr><tr><td>T2</td><td>Add IPC channel + API</td><td>Introduce <code>idle-engine:input-event</code> IPC channel and expose <code>sendInputEvent</code> on the preload bridge.</td><td><code>packages/shell-desktop/src/ipc.ts</code></td><td>IPC channel + types exist; preload exposes <code>sendInputEvent</code>; shell-desktop IPC/preload tests pass.</td></tr><tr><td>T3</td><td>Send typed input events</td><td>Update desktop renderer to send typed pointer/wheel events via <code>sendInputEvent</code> (with RAF coalescing for moves).</td><td><code>packages/shell-desktop/src/renderer/index.ts</code></td><td>Pointer/wheel events call <code>sendInputEvent</code> with schemaVersion <code>1</code>; renderer unit tests pass.</td></tr><tr><td>T4</td><td>Validate + enqueue input events</td><td>Add main-process validation for <code>ShellInputEventEnvelope</code> and enqueue <code>INPUT_EVENT</code> commands; remove passthrough + stop emitting <code>SHELL_CONTROL_EVENT</code>.</td><td><code>packages/shell-desktop/src/main.ts</code></td><td>Invalid input-event IPC payloads are dropped; valid pointer/wheel events enqueue <code>INPUT_EVENT</code>; <code>SHELL_CONTROL_EVENT</code> is never enqueued; main tests pass.</td></tr><tr><td>T5</td><td>Consume <code>INPUT_EVENT</code> for demo UI</td><td>Migrate demo pointer/UI handling from legacy <code>SHELL_CONTROL_EVENT</code> passthrough to <code>INPUT_EVENT</code> so canvas UI interactions remain functional; keep legacy compatibility explicit.</td><td><code>packages/shell-desktop/src/sim/sim-runtime.ts</code></td><td>Sim consumes <code>INPUT_EVENT</code> for click-to-collect; sim-runtime tests pass.</td></tr><tr><td>T6</td><td>Integrate + regenerate coverage</td><td>Run workspace checks, update any remaining references, and regenerate <code>docs/coverage/index.md</code>.</td><td><code>docs/coverage/index.md</code></td><td><code>pnpm typecheck/lint/test</code> pass and coverage markdown is regenerated.</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="task-details">Task Details<a href="#task-details" class="hash-link" aria-label="Direct link to Task Details" title="Direct link to Task Details" translate="no">​</a></h3>
<p><strong>T1: Add <code>INPUT_EVENT</code> to core</strong></p>
<ul>
<li class="">Summary: Introduce shared <code>InputEvent</code> types and the new <code>INPUT_EVENT</code> runtime command type with a versioned payload.</li>
<li class="">Files:<!-- -->
<ul>
<li class=""><code>packages/core/src/command.ts</code> - add <code>RUNTIME_COMMAND_TYPES.INPUT_EVENT</code>, <code>InputEventCommandPayload</code>, and wire into <code>RuntimeCommandPayloads</code> + <code>COMMAND_AUTHORIZATIONS</code>.</li>
<li class=""><code>packages/core/src/input-event.ts</code> - define <code>InputEvent</code>, <code>InputEventModifiers</code>, and related literals used by both IPC and runtime payloads.</li>
<li class=""><code>packages/core/src/index.browser.ts</code> - export the new input-event types and payload type for consumers.</li>
<li class=""><code>packages/core/src/input-event.test.ts</code> - add focused unit tests covering basic shape/serialization expectations (no IPC), if needed.</li>
</ul>
</li>
<li class="">Acceptance Criteria:<!-- -->
<ol>
<li class=""><code>@idle-engine/core</code> exports <code>RUNTIME_COMMAND_TYPES.INPUT_EVENT</code>.</li>
<li class=""><code>RuntimeCommandPayloads[&#x27;INPUT_EVENT&#x27;]</code> is strongly typed as <code>{ schemaVersion: 1; event: InputEvent }</code>.</li>
<li class=""><code>COMMAND_AUTHORIZATIONS[RUNTIME_COMMAND_TYPES.INPUT_EVENT].allowedPriorities</code> is exactly <code>[CommandPriority.PLAYER]</code> (and <code>unauthorizedEvent === &#x27;UnauthorizedInputEventCommand&#x27;</code>).</li>
<li class=""><code>pnpm --filter @idle-engine/core typecheck</code> passes.</li>
<li class=""><code>pnpm --filter @idle-engine/core test</code> passes.</li>
</ol>
</li>
<li class="">Dependencies: None</li>
<li class="">Verification: <code>pnpm --filter @idle-engine/core test</code></li>
</ul>
<p><strong>T2: Add IPC channel + API</strong></p>
<ul>
<li class="">Summary: Add the new IPC channel constant and a typed renderer→main send surface for input events.</li>
<li class="">Files:<!-- -->
<ul>
<li class=""><code>packages/shell-desktop/src/ipc.ts</code> - add <code>IPC_CHANNELS.inputEvent</code> and define <code>ShellInputEventEnvelope</code> (schemaVersion <code>1</code>) referencing <code>InputEvent</code> from <code>@idle-engine/core</code>; add <code>IdleEngineApi.sendInputEvent</code>.</li>
<li class=""><code>packages/shell-desktop/src/ipc.test.ts</code> - assert the new stable identifier (<code>idle-engine:input-event</code>).</li>
<li class=""><code>packages/shell-desktop/src/preload.cts</code> - expose <code>sendInputEvent</code> and route it via <code>ipcRenderer.send(IPC_CHANNELS.inputEvent, envelope)</code>.</li>
<li class=""><code>packages/shell-desktop/src/preload.test.ts</code> - verify <code>sendInputEvent</code> exists and forwards to <code>ipcRenderer.send</code>.</li>
</ul>
</li>
<li class="">Acceptance Criteria:<!-- -->
<ol>
<li class=""><code>IPC_CHANNELS.inputEvent === &#x27;idle-engine:input-event&#x27;</code>.</li>
<li class="">Preload exposes <code>idleEngine.sendInputEvent(...)</code> and it calls <code>ipcRenderer.send</code> on the correct channel.</li>
<li class=""><code>pnpm --filter @idle-engine/shell-desktop test -- src/ipc.test.ts</code> passes.</li>
<li class=""><code>pnpm --filter @idle-engine/shell-desktop test -- src/preload.test.ts</code> passes.</li>
</ol>
</li>
<li class="">Dependencies: T1</li>
<li class="">Verification: <code>pnpm --filter @idle-engine/shell-desktop test -- src/preload.test.ts</code></li>
</ul>
<p><strong>T3: Send typed input events</strong></p>
<ul>
<li class="">Summary: Replace pointer/wheel “passthrough metadata” forwarding with explicit typed input events.</li>
<li class="">Files:<!-- -->
<ul>
<li class=""><code>packages/shell-desktop/src/renderer/index.ts</code> - build and send <code>ShellInputEventEnvelope</code> for <code>mouse-down</code>, <code>mouse-up</code>, <code>mouse-move</code>, and <code>mouse-wheel</code>; keep pointer-move RAF coalescing.</li>
<li class=""><code>packages/shell-desktop/src/renderer/index.test.ts</code> - update expectations to assert <code>sendInputEvent</code> calls (not <code>sendControlEvent</code> metadata passthrough).</li>
</ul>
</li>
<li class="">Acceptance Criteria:<!-- -->
<ol>
<li class="">Pointer down/up/move events produce <code>ShellInputEventEnvelope</code> with <code>schemaVersion: 1</code> and <code>event.kind: &#x27;pointer&#x27;</code>.</li>
<li class="">Wheel events produce <code>ShellInputEventEnvelope</code> with <code>event.kind: &#x27;wheel&#x27;</code> and finite deltas/deltaMode.</li>
<li class="">Pointer move events are still coalesced to one send per animation frame.</li>
<li class=""><code>pnpm --filter @idle-engine/shell-desktop test -- src/renderer/index.test.ts</code> passes.</li>
</ol>
</li>
<li class="">Dependencies: T2</li>
<li class="">Verification: <code>pnpm --filter @idle-engine/shell-desktop test -- src/renderer/index.test.ts</code></li>
</ul>
<p><strong>T4: Validate + enqueue input events</strong></p>
<ul>
<li class="">Summary: Add a main-process handler for <code>idle-engine:input-event</code> that validates and enqueues typed <code>INPUT_EVENT</code> commands; remove passthrough forwarding + <code>SHELL_CONTROL_EVENT</code> emission.</li>
<li class="">Files:<!-- -->
<ul>
<li class=""><code>packages/shell-desktop/src/main.ts</code> - add IPC receive handler for <code>IPC_CHANNELS.inputEvent</code>; implement synchronous shape validation; enqueue <code>INPUT_EVENT</code> commands on success; delete <code>shouldPassthroughControlEvent</code> and the <code>SHELL_CONTROL_EVENT</code> enqueue path.</li>
<li class=""><code>packages/shell-desktop/src/main.test.ts</code> - update tests to assert <code>INPUT_EVENT</code> is enqueued and <code>SHELL_CONTROL_EVENT</code> is never produced, even if <code>metadata.passthrough</code> is set.</li>
</ul>
</li>
<li class="">Acceptance Criteria:<!-- -->
<ol>
<li class="">Invalid <code>ShellInputEventEnvelope</code> payloads are dropped (no worker messages posted).</li>
<li class="">When sim is not running (<code>sim.stopped</code>/<code>sim.crashed</code>/disposing), input events are ignored.</li>
<li class="">Valid pointer/wheel input events enqueue exactly one <code>INPUT_EVENT</code> command with <code>payload.schemaVersion === 1</code> and the validated event copied into payload.</li>
<li class="">Enqueued <code>INPUT_EVENT</code> commands have <code>priority === CommandPriority.PLAYER</code>, <code>step === nextStep</code> (snapshotted at receive time), <code>timestamp === step * stepSizeMs</code>, and <code>requestId === undefined</code>.</li>
<li class="">No code path enqueues <code>SHELL_CONTROL_EVENT</code> in response to renderer inputs.</li>
<li class=""><code>pnpm --filter @idle-engine/shell-desktop test -- src/main.test.ts</code> passes.</li>
</ol>
</li>
<li class="">Dependencies: T2</li>
<li class="">Verification: <code>pnpm --filter @idle-engine/shell-desktop test -- src/main.test.ts</code></li>
</ul>
<p><strong>T5: Consume <code>INPUT_EVENT</code> for demo UI</strong></p>
<ul>
<li class="">Summary: Migrate demo pointer/UI interaction handling away from legacy passthrough (<code>SHELL_CONTROL_EVENT.payload.event.metadata.*</code>) to <code>INPUT_EVENT.payload.event.*</code> so canvas UI clicks continue to work deterministically. Keep <code>SHELL_CONTROL_EVENT</code> registered as a no-op to support restores of older snapshots without <code>UnknownCommandType</code> errors.</li>
<li class="">Files:<!-- -->
<ul>
<li class=""><code>packages/shell-desktop/src/sim/sim-runtime.ts</code> - register a dispatcher handler for <code>RUNTIME_COMMAND_TYPES.INPUT_EVENT</code> and implement demo hit-testing for pointer <code>mouse-down</code> so clicking the on-canvas UI triggers <code>COLLECT_RESOURCE</code> (same gameplay effect as Space/collect). Hit-test region is the existing UI panel rect: <code>x=16, y=16, width=320, height=72</code> (matches <code>buildFrame</code>).</li>
<li class=""><code>packages/shell-desktop/src/sim/sim-runtime.test.ts</code> - assert <code>INPUT_EVENT</code> is registered and that an in-bounds <code>mouse-down</code> <code>INPUT_EVENT</code> produces the same visible UI effect as <code>COLLECT_RESOURCE</code>; assert <code>SHELL_CONTROL_EVENT</code> remains registered as a no-op for legacy restores.</li>
</ul>
</li>
<li class="">Acceptance Criteria:<!-- -->
<ol>
<li class=""><code>createSimRuntime().hasCommandHandler(RUNTIME_COMMAND_TYPES.INPUT_EVENT) === true</code>.</li>
<li class="">An <code>INPUT_EVENT</code> with <code>kind:&#x27;pointer&#x27;</code>, <code>intent:&#x27;mouse-down&#x27;</code>, and <code>x/y</code> inside the demo UI hit-test region triggers the same next-frame UI change as a <code>COLLECT_RESOURCE</code> command (resource count increases).</li>
<li class="">An <code>INPUT_EVENT</code> outside the hit-test region does not trigger <code>COLLECT_RESOURCE</code>.</li>
<li class="">If an <code>INPUT_EVENT</code> command payload has <code>schemaVersion !== 1</code>, the handler throws (sim worker crashes; fail-fast for incompatible replays/snapshots).</li>
<li class=""><code>createSimRuntime().hasCommandHandler(SHELL_CONTROL_EVENT_COMMAND_TYPE) === true</code> (legacy restore compatibility).</li>
<li class=""><code>pnpm --filter @idle-engine/shell-desktop test -- src/sim/sim-runtime.test.ts</code> passes.</li>
</ol>
</li>
<li class="">Dependencies: T1</li>
<li class="">Verification: <code>pnpm --filter @idle-engine/shell-desktop test -- src/sim/sim-runtime.test.ts</code></li>
</ul>
<p><strong>T6: Integrate + regenerate coverage</strong></p>
<ul>
<li class="">Summary: Ensure the workspace compiles, lints, tests pass, and documentation coverage is regenerated after updating tests.</li>
<li class="">Files:<!-- -->
<ul>
<li class=""><code>docs/coverage/index.md</code> - regenerated via <code>pnpm coverage:md</code> (do not edit manually).</li>
</ul>
</li>
<li class="">Acceptance Criteria:<!-- -->
<ol>
<li class=""><code>pnpm typecheck</code> passes.</li>
<li class=""><code>pnpm lint</code> passes.</li>
<li class=""><code>pnpm test</code> passes.</li>
<li class=""><code>pnpm coverage:md</code> updates <code>docs/coverage/index.md</code> and the file is committed.</li>
</ol>
</li>
<li class="">Dependencies: T3, T4, T5</li>
<li class="">Verification: <code>pnpm coverage:md</code></li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="6-validation">6. Validation<a href="#6-validation" class="hash-link" aria-label="Direct link to 6. Validation" title="Direct link to 6. Validation" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="pre-implementation-checks">Pre-Implementation Checks<a href="#pre-implementation-checks" class="hash-link" aria-label="Direct link to Pre-Implementation Checks" title="Direct link to Pre-Implementation Checks" translate="no">​</a></h3>
<ul class="contains-task-list containsTaskList_LGBQ">
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->All dependencies installed: <code>pnpm install</code></li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Types check: <code>pnpm typecheck</code></li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Existing tests pass: <code>pnpm test</code></li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="post-implementation-checks">Post-Implementation Checks<a href="#post-implementation-checks" class="hash-link" aria-label="Direct link to Post-Implementation Checks" title="Direct link to Post-Implementation Checks" translate="no">​</a></h3>
<ul class="contains-task-list containsTaskList_LGBQ">
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Types check: <code>pnpm typecheck</code></li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Lint passes: <code>pnpm lint</code></li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->All tests pass: <code>pnpm test</code></li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->New/updated test files pass:<!-- -->
<ul>
<li class=""><code>packages/core/src/input-event.test.ts</code></li>
<li class=""><code>packages/shell-desktop/src/ipc.test.ts</code></li>
<li class=""><code>packages/shell-desktop/src/preload.test.ts</code></li>
<li class=""><code>packages/shell-desktop/src/renderer/index.test.ts</code></li>
<li class=""><code>packages/shell-desktop/src/main.test.ts</code></li>
<li class=""><code>packages/shell-desktop/src/sim/sim-runtime.test.ts</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Targeted test runs (while iterating):<!-- -->
<ul>
<li class=""><code>pnpm --filter @idle-engine/core test -- src/input-event.test.ts</code></li>
<li class=""><code>pnpm --filter @idle-engine/shell-desktop test -- src/ipc.test.ts</code></li>
<li class=""><code>pnpm --filter @idle-engine/shell-desktop test -- src/preload.test.ts</code></li>
<li class=""><code>pnpm --filter @idle-engine/shell-desktop test -- src/renderer/index.test.ts</code></li>
<li class=""><code>pnpm --filter @idle-engine/shell-desktop test -- src/main.test.ts</code></li>
<li class=""><code>pnpm --filter @idle-engine/shell-desktop test -- src/sim/sim-runtime.test.ts</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Coverage markdown regenerated: <code>pnpm coverage:md</code></li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="manual-verification-desktop-shell">Manual Verification (desktop shell)<a href="#manual-verification-desktop-shell" class="hash-link" aria-label="Direct link to Manual Verification (desktop shell)" title="Direct link to Manual Verification (desktop shell)" translate="no">​</a></h3>
<ul class="contains-task-list containsTaskList_LGBQ">
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Run <code>pnpm --filter @idle-engine/shell-desktop start</code> and verify:<!-- -->
<ul>
<li class="">Pressing Space triggers the existing “collect” behavior (resource count increases).</li>
<li class="">Clicking the on-canvas UI triggers the same “collect” behavior (resource count increases).</li>
<li class="">Pointer down/move/up and wheel inputs do not crash the app (inputs are accepted or ignored deterministically depending on sim state).</li>
<li class="">Reloading the window restarts the sim controller (input ignored while initializing, then accepted once running).</li>
</ul>
</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_zkN7"><a href="https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/issue-850-design.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_URLU" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_DCA4"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_7BTH thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-scope" class="table-of-contents__link toc-highlight">1. Scope</a><ul><li><a href="#problem" class="table-of-contents__link toc-highlight">Problem</a></li><li><a href="#goals" class="table-of-contents__link toc-highlight">Goals</a></li><li><a href="#pointerui-preservation-concrete-rules" class="table-of-contents__link toc-highlight">Pointer/UI Preservation (Concrete Rules)</a></li><li><a href="#non-goals" class="table-of-contents__link toc-highlight">Non-Goals</a></li><li><a href="#boundaries" class="table-of-contents__link toc-highlight">Boundaries</a></li></ul></li><li><a href="#2-workflow" class="table-of-contents__link toc-highlight">2. Workflow</a><ul><li><a href="#states" class="table-of-contents__link toc-highlight">States</a></li><li><a href="#transitions" class="table-of-contents__link toc-highlight">Transitions</a></li><li><a href="#error-handling" class="table-of-contents__link toc-highlight">Error Handling</a></li><li><a href="#crash-recovery" class="table-of-contents__link toc-highlight">Crash Recovery</a></li><li><a href="#subprocesses-if-applicable" class="table-of-contents__link toc-highlight">Subprocesses (if applicable)</a></li></ul></li><li><a href="#3-interfaces" class="table-of-contents__link toc-highlight">3. Interfaces</a><ul><li><a href="#endpoints" class="table-of-contents__link toc-highlight">Endpoints</a></li><li><a href="#cli-commands-if-applicable" class="table-of-contents__link toc-highlight">CLI Commands (if applicable)</a></li><li><a href="#events-if-applicable" class="table-of-contents__link toc-highlight">Events (if applicable)</a></li><li><a href="#runtime-commands" class="table-of-contents__link toc-highlight">Runtime Commands</a></li><li><a href="#validation-rules" class="table-of-contents__link toc-highlight">Validation Rules</a></li><li><a href="#ui-interactions-if-applicable" class="table-of-contents__link toc-highlight">UI Interactions (if applicable)</a></li></ul></li><li><a href="#4-data" class="table-of-contents__link toc-highlight">4. Data</a><ul><li><a href="#schema-changes" class="table-of-contents__link toc-highlight">Schema Changes</a></li><li><a href="#command-authorization-command_authorizations" class="table-of-contents__link toc-highlight">Command Authorization (<code>COMMAND_AUTHORIZATIONS</code>)</a></li><li><a href="#version-validation-schemaversion" class="table-of-contents__link toc-highlight">Version Validation (<code>schemaVersion</code>)</a></li><li><a href="#field-definitions" class="table-of-contents__link toc-highlight">Field Definitions</a></li><li><a href="#migrations" class="table-of-contents__link toc-highlight">Migrations</a></li><li><a href="#artifacts" class="table-of-contents__link toc-highlight">Artifacts</a></li><li><a href="#artifact-lifecycle" class="table-of-contents__link toc-highlight">Artifact Lifecycle</a></li></ul></li><li><a href="#5-tasks" class="table-of-contents__link toc-highlight">5. Tasks</a><ul><li><a href="#decomposition-gates" class="table-of-contents__link toc-highlight">Decomposition Gates</a></li><li><a href="#ordering-gates" class="table-of-contents__link toc-highlight">Ordering Gates</a></li><li><a href="#infrastructure-gates" class="table-of-contents__link toc-highlight">Infrastructure Gates</a></li><li><a href="#task-dependency-graph" class="table-of-contents__link toc-highlight">Task Dependency Graph</a></li><li><a href="#task-breakdown" class="table-of-contents__link toc-highlight">Task Breakdown</a></li><li><a href="#task-details" class="table-of-contents__link toc-highlight">Task Details</a></li></ul></li><li><a href="#6-validation" class="table-of-contents__link toc-highlight">6. Validation</a><ul><li><a href="#pre-implementation-checks" class="table-of-contents__link toc-highlight">Pre-Implementation Checks</a></li><li><a href="#post-implementation-checks" class="table-of-contents__link toc-highlight">Post-Implementation Checks</a></li><li><a href="#manual-verification-desktop-shell" class="table-of-contents__link toc-highlight">Manual Verification (desktop shell)</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/contributor-handbook">Contributor Handbook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_zgE_"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_zgE_"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Idle Engine.</div></div></div></footer></div>
</body>
</html>