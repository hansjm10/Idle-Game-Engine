<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-content-dsl-schema-design" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Content DSL Schema Design | Idle Engine Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hansjm10.github.io/Idle-Game-Engine/content-dsl-schema-design"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Content DSL Schema Design | Idle Engine Docs"><meta data-rh="true" name="description" content="This design document specifies the canonical Zod schema contract for Idle Engine content packs. The schema guards authoring-time invariants, normalises inputs for the compiler, and aligns with the content expectations outlined in the main engine design."><meta data-rh="true" property="og:description" content="This design document specifies the canonical Zod schema contract for Idle Engine content packs. The schema guards authoring-time invariants, normalises inputs for the compiler, and aligns with the content expectations outlined in the main engine design."><link data-rh="true" rel="icon" href="/Idle-Game-Engine/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hansjm10.github.io/Idle-Game-Engine/content-dsl-schema-design"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/content-dsl-schema-design" hreflang="en"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/content-dsl-schema-design" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Content DSL Schema Design","item":"https://hansjm10.github.io/Idle-Game-Engine/content-dsl-schema-design"}]}</script><link rel="stylesheet" href="/Idle-Game-Engine/assets/css/styles.ddf7989c.css">
<script src="/Idle-Game-Engine/assets/js/runtime~main.41db1294.js" defer="defer"></script>
<script src="/Idle-Game-Engine/assets/js/main.57fd14dd.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Idle-Game-Engine/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_li4T" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Idle-Game-Engine/"><div class="navbar__logo"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--light_vaEm"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--dark_axH8"></div><b class="navbar__title text--truncate">Idle Engine</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Idle-Game-Engine/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle__Exw colorModeToggle_Lslw"><button class="clean-btn toggleButton_AMBK toggleButtonDisabled_p4Bd" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 lightToggleIcon_p2sk"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 darkToggleIcon_B2qX"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 systemToggleIcon_PWgn"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_RKai"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_nqaE"><div class="docsWrapper_CSLE"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sOWX" type="button"></button><div class="docRoot_qxtV"><aside class="theme-doc-sidebar-container docSidebarContainer_Xlvo"><div class="sidebarViewport_tjEA"><div class="sidebar_ubOv"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_CfkH"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/Idle-Game-Engine/"><span title="Getting Started" class="categoryLinkLabel_ebxo">Getting Started</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/"><span title="Overview" class="linkLabel_KsAJ">Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/contributor-handbook"><span title="Contributor Handbook" class="linkLabel_KsAJ">Contributor Handbook</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/role-index"><span title="Role Index" class="linkLabel_KsAJ">Role Index</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/design-document-template"><span title="Design Document Template" class="linkLabel_KsAJ">Design Document Template</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/idle-engine-design"><span title="Core Runtime" class="categoryLinkLabel_ebxo">Core Runtime</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/Idle-Game-Engine/content-dsl-schema-design"><span title="Content Pipeline" class="categoryLinkLabel_ebxo">Content Pipeline</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Idle-Game-Engine/content-dsl-schema-design"><span title="Content DSL Schema Design" class="linkLabel_KsAJ">Content DSL Schema Design</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/content-dsl-usage-guidelines"><span title="Content DSL Usage Guidelines" class="linkLabel_KsAJ">Content DSL Usage Guidelines</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/content-compiler-design"><span title="Content Compiler Design" class="linkLabel_KsAJ">Content Compiler Design</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/content-schema-rollout-decisions"><span title="Content Schema Rollout Decisions" class="linkLabel_KsAJ">Content Schema Rollout Decisions</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/content-validation-cli-design"><span title="Content Validation CLI Design" class="linkLabel_KsAJ">Content Validation CLI Design</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/coverage/"><span title="Diagnostics &amp; Quality" class="categoryLinkLabel_ebxo">Diagnostics &amp; Quality</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/implementation-plan"><span title="Operations &amp; Process" class="categoryLinkLabel_ebxo">Operations &amp; Process</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_tfRv"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_hyci"><div class="docItemContainer_tcAC"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_bxbs" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/Idle-Game-Engine/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_p1A9"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Content Pipeline</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Content DSL Schema Design</span></li></ul></nav><div class="tocCollapsible_WMbj theme-doc-toc-mobile tocMobile_wI3e"><button type="button" class="clean-btn tocCollapsibleButton_rjEa">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Content DSL Schema Design</h1></header>
<p>This design document specifies the canonical Zod schema contract for Idle Engine content packs. The schema guards authoring-time invariants, normalises inputs for the compiler, and aligns with the content expectations outlined in the main engine design.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="document-control">Document Control<a href="#document-control" class="hash-link" aria-label="Direct link to Document Control" title="Direct link to Document Control" translate="no">​</a></h2>
<ul>
<li class=""><strong>Title</strong>: Define canonical Zod schema contract for content DSL</li>
<li class=""><strong>Authors</strong>: Design team</li>
<li class=""><strong>Reviewers</strong>: N/A</li>
<li class=""><strong>Status</strong>: Design</li>
<li class=""><strong>Last Updated</strong>: 2025-10-18</li>
<li class=""><strong>Related Issues</strong>: #11</li>
<li class=""><strong>Execution Mode</strong>: AI-led</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="1-summary">1. Summary<a href="#1-summary" class="hash-link" aria-label="Direct link to 1. Summary" title="Direct link to 1. Summary" translate="no">​</a></h2>
<p>The Idle Engine content DSL bridges designer-authored data and the deterministic runtime. Today, sample packs provide ad-hoc TypeScript interfaces, but the monorepo lacks an enforceable schema. This document specifies the Zod schemas, normalisation rules, and validation flow that future CLI tooling will use before content is compiled into runtime-ready definitions. The goal is to deliver a single package that validates metadata, resources, entities, generators, upgrades, metrics, achievements, prestige layers, automations, transforms, runtime event extensions, and pack dependency metadata while providing strong typing for TypeScript consumers.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="2-context--problem-statement">2. Context &amp; Problem Statement<a href="#2-context--problem-statement" class="hash-link" aria-label="Direct link to 2. Context &amp; Problem Statement" title="Direct link to 2. Context &amp; Problem Statement" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="background">Background<a href="#background" class="hash-link" aria-label="Direct link to Background" title="Direct link to Background" translate="no">​</a></h3>
<ul>
<li class=""><code>packages/content-sample/src/index.ts</code> now re-exports the compiler-generated sample pack (rehydrated content, digest, summary, indices), maintaining the import-time warning guard without reparsing <code>content/pack.json</code>.</li>
<li class="">No shared schema package exists. Content authors must rely on informal conventions captured in <code>docs/idle-engine-design.md</code>.</li>
<li class=""><code>tools/content-schema-cli</code> is a stub focused on runtime event manifests and does not validate content pack data.</li>
<li class="">Tests, lint rules, and CI do not exercise schema validation because the schema is missing.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="problem">Problem<a href="#problem" class="hash-link" aria-label="Direct link to Problem" title="Direct link to Problem" translate="no">​</a></h3>
<p>The monorepo lacks an enforceable schema for content packs. Authors cannot validate their content at authoring time, leading to errors discovered late in the pipeline. There is no canonical source of truth for content structure, and runtime expectations are not aligned with authoring-time validation.</p>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="forces">Forces<a href="#forces" class="hash-link" aria-label="Direct link to Forces" title="Direct link to Forces" translate="no">​</a></h3>
<ul>
<li class="">Must support localisation-ready text, formula-driven values, and unlock conditions without constraining downstream compiler optimisations.</li>
<li class="">Schema evolution must remain explicit through semantic metadata, enabling future packs to opt into new capabilities without breaking prototype-era content.</li>
<li class="">Performance is critical for large content packs during CLI validation.</li>
<li class="">Backward compatibility with existing runtime versions must be maintained.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="3-goals--non-goals">3. Goals &amp; Non-Goals<a href="#3-goals--non-goals" class="hash-link" aria-label="Direct link to 3. Goals &amp; Non-Goals" title="Direct link to 3. Goals &amp; Non-Goals" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="goals">Goals<a href="#goals" class="hash-link" aria-label="Direct link to Goals" title="Direct link to Goals" translate="no">​</a></h3>
<ol>
<li class="">Provide a canonical <code>@idle-engine/content-schema</code> package exporting Zod schemas and inferred TypeScript types for every content DSL module, including metrics, achievements, runtime event definitions, and pack dependency metadata.</li>
<li class="">Normalise author input (trim strings, apply defaults, sort deterministically) so the compiler and runtime receive stable, replayable definitions.</li>
<li class="">Surface referential, balancing, and compatibility errors at authoring time with actionable messages for future CLI integrations.</li>
<li class="">Support localisation-ready text, formula-driven values, and unlock conditions without constraining downstream compiler optimisations.</li>
<li class="">Keep schema evolution explicit through semantic metadata, enabling future packs to opt into new capabilities without breaking prototype-era content.</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="non-goals">Non-Goals<a href="#non-goals" class="hash-link" aria-label="Direct link to Non-Goals" title="Direct link to Non-Goals" translate="no">​</a></h3>
<ul>
<li class="">Implementing the compiler that emits runtime-ready typed arrays, manifests, or worker bundles (tracked in a follow-up issue).</li>
<li class="">Executing or optimising numeric formulas beyond structural validation.</li>
<li class="">Delivering the localisation pipeline, documentation site generation, or in-editor authoring experience.</li>
<li class="">Shipping gameplay logic changes in the runtime; this document only constrains the content contract.</li>
<li class="">Rewriting existing sample data; migrations will land once the schema package exists.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="4-stakeholders-agents--impacted-surfaces">4. Stakeholders, Agents &amp; Impacted Surfaces<a href="#4-stakeholders-agents--impacted-surfaces" class="hash-link" aria-label="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" title="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="primary-stakeholders">Primary Stakeholders<a href="#primary-stakeholders" class="hash-link" aria-label="Direct link to Primary Stakeholders" title="Direct link to Primary Stakeholders" translate="no">​</a></h3>
<ul>
<li class="">Content authors who create game content using the DSL</li>
<li class="">Runtime implementation team</li>
<li class="">CLI tooling maintainers</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="agent-roles">Agent Roles<a href="#agent-roles" class="hash-link" aria-label="Direct link to Agent Roles" title="Direct link to Agent Roles" translate="no">​</a></h3>
<ul>
<li class=""><strong>Schema Implementation Agent</strong>: Implements Zod schemas for all content modules</li>
<li class=""><strong>Validation Agent</strong>: Implements cross-reference validation and normalisation</li>
<li class=""><strong>Testing Agent</strong>: Creates comprehensive test suites for schema validation</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="affected-packagesservices">Affected Packages/Services<a href="#affected-packagesservices" class="hash-link" aria-label="Direct link to Affected Packages/Services" title="Direct link to Affected Packages/Services" translate="no">​</a></h3>
<ul>
<li class=""><code>packages/content-schema</code> (new package)</li>
<li class=""><code>packages/content-sample</code></li>
<li class=""><code>tools/content-schema-cli</code></li>
<li class=""><code>packages/core</code> (runtime validation alignment)</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="compatibility-considerations">Compatibility Considerations<a href="#compatibility-considerations" class="hash-link" aria-label="Direct link to Compatibility Considerations" title="Direct link to Compatibility Considerations" translate="no">​</a></h3>
<ul>
<li class="">Schema must validate content packs targeting different runtime versions</li>
<li class="">Backward compatibility through <code>metadata.engine</code> semver ranges</li>
<li class="">Forward compatibility through feature gates aligned with runtime milestones</li>
<li class="">Entity feature gate is tracked separately in #738</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="5-current-state">5. Current State<a href="#5-current-state" class="hash-link" aria-label="Direct link to 5. Current State" title="Direct link to 5. Current State" translate="no">​</a></h2>
<p>The current state is outlined in section 2 (Context &amp; Problem Statement - Background). Key points:</p>
<ul>
<li class="">Sample packs use ad-hoc TypeScript interfaces</li>
<li class="">No shared schema package exists</li>
<li class="">Content validation is informal and convention-based</li>
<li class="">CLI tooling is incomplete</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="6-proposed-solution">6. Proposed Solution<a href="#6-proposed-solution" class="hash-link" aria-label="Direct link to 6. Proposed Solution" title="Direct link to 6. Proposed Solution" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="61-architecture-overview">6.1 Architecture Overview<a href="#61-architecture-overview" class="hash-link" aria-label="Direct link to 6.1 Architecture Overview" title="Direct link to 6.1 Architecture Overview" translate="no">​</a></h3>
<p><strong>Narrative</strong>: Create a new <code>packages/content-schema</code> package that exports Zod schemas for all content DSL modules. The package provides both structural validation (via base schemas) and semantic validation (via a validator factory that performs cross-reference checking, normalisation, and warning collection). Content flows through: raw input → structural parse → cross-reference validation → normalisation → output with warnings.</p>
<p><strong>Diagram</strong>: N/A</p>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="62-detailed-design">6.2 Detailed Design<a href="#62-detailed-design" class="hash-link" aria-label="Direct link to 6.2 Detailed Design" title="Direct link to 6.2 Detailed Design" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="package-layout--ownership">Package Layout &amp; Ownership<a href="#package-layout--ownership" class="hash-link" aria-label="Direct link to Package Layout &amp; Ownership" title="Direct link to Package Layout &amp; Ownership" translate="no">​</a></h4>
<p>Create <code>packages/content-schema</code> exporting common schema primitives, DSL module schemas, and composite pack schemas. The package remains private until the contract is stabilised.</p>
<p>Structure:</p>
<div class="language-text codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-text codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token plain">packages/content-schema/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  package.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  src/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    index.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    base/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ids.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      localization.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      numbers.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      formulas.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      conditions.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    modules/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      metadata.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      resources.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      entities.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      generators.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      upgrades.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      metrics.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      achievements.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      automations.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      prestige.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      transforms.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    runtime-events.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dependencies.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  runtime-compat.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pack/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    index.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schema.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    normalize.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    validate-cross-references.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    validate-dependencies.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    validate-cycles.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    types.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    utils.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  errors.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vitest.config.ts</span><br></span></code></pre></div></div>
<p><code>index.ts</code> re-exports the base <code>contentPackSchema</code>, the <code>createContentPackValidator</code> factory, a convenience <code>parseContentPack</code> helper that returns <code>{ pack, warnings }</code>, <code>NormalizedContentPack</code>, and other targeted schemas for focused validation.</p>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="shared-scalar-schemas--utilities">Shared Scalar Schemas &amp; Utilities<a href="#shared-scalar-schemas--utilities" class="hash-link" aria-label="Direct link to Shared Scalar Schemas &amp; Utilities" title="Direct link to Shared Scalar Schemas &amp; Utilities" translate="no">​</a></h4>
<p>Define shared primitives with Zod brands for stronger inference:</p>
<ul>
<li class="">
<p><code>contentIdSchema</code>: case-insensitive slug <code>[A-Za-z0-9][A-Za-z0-9-_/.:]{0,63}</code> trimmed and canonicalised to lowercase via <code>.transform</code>, ensuring consistent hashing while still accepting mixed author input. The transform rebrands the result with <code>.pipe(z.string().brand&lt;&#x27;ContentId&#x27;&gt;())</code> so TypeScript keeps the nominal type. The grammar deliberately excludes <code>@</code>, keeping scoped identifiers reserved for pack slugs.</p>
</li>
<li class="">
<p><code>packSlugSchema</code>: accepts both unscoped ids (<code>sample-pack</code>) and npm-style scoped ids (<code>@idle-engine/core</code>), trimming whitespace, collapsing duplicate separators, and canonicalising to lowercase before rebranding the output with <code>PackId</code>. The schema mirrors npm&#x27;s published scope rules—<code>@scope/name</code> with URL-safe characters—so content packs can reference workspace packages such as <code>@idle-engine/core</code> without loosening the general-purpose DSL id grammar.</p>
</li>
<li class="">
<p><code>localeCodeSchema</code>: BCP-47 compliant subset matching language tags used in the UI.</p>
</li>
<li class="">
<p><code>flagIdSchema</code> and <code>scriptIdSchema</code>: trimmed, lowercase slugs that reuse the content id grammar but keep bespoke <code>FlagId</code>/<code>ScriptId</code> brands. Normalisation collapses duplicate separators and canonicalises casing so allowlists and authored packs compare against the same canonical form.</p>
</li>
<li class="">
<p><code>systemAutomationTargetIdSchema</code>: alias for curated system toggle ids (<code>offline-catchup</code>, <code>research-daemon</code>, etc.) that trims, lowercases, and validates the identifier against an enum derived from the runtime.</p>
</li>
<li class="">
<p><code>semverSchema</code> and <code>semverRangeSchema</code>: validated via the <code>semver</code> library (<code>semver@7</code>) inside <code>.superRefine</code>.</p>
</li>
<li class="">
<p><code>hexColorSchema</code>, <code>iconPathSchema</code>, <code>urlSchema</code> for UI metadata.</p>
</li>
<li class="">
<p><code>nonNegativeNumberSchema</code>, <code>percentSchema</code>, <code>positiveIntSchema</code>.</p>
</li>
</ul>
<p><strong>Localised Text Schema</strong>:</p>
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> localizedTextSchema </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">trim</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">256</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    variants</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">record</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localeCodeSchema</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">trim</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">256</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">default</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">structuredClone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">strict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p><code>localizedTextSchema</code> treats the <code>default</code> field as the authoritative copy for the pack&#x27;s default locale. Localised transforms run inside <code>normalizeContentPack</code>, where <code>normalizeLocalizedText(metadata, text, warningSink)</code> backfills a missing <code>variants[metadata.defaultLocale]</code> entry so localisation tools that expect keyed entries remain compatible without forcing authors to duplicate strings. When authors supply a variant that differs from <code>default</code>, the helper records a warning instead of overwriting the authored copy so intentional locale tweaks remain intact.</p>
<p><code>localizedSummarySchema</code> extends the same structure with a relaxed ceiling (<code>max(512)</code>) for synopsis copy so <code>metadata.summary</code> can hold longer blurbs.</p>
<p>All schemas are <code>strict()</code> to reject unknown keys. Optional fields apply defaults through <code>.default</code> or <code>.transform</code>, and scalar schemas use <code>.coerce</code> where CLI or JSON-driven inputs frequently arrive as strings.</p>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="numeric-formula-schema">Numeric Formula Schema<a href="#numeric-formula-schema" class="hash-link" aria-label="Direct link to Numeric Formula Schema" title="Direct link to Numeric Formula Schema" translate="no">​</a></h4>
<p>Provide <code>numericFormulaSchema</code>, a discriminated union that supports both common progression curves and explicit expressions:</p>
<ul>
<li class=""><code>constant</code>: <code>{ kind: &#x27;constant&#x27;; value: number }</code></li>
<li class=""><code>linear</code>: <code>{ kind: &#x27;linear&#x27;; base: number; slope: number }</code></li>
<li class=""><code>exponential</code>: <code>{ kind: &#x27;exponential&#x27;; base?: number; growth: number; offset?: number }</code> (<code>base</code> defaults to <code>1</code>)</li>
<li class=""><code>polynomial</code>: <code>{ kind: &#x27;polynomial&#x27;; coefficients: number[] }</code></li>
<li class=""><code>piecewise</code>: <code>{ kind: &#x27;piecewise&#x27;; pieces: { untilLevel?: number; formula: NumericFormula }[] }</code></li>
<li class=""><code>expression</code>: embeds an AST validated by <code>expressionNodeSchema</code></li>
</ul>
<p>Expression nodes form a recursive Zod schema using <code>z.lazy</code> with node types:</p>
<ul>
<li class=""><code>literal</code>: constant number</li>
<li class=""><code>ref</code>: structured references that avoid stringly typed identifiers. The schema permits either runtime variables <code>{ kind: &#x27;ref&#x27;; target: { type: &#x27;variable&#x27;; name: &#x27;level&#x27; | &#x27;time&#x27; | &#x27;deltaTime&#x27; } }</code> or entity handles <code>{ kind: &#x27;ref&#x27;; target: { type: &#x27;resource&#x27; | &#x27;generator&#x27; | &#x27;upgrade&#x27; | &#x27;automation&#x27; | &#x27;prestigeLayer&#x27;; id: ContentId } }</code></li>
<li class=""><code>binary</code>: <code>op</code> in <code>{ add, sub, mul, div, pow, min, max }</code> with two operands</li>
<li class=""><code>unary</code>: <code>op</code> in <code>{ abs, ceil, floor, round, sqrt, log10, ln }</code></li>
<li class=""><code>call</code>: named function (e.g., <code>clamp</code>, <code>lerp</code>) with <code>args: Expression[]</code></li>
</ul>
<p>Validation enforces finite numbers, non-empty coefficient arrays, and monotonic <code>piecewise</code> sequences. Piecewise nodes must supply strictly increasing <code>untilLevel</code> values and terminate with a catch-all segment (omitting <code>untilLevel</code>) so evaluation order stays deterministic. Structured references keep lookups type-aware—validators dispatch by <code>target.type</code> without having to parse dotted strings—so the compiler can flag missing entities early while still permitting <code>level</code>/<code>time</code> references. Function call nodes are checked against a deterministic allowlist (<code>clamp</code>, <code>lerp</code>, <code>min3</code>, <code>max3</code>, <code>pow10</code>, <code>root</code>, etc.).</p>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="condition-schema">Condition Schema<a href="#condition-schema" class="hash-link" aria-label="Direct link to Condition Schema" title="Direct link to Condition Schema" translate="no">​</a></h4>
<p><code>conditionSchema</code> uses <code>z.discriminatedUnion(&#x27;kind&#x27;, …)</code> so every node spells out the payload required for validation and graph analysis. The following TypeScript shape shows the intended structure:</p>
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">ContentId</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">infer</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> contentIdSchema</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">NumericFormula</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">infer</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> numericFormulaSchema</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">FlagId</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">infer</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> flagIdSchema</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">ScriptId</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">infer</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> scriptIdSchema</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">Condition</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;always&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;never&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;resourceThreshold&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      resourceId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      comparator</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;gte&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;gt&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;lte&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;lt&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      amount</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> NumericFormula</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;generatorLevel&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      generatorId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      comparator</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;gte&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;gt&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;lte&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;lt&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      level</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> NumericFormula</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;upgradeOwned&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      upgradeId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      requiredPurchases</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// defaults to 1 during normalisation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;prestigeCountThreshold&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      prestigeLayerId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      comparator</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;gte&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;gt&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;lte&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;lt&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// defaults to &#x27;gte&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      count</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// positive int, defaults to 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;prestigeCompleted&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> prestigeLayerId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;prestigeUnlocked&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> prestigeLayerId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;flag&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> flagId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> FlagId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;script&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> scriptId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ScriptId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;allOf&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> conditions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> Condition</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;anyOf&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> conditions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> Condition</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;not&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> condition</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Condition </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>Conditions are <code>strict()</code> objects and reuse <code>numericFormulaSchema</code> wherever a numeric comparison is required. Cross-reference checks use the explicit <code>resourceId</code>, <code>generatorId</code>, <code>upgradeId</code>, and <code>prestigeLayerId</code> fields when validating existence and building dependency graphs.</p>
<p>Aggregation nodes (<code>allOf</code>, <code>anyOf</code>) require at least one nested condition via <code>.min(1)</code>. Cycle detection only introduces edges for monotonic predicates that participate in <code>allOf</code> and other positive contexts. Negated predicates (<code>not</code>) and disjunction branches (<code>anyOf</code>) still undergo existence checks, but they do not register graph edges.</p>
<p><code>resourceThreshold</code> is permitted to reference the current resource in its own unlock condition (to model &quot;unlock after first production&quot;); this self-edge does not register as a cycle dependency.</p>
<h5 class="anchor anchorTargetStickyNavbar_EdDC" id="condition-evaluation-semantics-runtime-behavior">Condition Evaluation Semantics (Runtime Behavior)<a href="#condition-evaluation-semantics-runtime-behavior" class="hash-link" aria-label="Direct link to Condition Evaluation Semantics (Runtime Behavior)" title="Direct link to Condition Evaluation Semantics (Runtime Behavior)" translate="no">​</a></h5>
<p>This subsection documents the <strong>existing runtime implementation</strong> of condition evaluation in <code>packages/core/src/condition-evaluator.ts</code>.</p>
<p><strong>Evaluation Context</strong>:</p>
<p>Conditions are evaluated against live game state via a <code>ConditionContext</code> interface that provides:</p>
<ul>
<li class=""><code>getResourceAmount(resourceId: string): number</code></li>
<li class=""><code>getGeneratorLevel(generatorId: string): number</code></li>
<li class=""><code>getUpgradePurchases(upgradeId: string): number</code></li>
<li class=""><code>hasPrestigeLayerUnlocked?(prestigeLayerId: string): boolean</code></li>
<li class=""><code>isFlagSet?(flagId: string): boolean</code></li>
<li class=""><code>evaluateScriptCondition?(scriptId: string): boolean</code></li>
<li class=""><code>onError?: (error: Error) =&gt; void</code></li>
</ul>
<p><strong>Static Threshold Evaluation</strong>:</p>
<p>Unlock conditions use <strong>static thresholds</strong> that do not scale with progression. All numeric formulas in unlock conditions are evaluated with <code>level: 0</code>. This differs from <strong>dynamic cost curves</strong> which evaluate with <code>level: purchaseIndex</code> to scale costs as players buy more units.</p>
<p><strong>Evaluation Rules by Condition Type</strong>:</p>
<ul>
<li class=""><strong><code>always</code></strong>: Returns <code>true</code> immediately</li>
<li class=""><strong><code>never</code></strong>: Returns <code>false</code></li>
<li class=""><strong><code>resourceThreshold</code></strong>: Retrieves current resource amount, evaluates <code>amount</code> formula with <code>level: 0</code>, compares using specified comparator</li>
<li class=""><strong><code>generatorLevel</code></strong>: Retrieves generator owned count, evaluates <code>level</code> formula with <code>level: 0</code>, compares using specified comparator</li>
<li class=""><strong><code>upgradeOwned</code></strong>: Checks if upgrade purchases ≥ <code>requiredPurchases</code> (defaults to 1)</li>
<li class=""><strong><code>prestigeUnlocked</code></strong>: Uses <code>context.hasPrestigeLayerUnlocked(prestigeLayerId)</code> - checks if prestige layer is currently available/unlocked</li>
<li class=""><strong><code>prestigeCompleted</code></strong>: Shorthand for &quot;has prestiged at least once&quot; - reads the prestige counter resource using convention <code>{prestigeLayerId}-prestige-count</code> and checks it is ≥ 1</li>
<li class=""><strong><code>prestigeCountThreshold</code></strong>: Reads prestige counter resource, compares against <code>count</code> using <code>comparator</code></li>
<li class=""><strong><code>flag</code></strong>: Uses <code>context.isFlagSet(flagId)</code> when supplied</li>
<li class=""><strong><code>script</code></strong>: Uses <code>context.evaluateScriptCondition(scriptId)</code> when supplied</li>
<li class=""><strong><code>allOf</code></strong>: Returns <code>true</code> only if every condition passes (logical AND), short-circuits on first failure</li>
<li class=""><strong><code>anyOf</code></strong>: Returns <code>true</code> if any condition passes (logical OR), short-circuits on first success</li>
<li class=""><strong><code>not</code></strong>: Inverts the nested condition result</li>
</ul>
<p><strong>Error Handling</strong>:</p>
<p>Unknown condition kinds or comparators trigger fail-safe behavior:</p>
<ul>
<li class=""><strong>Development</strong>: Calls <code>context.onError(error)</code> for test assertions</li>
<li class=""><strong>Production</strong>: Logs <code>console.warn(error.message)</code> and returns <code>false</code></li>
<li class=""><strong>Rationale</strong>: Graceful degradation prevents crashes when content contains unrecognized condition types</li>
</ul>
<p><strong>Persistent Unlock Semantics</strong>:</p>
<p>When conditions are used for <code>baseUnlock</code> on generators, the progression coordinator implements <strong>persistent unlock</strong> behavior. Once a generator&#x27;s <code>baseUnlock</code> condition evaluates to <code>true</code>, the <code>isUnlocked</code> flag never reverts to <code>false</code>, even if the condition later fails. This ensures generators remain available after being discovered.</p>
<p>In contrast, <code>visibilityCondition</code> is re-evaluated every game step and can toggle between <code>true</code> and <code>false</code>.</p>
<p>When <code>visibilityCondition</code> is omitted, the runtime treats visibility as following
unlock by default: generators and upgrades stay hidden until unlocked, and
resources that start hidden become visible once unlocked.</p>
<p><strong>Human-Readable Descriptions</strong>:</p>
<p>The runtime generates unlock hints for locked content using <code>describeCondition()</code>:</p>
<ul>
<li class=""><code>resourceThreshold</code> → &quot;Requires energy &gt;= 100&quot;</li>
<li class=""><code>generatorLevel</code> → &quot;Requires reactor &gt;= 5&quot;</li>
<li class=""><code>upgradeOwned</code> → &quot;Requires owning 3× efficiency&quot;</li>
<li class=""><code>allOf</code> → &quot;Requires energy &gt;= 100, Requires reactor &gt;= 5&quot;</li>
<li class=""><code>anyOf</code> → &quot;Requires any of: energy &gt;= 100 or reactor &gt;= 5&quot;</li>
<li class=""><code>not</code> → &quot;Not (Requires energy &gt;= 100)&quot;</li>
<li class=""><code>always</code> → <code>undefined</code></li>
<li class=""><code>never</code> → &quot;Unavailable in this build&quot;</li>
</ul>
<p><strong>Implementation Reference</strong>:</p>
<ul>
<li class="">Condition evaluator: <code>packages/core/src/condition-evaluator.ts</code></li>
<li class="">Condition evaluation tests: <code>packages/core/src/condition-evaluator.test.ts</code></li>
<li class="">Progression coordinator integration: <code>packages/core/src/progression-coordinator.ts</code></li>
</ul>
<p><strong>Content Authoring Guidelines</strong>:</p>
<ol>
<li class="">Use <code>always</code> for unconditionally unlocked content</li>
<li class="">Avoid circular dependencies</li>
<li class="">Prefer simple thresholds over complex <code>allOf</code> nesting</li>
<li class="">Test negative conditions carefully (<code>not</code> and <code>anyOf</code> introduce non-monotonic logic)</li>
<li class="">Remember that <code>baseUnlock</code> is persistent—don&#x27;t use it for temporary gates</li>
<li class="">Use <code>visibilityCondition</code> for temporary gates</li>
</ol>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="module-schemas">Module Schemas<a href="#module-schemas" class="hash-link" aria-label="Direct link to Module Schemas" title="Direct link to Module Schemas" translate="no">​</a></h4>
<p><strong>Metadata Schema</strong>:</p>
<p><code>metadataSchema</code> covers content-level metadata:</p>
<ul>
<li class=""><code>id</code>: pack slug (<code>packSlugSchema</code>)</li>
<li class=""><code>title</code>: <code>localizedTextSchema</code></li>
<li class=""><code>summary</code>: optional <code>localizedSummarySchema</code> with longer copy (≤512 chars)</li>
<li class=""><code>version</code>: semantic version string validated by <code>semver</code></li>
<li class=""><code>engine</code>: semver range describing supported runtime versions</li>
<li class=""><code>authors</code>: array of trimmed strings (≤64 chars) with de-duplication</li>
<li class=""><code>defaultLocale</code>: <code>localeCodeSchema</code> that maps to the <code>title.default</code> property</li>
<li class=""><code>supportedLocales</code>: non-empty array of <code>localeCodeSchema</code> entries representing every locale shipped with the pack</li>
<li class=""><code>tags</code>: array of slugs (≤24 chars) reserved for tooling filters</li>
<li class=""><code>links</code>: optional array of URL metadata <code>{ kind, label, href }</code></li>
<li class=""><code>createdAt</code> / <code>updatedAt</code>: ISO-8601 timestamps (optional)</li>
<li class=""><code>visibility</code>: optional enum <code>public | private | experimental</code></li>
<li class=""><code>offlineProgression</code>: optional offline fast path metadata <code>{ mode, preconditions }</code> (preconditions: <code>constantRates</code>, <code>noUnlocks</code>, <code>noAchievements</code>, <code>noAutomation</code>, <code>modeledResourceBounds</code>)</li>
<li class=""><code>dependencies</code>: optional object shaped by <code>packDependencySchema</code> with <code>requires</code>, <code>optional</code>, <code>conflicts</code>, and <code>provides</code> arrays</li>
</ul>
<p>The schema normalises whitespace, enforces canonical casing, validates offline progression metadata, and ensures <code>engine</code> ranges include the active runtime version when known and that <code>supportedLocales</code> contains <code>defaultLocale</code>.</p>
<p>When authors pass <code>ContentSchemaOptions.runtimeVersion</code>, <code>validateCrossReferences</code> performs two compatibility checks:</p>
<ol>
<li class=""><code>semver.satisfies(runtimeVersion, metadata.engine)</code> must be true</li>
<li class="">The validator consults the <code>FEATURE_GATES</code> map in <code>runtime-compat.ts</code> to ensure non-prototype modules match their minimum runtime versions</li>
</ol>
<p><strong>Resource Schema</strong>:</p>
<p><code>resourceDefinitionSchema</code> extends the runtime-facing definition with content metadata:</p>
<ul>
<li class=""><code>id</code>: <code>contentIdSchema</code></li>
<li class=""><code>name</code>: <code>localizedTextSchema</code></li>
<li class=""><code>category</code>: enum (<code>primary</code>, <code>prestige</code>, <code>automation</code>, <code>currency</code>, <code>misc</code>)</li>
<li class=""><code>economyClassification</code>: enum (<code>hard</code>, <code>soft</code>) - defaults to <code>soft</code></li>
<li class=""><code>tier</code>: positive integer for UI grouping</li>
<li class=""><code>icon</code>: optional icon path (SVG/PNG) resolved at build time</li>
<li class=""><code>startAmount</code>: non-negative number (defaults to <code>0</code>)</li>
<li class=""><code>capacity</code>: nullable number; <code>null</code> maps to infinity at runtime</li>
<li class=""><code>visible</code>: boolean default <code>true</code></li>
<li class=""><code>unlocked</code>: boolean default <code>false</code></li>
<li class=""><code>dirtyTolerance</code>: optional override (validated against runtime ceilings)</li>
<li class=""><code>order</code>: optional float for deterministic sort</li>
<li class=""><code>unlockCondition</code> / <code>visibilityCondition</code>: <code>conditionSchema</code> nodes</li>
<li class=""><code>prestige</code>: optional block describing prestige currency linkage <code>{ layerId, resetRetention?: NumericFormula }</code></li>
<li class=""><code>tags</code>: array of slugs for analytics or UI filters</li>
</ul>
<p><code>.superRefine</code> performs per-definition checks including <code>startAmount ≤ capacity</code> when capacity is finite.</p>
<p><strong>Entity Schema</strong>:</p>
<p><code>entityDefinitionSchema</code> captures units, heroes, or NPCs with stats and progression:</p>
<ul>
<li class=""><code>id</code>: <code>contentIdSchema</code></li>
<li class=""><code>name</code>: <code>localizedTextSchema</code></li>
<li class=""><code>description</code>: <code>localizedSummarySchema</code></li>
<li class=""><code>stats</code>: non-empty array of <code>{ id, name, baseValue, minValue?, maxValue? }</code> using <code>numericFormulaSchema</code></li>
<li class=""><code>maxCount</code>: optional <code>NumericFormula</code></li>
<li class=""><code>startCount</code>: non-negative integer defaulting to <code>0</code></li>
<li class=""><code>trackInstances</code>: boolean default <code>false</code></li>
<li class=""><code>progression</code>: optional block <code>{ experienceResource?, levelFormula, maxLevel?, statGrowth }</code></li>
<li class=""><code>unlockCondition</code> / <code>visibilityCondition</code>: <code>conditionSchema</code></li>
<li class=""><code>unlocked</code>: boolean default <code>false</code></li>
<li class=""><code>visible</code>: boolean default <code>true</code></li>
<li class=""><code>tags</code>: array of slugs</li>
<li class=""><code>order</code>: optional float for deterministic ordering</li>
</ul>
<p>The schema enforces unique stat ids and rejects <code>statGrowth</code> keys that do not match declared stats. Tags are lowercased, de-duplicated, and sorted; entities are ordered by <code>order</code> then <code>id</code>.</p>
<p><strong>Generator Schema</strong>:</p>
<p><code>generatorDefinitionSchema</code> models production structures:</p>
<ul>
<li class=""><code>id</code>, <code>name</code>, <code>icon</code>, <code>tags</code> similar to resources</li>
<li class=""><code>produces</code>: array of <code>{ resourceId, rate: NumericFormula }</code></li>
<li class=""><code>consumes</code>: optional array of <code>{ resourceId, rate: NumericFormula }</code></li>
<li class=""><code>purchase</code>: strict object describing purchase costs (supports both single-currency and multi-resource forms)</li>
<li class=""><code>initialLevel</code>: optional non-negative integer defaulting to <code>0</code>, applied as the starting owned count when initializing a new game state</li>
<li class=""><code>maxLevel</code>: optional positive integer</li>
<li class=""><code>order</code>: optional float controlling list ordering</li>
<li class=""><code>baseUnlock</code>: <code>conditionSchema</code> gating initial availability</li>
<li class=""><code>visibilityCondition</code>: <code>conditionSchema</code> for UI reveal</li>
<li class=""><code>automation</code>: optional reference <code>{ automationId }</code> linking to automation definitions</li>
<li class=""><code>effects</code>: optional array for generator-specific effects</li>
</ul>
<p>Cross-validation ensures referenced resources exist, consumption and production rates are finite, and <code>maxBulk</code> respects <code>maxLevel</code>.</p>
<p><strong>Upgrade Schema</strong>:</p>
<p><code>upgradeDefinitionSchema</code> captures upgrade catalog entries:</p>
<ul>
<li class=""><code>id</code>, <code>name</code>, <code>icon</code>, <code>tags</code></li>
<li class=""><code>category</code>: enum (<code>global</code>, <code>resource</code>, <code>generator</code>, <code>automation</code>, <code>prestige</code>)</li>
<li class=""><code>targets</code>: array of typed handles</li>
<li class=""><code>cost</code>: same schema as generator <code>purchase</code></li>
<li class=""><code>repeatable</code>: optional block describing stacking rules</li>
<li class=""><code>prerequisites</code>: array of <code>conditionSchema</code> or upgrade ids</li>
<li class=""><code>order</code>: optional float</li>
<li class=""><code>effects</code>: array of discriminated union entries (modifyResourceRate, modifyResourceCapacity, modifyGeneratorRate, modifyGeneratorCost, modifyGeneratorConsumption, grantAutomation, grantFlag, unlockResource, unlockGenerator, alterDirtyTolerance, emitEvent)</li>
<li class=""><code>unlockCondition</code> / <code>visibilityCondition</code></li>
</ul>
<p>Runtime semantics for repeatable upgrades are documented in detail in the source document.</p>
<p><strong>Metric Schema</strong>:</p>
<p><code>metricDefinitionSchema</code> describes pack-authored telemetry counters:</p>
<ul>
<li class=""><code>id</code>: <code>contentIdSchema</code> canonical slug</li>
<li class=""><code>name</code>: <code>localizedTextSchema</code></li>
<li class=""><code>description</code>: optional <code>localizedSummarySchema</code></li>
<li class=""><code>kind</code>: enum (<code>counter</code>, <code>gauge</code>, <code>histogram</code>, <code>upDownCounter</code>) mapping onto OpenTelemetry instrument semantics</li>
<li class=""><code>unit</code>: optional string validated against a trimmed ASCII grammar</li>
<li class=""><code>aggregation</code>: optional enum (<code>sum</code>, <code>delta</code>, <code>cumulative</code>, <code>distribution</code>)</li>
<li class=""><code>attributes</code>: optional array of attribute keys</li>
<li class=""><code>source</code>: enum describing how the pack emits the metric (<code>runtime</code>, <code>script</code>, <code>content</code>)</li>
<li class=""><code>order</code>: optional float</li>
</ul>
<p>Validation rejects duplicate metric ids and surfaces warnings when attribute key counts exceed three.</p>
<p><strong>Achievement Schema</strong>:</p>
<p><code>achievementDefinitionSchema</code> models milestone tracking:</p>
<ul>
<li class=""><code>id</code>: <code>contentIdSchema</code></li>
<li class=""><code>name</code>: <code>localizedTextSchema</code></li>
<li class=""><code>description</code>: <code>localizedSummarySchema</code></li>
<li class=""><code>category</code>: enum (<code>progression</code>, <code>prestige</code>, <code>automation</code>, <code>collection</code>)</li>
<li class=""><code>tier</code>: enum (<code>bronze</code>, <code>silver</code>, <code>gold</code>, <code>platinum</code>)</li>
<li class=""><code>icon</code>: optional icon path</li>
<li class=""><code>tags</code>: array for analytics or in-game filters</li>
<li class=""><code>track</code>: discriminated union describing progress measurement (resource, generatorLevel, upgradeOwned, flag, script, customMetric)</li>
<li class=""><code>progress</code>: object describing accumulation semantics with <code>target</code>, <code>mode</code>, and optional <code>repeatable</code> block</li>
<li class=""><code>reward</code>: optional union (grantResource, grantUpgrade, emitEvent, unlockAutomation, grantFlag)</li>
<li class=""><code>unlockCondition</code> / <code>visibilityCondition</code></li>
<li class=""><code>onUnlockEvents</code>: optional array of runtime event ids</li>
<li class=""><code>displayOrder</code>: optional float</li>
</ul>
<p>Cross-validation ensures <code>progress.target</code> evaluates to a positive, finite number and referenced ids exist.</p>
<p><strong>Automation Schema</strong>:</p>
<p><code>automationDefinitionSchema</code> describes automation toggles:</p>
<ul>
<li class=""><code>id</code>: <code>contentIdSchema</code></li>
<li class=""><code>name</code>: <code>localizedTextSchema</code></li>
<li class=""><code>description</code>: <code>localizedTextSchema</code></li>
<li class=""><code>targetType</code>: enum (<code>generator</code>, <code>upgrade</code>, <code>purchaseGenerator</code>, <code>collectResource</code>, <code>system</code>)</li>
<li class=""><code>targetId</code>: required when <code>targetType</code> is specific entity types</li>
<li class=""><code>systemTargetId</code>: required when <code>targetType === &#x27;system&#x27;</code></li>
<li class=""><code>trigger</code>: union of deterministic triggers (<code>interval</code>, <code>resourceThreshold</code>, <code>commandQueueEmpty</code>, <code>event</code>)</li>
<li class=""><code>cooldown</code>: optional <code>NumericFormula</code> (ms; numeric shorthand allowed)</li>
<li class=""><code>resourceCost</code>: optional upkeep cost schema</li>
<li class=""><code>unlockCondition</code>: <code>conditionSchema</code></li>
<li class=""><code>visibilityCondition</code>: optional <code>conditionSchema</code></li>
<li class=""><code>enabledByDefault</code>: boolean default <code>false</code></li>
<li class=""><code>order</code>: optional float</li>
</ul>
<p>System targets validate against a curated allowlist. Event-triggered automations are cross-checked against the merged runtime event catalogue.</p>
<p><strong>Transform Schema</strong>:</p>
<p><code>transformDefinitionSchema</code> captures deterministic conversions:</p>
<ul>
<li class=""><code>id</code>: <code>contentIdSchema</code></li>
<li class=""><code>name</code>: <code>localizedTextSchema</code></li>
<li class=""><code>description</code>: <code>localizedSummarySchema</code></li>
<li class=""><code>mode</code>: enum (<code>instant</code>, <code>continuous</code>, <code>batch</code>)</li>
<li class=""><code>inputs</code>: non-empty array of <code>{ resourceId: ContentId; amount: NumericFormula }</code></li>
<li class=""><code>outputs</code>: non-empty array of <code>{ resourceId: ContentId; amount: NumericFormula }</code></li>
<li class=""><code>duration</code>: optional <code>NumericFormula</code> (ms) for timed conversions</li>
<li class=""><code>cooldown</code>: optional <code>NumericFormula</code> (ms; numeric shorthand allowed)</li>
<li class=""><code>trigger</code>: discriminated union (manual, automation, condition, event)</li>
<li class=""><code>unlockCondition</code> / <code>visibilityCondition</code></li>
<li class=""><code>automation</code>: optional <code>{ automationId: ContentId }</code></li>
<li class=""><code>tags</code>: array for analytics/UX filters</li>
<li class=""><code>safety</code>: optional guard specifying <code>maxRunsPerTick</code> and <code>maxOutstandingBatches</code></li>
<li class=""><code>order</code>: optional float</li>
</ul>
<p>Validation confirms every transform references declared resources, batch modes declare a finite <code>duration</code>, and continuous transforms specify at least one consumption or production rate.</p>
<p><strong>Prestige Layer Schema</strong>:</p>
<p><code>prestigeLayerSchema</code> supports reset mechanics:</p>
<ul>
<li class=""><code>id</code>, <code>name</code>, <code>icon</code></li>
<li class=""><code>summary</code>: <code>localizedTextSchema</code></li>
<li class=""><code>resetTargets</code>: array of resource ids reset when the layer triggers</li>
<li class=""><code>resetGenerators</code>: optional array of generator ids</li>
<li class=""><code>resetUpgrades</code>: optional array of upgrade ids</li>
<li class=""><code>unlockCondition</code>: <code>conditionSchema</code></li>
<li class=""><code>reward</code>: block specifying output currency</li>
<li class=""><code>retention</code>: optional array describing retained resources/generators/upgrades</li>
<li class=""><code>automation</code>: optional reference enabling auto-prestige triggers</li>
<li class=""><code>order</code>: optional float</li>
</ul>
<p>Validation enforces that prestige rewards reference prestige-class resources and that reset targets cover at least one non-prestige resource.</p>
<p><strong>Runtime Event Contribution Schema</strong>:</p>
<p>Content packs augment the runtime event catalogue. The schema ensures authored entries align with the manifest generator:</p>
<ul>
<li class=""><code>id</code>: <code>contentIdSchema</code>, derived from canonical runtime event type <code>namespace:name</code></li>
<li class=""><code>namespace</code>: trimmed slug (≤32 chars)</li>
<li class=""><code>name</code>: trimmed string (≤48 chars)</li>
<li class=""><code>version</code>: positive integer</li>
<li class=""><code>payload</code>: discriminated union (zod or jsonSchema)</li>
<li class=""><code>emits</code>: optional array documenting which content entries publish the event</li>
<li class=""><code>tags</code>: optional analytics strings</li>
</ul>
<p>Normalisation always emits the canonical id (<code>namespace:name</code>) even when authors omit the field. Validation ensures schema paths remain pack-relative and <code>emits</code> references existing content ids.</p>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="content-pack-root-schema">Content Pack Root Schema<a href="#content-pack-root-schema" class="hash-link" aria-label="Direct link to Content Pack Root Schema" title="Direct link to Content Pack Root Schema" translate="no">​</a></h4>
<p><code>contentPackSchema</code> composes the module schemas for structural validation and type inference. The exported instance stays stateless.</p>
<p>A validator factory wraps the base schema with cross-reference checks, normalisation, and warning aggregation:</p>
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">ContentId</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">infer</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> contentIdSchema</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">PackId</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">infer</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> packSlugSchema</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">AllowlistEntries</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ReadonlySet</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">AllowlistSpecInput</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> required</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AllowlistEntries</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> soft</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AllowlistEntries</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">NormalizedAllowlistSpec</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> required</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlySet</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> soft</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlySet</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">SchemaWarningSeverity</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;error&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;warning&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;info&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">SchemaWarning</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> code</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> severity</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SchemaWarningSeverity</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> suggestion</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> issues</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZodIssue</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ContentSchemaOptions</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> allowlists</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> flags</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AllowlistSpecInput</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> scripts</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AllowlistSpecInput</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> systemAutomationTargets</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AllowlistSpecInput</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> runtimeVersion</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> knownPacks</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> PackId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> version</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> requires</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> packId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> PackId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> version</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> runtimeEventCatalogue</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AllowlistEntries</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> activePackIds</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AllowlistEntries</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> warningSink</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">warning</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SchemaWarning</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ContentPackValidationResult</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> pack</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> NormalizedContentPack</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> warnings</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> SchemaWarning</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">createContentPackValidator</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentSchemaOptions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">parse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">unknown</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentPackValidationResult</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">safeParse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">unknown</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentPackSafeParseResult</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> parseContentPack </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  input</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">unknown</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentSchemaOptions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentPackValidationResult</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p><code>runtime-compat.ts</code> hosts the feature gate matrix:</p>
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">FEATURE_GATES</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    module</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;automations&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    introducedIn</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;0.2.0&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    docRef</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;docs/idle-engine-design.md (§6.2)&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    module</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;transforms&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    introducedIn</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;0.3.0&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    docRef</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;docs/idle-engine-design.md (§6.2)&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    module</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;runtimeEvents&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    introducedIn</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;0.3.0&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    docRef</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;docs/runtime-event-pubsub-design.md&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    module</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;prestigeLayers&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    introducedIn</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;0.4.0&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    docRef</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;docs/idle-engine-design.md (§6.2)&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p><code>validateCrossReferences</code> performs:</p>
<ul>
<li class="">Id uniqueness within each module</li>
<li class="">Ensuring conditions reference defined ids</li>
<li class="">Verifying generator/upgrade/metric/achievement/automation/transform/entity references resolve against declared content ids</li>
<li class="">Validating entity progression references (<code>experienceResource</code>, stat growth keys, and formula references)</li>
<li class="">Enforcing runtime feature gates</li>
<li class="">Validating <code>metadata.dependencies</code></li>
<li class="">Detecting orphaned prestige currencies</li>
<li class="">Blocking engine-reserved namespace segments</li>
<li class="">Resolving <code>flag</code> and <code>script</code> conditions against allowlists</li>
<li class="">Rejecting runtime event contributions whose canonical id collides with core manifests</li>
<li class="">Confirming <code>achievementDefinition.onUnlockEvents</code> ids exist in the merged catalogue</li>
<li class="">Detecting cyclic dependencies across unlock and visibility conditions</li>
<li class="">Walking every <code>numericFormulaSchema</code> node to collect and validate references</li>
<li class="">Emitting warnings for soft issues</li>
</ul>
<p><code>normalizeContentPack</code> sorts arrays deterministically, injects derived lookup maps, applies default booleans, and produces hashes.</p>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="normalisation--derived-artifacts">Normalisation &amp; Derived Artifacts<a href="#normalisation--derived-artifacts" class="hash-link" aria-label="Direct link to Normalisation &amp; Derived Artifacts" title="Direct link to Normalisation &amp; Derived Artifacts" translate="no">​</a></h4>
<p><code>normalizeContentPack</code> returns a <code>NormalizedContentPack</code>:</p>
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">NormalizedContentPack</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> NormalizedMetadata</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> resources</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedResource</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> entities</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedEntity</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> generators</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedGenerator</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> upgrades</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedUpgrade</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> metrics</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedMetric</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> achievements</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedAchievement</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> automations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedAutomation</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> transforms</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedTransform</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> prestigeLayers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedPrestigeLayer</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> runtimeEvents</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedRuntimeEventContribution</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> lookup</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> resources</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedResource</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> entities</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedEntity</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> generators</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedGenerator</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> upgrades</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedUpgrade</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> metrics</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedMetric</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> achievements</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedAchievement</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> automations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedAutomation</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> transforms</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedTransform</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> prestigeLayers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedPrestigeLayer</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> runtimeEvents</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedRuntimeEventContribution</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> serializedLookup</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> resourceById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedResource</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> entityById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedEntity</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> generatorById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedGenerator</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> upgradeById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedUpgrade</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> metricById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedMetric</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> achievementById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedAchievement</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> automationById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedAutomation</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> transformById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedTransform</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> prestigeLayerById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedPrestigeLayer</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> runtimeEventById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedRuntimeEventContribution</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> digest</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> version</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> hash</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Lookup maps retain the <code>ContentId</code> brand by exposing immutable <code>ReadonlyMap</code> instances. <code>serializedLookup</code> carries downgraded <code>Record&lt;string, …&gt;</code> copies for JSON transport. Digests use FNV-1a hashing aligned with runtime manifest hashing.</p>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="apis--contracts">APIs &amp; Contracts<a href="#apis--contracts" class="hash-link" aria-label="Direct link to APIs &amp; Contracts" title="Direct link to APIs &amp; Contracts" translate="no">​</a></h4>
<p>The package exports:</p>
<ul>
<li class=""><code>contentPackSchema</code>: base Zod schema for structural validation</li>
<li class=""><code>createContentPackValidator(options)</code>: factory that returns <code>{ parse, safeParse }</code> with cross-reference validation</li>
<li class=""><code>parseContentPack(input, options)</code>: convenience helper</li>
<li class="">Individual module schemas: <code>resourceDefinitionSchema</code>, <code>entityDefinitionSchema</code>, <code>metricDefinitionSchema</code>, etc.</li>
<li class="">Type exports: <code>NormalizedContentPack</code>, <code>SchemaWarning</code>, <code>ContentSchemaOptions</code>, etc.</li>
<li class="">Scalar schemas: <code>contentIdSchema</code>, <code>packSlugSchema</code>, <code>numericFormulaSchema</code>, <code>conditionSchema</code>, etc.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="tooling--automation">Tooling &amp; Automation<a href="#tooling--automation" class="hash-link" aria-label="Direct link to Tooling &amp; Automation" title="Direct link to Tooling &amp; Automation" translate="no">​</a></h4>
<p>CLI changes in <code>tools/content-schema-cli</code> (follow-up work):</p>
<ul>
<li class="">Consume <code>@idle-engine/content-schema</code></li>
<li class="">Validate packs and emit structured JSON log entries</li>
<li class="">Support <code>--check</code> mode for CI/Lefthook</li>
<li class="">Support <code>--watch</code> mode for authoring</li>
<li class="">Compile artifacts after successful validation</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="63-operational-considerations">6.3 Operational Considerations<a href="#63-operational-considerations" class="hash-link" aria-label="Direct link to 6.3 Operational Considerations" title="Direct link to 6.3 Operational Considerations" translate="no">​</a></h3>
<p><strong>Deployment</strong>: N/A (library package)</p>
<p><strong>Telemetry &amp; Observability</strong>: CLI tooling will emit structured warnings and errors. Schema validation performance should be monitored for large packs.</p>
<p><strong>Security &amp; Compliance</strong>: Schema paths are validated to prevent directory traversal. No PII handling concerns.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="7-work-breakdown--delivery-plan">7. Work Breakdown &amp; Delivery Plan<a href="#7-work-breakdown--delivery-plan" class="hash-link" aria-label="Direct link to 7. Work Breakdown &amp; Delivery Plan" title="Direct link to 7. Work Breakdown &amp; Delivery Plan" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="71-issue-map">7.1 Issue Map<a href="#71-issue-map" class="hash-link" aria-label="Direct link to 7.1 Issue Map" title="Direct link to 7.1 Issue Map" translate="no">​</a></h3>
<table><thead><tr><th>Issue Title</th><th>Scope Summary</th><th>Proposed Assignee/Agent</th><th>Dependencies</th><th>Acceptance Criteria</th></tr></thead><tbody><tr><td>Scaffold content-schema package</td><td>Create package structure, tsconfig, vitest config</td><td>Schema Implementation Agent</td><td>None</td><td>Package builds and tests run</td></tr><tr><td>Implement scalar schemas</td><td>ids, numbers, localization primitives</td><td>Schema Implementation Agent</td><td>Package scaffold</td><td>Unit tests pass, types exported</td></tr><tr><td>Implement formula &amp; condition schemas</td><td>Recursive schemas with z.lazy</td><td>Schema Implementation Agent</td><td>Scalar schemas</td><td>Tests cover recursion, edge cases</td></tr><tr><td>Implement module schemas</td><td>All DSL modules (resources, generators, etc.)</td><td>Schema Implementation Agent</td><td>Formula &amp; condition schemas</td><td>Each module has passing tests</td></tr><tr><td>Implement runtime event schema</td><td>Runtime event contribution schema</td><td>Schema Implementation Agent</td><td>Module schemas</td><td>Event validation tests pass</td></tr><tr><td>Implement pack root schema &amp; validator factory</td><td>contentPackSchema, createContentPackValidator</td><td>Validation Agent</td><td>All module schemas</td><td>Validator factory works</td></tr><tr><td>Implement cross-reference validation</td><td>validateCrossReferences with cycle detection</td><td>Validation Agent</td><td>Pack root schema</td><td>Cycle detection tests pass</td></tr><tr><td>Implement normalisation</td><td>normalizeContentPack with lookup maps</td><td>Validation Agent</td><td>Cross-reference validation</td><td>Digest stability tests pass</td></tr><tr><td>Update CLI tooling</td><td>Integrate schema into content-schema-cli</td><td>CLI Agent</td><td>Schema package complete</td><td>CLI validates sample packs</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="72-milestones">7.2 Milestones<a href="#72-milestones" class="hash-link" aria-label="Direct link to 7.2 Milestones" title="Direct link to 7.2 Milestones" translate="no">​</a></h3>
<p><strong>Phase 1</strong>: Schema implementation (base schemas → module schemas → pack schema)
<strong>Phase 2</strong>: Validation &amp; normalisation (cross-reference checks → normalisation → digests)
<strong>Phase 3</strong>: Integration (CLI tooling → sample pack migration)</p>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="73-coordination-notes">7.3 Coordination Notes<a href="#73-coordination-notes" class="hash-link" aria-label="Direct link to 7.3 Coordination Notes" title="Direct link to 7.3 Coordination Notes" translate="no">​</a></h3>
<p><strong>Hand-off Package</strong>: Share schema package documentation with CLI maintainers, provide sample validation code</p>
<p><strong>Communication Cadence</strong>: Weekly sync on schema evolution, ad-hoc reviews for breaking changes</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="8-agent-guidance--guardrails">8. Agent Guidance &amp; Guardrails<a href="#8-agent-guidance--guardrails" class="hash-link" aria-label="Direct link to 8. Agent Guidance &amp; Guardrails" title="Direct link to 8. Agent Guidance &amp; Guardrails" translate="no">​</a></h2>
<p><strong>Context Packets</strong>:</p>
<ul>
<li class=""><code>docs/idle-engine-design.md</code> for runtime contract alignment</li>
<li class=""><code>docs/runtime-event-pubsub-design.md</code> for event system integration</li>
<li class=""><code>docs/runtime-event-manifest-authoring.md</code> for manifest generation expectations</li>
</ul>
<p><strong>Prompting &amp; Constraints</strong>:</p>
<ul>
<li class="">All schemas must be <code>strict()</code> to reject unknown keys</li>
<li class="">Use <code>.transform</code> for normalisation, <code>.superRefine</code> for cross-field validation</li>
<li class="">Brand types with Zod&#x27;s <code>.brand()</code> for stronger type safety</li>
<li class="">Follow existing code style in <code>packages/core</code></li>
</ul>
<p><strong>Safety Rails</strong>:</p>
<ul>
<li class="">Do not modify runtime code in <code>packages/core</code> without explicit approval</li>
<li class="">Do not change existing sample pack data until schema package is stable</li>
<li class="">Do not skip tests—coverage must remain at current levels or higher</li>
</ul>
<p><strong>Validation Hooks</strong>:</p>
<ul>
<li class="">Run <code>pnpm test --filter content-schema</code> before marking implementation complete</li>
<li class="">Run <code>pnpm build --filter content-schema</code> to verify TypeScript compilation</li>
<li class="">Verify type exports work correctly in downstream packages</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="9-alternatives-considered">9. Alternatives Considered<a href="#9-alternatives-considered" class="hash-link" aria-label="Direct link to 9. Alternatives Considered" title="Direct link to 9. Alternatives Considered" translate="no">​</a></h2>
<p><strong>Alternative 1: JSON Schema instead of Zod</strong></p>
<ul>
<li class=""><strong>Rejected</strong>: Zod provides better TypeScript integration, runtime validation, and transformation capabilities. JSON Schema would require separate type generation tooling.</li>
</ul>
<p><strong>Alternative 2: Joi or Yup for validation</strong></p>
<ul>
<li class=""><strong>Rejected</strong>: Zod is more TypeScript-native and has better ecosystem support in the monorepo.</li>
</ul>
<p><strong>Alternative 3: Runtime-only validation (no schema package)</strong></p>
<ul>
<li class=""><strong>Rejected</strong>: Authoring-time validation is critical for content creators. Runtime-only validation discovers errors too late.</li>
</ul>
<p><strong>Alternative 4: Separate schema packages per module</strong></p>
<ul>
<li class=""><strong>Rejected</strong>: A single schema package ensures consistency and simplifies cross-reference validation.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="10-testing--validation-plan">10. Testing &amp; Validation Plan<a href="#10-testing--validation-plan" class="hash-link" aria-label="Direct link to 10. Testing &amp; Validation Plan" title="Direct link to 10. Testing &amp; Validation Plan" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="unit--integration">Unit / Integration<a href="#unit--integration" class="hash-link" aria-label="Direct link to Unit / Integration" title="Direct link to Unit / Integration" translate="no">​</a></h3>
<ul>
<li class="">Unit tests for each schema module covering success and failure cases</li>
<li class="">Property-based tests for <code>numericFormulaSchema</code> ensuring generated curves remain finite and monotonic</li>
<li class="">Integration fixtures for full packs: valid sample pack, pack with missing references, pack with cyclic unlock conditions, pack with localisation gaps, pack with dependency cycles, pack with invalid runtime event contributions</li>
<li class="">Validator factory tests ensuring warnings are collected properly</li>
<li class="">Snapshot tests for <code>normalizeContentPack</code> verifying deterministic ordering and digest stability</li>
<li class="">Type-level tests using <code>expectTypeOf</code> to ensure inferred types align with runtime expectations</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="performance">Performance<a href="#performance" class="hash-link" aria-label="Direct link to Performance" title="Direct link to Performance" translate="no">​</a></h3>
<ul>
<li class="">Benchmark validation performance on large content packs (1000+ resources/generators)</li>
<li class="">Profile normalisation overhead</li>
<li class="">Success threshold: Validation completes in <code>&lt;100ms</code> for typical packs (<code>&lt;100 entities</code> per module)</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="tooling--a11y">Tooling / A11y<a href="#tooling--a11y" class="hash-link" aria-label="Direct link to Tooling / A11y" title="Direct link to Tooling / A11y" translate="no">​</a></h3>
<ul>
<li class="">CLI integration tests using <code>tools/content-schema-cli</code></li>
<li class="">Vitest coverage target: &gt;90% line coverage for schema package</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="11-risks--mitigations">11. Risks &amp; Mitigations<a href="#11-risks--mitigations" class="hash-link" aria-label="Direct link to 11. Risks &amp; Mitigations" title="Direct link to 11. Risks &amp; Mitigations" translate="no">​</a></h2>
<table><thead><tr><th>Risk</th><th>Impact</th><th>Likelihood</th><th>Mitigation</th></tr></thead><tbody><tr><td>Formula explosion (deeply nested expressions)</td><td>Performance degradation</td><td>Medium</td><td>Recursion depth limits and AST node count caps in <code>expressionNodeSchema</code></td></tr><tr><td>Schema drift vs runtime</td><td>Runtime evolution breaks validation</td><td>Medium</td><td>CI checks that validate <code>@idle-engine/core</code> against schema digest before publish</td></tr><tr><td>Author friction from strict schemas</td><td>Reduced adoption</td><td>Low</td><td>Descriptive error messages and non-fatal warnings for soft constraints</td></tr><tr><td>Compatibility versioning complexity</td><td>Breaking changes affect old packs</td><td>Medium</td><td>Version schema transforms, allow compiler to downgrade gracefully based on <code>metadata.engine</code></td></tr><tr><td>Transform loops (runaway production)</td><td>Runtime instability</td><td>Low</td><td>Enforce <code>safety</code> guards in schema, cover loop detection in integration tests</td></tr><tr><td>Performance on large packs</td><td>Slow CLI validation</td><td>Medium</td><td>Cache normalised results, reuse lookup maps between CLI runs</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="12-rollout-plan">12. Rollout Plan<a href="#12-rollout-plan" class="hash-link" aria-label="Direct link to 12. Rollout Plan" title="Direct link to 12. Rollout Plan" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="milestones">Milestones<a href="#milestones" class="hash-link" aria-label="Direct link to Milestones" title="Direct link to Milestones" translate="no">​</a></h3>
<ul>
<li class=""><strong>Phase 1 (Weeks 1-2)</strong>: Scaffold package, implement base schemas</li>
<li class=""><strong>Phase 2 (Weeks 3-4)</strong>: Implement module schemas, formula &amp; condition schemas</li>
<li class=""><strong>Phase 3 (Week 5)</strong>: Implement pack root schema, validator factory, cross-reference validation</li>
<li class=""><strong>Phase 4 (Week 6)</strong>: Implement normalisation, integrate with CLI tooling</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="migration-strategy">Migration Strategy<a href="#migration-strategy" class="hash-link" aria-label="Direct link to Migration Strategy" title="Direct link to Migration Strategy" translate="no">​</a></h3>
<ul>
<li class="">No data migrations required initially (schema package is new)</li>
<li class="">Existing sample packs will be migrated in follow-up work after schema stabilises</li>
<li class="">Feature flags in <code>runtime-compat.ts</code> handle version compatibility</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="communication">Communication<a href="#communication" class="hash-link" aria-label="Direct link to Communication" title="Direct link to Communication" translate="no">​</a></h3>
<ul>
<li class="">Document schema updates in changelog</li>
<li class="">Share schema evolution notes with content authors</li>
<li class="">Publish migration guide when sample packs are converted</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="13-open-questions">13. Open Questions<a href="#13-open-questions" class="hash-link" aria-label="Direct link to 13. Open Questions" title="Direct link to 13. Open Questions" translate="no">​</a></h2>
<ul>
<li class="">Should the schema expose calculated presentation defaults (e.g., auto-generated icon paths) or leave that to the compiler?</li>
<li class="">Do we need additional effect types (e.g., scripted modifiers) before schema v1.0, or can they wait for the scripting design doc?</li>
<li class="">What is the migration strategy when schema digests change (e.g., do we embed the digest into save files similar to event manifests)?</li>
<li class="">Should we migrate remaining TypeScript/hand-authored sample data into the CLI-discoverable pack format before or after schema v1.0?</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="14-follow-up-work">14. Follow-Up Work<a href="#14-follow-up-work" class="hash-link" aria-label="Direct link to 14. Follow-Up Work" title="Direct link to 14. Follow-Up Work" translate="no">​</a></h2>
<ul>
<li class="">Integrate schema into <code>tools/content-schema-cli</code> (separate PR)</li>
<li class="">Migrate <code>packages/content-sample</code> to use schema validation</li>
<li class="">Add CI checks to validate runtime alignment with schema</li>
<li class="">Document authoring best practices in dedicated guide</li>
<li class="">Implement schema version migration tooling</li>
<li class="">Add performance benchmarks for large packs</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="15-references">15. References<a href="#15-references" class="hash-link" aria-label="Direct link to 15. References" title="Direct link to 15. References" translate="no">​</a></h2>
<ul>
<li class=""><code>docs/idle-engine-design.md</code> - Main engine design document</li>
<li class=""><code>docs/runtime-event-pubsub-design.md</code> - Runtime event system design</li>
<li class=""><code>docs/runtime-event-manifest-authoring.md</code> - Event manifest generation</li>
<li class=""><code>docs/progression-coordinator-design.md</code> - Persistent unlock behavior (§6.2.4)</li>
<li class=""><code>packages/core/src/condition-evaluator.ts</code> - Condition evaluation implementation</li>
<li class=""><code>packages/core/src/events/event-bus.ts</code> - Event bus implementation</li>
<li class=""><a href="https://zod.dev/" target="_blank" rel="noopener noreferrer" class="">Zod Documentation</a> - Schema validation library</li>
<li class=""><a href="https://raw.githubusercontent.com/open-telemetry/opentelemetry-specification/main/specification/metrics/api.md" target="_blank" rel="noopener noreferrer" class="">OpenTelemetry Metrics API</a> - Metrics instrumentation guidance</li>
<li class=""><a href="https://docs.npmjs.com/cli/v10/using-npm/scope" target="_blank" rel="noopener noreferrer" class="">npm Scoped Packages</a> - Package naming conventions</li>
<li class=""><a href="https://blog.codinghorror.com/new-programming-jargon/#7-stringly-typed" target="_blank" rel="noopener noreferrer" class="">Coding Horror: Stringly Typed</a> - Avoiding string-based references</li>
<li class=""><a href="https://en.wikipedia.org/wiki/Non-monotonic_logic" target="_blank" rel="noopener noreferrer" class="">Non-monotonic logic - Wikipedia</a> - Cycle detection rationale</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-a--glossary">Appendix A — Glossary<a href="#appendix-a--glossary" class="hash-link" aria-label="Direct link to Appendix A — Glossary" title="Direct link to Appendix A — Glossary" translate="no">​</a></h2>
<ul>
<li class=""><strong>Content DSL</strong>: Domain-Specific Language for authoring game content</li>
<li class=""><strong>Zod</strong>: TypeScript-first schema validation library</li>
<li class=""><strong>Normalisation</strong>: Process of transforming authored content into canonical form (lowercased ids, sorted arrays, applied defaults)</li>
<li class=""><strong>Cross-reference validation</strong>: Checking that entity references (e.g., <code>resourceId</code> in conditions) point to declared entities</li>
<li class=""><strong>Branded types</strong>: TypeScript nominal types using Zod&#x27;s <code>.brand()</code> for stronger type safety</li>
<li class=""><strong>Feature gates</strong>: Runtime version requirements for specific content modules</li>
<li class=""><strong>FNV-1a</strong>: Fast hash algorithm used for content digests</li>
<li class=""><strong>Monotonic predicate</strong>: Condition that becomes true and stays true (used for unlock logic)</li>
<li class=""><strong>Non-monotonic logic</strong>: Logic where adding information can invalidate prior inferences (e.g., negation)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-b--change-log">Appendix B — Change Log<a href="#appendix-b--change-log" class="hash-link" aria-label="Direct link to Appendix B — Change Log" title="Direct link to Appendix B — Change Log" translate="no">​</a></h2>
<table><thead><tr><th>Date</th><th>Author</th><th>Change Summary</th></tr></thead><tbody><tr><td>2025-10-18</td><td>Design team</td><td>Initial design draft (migrated to template format 2025-12-21)</td></tr></tbody></table></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_QKxP"><a href="https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/content-dsl-schema-design.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_wOWh" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_Basj"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/Idle-Game-Engine/diagnostic-timeline-design"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Diagnostic Timeline Design Document</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Idle-Game-Engine/content-dsl-usage-guidelines"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Content DSL Usage Guidelines</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_AUZ0 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#document-control" class="table-of-contents__link toc-highlight">Document Control</a></li><li><a href="#1-summary" class="table-of-contents__link toc-highlight">1. Summary</a></li><li><a href="#2-context--problem-statement" class="table-of-contents__link toc-highlight">2. Context &amp; Problem Statement</a><ul><li><a href="#background" class="table-of-contents__link toc-highlight">Background</a></li><li><a href="#problem" class="table-of-contents__link toc-highlight">Problem</a></li><li><a href="#forces" class="table-of-contents__link toc-highlight">Forces</a></li></ul></li><li><a href="#3-goals--non-goals" class="table-of-contents__link toc-highlight">3. Goals &amp; Non-Goals</a><ul><li><a href="#goals" class="table-of-contents__link toc-highlight">Goals</a></li><li><a href="#non-goals" class="table-of-contents__link toc-highlight">Non-Goals</a></li></ul></li><li><a href="#4-stakeholders-agents--impacted-surfaces" class="table-of-contents__link toc-highlight">4. Stakeholders, Agents &amp; Impacted Surfaces</a><ul><li><a href="#primary-stakeholders" class="table-of-contents__link toc-highlight">Primary Stakeholders</a></li><li><a href="#agent-roles" class="table-of-contents__link toc-highlight">Agent Roles</a></li><li><a href="#affected-packagesservices" class="table-of-contents__link toc-highlight">Affected Packages/Services</a></li><li><a href="#compatibility-considerations" class="table-of-contents__link toc-highlight">Compatibility Considerations</a></li></ul></li><li><a href="#5-current-state" class="table-of-contents__link toc-highlight">5. Current State</a></li><li><a href="#6-proposed-solution" class="table-of-contents__link toc-highlight">6. Proposed Solution</a><ul><li><a href="#61-architecture-overview" class="table-of-contents__link toc-highlight">6.1 Architecture Overview</a></li><li><a href="#62-detailed-design" class="table-of-contents__link toc-highlight">6.2 Detailed Design</a></li><li><a href="#63-operational-considerations" class="table-of-contents__link toc-highlight">6.3 Operational Considerations</a></li></ul></li><li><a href="#7-work-breakdown--delivery-plan" class="table-of-contents__link toc-highlight">7. Work Breakdown &amp; Delivery Plan</a><ul><li><a href="#71-issue-map" class="table-of-contents__link toc-highlight">7.1 Issue Map</a></li><li><a href="#72-milestones" class="table-of-contents__link toc-highlight">7.2 Milestones</a></li><li><a href="#73-coordination-notes" class="table-of-contents__link toc-highlight">7.3 Coordination Notes</a></li></ul></li><li><a href="#8-agent-guidance--guardrails" class="table-of-contents__link toc-highlight">8. Agent Guidance &amp; Guardrails</a></li><li><a href="#9-alternatives-considered" class="table-of-contents__link toc-highlight">9. Alternatives Considered</a></li><li><a href="#10-testing--validation-plan" class="table-of-contents__link toc-highlight">10. Testing &amp; Validation Plan</a><ul><li><a href="#unit--integration" class="table-of-contents__link toc-highlight">Unit / Integration</a></li><li><a href="#performance" class="table-of-contents__link toc-highlight">Performance</a></li><li><a href="#tooling--a11y" class="table-of-contents__link toc-highlight">Tooling / A11y</a></li></ul></li><li><a href="#11-risks--mitigations" class="table-of-contents__link toc-highlight">11. Risks &amp; Mitigations</a></li><li><a href="#12-rollout-plan" class="table-of-contents__link toc-highlight">12. Rollout Plan</a><ul><li><a href="#milestones" class="table-of-contents__link toc-highlight">Milestones</a></li><li><a href="#migration-strategy" class="table-of-contents__link toc-highlight">Migration Strategy</a></li><li><a href="#communication" class="table-of-contents__link toc-highlight">Communication</a></li></ul></li><li><a href="#13-open-questions" class="table-of-contents__link toc-highlight">13. Open Questions</a></li><li><a href="#14-follow-up-work" class="table-of-contents__link toc-highlight">14. Follow-Up Work</a></li><li><a href="#15-references" class="table-of-contents__link toc-highlight">15. References</a></li><li><a href="#appendix-a--glossary" class="table-of-contents__link toc-highlight">Appendix A — Glossary</a></li><li><a href="#appendix-b--change-log" class="table-of-contents__link toc-highlight">Appendix B — Change Log</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/contributor-handbook">Contributor Handbook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Idle Engine.</div></div></div></footer></div>
</body>
</html>