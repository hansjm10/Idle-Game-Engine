<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-content-dsl-schema-design" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Content DSL Schema Design | Idle Engine Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hansjm10.github.io/Idle-Game-Engine/content-dsl-schema-design"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Content DSL Schema Design | Idle Engine Docs"><meta data-rh="true" name="description" content="Issue: #11"><meta data-rh="true" property="og:description" content="Issue: #11"><link data-rh="true" rel="icon" href="/Idle-Game-Engine/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hansjm10.github.io/Idle-Game-Engine/content-dsl-schema-design"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/content-dsl-schema-design" hreflang="en"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/content-dsl-schema-design" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Content DSL Schema Design","item":"https://hansjm10.github.io/Idle-Game-Engine/content-dsl-schema-design"}]}</script><link rel="stylesheet" href="/Idle-Game-Engine/assets/css/styles.ddf7989c.css">
<script src="/Idle-Game-Engine/assets/js/runtime~main.b35eabbf.js" defer="defer"></script>
<script src="/Idle-Game-Engine/assets/js/main.c241f68f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Idle-Game-Engine/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_li4T" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Idle-Game-Engine/"><div class="navbar__logo"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--light_vaEm"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--dark_axH8"></div><b class="navbar__title text--truncate">Idle Engine</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Idle-Game-Engine/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle__Exw colorModeToggle_Lslw"><button class="clean-btn toggleButton_AMBK toggleButtonDisabled_p4Bd" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 lightToggleIcon_p2sk"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 darkToggleIcon_B2qX"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 systemToggleIcon_PWgn"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_RKai"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_nqaE"><div class="docsWrapper_CSLE"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sOWX" type="button"></button><div class="docRoot_qxtV"><aside class="theme-doc-sidebar-container docSidebarContainer_Xlvo"><div class="sidebarViewport_tjEA"><div class="sidebar_ubOv"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_CfkH"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/Idle-Game-Engine/"><span title="Getting Started" class="categoryLinkLabel_ebxo">Getting Started</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/"><span title="Overview" class="linkLabel_KsAJ">Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/contributor-handbook"><span title="Contributor Handbook" class="linkLabel_KsAJ">Contributor Handbook</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/role-index"><span title="Role Index" class="linkLabel_KsAJ">Role Index</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/design-document-template"><span title="Design Document Template" class="linkLabel_KsAJ">Design Document Template</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/idle-engine-design"><span title="Core Runtime" class="categoryLinkLabel_ebxo">Core Runtime</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/Idle-Game-Engine/content-dsl-schema-design"><span title="Content Pipeline" class="categoryLinkLabel_ebxo">Content Pipeline</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Idle-Game-Engine/content-dsl-schema-design"><span title="Content DSL Schema Design" class="linkLabel_KsAJ">Content DSL Schema Design</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/content-dsl-usage-guidelines"><span title="Content DSL Usage Guidelines" class="linkLabel_KsAJ">Content DSL Usage Guidelines</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/content-compiler-design"><span title="Content Compiler Design Document" class="linkLabel_KsAJ">Content Compiler Design Document</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/content-schema-rollout-decisions"><span title="Content Schema Rollout: Decision Log" class="linkLabel_KsAJ">Content Schema Rollout: Decision Log</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/content-validation-cli-design"><span title="Content Validation CLI Design Document" class="linkLabel_KsAJ">Content Validation CLI Design Document</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/accessibility-smoke-tests-design"><span title="Shell Integration" class="categoryLinkLabel_ebxo">Shell Integration</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/coverage/"><span title="Diagnostics &amp; Quality" class="categoryLinkLabel_ebxo">Diagnostics &amp; Quality</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/implementation-plan"><span title="Operations &amp; Process" class="categoryLinkLabel_ebxo">Operations &amp; Process</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_tfRv"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_hyci"><div class="docItemContainer_tcAC"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_bxbs" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/Idle-Game-Engine/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_p1A9"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Content Pipeline</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Content DSL Schema Design</span></li></ul></nav><div class="tocCollapsible_WMbj theme-doc-toc-mobile tocMobile_wI3e"><button type="button" class="clean-btn tocCollapsibleButton_rjEa">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Content DSL Schema Design</h1></header>
<p><strong>Issue:</strong> #11<br>
<strong>Workstream:</strong> Content Pipeline<br>
<strong>Status:</strong> Design<br>
<strong>Last Updated:</strong> 2025-10-18</p>
<blockquote>
<p>Issue #11 defines the canonical Zod schema contract for Idle Engine content
packs. The schema guards authoring-time invariants, normalises inputs for the
compiler, and aligns with the content expectations outlined in
<code>docs/idle-engine-design.md</code> §10.</p>
</blockquote>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="1-overview">1. Overview<a href="#1-overview" class="hash-link" aria-label="Direct link to 1. Overview" title="Direct link to 1. Overview" translate="no">​</a></h2>
<p>The Idle Engine content DSL bridges designer-authored data and the deterministic
runtime. Today, sample packs provide ad-hoc TypeScript interfaces, but the
monorepo lacks an enforceable schema. This document specifies the Zod schemas,
normalisation rules, and validation flow that future CLI tooling will use before
content is compiled into runtime-ready definitions. The goal is to deliver a
single package that validates metadata, resources, generators, upgrades,
metrics, achievements, prestige layers, automations, transforms, runtime event
extensions, guild perks, and pack dependency metadata while providing strong
typing for TypeScript consumers.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="2-goals">2. Goals<a href="#2-goals" class="hash-link" aria-label="Direct link to 2. Goals" title="Direct link to 2. Goals" translate="no">​</a></h2>
<ul>
<li class="">Provide a canonical <code>@idle-engine/content-schema</code> package exporting Zod
schemas and inferred TypeScript types for every content DSL module, including
metrics, achievements, runtime event definitions, and pack dependency metadata.</li>
<li class="">Normalise author input (trim strings, apply defaults, sort deterministically)
so the compiler and runtime receive stable, replayable definitions.</li>
<li class="">Surface referential, balancing, and compatibility errors at authoring time
with actionable messages for future CLI integrations.</li>
<li class="">Support localisation-ready text, formula-driven values, and unlock conditions
without constraining downstream compiler optimisations.</li>
<li class="">Keep schema evolution explicit through semantic metadata, enabling future
packs to opt into new capabilities without breaking prototype-era content.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="3-non-goals">3. Non-Goals<a href="#3-non-goals" class="hash-link" aria-label="Direct link to 3. Non-Goals" title="Direct link to 3. Non-Goals" translate="no">​</a></h2>
<ul>
<li class="">Implementing the compiler that emits runtime-ready typed arrays, manifests, or
worker bundles (tracked in a follow-up issue).</li>
<li class="">Executing or optimising numeric formulas beyond structural validation.</li>
<li class="">Delivering the localisation pipeline, documentation site generation, or
in-editor authoring experience.</li>
<li class="">Shipping gameplay logic changes in the runtime; this document only constrains
the content contract.</li>
<li class="">Rewriting existing sample data; migrations will land once the schema package
exists.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="4-current-state">4. Current State<a href="#4-current-state" class="hash-link" aria-label="Direct link to 4. Current State" title="Direct link to 4. Current State" translate="no">​</a></h2>
<ul>
<li class=""><code>packages/content-sample/src/index.ts</code> now re-exports the compiler-generated
sample pack (rehydrated content, digest, summary, indices), maintaining the
import-time warning guard without reparsing <code>content/pack.json</code>.</li>
<li class="">No shared schema package exists. Content authors must rely on informal
conventions captured in <code>docs/idle-engine-design.md</code>.</li>
<li class=""><code>tools/content-schema-cli</code> is a stub focused on runtime event manifests and
does not validate content pack data.</li>
<li class="">Tests, lint rules, and CI do not exercise schema validation because the schema
is missing.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="5-proposed-solution">5. Proposed Solution<a href="#5-proposed-solution" class="hash-link" aria-label="Direct link to 5. Proposed Solution" title="Direct link to 5. Proposed Solution" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="51-package-layout--ownership">5.1 Package Layout &amp; Ownership<a href="#51-package-layout--ownership" class="hash-link" aria-label="Direct link to 5.1 Package Layout &amp; Ownership" title="Direct link to 5.1 Package Layout &amp; Ownership" translate="no">​</a></h3>
<ul>
<li class="">Create <code>packages/content-schema</code> exporting common schema primitives, DSL
module schemas, and composite pack schemas. The package remains private until
the contract is stabilised.</li>
<li class="">Structure the package as:</li>
</ul>
<div class="language-text codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-text codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token plain">packages/content-schema/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  package.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  src/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    index.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    base/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ids.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      localization.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      numbers.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      formulas.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      conditions.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    modules/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      metadata.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      resources.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      generators.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      upgrades.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      metrics.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      achievements.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      automations.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      prestige.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      guild-perks.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      transforms.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      runtime-events.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dependencies.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    runtime-compat.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pack.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    errors.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vitest.config.ts</span><br></span></code></pre></div></div>
<ul>
<li class=""><code>index.ts</code> re-exports the base <code>contentPackSchema</code>, the
<code>createContentPackValidator</code> factory, a convenience <code>parseContentPack</code>
helper that returns <code>{ pack, warnings }</code>, <code>NormalizedContentPack</code>, and other
targeted schemas for focused validation (e.g., <code>resourceDefinitionSchema</code>,
<code>metricDefinitionSchema</code>, <code>achievementDefinitionSchema</code>,
<code>runtimeEventContributionSchema</code>).</li>
<li class="">Downstream tooling (<code>packages/content-sample</code>, CLI, compiler) imports only
from this package.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="52-shared-scalar-schemas--utilities">5.2 Shared Scalar Schemas &amp; Utilities<a href="#52-shared-scalar-schemas--utilities" class="hash-link" aria-label="Direct link to 5.2 Shared Scalar Schemas &amp; Utilities" title="Direct link to 5.2 Shared Scalar Schemas &amp; Utilities" translate="no">​</a></h3>
<ul>
<li class="">Define shared primitives with Zod brands for stronger inference:<!-- -->
<ul>
<li class=""><code>contentIdSchema</code>: case-insensitive slug
<code>[A-Za-z0-9][A-Za-z0-9-_/.:]{0,63}</code> trimmed and canonicalised to lowercase
via <code>.transform</code>, ensuring consistent hashing while still accepting mixed
author input. The transform rebrands the result with
<code>.pipe(z.string().brand&lt;&#x27;ContentId&#x27;&gt;())</code> so TypeScript keeps the nominal
type that downstream code relies on, matching the guidance from the Zod
maintainers that transforms otherwise shed brands
(<a href="https://github.com/colinhacks/zod/issues/5183" target="_blank" rel="noopener noreferrer" class="">colinhacks/zod#5183</a>).
The grammar deliberately excludes <code>@</code>, keeping scoped identifiers reserved
for pack slugs.</li>
<li class=""><code>packSlugSchema</code>: accepts both unscoped ids (<code>sample-pack</code>) and npm-style
scoped ids (<code>@idle-engine/core</code>, mirrored from <code>packages/core/src/events/runtime-event-manifest.generated.ts:57</code>),
trimming whitespace, collapsing duplicate
separators, and canonicalising to lowercase before rebranding the output
with <code>PackId</code>. The schema mirrors npm’s published scope rules—<code>@scope/name</code>
with URL-safe characters—so content packs can reference workspace packages
such as <code>@idle-engine/core</code> without loosening the general-purpose DSL id
grammar.<sup><a href="#user-content-fn-npm-scope" id="user-content-fnref-npm-scope" data-footnote-ref="true" aria-describedby="footnote-label" class="anchorTargetStickyNavbar_EdDC">1</a></sup></li>
<li class=""><code>localeCodeSchema</code>: BCP-47 compliant subset matching language tags used in
the UI.</li>
<li class=""><code>flagIdSchema</code> and <code>scriptIdSchema</code>: trimmed, lowercase slugs that reuse the
content id grammar but keep bespoke <code>FlagId</code>/<code>ScriptId</code> brands. Normalisation
collapses duplicate separators and canonicalises casing so allowlists and
authored packs compare against the same canonical form.</li>
<li class=""><code>systemAutomationTargetIdSchema</code>: alias for curated system toggle ids
(<code>offline-catchup</code>, <code>research-daemon</code>, etc.) that trims, lowercases, and
validates the identifier against an enum derived from the runtime.</li>
<li class=""><code>semverSchema</code> and <code>semverRangeSchema</code>: validated via the <code>semver</code>
library (<code>semver@7</code>) inside <code>.superRefine</code>.</li>
<li class=""><code>hexColorSchema</code>, <code>iconPathSchema</code>, <code>urlSchema</code> for UI metadata.</li>
<li class=""><code>nonNegativeNumberSchema</code>, <code>percentSchema</code>, <code>positiveIntSchema</code>.</li>
</ul>
</li>
</ul>
<ul>
<li class="">Localised text uses a strict object:</li>
</ul>
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> localizedTextSchema </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">trim</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">256</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    variants</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">record</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localeCodeSchema</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">trim</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">256</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">default</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">structuredClone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">strict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<ul>
<li class=""><code>localizedTextSchema</code> treats the <code>default</code> field as the authoritative copy for
the pack&#x27;s default locale. Localised transforms run inside
<code>normalizeContentPack</code>, where <code>normalizeLocalizedText(metadata, text, warningSink)</code> backfills a missing
<code>variants[metadata.defaultLocale]</code> entry so localisation tools that expect
keyed entries remain compatible without forcing authors to duplicate strings.
When authors supply a variant that differs from <code>default</code>, the helper records
a warning instead of overwriting the authored copy so intentional locale
tweaks remain intact. Because Zod reuses the same object instance supplied to
<code>.default({})</code>, <code>normalizeLocalizedText</code> always clones the incoming variants
map (using the platform
<a href="https://developer.mozilla.org/en-US/docs/Web/API/structuredClone" target="_blank" rel="noopener noreferrer" class=""><code>structuredClone</code></a>
API or a fallback) before applying mutations so later parses cannot observe
stale state carried over from previous callers.</li>
<li class=""><code>normalizeLocalizedText</code> receives the parsed metadata and supported locale
list from the surrounding normalisation step, letting it emit structured
warnings for missing translations while keeping the base schema free of
cross-field knowledge.</li>
<li class="">Invalid locale keys or empty variant strings surface as parse failures; we no
longer swallow malformed author input via <code>.catch({})</code>, keeping localisation
mistakes visible to tooling.</li>
<li class=""><code>localizedSummarySchema</code> extends the same structure with a relaxed ceiling
(<code>max(512)</code>) for synopsis copy so <code>metadata.summary</code> can hold longer blurbs.</li>
<li class="">All schemas are <code>strict()</code> to reject unknown keys. Optional fields apply
defaults through <code>.default</code> or <code>.transform</code>, and scalar schemas use <code>.coerce</code>
where CLI or JSON-driven inputs frequently arrive as strings so authoring
tools do not need to hand-roll conversions.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="53-numeric-formula-schema">5.3 Numeric Formula Schema<a href="#53-numeric-formula-schema" class="hash-link" aria-label="Direct link to 5.3 Numeric Formula Schema" title="Direct link to 5.3 Numeric Formula Schema" translate="no">​</a></h3>
<ul>
<li class="">Provide <code>numericFormulaSchema</code>, a discriminated union that supports both
common progression curves and explicit expressions:<!-- -->
<ul>
<li class=""><code>constant</code>: <code>{ kind: &#x27;constant&#x27;; value: number }</code>.</li>
<li class=""><code>linear</code>: <code>{ kind: &#x27;linear&#x27;; base: number; slope: number }</code>.</li>
<li class=""><code>exponential</code>: <code>{ kind: &#x27;exponential&#x27;; base: number; growth: number; offset?: number }</code>.</li>
<li class=""><code>polynomial</code>: <code>{ kind: &#x27;polynomial&#x27;; coefficients: number[] }</code>.</li>
<li class=""><code>piecewise</code>: <code>{ kind: &#x27;piecewise&#x27;; pieces: { untilLevel?: number; formula: NumericFormula }[] }</code>.</li>
<li class=""><code>expression</code>: embeds an AST validated by <code>expressionNodeSchema</code>.</li>
</ul>
</li>
<li class="">Expression nodes form a recursive Zod schema using <code>z.lazy</code> with node types:<!-- -->
<ul>
<li class=""><code>literal</code>: constant number.</li>
<li class=""><code>ref</code>: structured references that avoid stringly typed identifiers
(<a href="https://blog.codinghorror.com/new-programming-jargon/#7-stringly-typed" target="_blank" rel="noopener noreferrer" class="">Coding Horror – “Stringly Typed”</a>).
The schema permits either runtime variables
<code>{ kind: &#x27;ref&#x27;; target: { type: &#x27;variable&#x27;; name: &#x27;level&#x27; | &#x27;time&#x27; | &#x27;deltaTime&#x27; } }</code>
or entity handles
<code>{ kind: &#x27;ref&#x27;; target: { type: &#x27;resource&#x27; | &#x27;generator&#x27; | &#x27;upgrade&#x27; | &#x27;automation&#x27; | &#x27;prestigeLayer&#x27;; id: ContentId } }</code>.</li>
<li class=""><code>binary</code>: <code>op</code> in <code>{ add, sub, mul, div, pow, min, max }</code> with two operands.</li>
<li class=""><code>unary</code>: <code>op</code> in <code>{ abs, ceil, floor, round, sqrt, log10, ln }</code>.</li>
<li class=""><code>call</code>: named function (e.g., <code>clamp</code>, <code>lerp</code>) with <code>args: Expression[]</code>.</li>
</ul>
</li>
<li class="">Validation enforces finite numbers, non-empty coefficient arrays, and monotonic
<code>piecewise</code> sequences. Piecewise nodes must supply strictly increasing
<code>untilLevel</code> values and terminate with a catch-all segment (omitting
<code>untilLevel</code>) so evaluation order stays deterministic and never depends on
engine sort stability. Structured references keep lookups type-aware—validators
dispatch by <code>target.type</code> (<code>resource</code>, <code>generator</code>, etc.) or the runtime
variable enum without having to parse dotted strings—so the compiler can flag
missing entities early while still permitting <code>level</code>/<code>time</code> references.
Function call nodes are checked against a deterministic allowlist (<code>clamp</code>,
<code>lerp</code>, <code>min3</code>, <code>max3</code>, <code>pow10</code>, <code>root</code>, etc.) so unexpected identifiers
produce structured errors instead of leaking to runtime.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="54-condition-schema">5.4 Condition Schema<a href="#54-condition-schema" class="hash-link" aria-label="Direct link to 5.4 Condition Schema" title="Direct link to 5.4 Condition Schema" translate="no">​</a></h3>
<ul>
<li class=""><code>conditionSchema</code> uses <code>z.discriminatedUnion(&#x27;kind&#x27;, …)</code> so every node spells
out the payload required for validation and graph analysis. The snippet below
shows the intended TypeScript shape using the types inferred from
<code>contentIdSchema</code> and <code>numericFormulaSchema</code>:</li>
</ul>
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// z imported from &#x27;zod&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">ContentId</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">infer</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> contentIdSchema</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">NumericFormula</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">infer</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> numericFormulaSchema</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">FlagId</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">infer</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> flagIdSchema</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">ScriptId</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">infer</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> scriptIdSchema</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">Condition</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;always&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;never&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;resourceThreshold&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      resourceId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      comparator</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;gte&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;gt&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;lte&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;lt&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      amount</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> NumericFormula</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;generatorLevel&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      generatorId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      comparator</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;gte&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;gt&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;lte&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;lt&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      level</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> NumericFormula</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;upgradeOwned&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      upgradeId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      requiredPurchases</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// defaults to 1 during normalisation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;prestigeUnlocked&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> prestigeLayerId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;flag&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> flagId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> FlagId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;script&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> scriptId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ScriptId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;allOf&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> conditions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> Condition</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;anyOf&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> conditions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> Condition</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> kind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;not&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> condition</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Condition </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<ul>
<li class="">Conditions are <code>strict()</code> objects and reuse <code>numericFormulaSchema</code> wherever a
numeric comparison is required (<code>amount</code>, <code>level</code>). Cross-reference checks use
the explicit <code>resourceId</code>, <code>generatorId</code>, <code>upgradeId</code>, and
<code>prestigeLayerId</code> fields when validating existence and building dependency
graphs. Future iterations can introduce additional condition variants (for
example, achievement, automation, or transform predicates); until then the
validator limits cross-references to the nodes above. <code>flag</code> and <code>script</code>
nodes are validated against
<code>ContentSchemaOptions.allowlists</code>; the factory accepts arrays or sets for the
inputs and normalises them (via the same canonical schemas used on conditions)
to <code>ReadonlySet</code> lookups. Entries marked <code>required</code> remain hard failures,
while <code>soft</code> allow missing lookups with a warning.</li>
<li class="">Aggregation nodes (<code>allOf</code>, <code>anyOf</code>) require at least one nested condition via
<code>.min(1)</code> so unlock logic never defaults to vacuous truth.</li>
<li class="">Cycle detection only introduces edges for monotonic predicates (<code>resource</code>
thresholds, generator levels, upgrade ownership, prestige unlocks, flag/script
allowlists) that participate in <code>allOf</code> and other positive contexts. Negated
predicates (<code>not</code>) and disjunction branches (<code>anyOf</code>) still undergo existence
checks, but they do not register graph edges; instead they are captured as
advisory constraints so authors can express absence-based gating without
creating non-monotonic cycles that would otherwise surface as false positives
during validation.<sup><a href="#user-content-fn-non-monotonic" id="user-content-fnref-non-monotonic" data-footnote-ref="true" aria-describedby="footnote-label" class="anchorTargetStickyNavbar_EdDC">2</a></sup></li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="541-condition-evaluation-semantics-runtime-behavior">5.4.1 Condition Evaluation Semantics (Runtime Behavior)<a href="#541-condition-evaluation-semantics-runtime-behavior" class="hash-link" aria-label="Direct link to 5.4.1 Condition Evaluation Semantics (Runtime Behavior)" title="Direct link to 5.4.1 Condition Evaluation Semantics (Runtime Behavior)" translate="no">​</a></h4>
<blockquote>
<p><strong>Note</strong>: This subsection documents the <strong>existing runtime implementation</strong> of condition evaluation as shipped in PR #303 (<code>packages/shell-web/src/modules/condition-evaluator.ts</code>). This is retroactive documentation of production code.</p>
</blockquote>
<p><strong>Evaluation Context</strong>:</p>
<p>Conditions are evaluated against live game state via a <code>ConditionContext</code> interface that provides:</p>
<ul>
<li class=""><code>getResourceAmount(resourceId: string): number</code> - Current resource amount</li>
<li class=""><code>getGeneratorLevel(generatorId: string): number</code> - Generator owned count</li>
<li class=""><code>getUpgradePurchases(upgradeId: string): number</code> - Upgrade purchase count</li>
<li class=""><code>onError?: (error: Error) =&gt; void</code> - Optional error callback for telemetry</li>
</ul>
<p><strong>Static Threshold Evaluation</strong>:</p>
<p>Unlock conditions (used for <code>baseUnlock</code> and <code>visibilityCondition</code> on generators/upgrades) use <strong>static thresholds</strong> that do not scale with progression. All numeric formulas in unlock conditions are evaluated with <code>level: 0</code>:</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> amount </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateNumericFormula</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">condition</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">amount</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  variables</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> level</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// STATIC_THRESHOLD_LEVEL constant</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>This differs from <strong>dynamic cost curves</strong> which evaluate with <code>level: purchaseIndex</code> to scale costs as players buy more units. The distinction is intentional: unlock thresholds are constant gates (e.g., &quot;unlock when you have 100 energy&quot;), while costs increase with purchases (e.g., &quot;10th generator costs 1000 energy&quot;).</p>
<p><strong>Evaluation Rules by Condition Type</strong>:</p>
<ul>
<li class=""><strong><code>always</code></strong>: Returns <code>true</code> immediately without evaluating game state</li>
<li class=""><strong><code>never</code></strong>: Returns <code>false</code> (used for content disabled in specific builds)</li>
<li class=""><strong><code>resourceThreshold</code></strong>:<!-- -->
<ul>
<li class="">Retrieves current resource amount via context</li>
<li class="">Evaluates <code>amount</code> formula with <code>level: 0</code></li>
<li class="">Compares using specified comparator (<code>gte | gt | lte | lt</code>)</li>
<li class="">Example: <code>{ kind: &#x27;resourceThreshold&#x27;, resourceId: &#x27;energy&#x27;, comparator: &#x27;gte&#x27;, amount: { kind: &#x27;constant&#x27;, value: 100 } }</code> checks if player has ≥100 energy</li>
</ul>
</li>
<li class=""><strong><code>generatorLevel</code></strong>:<!-- -->
<ul>
<li class="">Retrieves generator owned count via context</li>
<li class="">Evaluates <code>level</code> formula with <code>level: 0</code></li>
<li class="">Compares using specified comparator</li>
<li class="">Example: <code>{ kind: &#x27;generatorLevel&#x27;, generatorId: &#x27;reactor&#x27;, comparator: &#x27;gte&#x27;, level: { kind: &#x27;constant&#x27;, value: 5 } }</code> checks if player owns ≥5 reactors</li>
</ul>
</li>
<li class=""><strong><code>upgradeOwned</code></strong>:<!-- -->
<ul>
<li class="">Retrieves upgrade purchase count via context</li>
<li class="">Checks if purchases ≥ <code>requiredPurchases</code> (defaults to 1)</li>
<li class="">Example: <code>{ kind: &#x27;upgradeOwned&#x27;, upgradeId: &#x27;efficiency&#x27;, requiredPurchases: 3 }</code> checks if upgrade purchased ≥3 times</li>
</ul>
</li>
<li class=""><strong><code>allOf</code></strong>:<!-- -->
<ul>
<li class="">Evaluates all nested conditions recursively</li>
<li class="">Returns <code>true</code> only if <strong>every</strong> condition passes (logical AND)</li>
<li class="">Short-circuits on first failure</li>
</ul>
</li>
<li class=""><strong><code>anyOf</code></strong>:<!-- -->
<ul>
<li class="">Evaluates nested conditions recursively</li>
<li class="">Returns <code>true</code> if <strong>any</strong> condition passes (logical OR)</li>
<li class="">Short-circuits on first success</li>
</ul>
</li>
<li class=""><strong><code>not</code></strong>:<!-- -->
<ul>
<li class="">Evaluates nested condition recursively</li>
<li class="">Inverts the result</li>
<li class="">Example: <code>{ kind: &#x27;not&#x27;, condition: resourceThreshold }</code> passes if threshold NOT met</li>
</ul>
</li>
</ul>
<p><strong>Error Handling</strong>:</p>
<p>Unknown condition kinds or comparators trigger fail-safe behavior:</p>
<ul>
<li class=""><strong>Development</strong>: Calls <code>context.onError(error)</code> for test assertions and strict validation</li>
<li class=""><strong>Production</strong>: Logs <code>console.warn(error.message)</code> and returns <code>false</code></li>
<li class=""><strong>Rationale</strong>: Graceful degradation prevents crashes when content contains unrecognized condition types (e.g., from newer schema versions)</li>
</ul>
<p><strong>Persistent Unlock Semantics</strong>:</p>
<p>When conditions are used for <code>baseUnlock</code> on generators, the progression coordinator implements <strong>persistent unlock</strong> behavior:</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// packages/shell-web/src/modules/progression-coordinator.ts:310-312</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isUnlocked </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> baseUnlock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isUnlocked </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Never reverts!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Once a generator&#x27;s <code>baseUnlock</code> condition evaluates to <code>true</code>, the <code>isUnlocked</code> flag <strong>never reverts to <code>false</code></strong>, even if the condition later fails (e.g., player spends resources below the threshold). This ensures generators remain available after being discovered.</p>
<p>In contrast, <code>visibilityCondition</code> is re-evaluated every game step and can toggle between <code>true</code> and <code>false</code>, allowing dynamic hiding/showing of content based on current state.</p>
<p><strong>Human-Readable Descriptions</strong>:</p>
<p>The runtime generates unlock hints for locked content using <code>describeCondition()</code>:</p>
<ul>
<li class=""><code>resourceThreshold</code> → <code>&quot;Requires energy &gt;= 100&quot;</code></li>
<li class=""><code>generatorLevel</code> → <code>&quot;Requires reactor &gt;= 5&quot;</code></li>
<li class=""><code>upgradeOwned</code> → <code>&quot;Requires owning 3× efficiency&quot;</code></li>
<li class=""><code>allOf</code> → <code>&quot;Requires energy &gt;= 100, Requires reactor &gt;= 5&quot;</code> (comma-separated)</li>
<li class=""><code>anyOf</code> → <code>&quot;Requires any of: energy &gt;= 100 or reactor &gt;= 5&quot;</code></li>
<li class=""><code>not</code> → <code>&quot;Not (Requires energy &gt;= 100)&quot;</code></li>
<li class=""><code>always</code> → <code>undefined</code> (no hint needed)</li>
<li class=""><code>never</code> → <code>&quot;Unavailable in this build&quot;</code></li>
</ul>
<p>These hints are displayed in progression UI when upgrades are locked, helping players understand unlock requirements.</p>
<p><strong>Implementation Reference</strong>:</p>
<ul>
<li class="">Condition evaluator: <code>packages/shell-web/src/modules/condition-evaluator.ts:1-283</code></li>
<li class="">Condition evaluation tests: <code>packages/shell-web/src/modules/condition-evaluator.test.ts:1-556</code></li>
<li class="">Progression coordinator integration: <code>packages/shell-web/src/modules/progression-coordinator.ts:305-318, 331-349</code></li>
<li class="">Persistent unlock behavior: Documented in <code>docs/progression-coordinator-design.md</code> §6.2.4</li>
</ul>
<p><strong>Content Authoring Guidelines</strong>:</p>
<ol>
<li class=""><strong>Use <code>always</code> for unconditionally unlocked content</strong>: Set <code>baseUnlock: { kind: &#x27;always&#x27; }</code> for starting generators</li>
<li class=""><strong>Avoid circular dependencies</strong>: Don&#x27;t create unlock chains where A requires B and B requires A</li>
<li class=""><strong>Prefer simple thresholds</strong>: Use <code>resourceThreshold</code> or <code>generatorLevel</code> rather than complex <code>allOf</code> nesting when possible</li>
<li class=""><strong>Test negative conditions carefully</strong>: <code>not</code> and <code>anyOf</code> introduce non-monotonic logic; ensure they don&#x27;t create confusing unlock sequences</li>
<li class=""><strong>Consider persistent unlocks</strong>: Remember that <code>baseUnlock</code> is persistent—don&#x27;t use it for temporary gates</li>
<li class=""><strong>Use <code>visibilityCondition</code> for temporary gates</strong>: If content should hide again after discovery, use <code>visibilityCondition</code> instead of <code>baseUnlock</code></li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="55-metadata-schema">5.5 Metadata Schema<a href="#55-metadata-schema" class="hash-link" aria-label="Direct link to 5.5 Metadata Schema" title="Direct link to 5.5 Metadata Schema" translate="no">​</a></h3>
<ul>
<li class=""><code>metadataSchema</code> covers content-level metadata:<!-- -->
<ul>
<li class=""><code>id</code>: pack slug (<code>packSlugSchema</code>).</li>
<li class=""><code>title</code>: <code>localizedTextSchema</code>.</li>
<li class=""><code>summary</code>: optional <code>localizedSummarySchema</code> with longer copy (≤512 chars).</li>
<li class=""><code>version</code>: semantic version string validated by <code>semver</code>.</li>
<li class=""><code>engine</code>: semver range describing supported runtime versions.</li>
<li class=""><code>authors</code>: array of trimmed strings (≤64 chars) with de-duplication.</li>
<li class=""><code>defaultLocale</code>: <code>localeCodeSchema</code> that maps to the <code>title.default</code>
property. Normalisation ensures the same string also appears in
<code>title.variants</code> for tooling that expects locale keys.</li>
<li class=""><code>supportedLocales</code>: non-empty array of <code>localeCodeSchema</code> entries
representing every locale shipped with the pack. Validation rejects inputs
that omit <code>defaultLocale</code>, while normalisation removes duplicates and sorts
the final list for deterministic hashing.</li>
<li class=""><code>tags</code>: array of slugs (≤24 chars) reserved for tooling filters.</li>
<li class=""><code>links</code>: optional array of URL metadata <code>{ kind, label, href }</code>.</li>
<li class=""><code>createdAt</code> / <code>updatedAt</code>: ISO-8601 timestamps (optional).</li>
<li class=""><code>visibility</code>: optional enum <code>public | private | experimental</code>.</li>
<li class=""><code>dependencies</code>: optional object shaped by <code>packDependencySchema</code> exported
from <code>modules/dependencies.ts</code>:<!-- -->
<ul>
<li class=""><code>requires</code>: array of <code>{ packId: PackId; version: semverRangeSchema }</code>
representing hard dependencies that must load before this pack.</li>
<li class=""><code>optional</code>: array with the same shape for soft integrations (warnings
emitted when known installed packs omit the dependency; see §5.16).</li>
<li class=""><code>conflicts</code>: array restricting incompatible packs
(<code>{ packId: PackId; message?: string }</code>).</li>
<li class=""><code>provides</code>: optional array of capability slugs for discovery tooling.
Normalisation deduplicates entries, sorts them deterministically, and
ensures packs never self-reference. Dependency cycle detection runs during
cross-reference validation by combining the pack&#x27;s declared <code>requires</code>
edges with the dependency graph supplied through
<code>ContentSchemaOptions.knownPacks</code> (see §5.16); when upstream data is
missing, the validator still guards against self-references and duplicate
entries.</li>
</ul>
</li>
</ul>
</li>
<li class="">The schema normalises whitespace, enforces canonical casing, and ensures
<code>engine</code> ranges include the active runtime version when known (checked in
tests) and that <code>supportedLocales</code> contains <code>defaultLocale</code>. Optional
dependencies only surface <code>optionalDependency.missing</code> warnings when callers
supply <code>ContentSchemaOptions.activePackIds</code>; otherwise the entries stay
informational so unpublished packs are not penalised while the pipeline lacks
visibility into the installation graph. During the proof-of-concept phase we
explicitly keep optional dependencies as warnings (never hard errors) to
preserve iteration speed; once installation graphs are available we can
revisit stricter enforcement. When authors pass <code>ContentSchemaOptions.runtimeVersion</code>,
<code>validateCrossReferences</code> performs two compatibility checks:<!-- -->
<ol>
<li class=""><code>semver.satisfies(runtimeVersion, metadata.engine)</code> must be true; otherwise
a targeted error is raised (per the
<a href="https://github.com/npm/node-semver#ranges" target="_blank" rel="noopener noreferrer" class=""><code>node-semver</code> README example</a>).</li>
<li class="">The validator consults the <code>FEATURE_GATES</code> map in <code>runtime-compat.ts</code>. Each
non-prototype module (anchored to the roadmap described in
<code>docs/idle-engine-design.md</code> §18 and <code>docs/implementation-plan.md</code>)
declares the minimum runtime version it supports. For example, automations
require <code>&gt;=0.2.0</code>, transforms and runtime event contributions require
<code>&gt;=0.3.0</code>, prestige layers require <code>&gt;=0.4.0</code>, and guild perks require
<code>&gt;=0.5.0</code>. When a pack targets an older runtime yet includes gated modules,
<code>validateCrossReferences</code> emits a structured error naming the offending
feature and required version. Passing packs still receive warning hints
when they depend on features from newer runtimes so maintainers know which
modules to trim if they need to stay compatible.</li>
</ol>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="56-resource-schema">5.6 Resource Schema<a href="#56-resource-schema" class="hash-link" aria-label="Direct link to 5.6 Resource Schema" title="Direct link to 5.6 Resource Schema" translate="no">​</a></h3>
<ul>
<li class=""><code>resourceDefinitionSchema</code> extends the runtime-facing definition with content
metadata:<!-- -->
<ul>
<li class=""><code>id</code>: <code>contentIdSchema</code>.</li>
<li class=""><code>name</code>: <code>localizedTextSchema</code>.</li>
<li class=""><code>category</code>: enum (<code>primary</code>, <code>prestige</code>, <code>automation</code>, <code>currency</code>,
<code>misc</code>).</li>
<li class=""><code>tier</code>: positive integer for UI grouping.</li>
<li class=""><code>icon</code>: optional icon path (SVG/PNG) resolved at build time.</li>
<li class=""><code>startAmount</code>: non-negative number (defaults to <code>0</code>).</li>
<li class=""><code>capacity</code>: nullable number; <code>null</code> maps to infinity at runtime.</li>
<li class=""><code>visible</code>: boolean default <code>true</code>.</li>
<li class=""><code>unlocked</code>: boolean default <code>false</code>.</li>
<li class=""><code>dirtyTolerance</code>: optional override (validated against runtime ceilings).</li>
<li class=""><code>order</code>: optional float for deterministic sort when content author wants
manual ordering.</li>
<li class=""><code>unlockCondition</code> / <code>visibilityCondition</code>: <code>conditionSchema</code> nodes.</li>
<li class=""><code>prestige</code>: optional block describing prestige currency linkage
<code>{ layerId, resetRetention?: NumericFormula }</code>.</li>
<li class=""><code>tags</code>: array of slugs for analytics or UI filters.</li>
</ul>
</li>
<li class=""><code>.superRefine</code> performs per-definition checks:<!-- -->
<ul>
<li class=""><code>startAmount ≤ capacity</code> when capacity is finite.</li>
<li class=""><code>dirtyTolerance</code> clamped to the runtime maximum with telemetry-friendly
diagnostics.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="57-generator-schema">5.7 Generator Schema<a href="#57-generator-schema" class="hash-link" aria-label="Direct link to 5.7 Generator Schema" title="Direct link to 5.7 Generator Schema" translate="no">​</a></h3>
<ul>
<li class=""><code>generatorDefinitionSchema</code> models production structures:<!-- -->
<ul>
<li class=""><code>id</code>, <code>name</code>, <code>icon</code>, <code>tags</code> similar to resources.</li>
<li class=""><code>produces</code>: array of <code>{ resourceId, rate: NumericFormula }</code>.</li>
<li class=""><code>consumes</code>: optional array of <code>{ resourceId, rate: NumericFormula }</code> for
upkeep costs.</li>
<li class=""><code>purchase</code>: strict object with explicit scalar schemas:<!-- -->
<ul>
<li class=""><code>currencyId</code>: <code>contentIdSchema</code> (lowercased during normalisation).</li>
<li class=""><code>baseCost</code>: <code>nonNegativeNumberSchema</code> ensuring finite, ≥0 values.</li>
<li class=""><code>costCurve</code>: <code>numericFormulaSchema</code> evaluated in the runtime against the
current purchase count.</li>
<li class=""><code>maxBulk</code>: optional <code>positiveIntSchema</code> constraining bulk-buy UI affordances.</li>
</ul>
</li>
<li class=""><code>maxLevel</code>: optional positive integer.</li>
<li class=""><code>order</code>: optional float controlling list ordering (sorted before id during
normalisation).</li>
<li class=""><code>baseUnlock</code>: <code>conditionSchema</code> gating initial availability.</li>
<li class=""><code>visibilityCondition</code>: <code>conditionSchema</code> for UI reveal.</li>
<li class=""><code>automation</code>: optional reference <code>{ automationId }</code> linking to automation
definitions.</li>
<li class=""><code>effects</code>: optional array for generator-specific effects (e.g., passive
bonuses) using shared effect schema from upgrades.</li>
</ul>
</li>
<li class="">Cross-validation ensures referenced resources exist, consumption and production
rates are finite, and <code>maxBulk</code> respects <code>maxLevel</code>.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="58-upgrade-schema">5.8 Upgrade Schema<a href="#58-upgrade-schema" class="hash-link" aria-label="Direct link to 5.8 Upgrade Schema" title="Direct link to 5.8 Upgrade Schema" translate="no">​</a></h3>
<ul>
<li class=""><code>upgradeDefinitionSchema</code> captures upgrade catalog entries:<!-- -->
<ul>
<li class=""><code>id</code>, <code>name</code>, <code>icon</code>, <code>tags</code>.</li>
<li class=""><code>category</code>: enum (<code>global</code>, <code>resource</code>, <code>generator</code>, <code>automation</code>,
<code>prestige</code>, <code>guild</code>).</li>
<li class=""><code>targets</code>: array of typed handles
(<code>{ kind: &#x27;resource&#x27;; id: ContentId }</code>,
<code>{ kind: &#x27;generator&#x27;; id: ContentId }</code>,
<code>{ kind: &#x27;automation&#x27;; id: ContentId }</code>,
<code>{ kind: &#x27;prestigeLayer&#x27;; id: ContentId }</code>,
<code>{ kind: &#x27;guildPerk&#x27;; id: ContentId }</code>, or <code>{ kind: &#x27;global&#x27; }</code>) so upgrade
payloads stay strongly typed and avoid the stringly typed anti-pattern noted
above.</li>
<li class=""><code>cost</code>: same schema as generator <code>purchase</code>, reusing the scalar contracts for
<code>currencyId</code>, <code>baseCost</code>, <code>costCurve</code>, and <code>maxBulk</code>.</li>
<li class=""><code>repeatable</code>: optional block describing stacking rules (<code>maxPurchases</code>,
<code>costCurve</code>, <code>effectCurve</code>).</li>
<li class=""><code>prerequisites</code>: array of <code>conditionSchema</code> or upgrade ids (internally
normalised to condition nodes).</li>
<li class=""><code>order</code>: optional float aligning manual catalogue ordering with generator and
resource lists.</li>
<li class=""><code>effects</code>: array of discriminated union entries:<!-- -->
<ul>
<li class=""><code>modifyResourceRate</code> (<code>resourceId</code>, <code>operation</code>, <code>value: NumericFormula</code>).</li>
<li class=""><code>modifyGeneratorRate</code>.</li>
<li class=""><code>modifyGeneratorCost</code>.</li>
<li class=""><code>grantAutomation</code>.</li>
<li class=""><code>grantFlag</code> (<code>{ kind: &#x27;grantFlag&#x27;; flagId: FlagId; value?: boolean }</code>)
declaring deterministic flag mutations; <code>value</code> defaults to <code>true</code> during
normalisation so authors can focus on the ids they flip. The schema reuses
<code>flagIdSchema</code> and validates the id against caller-supplied allowlists.</li>
<li class=""><code>unlockResource</code> / <code>unlockGenerator</code>.</li>
<li class=""><code>alterDirtyTolerance</code>.</li>
<li class=""><code>emitEvent</code> (hooks into runtime event bus).</li>
</ul>
</li>
<li class=""><code>unlockCondition</code> / <code>visibilityCondition</code>.</li>
</ul>
</li>
<li class="">Validation ensures effect targets exist, repeatable upgrades specify consistent
bounds, and cost curves match runtime expectations using the explicit <code>kind</code>
information in <code>targets</code> and the effect payloads.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="59-metric-schema">5.9 Metric Schema<a href="#59-metric-schema" class="hash-link" aria-label="Direct link to 5.9 Metric Schema" title="Direct link to 5.9 Metric Schema" translate="no">​</a></h3>
<ul>
<li class=""><code>metricDefinitionSchema</code> describes pack-authored telemetry counters that plug
into the instrumentation pipeline promised in <code>docs/idle-engine-design.md</code> §16
(“allow games to register custom metrics using shared instrumentation API”):<!-- -->
<ul>
<li class=""><code>id</code>: <code>contentIdSchema</code> canonical slug aligned with the instrumentation name
grammar. Normalisation lowercases ids and collapses duplicate separators so
authored metrics mirror the lookup keys used by runtime exporters.</li>
<li class=""><code>name</code>: <code>localizedTextSchema</code>.</li>
<li class=""><code>description</code>: optional <code>localizedSummarySchema</code>, surfaced in tooling so
designers and analytics reviewers share human-friendly context for each
measurement.</li>
<li class=""><code>kind</code>: enum (<code>counter</code>, <code>gauge</code>, <code>histogram</code>, <code>upDownCounter</code>) mapping onto
OpenTelemetry instrument semantics to keep downstream aggregation predictable
(matching the public guidance that instrument kind, unit, and description
shape identity and cardinality constraints<sup><a href="#user-content-fn-otel-metrics-api" id="user-content-fnref-otel-metrics-api" data-footnote-ref="true" aria-describedby="footnote-label" class="anchorTargetStickyNavbar_EdDC">3</a></sup>).</li>
<li class=""><code>unit</code>: optional string validated against a trimmed ASCII grammar and capped
at 32 characters. Normalisation defaults empty units to <code>&#x27;1&#x27;</code> for
dimensionless counters, mirroring OpenTelemetry’s recommendation for unit
fields.</li>
<li class=""><code>aggregation</code>: optional enum describing the preferred rollup
(<code>sum</code>, <code>delta</code>, <code>cumulative</code>, <code>distribution</code>). The schema keeps the value
advisory—tooling can respect author intent while still allowing fallback
aggregation when runtimes lack support.</li>
<li class=""><code>attributes</code>: optional array of attribute keys (<code>slug</code> grammar,
≤16 chars) documenting the telemetry dimension set so validation can warn
when authors declare high-cardinality combinations.</li>
<li class=""><code>source</code>: enum describing how the pack emits the metric (<code>runtime</code>, <code>script</code>,
<code>content</code>) with optional payload describing bindings (e.g.,
<code>{ kind: &#x27;script&#x27;; scriptId: ScriptId }</code>). Validation ensures referenced
script ids originate from allowlists and warns when runtime bindings cite
modules gated by <code>FEATURE_GATES</code>.</li>
<li class=""><code>order</code>: optional float letting authors stabilise how metrics appear in CLI
reports or documentation exports before falling back to id-based sorting.</li>
</ul>
</li>
<li class="">Validation rejects duplicate metric ids, enforces that histogram metrics
declare an advisory aggregation, and surfaces warnings when attribute key
counts exceed three (mirroring OpenTelemetry’s constraint on low-cardinality
attribute sets to keep exporters efficient). Metrics participate in
localisation checks and integrate with the warning sink so CLI tooling can
flag ambiguous descriptions.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="510-achievement-schema">5.10 Achievement Schema<a href="#510-achievement-schema" class="hash-link" aria-label="Direct link to 5.10 Achievement Schema" title="Direct link to 5.10 Achievement Schema" translate="no">​</a></h3>
<ul>
<li class=""><code>achievementDefinitionSchema</code> models milestone tracking promised in
<code>docs/idle-engine-design.md</code> §6 and §10:<!-- -->
<ul>
<li class=""><code>id</code>: <code>contentIdSchema</code>.</li>
<li class=""><code>name</code>: <code>localizedTextSchema</code>.</li>
<li class=""><code>description</code>: <code>localizedSummarySchema</code> (≤512 chars) so UI blurbs can be
longer than upgrade tooltips.</li>
<li class=""><code>category</code>: enum (<code>progression</code>, <code>prestige</code>, <code>automation</code>, <code>social</code>,
<code>collection</code>).</li>
<li class=""><code>tier</code>: enum (<code>bronze</code>, <code>silver</code>, <code>gold</code>, <code>platinum</code>) used for UI theming.</li>
<li class=""><code>icon</code>: optional icon path.</li>
<li class=""><code>tags</code>: array for analytics or in-game filters.</li>
<li class=""><code>track</code>: discriminated union describing progress measurement:<!-- -->
<ul>
<li class=""><code>resource</code>: <code>{ kind: &#x27;resource&#x27;; resourceId: ContentId; threshold: NumericFormula; comparator?: &#x27;gte&#x27; | &#x27;gt&#x27; | &#x27;lte&#x27; | &#x27;lt&#x27; }</code>.</li>
<li class=""><code>generatorLevel</code>: <code>{ kind: &#x27;generator-level&#x27;; generatorId: ContentId; level: NumericFormula }</code>.</li>
<li class=""><code>upgradeOwned</code>: <code>{ kind: &#x27;upgrade-owned&#x27;; upgradeId: ContentId; purchases?: NumericFormula }</code>.</li>
<li class=""><code>flag</code>: <code>{ kind: &#x27;flag&#x27;; flagId: FlagId }</code>.</li>
<li class=""><code>script</code>: <code>{ kind: &#x27;script&#x27;; scriptId: ScriptId }</code>.</li>
<li class=""><code>customMetric</code>: <code>{ kind: &#x27;custom-metric&#x27;; metricId: ContentId; threshold: NumericFormula }</code> for pack-defined telemetry counters. Validation ensures
<code>metricId</code> references a metric declared in the same pack.</li>
</ul>
</li>
<li class=""><code>progress</code>: object describing accumulation semantics:<!-- -->
<ul>
<li class=""><code>target</code>: optional <code>NumericFormula</code>. When omitted, normalisation derives a
deterministic default: <code>threshold</code>, <code>level</code>, <code>purchases</code>, or <code>metric</code>
requirements from the active <code>track</code> variant, and a constant <code>1</code> curve for
boolean achievements (<code>flag</code>, <code>script</code>) so they still model a goal that
resolves to completion.</li>
<li class=""><code>mode</code>: enum (<code>oneShot</code>, <code>incremental</code>, <code>repeatable</code>) guiding whether
progress sticks after completion.</li>
<li class=""><code>repeatable</code>: optional object used when <code>mode === &#x27;repeatable&#x27;</code>:
<code>{ resetWindow: NumericFormula; maxRepeats?: number; rewardScaling?: NumericFormula }</code>.
<code>resetWindow</code> defines the deterministic interval between repeats
(expressed in runtime ticks). <code>maxRepeats</code> limits the total number of
times the achievement can recur, and <code>rewardScaling</code> describes how repeat
rewards scale (defaults to a constant <code>1</code> curve). Validation enforces
presence of <code>resetWindow</code> whenever the repeatable block exists.</li>
</ul>
</li>
<li class=""><code>reward</code>: optional union (<code>grantResource</code>, <code>grantUpgrade</code>, <code>grantGuildPerk</code>,
<code>emitEvent</code>, <code>unlockAutomation</code>, <code>grantFlag</code>) reusing effect payload schemas.
<code>grantFlag</code> mirrors the upgrade effect contract (<code>flagId</code>, optional <code>value</code>
defaulting to <code>true</code>) and validates entries against the <code>flags</code> allowlist.</li>
<li class=""><code>unlockCondition</code>: optional <code>conditionSchema</code> gating visibility in the log.</li>
<li class=""><code>visibilityCondition</code>: optional <code>conditionSchema</code> enabling hidden feats.</li>
<li class=""><code>onUnlockEvents</code>: optional array of runtime event ids emitted when the
achievement completes, ensuring content-authored events integrate with the
manifest pipeline described in §5.15.</li>
<li class=""><code>displayOrder</code>: optional float for deterministic ordering alongside author
supplied tiers.</li>
</ul>
</li>
<li class="">Cross-validation ensures the resolved <code>progress.target</code> (authored or inferred)
evaluates to a positive, finite number, referenced ids exist (including
<code>customMetric.metricId</code> entries), union variants include the correct handles,
and repeatable achievements declare deterministic
reset semantics via the
<code>repeatable.resetWindow</code> field (while keeping <code>maxRepeats</code> finite and
<code>rewardScaling</code> curves bounded). Achievements also participate in localisation
checks so missing descriptions surface warnings.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="511-automation-schema">5.11 Automation Schema<a href="#511-automation-schema" class="hash-link" aria-label="Direct link to 5.11 Automation Schema" title="Direct link to 5.11 Automation Schema" translate="no">​</a></h3>
<ul>
<li class=""><code>automationDefinitionSchema</code> describes automation toggles:<!-- -->
<ul>
<li class=""><code>id</code>: <code>contentIdSchema</code>.</li>
<li class=""><code>name</code>: <code>localizedTextSchema</code>.</li>
<li class=""><code>description</code>: <code>localizedTextSchema</code>.</li>
<li class=""><code>targetType</code>: enum (<code>generator</code>, <code>upgrade</code>, <code>system</code>).</li>
<li class=""><code>targetId</code>: required when <code>targetType</code> is <code>generator</code> or <code>upgrade</code> and
validated against the relevant ids.</li>
<li class=""><code>systemTargetId</code>: required when <code>targetType === &#x27;system&#x27;</code>, validated using
<code>systemAutomationTargetIdSchema</code> against the curated allowlist
(<code>offline-catchup</code>, <code>research-daemon</code>, etc.).</li>
<li class=""><code>trigger</code>: union of deterministic triggers (<code>interval</code>, <code>resourceThreshold</code>,
<code>commandQueueEmpty</code>, <code>event</code>).</li>
<li class=""><code>cooldown</code>: optional number (<code>ms</code>).</li>
<li class=""><code>resourceCost</code>: optional upkeep cost schema reused from generators.</li>
<li class=""><code>unlockCondition</code>: <code>conditionSchema</code>.</li>
<li class=""><code>enabledByDefault</code>: boolean default <code>false</code>.</li>
<li class=""><code>order</code>: optional float guiding UI grouping.</li>
</ul>
</li>
<li class="">Automations can reference script hooks; validation ensures script ids adhere to
the shared id schema. System targets validate against a curated allowlist
encoded by <code>systemAutomationTargetIdSchema</code> (e.g., <code>offline-catchup</code>,
<code>research-daemon</code>) so authors receive actionable errors instead of generic
missing-id failures. Event-triggered automations (<code>trigger.kind === &#x27;event&#x27;</code>)
are cross-checked against the merged runtime event catalogue so dangling ids
surface during validation rather than at runtime.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="512-transform-schema">5.12 Transform Schema<a href="#512-transform-schema" class="hash-link" aria-label="Direct link to 5.12 Transform Schema" title="Direct link to 5.12 Transform Schema" translate="no">​</a></h3>
<ul>
<li class=""><code>transformDefinitionSchema</code> captures deterministic conversions sitting between
generators and prestige resets, satisfying the “transforms” requirement in
<code>docs/idle-engine-design.md</code> §6:<!-- -->
<ul>
<li class=""><code>id</code>: <code>contentIdSchema</code>.</li>
<li class=""><code>name</code>: <code>localizedTextSchema</code>.</li>
<li class=""><code>description</code>: <code>localizedSummarySchema</code> clarifying the conversion behaviour.</li>
<li class=""><code>mode</code>: enum (<code>instant</code>, <code>continuous</code>, <code>batch</code>) expressing whether the
transform fires once, ticks every simulation step, or processes a finite
batch when triggered.</li>
<li class=""><code>inputs</code>: non-empty array of <code>{ resourceId: ContentId; amount: NumericFormula }</code>.</li>
<li class=""><code>outputs</code>: non-empty array of <code>{ resourceId: ContentId; amount: NumericFormula }</code>.</li>
<li class=""><code>duration</code>: optional <code>NumericFormula</code> (ms) for timed conversions (required
for <code>batch</code> mode).</li>
<li class=""><code>cooldown</code>: optional <code>NumericFormula</code> enforcing time between runs.</li>
<li class=""><code>trigger</code>: discriminated union describing how the transform activates:<!-- -->
<ul>
<li class=""><code>manual</code>: <code>{ kind: &#x27;manual&#x27; }</code> for player-driven conversions.</li>
<li class=""><code>automation</code>: <code>{ kind: &#x27;automation&#x27;; automationId: ContentId }</code>
referencing an automation toggle that fires the transform.<sup><a href="#user-content-fn-core-automation-tests" id="user-content-fnref-core-automation-tests" data-footnote-ref="true" aria-describedby="footnote-label" class="anchorTargetStickyNavbar_EdDC">4</a></sup></li>
<li class=""><code>condition</code>: <code>{ kind: &#x27;condition&#x27;; condition: Condition }</code> for inline
predicates.</li>
<li class=""><code>event</code>: <code>{ kind: &#x27;event&#x27;; eventId: ContentId }</code> bundling runtime event
identifiers.</li>
</ul>
</li>
<li class=""><code>unlockCondition</code>: optional <code>conditionSchema</code>.</li>
<li class=""><code>visibilityCondition</code>: optional <code>conditionSchema</code>.</li>
<li class=""><code>automation</code>: optional <code>{ automationId: ContentId }</code> linking to automation
toggles for hands-off operation. When <code>trigger.kind === &#x27;automation&#x27;</code> this
block is required and must reference the same canonical id.</li>
<li class=""><code>tags</code>: array for analytics/UX filters.</li>
<li class=""><code>safety</code>: optional guard specifying <code>maxRunsPerTick</code> and
<code>maxOutstandingBatches</code> so the runtime clamps runaway loops deterministically.</li>
<li class=""><code>order</code>: optional float allowing authors to stabilise transform ordering in
menus.</li>
</ul>
</li>
<li class="">Validation confirms every transform references declared resources, batch modes
declare a finite <code>duration</code>, continuous transforms specify at least one
consumption or production rate, and the signed sum of input/output rates stays
finite to protect hashing. When <code>trigger.kind === &#x27;automation&#x27;</code> the validator
ensures the embedded <code>automationId</code> exists and, when the optional <code>automation</code>
block is present, that both references match. Event-triggered transforms verify
<code>eventId</code> against the runtime contributions defined in §5.15.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="513-prestige-layer-schema">5.13 Prestige Layer Schema<a href="#513-prestige-layer-schema" class="hash-link" aria-label="Direct link to 5.13 Prestige Layer Schema" title="Direct link to 5.13 Prestige Layer Schema" translate="no">​</a></h3>
<ul>
<li class=""><code>prestigeLayerSchema</code> supports reset mechanics:<!-- -->
<ul>
<li class=""><code>id</code>, <code>name</code>, <code>icon</code>.</li>
<li class=""><code>summary</code>: <code>localizedTextSchema</code>.</li>
<li class=""><code>resetTargets</code>: array of resource ids reset when the layer triggers.</li>
<li class=""><code>unlockCondition</code>: <code>conditionSchema</code>.</li>
<li class=""><code>reward</code>: block specifying output currency <code>{ resourceId, baseReward: NumericFormula, multiplierCurve?: NumericFormula }</code>.</li>
<li class=""><code>retention</code>: optional array describing retained resources/upgrades.</li>
<li class=""><code>automation</code>: optional reference enabling auto-prestige triggers.</li>
<li class=""><code>order</code>: optional float for menu ordering.</li>
</ul>
</li>
<li class="">Validation enforces that prestige rewards reference prestige-class resources
and that reset targets cover at least one non-prestige resource.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="514-guild-perk-schema">5.14 Guild Perk Schema<a href="#514-guild-perk-schema" class="hash-link" aria-label="Direct link to 5.14 Guild Perk Schema" title="Direct link to 5.14 Guild Perk Schema" translate="no">​</a></h3>
<ul>
<li class=""><code>guildPerkSchema</code> provides hooks for social systems:<!-- -->
<ul>
<li class=""><code>id</code>: <code>contentIdSchema</code>.</li>
<li class=""><code>name</code>: <code>localizedTextSchema</code>.</li>
<li class=""><code>description</code>: <code>localizedTextSchema</code>.</li>
<li class=""><code>category</code>: enum (<code>buff</code>, <code>utility</code>, <code>cosmetic</code>).</li>
<li class=""><code>maxRank</code>: positive integer.</li>
<li class=""><code>effects</code>: union aligned with upgrade effects plus guild-specific entries
(<code>modifyGuildStorage</code>, <code>unlockGuildAutomation</code>).</li>
<li class=""><code>cost</code>: block referencing guild currency or contribution metrics.</li>
<li class=""><code>unlockCondition</code>: <code>conditionSchema</code> (allowing milestones or campaign
progress).</li>
<li class=""><code>order</code>: optional float coordinating perk list ordering with prestige and
upgrade entries.</li>
<li class=""><code>visibilityCondition</code>.</li>
</ul>
</li>
<li class="">Guild perks can be optional for prototype packs; schema allows empty arrays.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="515-runtime-event-contribution-schema">5.15 Runtime Event Contribution Schema<a href="#515-runtime-event-contribution-schema" class="hash-link" aria-label="Direct link to 5.15 Runtime Event Contribution Schema" title="Direct link to 5.15 Runtime Event Contribution Schema" translate="no">​</a></h3>
<ul>
<li class="">Content packs augment the runtime event catalogue documented in
<code>docs/runtime-event-pubsub-design.md</code> and
<code>docs/runtime-event-manifest-authoring.md</code>. The schema ensures authored
entries align with the manifest generator responsible for producing
<code>GENERATED_RUNTIME_EVENT_DEFINITIONS</code>:<!-- -->
<ul>
<li class=""><code>id</code>: <code>contentIdSchema</code>, derived from the canonical runtime event type
<code>namespace:name</code>. Authors may omit the field; when provided the
schema verifies the value matches the derived identifier before emitting the
canonical lowercased string.</li>
<li class=""><code>namespace</code>: trimmed slug (≤32 chars) for grouping related events.</li>
<li class=""><code>name</code>: trimmed string (≤48 chars) matching runtime naming conventions.</li>
<li class=""><code>version</code>: positive integer bumped whenever payload compatibility changes.</li>
<li class=""><code>payload</code>: discriminated union:<!-- -->
<ul>
<li class=""><code>zod</code>: <code>{ kind: &#x27;zod&#x27;; schemaPath: string }</code> referencing a TypeScript
module exporting a Zod schema.</li>
<li class=""><code>jsonSchema</code>: <code>{ kind: &#x27;json-schema&#x27;; schemaPath: string }</code> referencing a
JSON Schema document consumed by the generator.</li>
</ul>
</li>
<li class=""><code>emits</code>: optional array of <code>{ source: &#x27;achievement&#x27; | &#x27;upgrade&#x27; | &#x27;transform&#x27; | &#x27;script&#x27;; id: ContentId }</code>
documenting which content entries publish the event (surfaced in generated
docs).</li>
<li class=""><code>tags</code>: optional analytics strings.</li>
</ul>
</li>
<li class="">Normalisation always emits the canonical id (<code>namespace:name</code>) even when
authors omit the field so downstream references have a single stable key.</li>
<li class="">Validation ensures schema paths remain pack-relative (rejecting absolute and
parent-directory escapes), <code>version</code> increments monotonically under
normalisation, and <code>emits</code> references existing content ids so manifest
documentation can hyperlink back into DSL definitions. File-system existence
checks continue to live in <code>tools/content-schema-cli</code>, which already loads the
manifests and schema documents during <code>pnpm generate</code>, so the schema package
stays environment-agnostic while tooling preserves the authoring guarantees
documented in <code>docs/runtime-event-manifest-authoring.md</code>. Parsed
contributions feed the merge pipeline, which recomputes manifest hashes
alongside runtime events to keep replay safeguards intact.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="516-content-pack-root-schema">5.16 Content Pack Root Schema<a href="#516-content-pack-root-schema" class="hash-link" aria-label="Direct link to 5.16 Content Pack Root Schema" title="Direct link to 5.16 Content Pack Root Schema" translate="no">​</a></h3>
<ul>
<li class=""><code>contentPackSchema</code> composes the module schemas for structural validation and
type inference. The exported instance stays stateless so downstream tooling
can call <code>contentPackSchema.parse</code> without inheriting warning collectors or
runtime assumptions. This mirrors Zod&#x27;s immutable API contract where methods
always return new schema instances (<a href="https://raw.githubusercontent.com/colinhacks/zod/master/packages/zod/README.md#L86" target="_blank" rel="noopener noreferrer" class="">Zod README</a>).</li>
<li class="">A validator factory wraps the base schema with cross-reference checks,
normalisation, and warning aggregation. The allowlist inputs accept either
arrays or sets so CLI JSON/YAML configs remain ergonomic (JSON cannot encode
<code>Set</code> values without custom replacers per
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify" target="_blank" rel="noopener noreferrer" class="">MDN</a>):</li>
<li class=""><code>ContentSchemaOptions.runtimeEventCatalogue</code> lets callers provide the core
runtime event identifiers (for example, the union exported from
<code>GENERATED_RUNTIME_EVENT_DEFINITIONS</code>) so the validator can flag dangling
<code>onUnlockEvents</code> without importing <code>@idle-engine/core</code>:</li>
<li class=""><code>ContentSchemaOptions.activePackIds</code> lists pack slugs already installed in
the authoring environment; optional dependencies missing from this concrete
set emit warnings instead of quietly passing validation.</li>
</ul>
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// z imported from &#x27;zod&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">ContentId</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">infer</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> contentIdSchema</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">PackId</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">infer</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> packSlugSchema</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">AllowlistEntries</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ReadonlySet</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">AllowlistSpecInput</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> required</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AllowlistEntries</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> soft</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AllowlistEntries</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">NormalizedAllowlistSpec</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> required</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlySet</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> soft</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlySet</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">SchemaWarningSeverity</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;error&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;warning&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;info&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">SchemaWarning</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> code</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> severity</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SchemaWarningSeverity</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> suggestion</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> issues</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZodIssue</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ContentSchemaOptions</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> allowlists</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> flags</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AllowlistSpecInput</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> scripts</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AllowlistSpecInput</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> systemAutomationTargets</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AllowlistSpecInput</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> runtimeVersion</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> knownPacks</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> PackId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> version</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> requires</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> packId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> PackId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> version</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> runtimeEventCatalogue</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AllowlistEntries</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> activePackIds</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AllowlistEntries</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> warningSink</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">warning</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SchemaWarning</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ContentPackValidationResult</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> pack</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> NormalizedContentPack</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> warnings</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> SchemaWarning</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">ContentPackInput</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">input</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> baseContentPackSchema</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">ContentPackSafeParseSuccess</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> success</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> data</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentPackValidationResult</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">ContentPackSafeParseFailure</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> success</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> error</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZodError</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentPackInput</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">ContentPackSafeParseResult</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ContentPackSafeParseSuccess</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ContentPackSafeParseFailure</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> toArray </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entries</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AllowlistEntries </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  entries </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token builtin">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entries</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> normalizeAllowlistEntries </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  entries</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AllowlistEntries </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  schema</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZodType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  severity</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SchemaWarningSeverity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">warningSink</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">warning</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SchemaWarning</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pathPrefix</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlySet</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> normalized </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Set</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name builtin">string</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> issues</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZodIssue</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">toArray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entries</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> schema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">safeParse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> entryPath </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">...</span><span class="token plain">pathPrefix</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">severity </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;error&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> issue </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">issues</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          issues</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">issue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">...</span><span class="token plain">entryPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">issue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">warningSink</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        code</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> severity </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;warning&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;allowlist.invalidSoftEntry&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;allowlist.invalidEntry&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Allowlist entry &quot;</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">value</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">&quot; failed validation.</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> entryPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        severity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        issues</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">issues</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    normalized</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">severity </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;error&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> issues</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ZodError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">issues</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> normalized</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> normalizeAllowlistSpec </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spec</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AllowlistSpecInput </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  schema</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZodType</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">warningSink</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">warning</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SchemaWarning</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pathPrefix</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> NormalizedAllowlistSpec </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  required</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">normalizeAllowlistEntries</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">required</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schema</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;error&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    warningSink</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">...</span><span class="token plain">pathPrefix</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;required&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  soft</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">normalizeAllowlistEntries</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">soft</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schema</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;warning&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    warningSink</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">...</span><span class="token plain">pathPrefix</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;soft&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> normalizeRuntimeEventCatalogue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  entries</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AllowlistEntries </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlySet</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">toArray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entries</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eventType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> contentIdSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">parse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eventType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> normalizeActivePackIds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  entries</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AllowlistEntries </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlySet</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">PackId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">toArray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entries</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">packId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> packSlugSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">parse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">packId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Reusing `contentIdSchema` keeps runtime catalogue entries canonicalised, so</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// downstream comparisons against author-supplied ids remain case-insensitive.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Invalid allowlist entries become contextual warnings for `soft` sets, while</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// `required` entries accumulate their underlying `ZodIssue`s and raise a fresh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// `ZodError` whose paths point at `options.allowlists.&lt;key&gt;.required[index]`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// This mirrors Zod’s guidance on surfacing issues from effects</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// (`superRefine` / `safeParse`) without discarding the enriched path metadata or</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// halting validation after the first failure.[^zod-superrefine]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">FEATURE_GATES</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    module</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;automations&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    introducedIn</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;0.2.0&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    docRef</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;docs/idle-engine-design.md (§9, §18)&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    module</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;transforms&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    introducedIn</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;0.3.0&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    docRef</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;docs/idle-engine-design.md (§6)&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    module</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;runtimeEvents&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    introducedIn</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;0.3.0&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    docRef</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;docs/runtime-event-pubsub-design.md&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    module</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;prestigeLayers&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    introducedIn</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;0.4.0&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    docRef</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;docs/idle-engine-design.md (§6, §18)&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    module</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;guildPerks&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    introducedIn</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;0.5.0&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    docRef</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;docs/idle-engine-design.md (§18)&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>The helper functions in <code>runtime-compat.ts</code> expose <code>resolveFeatureViolations( runtimeVersion, pack)</code> so <code>validateCrossReferences</code> can emit structured errors
for unsupported modules while still allowing the CLI to display contextual
documentation links.</p>
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> baseContentPackSchema </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> metadataSchema</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resourceDefinitionSchema</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    generators</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">generatorDefinitionSchema</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    upgrades</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">upgradeDefinitionSchema</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metrics</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">metricDefinitionSchema</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">default</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    achievements</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">achievementDefinitionSchema</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">default</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    automations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automationDefinitionSchema</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">default</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    transforms</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">transformDefinitionSchema</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">default</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prestigeLayers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prestigeLayerSchema</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">default</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    guildPerks</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">guildPerkSchema</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">default</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    runtimeEvents</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">runtimeEventContributionSchema</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">default</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">strict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> contentPackSchema </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> baseContentPackSchema</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">buildContentPackEffectsSchema</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentSchemaOptions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">warningSink</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">warning</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SchemaWarning</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  baseContentPackSchema</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">superRefine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pack</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">validateCrossReferences</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pack</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        allowlists</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allowlists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              flags</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">normalizeAllowlistSpec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allowlists</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                flagIdSchema</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                warningSink</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;options&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;allowlists&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;flags&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              scripts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">normalizeAllowlistSpec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allowlists</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scripts</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                scriptIdSchema</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                warningSink</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;options&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;allowlists&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;scripts&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              systemAutomationTargets</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">normalizeAllowlistSpec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allowlists</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">systemAutomationTargets</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                systemAutomationTargetIdSchema</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                warningSink</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;options&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;allowlists&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;systemAutomationTargets&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        warningSink</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        runtimeEventCatalogue</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">normalizeRuntimeEventCatalogue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">runtimeEventCatalogue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        runtimeVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">runtimeVersion</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        activePackIds</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">normalizeActivePackIds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">activePackIds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pack</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">normalizeContentPack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pack</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        runtimeVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">runtimeVersion</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        warningSink</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">createContentPackValidator</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentSchemaOptions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">parse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">unknown</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentPackValidationResult </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> warnings</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SchemaWarning</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">sink</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">warning</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SchemaWarning</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      warnings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">warning</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">warningSink</span><span class="token operator" style="color:#393A34">?.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">warning</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> schema </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">buildContentPackEffectsSchema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sink</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> pack </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> schema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">parse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> pack</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> warnings </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">safeParse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">unknown</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentPackSafeParseResult </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> warnings</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SchemaWarning</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">sink</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">warning</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SchemaWarning</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      warnings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">warning</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">warningSink</span><span class="token operator" style="color:#393A34">?.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">warning</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> schema </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">buildContentPackEffectsSchema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sink</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> schema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">safeParse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> success</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentPackSafeParseSuccess </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        success</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> pack</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> warnings </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> success</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> failure</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentPackSafeParseFailure </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      success</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      error</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> failure</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> parseContentPack </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  input</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">unknown</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentSchemaOptions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentPackValidationResult </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">createContentPackValidator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">parse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<ul>
<li class=""><code>runtime-compat.ts</code> hosts the feature gate matrix consumed by the validator.
Helper utilities such as <code>resolveFeatureViolations(runtimeVersion, pack)</code>
surface structured errors with links back to <code>docs/idle-engine-design.md</code> and
<code>docs/runtime-event-pubsub-design.md</code> so authors understand when newer modules
require runtime upgrades.</li>
<li class="">Consumers that need cross-reference enforcement, normalisation, or warnings
use <code>createContentPackValidator().parse</code> (or <code>parseContentPack</code>). Every call
composes a fresh <code>ZodEffects</code> instance, preserving Zod&#x27;s immutable guarantees
and avoiding shared mutable state even when runs happen concurrently.</li>
<li class=""><code>safeParse</code> mirrors the standard Zod API: successful parses return the
normalised pack plus collected warnings, while failures surface the
<code>ZodError&lt;ContentPackInput&gt;</code> emitted by <code>SafeParseReturnType&lt;Input, Output&gt;</code>
so callers receive error paths in terms of the authored payload<sup><a href="#user-content-fn-zod-safeparse" id="user-content-fnref-zod-safeparse" data-footnote-ref="true" aria-describedby="footnote-label" class="anchorTargetStickyNavbar_EdDC">5</a></sup>.
Direct calls to
<code>contentPackSchema.parse</code> remain available for structural checks only (no
cross-reference analysis or warnings).</li>
</ul>
<ul>
<li class=""><code>validateCrossReferences</code> performs:<!-- -->
<ul>
<li class="">Id uniqueness within each module. Resources, generators, upgrades, metrics,
achievements, automations, transforms, prestige layers, guild perks, and
runtime events reject duplicate slugs inside their respective arrays, while
cross-module reuse remains legal so content authors can intentionally mirror
naming (for example, keeping an automation toggle slug aligned with the
resource it affects). Reserved namespaces (such as the
<code>idle-engine/</code> prefix) are still blocked globally.</li>
<li class="">Ensuring conditions reference defined ids across resources, generators,
upgrades, prestige layers, and allowlisted flags and scripts; additional
condition variants will extend this graph as new predicates ship.</li>
<li class="">Verifying generator <code>produces</code> / <code>consumes</code> entries, upgrade <code>targets</code> and
<code>effects</code> (by <code>kind</code>), metric bindings, achievement <code>track</code> handles,
automation
<code>targetId</code>/<code>systemTargetId</code> and event-trigger handles, transform
<code>inputs</code>/<code>outputs</code> plus optional <code>automationId</code>, runtime event <code>emits</code>
handles, and prestige reset/reward resources resolve against
declared entities, matching the pipeline guarantees laid out in
<code>docs/idle-engine-design.md</code> §10.</li>
<li class="">Checking <code>customMetric</code> achievement tracks and automation/resource bindings
against the pack&#x27;s metric catalogue, verifying metric <code>source</code> hooks (e.g.,
script bindings) against the relevant allowlists, emitting errors when
references are missing, and warnings when metrics declare attribute sets
exceeding three keys (to deter high-cardinality exports).</li>
<li class="">Enforcing runtime feature gates by comparing the parsed pack to the
<code>FEATURE_GATES</code> map. When <code>ContentSchemaOptions.runtimeVersion</code> is provided,
modules declared in the pack must satisfy their minimum runtime ranges; the
validator emits errors for hard violations and warnings when the pack relies
on features newer than the supplied runtime.</li>
<li class="">Validating <code>metadata.dependencies</code> by checking for self-references, duplicate
pack ids, conflicting version ranges, and dependency cycles. When callers
supply <code>ContentSchemaOptions.knownPacks</code>, the validator merges the pack&#x27;s
<code>requires</code> edges with the known graph (using the optional
<code>requires</code> metadata on each known pack) to detect multi-pack cycles and flag
incompatible version ranges. When <code>knownPacks</code> lacks an entry for a declared
dependency, the validator records a warning (so unpublished packs remain
authorable) while still catching self-references and duplicate ids.
Optional dependencies compare against <code>options.activePackIds</code>; entries
missing from that concrete set emit <code>optionalDependency.missing</code> warnings,
while absent context downgrades the check to an informational note.</li>
<li class="">Detecting orphaned prestige currencies (reward resources marked prestige but
not defined).</li>
<li class="">Blocking ids that attempt to use engine-reserved namespace segments (e.g.,
an <code>idle-engine/</code> prefix), complementing the <code>contentIdSchema</code> slug rules.</li>
<li class="">Resolving <code>flag</code> and <code>script</code> conditions against the caller-provided
allowlists using their canonical slug forms, treating ids in the <code>required</code>
sets as hard dependencies while emitting warnings when lookups fail for
entries marked <code>soft</code>. Invalid allowlist entries are caught during
normalisation via the <code>allowlist.invalid*</code> warning codes so misconfigured
options surface as structured errors instead of exploding during schema
construction. The same lookups cover <code>grantFlag</code> upgrade effects and
achievement rewards so flags cannot be granted unless they are declared in
the active allowlist.</li>
<li class="">Rejecting runtime event contributions whose canonical id collides with an
entry in the caller-supplied catalogue (including core manifests). The
runtime bus refuses duplicate registrations already
(<code>packages/core/src/events/event-bus.ts:330</code>), so catching collisions during
schema validation keeps packs from producing manifests that would fail at
bootstrap time.</li>
<li class="">Confirming <code>achievementDefinition.onUnlockEvents</code> ids exist in the merged
runtime event catalogue built from the pack&#x27;s own contributions plus the
caller-supplied <code>ContentSchemaOptions.runtimeEventCatalogue</code>. When the
catalogue is provided, missing ids become structured errors so packs cannot
ship dangling hooks into the event bus defined in
<code>docs/runtime-event-pubsub-design.md</code>; if the caller omits the catalogue, the
validator emits warnings instead to keep authoring possible before the core
manifest is available locally.</li>
<li class="">Detecting cyclic dependencies across unlock and visibility conditions by
constructing a monotonic dependency graph. Nodes cover the entity classes
that conditions can reference directly (<code>resources</code>, <code>generators</code>,
<code>upgrades</code>, <code>prestigeLayers</code>, plus allowlisted <code>flags</code>/<code>scripts</code>) and extend
to <code>automations</code>, <code>transforms</code>, <code>guildPerks</code>, and <code>achievements</code> through the
derived relationships captured elsewhere in the schema (for example upgrade
<code>targets</code>, automation bindings, and transform references). Positive
predicates (thresholds, ownership, allowlisted flags/scripts) and the
derived relationships above produce graph edges. Negated predicates and
<code>anyOf</code> disjunction branches remain advisory constraints and are excluded
from the strongly connected component walk, preventing absence-based gating
from masquerading as a positive cycle. Depth-first search with path tracking
raises a structured error when a positive loop (<code>A → B → … → A</code>) is
discovered, pointing at the chain of ids that must be broken.</li>
<li class="">Walking every <code>numericFormulaSchema</code> node—including nested <code>piecewise</code>
segments, expression trees, and function call arguments—to collect
<code>{ target: { type, id } }</code> references. Each referenced id is validated
against the same lookup tables used for conditions, guaranteeing that
authored formulas cannot silently reference undefined resources, generators,
upgrades, automations, or prestige layers.</li>
<li class="">Emitting warnings (captured via <code>SchemaWarning</code> array) for soft issues such
as steep cost curves or missing localisation variants.</li>
</ul>
</li>
<li class=""><code>normalizeContentPack</code> sorts arrays deterministically, injects derived lookup
maps, applies default booleans, and produces hashes used by the compiler.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="517-normalisation--derived-artifacts">5.17 Normalisation &amp; Derived Artifacts<a href="#517-normalisation--derived-artifacts" class="hash-link" aria-label="Direct link to 5.17 Normalisation &amp; Derived Artifacts" title="Direct link to 5.17 Normalisation &amp; Derived Artifacts" translate="no">​</a></h3>
<ul>
<li class=""><code>normalizeContentPack</code> returns a <code>NormalizedContentPack</code>:</li>
</ul>
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">ContentId</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">infer</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> contentIdSchema</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">PackId</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">infer</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> packSlugSchema</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">NormalizedContentPack</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> metadata</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> NormalizedMetadata</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> resources</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedResource</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> generators</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedGenerator</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> upgrades</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedUpgrade</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> metrics</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedMetric</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> achievements</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedAchievement</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> automations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedAutomation</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> transforms</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedTransform</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> prestigeLayers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedPrestigeLayer</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> guildPerks</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedGuildPerk</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> runtimeEvents</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> NormalizedRuntimeEventContribution</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> lookup</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> resources</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedResource</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> generators</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedGenerator</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> upgrades</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedUpgrade</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> metrics</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedMetric</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> achievements</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedAchievement</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> automations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedAutomation</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> transforms</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedTransform</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> prestigeLayers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedPrestigeLayer</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> guildPerks</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedGuildPerk</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> runtimeEvents</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadonlyMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ContentId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      NormalizedRuntimeEventContribution</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> serializedLookup</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> resourceById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedResource</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> generatorById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedGenerator</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> upgradeById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedUpgrade</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> metricById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedMetric</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> achievementById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedAchievement</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> automationById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedAutomation</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> transformById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedTransform</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> prestigeLayerById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedPrestigeLayer</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> guildPerkById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedGuildPerk</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> runtimeEventById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NormalizedRuntimeEventContribution</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> digest</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> version</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> hash</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ul>
<li class=""><code>normalizeContentPack</code> accepts a <code>NormalizationContext</code> containing the active
runtime version (for compatibility checks) and the shared warning sink used
by cross-reference validation.</li>
<li class=""><code>NormalizedMetadata</code> preserves the <code>PackId</code> brand on <code>id</code>, keeping downstream
dependency graphs scoped-id aware.</li>
<li class="">Lookup maps retain the <code>ContentId</code> brand by exposing immutable <code>ReadonlyMap</code>
instances for every module (resources, generators, upgrades, metrics,
achievements, automations, transforms, prestige layers, guild perks, runtime
events). <code>serializedLookup</code> carries the downgraded <code>Record&lt;string, …&gt;</code> copies
used when emitting JSON so transport layers can remain brand-agnostic without
polluting consumer types. Helper utilities convert between the two
representations when persisting or hydrating packs.</li>
<li class="">With metadata already parsed, <code>normalizeContentPack</code> threads the resulting
<code>NormalizedMetadata</code> into <code>normalizeLocalizedText</code> calls for titles, names,
summaries, and descriptions so locale mirroring and missing-translation
warnings stay consistent across modules.</li>
<li class="">Metric normalisation emits <code>NormalizedMetric</code> entries with sorted attribute
keys, deduplicated values, the <code>&#x27;1&#x27;</code> unit fallback, and resolved source
bindings so telemetry exports and CLI reports stay deterministic.</li>
<li class="">Digests use FNV-1a hashing aligned with runtime manifest hashing. Version
increments whenever schema-breaking transformations occur. The hash excludes
transient warning data so identical author input yields stable digests even
when the warning set changes.</li>
<li class="">Warnings follow the <code>SchemaWarning</code> contract (<code>{ code, message, path, severity, suggestion?, issues? }</code>) to support CLI displays and are returned
alongside the normalized pack by the validator factory instead of being
embedded in the normalized structure.</li>
<li class="">Normalisation ensures arrays apply author-specified ordering keys when they
exist (<code>order</code> on resources/generators/upgrades/metrics/automations/transforms/
prestige/guild perks and <code>displayOrder</code> on achievements) and then fall back to
canonical id comparisons, providing deterministic ties when authors omit
explicit ordering. This avoids relying on JavaScript engine sort stability,
keeps digests repeatable across runtimes, strips duplicate tags, and freezes
string casing (ids lowercased, labels preserved). Helper utilities serialise
the <code>ReadonlyMap</code> lookups into the accompanying <code>serializedLookup</code> object for
persistence, and hydrate them back into branded maps when content packs are
loaded.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="518-implementation-plan">5.18 Implementation Plan<a href="#518-implementation-plan" class="hash-link" aria-label="Direct link to 5.18 Implementation Plan" title="Direct link to 5.18 Implementation Plan" translate="no">​</a></h3>
<ol>
<li class="">Scaffold <code>packages/content-schema</code> with base tooling (tsconfig, lint, test).</li>
<li class="">Implement scalar schemas (<code>ids</code>, <code>numbers</code>, <code>localization</code>) with unit tests.</li>
<li class="">Land <code>numericFormulaSchema</code> and <code>conditionSchema</code>, including recursion guard
tests and snapshot fixtures.</li>
<li class="">Implement module schemas incrementally with targeted validation tests:<!-- -->
<ul>
<li class=""><code>metadata</code> (including <code>dependencies</code>), <code>resources</code>, <code>generators</code>,
<code>upgrades</code>, <code>metrics</code>, <code>achievements</code>, <code>automations</code>, <code>transforms</code>,
<code>prestige</code>, <code>guild-perks</code>.</li>
</ul>
</li>
<li class="">Add the runtime event contribution schema and manifest validation that
mirrors <code>docs/runtime-event-manifest-authoring.md</code>, including fixtures for
invalid schema paths and duplicate ids.</li>
<li class="">Compose <code>contentPackSchema</code>, wire up <code>createContentPackValidator</code> with a
shared warning collector, implement <code>validateCrossReferences</code> (including the
numeric-formula reference walk and cross-module cycle detector), and add
failing fixtures covering duplicate ids, missing references, invalid
formulas, and intertwined unlock loops.</li>
<li class="">Implement <code>normalizeContentPack</code>, compute digests, and expose typed lookup
maps.</li>
<li class="">Update <code>tools/content-schema-cli</code> to consume the new package (follow-up PR),
mirroring the structured error responses already used by social service
routes. Wire validation into <code>pnpm test --filter content-schema</code> and add a
lightweight <code>pnpm generate</code> step that refreshes schema digests alongside the
event manifest pipeline.</li>
<li class="">Port <code>packages/content-sample</code> to validate via the schema in a separate
change once the package stabilises.</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="519-authoring-best-practices">5.19 Authoring Best Practices<a href="#519-authoring-best-practices" class="hash-link" aria-label="Direct link to 5.19 Authoring Best Practices" title="Direct link to 5.19 Authoring Best Practices" translate="no">​</a></h3>
<ul>
<li class="">Provide human-readable error summaries and include <code>path</code> data so CLI
consumers can surface issues consistently with existing Express handlers.</li>
<li class="">Memoise normalised lookup maps between CLI runs to reduce validation latency
for large packs.</li>
<li class="">Normalise casing and deterministically sort arrays before hashing so content
digests align with <code>docs/runtime-event-manifest-authoring.md</code>.</li>
<li class="">Document schema additions in <code>docs/idle-engine-design.md</code> and call out
migrations in <code>docs/implementation-plan.md</code> to keep the DSL contract in sync
with runtime workstreams.</li>
<li class="">Run <code>pnpm generate</code> after editing pack sources; the CLI validates packs via <code>@idle-engine/content-schema</code>, then compiles artifacts once validation succeeds, emitting structured JSON log entries (<code>content_pack.validated</code>, <code>content_pack.validation_failed</code>, <code>content_pack.compiled</code>, <code>watch.run</code>, etc.) for downstream automation.</li>
<li class="">Use <code>pnpm generate --check</code> in CI, Lefthook, and verification scripts to detect drift without rewriting artifacts. <code>--watch</code> keeps the pipeline alive during authoring but still marks failures while emitting <code>watch.run</code> summaries so you can fix issues before exit.</li>
<li class="">Treat <code>content/compiled/index.json</code> (or any path supplied via <code>--summary</code>) as the canonical workspace summary. If validation fails or the CLI reports drift, rerun <code>pnpm generate</code> before consuming the summary or committing compiled artifacts to avoid shipping stale data.</li>
<li class="">Keep authoring sources in <code>&lt;package&gt;/content/pack.json</code>, resolve warnings before publishing, and annotate intentional suppressions so migration scripts can distinguish deliberate exceptions from regressions.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="6-testing-strategy">6. Testing Strategy<a href="#6-testing-strategy" class="hash-link" aria-label="Direct link to 6. Testing Strategy" title="Direct link to 6. Testing Strategy" translate="no">​</a></h2>
<ul>
<li class="">Unit tests for each schema module covering success and failure cases, ensuring
error messages include context (id, field path, offending value).</li>
<li class="">Property-based tests for <code>numericFormulaSchema</code> ensuring generated exponential
or linear curves remain finite and monotonic where required.</li>
<li class="">Integration fixtures for full packs: valid sample pack, pack missing resource
references, pack with cyclic unlock conditions, pack with localisation gaps,
pack with dependency cycles, and pack with invalid runtime event contributions
(missing schema paths or duplicate ids).</li>
<li class="">Validator factory tests ensure <code>createContentPackValidator</code> returns collected
warnings (missing translations, flagged scripts) alongside normalised packs.</li>
<li class="">Snapshot tests for <code>normalizeContentPack</code> verifying deterministic ordering and
digest stability.</li>
<li class="">Type-level tests (using <code>expectTypeOf</code>) to ensure inferred types align with
runtime expectations.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="7-risks--mitigations">7. Risks &amp; Mitigations<a href="#7-risks--mitigations" class="hash-link" aria-label="Direct link to 7. Risks &amp; Mitigations" title="Direct link to 7. Risks &amp; Mitigations" translate="no">​</a></h2>
<ul>
<li class=""><strong>Formula explosion</strong>: Recursive expression parsing may allow deeply nested
structures, risking performance issues. Mitigate with recursion depth limits
and AST node count caps inside <code>expressionNodeSchema</code>.</li>
<li class=""><strong>Schema drift vs runtime</strong>: Runtime may evolve faster than schema updates.
Mitigate by adding CI checks that <code>@idle-engine/core</code> validates resource
definitions against the schema digest before publish.</li>
<li class=""><strong>Author friction</strong>: Strict schemas may frustrate early adopters. Mitigate
with descriptive error messages and non-fatal warnings for soft constraints.</li>
<li class=""><strong>Compatibility versioning</strong>: Packs targeting older runtime versions must
continue to parse. Mitigate by versioning schema transforms and allowing the
compiler to downgrade gracefully when <code>metadata.engine</code> excludes new features.</li>
<li class=""><strong>Transform loops</strong>: Misconfigured transforms may create runaway production
chains. Mitigate by enforcing <code>safety</code> guards in the schema and covering loop
detection in integration tests.</li>
<li class=""><strong>Performance</strong>: Running complex validation on large content packs could be
slow. Mitigate by caching normalised results and reusing lookup maps between
CLI runs.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="8-decisions--clarifications">8. Decisions &amp; Clarifications<a href="#8-decisions--clarifications" class="hash-link" aria-label="Direct link to 8. Decisions &amp; Clarifications" title="Direct link to 8. Decisions &amp; Clarifications" translate="no">​</a></h2>
<ul>
<li class="">Ids are case-insensitive in validation but canonicalised to lowercase for
deterministic hashing; <code>contentIdSchema</code> performs the lowercasing transform
so display casing belongs exclusively in localisation strings.</li>
<li class="">Pack metadata and dependency edges use <code>packSlugSchema</code>, allowing scoped
identifiers such as <code>@idle-engine/core</code> while other module ids continue to
rely on the stricter <code>contentIdSchema</code>.</li>
<li class="">Schemas reject unknown keys to catch typos early; authors must explicitly
include new fields when the schema evolves.</li>
<li class="">Localised strings require at least the default locale; additional variants are
optional but flagged when missing for locales declared in
<code>metadata.supportedLocales</code>.</li>
<li class="">Numeric formulas accept finite numbers only; <code>Infinity</code> is modelled through
explicit flags (<code>capacity: null</code>) instead of raw numeric values.</li>
<li class="">Warnings are returned alongside the normalised payload; it is up to CLI and
compiler tooling to decide whether to treat specific warning codes as errors.</li>
<li class="">Lookup tables are serialized as plain objects for transport; helper utilities
create transient <code>Map</code> views when callers need richer ergonomics.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="9-acceptance-criteria">9. Acceptance Criteria<a href="#9-acceptance-criteria" class="hash-link" aria-label="Direct link to 9. Acceptance Criteria" title="Direct link to 9. Acceptance Criteria" translate="no">​</a></h2>
<ul>
<li class=""><code>packages/content-schema</code> exists with exported schemas, inferred types, and
Vitest coverage across every module (metadata + dependencies, resources,
generators, upgrades, metrics, achievements, automations, transforms, prestige,
guild perks, runtime event contributions).</li>
<li class=""><code>createContentPackValidator.parse</code> (and the exported <code>parseContentPack</code>
helper) validate sample fixtures, emit expected warnings, and produce deterministic
normalised output with digest metadata, serialisable lookup objects, and
branded <code>ContentId</code> keyed maps.</li>
<li class="">Cross-reference validation rejects packs with missing or duplicate ids,
dangling conditions, invalid formula references, runtime event contributions
that cite unknown emitters, and dependency cycles whenever the caller
provides sufficient <code>knownPacks.requires</code> data to build the cross-pack graph.</li>
<li class="">Runtime compatibility gates reject packs that include modules introduced after
the target runtime (<code>ContentSchemaOptions.runtimeVersion</code>), while emitting
contextual warnings when the pack straddles newer features.</li>
<li class="">Achievement <code>onUnlockEvents</code> lists are validated against the merged runtime
event catalogue so packs cannot ship dangling hooks.</li>
<li class="">Localisation checks ensure <code>metadata.supportedLocales</code> lists are honoured and
missing variants surface as structured warnings.</li>
<li class="">Documentation updates link this design with <code>docs/implementation-plan.md</code>
and <code>docs/idle-engine-design.md</code>.</li>
<li class="">A follow-up work item is opened to integrate the schema into
<code>tools/content-schema-cli</code> and the sample content pack.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="10-open-questions--follow-ups">10. Open Questions &amp; Follow-Ups<a href="#10-open-questions--follow-ups" class="hash-link" aria-label="Direct link to 10. Open Questions &amp; Follow-Ups" title="Direct link to 10. Open Questions &amp; Follow-Ups" translate="no">​</a></h2>
<ul>
<li class="">Should the schema expose calculated presentation defaults (e.g., auto-generated
icon paths) or leave that to the compiler?</li>
<li class="">How will guild perk costs interface with social-service data when live
persistence lands?</li>
<li class="">Do we need additional effect types (e.g., scripted modifiers) before schema
v1.0, or can they wait for the scripting design doc?</li>
<li class="">What is the migration strategy when schema digests change (e.g., do we embed
the digest into save files similar to event manifests)?</li>
<li class="">Migrate remaining TypeScript/hand-authored sample data into the CLI-discoverable pack format and ensure the forthcoming DSL compiler emits the same schema-normalised structures.</li>
</ul>
<!-- -->
<section data-footnotes="true" class="footnotes"><h2 class="anchor anchorTargetStickyNavbar_EdDC sr-only" id="footnote-label">Footnotes<a href="#footnote-label" class="hash-link" aria-label="Direct link to Footnotes" title="Direct link to Footnotes" translate="no">​</a></h2>
<ol>
<li class="anchorTargetStickyNavbar_EdDC" id="user-content-fn-npm-scope">
<p><em>Scoped packages</em> — npm Docs. Demonstrates npm’s scoped package
naming convention using <code>@myorg/mypackage</code>, which the schema mirrors so packs
can reference scoped workspace ids. <a href="https://docs.npmjs.com/cli/v10/using-npm/scope" target="_blank" rel="noopener noreferrer" class="">https://docs.npmjs.com/cli/v10/using-npm/scope</a> <a href="#user-content-fnref-npm-scope" data-footnote-backref="" aria-label="Back to reference 1" class="data-footnote-backref">↩</a></p>
</li>
<li class="anchorTargetStickyNavbar_EdDC" id="user-content-fn-non-monotonic">
<p>&quot;Non-monotonic logic&quot; — Wikipedia. Notes that adding new
information can invalidate prior inferences, so negative knowledge behaves
non-monotonically and must be modelled separately from positive dependency
edges. <a href="https://en.wikipedia.org/wiki/Non-monotonic_logic" target="_blank" rel="noopener noreferrer" class="">https://en.wikipedia.org/wiki/Non-monotonic_logic</a> <a href="#user-content-fnref-non-monotonic" data-footnote-backref="" aria-label="Back to reference 2" class="data-footnote-backref">↩</a></p>
</li>
<li class="anchorTargetStickyNavbar_EdDC" id="user-content-fn-otel-metrics-api">
<p><em>Metrics API</em> — OpenTelemetry Specification. Highlights
instrument identity across <code>name</code>, <code>kind</code>, <code>unit</code>, and <code>description</code>, guiding
schema fields for metrics authored by packs.
<a href="https://raw.githubusercontent.com/open-telemetry/opentelemetry-specification/main/specification/metrics/api.md" target="_blank" rel="noopener noreferrer" class="">https://raw.githubusercontent.com/open-telemetry/opentelemetry-specification/main/specification/metrics/api.md</a> <a href="#user-content-fnref-otel-metrics-api" data-footnote-backref="" aria-label="Back to reference 3" class="data-footnote-backref">↩</a></p>
</li>
<li class="anchorTargetStickyNavbar_EdDC" id="user-content-fn-core-automation-tests">
<p><code>packages/core/src/index.test.ts:676</code> and
<code>packages/core/src/index.test.ts:700</code> exercise automation toggles keyed by
canonical ids when emitting runtime events, underscoring why transform
automation triggers must capture the exact <code>automationId</code>. <a href="#user-content-fnref-core-automation-tests" data-footnote-backref="" aria-label="Back to reference 4" class="data-footnote-backref">↩</a></p>
</li>
<li class="anchorTargetStickyNavbar_EdDC" id="user-content-fn-zod-safeparse">
<p><code>SafeParseReturnType&lt;Input, Output&gt;</code> and
<code>SafeParseError&lt;Input&gt;</code> from the published <code>zod@3.23.8</code> type definitions show
that failure errors are parameterised over the input payload. See
<code>package/v3/types.d.ts</code> lines 44-70 inside the npm tarball:
<a href="https://registry.npmjs.org/zod/-/zod-3.23.8.tgz" target="_blank" rel="noopener noreferrer" class="">https://registry.npmjs.org/zod/-/zod-3.23.8.tgz</a> <a href="#user-content-fnref-zod-safeparse" data-footnote-backref="" aria-label="Back to reference 5" class="data-footnote-backref">↩</a></p>
</li>
</ol>
</section></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_QKxP"><a href="https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/content-dsl-schema-design.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_wOWh" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_Basj"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/Idle-Game-Engine/diagnostic-timeline-design"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Diagnostic Timeline Instrumentation</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Idle-Game-Engine/content-dsl-usage-guidelines"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Content DSL Usage Guidelines</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_AUZ0 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-overview" class="table-of-contents__link toc-highlight">1. Overview</a></li><li><a href="#2-goals" class="table-of-contents__link toc-highlight">2. Goals</a></li><li><a href="#3-non-goals" class="table-of-contents__link toc-highlight">3. Non-Goals</a></li><li><a href="#4-current-state" class="table-of-contents__link toc-highlight">4. Current State</a></li><li><a href="#5-proposed-solution" class="table-of-contents__link toc-highlight">5. Proposed Solution</a><ul><li><a href="#51-package-layout--ownership" class="table-of-contents__link toc-highlight">5.1 Package Layout &amp; Ownership</a></li><li><a href="#52-shared-scalar-schemas--utilities" class="table-of-contents__link toc-highlight">5.2 Shared Scalar Schemas &amp; Utilities</a></li><li><a href="#53-numeric-formula-schema" class="table-of-contents__link toc-highlight">5.3 Numeric Formula Schema</a></li><li><a href="#54-condition-schema" class="table-of-contents__link toc-highlight">5.4 Condition Schema</a></li><li><a href="#55-metadata-schema" class="table-of-contents__link toc-highlight">5.5 Metadata Schema</a></li><li><a href="#56-resource-schema" class="table-of-contents__link toc-highlight">5.6 Resource Schema</a></li><li><a href="#57-generator-schema" class="table-of-contents__link toc-highlight">5.7 Generator Schema</a></li><li><a href="#58-upgrade-schema" class="table-of-contents__link toc-highlight">5.8 Upgrade Schema</a></li><li><a href="#59-metric-schema" class="table-of-contents__link toc-highlight">5.9 Metric Schema</a></li><li><a href="#510-achievement-schema" class="table-of-contents__link toc-highlight">5.10 Achievement Schema</a></li><li><a href="#511-automation-schema" class="table-of-contents__link toc-highlight">5.11 Automation Schema</a></li><li><a href="#512-transform-schema" class="table-of-contents__link toc-highlight">5.12 Transform Schema</a></li><li><a href="#513-prestige-layer-schema" class="table-of-contents__link toc-highlight">5.13 Prestige Layer Schema</a></li><li><a href="#514-guild-perk-schema" class="table-of-contents__link toc-highlight">5.14 Guild Perk Schema</a></li><li><a href="#515-runtime-event-contribution-schema" class="table-of-contents__link toc-highlight">5.15 Runtime Event Contribution Schema</a></li><li><a href="#516-content-pack-root-schema" class="table-of-contents__link toc-highlight">5.16 Content Pack Root Schema</a></li><li><a href="#517-normalisation--derived-artifacts" class="table-of-contents__link toc-highlight">5.17 Normalisation &amp; Derived Artifacts</a></li><li><a href="#518-implementation-plan" class="table-of-contents__link toc-highlight">5.18 Implementation Plan</a></li><li><a href="#519-authoring-best-practices" class="table-of-contents__link toc-highlight">5.19 Authoring Best Practices</a></li></ul></li><li><a href="#6-testing-strategy" class="table-of-contents__link toc-highlight">6. Testing Strategy</a></li><li><a href="#7-risks--mitigations" class="table-of-contents__link toc-highlight">7. Risks &amp; Mitigations</a></li><li><a href="#8-decisions--clarifications" class="table-of-contents__link toc-highlight">8. Decisions &amp; Clarifications</a></li><li><a href="#9-acceptance-criteria" class="table-of-contents__link toc-highlight">9. Acceptance Criteria</a></li><li><a href="#10-open-questions--follow-ups" class="table-of-contents__link toc-highlight">10. Open Questions &amp; Follow-Ups</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/contributor-handbook">Contributor Handbook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Idle Engine.</div></div></div></footer></div>
</body>
</html>