<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-runtime-command-transport-design-issue-545" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Runtime Command Transport Design (Issue 545) | Idle Engine Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hansjm10.github.io/Idle-Game-Engine/runtime-command-transport-design-issue-545"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Runtime Command Transport Design (Issue 545) | Idle Engine Docs"><meta data-rh="true" name="description" content="Document Control"><meta data-rh="true" property="og:description" content="Document Control"><link data-rh="true" rel="icon" href="/Idle-Game-Engine/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hansjm10.github.io/Idle-Game-Engine/runtime-command-transport-design-issue-545"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/runtime-command-transport-design-issue-545" hreflang="en"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/runtime-command-transport-design-issue-545" hreflang="x-default"><link rel="stylesheet" href="/Idle-Game-Engine/assets/css/styles.ddf7989c.css">
<script src="/Idle-Game-Engine/assets/js/runtime~main.41db1294.js" defer="defer"></script>
<script src="/Idle-Game-Engine/assets/js/main.57fd14dd.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Idle-Game-Engine/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_li4T" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Idle-Game-Engine/"><div class="navbar__logo"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--light_vaEm"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--dark_axH8"></div><b class="navbar__title text--truncate">Idle Engine</b></a><a class="navbar__item navbar__link" href="/Idle-Game-Engine/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle__Exw colorModeToggle_Lslw"><button class="clean-btn toggleButton_AMBK toggleButtonDisabled_p4Bd" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 lightToggleIcon_p2sk"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 darkToggleIcon_B2qX"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 systemToggleIcon_PWgn"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_RKai"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_nqaE"><div class="docsWrapper_CSLE"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sOWX" type="button"></button><div class="docRoot_qxtV"><main class="docMainContainer_tfRv docMainContainerEnhanced_qAvX"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_hyci"><div class="docItemContainer_tcAC"><article><div class="tocCollapsible_WMbj theme-doc-toc-mobile tocMobile_wI3e"><button type="button" class="clean-btn tocCollapsibleButton_rjEa">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Runtime Command Transport Design (Issue 545)</h1></header>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="document-control">Document Control<a href="#document-control" class="hash-link" aria-label="Direct link to Document Control" title="Direct link to Document Control" translate="no">​</a></h2>
<ul>
<li class=""><strong>Title</strong>: Introduce command transport envelope, responses, and idempotency for Issue 545</li>
<li class=""><strong>Authors</strong>: TODO (Owner: Runtime Core Maintainer)</li>
<li class=""><strong>Reviewers</strong>: TODO (Owner: Runtime Core Maintainers)</li>
<li class=""><strong>Status</strong>: Draft</li>
<li class=""><strong>Last Updated</strong>: 2025-12-27</li>
<li class=""><strong>Related Issues</strong>: <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/545" target="_blank" rel="noopener noreferrer" class="">https://github.com/hansjm10/Idle-Game-Engine/issues/545</a>, <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/666" target="_blank" rel="noopener noreferrer" class="">https://github.com/hansjm10/Idle-Game-Engine/issues/666</a></li>
<li class=""><strong>Execution Mode</strong>: AI-led</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="1-summary">1. Summary<a href="#1-summary" class="hash-link" aria-label="Direct link to 1. Summary" title="Direct link to 1. Summary" translate="no">​</a></h2>
<p>Issue 545 defines a command transport layer that wraps runtime commands in a network-ready envelope, produces authoritative acknowledgments or rejections, and enforces idempotency with client-side pending tracking so networked command execution can be built without altering Idle Engine determinism. The server treats client-supplied command metadata as advisory and stamps authoritative <code>serverStep</code>, priority, and timestamps on receipt.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="2-context--problem-statement">2. Context &amp; Problem Statement<a href="#2-context--problem-statement" class="hash-link" aria-label="Direct link to 2. Context &amp; Problem Statement" title="Direct link to 2. Context &amp; Problem Statement" translate="no">​</a></h2>
<ul>
<li class=""><strong>Background</strong>: Issue 545 builds on the existing command model with optional request identifiers (<code>packages/core/src/command.ts:18</code>), deterministic queueing and serialization (<code>packages/core/src/command-queue.ts:33</code>, <code>packages/core/src/command-queue.ts:207</code>), and dispatcher error reporting (<code>packages/core/src/command-dispatcher.ts:7</code>), while state sync documentation explicitly defers transport (<code>docs/state-synchronization-protocol-design.md</code>).</li>
<li class=""><strong>Problem</strong>: Issue 545 highlights missing transport primitives: no command envelope with <code>clientId</code>/<code>requestId</code>, no acknowledgment or rejection response protocol, no idempotency registry, and no client-side pending tracker.</li>
<li class=""><strong>Forces</strong>: Issue 545 must preserve deterministic tick execution, remain transport-agnostic inside <code>packages/core</code>, avoid breaking existing command serialization, and keep tests stable for <code>pnpm test --filter @idle-engine/core</code>.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="3-goals--non-goals">3. Goals &amp; Non-Goals<a href="#3-goals--non-goals" class="hash-link" aria-label="Direct link to 3. Goals &amp; Non-Goals" title="Direct link to 3. Goals &amp; Non-Goals" translate="no">​</a></h2>
<ul>
<li class=""><strong>Goals</strong>: Issue 545 will define <code>CommandEnvelope</code> and <code>CommandResponse</code> types, add an idempotency registry with configurable retention, add a pending command tracker for acknowledgments and timeouts, and deliver acceptance tests for accepted, rejected, and duplicate flows.</li>
<li class=""><strong>Non-Goals</strong>: Issue 545 does not implement WebSocket/HTTP transports, authentication, compression, client prediction, or changes to the deterministic queue semantics.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="4-stakeholders-agents--impacted-surfaces">4. Stakeholders, Agents &amp; Impacted Surfaces<a href="#4-stakeholders-agents--impacted-surfaces" class="hash-link" aria-label="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" title="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" translate="no">​</a></h2>
<ul>
<li class=""><strong>Primary Stakeholders</strong>: Issue 545 is owned by Runtime Core maintainers, with Shell maintainers and QA as secondary stakeholders.</li>
<li class=""><strong>Agent Roles</strong>:</li>
</ul>
<table><thead><tr><th>Agent</th><th>Responsibilities</th></tr></thead><tbody><tr><td>Transport Protocol Agent</td><td>Define Issue 545 transport types, registries, and exports.</td></tr><tr><td>Runtime Implementation Agent</td><td>Integrate Issue 545 outcomes and server adapter hooks in <code>packages/core</code>.</td></tr><tr><td>Testing Agent</td><td>Add Issue 545 unit and integration coverage.</td></tr><tr><td>Docs Agent</td><td>Maintain Issue 545 documentation and references.</td></tr></tbody></table>
<ul>
<li class=""><strong>Affected Packages/Services</strong>: Issue 545 impacts <code>packages/core</code> and related runtime-facing docs under <code>docs/</code>.</li>
<li class=""><strong>Compatibility Considerations</strong>: Issue 545 APIs are additive, <code>Command.requestId</code> remains optional for local commands (<code>packages/core/src/command.ts:18</code>), and serialized command queue formats remain unchanged (<code>packages/core/src/command-queue.ts:207</code>).</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="5-current-state">5. Current State<a href="#5-current-state" class="hash-link" aria-label="Direct link to 5. Current State" title="Direct link to 5. Current State" translate="no">​</a></h2>
<p>Issue 545 starts from a runtime that queues and serializes commands without transport metadata (<code>packages/core/src/command-queue.ts:207</code>), uses <code>CommandError</code> for failures (<code>packages/core/src/command-dispatcher.ts:7</code>), and exposes only failure draining (<code>packages/core/src/index.ts:237</code>). There is no idempotency registry, no pending command tracker, and no integration tests for request/response flows beyond queue unit tests (<code>packages/core/src/command-queue.test.ts:39</code>).</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="6-proposed-solution">6. Proposed Solution<a href="#6-proposed-solution" class="hash-link" aria-label="Direct link to 6. Proposed Solution" title="Direct link to 6. Proposed Solution" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="61-architecture-overview">6.1 Architecture Overview<a href="#61-architecture-overview" class="hash-link" aria-label="Direct link to 6.1 Architecture Overview" title="Direct link to 6.1 Architecture Overview" translate="no">​</a></h3>
<ul>
<li class=""><strong>Narrative</strong>: Issue 545 adds a transport protocol layer that wraps serialized commands in an envelope, routes them through an idempotency registry and server adapter, and returns an acknowledgment or rejection response while leaving deterministic runtime execution unchanged.</li>
<li class=""><strong>Diagram</strong>:</li>
</ul>
<div class="language-text codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-text codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token plain">Client                         Transport Layer                          Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------  CommandEnvelope  -----------------------  CommandEnvelope  -----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Runtime UI   -&gt; Pending Tracker -&gt; Network Adapter   -&gt;  Transport Server -&gt; Idle Runtime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Runtime UI   &lt;- CommandResponse &lt;- Pending Tracker &lt;-    Idempotency Reg  &lt;- CommandQueue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------                  -----------------------                  -----------------</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="62-detailed-design">6.2 Detailed Design<a href="#62-detailed-design" class="hash-link" aria-label="Direct link to 6.2 Detailed Design" title="Direct link to 6.2 Detailed Design" translate="no">​</a></h3>
<ul>
<li class=""><strong>Runtime Changes</strong>: Issue 545 adds a <code>CommandExecutionOutcome</code> stream (success or failure with <code>requestId</code>, <code>serverStep</code> for the execution step, and <code>CommandError</code>) and a <code>drainCommandOutcomes()</code> API alongside <code>drainCommandFailures()</code> (<code>packages/core/src/index.ts:237</code>). The transport server uses these outcomes to finalize responses without changing command queue order (<code>packages/core/src/command-queue.ts:74</code>) and serializes <code>CommandError</code> into a JSON-safe transport error.</li>
<li class=""><strong>Data &amp; Schemas</strong>: Issue 545 introduces a JSON-safe <code>SerializedCommand</code> and transport wrappers aligned with existing payload serialization (<code>packages/core/src/command-queue.ts:33</code>). <code>CommandResponse.serverStep</code> records the server enqueue step (acknowledgment), not the execution step.</li>
</ul>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">SerializedCommand</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> priority</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CommandPriority</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> timestamp</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> step</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> payload</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> JsonValue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> requestId</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">CommandEnvelope</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> requestId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> clientId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> command</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SerializedCommand</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> sentAt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">CommandResponseError</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> code</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> details</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> JsonValue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">CommandResponse</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> requestId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> status</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;accepted&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;rejected&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;duplicate&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> serverStep</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> error</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CommandResponseError</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ul>
<li class=""><strong>APIs &amp; Contracts</strong>: Issue 545 adds idempotency and pending tracking interfaces with deterministic, in-memory implementations.</li>
</ul>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">IdempotencyRegistry</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CommandResponse </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">record</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> response</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CommandResponse</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> expiresAt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">purgeExpired</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">now</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">PendingCommandTracker</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">track</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">envelope</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CommandEnvelope</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">resolve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">response</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CommandResponse</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">expire</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">now</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CommandEnvelope</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">getPending</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> CommandEnvelope</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ul>
<li class=""><strong>Tooling &amp; Automation</strong>: Issue 545 exports transport types and helpers from <code>packages/core/src/index.ts</code>, adds unit/integration tests in <code>packages/core/src</code>, and updates docs references in <code>docs/</code>.</li>
<li class=""><strong>Authority &amp; Trust Boundaries</strong>:<!-- -->
<ul>
<li class="">Server is authoritative for command execution order. Client-supplied <code>step</code>, <code>priority</code>, and <code>timestamp</code> are treated as advisory and MUST be normalized on receipt.</li>
<li class="">Transport MUST stamp <code>serverStep</code> via <code>runtime.getNextExecutableStep()</code> and normalize priority to <code>CommandPriority.PLAYER</code> for client-originated commands (server/system commands may use <code>SYSTEM</code>).</li>
<li class="">Transport MUST apply server-side timestamps to avoid client clock skew influencing ordering within a priority lane.</li>
<li class="">Idempotency remains scoped to <code>{clientId, requestId}</code>; duplicates return cached responses (<code>packages/core/src/command-transport-server.ts:106</code>).</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="63-operational-considerations">6.3 Operational Considerations<a href="#63-operational-considerations" class="hash-link" aria-label="Direct link to 6.3 Operational Considerations" title="Direct link to 6.3 Operational Considerations" translate="no">​</a></h3>
<ul>
<li class=""><strong>Deployment</strong>: Issue 545 is additive and requires no runtime deployment changes.</li>
<li class=""><strong>Telemetry &amp; Observability</strong>: Issue 545 adds telemetry events for duplicate requests and timeouts without logging payload contents.</li>
<li class=""><strong>Security &amp; Compliance</strong>: Issue 545 validates <code>clientId</code>/<code>requestId</code> length and format, and scopes idempotency keys to <code>{clientId, requestId}</code>.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="64-usage-guidance-initial">6.4 Usage Guidance (Initial)<a href="#64-usage-guidance-initial" class="hash-link" aria-label="Direct link to 6.4 Usage Guidance (Initial)" title="Direct link to 6.4 Usage Guidance (Initial)" translate="no">​</a></h3>
<ul>
<li class=""><strong>When to use</strong>: Apply the transport protocol when commands originate outside the runtime process (networked client, multi-process shell). Local-only commands can enqueue directly without envelopes.</li>
<li class=""><strong>Envelope creation</strong>: Wrap commands in <code>CommandEnvelope</code> with stable <code>clientId</code>, unique <code>requestId</code> per client, and <code>sentAt</code> for observability; keep payloads JSON-safe via <code>SerializedCommand</code>.</li>
<li class=""><strong>Server handling</strong>: Validate identifiers, check the idempotency registry by <code>{clientId, requestId}</code>, return cached <code>duplicate</code> responses, and record <code>accepted</code> responses keyed to the enqueue <code>serverStep</code>; return <code>rejected</code> with <code>CommandResponseError</code> for invalid requests.<!-- -->
<ul>
<li class="">Normalize command metadata: override <code>command.step</code> with <code>getNextExecutableStep()</code>, clamp priority to <code>CommandPriority.PLAYER</code> for client-originated traffic, and overwrite <code>command.timestamp</code> with server time before enqueueing to preserve deterministic ordering under client clock skew.</li>
</ul>
</li>
<li class=""><strong>RequestId collisions</strong>: Reject envelopes that reuse a <code>requestId</code> across different <code>clientId</code> values while the requestId is still pending, returning <code>REQUEST_ID_IN_USE</code>.</li>
<li class=""><strong>Server adapter example</strong>:<!-- -->
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> server </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createCommandTransportServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  commandQueue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">getNextExecutableStep</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getNextExecutableStep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">drainCommandOutcomes</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">drainCommandOutcomes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> response </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">handleEnvelope</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">envelope</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> outcomes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">drainOutcomeResponses</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
</li>
<li class=""><strong>Client handling</strong>: Track pending envelopes, resolve on <code>CommandResponse</code>, and expire/retry based on configured timeouts using the pending tracker.</li>
<li class=""><strong>Defaults</strong>: Recommend <code>DEFAULT_IDEMPOTENCY_TTL_MS = 5 * 60 * 1000</code> and <code>DEFAULT_PENDING_COMMAND_TIMEOUT_MS = 30 * 1000</code>; tune per transport latency and retry strategy.</li>
<li class=""><strong>Prediction and reconciliation</strong>: For client-side prediction usage, authority boundaries, and snapshot cadence, see <a class="" href="/Idle-Game-Engine/runtime-client-prediction-rollback-design-issue-546">Client Prediction and Rollback Design (Issue 546)</a>.</li>
<li class=""><strong>Related runtime guidance</strong>: A runtime-facing stub lives in <a class="" href="/Idle-Game-Engine/runtime-command-queue-design">Runtime Command Queue Design</a> for quick discovery and links back here for full protocol details.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="7-work-breakdown--delivery-plan">7. Work Breakdown &amp; Delivery Plan<a href="#7-work-breakdown--delivery-plan" class="hash-link" aria-label="Direct link to 7. Work Breakdown &amp; Delivery Plan" title="Direct link to 7. Work Breakdown &amp; Delivery Plan" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="71-issue-map">7.1 Issue Map<a href="#71-issue-map" class="hash-link" aria-label="Direct link to 7.1 Issue Map" title="Direct link to 7.1 Issue Map" translate="no">​</a></h3>
<table><thead><tr><th>Issue Title</th><th>Scope Summary</th><th>Proposed Assignee/Agent</th><th>Dependencies</th><th>Acceptance Criteria</th></tr></thead><tbody><tr><td>feat(core): add transport types for Issue 545</td><td>Define <code>SerializedCommand</code>, <code>CommandEnvelope</code>, <code>CommandResponse</code> and exports</td><td>Transport Protocol Agent</td><td>Design approval</td><td>Types exported; lint clean; <code>pnpm test --filter @idle-engine/core</code> passes</td></tr><tr><td>feat(core): add idempotency registry for Issue 545</td><td>Implement registry interface + default in-memory registry</td><td>Runtime Implementation Agent</td><td>Transport types</td><td>Registry handles duplicates with TTL; unit tests added</td></tr><tr><td>feat(core): add pending command tracker for Issue 545</td><td>Implement client-side tracker for in-flight commands</td><td>Runtime Implementation Agent</td><td>Transport types</td><td>Timeouts tracked; retry hooks defined; unit tests added</td></tr><tr><td>feat(core): add command outcome drain for Issue 545</td><td>Expose success/failure outcomes with requestId</td><td>Runtime Implementation Agent</td><td>Transport types</td><td><code>drainCommandOutcomes()</code> returns accepted/rejected outcomes; tests updated</td></tr><tr><td>feat(core): add transport server adapter for Issue 545</td><td>Convert envelopes to runtime commands and responses</td><td>Transport Protocol Agent</td><td>Registry + outcomes</td><td>Accept/reject/duplicate behavior verified; integration tests added</td></tr><tr><td>test(core): cover transport flows for Issue 545</td><td>Add accept/reject/duplicate integration tests</td><td>Testing Agent</td><td>Server adapter</td><td>Tests added for ack, rejection, duplicate; <code>pnpm test --filter @idle-engine/core</code> passes</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="72-milestones">7.2 Milestones<a href="#72-milestones" class="hash-link" aria-label="Direct link to 7.2 Milestones" title="Direct link to 7.2 Milestones" translate="no">​</a></h3>
<ul>
<li class=""><strong>Phase 1</strong>: Issue 545 transport types, registry, and pending tracker implemented and tested.</li>
<li class=""><strong>Phase 2</strong>: Issue 545 runtime outcomes, server adapter, and integration tests completed.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="73-coordination-notes">7.3 Coordination Notes<a href="#73-coordination-notes" class="hash-link" aria-label="Direct link to 7.3 Coordination Notes" title="Direct link to 7.3 Coordination Notes" translate="no">​</a></h3>
<ul>
<li class=""><strong>Hand-off Package</strong>: Issue 545 context includes <code>docs/runtime-command-queue-design.md</code>, <code>docs/state-synchronization-protocol-design.md</code>, <code>packages/core/src/command.ts:18</code>, <code>packages/core/src/command-dispatcher.ts:7</code>.</li>
<li class=""><strong>Communication Cadence</strong>: Issue 545 status updates daily until Phase 2 completion, with a review checkpoint after Phase 1.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="8-agent-guidance--guardrails">8. Agent Guidance &amp; Guardrails<a href="#8-agent-guidance--guardrails" class="hash-link" aria-label="Direct link to 8. Agent Guidance &amp; Guardrails" title="Direct link to 8. Agent Guidance &amp; Guardrails" translate="no">​</a></h2>
<ul>
<li class=""><strong>Context Packets</strong>: Issue 545 agents must load <code>packages/core/src/command.ts</code>, <code>packages/core/src/command-queue.ts</code>, <code>packages/core/src/command-dispatcher.ts</code>, <code>packages/core/src/index.ts</code>, and <code>docs/state-synchronization-protocol-design.md</code>.</li>
<li class=""><strong>Prompting &amp; Constraints</strong>: Issue 545 agent prompt example: &quot;You are the Runtime Implementation Agent for Issue 545. Implement idempotency registry and pending tracker in <code>packages/core</code>, use type-only imports, do not alter command queue ordering, and run <code>pnpm test --filter @idle-engine/core</code>.&quot;</li>
<li class=""><strong>Safety Rails</strong>: Issue 545 agents must not edit <code>dist/</code> outputs, must avoid console output that could disrupt Vitest JSON reporting, and must not add network dependencies to <code>packages/core</code>.</li>
<li class=""><strong>Validation Hooks</strong>: Issue 545 completion requires <code>pnpm lint</code> and <code>pnpm test --filter @idle-engine/core</code>.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="9-alternatives-considered">9. Alternatives Considered<a href="#9-alternatives-considered" class="hash-link" aria-label="Direct link to 9. Alternatives Considered" title="Direct link to 9. Alternatives Considered" translate="no">​</a></h2>
<p>Issue 545 alternatives considered:</p>
<ul>
<li class="">Implement transport in shell code only (rejected: fragments protocol definitions and reduces test coverage).</li>
<li class="">Extend command queue serialization to serve as transport (rejected: lacks acknowledgment and idempotency semantics).</li>
<li class="">Use state sync snapshots for command delivery (rejected: excessive bandwidth and mismatch with request/response flows).</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="10-testing--validation-plan">10. Testing &amp; Validation Plan<a href="#10-testing--validation-plan" class="hash-link" aria-label="Direct link to 10. Testing &amp; Validation Plan" title="Direct link to 10. Testing &amp; Validation Plan" translate="no">​</a></h2>
<ul>
<li class=""><strong>Unit / Integration</strong>: Issue 545 adds unit tests for idempotency registry and pending tracker plus integration tests for accept, reject, and duplicate flows.</li>
<li class=""><strong>Performance</strong>: Issue 545 validates O(1) average registry operations and TTL eviction behavior.</li>
<li class=""><strong>Tooling / A11y</strong>: Issue 545 has no UI surface, so accessibility validation is not applicable.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="11-risks--mitigations">11. Risks &amp; Mitigations<a href="#11-risks--mitigations" class="hash-link" aria-label="Direct link to 11. Risks &amp; Mitigations" title="Direct link to 11. Risks &amp; Mitigations" translate="no">​</a></h2>
<p>Issue 545 risks and mitigations:</p>
<ul>
<li class="">Duplicate requestId collisions across clients lead to incorrect responses. Mitigation: scope registry keys by <code>{clientId, requestId}</code> and validate input formats.</li>
<li class="">Pending tracker leaks entries when no response arrives. Mitigation: require timeout eviction and expose pending counts for diagnostics.</li>
<li class="">Command rejection lacks explicit error payload. Mitigation: standardize rejection errors using <code>CommandError</code> (<code>packages/core/src/command-dispatcher.ts:7</code>) and serialize to <code>CommandResponseError</code> for transport.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="12-rollout-plan">12. Rollout Plan<a href="#12-rollout-plan" class="hash-link" aria-label="Direct link to 12. Rollout Plan" title="Direct link to 12. Rollout Plan" translate="no">​</a></h2>
<ul>
<li class=""><strong>Milestones</strong>: Issue 545 ships in two phases (types/registry first, adapter and tests second).</li>
<li class=""><strong>Migration Strategy</strong>: Issue 545 introduces additive APIs with no data migration.</li>
<li class=""><strong>Communication</strong>: Issue 545 release notes should link to this doc and reference issue 545 acceptance criteria.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="13-open-questions">13. Open Questions<a href="#13-open-questions" class="hash-link" aria-label="Direct link to 13. Open Questions" title="Direct link to 13. Open Questions" translate="no">​</a></h2>
<ul>
<li class="">Resolved: default idempotency retention is 5 minutes and pending timeout is 30 seconds (both configurable).</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="14-follow-up-work">14. Follow-Up Work<a href="#14-follow-up-work" class="hash-link" aria-label="Direct link to 14. Follow-Up Work" title="Direct link to 14. Follow-Up Work" translate="no">​</a></h2>
<ul>
<li class="">Issue 545 follow-up: build concrete WebSocket/HTTP transport adapters in shell repos.</li>
<li class="">Issue 545 follow-up: add metrics dashboards for transport acknowledgments.</li>
<li class="">Issue 545 follow-up: evaluate batching/compression strategies for command envelopes.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="15-references">15. References<a href="#15-references" class="hash-link" aria-label="Direct link to 15. References" title="Direct link to 15. References" translate="no">​</a></h2>
<ul>
<li class=""><a href="https://github.com/hansjm10/Idle-Game-Engine/issues/545" target="_blank" rel="noopener noreferrer" class="">https://github.com/hansjm10/Idle-Game-Engine/issues/545</a></li>
<li class=""><code>docs/runtime-command-queue-design.md</code></li>
<li class=""><code>docs/state-synchronization-protocol-design.md</code></li>
<li class=""><code>packages/core/src/command.ts:18</code></li>
<li class=""><code>packages/core/src/command.ts:230</code></li>
<li class=""><code>packages/core/src/command-queue.ts:33</code></li>
<li class=""><code>packages/core/src/command-queue.ts:207</code></li>
<li class=""><code>packages/core/src/command-dispatcher.ts:7</code></li>
<li class=""><code>packages/core/src/index.ts:237</code></li>
<li class=""><code>packages/core/src/command-queue.test.ts:39</code></li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-a---glossary">Appendix A - Glossary<a href="#appendix-a---glossary" class="hash-link" aria-label="Direct link to Appendix A - Glossary" title="Direct link to Appendix A - Glossary" translate="no">​</a></h2>
<ul>
<li class=""><strong>Issue 545 CommandEnvelope</strong>: Transport wrapper containing <code>clientId</code>, <code>requestId</code>, <code>command</code>, and <code>sentAt</code>.</li>
<li class=""><strong>Issue 545 CommandResponse</strong>: Server response with acceptance, rejection, or duplication status.</li>
<li class=""><strong>Issue 545 Idempotency Registry</strong>: Server-side cache preventing duplicate command execution.</li>
<li class=""><strong>Issue 545 Pending Command Tracker</strong>: Client-side tracker for in-flight command acknowledgments and timeouts.</li>
<li class=""><strong>Issue 545 SerializedCommand</strong>: JSON-safe command payload used for transport.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-b---change-log">Appendix B - Change Log<a href="#appendix-b---change-log" class="hash-link" aria-label="Direct link to Appendix B - Change Log" title="Direct link to Appendix B - Change Log" translate="no">​</a></h2>
<table><thead><tr><th>Date</th><th>Author</th><th>Change Summary</th></tr></thead><tbody><tr><td>2025-12-28</td><td>Codex</td><td>Clarify server-stamped step/priority/timestamp authority</td></tr><tr><td>2025-12-27</td><td>TODO (Owner: Runtime Core Maintainer)</td><td>Initial Issue 545 draft</td></tr><tr><td>2025-12-27</td><td>Codex</td><td>Clarify <code>CommandResponse.serverStep</code> as enqueue step</td></tr><tr><td>2025-12-27</td><td>Codex</td><td>Add initial transport usage guidance and runtime doc stub (Issue #677)</td></tr></tbody></table></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_QKxP"><a href="https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/runtime-command-transport-design-issue-545.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_wOWh" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_Basj"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_AUZ0 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#document-control" class="table-of-contents__link toc-highlight">Document Control</a></li><li><a href="#1-summary" class="table-of-contents__link toc-highlight">1. Summary</a></li><li><a href="#2-context--problem-statement" class="table-of-contents__link toc-highlight">2. Context &amp; Problem Statement</a></li><li><a href="#3-goals--non-goals" class="table-of-contents__link toc-highlight">3. Goals &amp; Non-Goals</a></li><li><a href="#4-stakeholders-agents--impacted-surfaces" class="table-of-contents__link toc-highlight">4. Stakeholders, Agents &amp; Impacted Surfaces</a></li><li><a href="#5-current-state" class="table-of-contents__link toc-highlight">5. Current State</a></li><li><a href="#6-proposed-solution" class="table-of-contents__link toc-highlight">6. Proposed Solution</a><ul><li><a href="#61-architecture-overview" class="table-of-contents__link toc-highlight">6.1 Architecture Overview</a></li><li><a href="#62-detailed-design" class="table-of-contents__link toc-highlight">6.2 Detailed Design</a></li><li><a href="#63-operational-considerations" class="table-of-contents__link toc-highlight">6.3 Operational Considerations</a></li><li><a href="#64-usage-guidance-initial" class="table-of-contents__link toc-highlight">6.4 Usage Guidance (Initial)</a></li></ul></li><li><a href="#7-work-breakdown--delivery-plan" class="table-of-contents__link toc-highlight">7. Work Breakdown &amp; Delivery Plan</a><ul><li><a href="#71-issue-map" class="table-of-contents__link toc-highlight">7.1 Issue Map</a></li><li><a href="#72-milestones" class="table-of-contents__link toc-highlight">7.2 Milestones</a></li><li><a href="#73-coordination-notes" class="table-of-contents__link toc-highlight">7.3 Coordination Notes</a></li></ul></li><li><a href="#8-agent-guidance--guardrails" class="table-of-contents__link toc-highlight">8. Agent Guidance &amp; Guardrails</a></li><li><a href="#9-alternatives-considered" class="table-of-contents__link toc-highlight">9. Alternatives Considered</a></li><li><a href="#10-testing--validation-plan" class="table-of-contents__link toc-highlight">10. Testing &amp; Validation Plan</a></li><li><a href="#11-risks--mitigations" class="table-of-contents__link toc-highlight">11. Risks &amp; Mitigations</a></li><li><a href="#12-rollout-plan" class="table-of-contents__link toc-highlight">12. Rollout Plan</a></li><li><a href="#13-open-questions" class="table-of-contents__link toc-highlight">13. Open Questions</a></li><li><a href="#14-follow-up-work" class="table-of-contents__link toc-highlight">14. Follow-Up Work</a></li><li><a href="#15-references" class="table-of-contents__link toc-highlight">15. References</a></li><li><a href="#appendix-a---glossary" class="table-of-contents__link toc-highlight">Appendix A - Glossary</a></li><li><a href="#appendix-b---change-log" class="table-of-contents__link toc-highlight">Appendix B - Change Log</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/contributor-handbook">Contributor Handbook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Idle Engine.</div></div></div></footer></div>
</body>
</html>