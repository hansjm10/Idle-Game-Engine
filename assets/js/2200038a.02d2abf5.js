"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[3301],{5425:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>t,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"runtime-worker-bridge-runbook","title":"Runtime->React Worker Bridge Operational Runbook","description":"Issue: #261","source":"@site/../../docs/runtime-worker-bridge-runbook.md","sourceDirName":".","slug":"/runtime-worker-bridge-runbook","permalink":"/Idle-Game-Engine/runtime-worker-bridge-runbook","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/runtime-worker-bridge-runbook.md","tags":[],"version":"current","frontMatter":{}}');var i=n(5270),o=n(7678);const l={},t="Runtime->React Worker Bridge Operational Runbook",d={},c=[{value:"1. Purpose &amp; Scope",id:"1-purpose--scope",level:2},{value:"2. Ownership &amp; Review Path",id:"2-ownership--review-path",level:2},{value:"3. Build &amp; Rollout Workflow",id:"3-build--rollout-workflow",level:2},{value:"3.1 Local build matrix",id:"31-local-build-matrix",level:3},{value:"3.2 Feature flag rollout",id:"32-feature-flag-rollout",level:3},{value:"3.3 Configuration knobs",id:"33-configuration-knobs",level:3},{value:"3.4 Rollout phases &amp; notes",id:"34-rollout-phases--notes",level:3},{value:"4. Operational Procedures",id:"4-operational-procedures",level:2},{value:"4.1 Worker lifecycle",id:"41-worker-lifecycle",level:3},{value:"4.2 Command channel",id:"42-command-channel",level:3},{value:"4.3 Diagnostics opt-in",id:"43-diagnostics-opt-in",level:3},{value:"4.4 READY/ERROR signalling",id:"44-readyerror-signalling",level:3},{value:"4.5 Session snapshots",id:"45-session-snapshots",level:3},{value:"5. Validation Checklist",id:"5-validation-checklist",level:2},{value:"6. Troubleshooting Playbook",id:"6-troubleshooting-playbook",level:2},{value:"7. Verification Artifacts",id:"7-verification-artifacts",level:2},{value:"8. Follow-Up &amp; Assumptions",id:"8-follow-up--assumptions",level:2}];function a(e){const s={a:"a",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.header,{children:(0,i.jsx)(s.h1,{id:"runtime-react-worker-bridge-operational-runbook",children:"Runtime->React Worker Bridge Operational Runbook"})}),"\n",(0,i.jsxs)(s.p,{children:["Issue: ",(0,i.jsx)(s.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/261",children:"#261"}),(0,i.jsx)(s.br,{}),"\n","Design Source: ",(0,i.jsx)(s.a,{href:"/Idle-Game-Engine/runtime-react-worker-bridge-design",children:"runtime-react-worker-bridge-design.md"})," \xa7\xa73, 6.3, 12"]}),"\n",(0,i.jsx)(s.h2,{id:"1-purpose--scope",children:"1. Purpose & Scope"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Stabilise day-to-day build, deployment, and troubleshooting for the runtime worker bridge delivered by issues ",(0,i.jsx)(s.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/253",children:"#253"})," and ",(0,i.jsx)(s.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/254",children:"#254"}),". The implementation lives in ",(0,i.jsx)(s.code,{children:"packages/shell-web/src/runtime.worker.ts"})," and ",(0,i.jsx)(s.code,{children:"packages/shell-web/src/modules/worker-bridge.ts"}),"."]}),"\n",(0,i.jsx)(s.li,{children:"Reinforce the design goals in \xa73 (deterministic messaging, diagnostics gating, lifecycle hygiene) and the operational guardrails from \xa76.3 (deployment, observability, security)."}),"\n",(0,i.jsx)(s.li,{children:"Provide a single checklist that Presentation Shell and Runtime Core leads can approve before enabling or rolling back the worker bridge."}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"2-ownership--review-path",children:"2. Ownership & Review Path"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Primary contacts"}),": Runtime Core maintainers (command queue invariants) and Presentation Shell lead (React integration). Tag both parties for every runbook or bridge code change\u2014this satisfies the \u201cGuidance reviewed by Runtime Core and Presentation Shell leads\u201d acceptance criterion."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Escalation"}),": file incidents in the project board (",(0,i.jsx)(s.code,{children:"Presentation Shell"})," workstream) and page Runtime Core if determinism or command sequencing is in doubt."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Telemetry routing"}),": the worker surfaces incidents through ",(0,i.jsx)(s.code,{children:"globalThis.__IDLE_ENGINE_TELEMETRY__"})," (",(0,i.jsx)(s.code,{children:"packages/shell-web/src/modules/worker-bridge.ts:41"}),"); coordinate with analytics before mutating that facade."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"3-build--rollout-workflow",children:"3. Build & Rollout Workflow"}),"\n",(0,i.jsx)(s.h3,{id:"31-local-build-matrix",children:"3.1 Local build matrix"}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"pnpm install"})," (repository root) \u2013 ensures Vite and shared configs are present."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"pnpm --filter shell-web dev"})," \u2013 spins up the worker-enabled shell at ",(0,i.jsx)(s.a,{href:"http://localhost:5173",children:"http://localhost:5173"})," for interactive validation."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"pnpm build --filter shell-web"})," \u2013 produces the production bundle under ",(0,i.jsx)(s.code,{children:"packages/shell-web/dist/"}),". The build emits a hashed worker artifact (for example ",(0,i.jsx)(s.code,{children:"dist/assets/runtime.worker-*.js"}),") alongside the main entrypoint; confirm both files exist before promoting a release."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"pnpm preview --filter shell-web -- --open"})," \u2013 optional smoke of the built assets via Vite\u2019s preview server."]}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"32-feature-flag-rollout",children:"3.2 Feature flag rollout"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Release staging"}),": publish the built assets to your CDN under a canary prefix (e.g. ",(0,i.jsx)(s.code,{children:"/shell/worker-canary/"}),"). Keep the previous non-worker build available so flips are instant."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Flag control"}),": flip ",(0,i.jsx)(s.code,{children:"VITE_ENABLE_WORKER_BRIDGE"})," (or ",(0,i.jsx)(s.code,{children:"ENABLE_WORKER_BRIDGE"})," in non-Vite Node environments) to ",(0,i.jsx)(s.code,{children:"true"})," to instantiate the worker-backed bridge inside the React shell. Leave the variable unset/",(0,i.jsx)(s.code,{children:"false"})," to fall back to the inline legacy bridge implemented in ",(0,i.jsx)(s.code,{children:"packages/shell-web/src/modules/inline-runtime-worker.ts"}),". Hosts can layer a deployment-level flag such as ",(0,i.jsx)(s.code,{children:"presentationShell.workerBridge.enabled"})," on top when orchestrating asset rollouts."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Rollback"}),": disable the flag to fall back to the legacy artifact, or redeploy the last known-good bundle. No code change is required provided both builds remain in storage."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Environment parity"}),": enable the flag progressively (dev \u2192 staging \u2192 canary \u2192 production). Each promotion should include the validation checklist in Section 5 and sign-off from both leads."]}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"33-configuration-knobs",children:"3.3 Configuration knobs"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"VITE_ENABLE_WORKER_BRIDGE"})," / ",(0,i.jsx)(s.code,{children:"ENABLE_WORKER_BRIDGE"})," \u2013 default ",(0,i.jsx)(s.code,{children:"false"}),". When ",(0,i.jsx)(s.code,{children:"true"}),", ",(0,i.jsx)(s.code,{children:"useWorkerBridge"})," spins up the worker in a dedicated thread; when ",(0,i.jsx)(s.code,{children:"false"}),", it runs the inline legacy runtime."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"VITE_ENABLE_SOCIAL_COMMANDS"})," / ",(0,i.jsx)(s.code,{children:"VITE_SOCIAL_SERVICE_BASE_URL"})," \u2013 opt-in to social-worker calls; default is disabled (see ",(0,i.jsx)(s.code,{children:"packages/shell-web/src/modules/social-config.ts"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"VITE_SHELL_ANALYTICS_ENDPOINT"})," / ",(0,i.jsx)(s.code,{children:"SHELL_ANALYTICS_ENDPOINT"})," \u2013 optional HTTPS endpoint for browser telemetry. When present, the shell analytics facade posts worker errors via ",(0,i.jsx)(s.code,{children:"navigator.sendBeacon"})," (or fetch fallback); omit to rely on local console output and the ",(0,i.jsx)(s.code,{children:"idle-engine:telemetry"})," DOM event stream."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"__IDLE_ENGINE_TELEMETRY__"})," \u2013 optional global injected by hosts for telemetry forwarding (errors surfaced through the bridge call this automatically)."]}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"34-rollout-phases--notes",children:"3.4 Rollout phases & notes"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Phase 1 \u2013 Dev canary"}),": enable ",(0,i.jsx)(s.code,{children:"VITE_ENABLE_WORKER_BRIDGE=true"})," in local/dev builds, run ",(0,i.jsx)(s.code,{children:"pnpm lint"}),", ",(0,i.jsx)(s.code,{children:"pnpm test --filter shell-web"}),", and ",(0,i.jsx)(s.code,{children:"pnpm build --filter shell-web"}),". Capture results plus owners (Presentation Shell lead, Runtime Core maintainer) in the weekly status update."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Phase 2 \u2013 Staging/canary"}),": promote the worker bundle behind a staging flag, execute the validation checklist in Section 5, and monitor diagnostics/telemetry dashboards for 48 hours. Document contact points for on-call coverage in the rollout notes."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Phase 3 \u2013 Production enablement"}),": flip the production flag, announce availability in the weekly status update, and note the rollback plan (disable ",(0,i.jsx)(s.code,{children:"VITE_ENABLE_WORKER_BRIDGE"}),") alongside escalation contacts."]}),"\n",(0,i.jsx)(s.li,{children:"When drafting rollout notes, include the commands executed above, current flag state, and the runtime/presentation contacts listed in Section 2 so downstream agents can coordinate escalation."}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"4-operational-procedures",children:"4. Operational Procedures"}),"\n",(0,i.jsx)(s.h3,{id:"41-worker-lifecycle",children:"4.1 Worker lifecycle"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Instantiation"}),": ",(0,i.jsx)(s.code,{children:"useWorkerBridge()"})," (React hook) spins up the worker via ",(0,i.jsx)(s.code,{children:"new Worker(new URL('../runtime.worker.ts', import.meta.url), { type: 'module' })"})," and returns a singleton bridge (",(0,i.jsx)(s.code,{children:"packages/shell-web/src/modules/worker-bridge.ts:604-623"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Handshake"}),": the worker posts a ",(0,i.jsx)(s.code,{children:"READY"})," message once initialised (",(0,i.jsx)(s.code,{children:"packages/shell-web/src/runtime.worker.ts:877"}),"). Clients must ",(0,i.jsx)(s.code,{children:"await bridge.awaitReady()"})," before sending commands; messages issued earlier are queued."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Session restore"}),": ",(0,i.jsx)(s.code,{children:"bridge.restoreSession()"})," forwards a ",(0,i.jsx)(s.code,{children:"RESTORE_SESSION"})," envelope and defers command flush until ",(0,i.jsx)(s.code,{children:"SESSION_RESTORED"})," arrives. Commands sent during restore are stored and replayed automatically (",(0,i.jsx)(s.code,{children:"runtime.worker.ts:195-223"}),", ",(0,i.jsx)(s.code,{children:"worker-bridge.ts:150-188"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Disposal"}),": the hook\u2019s ",(0,i.jsx)(s.code,{children:"useEffect"})," unregisters listeners and calls ",(0,i.jsx)(s.code,{children:"bridge.dispose()"})," on unmount, preventing worker leaks (",(0,i.jsx)(s.code,{children:"worker-bridge.ts:614-622"}),"). Always unmount providers during route transitions to avoid stray workers."]}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"42-command-channel",children:"4.2 Command channel"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Commands must include a monotonic ",(0,i.jsx)(s.code,{children:"issuedAt"})," (usually ",(0,i.jsx)(s.code,{children:"performance.now()"}),"). The worker drops stale envelopes and emits ",(0,i.jsx)(s.code,{children:"STALE_COMMAND"})," errors (",(0,i.jsx)(s.code,{children:"runtime.worker.ts:712-735"}),"). React clients should reuse ",(0,i.jsx)(s.code,{children:"bridge.sendCommand"})," which stamps the fields correctly."]}),"\n",(0,i.jsxs)(s.li,{children:["The worker enqueues everything at ",(0,i.jsx)(s.code,{children:"CommandPriority.PLAYER"}),", guarding against privilege escalation across the bridge (",(0,i.jsx)(s.code,{children:"runtime.worker.ts:759-770"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["Social commands remain behind ",(0,i.jsx)(s.code,{children:"VITE_ENABLE_SOCIAL_COMMANDS"})," and proxy through fetch helpers (",(0,i.jsx)(s.code,{children:"runtime.worker.ts:240-520"}),"). Unsupported kinds throw ",(0,i.jsx)(s.code,{children:"WorkerBridgeSocialCommandError"}),"."]}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"43-diagnostics-opt-in",children:"4.3 Diagnostics opt-in"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Call ",(0,i.jsx)(s.code,{children:"bridge.enableDiagnostics()"})," to subscribe; pair it with ",(0,i.jsx)(s.code,{children:"bridge.onDiagnosticsUpdate(handler)"})," to receive ",(0,i.jsx)(s.code,{children:"DiagnosticTimelineResult"})," deltas. Updates throttle automatically and include dropped-entry counters (",(0,i.jsx)(s.code,{children:"runtime.worker.ts:90-118"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["Disable streaming via ",(0,i.jsx)(s.code,{children:"bridge.disableDiagnostics()"})," and ",(0,i.jsx)(s.code,{children:"bridge.offDiagnosticsUpdate(handler)"})," to reduce noise. Diagnostics are opt-in by default to preserve the main-thread budget (\xa76.3)."]}),"\n",(0,i.jsxs)(s.li,{children:["The shell now auto-installs ",(0,i.jsx)(s.code,{children:"packages/shell-web/src/modules/shell-analytics.ts"}),", wiring ",(0,i.jsx)(s.code,{children:"__IDLE_ENGINE_TELEMETRY__.recordError"})," to the configured analytics transport and dispatching the ",(0,i.jsx)(s.code,{children:"idle-engine:telemetry"})," DOM event. Hosts can still override the global to fan out or enrich telemetry; when doing so, delegate back to the default facade to keep dashboards in sync."]}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"44-readyerror-signalling",children:"4.4 READY/ERROR signalling"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Monitor the console for ",(0,i.jsx)(s.code,{children:"[runtime.worker]"})," warnings. Errors propagate through ",(0,i.jsx)(s.code,{children:"bridge.onError"})," callbacks with typed detail (",(0,i.jsx)(s.code,{children:"RuntimeWorkerErrorDetails"}),") and request IDs for social commands."]}),"\n",(0,i.jsxs)(s.li,{children:["Common codes:","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"INVALID_COMMAND_PAYLOAD"})," \u2013 schema/version mismatch or malformed payload."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"SCHEMA_VERSION_MISMATCH"})," \u2013 client bundle using different ",(0,i.jsx)(s.code,{children:"WORKER_MESSAGE_SCHEMA_VERSION"})," (currently ",(0,i.jsx)(s.code,{children:"3"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"RESTORE_FAILED"})," \u2013 session payload rejected; inspect ",(0,i.jsx)(s.code,{children:".details"})," for reconciliation logs."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"STALE_COMMAND"})," \u2013 command ",(0,i.jsx)(s.code,{children:"issuedAt"})," < last accepted; ensure callers use the bridge helpers."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"SNAPSHOT_FAILED"})," \u2013 session snapshot capture failed; see \xa74.5 for details."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"45-session-snapshots",children:"4.5 Session snapshots"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Capture performance"}),": Snapshot serialization is ",(0,i.jsx)(s.strong,{children:"synchronous"})," and blocks the worker tick loop. The worker captures the current runtime state via ",(0,i.jsx)(s.code,{children:"exportForSave()"})," and emits a ",(0,i.jsx)(s.code,{children:"SESSION_SNAPSHOT"})," message with the complete payload (state, metadata, content digest)."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Expected snapshot sizes"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Small games (~10 resources): ",(0,i.jsx)(s.strong,{children:"1-5 KB"})]}),"\n",(0,i.jsxs)(s.li,{children:["Medium games (~50 resources): ",(0,i.jsx)(s.strong,{children:"5-25 KB"})]}),"\n",(0,i.jsxs)(s.li,{children:["Large games (~200+ resources): ",(0,i.jsx)(s.strong,{children:"25-100 KB"})]}),"\n",(0,i.jsxs)(s.li,{children:["Resource count is the primary driver of snapshot size. Monitor ",(0,i.jsx)(s.code,{children:"worker.session_snapshot_captured"})," telemetry events for ",(0,i.jsx)(s.code,{children:"snapshotBytes"})," and ",(0,i.jsx)(s.code,{children:"resourceCount"})," to track growth trends."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Capture duration"}),": Typically ",(0,i.jsx)(s.strong,{children:"<5ms"})," for small-to-medium games. Snapshots blocking longer than ",(0,i.jsx)(s.strong,{children:">10ms"})," may indicate state bloat or serialization bottlenecks; consider profiling ",(0,i.jsx)(s.code,{children:"exportForSave()"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Concurrency behavior"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Multiple snapshot requests are processed ",(0,i.jsx)(s.strong,{children:"sequentially"})," in message order. Each snapshot captures the state at its processing time (same ",(0,i.jsx)(s.code,{children:"workerStep"})," if no ticks occur between requests)."]}),"\n",(0,i.jsxs)(s.li,{children:["Snapshots are ",(0,i.jsx)(s.strong,{children:"gated during session restoration"})," (",(0,i.jsx)(s.code,{children:"RESTORE_IN_PROGRESS"})," check at ",(0,i.jsx)(s.code,{children:"runtime.worker.ts:816"}),") to avoid capturing inconsistent state. Requests during restore fail immediately with ",(0,i.jsx)(s.code,{children:"SNAPSHOT_FAILED"})," error code and ",(0,i.jsx)(s.code,{children:"details.reason: 'RESTORE_IN_PROGRESS'"}),". Wait for ",(0,i.jsx)(s.code,{children:"SESSION_RESTORED"})," before requesting snapshots."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Telemetry monitoring"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Success"}),": ",(0,i.jsx)(s.code,{children:"worker.session_snapshot_captured"})," events include ",(0,i.jsx)(s.code,{children:"snapshotBytes"}),", ",(0,i.jsx)(s.code,{children:"snapshotKB"}),", ",(0,i.jsx)(s.code,{children:"workerStep"}),", ",(0,i.jsx)(s.code,{children:"reason"}),", ",(0,i.jsx)(s.code,{children:"requestId"}),", ",(0,i.jsx)(s.code,{children:"resourceCount"}),". Use these metrics to establish baselines and detect anomalies (e.g., sudden size spikes)."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Failure"}),": ",(0,i.jsx)(s.code,{children:"worker.session_snapshot_failed"})," events include ",(0,i.jsx)(s.code,{children:"reason"})," (",(0,i.jsx)(s.code,{children:"'EXPORT_FAILED'"}),"), ",(0,i.jsx)(s.code,{children:"errorMessage"}),", ",(0,i.jsx)(s.code,{children:"workerStep"}),", ",(0,i.jsx)(s.code,{children:"requestId"}),". Investigate export failures for corrupted state or serialization bugs."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Blocked"}),": ",(0,i.jsx)(s.code,{children:"worker.session_snapshot_blocked"})," warnings fire when snapshots are requested during restoration (",(0,i.jsx)(s.code,{children:"reason: 'RESTORE_IN_PROGRESS'"}),"). This is expected behavior; ensure callers wait for ",(0,i.jsx)(s.code,{children:"SESSION_RESTORED"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Error details structure"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"SNAPSHOT_FAILED"})," errors include structured ",(0,i.jsx)(s.code,{children:"details"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"reason"}),": ",(0,i.jsx)(s.code,{children:"'RESTORE_IN_PROGRESS'"})," (blocked during restore) or ",(0,i.jsx)(s.code,{children:"'EXPORT_FAILED'"})," (serialization error)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"workerStep"}),": Current runtime step when the error occurred"]}),"\n",(0,i.jsxs)(s.li,{children:["Additional fields from the underlying error (via ",(0,i.jsx)(s.code,{children:"extractErrorDetails()"}),")"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Troubleshooting"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["If snapshots consistently fail with ",(0,i.jsx)(s.code,{children:"'EXPORT_FAILED'"}),", check for circular references or non-serializable objects in game state."]}),"\n",(0,i.jsx)(s.li,{children:"If snapshot sizes grow unexpectedly, audit resource definitions for memory leaks (e.g., unbounded arrays in modifiers)."}),"\n",(0,i.jsx)(s.li,{children:"If snapshots block the tick loop (>10ms), consider deferring capture to idle periods or implementing incremental serialization."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"5-validation-checklist",children:"5. Validation Checklist"}),"\n",(0,i.jsx)(s.p,{children:"Run these commands from the repository root before promoting or flipping the feature flag:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"pnpm lint\npnpm test --filter shell-web\npnpm build --filter shell-web\n"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Attach logs (including the final ",(0,i.jsx)(s.code,{children:"vitest-llm-reporter"})," JSON) to the release note."]}),"\n",(0,i.jsxs)(s.li,{children:["If UI flows change (e.g., diagnostics panel, social tooling), run ",(0,i.jsx)(s.code,{children:"pnpm test:a11y"})," and capture any residual gaps in the deployment summary."]}),"\n",(0,i.jsxs)(s.li,{children:["Verify ",(0,i.jsx)(s.code,{children:"packages/shell-web/dist/index.html"})," references the hashed worker asset; mismatches indicate a stale build."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"6-troubleshooting-playbook",children:"6. Troubleshooting Playbook"}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Symptom"}),(0,i.jsx)(s.th,{children:"Likely Cause"}),(0,i.jsx)(s.th,{children:"Checks & Fix"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsxs)(s.td,{children:["No ",(0,i.jsx)(s.code,{children:"READY"})," message, ",(0,i.jsx)(s.code,{children:"awaitReady()"})," never resolves"]}),(0,i.jsx)(s.td,{children:"Worker asset missing or blocked by CSP"}),(0,i.jsxs)(s.td,{children:["Confirm ",(0,i.jsx)(s.code,{children:"dist/assets/runtime.worker-*.js"})," exists and is served with ",(0,i.jsx)(s.code,{children:"Content-Type: text/javascript"}),"; inspect network panel for 404/blocked requests."]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsxs)(s.td,{children:[(0,i.jsx)(s.code,{children:"RESTORE_FAILED"})," errors on boot"]}),(0,i.jsx)(s.td,{children:"Serialized state incompatible with runtime or corrupted payload"}),(0,i.jsxs)(s.td,{children:["Capture ",(0,i.jsx)(s.code,{children:"error.details"})," and rerun ",(0,i.jsx)(s.code,{children:"pnpm test --filter shell-web --runInBand"})," to reproduce with fixture saves. Validate content digests before calling ",(0,i.jsx)(s.code,{children:"restoreSession"}),"."]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Commands silently dropped"}),(0,i.jsxs)(s.td,{children:["Non-monotonic ",(0,i.jsx)(s.code,{children:"issuedAt"})," or commands queued during restore"]}),(0,i.jsxs)(s.td,{children:["Ensure callers await ",(0,i.jsx)(s.code,{children:"bridge.awaitReady()"})," and reuse ",(0,i.jsx)(s.code,{children:"sendCommand"}),". Monitor worker warnings for ",(0,i.jsx)(s.code,{children:"Dropping stale command"}),"."]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Diagnostics callbacks never fire"}),(0,i.jsxs)(s.td,{children:[(0,i.jsx)(s.code,{children:"enableDiagnostics"})," not invoked or subscription removed"]}),(0,i.jsx)(s.td,{children:"Confirm subscription sequence (enable \u2192 onDiagnosticsUpdate) and ensure diagnostics remains enabled in the worker. Remember diagnostics are disabled if the bridge disposes between renders."})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Worker leaks after navigation"}),(0,i.jsx)(s.td,{children:"Hook unmounted without disposing or multiple bridges instantiated"}),(0,i.jsxs)(s.td,{children:["Verify only one ",(0,i.jsx)(s.code,{children:"useWorkerBridge"})," consumer is active; ensure providers unmount on route changes. Use React DevTools to confirm no lingering bridge instance."]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsxs)(s.td,{children:["Social commands reject with ",(0,i.jsx)(s.code,{children:'"Social commands are disabled in this shell"'})," / worker error code ",(0,i.jsx)(s.code,{children:"SOCIAL_COMMANDS_DISABLED"})]}),(0,i.jsxs)(s.td,{children:[(0,i.jsx)(s.code,{children:"VITE_ENABLE_SOCIAL_COMMANDS"})," not set in the build environment"]}),(0,i.jsx)(s.td,{children:"Enable the env var (or launch flag) and redeploy; social command support stays off by default."})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsxs)(s.td,{children:[(0,i.jsx)(s.code,{children:"SNAPSHOT_FAILED"})," with ",(0,i.jsx)(s.code,{children:"reason: 'RESTORE_IN_PROGRESS'"})]}),(0,i.jsx)(s.td,{children:"Snapshot requested during active session restoration"}),(0,i.jsxs)(s.td,{children:["Wait for ",(0,i.jsx)(s.code,{children:"SESSION_RESTORED"})," message before requesting snapshots. Check telemetry for ",(0,i.jsx)(s.code,{children:"worker.session_snapshot_blocked"})," warnings. Normal behavior when snapshots race with restore operations."]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsxs)(s.td,{children:[(0,i.jsx)(s.code,{children:"SNAPSHOT_FAILED"})," with ",(0,i.jsx)(s.code,{children:"reason: 'EXPORT_FAILED'"})]}),(0,i.jsx)(s.td,{children:"State serialization error (circular refs, non-serializable objects)"}),(0,i.jsxs)(s.td,{children:["Inspect ",(0,i.jsx)(s.code,{children:"error.details"})," for the underlying cause. Check for circular references in game state or modifiers. Review resource definitions for objects that can't be JSON-serialized."]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Snapshot sizes unexpectedly large (>100 KB)"}),(0,i.jsx)(s.td,{children:"State bloat or memory leaks in resource modifiers"}),(0,i.jsxs)(s.td,{children:["Monitor ",(0,i.jsx)(s.code,{children:"worker.session_snapshot_captured"})," telemetry for ",(0,i.jsx)(s.code,{children:"snapshotBytes"})," and ",(0,i.jsx)(s.code,{children:"resourceCount"}),". Audit resource definitions for unbounded arrays or large data structures. Profile ",(0,i.jsx)(s.code,{children:"exportForSave()"})," to identify serialization bottlenecks."]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Snapshots block worker tick loop (>10ms)"}),(0,i.jsx)(s.td,{children:"Large game state or slow serialization"}),(0,i.jsxs)(s.td,{children:["Check ",(0,i.jsx)(s.code,{children:"worker.session_snapshot_captured"})," telemetry for capture duration. Consider deferring snapshots to idle periods or implementing incremental serialization. Profile ",(0,i.jsx)(s.code,{children:"exportForSave()"})," for performance bottlenecks."]})]})]})]}),"\n",(0,i.jsx)(s.h2,{id:"7-verification-artifacts",children:"7. Verification Artifacts"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Automated coverage: ",(0,i.jsx)(s.code,{children:"packages/shell-web/src/runtime.worker.test.ts"})," (handshake, diagnostics, command validation) and ",(0,i.jsx)(s.code,{children:"packages/shell-web/src/modules/worker-bridge.test.ts"})," (bridge queueing, disposal, social command gating). These correspond to implementations expected by issues #253 and #254."]}),"\n",(0,i.jsxs)(s.li,{children:["Manual smoke (record in release notes):","\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["Launch ",(0,i.jsx)(s.code,{children:"pnpm --filter shell-web dev"}),", open ",(0,i.jsx)(s.a,{href:"http://localhost:5173",children:"http://localhost:5173"}),", and confirm commands increment the runtime step counter."]}),"\n",(0,i.jsxs)(s.li,{children:["Toggle diagnostics via DevTools snippet (run after the shell mounts):","\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-js",children:"(async () => {\n  const bridge = window.__IDLE_WORKER_BRIDGE__;\n  if (!bridge) {\n    throw new Error('Worker bridge has not initialised yet');\n  }\n  await bridge.awaitReady();\n  bridge.enableDiagnostics();\n  bridge.onDiagnosticsUpdate(console.log);\n})();\n"})}),"\n","Ensure console prints deltas and no dropped-entry spikes after idling 30s. Call ",(0,i.jsx)(s.code,{children:"bridge.disableDiagnostics()"})," when finished."]}),"\n",(0,i.jsxs)(s.li,{children:["Toggle ",(0,i.jsx)(s.code,{children:"VITE_ENABLE_WORKER_BRIDGE"})," (or deployment-level equivalent) off/on in staging to validate both the worker path and the inline fallback before promoting to production."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"8-follow-up--assumptions",children:"8. Follow-Up & Assumptions"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Flag retirement"}),": plan to remove ",(0,i.jsx)(s.code,{children:"VITE_ENABLE_WORKER_BRIDGE"})," once rollout Phase 3 completes and production monitoring stays green; track the cleanup under issue #262 and delete the inline fallback at the same time."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Persistence integration"}),": coordinate with issue #258 (Worker\u2194Shell persistence handoff) before enabling offline progression; the runbook will require updates once snapshot flows ship."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Telemetry completeness"}),": telemetry sink delivered in issue ",(0,i.jsx)(s.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/267",children:"#267"}),". Configure ",(0,i.jsx)(s.code,{children:"VITE_SHELL_ANALYTICS_ENDPOINT"})," (or ",(0,i.jsx)(s.code,{children:"SHELL_ANALYTICS_ENDPOINT"}),") per environment and monitor the ",(0,i.jsx)(s.code,{children:"idle-engine:telemetry"})," event stream for local validation before flipping production flags."]}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"Maintain this runbook alongside bridge code changes\u2014update sections 3\u20136 whenever the worker protocol, diagnostics behaviour, or deployment strategy evolves. Tag both leads for review to keep operational guidance authoritative."})]})}function h(e={}){const{wrapper:s}={...(0,o.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},7678:(e,s,n)=>{n.d(s,{R:()=>l,x:()=>t});var r=n(9430);const i={},o=r.createContext(i);function l(e){const s=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function t(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),r.createElement(o.Provider,{value:s},e.children)}}}]);