"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[7105],{7678:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>a});var s=i(9430);const t={},r=s.createContext(t);function o(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),s.createElement(r.Provider,{value:n},e.children)}},8538:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"idle-engine-design","title":"Idle Engine Design Document","description":"1. Overview","source":"@site/../../docs/idle-engine-design.md","sourceDirName":".","slug":"/idle-engine-design","permalink":"/Idle-Game-Engine/idle-engine-design","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/idle-engine-design.md","tags":[],"version":"current","frontMatter":{},"sidebar":"developerSidebar","previous":{"title":"Design Document Template","permalink":"/Idle-Game-Engine/design-document-template"},"next":{"title":"Runtime Step Lifecycle Alignment","permalink":"/Idle-Game-Engine/runtime-step-lifecycle"}}');var t=i(5270),r=i(7678);const o={},a="Idle Engine Design Document",l={},c=[{value:"1. Overview",id:"1-overview",level:2},{value:"2. Goals",id:"2-goals",level:2},{value:"3. Non-Goals",id:"3-non-goals",level:2},{value:"4. Economy Model (GEL-001)",id:"4-economy-model-gel-001",level:2},{value:"5. Use Cases",id:"5-use-cases",level:2},{value:"6. Functional Requirements",id:"6-functional-requirements",level:2},{value:"7. Non-Functional Requirements",id:"7-non-functional-requirements",level:2},{value:"8. Architecture Overview",id:"8-architecture-overview",level:2},{value:"9. Core Runtime Design",id:"9-core-runtime-design",level:2},{value:"9.1 Simulation Scheduler",id:"91-simulation-scheduler",level:3},{value:"9.1.1 Tick Pseudocode",id:"911-tick-pseudocode",level:4},{value:"9.2 State Model",id:"92-state-model",level:3},{value:"9.3 Systems",id:"93-systems",level:3},{value:"9.4 Script Hooks",id:"94-script-hooks",level:3},{value:"9.5 Persistence",id:"95-persistence",level:3},{value:"9.6 Social Services Integration",id:"96-social-services-integration",level:3},{value:"9.7 Authentication &amp; Integrity Controls",id:"97-authentication--integrity-controls",level:3},{value:"10. Content Pipeline",id:"10-content-pipeline",level:2},{value:"11. Presentation Layer Contracts",id:"11-presentation-layer-contracts",level:2},{value:"12. Performance Strategy",id:"12-performance-strategy",level:2},{value:"13. Tooling &amp; Developer Experience",id:"13-tooling--developer-experience",level:2},{value:"14. Testing Strategy",id:"14-testing-strategy",level:2},{value:"15. Deployment &amp; Distribution",id:"15-deployment--distribution",level:2},{value:"16. Analytics &amp; Telemetry",id:"16-analytics--telemetry",level:2},{value:"17. Security Considerations",id:"17-security-considerations",level:2},{value:"18. Roadmap (High-Level)",id:"18-roadmap-high-level",level:2},{value:"19. Prototype Milestone Plan",id:"19-prototype-milestone-plan",level:2},{value:"20. Open Questions",id:"20-open-questions",level:2},{value:"Appendix A \u2014 Economy Glossary (GEL-001)",id:"appendix-a--economy-glossary-gel-001",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"idle-engine-design-document",children:"Idle Engine Design Document"})}),"\n",(0,t.jsx)(n.h2,{id:"1-overview",children:"1. Overview"}),"\n",(0,t.jsx)(n.p,{children:"The Idle Engine is a reusable, data-driven runtime tailored for incremental/idle games. It separates optimized simulation services from game-specific content so that multiple titles can wrap the same core engine. The architecture targets a web-first execution environment while keeping the runtime portable to desktop shells (Electron/Tauri) without rewriting logic."}),"\n",(0,t.jsx)(n.h2,{id:"2-goals",children:"2. Goals"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Deliver a shared runtime that multiple idle games can layer content on top of with minimal duplication."}),"\n",(0,t.jsx)(n.li,{children:"Maintain deterministic, efficient simulations capable of running in background tabs or native shells with minimal CPU and memory usage."}),"\n",(0,t.jsx)(n.li,{children:"Provide a declarative content pipeline for defining resources, generators, upgrades, achievements, and events."}),"\n",(0,t.jsx)(n.li,{children:"Support instant deployment to browsers while enabling optional native packaging with the exact same engine build."}),"\n",(0,t.jsx)(n.li,{children:"Keep the core easily testable, observable, and instrumentable for analytics and A/B experimentation."}),"\n",(0,t.jsxs)(n.li,{children:["Stabilise shared/global economy via a server-authoritative ledger and economic invariants as defined in ",(0,t.jsx)(n.code,{children:"docs/global-economy-ledger-design.md"})," (initiative ",(0,t.jsx)(n.code,{children:"GEL-001"}),")."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"3-non-goals",children:"3. Non-Goals"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Building a general-purpose 3D engine or real-time action framework."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Supporting platforms with no modern browser/WebView runtime."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Shipping a visual content editor in the first iteration (can be roadmap work)."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Primary runtime language is TypeScript targeting modern browsers; heavy math/automation can move into WebAssembly modules (Rust/Zig) if profiling warrants it."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Single-threaded determinism is sufficient for core simulation; concurrency is limited to Web Workers for isolation."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Persistence leverages IndexedDB/localStorage in browser shells and filesystem APIs in native wrappers."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Network services (leaderboards, guild coordination) are optional for core loop but must be reachable when social features are in use."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Default deployment self-hosts social services, with adapter interface enabling migration to managed platforms when required."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Authentication built on OpenID Connect; baseline deployment uses self-hosted Keycloak (or Ory Hydra/Kratos), and tokens remain compatible with managed OIDC providers."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"4-economy-model-gel-001",children:"4. Economy Model (GEL-001)"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Hard vs soft split: ",(0,t.jsx)(n.strong,{children:"hard currencies"})," are server-authoritative and only mutate through validated social service operations; ",(0,t.jsx)(n.strong,{children:"soft progression"})," (local resources, upgrades, automation) stays client-authoritative and deterministic inside the runtime."]}),"\n",(0,t.jsx)(n.li,{children:"Ledger ownership: the social service maintains the canonical ledger for all hard currencies (balances, transactions, guild contributions) and enforces invariants such as no overspend, bounded earn rates, and authenticated identities."}),"\n",(0,t.jsx)(n.li,{children:"Client/server cooperation: clients can render optimistic UI for spends/transfers but reconcile using authoritative ledger responses; discrepancies clamp to server values and can trigger anomaly flags."}),"\n",(0,t.jsx)(n.li,{children:"Verification: when needed, the social service can perform deterministic replay using the runtime under Node to bound-check suspicious claims without running a continuous server-side simulation."}),"\n",(0,t.jsxs)(n.li,{children:["Navigation: see ",(0,t.jsx)(n.code,{children:"docs/global-economy-ledger-design.md"})," (",(0,t.jsx)(n.code,{children:"GEL-001"}),") for API shapes, invariants, replay workflow, and delivery plan; high-level docs should point there when describing shared economy behaviour."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"5-use-cases",children:"5. Use Cases"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Wrap the engine with different content modules to create new idle games quickly."}),"\n",(0,t.jsx)(n.li,{children:"Patch content live without redeploying the runtime (configuration-driven events, seasonal content)."}),"\n",(0,t.jsx)(n.li,{children:"Run automated simulations for balance verification and analytics inside Node.js."}),"\n",(0,t.jsx)(n.li,{children:"Package the engine with a native shell for offline desktop distribution or stores requiring binaries."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"6-functional-requirements",children:"6. Functional Requirements"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Data-driven definition of: resources, generators, transforms, upgrades, milestones/achievements, prestige/reset layers."}),"\n",(0,t.jsx)(n.li,{children:"Deterministic tick scheduler with support for fixed-step and adaptive catch-up (offline progress credit)."}),"\n",(0,t.jsx)(n.li,{children:"Event system for triggers (resource thresholds, time, scripted conditions)."}),"\n",(0,t.jsx)(n.li,{children:"Save/load with versioned schemas and forward-compatible migrations; saves scoped per title with no cross-game import."}),"\n",(0,t.jsx)(n.li,{children:"UI integration layer exposing state snapshots and delta streams for rendering frameworks (React/Svelte/etc.)."}),"\n",(0,t.jsx)(n.li,{children:"Instrumentation hooks (metrics/events) for analytics."}),"\n",(0,t.jsx)(n.li,{children:"Social layer services: leaderboards (global, guild) and guild roster/state management with server synchronization APIs."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"7-non-functional-requirements",children:"7. Non-Functional Requirements"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Idle tick loop must sustain 60 ticks/sec in foreground and efficient low-frequency batching in background.",(0,t.jsx)("br",{})]}),"\n",(0,t.jsx)(n.li,{children:"Engine memory footprint under ~5 MB for moderate content sets; no unbounded data growth."}),"\n",(0,t.jsx)(n.li,{children:"State serialization/deserialization under 10 ms for typical saves."}),"\n",(0,t.jsx)(n.li,{children:"Content module API stable across game releases; breaking changes require version negotiation."}),"\n",(0,t.jsx)(n.li,{children:"Social services must tolerate intermittent connectivity and reconcile state when clients reconnect."}),"\n",(0,t.jsx)(n.li,{children:"Test automation coverage for tick math, offline progression, prestige resets, migrations, and leaderboard/guild flows."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"8-architecture-overview",children:"8. Architecture Overview"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"+------------------------------+\n|          Presentation        |\n| (Web UI, Native Shell UI)    |\n+------------------------------+\n              |\n              v\n+------------------------------+\n|      Engine Integration      |\n|  (Runtime Adapter, IPC/API)  |\n+------------------------------+\n              |\n              v\n+------------------------------+\n|         Core Runtime         |\n|  - Simulation Scheduler      |\n|  - State Graph               |\n|  - Systems (Progression,     |\n|    Automation, Events)       |\n+------------------------------+\n              |\n              v\n+------------------------------+\n|       Content Modules        |\n| (Game-specific data + rules) |\n+------------------------------+\n              |\n              v\n+------------------------------+\n|     Social/Cloud Services    |\n|  (Leaderboards, Guild APIs)  |\n+------------------------------+\n"})}),"\n",(0,t.jsx)(n.p,{children:"The runtime executes inside a Web Worker (browser) or dedicated thread (Node/native). Presentation layers communicate via a message channel (postMessage or IPC). Content modules register definitions at initialization and inject custom logic via well-scoped callbacks.\nSocial features interact with self-hosted backend services by default through the integration layer, which handles secure API calls, caching, and reconciliation. Adapter boundaries allow swapping to managed providers without engine rewrites."}),"\n",(0,t.jsx)(n.h2,{id:"9-core-runtime-design",children:"9. Core Runtime Design"}),"\n",(0,t.jsx)(n.h3,{id:"91-simulation-scheduler",children:"9.1 Simulation Scheduler"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Fixed timestep (default 100 ms) with accumulators to handle real-time catch-up."}),"\n",(0,t.jsx)(n.li,{children:"Offline progression: on resume/load, compute elapsed time and run batched ticks with configurable caps (eg. max 12 hours) to avoid runaway progression."}),"\n",(0,t.jsx)(n.li,{children:"Background throttling: detect document visibility or shell signals to adjust tick frequency and reduce CPU use."}),"\n",(0,t.jsxs)(n.li,{children:["Scheduler implemented as a deterministic loop: accumulate elapsed real time, clamp per-frame step count, process ",(0,t.jsx)(n.code,{children:"systems"})," in a fixed order for deterministic results."]}),"\n",(0,t.jsx)(n.li,{children:"Tick pipeline executes in phases (input intents, automation, production, progression, events) with hooks so content modules can subscribe without reordering core systems."}),"\n",(0,t.jsx)(n.li,{children:"Provide instrumentation probes (tick duration, queue backlog) surfaced via diagnostics interface for tuning."}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"911-tick-pseudocode",children:"9.1.1 Tick Pseudocode"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"function runTick(deltaMs) {\n  accumulator += deltaMs;\n  const steps = clamp(floor(accumulator / FIXED_STEP_MS), 0, MAX_STEPS_PER_FRAME);\n  accumulator -= steps * FIXED_STEP_MS;\n  for (let i = 0; i < steps; i++) {\n    applyQueuedCommands();\n    automationSystem.tick();\n    productionSystem.tick();\n    progressionSystem.tick();\n    eventSystem.tick();\n    telemetry.recordTick();\n  }\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"92-state-model",children:"9.2 State Model"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Normalized resource graph: each resource has identifiers, quantity, rate, metadata."}),"\n",(0,t.jsx)(n.li,{children:"Systems maintain derived state (per second production, unlocked status)."}),"\n",(0,t.jsx)(n.li,{children:"Use structural sharing or typed arrays for efficient snapshots; avoid deep clone churn."}),"\n",(0,t.jsxs)(n.li,{children:["Core entities stored in struct-of-arrays layout (",(0,t.jsx)(n.code,{children:"resourceIds[]"}),", ",(0,t.jsx)(n.code,{children:"quantities[]"}),", ",(0,t.jsx)(n.code,{children:"rates[]"}),") for cache-friendly iteration."]}),"\n",(0,t.jsx)(n.li,{children:"Derived views published as read-only proxies to presentation layer to avoid mutation leaks."}),"\n",(0,t.jsx)(n.li,{children:"Change journal collects mutations each tick so deltas can be sent to clients without serializing full state."}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"93-systems",children:"9.3 Systems"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Production System"}),": processes generators, cost reductions, automation toggles."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Upgrade System"}),": resolves prerequisites, applies modifiers (additive, multiplicative, exponential) via composable formula pipelines."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Prestige System"}),": manages layer resets with carry-over rewards."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Event System"}),": publishes domain events (e.g., thresholds met) for UI/analytics."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Task Scheduler"}),": handles time-based tasks (quests, research timers) with pause/resume semantics."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Social System"}),": interfaces with leaderboard and guild services, queues outbound intents, applies confirmed updates, and reconciles conflicts on reconnect."]}),"\n",(0,t.jsx)(n.li,{children:"Systems register deterministic execution order and optional dependencies; engine validates order at startup to prevent circular hooks."}),"\n",(0,t.jsxs)(n.li,{children:["Modifiers expressed as pure functions operating on typed contexts (",(0,t.jsx)(n.code,{children:"ResourceCtx"}),", ",(0,t.jsx)(n.code,{children:"GeneratorCtx"}),") to preserve testability."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"94-script-hooks",children:"9.4 Script Hooks"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Script layer exposes deterministic APIs (no direct async). Hooks run inside simulation step for predictable results."}),"\n",(0,t.jsx)(n.li,{children:"Optional sandbox (QuickJS/WASM) for third-party content without compromising core runtime."}),"\n",(0,t.jsx)(n.li,{children:"Script host provides whitelisted math/util modules and deterministic random via seeded RNG per save."}),"\n",(0,t.jsx)(n.li,{children:"Hooks execute within time budget; overruns generate diagnostics and can be killed to preserve tick cadence."}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"95-persistence",children:"9.5 Persistence"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"State snapshots serialized to binary (MessagePack or custom) to minimize size."}),"\n",(0,t.jsx)(n.li,{children:"Versioned schema with migration pipeline to ensure backward compatibility."}),"\n",(0,t.jsx)(n.li,{children:"Autosave scheduler (e.g., every 30 seconds, on significant events, and before unload)."}),"\n",(0,t.jsx)(n.li,{children:"Per-title save slots keyed by content package; no cross-title sharing to avoid balance exploits."}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"96-social-services-integration",children:"9.6 Social Services Integration"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Provide REST/gRPC client wrappers for leaderboard submissions, guild roster updates, messaging, and reward claims."}),"\n",(0,t.jsx)(n.li,{children:"Support optimistic UI updates with eventual server confirmation; roll back state when server rejects a change."}),"\n",(0,t.jsx)(n.li,{children:"Enforce rate limiting, authentication tokens, and replay protection to deter cheating."}),"\n",(0,t.jsx)(n.li,{children:"Offer abstraction so implementations can swap between in-house services and third-party platforms without touching game logic."}),"\n",(0,t.jsx)(n.li,{children:"Ship a reference self-host service (e.g., Node/Rust) with deployment scripts (Docker/Kubernetes) and clearly defined interfaces for alternative providers."}),"\n",(0,t.jsx)(n.li,{children:"Document data schemas and synchronization contracts so external platforms can implement compatible APIs."}),"\n",(0,t.jsxs)(n.li,{children:["For global economy stability and hard-currency invariants, rely on a server-authoritative ledger and economy APIs as specified in ",(0,t.jsx)(n.code,{children:"docs/global-economy-ledger-design.md"})," (initiative ",(0,t.jsx)(n.code,{children:"GEL-001"}),")."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"97-authentication--integrity-controls",children:"9.7 Authentication & Integrity Controls"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Self-hosted Keycloak instance issues short-lived JWT access tokens and rotation-backed refresh tokens; clients authenticate via email magic link or device key exchange."}),"\n",(0,t.jsx)(n.li,{children:"Engine SDK signs every social mutation with the current token and device fingerprint; backend validates signature, token scope, and rate limits per identity/device/IP."}),"\n",(0,t.jsx)(n.li,{children:"Server derives authoritative leaderboard scores (never trusts raw client totals) and clamps suspicious deltas before persistence."}),"\n",(0,t.jsx)(n.li,{children:"Telemetry pipeline feeds anomaly detection (baseline heuristics + configurable z-score rules) that can flag or quarantine accounts automatically."}),"\n",(0,t.jsx)(n.li,{children:"Adapter interfaces accept any OIDC-compliant IdP so partners can switch to managed providers (Auth0, Cognito, etc.) without changing client code."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"10-content-pipeline",children:"10. Content Pipeline"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Content described via declarative TypeScript/JSON modules and compiled into normalized definitions."}),"\n",(0,t.jsx)(n.li,{children:"Support for hierarchical content packages (base game, seasonal event, micro-DLC) with dependency resolution."}),"\n",(0,t.jsx)(n.li,{children:"Validation tooling to verify IDs, cyclical dependencies, formula sanity before shipping."}),"\n",(0,t.jsxs)(n.li,{children:["Property-based sanitization guidance lives in ",(0,t.jsx)(n.a,{href:"/Idle-Game-Engine/content-schema-rollout-decisions#6-property-based-formula-sanitization-guidance",children:(0,t.jsx)(n.code,{children:"docs/content-schema-rollout-decisions.md#6-property-based-formula-sanitization-guidance"})}),"; run the schema and CLI suites before shipping new formulas."]}),"\n",(0,t.jsx)(n.li,{children:"Provide CLI to bundle content, generate documentation, and run balance simulations."}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"pnpm generate"})," invokes ",(0,t.jsx)(n.code,{children:"tools/content-schema-cli"}),", which now validates every ",(0,t.jsx)(n.code,{children:"content/pack.json"})," via ",(0,t.jsx)(n.code,{children:"@idle-engine/content-schema"})," before refreshing runtime event manifests. The CLI emits structured JSON log events (",(0,t.jsx)(n.code,{children:"content_pack.validated"}),", ",(0,t.jsx)(n.code,{children:"content_pack.compiled"}),", ",(0,t.jsx)(n.code,{children:"content_pack.validation_failed"}),", ",(0,t.jsx)(n.code,{children:"watch.run"}),", etc.) so automation can gate builds on failures, warnings, or drift."]}),"\n",(0,t.jsxs)(n.li,{children:["Watch and check flows are first-class: ",(0,t.jsx)(n.code,{children:"--watch"})," keeps the pipeline alive after failures while surfacing iteration summaries, and ",(0,t.jsx)(n.code,{children:"--check"})," exits non-zero whenever validation summaries or compiled artifacts would change. Lefthook and CI invoke ",(0,t.jsx)(n.code,{children:"pnpm generate --check"})," to prevent stale outputs from landing."]}),"\n",(0,t.jsxs)(n.li,{children:["Every run persists a workspace summary at ",(0,t.jsx)(n.code,{children:"content/compiled/index.json"})," (overrideable via ",(0,t.jsx)(n.code,{children:"--summary"}),") that records validation and compilation status. Downstream tooling must treat the summary as stale when validation fails or the CLI reports drift; rerun ",(0,t.jsx)(n.code,{children:"pnpm generate"})," to refresh artifacts before consumption."]}),"\n",(0,t.jsxs)(n.li,{children:["Authoring packs live alongside their manifests (e.g., ",(0,t.jsx)(n.code,{children:"packages/content-sample/content/pack.json"}),"). Keep schema warnings at zero, add missing localized variants for declared locales, and document intentional deviations so future migrations stay deterministic."]}),"\n",(0,t.jsx)(n.li,{children:"Extendable DSL supports custom modifiers, scripted events, and guild-related hooks while maintaining sandbox boundaries."}),"\n",(0,t.jsx)(n.li,{children:"DSL expressed as strongly typed schemas (Zod) compiled into immutable definitions; support YAML option for non-TS teams via build-time conversion."}),"\n",(0,t.jsx)(n.li,{children:"Each content item declares metadata (version, compatibility range), resource/generator definitions, formulas (expressed as AST or limited expression strings), and unlock conditions."}),"\n",(0,t.jsx)(n.li,{children:"Preprocessors resolve derived values (e.g., cumulative cost curves) and emit warnings when difficulty spikes exceed configured thresholds."}),"\n",(0,t.jsx)(n.li,{children:"Content lints enforce naming conventions, ID uniqueness, and forbid direct references across prestige layers without explicit bridges."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Follow-up migration work: wire the DSL compiler to emit schema-aligned packs instead of hand-authored TypeScript, port legacy sample data into the CLI format, and extend CI so schema warnings fail builds once the broader content library lands."}),"\n",(0,t.jsx)(n.h2,{id:"11-presentation-layer-contracts",children:"11. Presentation Layer Contracts"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Runtime sends UI ready snapshots through a state channel; UI sends user intents (purchase upgrade, toggle automation) via command channel."}),"\n",(0,t.jsx)(n.li,{children:"Presentation shell chooses framework (React, Svelte, plain DOM); engine only depends on the contract."}),"\n",(0,t.jsx)(n.li,{children:"Desktop wrapper uses the same contract through IPC between WebView and Node host."}),"\n",(0,t.jsx)(n.li,{children:"Provide default UI kit (resource panels, upgrade lists, modals) for rapid prototyping while allowing custom skins."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"12-performance-strategy",children:"12. Performance Strategy"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Run simulation in Web Worker with transferable state buffers to avoid main thread jank."}),"\n",(0,t.jsx)(n.li,{children:"Use data-oriented structures (typed arrays, struct-of-arrays) for high-frequency calculations."}),"\n",(0,t.jsx)(n.li,{children:"Memoize derived stats and recompute lazily when source data changes."}),"\n",(0,t.jsx)(n.li,{children:"Profile with browser tools and Node benchmarks; escalate hotspots to WebAssembly implementations when ROI is justified."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"13-tooling--developer-experience",children:"13. Tooling & Developer Experience"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Monorepo using pnpm or Turborepo: ",(0,t.jsx)(n.code,{children:"packages/core"}),", ",(0,t.jsx)(n.code,{children:"packages/content-{game}"}),", ",(0,t.jsx)(n.code,{children:"packages/shell-web"}),", ",(0,t.jsx)(n.code,{children:"packages/shell-desktop"}),", ",(0,t.jsx)(n.code,{children:"packages/tools"}),"."]}),"\n",(0,t.jsx)(n.li,{children:"Shared type definitions and schema validation via Zod or similar."}),"\n",(0,t.jsx)(n.li,{children:"CLI tools for content linting, simulation playback, save migration testing."}),"\n",(0,t.jsx)(n.li,{children:"Storybook or component library for UI kit review."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"14-testing-strategy",children:"14. Testing Strategy"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Unit tests for tick calculations, formula evaluation, and state reducers."}),"\n",(0,t.jsx)(n.li,{children:"Property-based tests for resource balance invariants (e.g., never negative resources)."}),"\n",(0,t.jsx)(n.li,{children:"Integration tests running full simulations for offline progress scenarios."}),"\n",(0,t.jsx)(n.li,{children:"Snapshot tests for content definitions to catch accidental changes."}),"\n",(0,t.jsx)(n.li,{children:"End-to-end UI smoke tests (Playwright) against web shell."}),"\n",(0,t.jsx)(n.li,{children:"Contract tests covering leaderboard submissions, guild workflows, and offline/online reconciliation paths."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"15-deployment--distribution",children:"15. Deployment & Distribution"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Browser build: bundle core runtime and content, serve via CDN. Use service workers for offline caching."}),"\n",(0,t.jsx)(n.li,{children:"Desktop build: package web artifacts with Tauri/Electron; leverage native file system for saves and optional Steam integrations."}),"\n",(0,t.jsx)(n.li,{children:"Continuous delivery pipeline runs tests, bundles content, publishes npm packages for runtime and tools."}),"\n",(0,t.jsx)(n.li,{children:"Runtime versioning: semantic version with engine-API compatibility matrix for content packs."}),"\n",(0,t.jsx)(n.li,{children:"Social services deploy independently; provide feature flag management for staged leaderboards and guild rollouts."}),"\n",(0,t.jsx)(n.li,{children:"Licensing delivered through a partner program: partners receive vetted runtime binaries, API keys for social services, and compliance guidelines."}),"\n",(0,t.jsx)(n.li,{children:"Provide infrastructure-as-code templates for self-host deployments (Docker Compose for local, Terraform/Kubernetes for production) and guidance for migrating to managed leaderboard providers."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"16-analytics--telemetry",children:"16. Analytics & Telemetry"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Provide opt-in telemetry hooks (events, state snapshots) sending via fetch/beacon or native channels."}),"\n",(0,t.jsx)(n.li,{children:"Ensure privacy compliance; keep PII out of default payloads."}),"\n",(0,t.jsx)(n.li,{children:"Allow games to register custom metrics using shared instrumentation API."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"17-security-considerations",children:"17. Security Considerations"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Sandbox third-party scripts to prevent DOM or host access."}),"\n",(0,t.jsx)(n.li,{children:"Validate content bundles before loading to avoid malicious overrides."}),"\n",(0,t.jsx)(n.li,{children:"Harden save loading with schema validation to avoid corrupted states."}),"\n",(0,t.jsx)(n.li,{children:"Rotate API secrets regularly, store them in Vault/Secrets Manager, and audit access logs."}),"\n",(0,t.jsx)(n.li,{children:"Provide moderation tooling to ban or shadowban users flagged by integrity rules, and support rapid leaderboard purges."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"18-roadmap-high-level",children:"18. Roadmap (High-Level)"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Prototype core runtime: tick loop, resource model, basic upgrades, persistence."}),"\n",(0,t.jsx)(n.li,{children:"Build web shell with default UI kit and integration channel."}),"\n",(0,t.jsx)(n.li,{children:"Ship CLI tooling for content definition linting and simulation tests."}),"\n",(0,t.jsx)(n.li,{children:"Produce reference game module to validate end-to-end loop."}),"\n",(0,t.jsx)(n.li,{children:"Implement offline progression, prestige layers, analytics hooks."}),"\n",(0,t.jsx)(n.li,{children:"Stand up leaderboard and guild services; integrate authentication and moderation tooling."}),"\n",(0,t.jsx)(n.li,{children:"Optimize performance hotspots; introduce WebAssembly modules as needed."}),"\n",(0,t.jsx)(n.li,{children:"Package desktop shell; add cloud sync optional module."}),"\n",(0,t.jsx)(n.li,{children:"Explore content editor and modding workflows."}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"19-prototype-milestone-plan",children:"19. Prototype Milestone Plan"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Objective"}),": Deliver a vertical slice proving the engine loop, content DSL, and social scaffolding within 8 weeks."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Milestone Deliverables"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"packages/core"}),": runnable runtime with scheduler, resource system, upgrade processor, save/load (JSON stub), diagnostics dashboard."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"packages/shell-web"}),": minimal React UI consuming state snapshots, executing commands, and visualizing resources/upgrades."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"packages/content-sample"}),": reference game pack with ~10 resources, 6 generators, basic prestige layer, and sample guild perks."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"services/social"}),": self-hosted Node (NestJS) or Rust (Axum) API providing stubbed leaderboard/guild endpoints with Keycloak integration."]}),"\n",(0,t.jsx)(n.li,{children:"CI pipeline executing unit/integration tests and linting content."}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Workstreams & Sequencing"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Foundation (Week 1-2): set up monorepo tooling (pnpm, ESLint, Vitest), implement scheduler skeleton, resource data structures, command bus."}),"\n",(0,t.jsx)(n.li,{children:"Content & DSL (Week 2-4): define schemas, build content compiler, create sample content pack, implement validation CLI."}),"\n",(0,t.jsx)(n.li,{children:"Presentation Adapter (Week 3-5): integrate Worker runtime with React shell, implement delta subscription, basic UI kit components."}),"\n",(0,t.jsx)(n.li,{children:"Persistence & Offline (Week 4-6): add save/load, offline catch-up logic, autosave timers, smoke tests."}),"\n",(0,t.jsx)(n.li,{children:"Social Stub (Week 5-7): deploy Keycloak, implement social API, integrate token validation in engine SDK, mock leaderboard UI."}),"\n",(0,t.jsx)(n.li,{children:"Hardening (Week 7-8): profiling, test coverage targets, docs (runbooks, developer guide), milestone demo."}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Success Criteria"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Reference game runs at 60 ticks/sec in browser foreground with under 30% main-thread utilization on target hardware."}),"\n",(0,t.jsx)(n.li,{children:"Offline catch-up accurately simulates up to 12 hours without divergence from continuous play baseline."}),"\n",(0,t.jsx)(n.li,{children:"Leaderboard submissions authenticated via Keycloak and shown in UI (stubbed data acceptable)."}),"\n",(0,t.jsx)(n.li,{children:"Content CLI blocks invalid definitions and outputs human-friendly diagnostics."}),"\n",(0,t.jsx)(n.li,{children:"CI pipeline green (unit, integration, lint) and docker-compose stack (engine + Keycloak + social API) launches via single command."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"20-open-questions",children:"20. Open Questions"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"How do we expose extensibility to partners while preserving engine stability (module vetting, version caps)?"}),"\n",(0,t.jsx)(n.li,{children:"Which managed providers should we validate adapters against, and what migration tooling do partners need?"}),"\n",(0,t.jsx)(n.li,{children:"Which telemetry thresholds or machine-learning models will we standardize on for automated cheat detection escalation?"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"appendix-a--economy-glossary-gel-001",children:"Appendix A \u2014 Economy Glossary (GEL-001)"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Hard currency: server-authoritative currency recorded in the global ledger; mutations only occur through authenticated social service operations that enforce invariants (no overspend, bounded earns)."}),"\n",(0,t.jsx)(n.li,{children:"Soft progression: client-authoritative simulation state (resources, upgrades, automation) managed deterministically by the runtime; reconciles only on sync boundaries where hard currency balances are authoritative."}),"\n",(0,t.jsxs)(n.li,{children:["Server-authoritative ledger: social service subsystem that maintains canonical balances and transaction history for hard currencies, powers leaderboards/guild contributions, and is documented in ",(0,t.jsx)(n.code,{children:"docs/global-economy-ledger-design.md"}),"."]}),"\n",(0,t.jsx)(n.li,{children:"Optimistic UI + reconciliation: client may show provisional spend/transfer results but must apply server responses to clamp balances to ledger truth and surface rejection metadata."}),"\n",(0,t.jsx)(n.li,{children:"Deterministic replay verification: optional server-side check that replays a bounded segment of simulation using the runtime (Node) to validate suspicious economic claims without running continuous server ticks."}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}}}]);