"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[8203],{7678:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>a});var i=t(9430);const s={},r=i.createContext(s);function o(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(r.Provider,{value:n},e.children)}},9855:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"runtime-event-bus-decisions","title":"Decision Record: Runtime Event Bus Follow-ups","description":"Status: Accepted","source":"@site/../../docs/runtime-event-bus-decisions.md","sourceDirName":".","slug":"/runtime-event-bus-decisions","permalink":"/Idle-Game-Engine/runtime-event-bus-decisions","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/runtime-event-bus-decisions.md","tags":[],"version":"current","frontMatter":{},"sidebar":"developerSidebar","previous":{"title":"Runtime Event Pub/Sub Design","permalink":"/Idle-Game-Engine/runtime-event-pubsub-design"},"next":{"title":"Runtime Event Manifest Authoring","permalink":"/Idle-Game-Engine/runtime-event-manifest-authoring"}}');var s=t(5270),r=t(7678);const o={},a="Decision Record: Runtime Event Bus Follow-ups",d={},l=[{value:"Context",id:"context",level:2},{value:"Decisions",id:"decisions",level:2},{value:"1. Content packs declare events through schema-backed manifests",id:"1-content-packs-declare-events-through-schema-backed-manifests",level:3},{value:"2. No additional priority tiers; deterministic order follows publish time",id:"2-no-additional-priority-tiers-deterministic-order-follows-publish-time",level:3},{value:"3. Channel-scoped diagnostic throttling with adaptive soft limits",id:"3-channel-scoped-diagnostic-throttling-with-adaptive-soft-limits",level:3},{value:"4. Struct-of-arrays remains the primary wire format with guard rails",id:"4-struct-of-arrays-remains-the-primary-wire-format-with-guard-rails",level:3},{value:"Consequences",id:"consequences",level:2},{value:"Next Steps",id:"next-steps",level:2}];function c(e){const n={br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"decision-record-runtime-event-bus-follow-ups",children:"Decision Record: Runtime Event Bus Follow-ups"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Status:"})," Accepted",(0,s.jsx)(n.br,{}),"\n",(0,s.jsx)(n.strong,{children:"Date:"})," 2025-10-16",(0,s.jsx)(n.br,{}),"\n",(0,s.jsx)(n.strong,{children:"Related Work:"})," ",(0,s.jsx)(n.code,{children:"docs/runtime-event-pubsub-design.md"}),", issue #87"]}),"\n",(0,s.jsx)(n.h2,{id:"context",children:"Context"}),"\n",(0,s.jsx)(n.p,{children:"The runtime event bus design introduced in issue #8 left four areas open for\nvalidation before the feature could be considered production-ready:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Auto-registration of content-pack-defined events without destabilising replay\nmanifests."}),"\n",(0,s.jsx)(n.li,{children:"Whether the bus requires dedicated priority tiers to guarantee dispatch\nordering for urgent channels."}),"\n",(0,s.jsx)(n.li,{children:"A policy for throttling soft-limit diagnostics so repeated warnings remain\nactionable while respecting channel-specific thresholds."}),"\n",(0,s.jsx)(n.li,{children:"Confirmation that the struct-of-arrays transport proposed for event frames\nis still the best fit, or definition of a fallback path for sparse workloads."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"This record captures the final calls for each topic so downstream work can\nassume a stable contract."}),"\n",(0,s.jsx)(n.h2,{id:"decisions",children:"Decisions"}),"\n",(0,s.jsx)(n.h3,{id:"1-content-packs-declare-events-through-schema-backed-manifests",children:"1. Content packs declare events through schema-backed manifests"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Content packs may define additional runtime events, but registration happens\nduring the offline build pipeline. Pack manifests contribute ",(0,s.jsx)(n.code,{children:"eventTypes"}),"\nentries that include a ",(0,s.jsx)(n.code,{children:"namespace"}),", ",(0,s.jsx)(n.code,{children:"name"}),", ",(0,s.jsx)(n.code,{children:"version"}),", and schema reference."]}),"\n",(0,s.jsxs)(n.li,{children:["The build tooling emits a deterministic manifest ordered by the pair\n",(0,s.jsx)(n.code,{children:"(packSlug, eventKey)"})," and generates the TypeScript declaration used to extend\nthe ",(0,s.jsx)(n.code,{children:"RuntimeEventType"})," union. Generation is stable because the manifest is\nsorted and versioned; replays key off the ",(0,s.jsx)(n.code,{children:"(packSlug, eventKey, version)"})," tuple\nand refuse to load if the manifest hash changes."]}),"\n",(0,s.jsx)(n.li,{children:"Runtime registration is forbidden. Content packs shipped to players contain\nthe baked manifest so all environments share the exact event catalogue."}),"\n",(0,s.jsxs)(n.li,{children:["Follow-up: extend the existing content schema CLI to merge ",(0,s.jsx)(n.code,{children:"eventTypes"})," during\n",(0,s.jsx)(n.code,{children:"pnpm generate"}),". Owners of ",(0,s.jsx)(n.code,{children:"packages/content-sample"})," provide the first example."]}),"\n",(0,s.jsxs)(n.li,{children:["Authoring flow: ",(0,s.jsx)(n.code,{children:"docs/runtime-event-manifest-authoring.md"})," captures the manifest\nformat, generation command, and how the recorder validates the hash."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"2-no-additional-priority-tiers-deterministic-order-follows-publish-time",children:"2. No additional priority tiers; deterministic order follows publish time"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"The event bus keeps a single FIFO queue per tick. Priority tiers are deferred\nbecause they complicate determinism and make it harder to reason about replay\nequivalence."}),"\n",(0,s.jsx)(n.li,{children:"Systems that need earlier reactions must publish earlier (inside the command\nhandler) or subscribe to an explicit pre-commit hook. This remains consistent\nwith the command queue strategy."}),"\n",(0,s.jsx)(n.li,{children:"To prevent starvation, the dispatcher processes listeners in the order their\nsubscriptions were registered. Test fixtures will cover the deterministic\nordering contract."}),"\n",(0,s.jsx)(n.li,{children:"Follow-up: document the sequencing expectations for system authors and audit\nthe initial consumers to ensure they do not rely on implied priorities."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"3-channel-scoped-diagnostic-throttling-with-adaptive-soft-limits",children:"3. Channel-scoped diagnostic throttling with adaptive soft limits"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["The bus exposes ",(0,s.jsx)(n.code,{children:"EventDiagnostics"})," helpers that rate-limit soft-limit warnings\nper channel. Each channel provides a configuration with ",(0,s.jsx)(n.code,{children:"maxEventsPerTick"}),",\n",(0,s.jsx)(n.code,{children:"maxEventsPerSecond"}),", and an optional ",(0,s.jsx)(n.code,{children:"cooldownTicks"}),". Defaults are applied\nfrom the runtime config but can be tuned by integrators."]}),"\n",(0,s.jsx)(n.li,{children:"When a publisher exceeds the soft limit, the bus logs a warning once and\nincreases the cooldown (exponential backoff) before emitting the next warning.\nHard limits still throw determinism-breaking errors immediately."}),"\n",(0,s.jsxs)(n.li,{children:["Telemetry exports aggregate counters so dashboards can alert on sustained\npressure without spamming logs. The implementation emits\n",(0,s.jsx)(n.code,{children:"EventSoftLimitBreach"})," warnings, records per-channel increments through the\n",(0,s.jsx)(n.code,{children:"events.soft_limit_breaches"})," counter stream, and surfaces cooldown gauges via\n",(0,s.jsx)(n.code,{children:"events.cooldown_ticks"})," which feed the Prometheus metrics\n",(0,s.jsx)(n.code,{children:"idle_engine_events_soft_limit_breaches_total"})," and\n",(0,s.jsx)(n.code,{children:"idle_engine_events_soft_limit_cooldown_ticks"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"Follow-up: wire the diagnostic struct into the existing telemetry adapter and\nadd focused tests in the bus package."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"4-struct-of-arrays-remains-the-primary-wire-format-with-guard-rails",children:"4. Struct-of-arrays remains the primary wire format with guard rails"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Measurements with representative content indicate that struct-of-arrays keeps\ntransfer frames compact when multiple systems emit events in the same tick.\nThe approach also aligns with the resource delta pipeline, simplifying reuse."}),"\n",(0,s.jsx)(n.li,{children:"A fallback JSON object array is defined but only toggled when the average\nframe density drops below 2 events per channel over a rolling 256-tick window.\nThe toggle is feature-flagged to allow per-environment experimentation."}),"\n",(0,s.jsx)(n.li,{children:"The runtime exporter surfaces diagnostics when the fallback is activated so we\ncan revisit the default if sparse workloads become dominant."}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"EventBusOptions.frameExport.autoFallback.enabled"})," controls whether the\ndensity-driven downgrade is considered. When enabled, the runtime emits a\n",(0,s.jsx)(n.code,{children:"RuntimeEventFrameFormatChanged"})," telemetry warning any time the exporter flips\nformats and ",(0,s.jsx)(n.code,{children:"EventBus.getFrameExportState()"})," exposes the rolling window,\ndensity threshold, and active format so shells can display the state."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"RuntimeEventFrame"})," payloads now include a ",(0,s.jsx)(n.code,{children:"format"})," discriminator and optional\n",(0,s.jsx)(n.code,{children:"diagnostics"})," block; consumers should branch on the format before accessing\nstruct-of-arrays fields. Object-array exports surface the same metadata but\nprovide ",(0,s.jsx)(n.code,{children:"events[]"})," records instead of typed arrays."]}),"\n",(0,s.jsxs)(n.li,{children:["Benchmarks comparing both representations live under\n",(0,s.jsx)(n.code,{children:"packages/core/benchmarks"}),". Run ",(0,s.jsx)(n.code,{children:"pnpm --filter @idle-engine/core run benchmark"}),"\nto capture dense and sparse timings in CI logs."]}),"\n",(0,s.jsx)(n.li,{children:"Follow-up: add benchmark coverage for both formats and document the flag in\nthe shell transport guide."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"consequences",children:"Consequences"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Content packs gain a predictable path to extend the event taxonomy without\nrisking replay drift, but they must participate in the generation pipeline."}),"\n",(0,s.jsx)(n.li,{children:"Consumers can rely on strict FIFO ordering, which simplifies tests, though\nspecial-case preemption must be handled within publishers themselves."}),"\n",(0,s.jsx)(n.li,{children:"Diagnostics are actionable without overwhelming telemetry sinks, and the rate\nlimiter parameters can evolve per channel as new systems come online."}),"\n",(0,s.jsx)(n.li,{children:"The transport remains optimised for dense workloads while providing metrics\nand guard rails to detect when a simpler format would be preferable."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Update the content tooling to accept ",(0,s.jsx)(n.code,{children:"eventTypes"})," manifests and emit the\ngenerated union (",(0,s.jsx)(n.code,{children:"packages/content-sample"})," supplies the reference config)."]}),"\n",(0,s.jsx)(n.li,{children:"Implement the diagnostic helpers and wire them into the event bus exporter."}),"\n",(0,s.jsx)(n.li,{children:"Add benchmark and test coverage once the event bus lands to verify queue\nordering, throttling, and serialization toggling."}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}}}]);