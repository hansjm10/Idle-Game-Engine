"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[138],{7477:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>o,contentTitle:()=>d,default:()=>h,frontMatter:()=>t,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"runtime-client-prediction-rollback-design-issue-546","title":"Client Prediction and Rollback Design (Issue 546)","description":"Document Control","source":"@site/../../docs/runtime-client-prediction-rollback-design-issue-546.md","sourceDirName":".","slug":"/runtime-client-prediction-rollback-design-issue-546","permalink":"/Idle-Game-Engine/runtime-client-prediction-rollback-design-issue-546","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/runtime-client-prediction-rollback-design-issue-546.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"title":"Client Prediction and Rollback Design (Issue 546)","sidebar_position":4}}');var i=n(5270),c=n(7678);const t={title:"Client Prediction and Rollback Design (Issue 546)",sidebar_position:4},d="Client Prediction and Rollback Design (Issue 546)",o={},l=[{value:"Document Control",id:"document-control",level:2},{value:"1. Summary",id:"1-summary",level:2},{value:"2. Context &amp; Problem Statement",id:"2-context--problem-statement",level:2},{value:"3. Goals &amp; Non-Goals",id:"3-goals--non-goals",level:2},{value:"4. Stakeholders, Agents &amp; Impacted Surfaces",id:"4-stakeholders-agents--impacted-surfaces",level:2},{value:"5. Current State",id:"5-current-state",level:2},{value:"6. Proposed Solution",id:"6-proposed-solution",level:2},{value:"6.1 Architecture Overview",id:"61-architecture-overview",level:3},{value:"6.2 Detailed Design",id:"62-detailed-design",level:3},{value:"6.3 Operational Considerations",id:"63-operational-considerations",level:3},{value:"7. Work Breakdown &amp; Delivery Plan",id:"7-work-breakdown--delivery-plan",level:2},{value:"7.1 Issue Map",id:"71-issue-map",level:3},{value:"7.2 Milestones",id:"72-milestones",level:3},{value:"7.3 Coordination Notes",id:"73-coordination-notes",level:3},{value:"8. Agent Guidance &amp; Guardrails",id:"8-agent-guidance--guardrails",level:2},{value:"9. Alternatives Considered",id:"9-alternatives-considered",level:2},{value:"10. Testing &amp; Validation Plan",id:"10-testing--validation-plan",level:2},{value:"11. Risks &amp; Mitigations",id:"11-risks--mitigations",level:2},{value:"12. Rollout Plan",id:"12-rollout-plan",level:2},{value:"13. Resolved Decisions",id:"13-resolved-decisions",level:2},{value:"14. Follow-Up Work",id:"14-follow-up-work",level:2},{value:"15. References",id:"15-references",level:2},{value:"Appendix A - Glossary",id:"appendix-a---glossary",level:2},{value:"Appendix B - Change Log",id:"appendix-b---change-log",level:2}];function a(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,c.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.header,{children:(0,i.jsx)(s.h1,{id:"client-prediction-and-rollback-design-issue-546",children:"Client Prediction and Rollback Design (Issue 546)"})}),"\n",(0,i.jsx)(s.h2,{id:"document-control",children:"Document Control"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Title"}),": Add client-side prediction and rollback for Issue 546"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Authors"}),": Codex (AI, Senior Network Game Engineer)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Reviewers"}),": Runtime Core maintainers"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Status"}),": Draft"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Last Updated"}),": 2025-12-28"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Related Issues"}),": ",(0,i.jsx)(s.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/546",children:"https://github.com/hansjm10/Idle-Game-Engine/issues/546"}),", ",(0,i.jsx)(s.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/684",children:"https://github.com/hansjm10/Idle-Game-Engine/issues/684"})]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Execution Mode"}),": AI-led"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"1-summary",children:"1. Summary"}),"\n",(0,i.jsx)(s.p,{children:"Issue 546 introduces client-side prediction and rollback for networked play in the Idle Engine. This design adds a core PredictionManager that buffers local commands, records per-step checksums, applies authoritative server snapshots, and performs rollback plus deterministic replay when divergence is detected. The approach explicitly builds on the existing command queue and state-sync snapshot/restore APIs to keep simulation deterministic, minimize prediction latency, and bound memory usage while remaining transport-agnostic for Issue 546. Authority is explicitly server-side: client-supplied metadata is treated as advisory and validated or overridden by the transport layer."}),"\n",(0,i.jsx)(s.h2,{id:"2-context--problem-statement",children:"2. Context & Problem Statement"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Background"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["The runtime executes fixed-step ticks with deterministic command ordering and step stamping (",(0,i.jsx)(s.code,{children:"packages/core/src/index.ts:132"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/command-queue.ts:18"}),", ",(0,i.jsx)(s.code,{children:"docs/runtime-command-queue-design.md"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["State synchronization already provides unified snapshots, checksums, and restore utilities (",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/capture.ts:13"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/checksum.ts:1"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/restore.ts:188"}),", ",(0,i.jsx)(s.code,{children:"docs/state-synchronization-protocol-design.md"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["Command transport (Issue 545) introduces request IDs and acknowledgments but explicitly excludes client prediction (",(0,i.jsx)(s.code,{children:"packages/core/src/command-transport.ts:1"}),", ",(0,i.jsx)(s.code,{children:"docs/runtime-command-transport-design-issue-545.md"}),")."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Problem"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Issue 546 requires clients to advance simulation without blocking on server round-trips, but there is no core prediction buffer or rollback coordinator today."}),"\n",(0,i.jsxs)(s.li,{children:["Existing snapshot restore requires manual wiring of runtime systems and does not provide automatic rollback/replay orchestration (see manual restore in ",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/restore.test.ts:48"}),")."]}),"\n",(0,i.jsx)(s.li,{children:"Without Issue 546, network latency forces either blocked input or custom per-shell reconciliation logic that risks breaking determinism."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Forces"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Determinism is mandatory across replay, including RNG seed/state restoration (",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/restore.ts:227"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/command-recorder.ts:393"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["Performance budgets from state sync must be preserved: checksum under 100 microseconds, capture under 1ms, restore under 5ms (",(0,i.jsx)(s.code,{children:"docs/state-synchronization-protocol-design.md:833"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["Prediction should not violate runtime cadence; maintain 60Hz where configured and respect ",(0,i.jsx)(s.code,{children:"maxStepsPerFrame"})," (",(0,i.jsx)(s.code,{children:"packages/core/src/index.ts:110"}),", ",(0,i.jsx)(s.code,{children:"docs/runtime-event-pubsub-design.md:24"}),")."]}),"\n",(0,i.jsx)(s.li,{children:"Memory must stay bounded: avoid unbounded command buffering or full snapshot histories in Issue 546."}),"\n",(0,i.jsxs)(s.li,{children:["Compatibility must remain additive: no changes to save formats or command queue schemas (",(0,i.jsx)(s.code,{children:"packages/core/src/game-state-save.ts:319"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/command-queue.ts:40"}),")."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"3-goals--non-goals",children:"3. Goals & Non-Goals"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Goals"}),":","\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["Issue 546 adds a PredictionManager in ",(0,i.jsx)(s.code,{children:"packages/core"})," that records local commands with step metadata and tracks pending buffers."]}),"\n",(0,i.jsx)(s.li,{children:"Issue 546 applies server snapshots and confirmed steps using checksums, avoiding rollback when predicted state matches."}),"\n",(0,i.jsx)(s.li,{children:"Issue 546 performs rollback and deterministic replay of unconfirmed commands on divergence."}),"\n",(0,i.jsxs)(s.li,{children:["Issue 546 uses ",(0,i.jsx)(s.code,{children:"GameStateSnapshot"})," and ",(0,i.jsx)(s.code,{children:"computeStateChecksum"})," for authoritative comparison (",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/types.ts:7"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/checksum.ts:56"}),")."]}),"\n",(0,i.jsx)(s.li,{children:"Issue 546 enforces bounded prediction windows with explicit overflow handling."}),"\n",(0,i.jsxs)(s.li,{children:["Issue 546 provides telemetry hooks for rollback outcomes and checksum mismatches (",(0,i.jsx)(s.code,{children:"packages/core/src/telemetry.ts:3"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["Issue 546 includes deterministic unit and stress tests in ",(0,i.jsx)(s.code,{children:"packages/core"})," with ",(0,i.jsx)(s.code,{children:"pnpm test --filter @idle-engine/core"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Non-Goals"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Issue 546 does not implement transport protocols, authentication, or compression (Issue 545 scope)."}),"\n",(0,i.jsx)(s.li,{children:"Issue 546 does not ship UI smoothing, interpolation, or render-layer rewinds."}),"\n",(0,i.jsx)(s.li,{children:"Issue 546 does not introduce server-side continuous simulation or authoritative replay services."}),"\n",(0,i.jsx)(s.li,{children:"Issue 546 does not change command queue ordering, command schemas, or save formats."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"4-stakeholders-agents--impacted-surfaces",children:"4. Stakeholders, Agents & Impacted Surfaces"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Primary Stakeholders"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Runtime Core maintainers (Issue 546 implementation and API review)."}),"\n",(0,i.jsx)(s.li,{children:"Network/transport integrators (Issue 545 consumers relying on prediction state)."}),"\n",(0,i.jsx)(s.li,{children:"QA/Testing (determinism and rollback validation)."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Agent Roles"}),":"]}),"\n"]}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Agent"}),(0,i.jsx)(s.th,{children:"Responsibilities"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Runtime Prediction Agent"}),(0,i.jsxs)(s.td,{children:["Implement PredictionManager, buffers, and rollback logic for Issue 546 in ",(0,i.jsx)(s.code,{children:"packages/core"}),"."]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"State Sync Agent"}),(0,i.jsx)(s.td,{children:"Extend snapshot/restore integration and add runtime restore helpers for Issue 546."})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Testing Agent"}),(0,i.jsx)(s.td,{children:"Add deterministic and stress tests for Issue 546."})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Telemetry Agent"}),(0,i.jsx)(s.td,{children:"Add rollback/prediction instrumentation for Issue 546."})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Docs Agent"}),(0,i.jsx)(s.td,{children:"Update docs and usage guidance for Issue 546."})]})]})]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Affected Packages/Services"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"packages/core"})," (new prediction module, exports, tests)."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"docs/"})," (Issue 546 design and future API docs)."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Compatibility Considerations"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Issue 546 APIs are additive; no changes to ",(0,i.jsx)(s.code,{children:"SerializedCommandQueueV1"})," or game save schema."]}),"\n",(0,i.jsxs)(s.li,{children:["Prediction must respect command step stamping and replay determinism (",(0,i.jsx)(s.code,{children:"packages/core/src/index.ts:258"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/command.ts:18"}),")."]}),"\n",(0,i.jsx)(s.li,{children:"Type-only imports and exports remain mandatory under lint rules."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"5-current-state",children:"5. Current State"}),"\n",(0,i.jsx)(s.p,{children:"Issue 546 builds on existing deterministic infrastructure but lacks a prediction coordinator:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Deterministic runtime"}),": ",(0,i.jsx)(s.code,{children:"IdleEngineRuntime"})," executes fixed-step ticks with command queue integration and step stamping (",(0,i.jsx)(s.code,{children:"packages/core/src/index.ts:132"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Command queue"}),": Priority lanes with deterministic ordering and JSON-safe serialization (",(0,i.jsx)(s.code,{children:"packages/core/src/command-queue.ts:18"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"State sync"}),": Unified snapshots, checksums, compare, and restore functions (",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/capture.ts:13"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/checksum.ts:56"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/compare.ts:965"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/restore.ts:188"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Runtime wiring"}),": ",(0,i.jsx)(s.code,{children:"createGameRuntime"})," and ",(0,i.jsx)(s.code,{children:"wireGameRuntime"})," assemble systems and provide save/hydrate helpers (",(0,i.jsx)(s.code,{children:"packages/core/src/index.ts:846"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/index.ts:904"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Transport layer"}),": requestId and ack semantics are in core but exclude prediction (",(0,i.jsx)(s.code,{children:"packages/core/src/command-transport.ts:1"}),", ",(0,i.jsx)(s.code,{children:"docs/runtime-command-transport-design-issue-545.md"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Gap for Issue 546"}),": there is no pending prediction buffer, rollback orchestration, or checksum-based reconciliation loop in core."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"6-proposed-solution",children:"6. Proposed Solution"}),"\n",(0,i.jsx)(s.h3,{id:"61-architecture-overview",children:"6.1 Architecture Overview"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Narrative"}),": Issue 546 adds a PredictionManager that sits above the deterministic runtime. The manager records local commands, captures per-step checksums, and reconciles with server snapshots. On checksum mismatch, it restores to the authoritative snapshot, re-enqueues pending commands, and replays ticks to catch up to the local step."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Diagram"}),":"]}),"\n"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-text",children:"Local Input -> recordLocalCommand -> CommandQueue -> Runtime Tick -> Prediction History\n                           |                                    |\n                           v                                    v\n                    Pending Buffer                       checksum per step\n                           |\nServer Snapshot + step ----+----\x3e compare checksums ----\x3e match?\n                                                   | yes\n                                                   v\n                                             drop pending <= confirmed\n                                                   |\n                                                   v\n                                               continue predict\n                                                   |\n                                                   | no\n                                                   v\n                                   restore snapshot -> replay pending -> update runtime\n"})}),"\n",(0,i.jsx)(s.h3,{id:"62-detailed-design",children:"6.2 Detailed Design"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"API Surface (Issue 546)"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["New module: ",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/prediction-manager.ts"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:["Export from ",(0,i.jsx)(s.code,{children:"packages/core/src/index.ts"})," alongside state-sync APIs."]}),"\n",(0,i.jsx)(s.li,{children:"Baseline interface aligned with Issue 546 and extended for integration:"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"export interface PredictionManager {\n  recordLocalCommand(command: Command, atStep?: number): void;\n  recordPredictedStep(step?: number): void;\n  applyServerState(\n    snapshot: GameStateSnapshot,\n    confirmedStep: number,\n  ): RollbackResult;\n  getPendingCommands(): readonly Command[];\n  getPredictionWindow(): PredictionWindow;\n}\n\nexport type RollbackResult = Readonly<{\n  readonly status: 'confirmed' | 'rolled-back' | 'resynced' | 'ignored';\n  readonly confirmedStep: number;\n  readonly localStep: number;\n  readonly replayedSteps: number;\n  readonly pendingCommands: number;\n  readonly checksumMatch?: boolean;\n  readonly reason?: 'checksum-match' | 'checksum-mismatch' | 'stale-snapshot' | 'prediction-window-exceeded';\n}>;\n"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.code,{children:"recordPredictedStep"})," is required for Issue 546 to record checksums at each simulated step. For networked clients, configure ",(0,i.jsx)(s.code,{children:"maxStepsPerFrame = 1"})," to ensure per-step recording (",(0,i.jsx)(s.code,{children:"packages/core/src/index.ts:110"}),")."]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Authority & Trust Boundaries (Issue 546)"}),":"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Server is authoritative for confirmed steps and snapshot content; clients never decide the canonical state."}),"\n",(0,i.jsxs)(s.li,{children:["Client-supplied ",(0,i.jsx)(s.code,{children:"step"}),", ",(0,i.jsx)(s.code,{children:"priority"}),", and ",(0,i.jsx)(s.code,{children:"timestamp"})," are treated as advisory. The transport layer MUST stamp authoritative ",(0,i.jsx)(s.code,{children:"serverStep"})," (",(0,i.jsx)(s.code,{children:"runtime.getNextExecutableStep()"}),"), normalize client commands to ",(0,i.jsx)(s.code,{children:"CommandPriority.PLAYER"}),", and apply server-side timestamps on receipt (",(0,i.jsx)(s.code,{children:"packages/core/src/command-transport-server.ts:145"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/command-queue.ts:18"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["Idempotency is enforced by ",(0,i.jsx)(s.code,{children:"{clientId, requestId}"})," keys; duplicate or replayed envelopes resolve to cached ",(0,i.jsx)(s.code,{children:"CommandResponse"})," (",(0,i.jsx)(s.code,{children:"packages/core/src/command-transport.ts:1"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/command-transport-server.ts:106"}),")."]}),"\n",(0,i.jsx)(s.li,{children:"Authentication/authorization is transport-layer scope (Issue 545); core prediction assumes envelopes have been validated and authorized before enqueue."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Prediction History (Issue 546)"}),":"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Store a ring buffer of ",(0,i.jsx)(s.code,{children:"{ step, checksum }"})," only; optionally store snapshots in debug mode for diffing."]}),"\n",(0,i.jsxs)(s.li,{children:["Default history window: 50 steps or 5 seconds at ",(0,i.jsx)(s.code,{children:"stepSizeMs = 100"})," (configurable)."]}),"\n",(0,i.jsxs)(s.li,{children:["Checksum uses ",(0,i.jsx)(s.code,{children:"computeStateChecksum"})," and excludes ",(0,i.jsx)(s.code,{children:"capturedAt"})," (",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/checksum.ts:56"}),")."]}),"\n",(0,i.jsx)(s.li,{children:"If the confirmed step is outside the stored history window, treat it as a prediction window overflow and resync from the authoritative snapshot."}),"\n",(0,i.jsxs)(s.li,{children:["If ",(0,i.jsx)(s.code,{children:"maxStepsPerFrame > 1"}),", record checksums every ",(0,i.jsx)(s.code,{children:"checksumIntervalSteps"})," (default 1) and accept coarser rollback granularity to keep capture overhead bounded."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Pending Command Buffer (Issue 546)"}),":"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Store ",(0,i.jsx)(s.code,{children:"Command"})," objects in step order with requestId and timestamp."]}),"\n",(0,i.jsxs)(s.li,{children:["Default maximum pending commands: 1000 (configurable, independent of ",(0,i.jsx)(s.code,{children:"DEFAULT_MAX_QUEUE_SIZE"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["On buffer overflow: return ",(0,i.jsx)(s.code,{children:"status = 'resynced'"})," and force authoritative restore."]}),"\n",(0,i.jsx)(s.li,{children:"Pending commands are client-originated only. Authoritative remote commands must arrive via snapshots or a server-authored command stream and are applied before replay."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Server State Application (Issue 546)"}),":"]}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["Ignore stale snapshots where ",(0,i.jsx)(s.code,{children:"confirmedStep < lastConfirmedStep"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:["If ",(0,i.jsx)(s.code,{children:"confirmedStep === lastConfirmedStep"}),", treat the snapshot as idempotent; only rollback if the checksum differs."]}),"\n",(0,i.jsxs)(s.li,{children:["If the local checksum history does not include ",(0,i.jsx)(s.code,{children:"confirmedStep"}),", resync immediately (treat as prediction window overflow)."]}),"\n",(0,i.jsxs)(s.li,{children:["Compute server checksum and compare to local checksum stored for ",(0,i.jsx)(s.code,{children:"confirmedStep"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:["If checksums match: drop pending commands at or before ",(0,i.jsx)(s.code,{children:"confirmedStep"})," and advance confirmed pointer."]}),"\n",(0,i.jsx)(s.li,{children:"If checksums differ: trigger rollback and replay."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Rollback and Replay (Issue 546)"}),":"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Restoration is built on state-sync snapshot restore and runtime wiring:","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["New helper ",(0,i.jsx)(s.code,{children:"restoreGameRuntimeFromSnapshot"})," in ",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/restore-runtime.ts"})," (proposed)."]}),"\n",(0,i.jsxs)(s.li,{children:["The helper composes ",(0,i.jsx)(s.code,{children:"restoreFromSnapshot"}),", ",(0,i.jsx)(s.code,{children:"createProgressionCoordinator"}),", ",(0,i.jsx)(s.code,{children:"wireGameRuntime"}),", and system restore hooks (",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/restore.ts:188"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/index.ts:904"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/automation-system.ts:267"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/transform-system.ts:1100"}),")."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["Replay flow:","\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsx)(s.li,{children:"Restore authoritative snapshot to a fresh runtime wiring."}),"\n",(0,i.jsxs)(s.li,{children:["Restore the authoritative command queue from the snapshot (included in ",(0,i.jsx)(s.code,{children:"GameStateSnapshot.commandQueue"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["Re-enqueue pending client commands with original step values where ",(0,i.jsx)(s.code,{children:"step > confirmedStep"}),".","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Commands at or before ",(0,i.jsx)(s.code,{children:"confirmedStep"})," are dropped as confirmed."]}),"\n",(0,i.jsxs)(s.li,{children:["Queue ordering remains deterministic via priority + timestamp + sequence (",(0,i.jsx)(s.code,{children:"packages/core/src/command-queue.ts:18"}),")."]}),"\n",(0,i.jsx)(s.li,{children:"If the server provides a separate authoritative command stream, apply it before pending replay; otherwise disable prediction when snapshots are partial."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["Tick forward from ",(0,i.jsx)(s.code,{children:"confirmedStep"})," to the prior local step using fixed-step ticks."]}),"\n",(0,i.jsx)(s.li,{children:"Replace the active runtime wiring and emit a rollback telemetry event."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Runtime Restore Helper (Issue 546)"}),":"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Proposed signature:"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"export function restoreGameRuntimeFromSnapshot(options: {\n  readonly content: NormalizedContentPack;\n  readonly snapshot: GameStateSnapshot;\n  readonly enableProduction?: boolean;\n  readonly enableAutomation?: boolean;\n  readonly enableTransforms?: boolean;\n}): GameRuntimeWiring;\n"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"Implementation references:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Build resource definitions from ",(0,i.jsx)(s.code,{children:"content.resources"})," (see mapping in ",(0,i.jsx)(s.code,{children:"packages/core/src/progression-coordinator.ts:359"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["Use ",(0,i.jsx)(s.code,{children:"restoreFromSnapshot"})," for runtime + resources (",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/restore.ts:188"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["Hydrate coordinator and restore automation/transform states with step rebasing (",(0,i.jsx)(s.code,{children:"packages/core/src/progression-coordinator-save.ts:331"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/automation-system.ts:267"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/transform-system.ts:1100"}),")."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Event and Telemetry Behavior (Issue 546)"}),":"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Emit telemetry events: ",(0,i.jsx)(s.code,{children:"PredictionChecksumMismatch"}),", ",(0,i.jsx)(s.code,{children:"PredictionRollback"}),", ",(0,i.jsx)(s.code,{children:"PredictionResync"}),", ",(0,i.jsx)(s.code,{children:"PredictionBufferOverflow"})," via ",(0,i.jsx)(s.code,{children:"telemetry"})," (",(0,i.jsx)(s.code,{children:"packages/core/src/telemetry.ts:3"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["External observers should treat events emitted during replay as non-authoritative unless explicitly opted in; default to suppress external side effects during replay by wiring a no-op ",(0,i.jsx)(s.code,{children:"EventPublisher"})," (mirrors replay safety in ",(0,i.jsx)(s.code,{children:"CommandRecorder"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/command-recorder.ts:79"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["Telemetry payloads SHOULD include ",(0,i.jsx)(s.code,{children:"confirmedStep"}),", ",(0,i.jsx)(s.code,{children:"localStep"}),", ",(0,i.jsx)(s.code,{children:"pendingCommands"}),", ",(0,i.jsx)(s.code,{children:"replayedSteps"}),", ",(0,i.jsx)(s.code,{children:"snapshotVersion"}),", ",(0,i.jsx)(s.code,{children:"runtimeVersion"})," (transport-level), ",(0,i.jsx)(s.code,{children:"definitionDigest"})," (from resources), ",(0,i.jsx)(s.code,{children:"queueSize"}),", and ",(0,i.jsx)(s.code,{children:"replayDurationMs"})," for live debugging."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Configuration Defaults (Issue 546)"}),":"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"maxPredictionSteps"}),": 50"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"maxPendingCommands"}),": 1000"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"checksumIntervalSteps"}),": 1"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"snapshotHistorySteps"}),": 0 (checksums only, enable snapshots for debug)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"maxReplayStepsPerTick"}),": align with ",(0,i.jsx)(s.code,{children:"maxStepsPerFrame"})]}),"\n",(0,i.jsxs)(s.li,{children:["Recommended server snapshot cadence: ~10 steps at ",(0,i.jsx)(s.code,{children:"stepSizeMs = 100"})," (about 1s), and no more than half the prediction window to avoid history eviction."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"63-operational-considerations",children:"6.3 Operational Considerations"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Deployment"}),": Issue 546 is core-only and additive; no build or infrastructure changes."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Telemetry & Observability"}),": new prediction telemetry events plus existing diagnostics timelines for tick performance (",(0,i.jsx)(s.code,{children:"packages/core/src/diagnostics/runtime-diagnostics-controller.ts:699"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Security & Compliance"}),": snapshots contain gameplay state, not PII; checksums are non-cryptographic and should not be used for authentication."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Versioning & Compatibility"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Require ",(0,i.jsx)(s.code,{children:"snapshot.version === 1"})," and reject/force resync on mismatch (",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/types.ts:1"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["Validate resource definition digest on restore; mismatch triggers resync or session rejection (",(0,i.jsx)(s.code,{children:"packages/core/src/resource-state.ts:1368"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["Transport should include ",(0,i.jsx)(s.code,{children:"runtimeVersion"})," and ",(0,i.jsx)(s.code,{children:"contentDigest"})," in the snapshot envelope for mixed-client compatibility; prediction should disable on incompatible versions (",(0,i.jsx)(s.code,{children:"packages/core/src/version.ts:1"}),")."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"7-work-breakdown--delivery-plan",children:"7. Work Breakdown & Delivery Plan"}),"\n",(0,i.jsx)(s.h3,{id:"71-issue-map",children:"7.1 Issue Map"}),"\n",(0,i.jsx)(s.p,{children:"Populate the table as the canonical source for downstream GitHub issues tied to Issue 546."}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Issue Title"}),(0,i.jsx)(s.th,{children:"Scope Summary"}),(0,i.jsx)(s.th,{children:"Proposed Assignee/Agent"}),(0,i.jsx)(s.th,{children:"Dependencies"}),(0,i.jsx)(s.th,{children:"Acceptance Criteria"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"feat(core): add PredictionManager interfaces for Issue 546"}),(0,i.jsx)(s.td,{children:"Define prediction types, buffers, and exports"}),(0,i.jsx)(s.td,{children:"Runtime Prediction Agent"}),(0,i.jsx)(s.td,{children:"Design approval"}),(0,i.jsx)(s.td,{children:"Types exported; lint clean; Issue 546 API available"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"feat(core): implement prediction history and buffer for Issue 546"}),(0,i.jsx)(s.td,{children:"Checksum history + pending command buffer"}),(0,i.jsx)(s.td,{children:"Runtime Prediction Agent"}),(0,i.jsx)(s.td,{children:"Prediction interfaces"}),(0,i.jsx)(s.td,{children:"Checksums recorded per step; buffers bounded"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"feat(core): add restoreGameRuntimeFromSnapshot helper for Issue 546"}),(0,i.jsx)(s.td,{children:"Restore wiring from snapshot + content"}),(0,i.jsx)(s.td,{children:"State Sync Agent"}),(0,i.jsx)(s.td,{children:"State-sync APIs"}),(0,i.jsx)(s.td,{children:"Helper returns wiring with restored systems"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"feat(core): implement rollback and replay pipeline for Issue 546"}),(0,i.jsx)(s.td,{children:"Apply server snapshots, rollback, replay"}),(0,i.jsx)(s.td,{children:"Runtime Prediction Agent"}),(0,i.jsx)(s.td,{children:"History + restore helper"}),(0,i.jsx)(s.td,{children:"Rollback replays pending commands; telemetry emitted"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"test(core): add prediction rollback tests for Issue 546"}),(0,i.jsx)(s.td,{children:"Unit + stress tests"}),(0,i.jsx)(s.td,{children:"Testing Agent"}),(0,i.jsx)(s.td,{children:"Core implementation"}),(0,i.jsxs)(s.td,{children:["Tests pass; ",(0,i.jsx)(s.code,{children:"pnpm test --filter @idle-engine/core"})]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"docs(core): document prediction usage for Issue 546"}),(0,i.jsx)(s.td,{children:"Usage notes + API reference"}),(0,i.jsx)(s.td,{children:"Docs Agent"}),(0,i.jsx)(s.td,{children:"Implementation"}),(0,i.jsx)(s.td,{children:"Docs merged; references updated"})]})]})]}),"\n",(0,i.jsx)(s.h3,{id:"72-milestones",children:"7.2 Milestones"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Phase 1 (Issue 546)"}),": Prediction interfaces, history buffer, and exports in core."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Phase 2 (Issue 546)"}),": Runtime restore helper and rollback/replay pipeline."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Phase 3 (Issue 546)"}),": Tests, telemetry, and documentation updates."]}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"73-coordination-notes",children:"7.3 Coordination Notes"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Hand-off Package"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"packages/core/src/index.ts:804"})," (runtime wiring)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/*"})," (snapshot, checksum, restore)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"packages/core/src/command-queue.ts"})," (command ordering)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"packages/core/src/command-transport.ts"})," (requestId semantics)"]}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.code,{children:"docs/state-synchronization-protocol-design.md"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Communication Cadence"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Issue 546 status updates per PR, with a rollback test checkpoint before merge."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"8-agent-guidance--guardrails",children:"8. Agent Guidance & Guardrails"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Context Packets"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"packages/core/src/index.ts"})," (runtime wiring and step semantics)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/capture.ts"})," and ",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/restore.ts"})]}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.code,{children:"packages/core/src/command-queue.ts"})}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"packages/core/src/automation-system.ts"})," and ",(0,i.jsx)(s.code,{children:"packages/core/src/transform-system.ts"})]}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.code,{children:"docs/state-synchronization-protocol-design.md"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.code,{children:"docs/runtime-command-transport-design-issue-545.md"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Prompting & Constraints"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:['"You are the Runtime Prediction Agent for Issue 546. Implement PredictionManager in ',(0,i.jsx)(s.code,{children:"packages/core"}),", use type-only imports, preserve deterministic replay, and export new APIs from ",(0,i.jsx)(s.code,{children:"packages/core/src/index.ts"}),'."']}),"\n",(0,i.jsxs)(s.li,{children:['"Use ',(0,i.jsx)(s.code,{children:"captureGameStateSnapshot"})," and ",(0,i.jsx)(s.code,{children:"computeStateChecksum"}),' for reconciliation; do not introduce non-deterministic hashing."']}),"\n",(0,i.jsxs)(s.li,{children:['"Maintain command step stamping with ',(0,i.jsx)(s.code,{children:"runtime.getNextExecutableStep()"}),'."']}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Safety Rails"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Do not modify ",(0,i.jsx)(s.code,{children:"dist/"})," outputs or save format schemas."]}),"\n",(0,i.jsxs)(s.li,{children:["Do not introduce network dependencies in ",(0,i.jsx)(s.code,{children:"packages/core"}),"."]}),"\n",(0,i.jsx)(s.li,{children:"Do not emit console output from tests that could corrupt Vitest JSON reporting."}),"\n",(0,i.jsxs)(s.li,{children:["Do not use ",(0,i.jsx)(s.code,{children:"Date.now()"})," in checksums or determinism-critical paths."]}),"\n",(0,i.jsx)(s.li,{children:"Do not reset git history or force push."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Validation Hooks"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.code,{children:"pnpm lint"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.code,{children:"pnpm typecheck"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.code,{children:"pnpm test --filter @idle-engine/core"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"9-alternatives-considered",children:"9. Alternatives Considered"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Always resync without prediction"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Pros: Simplest implementation."}),"\n",(0,i.jsx)(s.li,{children:"Cons: Violates Issue 546 latency requirements and blocks local input."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Use CommandRecorder for prediction replay"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Pros: Reuses replay machinery (",(0,i.jsx)(s.code,{children:"packages/core/src/command-recorder.ts:393"}),")."]}),"\n",(0,i.jsx)(s.li,{children:"Cons: Recorder is optimized for offline replay logs, not rolling prediction windows."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Store full snapshots per step"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Pros: Simplifies debug diffing."}),"\n",(0,i.jsx)(s.li,{children:"Cons: High memory cost; not aligned with Issue 546 bounded memory goals."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"10-testing--validation-plan",children:"10. Testing & Validation Plan"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Unit / Integration (Issue 546)"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Predict-then-confirm: checksum match drops pending buffer with no rollback."}),"\n",(0,i.jsx)(s.li,{children:"Predict-then-mismatch: rollback restores snapshot and replays commands deterministically."}),"\n",(0,i.jsx)(s.li,{children:"Pending buffer overflow triggers resync fallback."}),"\n",(0,i.jsxs)(s.li,{children:["RequestId preservation across rollback and replay (",(0,i.jsx)(s.code,{children:"packages/core/src/command.ts:18"}),")."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Performance"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Validate checksum and restore budgets from state-sync design remain within limits."}),"\n",(0,i.jsx)(s.li,{children:"Record replay duration per rollback and ensure it stays below one frame at configured cadence."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Tooling / A11y"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Not applicable for Issue 546 (runtime-only feature)."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"11-risks--mitigations",children:"11. Risks & Mitigations"}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Risk"}),(0,i.jsx)(s.th,{children:"Impact"}),(0,i.jsx)(s.th,{children:"Likelihood"}),(0,i.jsx)(s.th,{children:"Mitigation"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Replay determinism drift"}),(0,i.jsx)(s.td,{children:"High"}),(0,i.jsx)(s.td,{children:"Medium"}),(0,i.jsxs)(s.td,{children:["Use state-sync snapshots + RNG restore; add property tests (",(0,i.jsx)(s.code,{children:"packages/core/src/__tests__/state-sync.property.test.ts:31"}),")."]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Prediction window overflow"}),(0,i.jsx)(s.td,{children:"Medium"}),(0,i.jsx)(s.td,{children:"Medium"}),(0,i.jsx)(s.td,{children:"Bound pending commands and enforce resync fallback."})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Snapshot step mismatch"}),(0,i.jsx)(s.td,{children:"Medium"}),(0,i.jsx)(s.td,{children:"Low"}),(0,i.jsx)(s.td,{children:"Reject stale snapshots; emit telemetry for diagnostics."})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Event side effects during replay"}),(0,i.jsx)(s.td,{children:"Medium"}),(0,i.jsx)(s.td,{children:"Medium"}),(0,i.jsxs)(s.td,{children:["Use a no-op ",(0,i.jsx)(s.code,{children:"EventPublisher"})," during replay by default; require explicit opt-in for side effects."]})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Performance regression"}),(0,i.jsx)(s.td,{children:"Medium"}),(0,i.jsx)(s.td,{children:"Low"}),(0,i.jsx)(s.td,{children:"Track replay time via telemetry; keep checksum history lightweight."})]})]})]}),"\n",(0,i.jsx)(s.h2,{id:"12-rollout-plan",children:"12. Rollout Plan"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Milestones (Issue 546)"}),":","\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsx)(s.li,{children:"Ship PredictionManager API and internal buffers (core-only)."}),"\n",(0,i.jsx)(s.li,{children:"Add rollback/replay integration with runtime restore helper."}),"\n",(0,i.jsx)(s.li,{children:"Add tests, telemetry, and documentation updates."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Migration Strategy"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Additive API; existing single-player flows remain unchanged."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Communication"}),":","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Announce new prediction APIs in release notes and link Issue 546 design doc."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"13-resolved-decisions",children:"13. Resolved Decisions"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Rollback rebuilds runtime wiring using snapshot restore helpers; there is no step-reset API on ",(0,i.jsx)(s.code,{children:"IdleEngineRuntime"})," (",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/restore.ts:188"}),", ",(0,i.jsx)(s.code,{children:"packages/core/src/index.ts:904"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["Server snapshots are expected to include command queue state (",(0,i.jsx)(s.code,{children:"GameStateSnapshot.commandQueue"}),") for authoritative reconciliation; if partial snapshots are used, prediction is disabled until a full resync is applied (",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/types.ts:7"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["External event observers are suppressed during replay by default; replay uses a no-op event publisher unless explicitly configured (",(0,i.jsx)(s.code,{children:"packages/core/src/command-recorder.ts:79"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["Recommended snapshot cadence is ~1s (10 steps at ",(0,i.jsx)(s.code,{children:"DEFAULT_STEP_MS = 100"}),"), capped at half the prediction window to avoid history eviction (",(0,i.jsx)(s.code,{children:"packages/core/src/index.ts:110"}),")."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"14-follow-up-work",children:"14. Follow-Up Work"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Integrate Issue 546 with transport-level acknowledgments and pending tracking (Issue 545)."}),"\n",(0,i.jsx)(s.li,{children:"Add optional debug mode to store local snapshots for diffing on mismatch."}),"\n",(0,i.jsxs)(s.li,{children:["Extend prediction to support partial snapshot validation via ",(0,i.jsx)(s.code,{children:"computePartialChecksum"})," (",(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/checksum.ts:79"}),")."]}),"\n",(0,i.jsx)(s.li,{children:"Provide a replay-safe UI notification pipeline to avoid double firing on rollback."}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"15-references",children:"15. References"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"packages/core/src/index.ts:132"})," - ",(0,i.jsx)(s.code,{children:"IdleEngineRuntime"})," tick loop and step stamping"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"packages/core/src/command-queue.ts:18"})," - Command queue ordering and serialization"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/capture.ts:13"})," - Snapshot capture API"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/checksum.ts:56"})," - Checksum computation"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/compare.ts:965"})," - State diffing"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"packages/core/src/state-sync/restore.ts:188"})," - Snapshot restore"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"packages/core/src/automation-system.ts:267"})," - Automation state restore with step rebase"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"packages/core/src/transform-system.ts:1100"})," - Transform state restore with step rebase"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"packages/core/src/command-transport.ts:1"})," - RequestId and command envelopes"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"docs/state-synchronization-protocol-design.md"})," - State sync foundation"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"docs/runtime-command-transport-design-issue-545.md"})," - Transport layer scope separation"]}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/546",children:"https://github.com/hansjm10/Idle-Game-Engine/issues/546"})}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"appendix-a---glossary",children:"Appendix A - Glossary"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Prediction buffer"}),": The ordered list of local commands not yet confirmed by the server in Issue 546."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Rollback"}),": Restoring to the last authoritative snapshot and replaying pending commands for Issue 546."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Confirmed step"}),": The server-authoritative step number that the client uses to prune prediction history in Issue 546."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Prediction window"}),": The maximum number of steps or commands stored for Issue 546 reconciliation."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Replay"}),": Deterministic re-execution of pending commands after rollback."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"appendix-b---change-log",children:"Appendix B - Change Log"}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Date"}),(0,i.jsx)(s.th,{children:"Author"}),(0,i.jsx)(s.th,{children:"Change Summary"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"2025-12-28"}),(0,i.jsx)(s.td,{children:"Codex"}),(0,i.jsx)(s.td,{children:"Resolve review feedback on authority, reconciliation, replay safety, and compatibility"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"2025-12-28"}),(0,i.jsx)(s.td,{children:"Codex"}),(0,i.jsx)(s.td,{children:"Initial Issue 546 design draft"})]})]})]})]})}function h(e={}){const{wrapper:s}={...(0,c.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},7678:(e,s,n)=>{n.d(s,{R:()=>t,x:()=>d});var r=n(9430);const i={},c=r.createContext(i);function t(e){const s=r.useContext(c);return r.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function d(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),r.createElement(c.Provider,{value:s},e.children)}}}]);