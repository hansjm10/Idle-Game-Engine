"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[5563],{4589:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"runtime-event-pubsub-design","title":"Runtime Event Pub/Sub Design","description":"Issue: #8","source":"@site/../../docs/runtime-event-pubsub-design.md","sourceDirName":".","slug":"/runtime-event-pubsub-design","permalink":"/Idle-Game-Engine/runtime-event-pubsub-design","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/runtime-event-pubsub-design.md","tags":[],"version":"current","frontMatter":{},"sidebar":"developerSidebar","previous":{"title":"Runtime Command Queue Validation Tracker","permalink":"/Idle-Game-Engine/runtime-command-queue-validation-plan"},"next":{"title":"Decision Record: Runtime Event Bus Follow-ups","permalink":"/Idle-Game-Engine/runtime-event-bus-decisions"}}');var i=s(5270),r=s(7678);const o={},l="Runtime Event Pub/Sub Design",a={},c=[{value:"1. Overview",id:"1-overview",level:2},{value:"2. Goals",id:"2-goals",level:2},{value:"3. Non-Goals",id:"3-non-goals",level:2},{value:"4. Current State",id:"4-current-state",level:2},{value:"5. Requirements",id:"5-requirements",level:2},{value:"5.1 Functional Requirements",id:"51-functional-requirements",level:3},{value:"5.2 Non-Functional Requirements",id:"52-non-functional-requirements",level:3},{value:"6. Proposed Solution",id:"6-proposed-solution",level:2},{value:"6.1 Event Taxonomy &amp; Schema",id:"61-event-taxonomy--schema",level:3},{value:"6.2 Event Bus Core",id:"62-event-bus-core",level:3},{value:"6.3 Tick Lifecycle Integration",id:"63-tick-lifecycle-integration",level:3},{value:"6.4 Buffer Management &amp; Back-Pressure",id:"64-buffer-management--back-pressure",level:3},{value:"6.5 Subscription API Ergonomics",id:"65-subscription-api-ergonomics",level:3},{value:"6.6 External Publishing &amp; Replay",id:"66-external-publishing--replay",level:3},{value:"7. Integration &amp; Sequencing",id:"7-integration--sequencing",level:2},{value:"8. Testing Strategy",id:"8-testing-strategy",level:2},{value:"9. Observability",id:"9-observability",level:2},{value:"10. Resolved Follow-Ups",id:"10-resolved-follow-ups",level:2},{value:"11. Risks &amp; Mitigations",id:"11-risks--mitigations",level:2},{value:"12. Rollout Plan",id:"12-rollout-plan",level:2}];function d(e){const n={blockquote:"blockquote",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"runtime-event-pubsub-design",children:"Runtime Event Pub/Sub Design"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Issue:"})," #8",(0,i.jsx)(n.br,{}),"\n",(0,i.jsx)(n.strong,{children:"Workstream:"})," Runtime Core",(0,i.jsx)(n.br,{}),"\n",(0,i.jsx)(n.strong,{children:"Status:"})," Draft",(0,i.jsx)(n.br,{}),"\n",(0,i.jsx)(n.strong,{children:"Last Updated:"})," 2025-10-14"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["This document specifies the event publication and subscription system that\npowers cross-system signalling inside the Idle Engine runtime. It pairs with\nthe command queue design (",(0,i.jsx)(n.code,{children:"docs/runtime-command-queue-design.md"}),") and aligns\nwith the implementation sequencing captured in ",(0,i.jsx)(n.code,{children:"docs/implementation-plan.md"}),"\nPhase 1."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"1-overview",children:"1. Overview"}),"\n",(0,i.jsxs)(n.p,{children:["Issue #8 calls for a deterministic in-process event bus so systems, command\nhandlers, and integrations can react to runtime activity without tight coupling\nor shared mutable state. The engine currently relies on direct callbacks and\nresource polling; the new event layer supplies an explicit contract for domain\nevents (threshold triggers, automation toggles, social notifications, etc.)\nwhile preserving the single-threaded simulation model described in\n",(0,i.jsx)(n.code,{children:"docs/idle-engine-design.md"})," \xa76.2."]}),"\n",(0,i.jsx)(n.p,{children:"The pub/sub system emits immutable event payloads tagged with tick metadata and\nroutes them to two audiences:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Internal systems"})," running inside the simulation worker."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"External observers"})," (presentation shell, telemetry, persistence replay)\nthat consume batched event frames via existing transport buffers."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"2-goals",children:"2. Goals"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Deterministic ordering:"})," Events flow through a single queue processed in a\nrepeatable sequence per tick so offline catch-up and replays remain stable."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Type-safe contracts:"})," Event payloads use shared discriminated unions to\nprevent runtime casting, mirroring the command payload strategy."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Bounded allocations:"})," Event storage relies on recyclable buffers to avoid\nper-tick garbage that would erode performance over long sessions."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Scoped subscriptions:"})," Systems register interest during initialization and\nreceive only the event categories they declare to keep dispatch efficient."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Snapshot-ready batches:"})," The bus emits compact frames the existing\ntransport layer can forward to the presentation shell without bespoke wiring."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"3-non-goals",children:"3. Non-Goals"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Building cross-process or network delivery (handled later by social services\nand backend integrations)."}),"\n",(0,i.jsx)(n.li,{children:"Persisting a long-lived analytics stream; the bus retains only the current\ntick plus the in-flight snapshot batch."}),"\n",(0,i.jsx)(n.li,{children:"Supporting asynchronous listeners; all handlers execute within the simulation\ntick and may not yield control or schedule promises."}),"\n",(0,i.jsx)(n.li,{children:"Publishing UI layout events or rendering hints (handled by the shell based on\nstate snapshots)."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"4-current-state",children:"4. Current State"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"packages/core"})," exposes a command queue, dispatcher, and recorder but lacks a\ngeneral event aggregation mechanism. Systems communicate via direct function\ncalls and shared resource state (",(0,i.jsx)(n.code,{children:"resource-state.ts"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"resource-publish-transport.ts"})," mirrors resource deltas to the presentation\nshell yet cannot emit domain-specific events (e.g., achievement unlocked)."]}),"\n",(0,i.jsxs)(n.li,{children:["Telemetry utilities (",(0,i.jsx)(n.code,{children:"telemetry.ts"}),") provide logging hooks but cannot\nsubscribe to structured runtime events."]}),"\n",(0,i.jsx)(n.li,{children:"No test scaffolding exists to assert deterministic delivery order or to\nvalidate that subscriptions remain isolated between saves."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"5-requirements",children:"5. Requirements"}),"\n",(0,i.jsx)(n.h3,{id:"51-functional-requirements",children:"5.1 Functional Requirements"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Register event categories and payload schemas at engine bootstrap with\ncompile-time typing (leveraging TypeScript discriminated unions)."}),"\n",(0,i.jsxs)(n.li,{children:["Allow command handlers, systems, and scripts to publish events during the\nactive tick via a lightweight ",(0,i.jsx)(n.code,{children:"EventPublisher"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Deliver published events to subscribing systems during the same tick, after\ncommand execution but before snapshot emission, so state mutations precede\nreactions."}),"\n",(0,i.jsxs)(n.li,{children:["Accumulate events into a ",(0,i.jsx)(n.code,{children:"RuntimeEventFrame"})," structure exported alongside\nresource deltas for the presentation shell."]}),"\n",(0,i.jsx)(n.li,{children:"Reset the event buffers between ticks (or when the simulation is paused) to\nprevent stale payload leakage across frames."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"52-non-functional-requirements",children:"5.2 Non-Functional Requirements"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Zero observable impact on tick cadence at 60 Hz under typical load (\u2264200\nevents per tick)."}),"\n",(0,i.jsx)(n.li,{children:"No reliance on dynamic reflection; event routing must remain pure TypeScript\nfor compatibility with worker contexts."}),"\n",(0,i.jsx)(n.li,{children:"Provide explicit back-pressure diagnostics when publisher volume exceeds the\nconfigured buffer limits."}),"\n",(0,i.jsx)(n.li,{children:"Ensure the bus is replayable: given the same command stream, the emitted\nevent batches must be identical."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"6-proposed-solution",children:"6. Proposed Solution"}),"\n",(0,i.jsx)(n.h3,{id:"61-event-taxonomy--schema",children:"6.1 Event Taxonomy & Schema"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Define ",(0,i.jsx)(n.code,{children:"RuntimeEvent<TType extends string, TPayload>"})," in\n",(0,i.jsx)(n.code,{children:"packages/core/src/events/runtime-event.ts"}),". Each event is a readonly object:","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"interface RuntimeEvent<TType extends RuntimeEventType, TPayload> {\n  readonly type: TType;\n  readonly tick: number;\n  readonly issuedAt: number; // monotonic ms within session\n  readonly payload: Readonly<TPayload>;\n}\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"RuntimeEventType"})," is a string literal union grouped by domains (",(0,i.jsx)(n.code,{children:"resource"}),",\n",(0,i.jsx)(n.code,{children:"automation"}),", ",(0,i.jsx)(n.code,{children:"social"}),", ",(0,i.jsx)(n.code,{children:"telemetry"}),"). Runtime-owned types live in\n",(0,i.jsx)(n.code,{children:"packages/core"}),", while content packs contribute additional entries through an\noffline manifest. Pack manifests emit ",(0,i.jsx)(n.code,{children:"eventTypes"})," metadata that is sorted by\n",(0,i.jsx)(n.code,{children:"(packSlug, eventKey)"})," during generation so every build produces the same\ndeclaration file and replay manifests stay stable."]}),"\n",(0,i.jsxs)(n.li,{children:["Export canonical payload types under ",(0,i.jsx)(n.code,{children:"@idle-engine/core/events"})," (e.g.,\n",(0,i.jsx)(n.code,{children:"ResourceThresholdReachedEvent"}),", ",(0,i.jsx)(n.code,{children:"AutomationToggleEvent"}),") so command handlers\nand systems share definitions."]}),"\n",(0,i.jsxs)(n.li,{children:["Per-pack manifests authored in ",(0,i.jsx)(n.code,{children:"content/event-types.json"})," files describe\nadditional event types. Running ",(0,i.jsx)(n.code,{children:"pnpm generate"})," merges the manifests with the\ncore catalogue, refreshes the deterministic manifest hash, and updates the\n",(0,i.jsx)(n.code,{children:"ContentRuntimeEventType"})," union exported by ",(0,i.jsx)(n.code,{children:"@idle-engine/core"}),". See\n",(0,i.jsx)(n.code,{children:"docs/runtime-event-manifest-authoring.md"})," for authoring guidance."]}),"\n",(0,i.jsx)(n.li,{children:"The generator also publishes a manifest hash consumed by the recorder; replay\nfiles embed the hash and fail fast if the runtime attempts to load a different\ncatalogue, preventing content drift across environments."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"62-event-bus-core",children:"6.2 Event Bus Core"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Introduce ",(0,i.jsx)(n.code,{children:"EventBus"})," in ",(0,i.jsx)(n.code,{children:"packages/core/src/events/event-bus.ts"})," encapsulating\nthree concepts:","\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"EventRegistry"}),": maps event type \u2192 payload validator/encoder and assigns\neach type a numeric channel index for fast lookups."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"EventBuffer"}),": ring buffer storing ",(0,i.jsx)(n.code,{children:"RuntimeEvent"})," instances for the current\ntick. Two buffers exist per channel: one for internal subscribers, one for\noutbound snapshot frames. Buffers reuse preallocated slots (",(0,i.jsx)(n.code,{children:"ObjectPool"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"SubscriberTable"}),": fixed-length array of subscription callbacks keyed by\nchannel index."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["The bus exposes:","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"interface EventPublisher {\n  publish<TType extends RuntimeEventType>(\n    eventType: TType,\n    payload: RuntimeEventPayload<TType>,\n  ): void;\n}\n\ntype EventHandler<TType extends RuntimeEventType> = (\n  event: RuntimeEvent<TType>,\n  context: EventDispatchContext,\n) => void;\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"EventDispatchContext"})," carries references to immutable runtime state snapshots\nneeded for read-only inspection while forbidding mutation outside commands."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"63-tick-lifecycle-integration",children:"6.3 Tick Lifecycle Integration"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Tick Start:"})," Scheduler resets all event buffers, bumping the logical tick\ncounter. Systems may register or deregister subscriptions only at this\nboundary (avoids mid-tick mutations to the subscriber table)."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Command Execution:"})," Command queue drains and mutates state as designed in\nissue #6. Command handlers can call ",(0,i.jsx)(n.code,{children:"publish"})," to emit domain events."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"System Update Phase:"})," After all commands, systems execute in their\ndeterministic order (\xa79 of the engine design). Systems can publish additional\nevents and receive events emitted earlier in the same tick."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Event Dispatch:"})," For each channel, the bus iterates events in FIFO order\nand invokes subscriber handlers synchronously. The dispatcher guards against\nre-entrant publication causing infinite loops by allowing nested publishes\nbut enqueuing them to the tail of the current tick buffer."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Snapshot Emission:"})," Once internal subscribers finish, the bus compacts the\noutbound buffers into a ",(0,i.jsx)(n.code,{children:"RuntimeEventFrame"})," (typed arrays + string table)\nhanded to ",(0,i.jsx)(n.code,{children:"resource-publish-transport"})," so the presentation shell receives\nboth state deltas and events in the same transferable payload."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Tick End:"})," Telemetry records buffer metrics (events per channel, dropped\nevents) and clears transient data."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"64-buffer-management--back-pressure",children:"6.4 Buffer Management & Back-Pressure"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Default buffer capacity per channel is 256 events. ",(0,i.jsx)(n.code,{children:"EventChannelConfiguration"}),"\nexposes an optional ",(0,i.jsx)(n.code,{children:"diagnostics"})," block and ",(0,i.jsx)(n.code,{children:"channelConfigs"})," allows\nper-channel overrides so integrators can tune ",(0,i.jsx)(n.code,{children:"maxEventsPerTick"}),",\n",(0,i.jsx)(n.code,{children:"maxEventsPerSecond"}),", ",(0,i.jsx)(n.code,{children:"cooldownTicks"}),", and ",(0,i.jsx)(n.code,{children:"maxCooldownTicks"})," without\nrewriting the bus. ",(0,i.jsx)(n.code,{children:"maxEventsPerTick"})," defaults to the resolved soft limit and\n",(0,i.jsx)(n.code,{children:"maxEventsPerSecond"})," falls back to four times that threshold to flag bursts."]}),"\n",(0,i.jsxs)(n.li,{children:["Publishing beyond the configured soft limit triggers the ",(0,i.jsx)(n.code,{children:"EventDiagnostics"}),"\nrate limiter. The first breach issues an ",(0,i.jsx)(n.code,{children:"EventSoftLimitBreach"})," warning with\nremaining capacity and increments ",(0,i.jsx)(n.code,{children:"events.soft_limited"})," alongside the\nper-channel ",(0,i.jsx)(n.code,{children:"events.soft_limit_breaches"})," telemetry counter. Subsequent\nbreaches back off exponentially before logging again, keeping telemetry\nactionable while publishers adapt."]}),"\n",(0,i.jsxs)(n.li,{children:["Overflowing the hard capacity still throws ",(0,i.jsx)(n.code,{children:"EventBufferOverflowError"})," and\nrecords ",(0,i.jsx)(n.code,{children:"events.overflowed"}),", causing the tick to rewind at ",(0,i.jsx)(n.code,{children:"beginTick()"}),". Hard\nlimits remain deterministic safeguards and bypass the rate limiter."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"eventBus.getBackPressureSnapshot()"})," surfaces per-channel ",(0,i.jsx)(n.code,{children:"inUse"}),",\n",(0,i.jsx)(n.code,{children:"remainingCapacity"}),", ",(0,i.jsx)(n.code,{children:"highWaterMark"}),", ",(0,i.jsx)(n.code,{children:"cooldownTicksRemaining"}),",\n",(0,i.jsx)(n.code,{children:"softLimitBreaches"}),", and the most recent ",(0,i.jsx)(n.code,{children:"eventsPerSecond"})," sample so\ndashboards and transports can plot sustained load alongside cumulative\ncounters (",(0,i.jsx)(n.code,{children:"events.published"}),", ",(0,i.jsx)(n.code,{children:"events.soft_limited"}),", ",(0,i.jsx)(n.code,{children:"events.overflowed"}),",\n",(0,i.jsx)(n.code,{children:"events.subscribers"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:["Buffers use struct-of-arrays layouts mirroring resource storage so we can\ntransfer them to the shell with minimal copying. Strings (event types, IDs)\nenter a deduplicated string table shared with resource snapshots. When the\nrolling 256-tick average drops below two events per channel, the exporter can\nflip a feature flag to emit compact object arrays instead; diagnostics record\nthe transition so we can revisit the default if sparse workloads dominate.\nBoth frame shapes share a ",(0,i.jsx)(n.code,{children:"format"})," discriminator and diagnostics payload so\ndownstream tooling can branch safely when the fallback is active."]}),"\n",(0,i.jsxs)(n.li,{children:["When offline catch-up runs for many hours, the bus batches events into\nconfigurable windows (default 5 minutes) to prevent unbounded array growth.\nThe implementation segments the backlog into ",(0,i.jsx)(n.code,{children:"RuntimeEventFrame"})," chunks and\nstreams them through the existing recorder infrastructure."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"65-subscription-api-ergonomics",children:"6.5 Subscription API Ergonomics"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Systems register via:","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"interface EventSubscriptionHost {\n  on<TType extends RuntimeEventType>(\n    eventType: TType,\n    handler: EventHandler<TType>,\n  ): EventSubscription;\n}\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"EventSubscription"})," exposes ",(0,i.jsx)(n.code,{children:"unsubscribe()"})," used during system teardown\n(prestige resets, content unload). Teardown defers actual removal until the\nnext tick boundary."]}),"\n",(0,i.jsxs)(n.li,{children:["Provide convenience helpers for common patterns:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"onResourceThreshold(resourceId, comparator, handler)"})," to reduce boilerplate."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"once(eventType, handler)"})," that auto-unsubscribes after first invocation."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"Scripts running inside the deterministic sandbox receive a limited proxy that\nonly allows them to subscribe to whitelisted event types (guarded by content\npermissions)."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"66-external-publishing--replay",children:"6.6 External Publishing & Replay"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Event frames feed into the command recorder (",(0,i.jsx)(n.code,{children:"packages/core/src/command-recorder.ts"}),") so replay files contain both commands and events. Replays validate\nthat emitted events match recorded ones."]}),"\n",(0,i.jsxs)(n.li,{children:["Presentation shell consumes event frames to trigger UI transitions (e.g.,\ntoast notifications). The Vite web shell filters events client-side to avoid\njank during heavy tick loads, as detailed in ",(0,i.jsx)(n.code,{children:"packages/shell-web"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Persistence layer optionally stores the most recent N frames (configurable) to\nresume UI transitions after reload."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"7-integration--sequencing",children:"7. Integration & Sequencing"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Bootstrap wiring:"})," Extend the runtime initialization entry point\n(",(0,i.jsx)(n.code,{children:"packages/core/src/index.ts"}),") to accept an ",(0,i.jsx)(n.code,{children:"EventBusOptions"})," object and\nprovide a default bus instance."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Command queue hook:"})," Inject the publisher into the existing command\ndispatcher so handlers can emit events without importing the bus directly."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"System registration:"})," Update system registries to declare event\ndependencies alongside execution order. This change blocks systems that\nsubscribe to unknown events at bootstrap."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Transport linkage:"})," Enhance ",(0,i.jsx)(n.code,{children:"resource-publish-transport.ts"})," (or extract a\nshared ",(0,i.jsx)(n.code,{children:"state-transport.ts"}),") to serialise ",(0,i.jsx)(n.code,{children:"RuntimeEventFrame"})," payloads."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Telemetry coupling:"})," Forward bus stats into the telemetry facade for Grafana instrumentation when running under Node."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Documentation:"})," Publish event catalog tables in ",(0,i.jsx)(n.code,{children:"docs/runtime-step-lifecycle.md"})," once initial channels ship."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Sequencing aligns with the Phase 1 Runtime Core tasks outlined in the\nimplementation plan: command queue integration precedes transport updates to\nkeep merges small and reviewable."}),"\n",(0,i.jsx)(n.h2,{id:"8-testing-strategy",children:"8. Testing Strategy"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Unit tests:"})," Validate publish/subscribe order, handler isolation, buffer\nlimits, and nested publication semantics in\n",(0,i.jsx)(n.code,{children:"packages/core/src/events/event-bus.test.ts"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Integration tests:"})," Simulate a multi-system tick (resource system +\nautomation system) to confirm deterministic playback across multiple ticks."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Replay verification:"})," Extend ",(0,i.jsx)(n.code,{children:"command-recorder.test.ts"})," to assert that\nrecorded event frames match live emissions when re-running the same command\nsequence."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Performance tests:"})," Benchmark publishing 10k events per tick to ensure the\nbus respects the 100ms budget, mirroring the profiling harness planned in the\nimplementation plan."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"9-observability",children:"9. Observability"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Emit telemetry counters for ",(0,i.jsx)(n.code,{children:"events.published"}),", ",(0,i.jsx)(n.code,{children:"events.soft_limited"}),",\n",(0,i.jsx)(n.code,{children:"events.overflowed"}),", and ",(0,i.jsx)(n.code,{children:"events.subscribers"})," per tick."]}),"\n",(0,i.jsxs)(n.li,{children:["Surface per-channel gauges (",(0,i.jsx)(n.code,{children:"idle_engine_events_soft_limit_cooldown_ticks"}),") and\ncounters (",(0,i.jsx)(n.code,{children:"idle_engine_events_soft_limit_breaches_total"}),") so dashboards can\nhighlight channels that continue to push into the soft limit window."]}),"\n",(0,i.jsxs)(n.li,{children:["Log structured warnings when handlers exceed execution time thresholds (e.g.,","\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"2 ms) to surface slow subscribers."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"Expose a developer-mode event inspector in the web shell that reads the\ntransfer frame and renders the last N events for debugging, including the\ncurrent soft-limit cooldown, breach counts, and per-channel rates sourced from\nthe back-pressure snapshot."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"10-resolved-follow-ups",children:"10. Resolved Follow-Ups"}),"\n",(0,i.jsxs)(n.p,{children:["All deferred decisions from the draft have been finalised in\n",(0,i.jsx)(n.code,{children:"docs/runtime-event-bus-decisions.md"})," (issue #87). Highlights:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Content-defined events:"})," Content packs contribute event types through\nschema-backed manifests generated at build time, preserving deterministic\nreplay manifests."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Priority channels:"})," The bus keeps a single FIFO dispatch order; publishers\ncontrol sequencing by when they emit events rather than via priority tiers."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Back-pressure strategy:"})," Channel-scoped diagnostics throttle soft-limit\nwarnings with configurable limits and exponential backoff while hard caps\nstill abort the tick."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Serialization format:"})," Struct-of-arrays remains the default, with a\nfeature-flagged downgrade to object arrays when rolling density metrics show\nsparse workloads."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"11-risks--mitigations",children:"11. Risks & Mitigations"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Runaway publishers:"})," Excessive event emission could starve tick time.\nMitigation: channel-level thresholds with telemetry alerts and optional\npublisher throttles."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Subscriber side effects:"})," Handlers mutating shared state outside commands\nwould break determinism. Mitigation: pass read-only contexts and audit tests\nfor unauthorized mutations."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Transport bloat:"})," Event frames may enlarge the payload sent to the shell.\nMitigation: compress string tables and allow shell to opt into specific\nchannels."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"12-rollout-plan",children:"12. Rollout Plan"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Land the core event bus with unit tests and documentation stubs."}),"\n",(0,i.jsx)(n.li,{children:"Integrate resource threshold events and confirm shell transport round-trip."}),"\n",(0,i.jsx)(n.li,{children:"Expand coverage to automation toggles and prestige resets."}),"\n",(0,i.jsx)(n.li,{children:"Enable recording/replay validation and ship developer tooling for inspection."}),"\n",(0,i.jsx)(n.li,{children:"Update implementation plan and project board cards once early adopters\nintegrate (saves, UI toasts, analytics)."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Completion of this rollout closes issue #8 and unlocks downstream features that\ndepend on structured runtime event streams."})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},7678:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>l});var t=s(9430);const i={},r=t.createContext(i);function o(e){const n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);