"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[6758],{1696:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"issue-157-design","title":"core/content-schema: CI schema compatibility checks for runtime releases (Issue 157)","description":"Document Control","source":"@site/../../docs/issue-157-design.md","sourceDirName":".","slug":"/issue-157-design","permalink":"/Idle-Game-Engine/issue-157-design","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/issue-157-design.md","tags":[],"version":"current","sidebarPosition":99,"frontMatter":{"title":"core/content-schema: CI schema compatibility checks for runtime releases (Issue 157)","sidebar_position":99}}');var t=s(5270),c=s(7678);const r={title:"core/content-schema: CI schema compatibility checks for runtime releases (Issue 157)",sidebar_position:99},l="core/content-schema: CI schema compatibility checks for runtime releases (Issue 157)",d={},o=[{value:"Document Control",id:"document-control",level:2},{value:"1. Summary",id:"1-summary",level:2},{value:"2. Context &amp; Problem Statement",id:"2-context--problem-statement",level:2},{value:"3. Goals &amp; Non-Goals",id:"3-goals--non-goals",level:2},{value:"4. Stakeholders, Agents &amp; Impacted Surfaces",id:"4-stakeholders-agents--impacted-surfaces",level:2},{value:"5. Current State",id:"5-current-state",level:2},{value:"6. Proposed Solution",id:"6-proposed-solution",level:2},{value:"6.1 Architecture Overview",id:"61-architecture-overview",level:3},{value:"6.2 Detailed Design",id:"62-detailed-design",level:3},{value:"6.3 Operational Considerations",id:"63-operational-considerations",level:3},{value:"7. Work Breakdown &amp; Delivery Plan",id:"7-work-breakdown--delivery-plan",level:2},{value:"7.1 Issue Map",id:"71-issue-map",level:3},{value:"7.2 Milestones",id:"72-milestones",level:3},{value:"7.3 Coordination Notes",id:"73-coordination-notes",level:3},{value:"8. Agent Guidance &amp; Guardrails",id:"8-agent-guidance--guardrails",level:2},{value:"9. Alternatives Considered",id:"9-alternatives-considered",level:2},{value:"10. Testing &amp; Validation Plan",id:"10-testing--validation-plan",level:2},{value:"11. Risks &amp; Mitigations",id:"11-risks--mitigations",level:2},{value:"12. Rollout Plan",id:"12-rollout-plan",level:2},{value:"13. Open Questions",id:"13-open-questions",level:2},{value:"14. Follow-Up Work",id:"14-follow-up-work",level:2},{value:"15. References",id:"15-references",level:2},{value:"Appendix A \u2014 Glossary",id:"appendix-a--glossary",level:2},{value:"Appendix B \u2014 Change Log",id:"appendix-b--change-log",level:2}];function a(e){const n={a:"a",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,c.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"corecontent-schema-ci-schema-compatibility-checks-for-runtime-releases-issue-157",children:"core/content-schema: CI schema compatibility checks for runtime releases (Issue 157)"})}),"\n",(0,t.jsx)(n.h2,{id:"document-control",children:"Document Control"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Title"}),": CI schema compatibility checks for runtime releases"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Authors"}),": Codex (AI)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Reviewers"}),": TBD"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Status"}),": Draft"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Last Updated"}),": 2026-01-23"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Related Issues"}),": ",(0,t.jsx)(n.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/157",children:"https://github.com/hansjm10/Idle-Game-Engine/issues/157"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Execution Mode"}),": AI-led"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"1-summary",children:"1. Summary"}),"\n",(0,t.jsxs)(n.p,{children:["This design adds a fast, release-gating schema compatibility check for ",(0,t.jsx)(n.code,{children:"@idle-engine/core"})," to prevent the runtime from being released in a state that is incompatible with the content schema feature-gating model. We introduce a focused ",(0,t.jsx)(n.code,{children:"pnpm --filter @idle-engine/core test:schema-compat"})," script, wire it into CI, add a publish hook for core, and document the required workflow for evolving ",(0,t.jsx)(n.code,{children:"FEATURE_GATES"})," alongside runtime version bumps."]}),"\n",(0,t.jsx)(n.h2,{id:"2-context--problem-statement",children:"2. Context & Problem Statement"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Background"}),": Content packs are validated by ",(0,t.jsx)(n.code,{children:"@idle-engine/content-schema"}),", which uses ",(0,t.jsx)(n.code,{children:"FEATURE_GATES"})," to enforce minimum runtime versions per gated module (",(0,t.jsx)(n.code,{children:"packages/content-schema/src/runtime-compat.ts:3"}),"). ",(0,t.jsx)(n.code,{children:"resolveFeatureViolations"})," is applied during validation when ",(0,t.jsx)(n.code,{children:"ContentSchemaOptions.runtimeVersion"})," is provided (",(0,t.jsx)(n.code,{children:"packages/content-schema/src/pack/index.ts:162"}),"). The content validation CLI passes ",(0,t.jsx)(n.code,{children:"runtimeVersion: RUNTIME_VERSION"})," when validating packs (",(0,t.jsx)(n.code,{children:"tools/content-schema-cli/src/generate.ts:1036"}),")."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Problem"}),": We do not currently enforce that the runtime version being released (",(0,t.jsx)(n.code,{children:"@idle-engine/core"})," version / ",(0,t.jsx)(n.code,{children:"RUNTIME_VERSION"}),") is compatible with all declared feature gates. CI can remain green if no active pack exercises a newly gated module. Before this change, ",(0,t.jsx)(n.code,{children:"@idle-engine/core"})," was ",(0,t.jsx)(n.code,{children:"0.4.0"})," while ",(0,t.jsx)(n.code,{children:"FEATURE_GATES"})," included ",(0,t.jsx)(n.code,{children:"entities"})," introduced in ",(0,t.jsx)(n.code,{children:"0.5.0"}),", illustrating a drift scenario that was not caught by current workflows."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Forces"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Keep checks deterministic and fast (suitable for CI and publish hooks)."}),"\n",(0,t.jsxs)(n.li,{children:["Avoid test console output that could interfere with ",(0,t.jsx)(n.code,{children:"vitest-llm-reporter"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Provide a clear, documented process for updating ",(0,t.jsx)(n.code,{children:"FEATURE_GATES"})," and runtime versions together."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"3-goals--non-goals",children:"3. Goals & Non-Goals"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Goals"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Add a dedicated ",(0,t.jsx)(n.code,{children:"@idle-engine/core"})," script: ",(0,t.jsx)(n.code,{children:"test:schema-compat"})," (invoked as ",(0,t.jsx)(n.code,{children:"pnpm --filter @idle-engine/core test:schema-compat"}),")."]}),"\n",(0,t.jsxs)(n.li,{children:["Fail the check if ",(0,t.jsx)(n.code,{children:"RUNTIME_VERSION"})," is lower than any ",(0,t.jsx)(n.code,{children:"FEATURE_GATES[].introducedIn"})," value."]}),"\n",(0,t.jsxs)(n.li,{children:["Validate that a synthetic \u201ccompat pack\u201d enabling every gated module validates successfully when ",(0,t.jsx)(n.code,{children:"runtimeVersion"})," is ",(0,t.jsx)(n.code,{children:"RUNTIME_VERSION"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Gate core publishing via ",(0,t.jsx)(n.code,{children:"prepublishOnly"})," (or equivalent) so incompatible releases cannot be pushed accidentally."]}),"\n",(0,t.jsxs)(n.li,{children:["Document a schema evolution policy for when and how to bump ",(0,t.jsx)(n.code,{children:"FEATURE_GATES"})," and runtime versions."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Non-Goals"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Changing the semantics of feature gates (min-version checks) or pack validation."}),"\n",(0,t.jsx)(n.li,{children:"Reworking the overall release tooling for the monorepo (changesets, publish pipelines, etc.)."}),"\n",(0,t.jsx)(n.li,{children:"Proving full behavioral correctness of every runtime feature (this is a compatibility contract check, not a full simulation test suite)."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"4-stakeholders-agents--impacted-surfaces",children:"4. Stakeholders, Agents & Impacted Surfaces"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Primary Stakeholders"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Runtime maintainers (",(0,t.jsx)(n.code,{children:"packages/core"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:["Content-schema maintainers (",(0,t.jsx)(n.code,{children:"packages/content-schema"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:["Content pipeline maintainers (",(0,t.jsx)(n.code,{children:"tools/content-schema-cli"}),", ",(0,t.jsx)(n.code,{children:"packages/content-compiler"}),")"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Agent Roles"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Core Test Agent"}),": Add ",(0,t.jsx)(n.code,{children:"test:schema-compat"})," and the focused Vitest suite."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"CI Agent"}),": Wire the new check into ",(0,t.jsx)(n.code,{children:".github/workflows/ci.yml"})," (and any release workflows)."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Docs Agent"}),": Document the schema evolution policy and maintenance checklist."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Affected Packages/Services"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"packages/core/package.json"})," (new scripts, publish hooks)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"packages/core/src/**"})," (schema-compat tests)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:".github/workflows/ci.yml"})," (new CI step)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"docs/content-dsl-usage-guidelines.md"})," (policy/docs updates)"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Compatibility Considerations"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"No runtime API changes; only test/CI/publish guardrails."}),"\n",(0,t.jsx)(n.li,{children:"The new check may require a version bump or gate adjustment to restore consistency (see Open Questions)."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"5-current-state",children:"5. Current State"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"FEATURE_GATES"})," is the canonical map of \u201cschema module \u2192 minimum runtime version\u201d (",(0,t.jsx)(n.code,{children:"packages/content-schema/src/runtime-compat.ts:3-29"}),")."]}),"\n",(0,t.jsxs)(n.li,{children:["Feature gate enforcement happens only when a pack uses a gated module and the caller provides ",(0,t.jsx)(n.code,{children:"ContentSchemaOptions.runtimeVersion"})," (",(0,t.jsx)(n.code,{children:"packages/content-schema/src/pack/index.ts:162-188"}),")."]}),"\n",(0,t.jsxs)(n.li,{children:["The content validation pipeline runs with the current runtime version (CLI passes ",(0,t.jsx)(n.code,{children:"runtimeVersion: RUNTIME_VERSION"}),") (",(0,t.jsx)(n.code,{children:"tools/content-schema-cli/src/generate.ts:1036-1042"}),"), but this only catches drift if some validated pack exercises the newly gated module."]}),"\n",(0,t.jsxs)(n.li,{children:["CI currently validates that ",(0,t.jsx)(n.code,{children:"RUNTIME_VERSION"})," matches ",(0,t.jsx)(n.code,{children:"packages/core/package.json"})," (",(0,t.jsx)(n.code,{children:"tools/scripts/validate-runtime-version.mjs"}),"), but not that it satisfies ",(0,t.jsx)(n.code,{children:"FEATURE_GATES"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"6-proposed-solution",children:"6. Proposed Solution"}),"\n",(0,t.jsx)(n.h3,{id:"61-architecture-overview",children:"6.1 Architecture Overview"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Add a small, isolated Vitest suite in ",(0,t.jsx)(n.code,{children:"@idle-engine/core"})," that imports the schema package\u2019s compatibility primitives (",(0,t.jsx)(n.code,{children:"FEATURE_GATES"}),", ",(0,t.jsx)(n.code,{children:"resolveFeatureViolations"}),", ",(0,t.jsx)(n.code,{children:"createContentPackValidator"}),")."]}),"\n",(0,t.jsxs)(n.li,{children:["Run the suite via a dedicated package script (",(0,t.jsx)(n.code,{children:"test:schema-compat"}),") so CI and publish hooks can invoke it without executing the full core test suite."]}),"\n",(0,t.jsxs)(n.li,{children:["Update CI to run ",(0,t.jsx)(n.code,{children:"pnpm --filter @idle-engine/core test:schema-compat"})," as a first-class quality gate."]}),"\n",(0,t.jsxs)(n.li,{children:["Guard core publishing via a ",(0,t.jsx)(n.code,{children:"prepublishOnly"})," (or ",(0,t.jsx)(n.code,{children:"prepack"}),") hook that runs the same script."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"62-detailed-design",children:"6.2 Detailed Design"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Core script"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Add to ",(0,t.jsx)(n.code,{children:"packages/core/package.json"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"test:schema-compat"}),": runs only the schema compatibility tests (for example, ",(0,t.jsx)(n.code,{children:"vitest run src/__tests__/schema-compat.test.ts"}),")."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"prepublishOnly"})," (or ",(0,t.jsx)(n.code,{children:"prepack"}),"): runs ",(0,t.jsx)(n.code,{children:"pnpm run test:schema-compat"})," to block publishing on failure."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Schema compat tests (core)"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Add ",(0,t.jsx)(n.code,{children:"packages/core/src/__tests__/schema-compat.test.ts"})," with two primary test cases:","\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Runtime version \u2265 all feature gates"})}),"\n"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Build a ",(0,t.jsx)(n.code,{children:"FeatureGateMap"})," where every module in ",(0,t.jsx)(n.code,{children:"FEATURE_GATES"})," is treated as \u201cin use\u201d."]}),"\n",(0,t.jsxs)(n.li,{children:["Assert ",(0,t.jsx)(n.code,{children:"resolveFeatureViolations(RUNTIME_VERSION, allEnabledMap)"})," returns ",(0,t.jsx)(n.code,{children:"[]"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["This directly enforces that ",(0,t.jsx)(n.code,{children:"FEATURE_GATES[].introducedIn"})," never points to a future runtime release."]}),"\n"]}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Schema validates a compat pack under current runtime"})}),"\n"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Construct a minimal pack object that includes at least one entry in each gated module array:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"automations"}),", ",(0,t.jsx)(n.code,{children:"entities"}),", ",(0,t.jsx)(n.code,{children:"transforms"}),", ",(0,t.jsx)(n.code,{children:"runtimeEvents"}),", ",(0,t.jsx)(n.code,{children:"prestigeLayers"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Ensure all cross references are self-contained (resources referenced by generators/transforms exist; prestige layers include the required ",(0,t.jsx)(n.code,{children:"${layerId}-prestige-count"})," resource)."]}),"\n",(0,t.jsxs)(n.li,{children:["Run ",(0,t.jsx)(n.code,{children:"createContentPackValidator({ runtimeVersion: RUNTIME_VERSION })"})," and assert:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Validation succeeds"}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"warnings.length === 0"})," (or a tightly-scoped allowlist if unavoidable)"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:"Optional (recommended) follow-up: instantiate a core runtime with the normalized pack and run a single tick as a smoke test to confirm core can consume the \u201call modules enabled\u201d shape without throwing."}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"CI integration"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Update ",(0,t.jsx)(n.code,{children:".github/workflows/ci.yml"})," ",(0,t.jsx)(n.code,{children:"quality-gate"})," job to add:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"pnpm --filter @idle-engine/core test:schema-compat"})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Place it after dependency install and before broader ",(0,t.jsx)(n.code,{children:"pnpm test:ci"})," to fail fast."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Documentation"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Update ",(0,t.jsx)(n.code,{children:"docs/content-dsl-usage-guidelines.md"})," under \u201cCompatibility Triage\u201d with an explicit \u201cSchema evolution policy\u201d subsection:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["When adding a new gated module (or expanding an existing one), update ",(0,t.jsx)(n.code,{children:"FEATURE_GATES"})," and bump ",(0,t.jsx)(n.code,{children:"@idle-engine/core"})," version in the same PR."]}),"\n",(0,t.jsxs)(n.li,{children:["Require ",(0,t.jsx)(n.code,{children:"pnpm --filter @idle-engine/core test:schema-compat"})," to pass before merging."]}),"\n",(0,t.jsx)(n.li,{children:"Require updating the compatibility table (and rely on existing docs-sync tests)."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"63-operational-considerations",children:"6.3 Operational Considerations"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Deployment"}),": CI step addition is straightforward; the only operational change is an additional failing gate for incompatible version/gate updates."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Telemetry & Observability"}),": N/A (test-only)."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Security & Compliance"}),": N/A."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"7-work-breakdown--delivery-plan",children:"7. Work Breakdown & Delivery Plan"}),"\n",(0,t.jsx)(n.h3,{id:"71-issue-map",children:"7.1 Issue Map"}),"\n",(0,t.jsx)(n.p,{children:"This table decomposes Issue 157 into implementation slices that can be executed and reviewed independently."}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Issue Title"}),(0,t.jsx)(n.th,{children:"Scope Summary"}),(0,t.jsx)(n.th,{children:"Proposed Assignee/Agent"}),(0,t.jsx)(n.th,{children:"Dependencies"}),(0,t.jsx)(n.th,{children:"Acceptance Criteria"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"feat(core): add schema compat tests"}),(0,t.jsxs)(n.td,{children:["Add ",(0,t.jsx)(n.code,{children:"test:schema-compat"})," + Vitest suite validating ",(0,t.jsx)(n.code,{children:"FEATURE_GATES"})," vs ",(0,t.jsx)(n.code,{children:"RUNTIME_VERSION"})," and validating a compat pack"]}),(0,t.jsx)(n.td,{children:"Core Test Agent"}),(0,t.jsx)(n.td,{children:"None"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"pnpm --filter @idle-engine/core test:schema-compat"})," fails on drift"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"chore(ci): run core schema compat"}),(0,t.jsxs)(n.td,{children:["Add CI step to run ",(0,t.jsx)(n.code,{children:"test:schema-compat"})]}),(0,t.jsx)(n.td,{children:"CI Agent"}),(0,t.jsx)(n.td,{children:"schema compat tests merged"}),(0,t.jsx)(n.td,{children:"CI fails fast on drift"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"chore(core): guard publish with schema compat"}),(0,t.jsxs)(n.td,{children:["Add ",(0,t.jsx)(n.code,{children:"prepublishOnly"}),"/",(0,t.jsx)(n.code,{children:"prepack"})," to core package"]}),(0,t.jsx)(n.td,{children:"Core Test Agent"}),(0,t.jsx)(n.td,{children:"schema compat tests merged"}),(0,t.jsx)(n.td,{children:"Release/publish blocked when compat fails"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"docs: document schema evolution policy"}),(0,t.jsxs)(n.td,{children:["Add workflow notes to ",(0,t.jsx)(n.code,{children:"docs/content-dsl-usage-guidelines.md"})]}),(0,t.jsx)(n.td,{children:"Docs Agent"}),(0,t.jsx)(n.td,{children:"None"}),(0,t.jsx)(n.td,{children:"Policy exists; references correct source files"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"72-milestones",children:"7.2 Milestones"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Phase 1"}),": Implement core schema-compat tests + script."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Phase 2"}),": Wire CI + publish hooks."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Phase 3"}),": Document schema evolution policy and maintenance checklist."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"73-coordination-notes",children:"7.3 Coordination Notes"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Hand-off Package"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"packages/content-schema/src/runtime-compat.ts"})}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"packages/content-schema/src/pack/index.ts"})," (feature gate validation)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"tools/content-schema-cli/src/generate.ts"})," (runtimeVersion wiring)"]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:".github/workflows/ci.yml"})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Communication Cadence"}),": One review checkpoint after Phase 1 (tests + script), then a second after CI/publish hooks are in place."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"8-agent-guidance--guardrails",children:"8. Agent Guidance & Guardrails"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Context Packets"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"packages/content-schema/src/runtime-compat.ts"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"packages/content-schema/src/pack/index.ts"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"packages/core/src/version.ts"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"tools/content-schema-cli/src/generate.ts"})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Prompting & Constraints"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Keep tests deterministic and avoid console output that could interfere with ",(0,t.jsx)(n.code,{children:"vitest-llm-reporter"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Use type-only imports (",(0,t.jsx)(n.code,{children:"import type"}),") where applicable."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Safety Rails"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Do not edit checked-in ",(0,t.jsx)(n.code,{children:"dist/**"})," outputs by hand."]}),"\n",(0,t.jsx)(n.li,{children:"Do not weaken existing feature gate semantics (warnings vs errors) without explicit approval."}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Validation Hooks"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"pnpm --filter @idle-engine/core test:schema-compat"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"pnpm test:ci"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"pnpm lint"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"9-alternatives-considered",children:"9. Alternatives Considered"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsxs)(n.strong,{children:["Rely on ",(0,t.jsx)(n.code,{children:"pnpm generate --check"})]}),": Insufficient because it only validates packs present in the repo; drift can hide until a pack exercises the gated module."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsxs)(n.strong,{children:["Put all checks in ",(0,t.jsx)(n.code,{children:"@idle-engine/content-schema"})]}),": Helps detect drift, but does not provide a core-local publish gate and complicates workflows that operate on the core package alone."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Allow \u201cfuture\u201d feature gates"}),": Could support roadmap planning, but undermines the goal of preventing runtime/schema drift for released artifacts. If needed, a separate \u201cplanned gates\u201d list should be introduced explicitly."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"10-testing--validation-plan",children:"10. Testing & Validation Plan"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Unit / Integration"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Add focused Vitest tests in core (schema-compat suite only)."}),"\n",(0,t.jsxs)(n.li,{children:["Ensure the compat pack validates with ",(0,t.jsx)(n.code,{children:"runtimeVersion: RUNTIME_VERSION"})," and produces zero warnings."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Performance"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Keep ",(0,t.jsx)(n.code,{children:"test:schema-compat"})," under ~1s locally/CI by avoiding full runtime simulations."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Tooling / A11y"}),": N/A."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"11-risks--mitigations",children:"11. Risks & Mitigations"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Risk"}),": The new gate forces version bumps whenever ",(0,t.jsx)(n.code,{children:"FEATURE_GATES"})," changes.",(0,t.jsx)(n.br,{}),"\n",(0,t.jsx)(n.strong,{children:"Mitigation"}),": Treat ",(0,t.jsx)(n.code,{children:"FEATURE_GATES"})," as \u201cshipped runtime features only\u201d; do not add entries for future/planned versions."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Risk"}),": The compat pack becomes brittle as schema requirements evolve.",(0,t.jsx)(n.br,{}),"\n",(0,t.jsx)(n.strong,{children:"Mitigation"}),": Build it using ",(0,t.jsx)(n.code,{children:"@idle-engine/content-schema"})," factories where possible and keep it minimal; update alongside schema changes in the same PR."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Risk"}),": Duplicate checks between CI steps and publish hooks.",(0,t.jsx)(n.br,{}),"\n",(0,t.jsx)(n.strong,{children:"Mitigation"}),": Keep the suite tiny; redundancy is intentional for defense-in-depth."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"12-rollout-plan",children:"12. Rollout Plan"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Milestones"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Merge Phase 1: schema-compat tests and script in core."}),"\n",(0,t.jsx)(n.li,{children:"Merge Phase 2: CI step + publish hook."}),"\n",(0,t.jsx)(n.li,{children:"Merge Phase 3: docs update."}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Migration Strategy"}),": None (guardrail addition only)."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Communication"}),": Note in PR description that core releases are now blocked unless schema compatibility checks pass."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"13-open-questions",children:"13. Open Questions"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Should ",(0,t.jsx)(n.code,{children:"FEATURE_GATES"})," ever contain entries for unreleased/future runtime versions (roadmap), or must it always be \u2264 ",(0,t.jsx)(n.code,{children:"RUNTIME_VERSION"}),"?"]}),"\n",(0,t.jsxs)(n.li,{children:["For the current drift (",(0,t.jsx)(n.code,{children:"RUNTIME_VERSION = 0.4.0"})," vs ",(0,t.jsx)(n.code,{children:"entities introducedIn = 0.5.0"}),"), should we bump core to ",(0,t.jsx)(n.code,{children:"0.5.0"})," or adjust the gate version? ",(0,t.jsx)(n.strong,{children:"Resolved in this implementation"}),": bump core to ",(0,t.jsx)(n.code,{children:"0.5.0"}),"."]}),"\n",(0,t.jsx)(n.li,{children:"Should the schema-compat suite include a minimal runtime \u201ctick once\u201d smoke test, or keep validation-only to minimize runtime coupling?"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"14-follow-up-work",children:"14. Follow-Up Work"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Consider adding a small \u201ccontract smoke pack\u201d that is also consumed by a runtime wiring test to catch schema/runtime mismatches beyond version gating."}),"\n",(0,t.jsxs)(n.li,{children:["If release tooling changes (changesets, publishing public packages), ensure the new ",(0,t.jsx)(n.code,{children:"prepublishOnly"})," hook is still invoked in the release pipeline."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"15-references",children:"15. References"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Issue 157: ",(0,t.jsx)(n.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/157",children:"https://github.com/hansjm10/Idle-Game-Engine/issues/157"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"FEATURE_GATES"}),": ",(0,t.jsx)(n.code,{children:"packages/content-schema/src/runtime-compat.ts:3"})]}),"\n",(0,t.jsxs)(n.li,{children:["Feature gate validation: ",(0,t.jsx)(n.code,{children:"packages/content-schema/src/pack/index.ts:162"})]}),"\n",(0,t.jsxs)(n.li,{children:["CLI uses runtime version during validation: ",(0,t.jsx)(n.code,{children:"tools/content-schema-cli/src/generate.ts:1036"})]}),"\n",(0,t.jsxs)(n.li,{children:["Current runtime version constant: ",(0,t.jsx)(n.code,{children:"packages/core/src/version.ts:26"})]}),"\n",(0,t.jsxs)(n.li,{children:["CI workflow: ",(0,t.jsx)(n.code,{children:".github/workflows/ci.yml"})]}),"\n",(0,t.jsxs)(n.li,{children:["Decision log risk entry: ",(0,t.jsx)(n.code,{children:"docs/content-schema-rollout-decisions.md"})," (\u201cSchema Drift vs Runtime\u201d)"]}),"\n",(0,t.jsxs)(n.li,{children:["Schema design risk table: ",(0,t.jsx)(n.code,{children:"docs/content-dsl-schema-design.md"})," (\u201cSchema drift vs runtime\u201d)"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"appendix-a--glossary",children:"Appendix A \u2014 Glossary"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Feature gate"}),": A mapping from a schema module to the minimum runtime version that can safely execute it."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"runtimeVersion"})}),": ",(0,t.jsx)(n.code,{children:"ContentSchemaOptions.runtimeVersion"}),"; the runtime version used to enforce feature-gate compatibility during content validation."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Schema drift"}),": When schema expectations (including feature gates) move ahead of the runtime being released."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"appendix-b--change-log",children:"Appendix B \u2014 Change Log"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Date"}),(0,t.jsx)(n.th,{children:"Author"}),(0,t.jsx)(n.th,{children:"Change Summary"})]})}),(0,t.jsx)(n.tbody,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"2026-01-23"}),(0,t.jsx)(n.td,{children:"Codex (AI)"}),(0,t.jsx)(n.td,{children:"Initial draft design doc for Issue 157"})]})})]})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},7678:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>l});var i=s(9430);const t={},c=i.createContext(t);function r(e){const n=i.useContext(c);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),i.createElement(c.Provider,{value:n},e.children)}}}]);