"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[560],{7678:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>d});var t=r(9430);const i={},s=t.createContext(i);function o(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(s.Provider,{value:n},e.children)}},8120:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"worker-bridge-extension-tutorial","title":"Worker Bridge Extension Tutorial","description":"Walkthrough for adding a custom runtime command that flows from React through the worker bridge into the deterministic runtime.","source":"@site/../../docs/worker-bridge-extension-tutorial.md","sourceDirName":".","slug":"/worker-bridge-extension-tutorial","permalink":"/Idle-Game-Engine/worker-bridge-extension-tutorial","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/worker-bridge-extension-tutorial.md","tags":[],"version":"current","frontMatter":{"title":"Worker Bridge Extension Tutorial","description":"Walkthrough for adding a custom runtime command that flows from React through the worker bridge into the deterministic runtime."},"sidebar":"developerSidebar","previous":{"title":"Automated Accessibility Smoke Tests","permalink":"/Idle-Game-Engine/accessibility-smoke-tests-design"},"next":{"title":"Coverage Report","permalink":"/Idle-Game-Engine/coverage/"}}');var i=r(5270),s=r(7678);const o={title:"Worker Bridge Extension Tutorial",description:"Walkthrough for adding a custom runtime command that flows from React through the worker bridge into the deterministic runtime."},d="Worker Bridge Extension Tutorial",a={},c=[{value:"Before You Start",id:"before-you-start",level:2},{value:"1. Map the Bridge Contract",id:"1-map-the-bridge-contract",level:2},{value:"2. Define the Runtime Command",id:"2-define-the-runtime-command",level:2},{value:"3. Allow the Worker to Enqueue the Command",id:"3-allow-the-worker-to-enqueue-the-command",level:2},{value:"4. Send and Observe the Command from React",id:"4-send-and-observe-the-command-from-react",level:2},{value:"5. Validate the Extension",id:"5-validate-the-extension",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Next Steps",id:"next-steps",level:2}];function l(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"worker-bridge-extension-tutorial",children:"Worker Bridge Extension Tutorial"})}),"\n",(0,i.jsxs)(n.p,{children:["Create the developer tutorial promised in ",(0,i.jsx)(n.a,{href:"/Idle-Game-Engine/runtime-react-worker-bridge-design#142-remaining-items",children:"docs/runtime-react-worker-bridge-design.md \xa714.2"})," so contributors can extend the runtime\u2192React worker bridge with confidence. This guide anchors every step back to the design doc for issue #16 and highlights the code you will touch when shipping a new command end-to-end."]}),"\n",(0,i.jsx)(n.h2,{id:"before-you-start",children:"Before You Start"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Read the worker bridge design, especially ",(0,i.jsx)(n.a,{href:"/Idle-Game-Engine/runtime-react-worker-bridge-design#62-detailed-design",children:"\xa76.2 Detailed Design"})," for the message contract and ",(0,i.jsx)(n.a,{href:"/Idle-Game-Engine/runtime-react-worker-bridge-design#10-testing--validation-plan",children:"\xa710 Testing & Validation Plan"})," for required checks."]}),"\n",(0,i.jsxs)(n.li,{children:["Confirm your workspace is synced with ",(0,i.jsx)(n.code,{children:"pnpm install"})," (Node \u226520.10, pnpm \u22658) and that ",(0,i.jsx)(n.code,{children:"pnpm lint"})," and ",(0,i.jsx)(n.code,{children:"pnpm test"})," pass on ",(0,i.jsx)(n.code,{children:"main"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Keep ",(0,i.jsx)(n.code,{children:"packages/shell-web/src/modules/worker-bridge.ts"})," and ",(0,i.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.ts"})," open\u2014most bridge changes live there."]}),"\n",(0,i.jsxs)(n.li,{children:["When UI surfaces change, plan to run ",(0,i.jsx)(n.code,{children:"pnpm test:a11y"})," as called out in the ",(0,i.jsx)(n.a,{href:"/Idle-Game-Engine/accessibility-smoke-tests-design",children:"Accessibility smoke test design"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"1-map-the-bridge-contract",children:"1. Map the Bridge Contract"}),"\n",(0,i.jsx)(n.p,{children:"The worker bridge enforces a discriminated union of messages. Before adding anything new:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Inspect ",(0,i.jsx)(n.code,{children:"packages/shell-web/src/modules/worker-bridge.ts"})," (",(0,i.jsx)(n.code,{children:"WorkerBridge.sendCommand"}),") to see how UI payloads are wrapped with ",(0,i.jsx)(n.code,{children:"source"}),", ",(0,i.jsx)(n.code,{children:"requestId"}),", and the ",(0,i.jsx)(n.code,{children:"WORKER_MESSAGE_SCHEMA_VERSION"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Review the command validation path inside ",(0,i.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.ts"})," (",(0,i.jsx)(n.code,{children:"handleCommandMessage"}),", replay protection, and error telemetry). This code implements the READY/ERROR handshake and schema guardrails described in ",(0,i.jsx)(n.a,{href:"/Idle-Game-Engine/runtime-react-worker-bridge-design#62-detailed-design",children:"\xa76.2"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Decide whether your command belongs to the core runtime (",(0,i.jsx)(n.code,{children:"@idle-engine/core"}),") or a feature module. The worker simply enqueues commands; the runtime is responsible for registering handlers and publishing events."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Document the command intent and payload shape up front\u2014future agents rely on these notes when auditing bridge changes."}),"\n",(0,i.jsx)(n.h2,{id:"2-define-the-runtime-command",children:"2. Define the Runtime Command"}),"\n",(0,i.jsxs)(n.p,{children:["The runtime owns canonical command definitions. Add a new payload type, identifier, and handler under ",(0,i.jsx)(n.code,{children:"packages/core"})," so the bridge can dispatch it deterministically."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="packages/core/src/command.ts"',children:"export const RUNTIME_COMMAND_TYPES = Object.freeze({\n  PURCHASE_GENERATOR: 'PURCHASE_GENERATOR',\n  TOGGLE_GENERATOR: 'TOGGLE_GENERATOR',\n  COLLECT_RESOURCE: 'COLLECT_RESOURCE',\n  PRESTIGE_RESET: 'PRESTIGE_RESET',\n  OFFLINE_CATCHUP: 'OFFLINE_CATCHUP',\n  APPLY_MIGRATION: 'APPLY_MIGRATION',\n  GRANT_RESOURCE_BONUS: 'GRANT_RESOURCE_BONUS',\n} as const);\n\nexport interface GrantResourceBonusPayload {\n  readonly resourceId: string;\n  readonly amount: number;\n  readonly reason?: string;\n}\n\nexport interface RuntimeCommandPayloads {\n  readonly PURCHASE_GENERATOR: PurchaseGeneratorPayload;\n  readonly TOGGLE_GENERATOR: ToggleGeneratorPayload;\n  readonly COLLECT_RESOURCE: CollectResourcePayload;\n  readonly PRESTIGE_RESET: PrestigeResetPayload;\n  readonly OFFLINE_CATCHUP: OfflineCatchupPayload;\n  readonly APPLY_MIGRATION: ApplyMigrationPayload;\n  readonly GRANT_RESOURCE_BONUS: GrantResourceBonusPayload;\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"With the payload in place, register a handler so the dispatcher knows how to execute it. This example wires directly into the existing resource helpers, but your feature may live elsewhere:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="packages/core/src/resource-command-handlers.ts"',children:"dispatcher.register<GrantResourceBonusPayload>(\n  RUNTIME_COMMAND_TYPES.GRANT_RESOURCE_BONUS,\n  (payload, context) => {\n    if (!Number.isFinite(payload.amount) || payload.amount <= 0) {\n      telemetry.recordError('ResourceBonusInvalidAmount', {\n        resourceId: payload.resourceId,\n        amount: payload.amount,\n        step: context.step,\n      });\n      return;\n    }\n\n    const index = resources.requireIndex(payload.resourceId);\n    resources.addAmount(index, payload.amount);\n\n    telemetry.recordProgress('ResourceBonusGranted', {\n      resourceId: payload.resourceId,\n      amount: payload.amount,\n      reason: payload.reason,\n      step: context.step,\n    });\n  },\n);\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Update or create Vitest coverage so the new dispatcher path is enforced (see ",(0,i.jsx)(n.code,{children:"packages/core/src/resource-command-handlers.test.ts"})," for patterns). The runtime design mandates deterministic behaviour, so tests should assert ordering, validation, and telemetry."]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Design doc tie-back:"})," This work satisfies \u201cPublish an authoritative Worker message contract\u201d and \u201cShip reusable bridge surfaces\u201d from ",(0,i.jsx)(n.a,{href:"/Idle-Game-Engine/runtime-react-worker-bridge-design#3-goals--non-goals",children:"\xa73 Goals"})," by keeping type information centralised in ",(0,i.jsx)(n.code,{children:"@idle-engine/core"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"3-allow-the-worker-to-enqueue-the-command",children:"3. Allow the Worker to Enqueue the Command"}),"\n",(0,i.jsxs)(n.p,{children:["The worker already enqueues any ",(0,i.jsx)(n.code,{children:"COMMAND"})," payloads that pass validation, but you should double-check whether additional safeguards are needed:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["If the command must run with a different priority (e.g., automation/system), set the ",(0,i.jsx)(n.code,{children:"source"})," accordingly when you call ",(0,i.jsx)(n.code,{children:"sendCommand"}),", or adjust the worker enqueue logic near ",(0,i.jsx)(n.code,{children:"handleCommandMessage"})," in ",(0,i.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.ts"})," to map known command identifiers to alternate ",(0,i.jsx)(n.code,{children:"CommandPriority"})," values."]}),"\n",(0,i.jsxs)(n.li,{children:["Validate that ",(0,i.jsx)(n.code,{children:"WORKER_MESSAGE_SCHEMA_VERSION"})," remains unchanged. If you add new envelope fields, bump the version and extend the discriminated union in ",(0,i.jsx)(n.code,{children:"@idle-engine/runtime-bridge-contracts"})," per ",(0,i.jsx)(n.a,{href:"/Idle-Game-Engine/runtime-react-worker-bridge-design#62-detailed-design",children:"\xa76.2 Data & Schemas"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Extend the worker Vitest suite (",(0,i.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.test.ts"}),") with a case exercising your new command. Follow the replay-protection and schema tests that reference ",(0,i.jsx)(n.code,{children:"'PING'"})," for guidance."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["When the worker needs to respond with additional data (for example, command-specific errors), update the ",(0,i.jsx)(n.code,{children:"RuntimeWorkerOutboundMessage"})," union and emit the new envelope from the worker so the bridge can surface it to React."]}),"\n",(0,i.jsx)(n.h2,{id:"4-send-and-observe-the-command-from-react",children:"4. Send and Observe the Command from React"}),"\n",(0,i.jsxs)(n.p,{children:["React components interact with the worker through ",(0,i.jsx)(n.code,{children:"useWorkerBridge"}),". The tutorial example adds a button that boosts a generator; adjust the payload to match your own feature."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",metastring:'title="packages/shell-web/src/modules/App.tsx"',children:"const bridge = useWorkerBridge();\n\nconst handleGrantBonus = async () => {\n  await bridge.awaitReady();\n  bridge.sendCommand(RUNTIME_COMMAND_TYPES.GRANT_RESOURCE_BONUS, {\n    resourceId: selectedResourceId,\n    amount: 150,\n    reason: 'tutorial-demo',\n  });\n};\n\nreturn (\n  <button type=\"button\" onClick={handleGrantBonus}>\n    Grant Bonus Resource\n  </button>\n);\n"})}),"\n",(0,i.jsxs)(n.p,{children:["If you need to surface responses, register an ",(0,i.jsx)(n.code,{children:"onStateUpdate"})," or ",(0,i.jsx)(n.code,{children:"onError"})," callback:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"useEffect(() => {\n  const handleError = (error: RuntimeWorkerErrorDetails) => {\n    if (error.code === 'INVALID_COMMAND_PAYLOAD') {\n      toast.error(error.message);\n    }\n  };\n\n  bridge.onError(handleError);\n  return () => bridge.offError(handleError);\n}, [bridge]);\n"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Diagnostics:"})," For features that ship diagnostics, wire ",(0,i.jsx)(n.code,{children:"enableDiagnostics"})," / ",(0,i.jsx)(n.code,{children:"onDiagnosticsUpdate"})," to capture performance data as described in ",(0,i.jsx)(n.a,{href:"/Idle-Game-Engine/runtime-react-worker-bridge-design#62-detailed-design",children:"\xa76.2 APIs & Contracts"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"5-validate-the-extension",children:"5. Validate the Extension"}),"\n",(0,i.jsx)(n.p,{children:"When the implementation is complete, run the full validation checklist referenced in the issue:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"pnpm lint\npnpm test --filter shell-web\npnpm test --filter core\n# Required when UI flows change\npnpm test:a11y\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Keep the ",(0,i.jsx)(n.code,{children:"vitest-llm-reporter"})," JSON footer intact\u2014avoid extra console output."]}),"\n",(0,i.jsx)(n.li,{children:"If your command modifies the UI, capture screenshots or recordings for the Presentation Shell review."}),"\n",(0,i.jsx)(n.li,{children:"Update documentation and tests alongside code so future agents inherit a working baseline."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Symptom"}),(0,i.jsx)(n.th,{children:"Likely Cause"}),(0,i.jsx)(n.th,{children:"Remediation"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"WorkerBridge"})," rejects the command with ",(0,i.jsx)(n.code,{children:"INVALID_COMMAND_PAYLOAD"})]}),(0,i.jsxs)(n.td,{children:["Payload is missing required fields or ",(0,i.jsx)(n.code,{children:"issuedAt"})," is not finite"]}),(0,i.jsx)(n.td,{children:"Inspect the React call site and ensure payload matches the runtime type definition."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:["Worker logs ",(0,i.jsx)(n.code,{children:"SCHEMA_VERSION_MISMATCH"})]}),(0,i.jsxs)(n.td,{children:["Bridge and worker disagree on ",(0,i.jsx)(n.code,{children:"WORKER_MESSAGE_SCHEMA_VERSION"})]}),(0,i.jsxs)(n.td,{children:["Bump the version and regenerate all envelopes per ",(0,i.jsx)(n.a,{href:"/Idle-Game-Engine/runtime-react-worker-bridge-design#62-detailed-design",children:"\xa76.2"}),"; confirm UI and worker bundles rebuilt."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Commands appear to hang during session restore"}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"restoreSession"})," is pending and the bridge queues messages"]}),(0,i.jsxs)(n.td,{children:["Await ",(0,i.jsx)(n.code,{children:"bridge.restoreSession()"})," before issuing commands or ensure the worker emits ",(0,i.jsx)(n.code,{children:"SESSION_RESTORED"}),"."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Runtime executes command out of order"}),(0,i.jsx)(n.td,{children:"Command priority or replay guard misconfigured"}),(0,i.jsxs)(n.td,{children:["Verify ",(0,i.jsx)(n.code,{children:"source"})," and ",(0,i.jsx)(n.code,{children:"CommandPriority"})," mapping, and expand tests in ",(0,i.jsx)(n.code,{children:"runtime.worker.test.ts"})," to cover the new path."]})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Submit the change for review by the Presentation Shell lead, referencing this tutorial and the design doc in your PR summary."}),"\n",(0,i.jsx)(n.li,{children:"Record any follow-up work (additional diagnostics, UX polish) in new issues linked from the tutorial so future contributors can iterate."}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}}}]);