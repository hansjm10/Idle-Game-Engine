"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[815],{1506:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>d,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"runtime-react-worker-bridge-design","title":"Implement Runtime->React Worker Bridge","description":"Issue: #16 (implementation) / #251 (design doc) - Presentation Shell Workstream","source":"@site/../../docs/runtime-react-worker-bridge-design.md","sourceDirName":".","slug":"/runtime-react-worker-bridge-design","permalink":"/Idle-Game-Engine/runtime-react-worker-bridge-design","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/runtime-react-worker-bridge-design.md","tags":[],"version":"current","frontMatter":{}}');var r=s(5270),t=s(7678);const d={},l="Implement Runtime->React Worker Bridge",o={},c=[{value:"Document Control",id:"document-control",level:2},{value:"1. Summary",id:"1-summary",level:2},{value:"2. Context &amp; Problem Statement",id:"2-context--problem-statement",level:2},{value:"3. Goals &amp; Non-Goals",id:"3-goals--non-goals",level:2},{value:"4. Stakeholders, Agents &amp; Impacted Surfaces",id:"4-stakeholders-agents--impacted-surfaces",level:2},{value:"5. Current State",id:"5-current-state",level:2},{value:"6. Proposed Solution",id:"6-proposed-solution",level:2},{value:"6.1 Architecture Overview",id:"61-architecture-overview",level:3},{value:"6.2 Detailed Design",id:"62-detailed-design",level:3},{value:"6.3 Operational Considerations",id:"63-operational-considerations",level:3},{value:"7. Work Breakdown &amp; Delivery Plan",id:"7-work-breakdown--delivery-plan",level:2},{value:"7.1 Issue Map",id:"71-issue-map",level:3},{value:"7.2 Milestones",id:"72-milestones",level:3},{value:"7.3 Coordination Notes",id:"73-coordination-notes",level:3},{value:"8. Agent Guidance &amp; Guardrails",id:"8-agent-guidance--guardrails",level:2},{value:"9. Alternatives Considered",id:"9-alternatives-considered",level:2},{value:"10. Testing &amp; Validation Plan",id:"10-testing--validation-plan",level:2},{value:"11. Risks &amp; Mitigations",id:"11-risks--mitigations",level:2},{value:"12. Rollout Plan",id:"12-rollout-plan",level:2},{value:"13. Decisions Since Draft",id:"13-decisions-since-draft",level:2},{value:"14. Follow-Up Work",id:"14-follow-up-work",level:2},{value:"14.1 Worker\u2194Shell Persistence Handoff (Issue #258)",id:"141-workershell-persistence-handoff-issue-258",level:3},{value:"14.1.1 Troubleshooting &amp; Operations",id:"1411-troubleshooting--operations",level:4},{value:"14.2 Remaining Items",id:"142-remaining-items",level:3},{value:"15. References",id:"15-references",level:2},{value:"Appendix A - Glossary",id:"appendix-a---glossary",level:2},{value:"Appendix B - Change Log",id:"appendix-b---change-log",level:2}];function a(e){const n={a:"a",code:"code",del:"del",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"implement-runtime-react-worker-bridge",children:"Implement Runtime->React Worker Bridge"})}),"\n",(0,r.jsx)(n.p,{children:"Issue: #16 (implementation) / #251 (design doc) - Presentation Shell Workstream"}),"\n",(0,r.jsx)(n.h2,{id:"document-control",children:"Document Control"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Title"}),": Implement runtime->React Worker bridge"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Authors"}),": Idle Engine Design Authoring Agent (AI)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Reviewers"}),": TODO (Presentation Shell Lead)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Status"}),": Approved"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Last Updated"}),": 2025-11-11"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Related Issues"}),": ",(0,r.jsx)(n.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/16",children:"#16"}),", ",(0,r.jsx)(n.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/251",children:"#251"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Operational Runbook"}),": ",(0,r.jsx)(n.a,{href:"/Idle-Game-Engine/runtime-worker-bridge-runbook",children:"Runtime->React Worker Bridge Operational Runbook"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Execution Mode"}),": AI-led"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Schema Package"}),": ",(0,r.jsx)(n.code,{children:"@idle-engine/runtime-bridge-contracts"})]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"1-summary",children:"1. Summary"}),"\n",(0,r.jsx)(n.p,{children:'Responding to the directive "Create a design document for issue #16, use gh to find more about it," this plan formalises how we deliver a resilient Worker-mediated bridge from the deterministic runtime to the React presentation shell. Issue #16 ("Create Worker bridge for runtime -> React") requires hardened message contracts, lifecycle management, and diagnostics propagation so the shell can safely emit player commands and render authoritative state snapshots without compromising the runtime loop. The proposed architecture refines the existing worker prototype, codifies command and telemetry flows (READY/ERROR handshake, diagnostics toggles), and documents the session snapshot protocol to reach production readiness.'}),"\n",(0,r.jsx)(n.h2,{id:"2-context--problem-statement",children:"2. Context & Problem Statement"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Background"}),": The implementation plan highlights the Presentation Shell workstream's dependency on a Worker channel to consume runtime snapshots (",(0,r.jsx)(n.code,{children:"docs/implementation-plan.md:18"}),"). Prototype wiring already instantiates ",(0,r.jsx)(n.code,{children:"IdleEngineRuntime"})," inside a dedicated worker (",(0,r.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.ts:74"}),") and exposes a hook-based bridge for React (",(0,r.jsx)(n.code,{children:"packages/shell-web/src/modules/worker-bridge.ts:181"}),"). Architecture notes confirm the importance of keeping command stamping consistent with the fixed-step lifecycle (",(0,r.jsx)(n.code,{children:"docs/runtime-step-lifecycle.md:19"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Problem"}),": Issue #16 lacks an approved design describing the Worker bridge contract, error handling, diagnostics handshake, and React integration boundaries. The current bridge prototype (",(0,r.jsx)(n.code,{children:"packages/shell-web/src/modules/worker-bridge.ts:63"}),") is functional but undocumented, omits replay protection, and hardcodes payload shapes that downstream agents cannot rely on. Without a sanctioned design, AI agents risk diverging implementations and UI regressions."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Forces"}),": The bridge must preserve runtime determinism, remain Vite/React compatible, expose diagnostics for performance tuning, and sustain long-lived sessions without memory leaks. Presentation increments depend on a stable API, while runtime owners require guardrails that prevent untrusted UI code from mutating engine state directly."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"3-goals--non-goals",children:"3. Goals & Non-Goals"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Goals"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Publish an authoritative Worker message contract for issue #16 covering command, state, diagnostics, session snapshot, and lifecycle envelopes."}),"\n",(0,r.jsxs)(n.li,{children:["Establish a canonical schema package: ",(0,r.jsx)(n.code,{children:"@idle-engine/runtime-bridge-contracts"})," for all worker bridge message types and constants (e.g., ",(0,r.jsx)(n.code,{children:"WORKER_MESSAGE_SCHEMA_VERSION"}),")."]}),"\n",(0,r.jsx)(n.li,{children:"Ship a reusable React-facing bridge that enforces disposal, subscription control, and monotonic timestamps."}),"\n",(0,r.jsx)(n.li,{children:"Provide diagnostics opt-in wiring so shell agents can enable the runtime timeline without polluting baseline runs."}),"\n",(0,r.jsx)(n.li,{children:"Document operational runbooks for bundling, error surfacing, snapshot restore, and testing under Vite-driven dev/CI workflows."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Non-Goals"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Redesigning the IdleEngineRuntime scheduler or command queue internals (covered elsewhere)."}),"\n",(0,r.jsx)(n.li,{children:"Delivering final presentation components beyond the thin shell required to validate the bridge."}),"\n",(0,r.jsx)(n.li,{children:"Integrating social-service or content-pack APIs; those will follow once the bridge is proven."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"4-stakeholders-agents--impacted-surfaces",children:"4. Stakeholders, Agents & Impacted Surfaces"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Primary Stakeholders"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Presentation Shell workstream coordinating issue #16 delivery."}),"\n",(0,r.jsx)(n.li,{children:"Runtime Core maintainers ensuring Worker boundary safety."}),"\n",(0,r.jsx)(n.li,{children:"Developer Experience owners who uphold build/test ergonomics."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Agent Roles"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Runtime Worker Implementation Agent: owns worker harness, message schemas, and diagnostics delta logic."}),"\n",(0,r.jsx)(n.li,{children:"React Bridge Integration Agent: owns TypeScript bridge, React hooks, and UI consumption patterns."}),"\n",(0,r.jsx)(n.li,{children:"Quality & Diagnostics Agent: owns test coverage, telemetry assertions, and lint/test automation updates."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Affected Packages/Services"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.ts"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"packages/shell-web/src/modules/worker-bridge.ts"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"packages/core/src/index.ts"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"packages/shell-web/src/modules/App.tsx"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Compatibility Considerations"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Maintain backward compatibility for command queue priorities and step stamping defined in ",(0,r.jsx)(n.code,{children:"IdleEngineRuntime"})," (",(0,r.jsx)(n.code,{children:"packages/core/src/index.ts:82"}),"). Honor ",(0,r.jsx)(n.code,{children:"WORKER_MESSAGE_SCHEMA_VERSION"})," negotiation."]}),"\n",(0,r.jsx)(n.li,{children:"Ensure Worker bundling remains ES module compliant for Vite and future React upgrades."}),"\n",(0,r.jsx)(n.li,{children:"Guard against API changes that could invalidate diagnostics consumers or content packs waiting on snapshot schemas."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"5-current-state",children:"5. Current State"}),"\n",(0,r.jsxs)(n.p,{children:["Issue #16 currently relies on a minimal Worker harness that exposes state snapshots and diagnostics updates but lacks formal documentation. The worker bootstrap constructs a runtime, handles messages, and emits state deltas (",(0,r.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.ts:74"}),"). The React hook lazily instantiates ",(0,r.jsx)(n.code,{children:"WorkerBridgeImpl"}),", subscribes to worker messages, and disposes on unmount (",(0,r.jsx)(n.code,{children:"packages/shell-web/src/modules/worker-bridge.ts:181"}),"). The shell's ",(0,r.jsx)(n.code,{children:"App"})," component consumes this hook to push commands and render simple diagnostics (",(0,r.jsx)(n.code,{children:"packages/shell-web/src/modules/App.tsx:14"}),"). Architecture docs confirm alignment with the runtime lifecycle but do not specify failure handling or contract versioning (",(0,r.jsx)(n.code,{children:"docs/runtime-step-lifecycle.md:19"}),"). Tests cover core bridging scenarios, including gating diagnostics updates behind a subscription handshake (",(0,r.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.test.ts:186"}),"), yet they do not address reconnection resilience or malformed message rejection."]}),"\n",(0,r.jsx)(n.h2,{id:"6-proposed-solution",children:"6. Proposed Solution"}),"\n",(0,r.jsx)(n.h3,{id:"61-architecture-overview",children:"6.1 Architecture Overview"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Narrative"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Dedicated Worker hosts ",(0,r.jsx)(n.code,{children:"IdleEngineRuntime"})," and orchestrates command queue execution, pushing deterministic state snapshots to the UI. The React bridge encapsulates Worker lifecycle, exposes subscription hooks, and ensures commands cross the thread boundary with consistent metadata."]}),"\n",(0,r.jsx)(n.li,{children:"Message envelopes are versioned and validated before entering the runtime queue, safeguarding the runtime from malformed UI input. Diagnostics remain opt-in to avoid unnecessary load."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Diagram"})}),"\n",(0,r.jsxs)(n.p,{children:["Runtime worker \u2194 React bridge message flow covering READY, COMMAND, STATE_UPDATE, and DIAGNOSTICS envelopes. Source: ",(0,r.jsx)(n.code,{children:"docs/assets/diagrams/runtime-react-worker-bridge.mmd"})," (keep in sync)."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-mermaid",children:"%% Source of truth also stored at docs/assets/diagrams/runtime-react-worker-bridge.mmd\nsequenceDiagram\n  autonumber\n  participant React as React Shell\n  participant Bridge as WorkerBridge\n  participant Worker as Runtime Worker\n  participant Runtime as IdleEngineRuntime\n\n  React->>Bridge: instantiate WorkerBridge & awaitReady()\n  Bridge->>Worker: create worker(module)\n  Worker--\x3e>Bridge: READY {handshakeId}\n  Bridge--\x3e>React: resolve awaitReady()\n\n  React->>Bridge: sendCommand(type, payload)\n  Note right of Bridge: Wraps payload with requestId,<br/>source, issuedAt (performance.now())\n  Bridge->>Worker: COMMAND {schemaVersion, requestId, source, command}\n  Worker->>Runtime: enqueue(command)\n\n  Worker--\x3e>Bridge: STATE_UPDATE {state snapshot}\n  Bridge--\x3e>React: onStateUpdate(state)\n\n  React->>Bridge: enableDiagnostics()\n  Bridge->>Worker: DIAGNOSTICS_SUBSCRIBE\n  Worker->>Runtime: enableDiagnostics()\n  Runtime--\x3e>Worker: diagnostics delta\n  Worker--\x3e>Bridge: DIAGNOSTICS_UPDATE {timeline}\n  Bridge--\x3e>React: onDiagnosticsUpdate(diagnostics)\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"62-detailed-design",children:"6.2 Detailed Design"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Runtime Changes"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Extend ",(0,r.jsx)(n.code,{children:"initializeRuntimeWorker"})," to include an optional ",(0,r.jsx)(n.code,{children:"handshakeId"})," and emit a ",(0,r.jsx)(n.code,{children:"READY"})," message after registering listeners, allowing the React bridge to wait for readiness before sending commands (",(0,r.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.ts:74"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Harden message validation by rejecting commands missing ",(0,r.jsx)(n.code,{children:"type"}),", ",(0,r.jsx)(n.code,{children:"payload"}),", or non-monotonic ",(0,r.jsx)(n.code,{children:"timestamp"}),"; log structured errors to aid diagnostics."]}),"\n",(0,r.jsx)(n.li,{children:"Add replay protection by tracking the last processed UI command timestamp and dropping stale commands."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Data & Schemas"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Formalise Worker message types:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"COMMAND"})," (UI->Worker): ",(0,r.jsx)(n.code,{children:"{type, payload, requestId, source, issuedAt}"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"STATE_UPDATE"})," (Worker->UI): ",(0,r.jsx)(n.code,{children:"{currentStep, events[], backPressure}"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"DIAGNOSTICS_UPDATE"})," (Worker->UI): timeline delta snapshot"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"RESTORE_SESSION"})," (UI->Worker): ",(0,r.jsx)(n.code,{children:"{state?, elapsedMs?, resourceDeltas?}"})," session resume payload"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"SESSION_RESTORED"})," (Worker->UI): acknowledgement that queueing may resume"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"DIAGNOSTICS_SUBSCRIBE"})," / ",(0,r.jsx)(n.code,{children:"DIAGNOSTICS_UNSUBSCRIBE"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"READY"}),", ",(0,r.jsx)(n.code,{children:"ERROR"}),", and ",(0,r.jsx)(n.code,{children:"TERMINATE"})," control messages"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Maintain schema definitions in ",(0,r.jsx)(n.code,{children:"packages/shell-web/src/modules/worker-bridge.ts"})," with TypeScript discriminated unions for agent reuse (",(0,r.jsx)(n.code,{children:"packages/shell-web/src/modules/worker-bridge.ts:55"}),")."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"APIs & Contracts"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Expand ",(0,r.jsx)(n.code,{children:"WorkerBridge"})," interface to expose ",(0,r.jsx)(n.code,{children:"awaitReady()"}),", ",(0,r.jsx)(n.code,{children:"restoreSession()"}),", ",(0,r.jsx)(n.code,{children:"disableDiagnostics()"}),", and ",(0,r.jsx)(n.code,{children:"onError"})," callbacks while keeping existing ",(0,r.jsx)(n.code,{children:"sendCommand"}),", ",(0,r.jsx)(n.code,{children:"onStateUpdate"}),", and diagnostics observers (",(0,r.jsx)(n.code,{children:"packages/shell-web/src/modules/worker-bridge.ts:14"}),")."]}),"\n",(0,r.jsx)(n.li,{children:"Queue outbound traffic while a session restore is pending so UI code can emit user commands without racing the worker handshake."}),"\n",(0,r.jsxs)(n.li,{children:["Provide typed event emitters so React components receive strongly typed snapshots (",(0,r.jsx)(n.code,{children:"RuntimeStateSnapshot"}),") and diagnostics payloads."]}),"\n",(0,r.jsxs)(n.li,{children:["Surface worker errors through the optional ",(0,r.jsx)(n.code,{children:"__IDLE_ENGINE_TELEMETRY__"})," facade so hosts can forward incidents without bundling server-only dependencies."]}),"\n",(0,r.jsxs)(n.li,{children:["Document contract versioning in ",(0,r.jsx)(n.code,{children:"/docs"})," with change log entries referencing issue #16."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Tooling & Automation"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Update Vitest suites to cover handshake, replay protection, diagnostics gating, and disposal semantics (",(0,r.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.test.ts:1"}),")."]}),"\n",(0,r.jsx)(n.li,{children:"Add lint rule exceptions or ESLint configuration updates if Worker globals require adjustments."}),"\n",(0,r.jsxs)(n.li,{children:["Ensure ",(0,r.jsx)(n.code,{children:"pnpm test --filter shell-web"})," becomes the canonical validation command for agents, aligning with doc guidance."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"63-operational-considerations",children:"6.3 Operational Considerations"}),"\n",(0,r.jsxs)(n.p,{children:["Full build, rollout, and troubleshooting procedures live in the ",(0,r.jsx)(n.a,{href:"/Idle-Game-Engine/runtime-worker-bridge-runbook",children:"Runtime->React Worker Bridge Operational Runbook"}),"; keep that guide updated alongside the contract changes described below."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Deployment"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Incorporate Worker bundle into Vite build pipeline, verifying production builds include hashed worker assets. Document ",(0,r.jsx)(n.code,{children:"pnpm build --filter shell-web"})," as the release artifact generator."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Telemetry & Observability"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Expose console warnings when commands are dropped or diagnostics are disabled by policy, guiding agents during debugging."}),"\n",(0,r.jsx)(n.li,{children:"Forward runtime diagnostics deltas downstream without flooding logs; implement throttling if the UI main thread lags."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Security & Compliance"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Restrict Worker context to treat all UI-originating commands as ",(0,r.jsx)(n.code,{children:"CommandPriority.PLAYER"}),", preventing privilege escalation (",(0,r.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.ts:170"}),")."]}),"\n",(0,r.jsx)(n.li,{children:"Ensure no PII crosses the bridge; payloads should remain gameplay data scoped to the local session. Clarify that the Worker runs in-browser only, limiting exposure."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"7-work-breakdown--delivery-plan",children:"7. Work Breakdown & Delivery Plan"}),"\n",(0,r.jsx)(n.h3,{id:"71-issue-map",children:"7.1 Issue Map"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Issue Title"}),(0,r.jsx)(n.th,{children:"Scope Summary"}),(0,r.jsx)(n.th,{children:"Proposed Assignee/Agent"}),(0,r.jsx)(n.th,{children:"Dependencies"}),(0,r.jsx)(n.th,{children:"Acceptance Criteria"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"feat(shell-web): harden runtime worker handshake"}),(0,r.jsx)(n.td,{children:"Implement READY/ERROR control flow, command validation, replay protection"}),(0,r.jsx)(n.td,{children:"Runtime Worker Implementation Agent"}),(0,r.jsx)(n.td,{children:"Design approval (this doc)"}),(0,r.jsx)(n.td,{children:"Vitest coverage proves handshake, queue stamping, replay guard"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"feat(shell-web): expand React worker bridge API"}),(0,r.jsx)(n.td,{children:"Extend bridge with awaitReady, error surface, diagnostics toggles; update hook"}),(0,r.jsx)(n.td,{children:"React Bridge Integration Agent"}),(0,r.jsx)(n.td,{children:"Handshake issue"}),(0,r.jsx)(n.td,{children:"Bridge unit tests updated; App consumes new API without regressions"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"test(shell-web): diagnostics and lifecycle coverage"}),(0,r.jsx)(n.td,{children:"Add tests for diagnostics subscribe/unsubscribe, disposal, throttled logs"}),(0,r.jsx)(n.td,{children:"Quality & Diagnostics Agent"}),(0,r.jsx)(n.td,{children:"React bridge update"}),(0,r.jsx)(n.td,{children:"Tests cover DIAGNOSTICS_SUBSCRIBE and disposal; CI green"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"72-milestones",children:"7.2 Milestones"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Phase 1"}),": Finalise Worker message contract and handshake, including READY/ERROR flow; target completion within three working days of design approval."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Phase 2"}),": Update React bridge and UI integration to consume new contract; target completion two days after Phase 1, contingent on green tests."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Phase 3"}),": Diagnostics and lifecycle hardening, including documentation updates; finalise within two days after Phase 2."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"73-coordination-notes",children:"7.3 Coordination Notes"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Hand-off Package"}),": Provide agents with references to ",(0,r.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.ts:74"}),", ",(0,r.jsx)(n.code,{children:"packages/shell-web/src/modules/worker-bridge.ts:63"}),", and ",(0,r.jsx)(n.code,{children:"docs/runtime-step-lifecycle.md:19"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Communication Cadence"}),": Daily async status ping via project board comments; escalate blockers immediately to Presentation Shell lead."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Escalation Path"}),": Runtime Core maintainers adjudicate disputes about command queue invariants; Dev Experience ensures bundler compatibility."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"8-agent-guidance--guardrails",children:"8. Agent Guidance & Guardrails"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Context Packets"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Load ",(0,r.jsx)(n.code,{children:"docs/runtime-step-lifecycle.md:1"})," and ",(0,r.jsx)(n.code,{children:"docs/implementation-plan.md:18"})," before coding."]}),"\n",(0,r.jsxs)(n.li,{children:["Cache TypeScript typings from ",(0,r.jsx)(n.code,{children:"packages/core"})," to align command structures."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Prompting & Constraints"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Agents must reference issue #16 and this design doc in commit messages."}),"\n",(0,r.jsxs)(n.li,{children:["Follow Conventional Commit syntax; example: ",(0,r.jsx)(n.code,{children:"feat(shell-web): implement worker READY handshake"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Safety Rails"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Do not bypass Worker boundary by importing runtime directly into React components."}),"\n",(0,r.jsxs)(n.li,{children:["Avoid modifying ",(0,r.jsx)(n.code,{children:"packages/core"})," unless explicitly approved; prefer adapter changes in shell-web."]}),"\n",(0,r.jsx)(n.li,{children:"Never disable diagnostics safeguards when writing tests; use provided toggles."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Validation Hooks"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Run ",(0,r.jsx)(n.code,{children:"pnpm lint"})," and ",(0,r.jsx)(n.code,{children:"pnpm test --filter shell-web"})," locally before completion."]}),"\n",(0,r.jsxs)(n.li,{children:["For diagnostics changes, run ",(0,r.jsx)(n.code,{children:'pnpm test --filter "runtime.worker"'})," to target integration tests."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"9-alternatives-considered",children:"9. Alternatives Considered"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Main-thread runtime execution"}),": Rejected because it violates determinism guarantees and blocks UI responsiveness."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Service Worker or SharedWorker"}),": Discarded due to increased complexity and limited browser support relative to dedicated Worker simplicity for issue #16."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"postMessage-based RPC library"}),": Unnecessary; custom discriminated unions give tighter control over payload validation and reduce bundle size."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"10-testing--validation-plan",children:"10. Testing & Validation Plan"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Unit / Integration"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Extend Vitest suites for worker harness and bridge to cover handshake, replay guard, diagnostics enablement, and disposal."}),"\n",(0,r.jsx)(n.li,{children:"Mock Worker context to assert messages emitted on error and termination."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Performance"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Benchmark tick loop under simulated high-frequency commands to confirm no regression beyond current ",(0,r.jsx)(n.code,{children:"RAF_INTERVAL_MS"})," budget."]}),"\n",(0,r.jsx)(n.li,{children:"Validate diagnostics throttling to ensure UI thread remains responsive during stress tests."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Tooling / A11y"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["After bridge integration, run ",(0,r.jsx)(n.code,{children:"pnpm test:a11y"})," if UI surfaces change."]}),"\n",(0,r.jsx)(n.li,{children:"Confirm Vite build outputs include worker bundle without warnings."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"11-risks--mitigations",children:"11. Risks & Mitigations"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Bundler compatibility"}),": Vite upgrades or React 19 changes could destabilise Worker imports; mitigation is to pin versions and run smoke builds per milestone."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Command drift"}),": If runtime command contracts evolve, UI could break; mitigate by centralising TypeScript types and adding compile-time checks."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Diagnostics overload"}),": High-frequency diagnostics may overwhelm UI; enforce throttling and optional subscription."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Resource leaks"}),": Failure to dispose Worker on navigation could leak memory; ensure ",(0,r.jsx)(n.code,{children:"useWorkerBridge"})," always calls ",(0,r.jsx)(n.code,{children:"dispose()"})," and add regression tests."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"12-rollout-plan",children:"12. Rollout Plan"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Milestones"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Milestone 1: Merge worker handshake updates behind feature guard."}),"\n",(0,r.jsx)(n.li,{children:"Milestone 2: Enable new React bridge in dev builds; monitor for regressions."}),"\n",(0,r.jsx)(n.li,{children:"Milestone 3: Promote to production build once tests and manual smoke pass."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Migration Strategy"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Introduce the ",(0,r.jsx)(n.code,{children:"VITE_ENABLE_WORKER_BRIDGE"})," (",(0,r.jsx)(n.code,{children:"ENABLE_WORKER_BRIDGE"}),") flag so shells can fall back to the inline legacy bridge until confidence is established; leave it disabled by default and retire it after Phase 3 sign-off."]}),"\n",(0,r.jsx)(n.li,{children:"Provide migration notes for agents touching UI components."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Communication"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Announce bridge availability in weekly status report; include testing commands."}),"\n",(0,r.jsx)(n.li,{children:"Update onboarding documentation to reference new bridge once rollout completes."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"13-decisions-since-draft",children:"13. Decisions Since Draft"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Telemetry routing"})," ",(0,r.jsx)(n.em,{children:"(Owner: Presentation Shell analytics lead)"})," \u2014 Worker-side errors publish through the shell analytics pipeline via the global ",(0,r.jsx)(n.code,{children:"__IDLE_ENGINE_TELEMETRY__"})," facade (",(0,r.jsx)(n.code,{children:"packages/shell-web/src/modules/worker-bridge.ts:126"}),"). Implementation completed in ",(0,r.jsx)(n.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/267",children:"#267"})," installs the browser shell analytics facade (",(0,r.jsx)(n.code,{children:"packages/shell-web/src/modules/shell-analytics.ts"}),"), wiring worker bridge telemetry into dashboards and exposing the ",(0,r.jsx)(n.code,{children:"VITE_SHELL_ANALYTICS_ENDPOINT"})," fallback for hosts that rely on sendBeacon/fetch delivery."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Content pack messaging"})," ",(0,r.jsx)(n.em,{children:"(Owner: Content Systems integration lead)"})," \u2014 Presentation shells continue to consume pack-provided events exclusively through the ",(0,r.jsx)(n.code,{children:"STATE_UPDATE.state.events"})," array; no additional message envelopes are required. We verified this against existing pack samples and worker emission logic, so downstream agents can rely on the current contract without schema changes."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Resumable session handshake"})," ",(0,r.jsx)(n.em,{children:"(Owner: Runtime Core liaison)"})," \u2014 The ",(0,r.jsx)(n.code,{children:"RESTORE_SESSION"})," / ",(0,r.jsx)(n.code,{children:"SESSION_RESTORED"})," sequence and ",(0,r.jsx)(n.code,{children:"WorkerBridge.restoreSession()"})," helper are considered ready for rollout. Coordination with the persistence work in ",(0,r.jsx)(n.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/258",children:"#258"})," will cover storage handoff requirements before enabling offline progression in production."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"14-follow-up-work",children:"14. Follow-Up Work"}),"\n",(0,r.jsx)(n.h3,{id:"141-workershell-persistence-handoff-issue-258",children:"14.1 Worker\u2194Shell Persistence Handoff (Issue #258)"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Goals"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Persist authoritative runtime state so the shell can restore sessions without violating determinism or the existing ",(0,r.jsx)(n.code,{children:"RESTORE_SESSION"})," contract."]}),"\n",(0,r.jsx)(n.li,{children:"Support offline catch-up by capturing wall-clock metadata alongside the serialized state."}),"\n",(0,r.jsx)(n.li,{children:"Keep persistence infrastructure reusable across shells (web, native wrappers) and tolerant of future content pack migrations."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Constraints"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["The worker must remain deterministic and cannot touch DOM-only APIs such as ",(0,r.jsx)(n.code,{children:"localStorage"}),"; all storage I/O runs on the shell side."]}),"\n",(0,r.jsxs)(n.li,{children:["Existing validation in ",(0,r.jsx)(n.code,{children:"runtime.worker.ts:200"})," expects ",(0,r.jsx)(n.code,{children:"SerializedResourceState"})," payloads that pass ",(0,r.jsx)(n.code,{children:"reconcileSaveAgainstDefinitions"}),"; storage must never mutate those structures."]}),"\n",(0,r.jsx)(n.li,{children:"Autosave cadence cannot interfere with the simulation tick loop\u2014snapshot requests must be explicit and queued through the bridge."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Storage Evaluation"})}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Option"}),(0,r.jsx)(n.th,{children:"Pros"}),(0,r.jsx)(n.th,{children:"Cons"}),(0,r.jsx)(n.th,{children:"Notes"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"IndexedDB (Recommended)"}),(0,r.jsx)(n.td,{children:"Available in dedicated workers and windows, async, structured-clone friendly, ~50\u202fMB quota in most browsers"}),(0,r.jsx)(n.td,{children:"Needs promise-based wrapper, requires schema/version bookkeeping"}),(0,r.jsxs)(n.td,{children:["Use a single ",(0,r.jsx)(n.code,{children:"idle-engine.sessions"})," database with version upgrades handled by the shell"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Cache API"}),(0,r.jsx)(n.td,{children:"Streams suited to HTTP responses, versioned caches"}),(0,r.jsx)(n.td,{children:"Cannot store arbitrary structured data without manual serialization, unclear worker support for our use case"}),(0,r.jsx)(n.td,{children:"Rejected; better for asset caching than game state"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"localStorage"}),(0,r.jsx)(n.td,{children:"Simple API"}),(0,r.jsx)(n.td,{children:"Not accessible inside workers, synchronous (janks UI), ~5\u202fMB quota"}),(0,r.jsx)(n.td,{children:"Rejected; fails worker requirement and risks deadlocks"})]})]})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Chosen Strategy: Shell-managed IndexedDB"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Introduce a ",(0,r.jsx)(n.code,{children:"SessionPersistenceAdapter"})," in the React shell that owns all IndexedDB access. The worker exposes a new ",(0,r.jsx)(n.code,{children:"SESSION_SNAPSHOT"})," outbound message and ",(0,r.jsx)(n.code,{children:"REQUEST_SESSION_SNAPSHOT"})," inbound command so snapshot requests travel over the existing bridge."]}),"\n",(0,r.jsxs)(n.li,{children:["Persisted entries store raw ",(0,r.jsx)(n.code,{children:"SerializedResourceState"}),", offline metadata, and runtime/content digests. The worker never performs I/O; it only marshals deterministic data."]}),"\n",(0,r.jsxs)(n.li,{children:["Provide a thin abstraction (",(0,r.jsx)(n.code,{children:"PersistenceDriver"}),") so native shells can swap in filesystem-backed implementations while reusing message flow and schema."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Message Flow"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Save / Autosave"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Shell calls ",(0,r.jsx)(n.code,{children:"WorkerBridge.requestSessionSnapshot(reason)"})," (new API) when autosave timers, user actions, or shutdown events fire. The bridge enqueues a ",(0,r.jsx)(n.code,{children:"REQUEST_SESSION_SNAPSHOT"})," message after ",(0,r.jsx)(n.code,{children:"awaitReady()"})," and outside ",(0,r.jsx)(n.code,{children:"restoreSession"})," windows."]}),"\n",(0,r.jsxs)(n.li,{children:["Worker captures deterministic data: ",(0,r.jsx)(n.code,{children:"SerializedResourceState"})," via ",(0,r.jsx)(n.code,{children:"resourceState.exportForSave()"}),", current tick step, and monotonic clock reference. It responds with ",(0,r.jsx)(n.code,{children:"SESSION_SNAPSHOT { requestId, capturedAt, state, step, monotonicNow }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Shell adapter normalises metadata (e.g., converts ",(0,r.jsx)(n.code,{children:"capturedAt"})," to UTC, clamps offline caps) and writes the entry to the ",(0,r.jsx)(n.code,{children:"sessions"})," object store within a single IndexedDB transaction. On error it surfaces telemetry through the existing ",(0,r.jsx)(n.code,{children:"WorkerBridge"})," error channel."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Restore"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Shell reads the latest slot at startup (or when the user selects a save) and validates it against current content definitions using ",(0,r.jsx)(n.code,{children:"reconcileSaveAgainstDefinitions"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Shell computes offline elapsed time as ",(0,r.jsx)(n.code,{children:"min(now - capturedAt, OFFLINE_CAP_MS)"})," and derives optional ",(0,r.jsx)(n.code,{children:"resourceDeltas"})," if migrations supply them."]}),"\n",(0,r.jsxs)(n.li,{children:["Shell calls ",(0,r.jsx)(n.code,{children:"WorkerBridge.restoreSession({ state, elapsedMs, resourceDeltas })"}),". The worker follows the existing restore path, emitting either ",(0,r.jsx)(n.code,{children:"SESSION_RESTORED"})," or ",(0,r.jsx)(n.code,{children:"ERROR { code: 'RESTORE_FAILED' }"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"On success the shell resumes normal command flow; on failure it records telemetry, surfaces UI prompts, and may retry after running migrations."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Stored Payload (v1)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"schemaVersion"}),": number (start at ",(0,r.jsx)(n.code,{children:"1"})," to decouple from ",(0,r.jsx)(n.code,{children:"WORKER_MESSAGE_SCHEMA_VERSION"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"slotId"}),": string (",(0,r.jsx)(n.code,{children:'"default"'})," initially; enables future multi-slot UI)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"capturedAt"}),": ISO timestamp."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"workerStep"}),": number (runtime ",(0,r.jsx)(n.code,{children:"currentStep"})," for diagnostics)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"monotonicMs"}),": number captured from worker to help derive elapsed time safely."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"state"}),": ",(0,r.jsx)(n.code,{children:"SerializedResourceState"})," (immutable snapshot)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"runtimeVersion"}),": semver string of ",(0,r.jsx)(n.code,{children:"@idle-engine/core"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"contentDigest"}),": ",(0,r.jsx)(n.code,{children:"ResourceDefinitionDigest"})," for compatibility checks."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"flags"}),": ",(0,r.jsx)(n.code,{children:"{ pendingMigration?: boolean; abortedRestore?: boolean }"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Migration Considerations"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Content packs publish digests; the adapter compares stored ",(0,r.jsx)(n.code,{children:"contentDigest"})," against the live pack before restore. When digests diverge but a pack-supplied migration exists, the adapter runs it prior to calling ",(0,r.jsx)(n.code,{children:"restoreSession"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Schema upgrades use IndexedDB version migrations. Each bump records a deterministic transform function so older saves can be rewritten in place without loading them into the worker."}),"\n",(0,r.jsxs)(n.li,{children:["Record ",(0,r.jsx)(n.code,{children:"runtimeVersion"})," and ",(0,r.jsx)(n.code,{children:"persistenceSchemaVersion"})," to gate restores when the runtime introduces breaking changes. Future workers can advertise supported versions via ",(0,r.jsx)(n.code,{children:"READY { supportedPersistence }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["For detailed guidance on authoring migrations, see ",(0,r.jsx)(n.a,{href:"/Idle-Game-Engine/persistence-migration-guide",children:"Persistence Migration Guide"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Risks & Mitigations"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.em,{children:"Quota exhaustion"}),": add size guards (e.g., trim history to ",(0,r.jsx)(n.code,{children:"MAX_SNAPSHOTS_PER_SLOT"}),") and surface telemetry when writes fail. Provide user-facing guidance to clear space."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.em,{children:"Cross-tab conflicts"}),": namespace keys by ",(0,r.jsx)(n.code,{children:"profileId"})," and use IndexedDB transactions with ",(0,r.jsx)(n.code,{children:"versionchange"})," listeners to detect concurrent schema upgrades. Future enhancement: advisory locking via BroadcastChannel."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.em,{children:"Snapshot cost"}),": snapshot export is synchronous in the worker; autosave cadence must respect frame budgets. Default schedule is every 60\u202fs or on significant events; shells throttle additional requests during high back-pressure."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.em,{children:"Data corruption"}),": persist a checksum (e.g., SHA-256 over the serialized payload) and verify before restore; fallback to previous snapshot when verification fails."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Testing & Telemetry"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Add Vitest suites with mocked ",(0,r.jsx)(n.code,{children:"IDBFactory"})," to cover happy-path save/restore, schema upgrades, and corruption fallbacks."]}),"\n",(0,r.jsx)(n.li,{children:"Integration tests should spin up the worker harness, request a snapshot, round-trip through an in-memory IndexedDB polyfill, and assert the worker accepts the restored session."}),"\n",(0,r.jsxs)(n.li,{children:["Extend telemetry to record ",(0,r.jsx)(n.code,{children:"PersistenceSaveFailed"}),", ",(0,r.jsx)(n.code,{children:"PersistenceRestoreFailed"}),", and ",(0,r.jsx)(n.code,{children:"PersistenceMigrationApplied"})," events routed through ",(0,r.jsx)(n.code,{children:"__IDLE_ENGINE_TELEMETRY__"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Follow-Up Tasks"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Extend ",(0,r.jsx)(n.code,{children:"@idle-engine/runtime-bridge-contracts"})," with ",(0,r.jsx)(n.code,{children:"REQUEST_SESSION_SNAPSHOT"})," / ",(0,r.jsx)(n.code,{children:"SESSION_SNAPSHOT"})," message definitions and update runtime.worker harness."]}),"\n",(0,r.jsxs)(n.li,{children:["Implement ",(0,r.jsx)(n.code,{children:"SessionPersistenceAdapter"})," and autosave controller inside ",(0,r.jsx)(n.code,{children:"packages/shell-web"}),", including IndexedDB schema management (",(0,r.jsx)(n.code,{children:"sessions"})," store keyed by slot/profile)."]}),"\n",(0,r.jsx)(n.li,{children:"Ship shell UI affordances for manual save/load, error reporting, and migration prompts (flagged behind dev toggle until persistence stabilises)."}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.del,{children:"Document migration authoring guidelines for content pack maintainers alongside updated CLI scaffolding."})," ",(0,r.jsx)(n.strong,{children:"Completed"}),": See ",(0,r.jsx)(n.a,{href:"/Idle-Game-Engine/persistence-migration-guide",children:"Persistence Migration Guide"})," (Issue ",(0,r.jsx)(n.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/273",children:"#273"}),")."]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"1411-troubleshooting--operations",children:"14.1.1 Troubleshooting & Operations"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Resetting saves (Web):"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Open DevTools \u2192 Application \u2192 IndexedDB."}),"\n",(0,r.jsxs)(n.li,{children:["Expand ",(0,r.jsx)(n.code,{children:"idle-engine.sessions"})," \u2192 ",(0,r.jsx)(n.code,{children:"sessions"})," and delete records, or delete the entire database."]}),"\n",(0,r.jsxs)(n.li,{children:["The shell UI also exposes \u201cClear Data\u201d in the Persistence panel which calls ",(0,r.jsx)(n.code,{children:"SessionPersistenceAdapter.deleteSlot(...)"})," for the active slot."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Inspecting IndexedDB (Web):"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Keys are ",(0,r.jsx)(n.code,{children:"{slotId}:{timestamp}"}),". Values include ",(0,r.jsx)(n.code,{children:"schemaVersion"}),", ",(0,r.jsx)(n.code,{children:"capturedAt"}),", ",(0,r.jsx)(n.code,{children:"workerStep"}),", ",(0,r.jsx)(n.code,{children:"contentDigest"}),", and a checksum."]}),"\n",(0,r.jsx)(n.li,{children:"Corrupted snapshots (checksum mismatch) are skipped automatically; the adapter falls back to the next newest snapshot and emits telemetry."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Common errors and remedies:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"DB_OPEN_FAILED"}),": IndexedDB unavailable/blocked. Avoid private mode and ensure storage isn\u2019t disabled."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"DB_UPGRADE_BLOCKED"}),": Another tab holds the DB during upgrade. Close other tabs or refresh."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"SNAPSHOT_FAILED"}),": Worker export failed; snapshot requests are blocked during restoration. Retry after ",(0,r.jsx)(n.code,{children:"SESSION_RESTORED"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"SNAPSHOT_VALIDATION_FAILED"}),": All snapshots failed checksum verification. Delete the DB and start fresh."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"RESTORE_FAILED"}),": Worker rejected restore payload. Check ",(0,r.jsx)(n.code,{children:"flags.pendingMigration"}),", digests, and migration availability."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"CI determinism:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Use ",(0,r.jsx)(n.code,{children:"fake-indexeddb"})," to stub IndexedDB in Vitest. See ",(0,r.jsx)(n.code,{children:"packages/shell-web/src/modules/session-persistence-integration.test.ts"})," for worker \u2194 bridge \u2194 persistence coverage."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Extending for native shells:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Swap ",(0,r.jsx)(n.code,{children:"SessionPersistenceAdapter"})," with a platform adapter (filesystem/SQLite/MMKV) that preserves the ",(0,r.jsx)(n.code,{children:"StoredSessionSnapshot"})," contract and checksum semantics, then reuse the same wiring in the shell integration."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Open Questions"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Do we need encryption or obfuscation for competitive modes? (Out of scope for v1, document in security backlog.)"}),"\n",(0,r.jsx)(n.li,{children:"Should command replay logs be persisted alongside resource snapshots for richer debugging? (Candidate for follow-up issue once save slots land.)"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"142-remaining-items",children:"14.2 Remaining Items"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Integrate social-service command hooks after bridge stabilises. Owner: Social Services Lead."}),"\n",(0,r.jsx)(n.li,{children:"Produce developer tutorial documenting how to extend the bridge for custom commands. Owner: React Bridge Integration Agent (post-delivery)."}),"\n",(0,r.jsxs)(n.li,{children:["Implement shell analytics sink for worker bridge telemetry routing. Owner: Presentation Shell analytics lead. ",(0,r.jsx)(n.strong,{children:"Status"}),": Completed via ",(0,r.jsx)(n.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/267",children:"#267"}),"; configure hosts with ",(0,r.jsx)(n.code,{children:"VITE_SHELL_ANALYTICS_ENDPOINT"})," (or ",(0,r.jsx)(n.code,{children:"SHELL_ANALYTICS_ENDPOINT"}),") when routing through custom collectors."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"15-references",children:"15. References"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"docs/implementation-plan.md:18"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"docs/runtime-step-lifecycle.md:19"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.ts:74"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"packages/shell-web/src/modules/worker-bridge.ts:63"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"packages/shell-web/src/modules/App.tsx:14"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"packages/core/src/index.ts:82"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"appendix-a---glossary",children:"Appendix A - Glossary"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Worker bridge"}),": The communication layer transporting commands, state, and diagnostics between the IdleEngine runtime Worker and the React shell for issue #16."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Diagnostics timeline"}),": Runtime-produced stream of performance entries sampling slow ticks and system budgets, accessible via the worker bridge."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"appendix-b---change-log",children:"Appendix B - Change Log"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["2025-11-11 (Fixes #379): Promote status to Approved, align spec with live implementation including READY/ERROR handshake and session snapshot protocol, and extract the message schema into ",(0,r.jsx)(n.code,{children:"@idle-engine/runtime-bridge-contracts"}),". Updated Mermaid diagram (",(0,r.jsx)(n.code,{children:"docs/assets/diagrams/runtime-react-worker-bridge.mmd"}),") and linked consumers to the schema package.\n| Date       | Author | Change Summary |\n|------------|--------|----------------|\n| 2025-10-27 | Idle Engine Design Authoring Agent (AI) | Initial draft for issue #16 bridge design |\n| 2025-10-28 | Codex Agent (AI) | Added worker\u2194shell persistence handoff mini-spec (Fixes #258) |"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},7678:(e,n,s)=>{s.d(n,{R:()=>d,x:()=>l});var i=s(9430);const r={},t=i.createContext(r);function d(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);