"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[3274],{964:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"content-dsl-schema-design","title":"Content DSL Schema Design","description":"Issue: #11","source":"@site/../../docs/content-dsl-schema-design.md","sourceDirName":".","slug":"/content-dsl-schema-design","permalink":"/Idle-Game-Engine/content-dsl-schema-design","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/content-dsl-schema-design.md","tags":[],"version":"current","frontMatter":{},"sidebar":"developerSidebar","previous":{"title":"Diagnostic Timeline Design Document","permalink":"/Idle-Game-Engine/diagnostic-timeline-design"},"next":{"title":"Content DSL Usage Guidelines","permalink":"/Idle-Game-Engine/content-dsl-usage-guidelines"}}');var r=i(5270),t=i(7678);const c={},o="Content DSL Schema Design",d={},a=[{value:"1. Overview",id:"1-overview",level:2},{value:"2. Goals",id:"2-goals",level:2},{value:"3. Non-Goals",id:"3-non-goals",level:2},{value:"4. Current State",id:"4-current-state",level:2},{value:"5. Proposed Solution",id:"5-proposed-solution",level:2},{value:"5.1 Package Layout &amp; Ownership",id:"51-package-layout--ownership",level:3},{value:"5.2 Shared Scalar Schemas &amp; Utilities",id:"52-shared-scalar-schemas--utilities",level:3},{value:"5.3 Numeric Formula Schema",id:"53-numeric-formula-schema",level:3},{value:"5.4 Condition Schema",id:"54-condition-schema",level:3},{value:"5.4.1 Condition Evaluation Semantics (Runtime Behavior)",id:"541-condition-evaluation-semantics-runtime-behavior",level:4},{value:"5.5 Metadata Schema",id:"55-metadata-schema",level:3},{value:"5.6 Resource Schema",id:"56-resource-schema",level:3},{value:"5.7 Generator Schema",id:"57-generator-schema",level:3},{value:"5.8 Upgrade Schema",id:"58-upgrade-schema",level:3},{value:"5.9 Metric Schema",id:"59-metric-schema",level:3},{value:"5.10 Achievement Schema",id:"510-achievement-schema",level:3},{value:"5.11 Automation Schema",id:"511-automation-schema",level:3},{value:"5.12 Transform Schema",id:"512-transform-schema",level:3},{value:"5.13 Prestige Layer Schema",id:"513-prestige-layer-schema",level:3},{value:"5.14 Guild Perk Schema",id:"514-guild-perk-schema",level:3},{value:"5.15 Runtime Event Contribution Schema",id:"515-runtime-event-contribution-schema",level:3},{value:"5.16 Content Pack Root Schema",id:"516-content-pack-root-schema",level:3},{value:"5.17 Normalisation &amp; Derived Artifacts",id:"517-normalisation--derived-artifacts",level:3},{value:"5.18 Implementation Plan",id:"518-implementation-plan",level:3},{value:"5.19 Authoring Best Practices",id:"519-authoring-best-practices",level:3},{value:"6. Testing Strategy",id:"6-testing-strategy",level:2},{value:"7. Risks &amp; Mitigations",id:"7-risks--mitigations",level:2},{value:"8. Decisions &amp; Clarifications",id:"8-decisions--clarifications",level:2},{value:"9. Acceptance Criteria",id:"9-acceptance-criteria",level:2},{value:"10. Open Questions &amp; Follow-Ups",id:"10-open-questions--follow-ups",level:2}];function l(e){const n={a:"a",blockquote:"blockquote",br:"br",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",section:"section",strong:"strong",sup:"sup",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"content-dsl-schema-design",children:"Content DSL Schema Design"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Issue:"})," #11",(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.strong,{children:"Workstream:"})," Content Pipeline",(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.strong,{children:"Status:"})," Design",(0,r.jsx)(n.br,{}),"\n",(0,r.jsx)(n.strong,{children:"Last Updated:"})," 2025-10-18"]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["Issue #11 defines the canonical Zod schema contract for Idle Engine content\npacks. The schema guards authoring-time invariants, normalises inputs for the\ncompiler, and aligns with the content expectations outlined in\n",(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"})," \xa76.2."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"1-overview",children:"1. Overview"}),"\n",(0,r.jsx)(n.p,{children:"The Idle Engine content DSL bridges designer-authored data and the deterministic\nruntime. Today, sample packs provide ad-hoc TypeScript interfaces, but the\nmonorepo lacks an enforceable schema. This document specifies the Zod schemas,\nnormalisation rules, and validation flow that future CLI tooling will use before\ncontent is compiled into runtime-ready definitions. The goal is to deliver a\nsingle package that validates metadata, resources, generators, upgrades,\nmetrics, achievements, prestige layers, automations, transforms, runtime event\nextensions, guild perks, and pack dependency metadata while providing strong\ntyping for TypeScript consumers."}),"\n",(0,r.jsx)(n.h2,{id:"2-goals",children:"2. Goals"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Provide a canonical ",(0,r.jsx)(n.code,{children:"@idle-engine/content-schema"})," package exporting Zod\nschemas and inferred TypeScript types for every content DSL module, including\nmetrics, achievements, runtime event definitions, and pack dependency metadata."]}),"\n",(0,r.jsx)(n.li,{children:"Normalise author input (trim strings, apply defaults, sort deterministically)\nso the compiler and runtime receive stable, replayable definitions."}),"\n",(0,r.jsx)(n.li,{children:"Surface referential, balancing, and compatibility errors at authoring time\nwith actionable messages for future CLI integrations."}),"\n",(0,r.jsx)(n.li,{children:"Support localisation-ready text, formula-driven values, and unlock conditions\nwithout constraining downstream compiler optimisations."}),"\n",(0,r.jsx)(n.li,{children:"Keep schema evolution explicit through semantic metadata, enabling future\npacks to opt into new capabilities without breaking prototype-era content."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"3-non-goals",children:"3. Non-Goals"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Implementing the compiler that emits runtime-ready typed arrays, manifests, or\nworker bundles (tracked in a follow-up issue)."}),"\n",(0,r.jsx)(n.li,{children:"Executing or optimising numeric formulas beyond structural validation."}),"\n",(0,r.jsx)(n.li,{children:"Delivering the localisation pipeline, documentation site generation, or\nin-editor authoring experience."}),"\n",(0,r.jsx)(n.li,{children:"Shipping gameplay logic changes in the runtime; this document only constrains\nthe content contract."}),"\n",(0,r.jsx)(n.li,{children:"Rewriting existing sample data; migrations will land once the schema package\nexists."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"4-current-state",children:"4. Current State"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"packages/content-sample/src/index.ts"})," now re-exports the compiler-generated\nsample pack (rehydrated content, digest, summary, indices), maintaining the\nimport-time warning guard without reparsing ",(0,r.jsx)(n.code,{children:"content/pack.json"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["No shared schema package exists. Content authors must rely on informal\nconventions captured in ",(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tools/content-schema-cli"})," is a stub focused on runtime event manifests and\ndoes not validate content pack data."]}),"\n",(0,r.jsx)(n.li,{children:"Tests, lint rules, and CI do not exercise schema validation because the schema\nis missing."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"5-proposed-solution",children:"5. Proposed Solution"}),"\n",(0,r.jsx)(n.h3,{id:"51-package-layout--ownership",children:"5.1 Package Layout & Ownership"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Create ",(0,r.jsx)(n.code,{children:"packages/content-schema"})," exporting common schema primitives, DSL\nmodule schemas, and composite pack schemas. The package remains private until\nthe contract is stabilised."]}),"\n",(0,r.jsx)(n.li,{children:"Structure the package as:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"packages/content-schema/\n  package.json\n  src/\n    index.ts\n    base/\n      ids.ts\n      localization.ts\n      numbers.ts\n      formulas.ts\n      conditions.ts\n    modules/\n      metadata.ts\n      resources.ts\n      generators.ts\n      upgrades.ts\n      metrics.ts\n      achievements.ts\n      automations.ts\n      prestige.ts\n      guild-perks.ts\n      transforms.ts\n      runtime-events.ts\n      dependencies.ts\n    runtime-compat.ts\n    pack.ts\n    errors.ts\n  vitest.config.ts\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"index.ts"})," re-exports the base ",(0,r.jsx)(n.code,{children:"contentPackSchema"}),", the\n",(0,r.jsx)(n.code,{children:"createContentPackValidator"})," factory, a convenience ",(0,r.jsx)(n.code,{children:"parseContentPack"}),"\nhelper that returns ",(0,r.jsx)(n.code,{children:"{ pack, warnings }"}),", ",(0,r.jsx)(n.code,{children:"NormalizedContentPack"}),", and other\ntargeted schemas for focused validation (e.g., ",(0,r.jsx)(n.code,{children:"resourceDefinitionSchema"}),",\n",(0,r.jsx)(n.code,{children:"metricDefinitionSchema"}),", ",(0,r.jsx)(n.code,{children:"achievementDefinitionSchema"}),",\n",(0,r.jsx)(n.code,{children:"runtimeEventContributionSchema"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Downstream tooling (",(0,r.jsx)(n.code,{children:"packages/content-sample"}),", CLI, compiler) imports only\nfrom this package."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"52-shared-scalar-schemas--utilities",children:"5.2 Shared Scalar Schemas & Utilities"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Define shared primitives with Zod brands for stronger inference:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"contentIdSchema"}),": case-insensitive slug\n",(0,r.jsx)(n.code,{children:"[A-Za-z0-9][A-Za-z0-9-_/.:]{0,63}"})," trimmed and canonicalised to lowercase\nvia ",(0,r.jsx)(n.code,{children:".transform"}),", ensuring consistent hashing while still accepting mixed\nauthor input. The transform rebrands the result with\n",(0,r.jsx)(n.code,{children:".pipe(z.string().brand<'ContentId'>())"})," so TypeScript keeps the nominal\ntype that downstream code relies on, matching the guidance from the Zod\nmaintainers that transforms otherwise shed brands\n(",(0,r.jsx)(n.a,{href:"https://github.com/colinhacks/zod/issues/5183",children:"colinhacks/zod#5183"}),").\nThe grammar deliberately excludes ",(0,r.jsx)(n.code,{children:"@"}),", keeping scoped identifiers reserved\nfor pack slugs."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"packSlugSchema"}),": accepts both unscoped ids (",(0,r.jsx)(n.code,{children:"sample-pack"}),") and npm-style\nscoped ids (",(0,r.jsx)(n.code,{children:"@idle-engine/core"}),", mirrored from ",(0,r.jsx)(n.code,{children:"packages/core/src/events/runtime-event-manifest.generated.ts:57"}),"),\ntrimming whitespace, collapsing duplicate\nseparators, and canonicalising to lowercase before rebranding the output\nwith ",(0,r.jsx)(n.code,{children:"PackId"}),". The schema mirrors npm\u2019s published scope rules\u2014",(0,r.jsx)(n.code,{children:"@scope/name"}),"\nwith URL-safe characters\u2014so content packs can reference workspace packages\nsuch as ",(0,r.jsx)(n.code,{children:"@idle-engine/core"})," without loosening the general-purpose DSL id\ngrammar.",(0,r.jsx)(n.sup,{children:(0,r.jsx)(n.a,{href:"#user-content-fn-npm-scope",id:"user-content-fnref-npm-scope","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"1"})})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"localeCodeSchema"}),": BCP-47 compliant subset matching language tags used in\nthe UI."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"flagIdSchema"})," and ",(0,r.jsx)(n.code,{children:"scriptIdSchema"}),": trimmed, lowercase slugs that reuse the\ncontent id grammar but keep bespoke ",(0,r.jsx)(n.code,{children:"FlagId"}),"/",(0,r.jsx)(n.code,{children:"ScriptId"})," brands. Normalisation\ncollapses duplicate separators and canonicalises casing so allowlists and\nauthored packs compare against the same canonical form."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"systemAutomationTargetIdSchema"}),": alias for curated system toggle ids\n(",(0,r.jsx)(n.code,{children:"offline-catchup"}),", ",(0,r.jsx)(n.code,{children:"research-daemon"}),", etc.) that trims, lowercases, and\nvalidates the identifier against an enum derived from the runtime."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"semverSchema"})," and ",(0,r.jsx)(n.code,{children:"semverRangeSchema"}),": validated via the ",(0,r.jsx)(n.code,{children:"semver"}),"\nlibrary (",(0,r.jsx)(n.code,{children:"semver@7"}),") inside ",(0,r.jsx)(n.code,{children:".superRefine"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"hexColorSchema"}),", ",(0,r.jsx)(n.code,{children:"iconPathSchema"}),", ",(0,r.jsx)(n.code,{children:"urlSchema"})," for UI metadata."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"nonNegativeNumberSchema"}),", ",(0,r.jsx)(n.code,{children:"percentSchema"}),", ",(0,r.jsx)(n.code,{children:"positiveIntSchema"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Localised text uses a strict object:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"const localizedTextSchema = z\n  .object({\n    default: z.string().trim().min(1).max(256),\n    variants: z\n      .record(localeCodeSchema, z.string().trim().min(1).max(256))\n      .default({})\n      .transform((value) => structuredClone(value)),\n  })\n  .strict();\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"localizedTextSchema"})," treats the ",(0,r.jsx)(n.code,{children:"default"})," field as the authoritative copy for\nthe pack's default locale. Localised transforms run inside\n",(0,r.jsx)(n.code,{children:"normalizeContentPack"}),", where ",(0,r.jsx)(n.code,{children:"normalizeLocalizedText(metadata, text, warningSink)"})," backfills a missing\n",(0,r.jsx)(n.code,{children:"variants[metadata.defaultLocale]"})," entry so localisation tools that expect\nkeyed entries remain compatible without forcing authors to duplicate strings.\nWhen authors supply a variant that differs from ",(0,r.jsx)(n.code,{children:"default"}),", the helper records\na warning instead of overwriting the authored copy so intentional locale\ntweaks remain intact. Because Zod reuses the same object instance supplied to\n",(0,r.jsx)(n.code,{children:".default({})"}),", ",(0,r.jsx)(n.code,{children:"normalizeLocalizedText"})," always clones the incoming variants\nmap (using the platform\n",(0,r.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/API/structuredClone",children:(0,r.jsx)(n.code,{children:"structuredClone"})}),"\nAPI or a fallback) before applying mutations so later parses cannot observe\nstale state carried over from previous callers."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"normalizeLocalizedText"})," receives the parsed metadata and supported locale\nlist from the surrounding normalisation step, letting it emit structured\nwarnings for missing translations while keeping the base schema free of\ncross-field knowledge."]}),"\n",(0,r.jsxs)(n.li,{children:["Invalid locale keys or empty variant strings surface as parse failures; we no\nlonger swallow malformed author input via ",(0,r.jsx)(n.code,{children:".catch({})"}),", keeping localisation\nmistakes visible to tooling."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"localizedSummarySchema"})," extends the same structure with a relaxed ceiling\n(",(0,r.jsx)(n.code,{children:"max(512)"}),") for synopsis copy so ",(0,r.jsx)(n.code,{children:"metadata.summary"})," can hold longer blurbs."]}),"\n",(0,r.jsxs)(n.li,{children:["All schemas are ",(0,r.jsx)(n.code,{children:"strict()"})," to reject unknown keys. Optional fields apply\ndefaults through ",(0,r.jsx)(n.code,{children:".default"})," or ",(0,r.jsx)(n.code,{children:".transform"}),", and scalar schemas use ",(0,r.jsx)(n.code,{children:".coerce"}),"\nwhere CLI or JSON-driven inputs frequently arrive as strings so authoring\ntools do not need to hand-roll conversions."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"53-numeric-formula-schema",children:"5.3 Numeric Formula Schema"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Provide ",(0,r.jsx)(n.code,{children:"numericFormulaSchema"}),", a discriminated union that supports both\ncommon progression curves and explicit expressions:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"constant"}),": ",(0,r.jsx)(n.code,{children:"{ kind: 'constant'; value: number }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"linear"}),": ",(0,r.jsx)(n.code,{children:"{ kind: 'linear'; base: number; slope: number }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"exponential"}),": ",(0,r.jsx)(n.code,{children:"{ kind: 'exponential'; base?: number; growth: number; offset?: number }"}),". ",(0,r.jsx)(n.code,{children:"base"})," defaults to ",(0,r.jsx)(n.code,{children:"1"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"polynomial"}),": ",(0,r.jsx)(n.code,{children:"{ kind: 'polynomial'; coefficients: number[] }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"piecewise"}),": ",(0,r.jsx)(n.code,{children:"{ kind: 'piecewise'; pieces: { untilLevel?: number; formula: NumericFormula }[] }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"expression"}),": embeds an AST validated by ",(0,r.jsx)(n.code,{children:"expressionNodeSchema"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Expression nodes form a recursive Zod schema using ",(0,r.jsx)(n.code,{children:"z.lazy"})," with node types:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"literal"}),": constant number."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ref"}),": structured references that avoid stringly typed identifiers\n(",(0,r.jsx)(n.a,{href:"https://blog.codinghorror.com/new-programming-jargon/#7-stringly-typed",children:"Coding Horror \u2013 \u201cStringly Typed\u201d"}),").\nThe schema permits either runtime variables\n",(0,r.jsx)(n.code,{children:"{ kind: 'ref'; target: { type: 'variable'; name: 'level' | 'time' | 'deltaTime' } }"}),"\nor entity handles\n",(0,r.jsx)(n.code,{children:"{ kind: 'ref'; target: { type: 'resource' | 'generator' | 'upgrade' | 'automation' | 'prestigeLayer'; id: ContentId } }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"binary"}),": ",(0,r.jsx)(n.code,{children:"op"})," in ",(0,r.jsx)(n.code,{children:"{ add, sub, mul, div, pow, min, max }"})," with two operands."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"unary"}),": ",(0,r.jsx)(n.code,{children:"op"})," in ",(0,r.jsx)(n.code,{children:"{ abs, ceil, floor, round, sqrt, log10, ln }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"call"}),": named function (e.g., ",(0,r.jsx)(n.code,{children:"clamp"}),", ",(0,r.jsx)(n.code,{children:"lerp"}),") with ",(0,r.jsx)(n.code,{children:"args: Expression[]"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Validation enforces finite numbers, non-empty coefficient arrays, and monotonic\n",(0,r.jsx)(n.code,{children:"piecewise"})," sequences. Piecewise nodes must supply strictly increasing\n",(0,r.jsx)(n.code,{children:"untilLevel"})," values and terminate with a catch-all segment (omitting\n",(0,r.jsx)(n.code,{children:"untilLevel"}),") so evaluation order stays deterministic and never depends on\nengine sort stability. Structured references keep lookups type-aware\u2014validators\ndispatch by ",(0,r.jsx)(n.code,{children:"target.type"})," (",(0,r.jsx)(n.code,{children:"resource"}),", ",(0,r.jsx)(n.code,{children:"generator"}),", etc.) or the runtime\nvariable enum without having to parse dotted strings\u2014so the compiler can flag\nmissing entities early while still permitting ",(0,r.jsx)(n.code,{children:"level"}),"/",(0,r.jsx)(n.code,{children:"time"})," references.\nFunction call nodes are checked against a deterministic allowlist (",(0,r.jsx)(n.code,{children:"clamp"}),",\n",(0,r.jsx)(n.code,{children:"lerp"}),", ",(0,r.jsx)(n.code,{children:"min3"}),", ",(0,r.jsx)(n.code,{children:"max3"}),", ",(0,r.jsx)(n.code,{children:"pow10"}),", ",(0,r.jsx)(n.code,{children:"root"}),", etc.) so unexpected identifiers\nproduce structured errors instead of leaking to runtime."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"54-condition-schema",children:"5.4 Condition Schema"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"conditionSchema"})," uses ",(0,r.jsx)(n.code,{children:"z.discriminatedUnion('kind', \u2026)"})," so every node spells\nout the payload required for validation and graph analysis. The snippet below\nshows the intended TypeScript shape using the types inferred from\n",(0,r.jsx)(n.code,{children:"contentIdSchema"})," and ",(0,r.jsx)(n.code,{children:"numericFormulaSchema"}),":"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"// z imported from 'zod'\ntype ContentId = z.infer<typeof contentIdSchema>;\ntype NumericFormula = z.infer<typeof numericFormulaSchema>;\ntype FlagId = z.infer<typeof flagIdSchema>;\ntype ScriptId = z.infer<typeof scriptIdSchema>;\n\ntype Condition =\n  | { kind: 'always' }\n  | { kind: 'never' }\n  | {\n      kind: 'resourceThreshold';\n      resourceId: ContentId;\n      comparator: 'gte' | 'gt' | 'lte' | 'lt';\n      amount: NumericFormula;\n    }\n  | {\n      kind: 'generatorLevel';\n      generatorId: ContentId;\n      comparator: 'gte' | 'gt' | 'lte' | 'lt';\n      level: NumericFormula;\n    }\n  | {\n      kind: 'upgradeOwned';\n      upgradeId: ContentId;\n      requiredPurchases?: number; // defaults to 1 during normalisation\n    }\n  | {\n      kind: 'prestigeCountThreshold';\n      prestigeLayerId: ContentId;\n      comparator?: 'gte' | 'gt' | 'lte' | 'lt'; // defaults to 'gte' during normalisation\n      count?: number; // positive int, defaults to 1 during normalisation\n    }\n  | { kind: 'prestigeCompleted'; prestigeLayerId: ContentId }\n  | { kind: 'prestigeUnlocked'; prestigeLayerId: ContentId }\n  | { kind: 'flag'; flagId: FlagId }\n  | { kind: 'script'; scriptId: ScriptId }\n  | { kind: 'allOf'; conditions: readonly Condition[] }\n  | { kind: 'anyOf'; conditions: readonly Condition[] }\n  | { kind: 'not'; condition: Condition };\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Conditions are ",(0,r.jsx)(n.code,{children:"strict()"})," objects and reuse ",(0,r.jsx)(n.code,{children:"numericFormulaSchema"})," wherever a\nnumeric comparison is required (",(0,r.jsx)(n.code,{children:"amount"}),", ",(0,r.jsx)(n.code,{children:"level"}),"). Cross-reference checks use\nthe explicit ",(0,r.jsx)(n.code,{children:"resourceId"}),", ",(0,r.jsx)(n.code,{children:"generatorId"}),", ",(0,r.jsx)(n.code,{children:"upgradeId"}),", and\n",(0,r.jsx)(n.code,{children:"prestigeLayerId"})," fields when validating existence and building dependency\ngraphs. Future iterations can introduce additional condition variants (for\nexample, achievement, automation, or transform predicates); until then the\nvalidator limits cross-references to the nodes above. ",(0,r.jsx)(n.code,{children:"flag"})," and ",(0,r.jsx)(n.code,{children:"script"}),"\nnodes are validated against\n",(0,r.jsx)(n.code,{children:"ContentSchemaOptions.allowlists"}),"; the factory accepts arrays or sets for the\ninputs and normalises them (via the same canonical schemas used on conditions)\nto ",(0,r.jsx)(n.code,{children:"ReadonlySet"})," lookups. Entries marked ",(0,r.jsx)(n.code,{children:"required"})," remain hard failures,\nwhile ",(0,r.jsx)(n.code,{children:"soft"})," allow missing lookups with a warning."]}),"\n",(0,r.jsxs)(n.li,{children:["Aggregation nodes (",(0,r.jsx)(n.code,{children:"allOf"}),", ",(0,r.jsx)(n.code,{children:"anyOf"}),") require at least one nested condition via\n",(0,r.jsx)(n.code,{children:".min(1)"})," so unlock logic never defaults to vacuous truth."]}),"\n",(0,r.jsxs)(n.li,{children:["Cycle detection only introduces edges for monotonic predicates (",(0,r.jsx)(n.code,{children:"resource"}),"\nthresholds, generator levels, upgrade ownership, prestige unlocks, flag/script\nallowlists) that participate in ",(0,r.jsx)(n.code,{children:"allOf"})," and other positive contexts. Negated\npredicates (",(0,r.jsx)(n.code,{children:"not"}),") and disjunction branches (",(0,r.jsx)(n.code,{children:"anyOf"}),") still undergo existence\nchecks, but they do not register graph edges; instead they are captured as\nadvisory constraints so authors can express absence-based gating without\ncreating non-monotonic cycles that would otherwise surface as false positives\nduring validation.",(0,r.jsx)(n.sup,{children:(0,r.jsx)(n.a,{href:"#user-content-fn-non-monotonic",id:"user-content-fnref-non-monotonic","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"2"})})]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"541-condition-evaluation-semantics-runtime-behavior",children:"5.4.1 Condition Evaluation Semantics (Runtime Behavior)"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Note"}),": This subsection documents the ",(0,r.jsx)(n.strong,{children:"existing runtime implementation"})," of condition evaluation in ",(0,r.jsx)(n.code,{children:"packages/core/src/condition-evaluator.ts"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Evaluation Context"}),":"]}),"\n",(0,r.jsxs)(n.p,{children:["Conditions are evaluated against live game state via a ",(0,r.jsx)(n.code,{children:"ConditionContext"})," interface that provides:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"getResourceAmount(resourceId: string): number"})," - Current resource amount"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"getGeneratorLevel(generatorId: string): number"})," - Generator owned count"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"getUpgradePurchases(upgradeId: string): number"})," - Upgrade purchase count"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"hasPrestigeLayerUnlocked?(prestigeLayerId: string): boolean"})," - Whether a prestige layer is currently available/unlocked"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"isFlagSet?(flagId: string): boolean"})," - Feature flag lookup"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"evaluateScriptCondition?(scriptId: string): boolean"})," - Script-driven condition evaluation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"onError?: (error: Error) => void"})," - Optional error callback for telemetry"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Static Threshold Evaluation"}),":"]}),"\n",(0,r.jsxs)(n.p,{children:["Unlock conditions (used for ",(0,r.jsx)(n.code,{children:"baseUnlock"})," and ",(0,r.jsx)(n.code,{children:"visibilityCondition"})," on generators/upgrades) use ",(0,r.jsx)(n.strong,{children:"static thresholds"})," that do not scale with progression. All numeric formulas in unlock conditions are evaluated with ",(0,r.jsx)(n.code,{children:"level: 0"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const amount = evaluateNumericFormula(condition.amount, {\n  variables: { level: 0 }  // STATIC_THRESHOLD_LEVEL constant\n});\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This differs from ",(0,r.jsx)(n.strong,{children:"dynamic cost curves"})," which evaluate with ",(0,r.jsx)(n.code,{children:"level: purchaseIndex"}),' to scale costs as players buy more units. The distinction is intentional: unlock thresholds are constant gates (e.g., "unlock when you have 100 energy"), while costs increase with purchases (e.g., "10th generator costs 1000 energy").']}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Evaluation Rules by Condition Type"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"always"})}),": Returns ",(0,r.jsx)(n.code,{children:"true"})," immediately without evaluating game state"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"never"})}),": Returns ",(0,r.jsx)(n.code,{children:"false"})," (used for content disabled in specific builds)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"resourceThreshold"})}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Retrieves current resource amount via context"}),"\n",(0,r.jsxs)(n.li,{children:["Evaluates ",(0,r.jsx)(n.code,{children:"amount"})," formula with ",(0,r.jsx)(n.code,{children:"level: 0"})]}),"\n",(0,r.jsxs)(n.li,{children:["Compares using specified comparator (",(0,r.jsx)(n.code,{children:"gte | gt | lte | lt"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:["Example: ",(0,r.jsx)(n.code,{children:"{ kind: 'resourceThreshold', resourceId: 'energy', comparator: 'gte', amount: { kind: 'constant', value: 100 } }"})," checks if player has \u2265100 energy"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"generatorLevel"})}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Retrieves generator owned count via context"}),"\n",(0,r.jsxs)(n.li,{children:["Evaluates ",(0,r.jsx)(n.code,{children:"level"})," formula with ",(0,r.jsx)(n.code,{children:"level: 0"})]}),"\n",(0,r.jsx)(n.li,{children:"Compares using specified comparator"}),"\n",(0,r.jsxs)(n.li,{children:["Example: ",(0,r.jsx)(n.code,{children:"{ kind: 'generatorLevel', generatorId: 'reactor', comparator: 'gte', level: { kind: 'constant', value: 5 } }"})," checks if player owns \u22655 reactors"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"upgradeOwned"})}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Retrieves upgrade purchase count via context"}),"\n",(0,r.jsxs)(n.li,{children:["Checks if purchases \u2265 ",(0,r.jsx)(n.code,{children:"requiredPurchases"})," (defaults to 1)"]}),"\n",(0,r.jsxs)(n.li,{children:["Example: ",(0,r.jsx)(n.code,{children:"{ kind: 'upgradeOwned', upgradeId: 'efficiency', requiredPurchases: 3 }"})," checks if upgrade purchased \u22653 times"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"prestigeUnlocked"})}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Uses ",(0,r.jsx)(n.code,{children:"context.hasPrestigeLayerUnlocked(prestigeLayerId)"})]}),"\n",(0,r.jsxs)(n.li,{children:["Semantics: ",(0,r.jsx)(n.strong,{children:"prestige layer is currently available/unlocked"}),', not "player has prestiged at least once"']}),"\n",(0,r.jsxs)(n.li,{children:["Example: ",(0,r.jsx)(n.code,{children:"{ kind: 'prestigeUnlocked', prestigeLayerId: 'sample-pack.ascension-alpha' }"})," checks if the layer is available now"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"prestigeCompleted"})}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:'Shorthand for "has prestiged at least once" on the given layer'}),"\n",(0,r.jsxs)(n.li,{children:["Reads the prestige counter resource using the convention ",(0,r.jsx)(n.code,{children:"{prestigeLayerId}-prestige-count"})," and checks it is \u2265 1"]}),"\n",(0,r.jsxs)(n.li,{children:["Example: ",(0,r.jsx)(n.code,{children:"{ kind: 'prestigeCompleted', prestigeLayerId: 'sample-pack.ascension-alpha' }"})," checks if player has prestiged at least once"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"prestigeCountThreshold"})}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Reads the prestige counter resource using the convention ",(0,r.jsx)(n.code,{children:"{prestigeLayerId}-prestige-count"})]}),"\n",(0,r.jsxs)(n.li,{children:["Compares the current count against ",(0,r.jsx)(n.code,{children:"count"})," (defaults to 1) using ",(0,r.jsx)(n.code,{children:"comparator"})," (defaults to ",(0,r.jsx)(n.code,{children:"gte"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:["Example: ",(0,r.jsx)(n.code,{children:"{ kind: 'prestigeCountThreshold', prestigeLayerId: 'sample-pack.ascension-alpha', comparator: 'gte', count: 5 }"})," checks if player has prestiged at least 5 times"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"flag"})}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Uses ",(0,r.jsx)(n.code,{children:"context.isFlagSet(flagId)"})," when supplied"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"script"})}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Uses ",(0,r.jsx)(n.code,{children:"context.evaluateScriptCondition(scriptId)"})," when supplied"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"allOf"})}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Evaluates all nested conditions recursively"}),"\n",(0,r.jsxs)(n.li,{children:["Returns ",(0,r.jsx)(n.code,{children:"true"})," only if ",(0,r.jsx)(n.strong,{children:"every"})," condition passes (logical AND)"]}),"\n",(0,r.jsx)(n.li,{children:"Short-circuits on first failure"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"anyOf"})}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Evaluates nested conditions recursively"}),"\n",(0,r.jsxs)(n.li,{children:["Returns ",(0,r.jsx)(n.code,{children:"true"})," if ",(0,r.jsx)(n.strong,{children:"any"})," condition passes (logical OR)"]}),"\n",(0,r.jsx)(n.li,{children:"Short-circuits on first success"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"not"})}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Evaluates nested condition recursively"}),"\n",(0,r.jsx)(n.li,{children:"Inverts the result"}),"\n",(0,r.jsxs)(n.li,{children:["Example: ",(0,r.jsx)(n.code,{children:"{ kind: 'not', condition: resourceThreshold }"})," passes if threshold NOT met"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Error Handling"}),":"]}),"\n",(0,r.jsx)(n.p,{children:"Unknown condition kinds or comparators trigger fail-safe behavior:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Development"}),": Calls ",(0,r.jsx)(n.code,{children:"context.onError(error)"})," for test assertions and strict validation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Production"}),": Logs ",(0,r.jsx)(n.code,{children:"console.warn(error.message)"})," and returns ",(0,r.jsx)(n.code,{children:"false"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Rationale"}),": Graceful degradation prevents crashes when content contains unrecognized condition types (e.g., from newer schema versions)"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Persistent Unlock Semantics"}),":"]}),"\n",(0,r.jsxs)(n.p,{children:["When conditions are used for ",(0,r.jsx)(n.code,{children:"baseUnlock"})," on generators, the progression coordinator implements ",(0,r.jsx)(n.strong,{children:"persistent unlock"})," behavior:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// packages/core/src/progression-coordinator.ts\nif (!record.state.isUnlocked && baseUnlock) {\n  record.state.isUnlocked = true;  // Never reverts!\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Once a generator's ",(0,r.jsx)(n.code,{children:"baseUnlock"})," condition evaluates to ",(0,r.jsx)(n.code,{children:"true"}),", the ",(0,r.jsx)(n.code,{children:"isUnlocked"})," flag ",(0,r.jsxs)(n.strong,{children:["never reverts to ",(0,r.jsx)(n.code,{children:"false"})]}),", even if the condition later fails (e.g., player spends resources below the threshold). This ensures generators remain available after being discovered."]}),"\n",(0,r.jsxs)(n.p,{children:["In contrast, ",(0,r.jsx)(n.code,{children:"visibilityCondition"})," is re-evaluated every game step and can toggle between ",(0,r.jsx)(n.code,{children:"true"})," and ",(0,r.jsx)(n.code,{children:"false"}),", allowing dynamic hiding/showing of content based on current state."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Human-Readable Descriptions"}),":"]}),"\n",(0,r.jsxs)(n.p,{children:["The runtime generates unlock hints for locked content using ",(0,r.jsx)(n.code,{children:"describeCondition()"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"resourceThreshold"})," \u2192 ",(0,r.jsx)(n.code,{children:'"Requires energy >= 100"'})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"generatorLevel"})," \u2192 ",(0,r.jsx)(n.code,{children:'"Requires reactor >= 5"'})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"upgradeOwned"})," \u2192 ",(0,r.jsx)(n.code,{children:'"Requires owning 3\xd7 efficiency"'})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"allOf"})," \u2192 ",(0,r.jsx)(n.code,{children:'"Requires energy >= 100, Requires reactor >= 5"'})," (comma-separated)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"anyOf"})," \u2192 ",(0,r.jsx)(n.code,{children:'"Requires any of: energy >= 100 or reactor >= 5"'})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"not"})," \u2192 ",(0,r.jsx)(n.code,{children:'"Not (Requires energy >= 100)"'})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"always"})," \u2192 ",(0,r.jsx)(n.code,{children:"undefined"})," (no hint needed)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"never"})," \u2192 ",(0,r.jsx)(n.code,{children:'"Unavailable in this build"'})]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"These hints are displayed in progression UI when upgrades are locked, helping players understand unlock requirements."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Implementation Reference"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Condition evaluator: ",(0,r.jsx)(n.code,{children:"packages/core/src/condition-evaluator.ts"})]}),"\n",(0,r.jsxs)(n.li,{children:["Condition evaluation tests: ",(0,r.jsx)(n.code,{children:"packages/core/src/condition-evaluator.test.ts"})]}),"\n",(0,r.jsxs)(n.li,{children:["Progression coordinator integration: ",(0,r.jsx)(n.code,{children:"packages/core/src/progression-coordinator.ts"})]}),"\n",(0,r.jsxs)(n.li,{children:["Persistent unlock behavior: Documented in ",(0,r.jsx)(n.code,{children:"docs/progression-coordinator-design.md"})," \xa76.2.4"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Content Authoring Guidelines"}),":"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsxs)(n.strong,{children:["Use ",(0,r.jsx)(n.code,{children:"always"})," for unconditionally unlocked content"]}),": Set ",(0,r.jsx)(n.code,{children:"baseUnlock: { kind: 'always' }"})," for starting generators"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Avoid circular dependencies"}),": Don't create unlock chains where A requires B and B requires A"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Prefer simple thresholds"}),": Use ",(0,r.jsx)(n.code,{children:"resourceThreshold"})," or ",(0,r.jsx)(n.code,{children:"generatorLevel"})," rather than complex ",(0,r.jsx)(n.code,{children:"allOf"})," nesting when possible"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Test negative conditions carefully"}),": ",(0,r.jsx)(n.code,{children:"not"})," and ",(0,r.jsx)(n.code,{children:"anyOf"})," introduce non-monotonic logic; ensure they don't create confusing unlock sequences"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Consider persistent unlocks"}),": Remember that ",(0,r.jsx)(n.code,{children:"baseUnlock"})," is persistent\u2014don't use it for temporary gates"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsxs)(n.strong,{children:["Use ",(0,r.jsx)(n.code,{children:"visibilityCondition"})," for temporary gates"]}),": If content should hide again after discovery, use ",(0,r.jsx)(n.code,{children:"visibilityCondition"})," instead of ",(0,r.jsx)(n.code,{children:"baseUnlock"})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"55-metadata-schema",children:"5.5 Metadata Schema"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"metadataSchema"})," covers content-level metadata:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"id"}),": pack slug (",(0,r.jsx)(n.code,{children:"packSlugSchema"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"title"}),": ",(0,r.jsx)(n.code,{children:"localizedTextSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"summary"}),": optional ",(0,r.jsx)(n.code,{children:"localizedSummarySchema"})," with longer copy (\u2264512 chars)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"version"}),": semantic version string validated by ",(0,r.jsx)(n.code,{children:"semver"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"engine"}),": semver range describing supported runtime versions."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"authors"}),": array of trimmed strings (\u226464 chars) with de-duplication."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"defaultLocale"}),": ",(0,r.jsx)(n.code,{children:"localeCodeSchema"})," that maps to the ",(0,r.jsx)(n.code,{children:"title.default"}),"\nproperty. Normalisation ensures the same string also appears in\n",(0,r.jsx)(n.code,{children:"title.variants"})," for tooling that expects locale keys."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"supportedLocales"}),": non-empty array of ",(0,r.jsx)(n.code,{children:"localeCodeSchema"})," entries\nrepresenting every locale shipped with the pack. Validation rejects inputs\nthat omit ",(0,r.jsx)(n.code,{children:"defaultLocale"}),", while normalisation removes duplicates and sorts\nthe final list for deterministic hashing."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tags"}),": array of slugs (\u226424 chars) reserved for tooling filters."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"links"}),": optional array of URL metadata ",(0,r.jsx)(n.code,{children:"{ kind, label, href }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"createdAt"})," / ",(0,r.jsx)(n.code,{children:"updatedAt"}),": ISO-8601 timestamps (optional)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"visibility"}),": optional enum ",(0,r.jsx)(n.code,{children:"public | private | experimental"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"dependencies"}),": optional object shaped by ",(0,r.jsx)(n.code,{children:"packDependencySchema"})," exported\nfrom ",(0,r.jsx)(n.code,{children:"modules/dependencies.ts"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"requires"}),": array of ",(0,r.jsx)(n.code,{children:"{ packId: PackId; version: semverRangeSchema }"}),"\nrepresenting hard dependencies that must load before this pack."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"optional"}),": array with the same shape for soft integrations (warnings\nemitted when known installed packs omit the dependency; see \xa75.16)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"conflicts"}),": array restricting incompatible packs\n(",(0,r.jsx)(n.code,{children:"{ packId: PackId; message?: string }"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"provides"}),": optional array of capability slugs for discovery tooling.\nNormalisation deduplicates entries, sorts them deterministically, and\nensures packs never self-reference. Dependency cycle detection runs during\ncross-reference validation by combining the pack's declared ",(0,r.jsx)(n.code,{children:"requires"}),"\nedges with the dependency graph supplied through\n",(0,r.jsx)(n.code,{children:"ContentSchemaOptions.knownPacks"})," (see \xa75.16); when upstream data is\nmissing, the validator still guards against self-references and duplicate\nentries."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["The schema normalises whitespace, enforces canonical casing, and ensures\n",(0,r.jsx)(n.code,{children:"engine"})," ranges include the active runtime version when known (checked in\ntests) and that ",(0,r.jsx)(n.code,{children:"supportedLocales"})," contains ",(0,r.jsx)(n.code,{children:"defaultLocale"}),". Optional\ndependencies only surface ",(0,r.jsx)(n.code,{children:"optionalDependency.missing"})," warnings when callers\nsupply ",(0,r.jsx)(n.code,{children:"ContentSchemaOptions.activePackIds"}),"; otherwise the entries stay\ninformational so unpublished packs are not penalised while the pipeline lacks\nvisibility into the installation graph. During the proof-of-concept phase we\nexplicitly keep optional dependencies as warnings (never hard errors) to\npreserve iteration speed; once installation graphs are available we can\nrevisit stricter enforcement. When authors pass ",(0,r.jsx)(n.code,{children:"ContentSchemaOptions.runtimeVersion"}),",\n",(0,r.jsx)(n.code,{children:"validateCrossReferences"})," performs two compatibility checks:","\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"semver.satisfies(runtimeVersion, metadata.engine)"})," must be true; otherwise\na targeted error is raised (per the\n",(0,r.jsxs)(n.a,{href:"https://github.com/npm/node-semver#ranges",children:[(0,r.jsx)(n.code,{children:"node-semver"})," README example"]}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["The validator consults the ",(0,r.jsx)(n.code,{children:"FEATURE_GATES"})," map in ",(0,r.jsx)(n.code,{children:"runtime-compat.ts"}),". Each\nnon-prototype module (anchored to the milestones described in\n",(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"})," \xa77.2 and ",(0,r.jsx)(n.code,{children:"docs/implementation-plan.md"}),")\ndeclares the minimum runtime version it supports. For example, automations\nrequire ",(0,r.jsx)(n.code,{children:">=0.2.0"}),", transforms and runtime event contributions require\n",(0,r.jsx)(n.code,{children:">=0.3.0"}),", prestige layers require ",(0,r.jsx)(n.code,{children:">=0.4.0"}),", and guild perks require\n",(0,r.jsx)(n.code,{children:">=0.5.0"}),". When a pack targets an older runtime yet includes gated modules,\n",(0,r.jsx)(n.code,{children:"validateCrossReferences"})," emits a structured error naming the offending\nfeature and required version. Passing packs still receive warning hints\nwhen they depend on features from newer runtimes so maintainers know which\nmodules to trim if they need to stay compatible."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"56-resource-schema",children:"5.6 Resource Schema"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"resourceDefinitionSchema"})," extends the runtime-facing definition with content\nmetadata:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"id"}),": ",(0,r.jsx)(n.code,{children:"contentIdSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"name"}),": ",(0,r.jsx)(n.code,{children:"localizedTextSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"category"}),": enum (",(0,r.jsx)(n.code,{children:"primary"}),", ",(0,r.jsx)(n.code,{children:"prestige"}),", ",(0,r.jsx)(n.code,{children:"automation"}),", ",(0,r.jsx)(n.code,{children:"currency"}),",\n",(0,r.jsx)(n.code,{children:"misc"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"economyClassification"}),": enum (",(0,r.jsx)(n.code,{children:"hard"}),", ",(0,r.jsx)(n.code,{children:"soft"}),") classifying whether a\nresource participates in the server-authoritative ledger (",(0,r.jsx)(n.code,{children:"hard"}),") or is\nclient-authoritative progression (",(0,r.jsx)(n.code,{children:"soft"}),"). Defaults to ",(0,r.jsx)(n.code,{children:"soft"})," when omitted,\naligning with initiative ",(0,r.jsx)(n.code,{children:"GEL-001"}),"\u2019s hard/soft currency split."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tier"}),": positive integer for UI grouping."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"icon"}),": optional icon path (SVG/PNG) resolved at build time."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"startAmount"}),": non-negative number (defaults to ",(0,r.jsx)(n.code,{children:"0"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"capacity"}),": nullable number; ",(0,r.jsx)(n.code,{children:"null"})," maps to infinity at runtime."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"visible"}),": boolean default ",(0,r.jsx)(n.code,{children:"true"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"unlocked"}),": boolean default ",(0,r.jsx)(n.code,{children:"false"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"dirtyTolerance"}),": optional override (validated against runtime ceilings)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"order"}),": optional float for deterministic sort when content author wants\nmanual ordering."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"unlockCondition"})," / ",(0,r.jsx)(n.code,{children:"visibilityCondition"}),": ",(0,r.jsx)(n.code,{children:"conditionSchema"})," nodes."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"prestige"}),": optional block describing prestige currency linkage\n",(0,r.jsx)(n.code,{children:"{ layerId, resetRetention?: NumericFormula }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tags"}),": array of slugs for analytics or UI filters."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:".superRefine"})," performs per-definition checks:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"startAmount \u2264 capacity"})," when capacity is finite."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"dirtyTolerance"})," clamped to the runtime maximum with telemetry-friendly\ndiagnostics."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"57-generator-schema",children:"5.7 Generator Schema"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"generatorDefinitionSchema"})," models production structures:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"id"}),", ",(0,r.jsx)(n.code,{children:"name"}),", ",(0,r.jsx)(n.code,{children:"icon"}),", ",(0,r.jsx)(n.code,{children:"tags"})," similar to resources."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"produces"}),": array of ",(0,r.jsx)(n.code,{children:"{ resourceId, rate: NumericFormula }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"consumes"}),": optional array of ",(0,r.jsx)(n.code,{children:"{ resourceId, rate: NumericFormula }"})," for\nupkeep costs."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"purchase"}),": strict object with explicit scalar schemas:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"currencyId"}),": ",(0,r.jsx)(n.code,{children:"contentIdSchema"})," (lowercased during normalisation)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"baseCost"}),": ",(0,r.jsx)(n.code,{children:"nonNegativeNumberSchema"})," ensuring finite, \u22650 values."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"costCurve"}),": ",(0,r.jsx)(n.code,{children:"numericFormulaSchema"})," evaluated in the runtime against the\ncurrent purchase count."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"maxBulk"}),": optional ",(0,r.jsx)(n.code,{children:"positiveIntSchema"})," constraining bulk-buy UI affordances."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"maxLevel"}),": optional positive integer."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"order"}),": optional float controlling list ordering (sorted before id during\nnormalisation)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"baseUnlock"}),": ",(0,r.jsx)(n.code,{children:"conditionSchema"})," gating initial availability."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"visibilityCondition"}),": ",(0,r.jsx)(n.code,{children:"conditionSchema"})," for UI reveal."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"automation"}),": optional reference ",(0,r.jsx)(n.code,{children:"{ automationId }"})," linking to automation\ndefinitions."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"effects"}),": optional array for generator-specific effects (e.g., passive\nbonuses) using shared effect schema from upgrades."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Cross-validation ensures referenced resources exist, consumption and production\nrates are finite, and ",(0,r.jsx)(n.code,{children:"maxBulk"})," respects ",(0,r.jsx)(n.code,{children:"maxLevel"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"58-upgrade-schema",children:"5.8 Upgrade Schema"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"upgradeDefinitionSchema"})," captures upgrade catalog entries:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"id"}),", ",(0,r.jsx)(n.code,{children:"name"}),", ",(0,r.jsx)(n.code,{children:"icon"}),", ",(0,r.jsx)(n.code,{children:"tags"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"category"}),": enum (",(0,r.jsx)(n.code,{children:"global"}),", ",(0,r.jsx)(n.code,{children:"resource"}),", ",(0,r.jsx)(n.code,{children:"generator"}),", ",(0,r.jsx)(n.code,{children:"automation"}),",\n",(0,r.jsx)(n.code,{children:"prestige"}),", ",(0,r.jsx)(n.code,{children:"guild"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"targets"}),": array of typed handles\n(",(0,r.jsx)(n.code,{children:"{ kind: 'resource'; id: ContentId }"}),",\n",(0,r.jsx)(n.code,{children:"{ kind: 'generator'; id: ContentId }"}),",\n",(0,r.jsx)(n.code,{children:"{ kind: 'automation'; id: ContentId }"}),",\n",(0,r.jsx)(n.code,{children:"{ kind: 'prestigeLayer'; id: ContentId }"}),",\n",(0,r.jsx)(n.code,{children:"{ kind: 'guildPerk'; id: ContentId }"}),", or ",(0,r.jsx)(n.code,{children:"{ kind: 'global' }"}),") so upgrade\npayloads stay strongly typed and avoid the stringly typed anti-pattern noted\nabove."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"cost"}),": same schema as generator ",(0,r.jsx)(n.code,{children:"purchase"}),", reusing the scalar contracts for\n",(0,r.jsx)(n.code,{children:"currencyId"}),", ",(0,r.jsx)(n.code,{children:"baseCost"}),", ",(0,r.jsx)(n.code,{children:"costCurve"}),", and ",(0,r.jsx)(n.code,{children:"maxBulk"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"repeatable"}),": optional block describing stacking rules (",(0,r.jsx)(n.code,{children:"maxPurchases"}),",\n",(0,r.jsx)(n.code,{children:"costCurve"}),", ",(0,r.jsx)(n.code,{children:"effectCurve"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"prerequisites"}),": array of ",(0,r.jsx)(n.code,{children:"conditionSchema"})," or upgrade ids (internally\nnormalised to condition nodes)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"order"}),": optional float aligning manual catalogue ordering with generator and\nresource lists."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"effects"}),": array of discriminated union entries:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"modifyResourceRate"})," (",(0,r.jsx)(n.code,{children:"resourceId"}),", ",(0,r.jsx)(n.code,{children:"operation"}),", ",(0,r.jsx)(n.code,{children:"value: NumericFormula"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"modifyGeneratorRate"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"modifyGeneratorCost"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"grantAutomation"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"grantFlag"})," (",(0,r.jsx)(n.code,{children:"{ kind: 'grantFlag'; flagId: FlagId; value?: boolean }"}),")\ndeclaring deterministic flag mutations; ",(0,r.jsx)(n.code,{children:"value"})," defaults to ",(0,r.jsx)(n.code,{children:"true"})," during\nnormalisation so authors can focus on the ids they flip. The schema reuses\n",(0,r.jsx)(n.code,{children:"flagIdSchema"})," and validates the id against caller-supplied allowlists."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"unlockResource"})," / ",(0,r.jsx)(n.code,{children:"unlockGenerator"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"alterDirtyTolerance"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"emitEvent"})," (hooks into runtime event bus)."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"unlockCondition"})," / ",(0,r.jsx)(n.code,{children:"visibilityCondition"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Runtime semantics for repeatable upgrades:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Repeatable upgrades apply their effects once per purchase (stacking in\npurchase order)."}),"\n",(0,r.jsxs)(n.li,{children:["For each purchase application at ",(0,r.jsx)(n.code,{children:"level = 1..purchases"}),", runtime evaluates:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"curve = repeatable.effectCurve(level)"})," (defaults to ",(0,r.jsx)(n.code,{children:"1"})," when omitted)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"raw = effects[].value(level)"})," for each numeric effect."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"effective = raw \xd7 curve"})," (only when ",(0,r.jsx)(n.code,{children:"effectCurve"})," is present)."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["The ",(0,r.jsx)(n.code,{children:"effective"})," value is applied per ",(0,r.jsx)(n.code,{children:"operation"})," to a per-target modifier\nthat starts at ",(0,r.jsx)(n.code,{children:"1"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"add"}),": ",(0,r.jsx)(n.code,{children:"modifier += effective"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"multiply"}),": ",(0,r.jsx)(n.code,{children:"modifier *= effective"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"set"}),": ",(0,r.jsx)(n.code,{children:"modifier = effective"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Authoring note: if ",(0,r.jsx)(n.code,{children:"effects[].value"})," also references ",(0,r.jsx)(n.code,{children:"level"}),", scaling\ncomposes multiplicatively with ",(0,r.jsx)(n.code,{children:"effectCurve"}),"; avoid double-scaling unless\nintentional."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Validation ensures effect targets exist, repeatable upgrades specify consistent\nbounds, and cost curves match runtime expectations using the explicit ",(0,r.jsx)(n.code,{children:"kind"}),"\ninformation in ",(0,r.jsx)(n.code,{children:"targets"})," and the effect payloads."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"59-metric-schema",children:"5.9 Metric Schema"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"metricDefinitionSchema"})," describes pack-authored telemetry counters that plug\ninto the instrumentation pipeline promised in ",(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"})," \xa76.3\n(\u201callow games to register custom metrics using shared instrumentation API\u201d):","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"id"}),": ",(0,r.jsx)(n.code,{children:"contentIdSchema"})," canonical slug aligned with the instrumentation name\ngrammar. Normalisation lowercases ids and collapses duplicate separators so\nauthored metrics mirror the lookup keys used by runtime exporters."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"name"}),": ",(0,r.jsx)(n.code,{children:"localizedTextSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"description"}),": optional ",(0,r.jsx)(n.code,{children:"localizedSummarySchema"}),", surfaced in tooling so\ndesigners and analytics reviewers share human-friendly context for each\nmeasurement."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"kind"}),": enum (",(0,r.jsx)(n.code,{children:"counter"}),", ",(0,r.jsx)(n.code,{children:"gauge"}),", ",(0,r.jsx)(n.code,{children:"histogram"}),", ",(0,r.jsx)(n.code,{children:"upDownCounter"}),") mapping onto\nOpenTelemetry instrument semantics to keep downstream aggregation predictable\n(matching the public guidance that instrument kind, unit, and description\nshape identity and cardinality constraints",(0,r.jsx)(n.sup,{children:(0,r.jsx)(n.a,{href:"#user-content-fn-otel-metrics-api",id:"user-content-fnref-otel-metrics-api","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"3"})}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"unit"}),": optional string validated against a trimmed ASCII grammar and capped\nat 32 characters. Normalisation defaults empty units to ",(0,r.jsx)(n.code,{children:"'1'"})," for\ndimensionless counters, mirroring OpenTelemetry\u2019s recommendation for unit\nfields."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"aggregation"}),": optional enum describing the preferred rollup\n(",(0,r.jsx)(n.code,{children:"sum"}),", ",(0,r.jsx)(n.code,{children:"delta"}),", ",(0,r.jsx)(n.code,{children:"cumulative"}),", ",(0,r.jsx)(n.code,{children:"distribution"}),"). The schema keeps the value\nadvisory\u2014tooling can respect author intent while still allowing fallback\naggregation when runtimes lack support."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"attributes"}),": optional array of attribute keys (",(0,r.jsx)(n.code,{children:"slug"})," grammar,\n\u226416 chars) documenting the telemetry dimension set so validation can warn\nwhen authors declare high-cardinality combinations."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"source"}),": enum describing how the pack emits the metric (",(0,r.jsx)(n.code,{children:"runtime"}),", ",(0,r.jsx)(n.code,{children:"script"}),",\n",(0,r.jsx)(n.code,{children:"content"}),") with optional payload describing bindings (e.g.,\n",(0,r.jsx)(n.code,{children:"{ kind: 'script'; scriptId: ScriptId }"}),"). Validation ensures referenced\nscript ids originate from allowlists and warns when runtime bindings cite\nmodules gated by ",(0,r.jsx)(n.code,{children:"FEATURE_GATES"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"order"}),": optional float letting authors stabilise how metrics appear in CLI\nreports or documentation exports before falling back to id-based sorting."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Validation rejects duplicate metric ids, enforces that histogram metrics\ndeclare an advisory aggregation, and surfaces warnings when attribute key\ncounts exceed three (mirroring OpenTelemetry\u2019s constraint on low-cardinality\nattribute sets to keep exporters efficient). Metrics participate in\nlocalisation checks and integrate with the warning sink so CLI tooling can\nflag ambiguous descriptions."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"510-achievement-schema",children:"5.10 Achievement Schema"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"achievementDefinitionSchema"})," models milestone tracking promised in\n",(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"})," \xa76.2:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"id"}),": ",(0,r.jsx)(n.code,{children:"contentIdSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"name"}),": ",(0,r.jsx)(n.code,{children:"localizedTextSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"description"}),": ",(0,r.jsx)(n.code,{children:"localizedSummarySchema"})," (\u2264512 chars) so UI blurbs can be\nlonger than upgrade tooltips."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"category"}),": enum (",(0,r.jsx)(n.code,{children:"progression"}),", ",(0,r.jsx)(n.code,{children:"prestige"}),", ",(0,r.jsx)(n.code,{children:"automation"}),", ",(0,r.jsx)(n.code,{children:"social"}),",\n",(0,r.jsx)(n.code,{children:"collection"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tier"}),": enum (",(0,r.jsx)(n.code,{children:"bronze"}),", ",(0,r.jsx)(n.code,{children:"silver"}),", ",(0,r.jsx)(n.code,{children:"gold"}),", ",(0,r.jsx)(n.code,{children:"platinum"}),") used for UI theming."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"icon"}),": optional icon path."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tags"}),": array for analytics or in-game filters."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"track"}),": discriminated union describing progress measurement:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"resource"}),": ",(0,r.jsx)(n.code,{children:"{ kind: 'resource'; resourceId: ContentId; threshold: NumericFormula; comparator?: 'gte' | 'gt' | 'lte' | 'lt' }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"generatorLevel"}),": ",(0,r.jsx)(n.code,{children:"{ kind: 'generator-level'; generatorId: ContentId; level: NumericFormula }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"upgradeOwned"}),": ",(0,r.jsx)(n.code,{children:"{ kind: 'upgrade-owned'; upgradeId: ContentId; purchases?: NumericFormula }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"flag"}),": ",(0,r.jsx)(n.code,{children:"{ kind: 'flag'; flagId: FlagId }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"script"}),": ",(0,r.jsx)(n.code,{children:"{ kind: 'script'; scriptId: ScriptId }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"customMetric"}),": ",(0,r.jsx)(n.code,{children:"{ kind: 'custom-metric'; metricId: ContentId; threshold: NumericFormula }"})," for pack-defined telemetry counters. Validation ensures\n",(0,r.jsx)(n.code,{children:"metricId"})," references a metric declared in the same pack."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"progress"}),": object describing accumulation semantics:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"target"}),": optional ",(0,r.jsx)(n.code,{children:"NumericFormula"}),". When omitted, normalisation derives a\ndeterministic default: ",(0,r.jsx)(n.code,{children:"threshold"}),", ",(0,r.jsx)(n.code,{children:"level"}),", ",(0,r.jsx)(n.code,{children:"purchases"}),", or ",(0,r.jsx)(n.code,{children:"metric"}),"\nrequirements from the active ",(0,r.jsx)(n.code,{children:"track"})," variant, and a constant ",(0,r.jsx)(n.code,{children:"1"})," curve for\nboolean achievements (",(0,r.jsx)(n.code,{children:"flag"}),", ",(0,r.jsx)(n.code,{children:"script"}),") so they still model a goal that\nresolves to completion."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"mode"}),": enum (",(0,r.jsx)(n.code,{children:"oneShot"}),", ",(0,r.jsx)(n.code,{children:"incremental"}),", ",(0,r.jsx)(n.code,{children:"repeatable"}),") guiding whether\nprogress sticks after completion."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"repeatable"}),": optional object used when ",(0,r.jsx)(n.code,{children:"mode === 'repeatable'"}),":\n",(0,r.jsx)(n.code,{children:"{ resetWindow: NumericFormula; maxRepeats?: number; rewardScaling?: NumericFormula }"}),".\n",(0,r.jsx)(n.code,{children:"resetWindow"})," defines the deterministic interval between repeats\n(expressed in runtime ticks). ",(0,r.jsx)(n.code,{children:"maxRepeats"})," limits the total number of\ntimes the achievement can recur, and ",(0,r.jsx)(n.code,{children:"rewardScaling"})," describes how repeat\nrewards scale (defaults to a constant ",(0,r.jsx)(n.code,{children:"1"})," curve). Validation enforces\npresence of ",(0,r.jsx)(n.code,{children:"resetWindow"})," whenever the repeatable block exists."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"reward"}),": optional union (",(0,r.jsx)(n.code,{children:"grantResource"}),", ",(0,r.jsx)(n.code,{children:"grantUpgrade"}),", ",(0,r.jsx)(n.code,{children:"grantGuildPerk"}),",\n",(0,r.jsx)(n.code,{children:"emitEvent"}),", ",(0,r.jsx)(n.code,{children:"unlockAutomation"}),", ",(0,r.jsx)(n.code,{children:"grantFlag"}),") reusing effect payload schemas.\n",(0,r.jsx)(n.code,{children:"grantFlag"})," mirrors the upgrade effect contract (",(0,r.jsx)(n.code,{children:"flagId"}),", optional ",(0,r.jsx)(n.code,{children:"value"}),"\ndefaulting to ",(0,r.jsx)(n.code,{children:"true"}),") and validates entries against the ",(0,r.jsx)(n.code,{children:"flags"})," allowlist."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"unlockCondition"}),": optional ",(0,r.jsx)(n.code,{children:"conditionSchema"})," gating visibility in the log."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"visibilityCondition"}),": optional ",(0,r.jsx)(n.code,{children:"conditionSchema"})," enabling hidden feats."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"onUnlockEvents"}),": optional array of runtime event ids emitted when the\nachievement completes, ensuring content-authored events integrate with the\nmanifest pipeline described in \xa75.15."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"displayOrder"}),": optional float for deterministic ordering alongside author\nsupplied tiers."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Cross-validation ensures the resolved ",(0,r.jsx)(n.code,{children:"progress.target"})," (authored or inferred)\nevaluates to a positive, finite number, referenced ids exist (including\n",(0,r.jsx)(n.code,{children:"customMetric.metricId"})," entries), union variants include the correct handles,\nand repeatable achievements declare deterministic\nreset semantics via the\n",(0,r.jsx)(n.code,{children:"repeatable.resetWindow"})," field (while keeping ",(0,r.jsx)(n.code,{children:"maxRepeats"})," finite and\n",(0,r.jsx)(n.code,{children:"rewardScaling"})," curves bounded). Achievements also participate in localisation\nchecks so missing descriptions surface warnings."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"511-automation-schema",children:"5.11 Automation Schema"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"automationDefinitionSchema"})," describes automation toggles:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"id"}),": ",(0,r.jsx)(n.code,{children:"contentIdSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"name"}),": ",(0,r.jsx)(n.code,{children:"localizedTextSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"description"}),": ",(0,r.jsx)(n.code,{children:"localizedTextSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"targetType"}),": enum (",(0,r.jsx)(n.code,{children:"generator"}),", ",(0,r.jsx)(n.code,{children:"upgrade"}),", ",(0,r.jsx)(n.code,{children:"purchaseGenerator"}),", ",(0,r.jsx)(n.code,{children:"collectResource"}),", ",(0,r.jsx)(n.code,{children:"system"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"targetId"}),": required when ",(0,r.jsx)(n.code,{children:"targetType"})," is ",(0,r.jsx)(n.code,{children:"generator"}),", ",(0,r.jsx)(n.code,{children:"upgrade"}),", ",(0,r.jsx)(n.code,{children:"purchaseGenerator"}),", or ",(0,r.jsx)(n.code,{children:"collectResource"})," and\nvalidated against the relevant ids (",(0,r.jsx)(n.code,{children:"generator"}),", ",(0,r.jsx)(n.code,{children:"upgrade"}),", or ",(0,r.jsx)(n.code,{children:"resource"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"targetEnabled"}),": optional boolean for ",(0,r.jsx)(n.code,{children:"targetType === 'generator'"})," (defaults to ",(0,r.jsx)(n.code,{children:"true"})," at runtime)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"targetCount"}),": optional ",(0,r.jsx)(n.code,{children:"NumericFormula"})," for ",(0,r.jsx)(n.code,{children:"targetType === 'purchaseGenerator'"})," (defaults to ",(0,r.jsx)(n.code,{children:"1"})," at runtime)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"targetAmount"}),": optional ",(0,r.jsx)(n.code,{children:"NumericFormula"})," for ",(0,r.jsx)(n.code,{children:"targetType === 'collectResource'"})," (defaults to ",(0,r.jsx)(n.code,{children:"1"})," at runtime)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"systemTargetId"}),": required when ",(0,r.jsx)(n.code,{children:"targetType === 'system'"}),", validated using\n",(0,r.jsx)(n.code,{children:"systemAutomationTargetIdSchema"})," against the curated allowlist\n(",(0,r.jsx)(n.code,{children:"offline-catchup"}),", ",(0,r.jsx)(n.code,{children:"research-daemon"}),", etc.)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"trigger"}),": union of deterministic triggers (",(0,r.jsx)(n.code,{children:"interval"}),", ",(0,r.jsx)(n.code,{children:"resourceThreshold"}),",\n",(0,r.jsx)(n.code,{children:"commandQueueEmpty"}),", ",(0,r.jsx)(n.code,{children:"event"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"cooldown"}),": optional number (",(0,r.jsx)(n.code,{children:"ms"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"resourceCost"}),": optional upkeep cost schema reused from generators."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"unlockCondition"}),": ",(0,r.jsx)(n.code,{children:"conditionSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"enabledByDefault"}),": boolean default ",(0,r.jsx)(n.code,{children:"false"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"order"}),": optional float guiding UI grouping."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Automations can reference script hooks; validation ensures script ids adhere to\nthe shared id schema. System targets validate against a curated allowlist\nencoded by ",(0,r.jsx)(n.code,{children:"systemAutomationTargetIdSchema"})," (e.g., ",(0,r.jsx)(n.code,{children:"offline-catchup"}),",\n",(0,r.jsx)(n.code,{children:"research-daemon"}),") so authors receive actionable errors instead of generic\nmissing-id failures. Event-triggered automations (",(0,r.jsx)(n.code,{children:"trigger.kind === 'event'"}),")\nare cross-checked against the merged runtime event catalogue so dangling ids\nsurface during validation rather than at runtime."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"512-transform-schema",children:"5.12 Transform Schema"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"transformDefinitionSchema"})," captures deterministic conversions sitting between\ngenerators and prestige resets, satisfying the \u201ctransforms\u201d requirement in\n",(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"})," \xa76.2:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"id"}),": ",(0,r.jsx)(n.code,{children:"contentIdSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"name"}),": ",(0,r.jsx)(n.code,{children:"localizedTextSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"description"}),": ",(0,r.jsx)(n.code,{children:"localizedSummarySchema"})," clarifying the conversion behaviour."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"mode"}),": enum (",(0,r.jsx)(n.code,{children:"instant"}),", ",(0,r.jsx)(n.code,{children:"continuous"}),", ",(0,r.jsx)(n.code,{children:"batch"}),") expressing whether the\ntransform fires once, ticks every simulation step, or processes a finite\nbatch when triggered."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"inputs"}),": non-empty array of ",(0,r.jsx)(n.code,{children:"{ resourceId: ContentId; amount: NumericFormula }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"outputs"}),": non-empty array of ",(0,r.jsx)(n.code,{children:"{ resourceId: ContentId; amount: NumericFormula }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"duration"}),": optional ",(0,r.jsx)(n.code,{children:"NumericFormula"})," (ms) for timed conversions (required\nfor ",(0,r.jsx)(n.code,{children:"batch"})," mode)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"cooldown"}),": optional ",(0,r.jsx)(n.code,{children:"NumericFormula"})," enforcing time between runs."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"trigger"}),": discriminated union describing how the transform activates:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"manual"}),": ",(0,r.jsx)(n.code,{children:"{ kind: 'manual' }"})," for player-driven conversions."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"automation"}),": ",(0,r.jsx)(n.code,{children:"{ kind: 'automation'; automationId: ContentId }"}),"\nreferencing an automation toggle that fires the transform.",(0,r.jsx)(n.sup,{children:(0,r.jsx)(n.a,{href:"#user-content-fn-core-automation-tests",id:"user-content-fnref-core-automation-tests","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"4"})})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"condition"}),": ",(0,r.jsx)(n.code,{children:"{ kind: 'condition'; condition: Condition }"})," for inline\npredicates."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"event"}),": ",(0,r.jsx)(n.code,{children:"{ kind: 'event'; eventId: ContentId }"})," bundling runtime event\nidentifiers."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"unlockCondition"}),": optional ",(0,r.jsx)(n.code,{children:"conditionSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"visibilityCondition"}),": optional ",(0,r.jsx)(n.code,{children:"conditionSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"automation"}),": optional ",(0,r.jsx)(n.code,{children:"{ automationId: ContentId }"})," linking to automation\ntoggles for hands-off operation. When ",(0,r.jsx)(n.code,{children:"trigger.kind === 'automation'"})," this\nblock is required and must reference the same canonical id."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tags"}),": array for analytics/UX filters."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"safety"}),": optional guard specifying ",(0,r.jsx)(n.code,{children:"maxRunsPerTick"})," and\n",(0,r.jsx)(n.code,{children:"maxOutstandingBatches"})," so the runtime clamps runaway loops deterministically."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"order"}),": optional float allowing authors to stabilise transform ordering in\nmenus."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Validation confirms every transform references declared resources, batch modes\ndeclare a finite ",(0,r.jsx)(n.code,{children:"duration"}),", continuous transforms specify at least one\nconsumption or production rate, and the signed sum of input/output rates stays\nfinite to protect hashing. When ",(0,r.jsx)(n.code,{children:"trigger.kind === 'automation'"})," the validator\nensures the embedded ",(0,r.jsx)(n.code,{children:"automationId"})," exists and, when the optional ",(0,r.jsx)(n.code,{children:"automation"}),"\nblock is present, that both references match. Event-triggered transforms verify\n",(0,r.jsx)(n.code,{children:"eventId"})," against the runtime contributions defined in \xa75.15."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"513-prestige-layer-schema",children:"5.13 Prestige Layer Schema"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"prestigeLayerSchema"})," supports reset mechanics:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"id"}),", ",(0,r.jsx)(n.code,{children:"name"}),", ",(0,r.jsx)(n.code,{children:"icon"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"summary"}),": ",(0,r.jsx)(n.code,{children:"localizedTextSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"resetTargets"}),": array of resource ids reset when the layer triggers."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"unlockCondition"}),": ",(0,r.jsx)(n.code,{children:"conditionSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"reward"}),": block specifying output currency ",(0,r.jsx)(n.code,{children:"{ resourceId, baseReward: NumericFormula, multiplierCurve?: NumericFormula }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"retention"}),": optional array describing retained resources/upgrades."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"automation"}),": optional reference enabling auto-prestige triggers."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"order"}),": optional float for menu ordering."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Validation enforces that prestige rewards reference prestige-class resources\nand that reset targets cover at least one non-prestige resource."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"514-guild-perk-schema",children:"5.14 Guild Perk Schema"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"guildPerkSchema"})," provides hooks for social systems:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"id"}),": ",(0,r.jsx)(n.code,{children:"contentIdSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"name"}),": ",(0,r.jsx)(n.code,{children:"localizedTextSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"description"}),": ",(0,r.jsx)(n.code,{children:"localizedTextSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"category"}),": enum (",(0,r.jsx)(n.code,{children:"buff"}),", ",(0,r.jsx)(n.code,{children:"utility"}),", ",(0,r.jsx)(n.code,{children:"cosmetic"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"maxRank"}),": positive integer."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"effects"}),": union aligned with upgrade effects plus guild-specific entries\n(",(0,r.jsx)(n.code,{children:"modifyGuildStorage"}),", ",(0,r.jsx)(n.code,{children:"unlockGuildAutomation"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"cost"}),": block referencing guild currency or contribution metrics."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"unlockCondition"}),": ",(0,r.jsx)(n.code,{children:"conditionSchema"})," (allowing milestones or campaign\nprogress)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"order"}),": optional float coordinating perk list ordering with prestige and\nupgrade entries."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"visibilityCondition"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Guild perks can be optional for prototype packs; schema allows empty arrays."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"515-runtime-event-contribution-schema",children:"5.15 Runtime Event Contribution Schema"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Content packs augment the runtime event catalogue documented in\n",(0,r.jsx)(n.code,{children:"docs/runtime-event-pubsub-design.md"})," and\n",(0,r.jsx)(n.code,{children:"docs/runtime-event-manifest-authoring.md"}),". The schema ensures authored\nentries align with the manifest generator responsible for producing\n",(0,r.jsx)(n.code,{children:"GENERATED_RUNTIME_EVENT_DEFINITIONS"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"id"}),": ",(0,r.jsx)(n.code,{children:"contentIdSchema"}),", derived from the canonical runtime event type\n",(0,r.jsx)(n.code,{children:"namespace:name"}),". Authors may omit the field; when provided the\nschema verifies the value matches the derived identifier before emitting the\ncanonical lowercased string."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"namespace"}),": trimmed slug (\u226432 chars) for grouping related events."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"name"}),": trimmed string (\u226448 chars) matching runtime naming conventions."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"version"}),": positive integer bumped whenever payload compatibility changes."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"payload"}),": discriminated union:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"zod"}),": ",(0,r.jsx)(n.code,{children:"{ kind: 'zod'; schemaPath: string }"})," referencing a TypeScript\nmodule exporting a Zod schema."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"jsonSchema"}),": ",(0,r.jsx)(n.code,{children:"{ kind: 'json-schema'; schemaPath: string }"})," referencing a\nJSON Schema document consumed by the generator."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"emits"}),": optional array of ",(0,r.jsx)(n.code,{children:"{ source: 'achievement' | 'upgrade' | 'transform' | 'script'; id: ContentId }"}),"\ndocumenting which content entries publish the event (surfaced in generated\ndocs)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tags"}),": optional analytics strings."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Normalisation always emits the canonical id (",(0,r.jsx)(n.code,{children:"namespace:name"}),") even when\nauthors omit the field so downstream references have a single stable key."]}),"\n",(0,r.jsxs)(n.li,{children:["Validation ensures schema paths remain pack-relative (rejecting absolute and\nparent-directory escapes), ",(0,r.jsx)(n.code,{children:"version"})," increments monotonically under\nnormalisation, and ",(0,r.jsx)(n.code,{children:"emits"})," references existing content ids so manifest\ndocumentation can hyperlink back into DSL definitions. File-system existence\nchecks continue to live in ",(0,r.jsx)(n.code,{children:"tools/content-schema-cli"}),", which already loads the\nmanifests and schema documents during ",(0,r.jsx)(n.code,{children:"pnpm generate"}),", so the schema package\nstays environment-agnostic while tooling preserves the authoring guarantees\ndocumented in ",(0,r.jsx)(n.code,{children:"docs/runtime-event-manifest-authoring.md"}),". Parsed\ncontributions feed the merge pipeline, which recomputes manifest hashes\nalongside runtime events to keep replay safeguards intact."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"516-content-pack-root-schema",children:"5.16 Content Pack Root Schema"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"contentPackSchema"})," composes the module schemas for structural validation and\ntype inference. The exported instance stays stateless so downstream tooling\ncan call ",(0,r.jsx)(n.code,{children:"contentPackSchema.parse"})," without inheriting warning collectors or\nruntime assumptions. This mirrors Zod's immutable API contract where methods\nalways return new schema instances (",(0,r.jsx)(n.a,{href:"https://raw.githubusercontent.com/colinhacks/zod/master/packages/zod/README.md#L86",children:"Zod README"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["A validator factory wraps the base schema with cross-reference checks,\nnormalisation, and warning aggregation. The allowlist inputs accept either\narrays or sets so CLI JSON/YAML configs remain ergonomic (JSON cannot encode\n",(0,r.jsx)(n.code,{children:"Set"})," values without custom replacers per\n",(0,r.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify",children:"MDN"}),"):"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ContentSchemaOptions.runtimeEventCatalogue"})," lets callers provide the core\nruntime event identifiers (for example, the union exported from\n",(0,r.jsx)(n.code,{children:"GENERATED_RUNTIME_EVENT_DEFINITIONS"}),") so the validator can flag dangling\n",(0,r.jsx)(n.code,{children:"onUnlockEvents"})," without importing ",(0,r.jsx)(n.code,{children:"@idle-engine/core"}),":"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ContentSchemaOptions.activePackIds"})," lists pack slugs already installed in\nthe authoring environment; optional dependencies missing from this concrete\nset emit warnings instead of quietly passing validation."]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"// z imported from 'zod'\ntype ContentId = z.infer<typeof contentIdSchema>;\ntype PackId = z.infer<typeof packSlugSchema>;\ntype AllowlistEntries = readonly string[] | ReadonlySet<string>;\n\ninterface AllowlistSpecInput {\n  readonly required?: AllowlistEntries;\n  readonly soft?: AllowlistEntries;\n}\n\ninterface NormalizedAllowlistSpec {\n  readonly required: ReadonlySet<string>;\n  readonly soft: ReadonlySet<string>;\n}\n\ntype SchemaWarningSeverity = 'error' | 'warning' | 'info';\n\nexport interface SchemaWarning {\n  readonly code: string;\n  readonly message: string;\n  readonly path: readonly (string | number)[];\n  readonly severity: SchemaWarningSeverity;\n  readonly suggestion?: string;\n  readonly issues?: readonly z.ZodIssue[];\n}\n\nexport interface ContentSchemaOptions {\n  readonly allowlists?: {\n    readonly flags?: AllowlistSpecInput;\n    readonly scripts?: AllowlistSpecInput;\n    readonly systemAutomationTargets?: AllowlistSpecInput;\n  };\n  readonly runtimeVersion?: string;\n  readonly knownPacks?: readonly {\n    readonly id: PackId;\n    readonly version: string;\n    readonly requires?: readonly {\n      readonly packId: PackId;\n      readonly version?: string;\n    }[];\n  }[];\n  readonly runtimeEventCatalogue?: AllowlistEntries;\n  readonly activePackIds?: AllowlistEntries;\n  readonly warningSink?: (warning: SchemaWarning) => void;\n}\n\nexport interface ContentPackValidationResult {\n  readonly pack: NormalizedContentPack;\n  readonly warnings: readonly SchemaWarning[];\n}\n\ntype ContentPackInput = z.input<typeof baseContentPackSchema>;\n\ntype ContentPackSafeParseSuccess = {\n  readonly success: true;\n  readonly data: ContentPackValidationResult;\n};\n\ntype ContentPackSafeParseFailure = {\n  readonly success: false;\n  readonly error: z.ZodError<ContentPackInput>;\n};\n\ntype ContentPackSafeParseResult =\n  | ContentPackSafeParseSuccess\n  | ContentPackSafeParseFailure;\n\nconst toArray = (entries: AllowlistEntries | undefined): readonly string[] =>\n  entries ? Array.from(entries) : [];\n\nconst normalizeAllowlistEntries = (\n  entries: AllowlistEntries | undefined,\n  schema: z.ZodType<string>,\n  severity: SchemaWarningSeverity,\n  warningSink: (warning: SchemaWarning) => void,\n  pathPrefix: readonly (string | number)[],\n): ReadonlySet<string> => {\n  const normalized = new Set<string>();\n  const issues: z.ZodIssue[] = [];\n  toArray(entries).forEach((value, index) => {\n    const result = schema.safeParse(value);\n    if (!result.success) {\n      const entryPath = [...pathPrefix, index];\n      if (severity === 'error') {\n        for (const issue of result.error.issues) {\n          issues.push({\n            ...issue,\n            path: [...entryPath, ...issue.path],\n          });\n        }\n        return;\n      }\n      warningSink({\n        code: severity === 'warning'\n          ? 'allowlist.invalidSoftEntry'\n          : 'allowlist.invalidEntry',\n        message: `Allowlist entry \"${value}\" failed validation.`,\n        path: entryPath,\n        severity,\n        issues: result.error.issues,\n      });\n      return;\n    }\n    normalized.add(result.data);\n  });\n  if (severity === 'error' && issues.length > 0) {\n    throw new z.ZodError(issues);\n  }\n  return normalized;\n};\n\nconst normalizeAllowlistSpec = (\n  spec: AllowlistSpecInput | undefined,\n  schema: z.ZodType<string>,\n  warningSink: (warning: SchemaWarning) => void,\n  pathPrefix: readonly (string | number)[],\n): NormalizedAllowlistSpec => ({\n  required: normalizeAllowlistEntries(\n    spec?.required,\n    schema,\n    'error',\n    warningSink,\n    [...pathPrefix, 'required'],\n  ),\n  soft: normalizeAllowlistEntries(\n    spec?.soft,\n    schema,\n    'warning',\n    warningSink,\n    [...pathPrefix, 'soft'],\n  ),\n});\n\nconst normalizeRuntimeEventCatalogue = (\n  entries: AllowlistEntries | undefined,\n): ReadonlySet<string> =>\n  new Set(\n    toArray(entries).map((eventType) => contentIdSchema.parse(eventType)),\n  );\n\nconst normalizeActivePackIds = (\n  entries: AllowlistEntries | undefined,\n): ReadonlySet<PackId> =>\n  new Set(toArray(entries).map((packId) => packSlugSchema.parse(packId)));\n\n// Reusing `contentIdSchema` keeps runtime catalogue entries canonicalised, so\n// downstream comparisons against author-supplied ids remain case-insensitive.\n// Invalid allowlist entries become contextual warnings for `soft` sets, while\n// `required` entries accumulate their underlying `ZodIssue`s and raise a fresh\n// `ZodError` whose paths point at `options.allowlists.<key>.required[index]`.\n// This mirrors Zod\u2019s guidance on surfacing issues from effects\n// (`superRefine` / `safeParse`) without discarding the enriched path metadata or\n// halting validation after the first failure.[^zod-superrefine]\n\nexport const FEATURE_GATES = [\n  {\n    module: 'automations',\n    introducedIn: '0.2.0',\n    docRef: 'docs/idle-engine-design.md (\xa76.2)',\n  },\n  {\n    module: 'transforms',\n    introducedIn: '0.3.0',\n    docRef: 'docs/idle-engine-design.md (\xa76.2)',\n  },\n  {\n    module: 'runtimeEvents',\n    introducedIn: '0.3.0',\n    docRef: 'docs/runtime-event-pubsub-design.md',\n  },\n  {\n    module: 'prestigeLayers',\n    introducedIn: '0.4.0',\n    docRef: 'docs/idle-engine-design.md (\xa76.2)',\n  },\n  {\n    module: 'guildPerks',\n    introducedIn: '0.5.0',\n    docRef: 'docs/idle-engine-design.md (\xa76.2)',\n  },\n] as const;\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The helper functions in ",(0,r.jsx)(n.code,{children:"runtime-compat.ts"})," expose ",(0,r.jsx)(n.code,{children:"resolveFeatureViolations( runtimeVersion, pack)"})," so ",(0,r.jsx)(n.code,{children:"validateCrossReferences"})," can emit structured errors\nfor unsupported modules while still allowing the CLI to display contextual\ndocumentation links."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"const baseContentPackSchema = z\n  .object({\n    metadata: metadataSchema,\n    resources: z.array(resourceDefinitionSchema),\n    generators: z.array(generatorDefinitionSchema),\n    upgrades: z.array(upgradeDefinitionSchema),\n    metrics: z.array(metricDefinitionSchema).default([]),\n    achievements: z.array(achievementDefinitionSchema).default([]),\n    automations: z.array(automationDefinitionSchema).default([]),\n    transforms: z.array(transformDefinitionSchema).default([]),\n    prestigeLayers: z.array(prestigeLayerSchema).default([]),\n    guildPerks: z.array(guildPerkSchema).default([]),\n    runtimeEvents: z.array(runtimeEventContributionSchema).default([]),\n  })\n  .strict();\n\nexport const contentPackSchema = baseContentPackSchema;\n\nconst buildContentPackEffectsSchema = (\n  options: ContentSchemaOptions,\n  warningSink: (warning: SchemaWarning) => void,\n) =>\n  baseContentPackSchema\n    .superRefine((pack, ctx) =>\n      validateCrossReferences(pack, ctx, {\n        allowlists: options.allowlists\n          ? {\n              flags: normalizeAllowlistSpec(\n                options.allowlists.flags,\n                flagIdSchema,\n                warningSink,\n                ['options', 'allowlists', 'flags'],\n              ),\n              scripts: normalizeAllowlistSpec(\n                options.allowlists.scripts,\n                scriptIdSchema,\n                warningSink,\n                ['options', 'allowlists', 'scripts'],\n              ),\n              systemAutomationTargets: normalizeAllowlistSpec(\n                options.allowlists.systemAutomationTargets,\n                systemAutomationTargetIdSchema,\n                warningSink,\n                ['options', 'allowlists', 'systemAutomationTargets'],\n              ),\n            }\n          : undefined,\n        warningSink,\n        runtimeEventCatalogue: normalizeRuntimeEventCatalogue(\n          options.runtimeEventCatalogue,\n        ),\n        runtimeVersion: options.runtimeVersion,\n        activePackIds: normalizeActivePackIds(options.activePackIds),\n      }),\n    )\n    .transform((pack) =>\n      normalizeContentPack(pack, {\n        runtimeVersion: options.runtimeVersion,\n        warningSink,\n      }),\n    );\n\nexport const createContentPackValidator = (\n  options: ContentSchemaOptions = {},\n) => ({\n  parse(input: unknown): ContentPackValidationResult {\n    const warnings: SchemaWarning[] = [];\n    const sink = (warning: SchemaWarning) => {\n      warnings.push(warning);\n      options.warningSink?.(warning);\n    };\n    const schema = buildContentPackEffectsSchema(options, sink);\n    const pack = schema.parse(input);\n    return { pack, warnings };\n  },\n  safeParse(input: unknown): ContentPackSafeParseResult {\n    const warnings: SchemaWarning[] = [];\n    const sink = (warning: SchemaWarning) => {\n      warnings.push(warning);\n      options.warningSink?.(warning);\n    };\n    const schema = buildContentPackEffectsSchema(options, sink);\n    const result = schema.safeParse(input);\n    if (result.success) {\n      const success: ContentPackSafeParseSuccess = {\n        success: true,\n        data: { pack: result.data, warnings },\n      };\n      return success;\n    }\n    const failure: ContentPackSafeParseFailure = {\n      success: false,\n      error: result.error,\n    };\n    return failure;\n  },\n});\n\nexport const parseContentPack = (\n  input: unknown,\n  options?: ContentSchemaOptions,\n): ContentPackValidationResult =>\n  createContentPackValidator(options).parse(input);\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"runtime-compat.ts"})," hosts the feature gate matrix consumed by the validator.\nHelper utilities such as ",(0,r.jsx)(n.code,{children:"resolveFeatureViolations(runtimeVersion, pack)"}),"\nsurface structured errors with links back to ",(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"})," and\n",(0,r.jsx)(n.code,{children:"docs/runtime-event-pubsub-design.md"})," so authors understand when newer modules\nrequire runtime upgrades."]}),"\n",(0,r.jsxs)(n.li,{children:["Consumers that need cross-reference enforcement, normalisation, or warnings\nuse ",(0,r.jsx)(n.code,{children:"createContentPackValidator().parse"})," (or ",(0,r.jsx)(n.code,{children:"parseContentPack"}),"). Every call\ncomposes a fresh ",(0,r.jsx)(n.code,{children:"ZodEffects"})," instance, preserving Zod's immutable guarantees\nand avoiding shared mutable state even when runs happen concurrently."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"safeParse"})," mirrors the standard Zod API: successful parses return the\nnormalised pack plus collected warnings, while failures surface the\n",(0,r.jsx)(n.code,{children:"ZodError<ContentPackInput>"})," emitted by ",(0,r.jsx)(n.code,{children:"SafeParseReturnType<Input, Output>"}),"\nso callers receive error paths in terms of the authored payload",(0,r.jsx)(n.sup,{children:(0,r.jsx)(n.a,{href:"#user-content-fn-zod-safeparse",id:"user-content-fnref-zod-safeparse","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"5"})}),".\nDirect calls to\n",(0,r.jsx)(n.code,{children:"contentPackSchema.parse"})," remain available for structural checks only (no\ncross-reference analysis or warnings)."]}),"\n"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"validateCrossReferences"})," performs:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Id uniqueness within each module. Resources, generators, upgrades, metrics,\nachievements, automations, transforms, prestige layers, guild perks, and\nruntime events reject duplicate slugs inside their respective arrays, while\ncross-module reuse remains legal so content authors can intentionally mirror\nnaming (for example, keeping an automation toggle slug aligned with the\nresource it affects). Reserved namespaces (such as the\n",(0,r.jsx)(n.code,{children:"idle-engine/"})," prefix) are still blocked globally."]}),"\n",(0,r.jsx)(n.li,{children:"Ensuring conditions reference defined ids across resources, generators,\nupgrades, prestige layers, and allowlisted flags and scripts; additional\ncondition variants will extend this graph as new predicates ship."}),"\n",(0,r.jsxs)(n.li,{children:["Verifying generator ",(0,r.jsx)(n.code,{children:"produces"})," / ",(0,r.jsx)(n.code,{children:"consumes"})," entries, upgrade ",(0,r.jsx)(n.code,{children:"targets"})," and\n",(0,r.jsx)(n.code,{children:"effects"})," (by ",(0,r.jsx)(n.code,{children:"kind"}),"), metric bindings, achievement ",(0,r.jsx)(n.code,{children:"track"})," handles,\nautomation\n",(0,r.jsx)(n.code,{children:"targetId"}),"/",(0,r.jsx)(n.code,{children:"systemTargetId"})," and event-trigger handles, transform\n",(0,r.jsx)(n.code,{children:"inputs"}),"/",(0,r.jsx)(n.code,{children:"outputs"})," plus optional ",(0,r.jsx)(n.code,{children:"automationId"}),", runtime event ",(0,r.jsx)(n.code,{children:"emits"}),"\nhandles, and prestige reset/reward resources resolve against\ndeclared entities, matching the pipeline guarantees laid out in\n",(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"})," \xa76.2."]}),"\n",(0,r.jsxs)(n.li,{children:["Checking ",(0,r.jsx)(n.code,{children:"customMetric"})," achievement tracks and automation/resource bindings\nagainst the pack's metric catalogue, verifying metric ",(0,r.jsx)(n.code,{children:"source"})," hooks (e.g.,\nscript bindings) against the relevant allowlists, emitting errors when\nreferences are missing, and warnings when metrics declare attribute sets\nexceeding three keys (to deter high-cardinality exports)."]}),"\n",(0,r.jsxs)(n.li,{children:["Enforcing runtime feature gates by comparing the parsed pack to the\n",(0,r.jsx)(n.code,{children:"FEATURE_GATES"})," map. When ",(0,r.jsx)(n.code,{children:"ContentSchemaOptions.runtimeVersion"})," is provided,\nmodules declared in the pack must satisfy their minimum runtime ranges; the\nvalidator emits errors for hard violations and warnings when the pack relies\non features newer than the supplied runtime."]}),"\n",(0,r.jsxs)(n.li,{children:["Validating ",(0,r.jsx)(n.code,{children:"metadata.dependencies"})," by checking for self-references, duplicate\npack ids, conflicting version ranges, and dependency cycles. When callers\nsupply ",(0,r.jsx)(n.code,{children:"ContentSchemaOptions.knownPacks"}),", the validator merges the pack's\n",(0,r.jsx)(n.code,{children:"requires"})," edges with the known graph (using the optional\n",(0,r.jsx)(n.code,{children:"requires"})," metadata on each known pack) to detect multi-pack cycles and flag\nincompatible version ranges. When ",(0,r.jsx)(n.code,{children:"knownPacks"})," lacks an entry for a declared\ndependency, the validator records a warning (so unpublished packs remain\nauthorable) while still catching self-references and duplicate ids.\nOptional dependencies compare against ",(0,r.jsx)(n.code,{children:"options.activePackIds"}),"; entries\nmissing from that concrete set emit ",(0,r.jsx)(n.code,{children:"optionalDependency.missing"})," warnings,\nwhile absent context downgrades the check to an informational note."]}),"\n",(0,r.jsx)(n.li,{children:"Detecting orphaned prestige currencies (reward resources marked prestige but\nnot defined)."}),"\n",(0,r.jsxs)(n.li,{children:["Blocking ids that attempt to use engine-reserved namespace segments (e.g.,\nan ",(0,r.jsx)(n.code,{children:"idle-engine/"})," prefix), complementing the ",(0,r.jsx)(n.code,{children:"contentIdSchema"})," slug rules."]}),"\n",(0,r.jsxs)(n.li,{children:["Resolving ",(0,r.jsx)(n.code,{children:"flag"})," and ",(0,r.jsx)(n.code,{children:"script"})," conditions against the caller-provided\nallowlists using their canonical slug forms, treating ids in the ",(0,r.jsx)(n.code,{children:"required"}),"\nsets as hard dependencies while emitting warnings when lookups fail for\nentries marked ",(0,r.jsx)(n.code,{children:"soft"}),". Invalid allowlist entries are caught during\nnormalisation via the ",(0,r.jsx)(n.code,{children:"allowlist.invalid*"})," warning codes so misconfigured\noptions surface as structured errors instead of exploding during schema\nconstruction. The same lookups cover ",(0,r.jsx)(n.code,{children:"grantFlag"})," upgrade effects and\nachievement rewards so flags cannot be granted unless they are declared in\nthe active allowlist."]}),"\n",(0,r.jsxs)(n.li,{children:["Rejecting runtime event contributions whose canonical id collides with an\nentry in the caller-supplied catalogue (including core manifests). The\nruntime bus refuses duplicate registrations already\n(",(0,r.jsx)(n.code,{children:"packages/core/src/events/event-bus.ts:330"}),"), so catching collisions during\nschema validation keeps packs from producing manifests that would fail at\nbootstrap time."]}),"\n",(0,r.jsxs)(n.li,{children:["Confirming ",(0,r.jsx)(n.code,{children:"achievementDefinition.onUnlockEvents"})," ids exist in the merged\nruntime event catalogue built from the pack's own contributions plus the\ncaller-supplied ",(0,r.jsx)(n.code,{children:"ContentSchemaOptions.runtimeEventCatalogue"}),". When the\ncatalogue is provided, missing ids become structured errors so packs cannot\nship dangling hooks into the event bus defined in\n",(0,r.jsx)(n.code,{children:"docs/runtime-event-pubsub-design.md"}),"; if the caller omits the catalogue, the\nvalidator emits warnings instead to keep authoring possible before the core\nmanifest is available locally."]}),"\n",(0,r.jsxs)(n.li,{children:["Detecting cyclic dependencies across unlock and visibility conditions by\nconstructing a monotonic dependency graph. Nodes cover the entity classes\nthat conditions can reference directly (",(0,r.jsx)(n.code,{children:"resources"}),", ",(0,r.jsx)(n.code,{children:"generators"}),",\n",(0,r.jsx)(n.code,{children:"upgrades"}),", ",(0,r.jsx)(n.code,{children:"prestigeLayers"}),", plus allowlisted ",(0,r.jsx)(n.code,{children:"flags"}),"/",(0,r.jsx)(n.code,{children:"scripts"}),") and extend\nto ",(0,r.jsx)(n.code,{children:"automations"}),", ",(0,r.jsx)(n.code,{children:"transforms"}),", ",(0,r.jsx)(n.code,{children:"guildPerks"}),", and ",(0,r.jsx)(n.code,{children:"achievements"})," through the\nderived relationships captured elsewhere in the schema (for example upgrade\n",(0,r.jsx)(n.code,{children:"targets"}),", automation bindings, and transform references). Positive\npredicates (thresholds, ownership, allowlisted flags/scripts) and the\nderived relationships above produce graph edges. Negated predicates and\n",(0,r.jsx)(n.code,{children:"anyOf"})," disjunction branches remain advisory constraints and are excluded\nfrom the strongly connected component walk, preventing absence-based gating\nfrom masquerading as a positive cycle. Depth-first search with path tracking\nraises a structured error when a positive loop (",(0,r.jsx)(n.code,{children:"A \u2192 B \u2192 \u2026 \u2192 A"}),") is\ndiscovered, pointing at the chain of ids that must be broken."]}),"\n",(0,r.jsxs)(n.li,{children:["Walking every ",(0,r.jsx)(n.code,{children:"numericFormulaSchema"})," node\u2014including nested ",(0,r.jsx)(n.code,{children:"piecewise"}),"\nsegments, expression trees, and function call arguments\u2014to collect\n",(0,r.jsx)(n.code,{children:"{ target: { type, id } }"})," references. Each referenced id is validated\nagainst the same lookup tables used for conditions, guaranteeing that\nauthored formulas cannot silently reference undefined resources, generators,\nupgrades, automations, or prestige layers."]}),"\n",(0,r.jsxs)(n.li,{children:["Emitting warnings (captured via ",(0,r.jsx)(n.code,{children:"SchemaWarning"})," array) for soft issues such\nas steep cost curves or missing localisation variants."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"normalizeContentPack"})," sorts arrays deterministically, injects derived lookup\nmaps, applies default booleans, and produces hashes used by the compiler."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"517-normalisation--derived-artifacts",children:"5.17 Normalisation & Derived Artifacts"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"normalizeContentPack"})," returns a ",(0,r.jsx)(n.code,{children:"NormalizedContentPack"}),":"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"type ContentId = z.infer<typeof contentIdSchema>;\ntype PackId = z.infer<typeof packSlugSchema>;\n\ninterface NormalizedContentPack {\n  readonly metadata: NormalizedMetadata;\n  readonly resources: readonly NormalizedResource[];\n  readonly generators: readonly NormalizedGenerator[];\n  readonly upgrades: readonly NormalizedUpgrade[];\n  readonly metrics: readonly NormalizedMetric[];\n  readonly achievements: readonly NormalizedAchievement[];\n  readonly automations: readonly NormalizedAutomation[];\n  readonly transforms: readonly NormalizedTransform[];\n  readonly prestigeLayers: readonly NormalizedPrestigeLayer[];\n  readonly guildPerks: readonly NormalizedGuildPerk[];\n  readonly runtimeEvents: readonly NormalizedRuntimeEventContribution[];\n  readonly lookup: {\n    readonly resources: ReadonlyMap<ContentId, NormalizedResource>;\n    readonly generators: ReadonlyMap<ContentId, NormalizedGenerator>;\n    readonly upgrades: ReadonlyMap<ContentId, NormalizedUpgrade>;\n    readonly metrics: ReadonlyMap<ContentId, NormalizedMetric>;\n    readonly achievements: ReadonlyMap<ContentId, NormalizedAchievement>;\n    readonly automations: ReadonlyMap<ContentId, NormalizedAutomation>;\n    readonly transforms: ReadonlyMap<ContentId, NormalizedTransform>;\n    readonly prestigeLayers: ReadonlyMap<ContentId, NormalizedPrestigeLayer>;\n    readonly guildPerks: ReadonlyMap<ContentId, NormalizedGuildPerk>;\n    readonly runtimeEvents: ReadonlyMap<\n      ContentId,\n      NormalizedRuntimeEventContribution\n    >;\n  };\n  readonly serializedLookup: {\n    readonly resourceById: Readonly<Record<string, NormalizedResource>>;\n    readonly generatorById: Readonly<Record<string, NormalizedGenerator>>;\n    readonly upgradeById: Readonly<Record<string, NormalizedUpgrade>>;\n    readonly metricById: Readonly<Record<string, NormalizedMetric>>;\n    readonly achievementById: Readonly<Record<string, NormalizedAchievement>>;\n    readonly automationById: Readonly<Record<string, NormalizedAutomation>>;\n    readonly transformById: Readonly<Record<string, NormalizedTransform>>;\n    readonly prestigeLayerById: Readonly<\n      Record<string, NormalizedPrestigeLayer>\n    >;\n    readonly guildPerkById: Readonly<Record<string, NormalizedGuildPerk>>;\n    readonly runtimeEventById: Readonly<\n      Record<string, NormalizedRuntimeEventContribution>\n    >;\n  };\n  readonly digest: {\n    readonly version: number;\n    readonly hash: string;\n  };\n}\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"normalizeContentPack"})," accepts a ",(0,r.jsx)(n.code,{children:"NormalizationContext"})," containing the active\nruntime version (for compatibility checks) and the shared warning sink used\nby cross-reference validation."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"NormalizedMetadata"})," preserves the ",(0,r.jsx)(n.code,{children:"PackId"})," brand on ",(0,r.jsx)(n.code,{children:"id"}),", keeping downstream\ndependency graphs scoped-id aware."]}),"\n",(0,r.jsxs)(n.li,{children:["Lookup maps retain the ",(0,r.jsx)(n.code,{children:"ContentId"})," brand by exposing immutable ",(0,r.jsx)(n.code,{children:"ReadonlyMap"}),"\ninstances for every module (resources, generators, upgrades, metrics,\nachievements, automations, transforms, prestige layers, guild perks, runtime\nevents). ",(0,r.jsx)(n.code,{children:"serializedLookup"})," carries the downgraded ",(0,r.jsx)(n.code,{children:"Record<string, \u2026>"})," copies\nused when emitting JSON so transport layers can remain brand-agnostic without\npolluting consumer types. Helper utilities convert between the two\nrepresentations when persisting or hydrating packs."]}),"\n",(0,r.jsxs)(n.li,{children:["With metadata already parsed, ",(0,r.jsx)(n.code,{children:"normalizeContentPack"})," threads the resulting\n",(0,r.jsx)(n.code,{children:"NormalizedMetadata"})," into ",(0,r.jsx)(n.code,{children:"normalizeLocalizedText"})," calls for titles, names,\nsummaries, and descriptions so locale mirroring and missing-translation\nwarnings stay consistent across modules."]}),"\n",(0,r.jsxs)(n.li,{children:["Metric normalisation emits ",(0,r.jsx)(n.code,{children:"NormalizedMetric"})," entries with sorted attribute\nkeys, deduplicated values, the ",(0,r.jsx)(n.code,{children:"'1'"})," unit fallback, and resolved source\nbindings so telemetry exports and CLI reports stay deterministic."]}),"\n",(0,r.jsx)(n.li,{children:"Digests use FNV-1a hashing aligned with runtime manifest hashing. Version\nincrements whenever schema-breaking transformations occur. The hash excludes\ntransient warning data so identical author input yields stable digests even\nwhen the warning set changes."}),"\n",(0,r.jsxs)(n.li,{children:["Warnings follow the ",(0,r.jsx)(n.code,{children:"SchemaWarning"})," contract (",(0,r.jsx)(n.code,{children:"{ code, message, path, severity, suggestion?, issues? }"}),") to support CLI displays and are returned\nalongside the normalized pack by the validator factory instead of being\nembedded in the normalized structure."]}),"\n",(0,r.jsxs)(n.li,{children:["Normalisation ensures arrays apply author-specified ordering keys when they\nexist (",(0,r.jsx)(n.code,{children:"order"})," on resources/generators/upgrades/metrics/automations/transforms/\nprestige/guild perks and ",(0,r.jsx)(n.code,{children:"displayOrder"})," on achievements) and then fall back to\ncanonical id comparisons, providing deterministic ties when authors omit\nexplicit ordering. This avoids relying on JavaScript engine sort stability,\nkeeps digests repeatable across runtimes, strips duplicate tags, and freezes\nstring casing (ids lowercased, labels preserved). Helper utilities serialise\nthe ",(0,r.jsx)(n.code,{children:"ReadonlyMap"})," lookups into the accompanying ",(0,r.jsx)(n.code,{children:"serializedLookup"})," object for\npersistence, and hydrate them back into branded maps when content packs are\nloaded."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"518-implementation-plan",children:"5.18 Implementation Plan"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Scaffold ",(0,r.jsx)(n.code,{children:"packages/content-schema"})," with base tooling (tsconfig, lint, test)."]}),"\n",(0,r.jsxs)(n.li,{children:["Implement scalar schemas (",(0,r.jsx)(n.code,{children:"ids"}),", ",(0,r.jsx)(n.code,{children:"numbers"}),", ",(0,r.jsx)(n.code,{children:"localization"}),") with unit tests."]}),"\n",(0,r.jsxs)(n.li,{children:["Land ",(0,r.jsx)(n.code,{children:"numericFormulaSchema"})," and ",(0,r.jsx)(n.code,{children:"conditionSchema"}),", including recursion guard\ntests and snapshot fixtures."]}),"\n",(0,r.jsxs)(n.li,{children:["Implement module schemas incrementally with targeted validation tests:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"metadata"})," (including ",(0,r.jsx)(n.code,{children:"dependencies"}),"), ",(0,r.jsx)(n.code,{children:"resources"}),", ",(0,r.jsx)(n.code,{children:"generators"}),",\n",(0,r.jsx)(n.code,{children:"upgrades"}),", ",(0,r.jsx)(n.code,{children:"metrics"}),", ",(0,r.jsx)(n.code,{children:"achievements"}),", ",(0,r.jsx)(n.code,{children:"automations"}),", ",(0,r.jsx)(n.code,{children:"transforms"}),",\n",(0,r.jsx)(n.code,{children:"prestige"}),", ",(0,r.jsx)(n.code,{children:"guild-perks"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Add the runtime event contribution schema and manifest validation that\nmirrors ",(0,r.jsx)(n.code,{children:"docs/runtime-event-manifest-authoring.md"}),", including fixtures for\ninvalid schema paths and duplicate ids."]}),"\n",(0,r.jsxs)(n.li,{children:["Compose ",(0,r.jsx)(n.code,{children:"contentPackSchema"}),", wire up ",(0,r.jsx)(n.code,{children:"createContentPackValidator"})," with a\nshared warning collector, implement ",(0,r.jsx)(n.code,{children:"validateCrossReferences"})," (including the\nnumeric-formula reference walk and cross-module cycle detector), and add\nfailing fixtures covering duplicate ids, missing references, invalid\nformulas, and intertwined unlock loops."]}),"\n",(0,r.jsxs)(n.li,{children:["Implement ",(0,r.jsx)(n.code,{children:"normalizeContentPack"}),", compute digests, and expose typed lookup\nmaps."]}),"\n",(0,r.jsxs)(n.li,{children:["Update ",(0,r.jsx)(n.code,{children:"tools/content-schema-cli"})," to consume the new package (follow-up PR),\nmirroring the structured error responses already used by social service\nroutes. Wire validation into ",(0,r.jsx)(n.code,{children:"pnpm test --filter content-schema"})," and add a\nlightweight ",(0,r.jsx)(n.code,{children:"pnpm generate"})," step that refreshes schema digests alongside the\nevent manifest pipeline."]}),"\n",(0,r.jsxs)(n.li,{children:["Port ",(0,r.jsx)(n.code,{children:"packages/content-sample"})," to validate via the schema in a separate\nchange once the package stabilises."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"519-authoring-best-practices",children:"5.19 Authoring Best Practices"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Provide human-readable error summaries and include ",(0,r.jsx)(n.code,{children:"path"})," data so CLI\nconsumers can surface issues consistently with existing Express handlers."]}),"\n",(0,r.jsx)(n.li,{children:"Memoise normalised lookup maps between CLI runs to reduce validation latency\nfor large packs."}),"\n",(0,r.jsxs)(n.li,{children:["Normalise casing and deterministically sort arrays before hashing so content\ndigests align with ",(0,r.jsx)(n.code,{children:"docs/runtime-event-manifest-authoring.md"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Document schema additions in ",(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"})," and call out\nmigrations in ",(0,r.jsx)(n.code,{children:"docs/implementation-plan.md"})," to keep the DSL contract in sync\nwith runtime workstreams."]}),"\n",(0,r.jsxs)(n.li,{children:["Run ",(0,r.jsx)(n.code,{children:"pnpm generate"})," after editing pack sources; the CLI validates packs via ",(0,r.jsx)(n.code,{children:"@idle-engine/content-schema"}),", then compiles artifacts once validation succeeds, emitting structured JSON log entries (",(0,r.jsx)(n.code,{children:"content_pack.validated"}),", ",(0,r.jsx)(n.code,{children:"content_pack.validation_failed"}),", ",(0,r.jsx)(n.code,{children:"content_pack.compiled"}),", ",(0,r.jsx)(n.code,{children:"watch.run"}),", etc.) for downstream automation."]}),"\n",(0,r.jsxs)(n.li,{children:["Use ",(0,r.jsx)(n.code,{children:"pnpm generate --check"})," in CI, Lefthook, and verification scripts to detect drift without rewriting artifacts. ",(0,r.jsx)(n.code,{children:"--watch"})," keeps the pipeline alive during authoring but still marks failures while emitting ",(0,r.jsx)(n.code,{children:"watch.run"})," summaries so you can fix issues before exit."]}),"\n",(0,r.jsxs)(n.li,{children:["Treat ",(0,r.jsx)(n.code,{children:"content/compiled/index.json"})," (or any path supplied via ",(0,r.jsx)(n.code,{children:"--summary"}),") as the canonical workspace summary. If validation fails or the CLI reports drift, rerun ",(0,r.jsx)(n.code,{children:"pnpm generate"})," before consuming the summary or committing compiled artifacts to avoid shipping stale data."]}),"\n",(0,r.jsxs)(n.li,{children:["Keep authoring sources in ",(0,r.jsx)(n.code,{children:"<package>/content/pack.json"}),", resolve warnings before publishing, and annotate intentional suppressions so migration scripts can distinguish deliberate exceptions from regressions."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"6-testing-strategy",children:"6. Testing Strategy"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Unit tests for each schema module covering success and failure cases, ensuring\nerror messages include context (id, field path, offending value)."}),"\n",(0,r.jsxs)(n.li,{children:["Property-based tests for ",(0,r.jsx)(n.code,{children:"numericFormulaSchema"})," ensuring generated exponential\nor linear curves remain finite and monotonic where required."]}),"\n",(0,r.jsx)(n.li,{children:"Integration fixtures for full packs: valid sample pack, pack missing resource\nreferences, pack with cyclic unlock conditions, pack with localisation gaps,\npack with dependency cycles, and pack with invalid runtime event contributions\n(missing schema paths or duplicate ids)."}),"\n",(0,r.jsxs)(n.li,{children:["Validator factory tests ensure ",(0,r.jsx)(n.code,{children:"createContentPackValidator"})," returns collected\nwarnings (missing translations, flagged scripts) alongside normalised packs."]}),"\n",(0,r.jsxs)(n.li,{children:["Snapshot tests for ",(0,r.jsx)(n.code,{children:"normalizeContentPack"})," verifying deterministic ordering and\ndigest stability."]}),"\n",(0,r.jsxs)(n.li,{children:["Type-level tests (using ",(0,r.jsx)(n.code,{children:"expectTypeOf"}),") to ensure inferred types align with\nruntime expectations."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"7-risks--mitigations",children:"7. Risks & Mitigations"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Formula explosion"}),": Recursive expression parsing may allow deeply nested\nstructures, risking performance issues. Mitigate with recursion depth limits\nand AST node count caps inside ",(0,r.jsx)(n.code,{children:"expressionNodeSchema"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Schema drift vs runtime"}),": Runtime may evolve faster than schema updates.\nMitigate by adding CI checks that ",(0,r.jsx)(n.code,{children:"@idle-engine/core"})," validates resource\ndefinitions against the schema digest before publish."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Author friction"}),": Strict schemas may frustrate early adopters. Mitigate\nwith descriptive error messages and non-fatal warnings for soft constraints."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Compatibility versioning"}),": Packs targeting older runtime versions must\ncontinue to parse. Mitigate by versioning schema transforms and allowing the\ncompiler to downgrade gracefully when ",(0,r.jsx)(n.code,{children:"metadata.engine"})," excludes new features."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Transform loops"}),": Misconfigured transforms may create runaway production\nchains. Mitigate by enforcing ",(0,r.jsx)(n.code,{children:"safety"})," guards in the schema and covering loop\ndetection in integration tests."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Performance"}),": Running complex validation on large content packs could be\nslow. Mitigate by caching normalised results and reusing lookup maps between\nCLI runs."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"8-decisions--clarifications",children:"8. Decisions & Clarifications"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Ids are case-insensitive in validation but canonicalised to lowercase for\ndeterministic hashing; ",(0,r.jsx)(n.code,{children:"contentIdSchema"})," performs the lowercasing transform\nso display casing belongs exclusively in localisation strings."]}),"\n",(0,r.jsxs)(n.li,{children:["Pack metadata and dependency edges use ",(0,r.jsx)(n.code,{children:"packSlugSchema"}),", allowing scoped\nidentifiers such as ",(0,r.jsx)(n.code,{children:"@idle-engine/core"})," while other module ids continue to\nrely on the stricter ",(0,r.jsx)(n.code,{children:"contentIdSchema"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Schemas reject unknown keys to catch typos early; authors must explicitly\ninclude new fields when the schema evolves."}),"\n",(0,r.jsxs)(n.li,{children:["Localised strings require at least the default locale; additional variants are\noptional but flagged when missing for locales declared in\n",(0,r.jsx)(n.code,{children:"metadata.supportedLocales"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Numeric formulas accept finite numbers only; ",(0,r.jsx)(n.code,{children:"Infinity"})," is modelled through\nexplicit flags (",(0,r.jsx)(n.code,{children:"capacity: null"}),") instead of raw numeric values."]}),"\n",(0,r.jsx)(n.li,{children:"Warnings are returned alongside the normalised payload; it is up to CLI and\ncompiler tooling to decide whether to treat specific warning codes as errors."}),"\n",(0,r.jsxs)(n.li,{children:["Lookup tables are serialized as plain objects for transport; helper utilities\ncreate transient ",(0,r.jsx)(n.code,{children:"Map"})," views when callers need richer ergonomics."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"9-acceptance-criteria",children:"9. Acceptance Criteria"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"packages/content-schema"})," exists with exported schemas, inferred types, and\nVitest coverage across every module (metadata + dependencies, resources,\ngenerators, upgrades, metrics, achievements, automations, transforms, prestige,\nguild perks, runtime event contributions)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"createContentPackValidator.parse"})," (and the exported ",(0,r.jsx)(n.code,{children:"parseContentPack"}),"\nhelper) validate sample fixtures, emit expected warnings, and produce deterministic\nnormalised output with digest metadata, serialisable lookup objects, and\nbranded ",(0,r.jsx)(n.code,{children:"ContentId"})," keyed maps."]}),"\n",(0,r.jsxs)(n.li,{children:["Cross-reference validation rejects packs with missing or duplicate ids,\ndangling conditions, invalid formula references, runtime event contributions\nthat cite unknown emitters, and dependency cycles whenever the caller\nprovides sufficient ",(0,r.jsx)(n.code,{children:"knownPacks.requires"})," data to build the cross-pack graph."]}),"\n",(0,r.jsxs)(n.li,{children:["Runtime compatibility gates reject packs that include modules introduced after\nthe target runtime (",(0,r.jsx)(n.code,{children:"ContentSchemaOptions.runtimeVersion"}),"), while emitting\ncontextual warnings when the pack straddles newer features."]}),"\n",(0,r.jsxs)(n.li,{children:["Achievement ",(0,r.jsx)(n.code,{children:"onUnlockEvents"})," lists are validated against the merged runtime\nevent catalogue so packs cannot ship dangling hooks."]}),"\n",(0,r.jsxs)(n.li,{children:["Localisation checks ensure ",(0,r.jsx)(n.code,{children:"metadata.supportedLocales"})," lists are honoured and\nmissing variants surface as structured warnings."]}),"\n",(0,r.jsxs)(n.li,{children:["Documentation updates link this design with ",(0,r.jsx)(n.code,{children:"docs/implementation-plan.md"}),"\nand ",(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["A follow-up work item is opened to integrate the schema into\n",(0,r.jsx)(n.code,{children:"tools/content-schema-cli"})," and the sample content pack."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"10-open-questions--follow-ups",children:"10. Open Questions & Follow-Ups"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Should the schema expose calculated presentation defaults (e.g., auto-generated\nicon paths) or leave that to the compiler?"}),"\n",(0,r.jsx)(n.li,{children:"How will guild perk costs interface with social-service data when live\npersistence lands?"}),"\n",(0,r.jsx)(n.li,{children:"Do we need additional effect types (e.g., scripted modifiers) before schema\nv1.0, or can they wait for the scripting design doc?"}),"\n",(0,r.jsx)(n.li,{children:"What is the migration strategy when schema digests change (e.g., do we embed\nthe digest into save files similar to event manifests)?"}),"\n",(0,r.jsx)(n.li,{children:"Migrate remaining TypeScript/hand-authored sample data into the CLI-discoverable pack format and ensure the forthcoming DSL compiler emits the same schema-normalised structures."}),"\n"]}),"\n","\n",(0,r.jsxs)(n.section,{"data-footnotes":!0,className:"footnotes",children:[(0,r.jsx)(n.h2,{className:"sr-only",id:"footnote-label",children:"Footnotes"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{id:"user-content-fn-npm-scope",children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.em,{children:"Scoped packages"})," \u2014 npm Docs. Demonstrates npm\u2019s scoped package\nnaming convention using ",(0,r.jsx)(n.code,{children:"@myorg/mypackage"}),", which the schema mirrors so packs\ncan reference scoped workspace ids. ",(0,r.jsx)(n.a,{href:"https://docs.npmjs.com/cli/v10/using-npm/scope",children:"https://docs.npmjs.com/cli/v10/using-npm/scope"})," ",(0,r.jsx)(n.a,{href:"#user-content-fnref-npm-scope","data-footnote-backref":"","aria-label":"Back to reference 1",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{id:"user-content-fn-non-monotonic",children:["\n",(0,r.jsxs)(n.p,{children:['"Non-monotonic logic" \u2014 Wikipedia. Notes that adding new\ninformation can invalidate prior inferences, so negative knowledge behaves\nnon-monotonically and must be modelled separately from positive dependency\nedges. ',(0,r.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Non-monotonic_logic",children:"https://en.wikipedia.org/wiki/Non-monotonic_logic"})," ",(0,r.jsx)(n.a,{href:"#user-content-fnref-non-monotonic","data-footnote-backref":"","aria-label":"Back to reference 2",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{id:"user-content-fn-otel-metrics-api",children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.em,{children:"Metrics API"})," \u2014 OpenTelemetry Specification. Highlights\ninstrument identity across ",(0,r.jsx)(n.code,{children:"name"}),", ",(0,r.jsx)(n.code,{children:"kind"}),", ",(0,r.jsx)(n.code,{children:"unit"}),", and ",(0,r.jsx)(n.code,{children:"description"}),", guiding\nschema fields for metrics authored by packs.\n",(0,r.jsx)(n.a,{href:"https://raw.githubusercontent.com/open-telemetry/opentelemetry-specification/main/specification/metrics/api.md",children:"https://raw.githubusercontent.com/open-telemetry/opentelemetry-specification/main/specification/metrics/api.md"})," ",(0,r.jsx)(n.a,{href:"#user-content-fnref-otel-metrics-api","data-footnote-backref":"","aria-label":"Back to reference 3",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{id:"user-content-fn-core-automation-tests",children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"packages/core/src/index.test.ts:676"})," and\n",(0,r.jsx)(n.code,{children:"packages/core/src/index.test.ts:700"})," exercise automation toggles keyed by\ncanonical ids when emitting runtime events, underscoring why transform\nautomation triggers must capture the exact ",(0,r.jsx)(n.code,{children:"automationId"}),". ",(0,r.jsx)(n.a,{href:"#user-content-fnref-core-automation-tests","data-footnote-backref":"","aria-label":"Back to reference 4",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{id:"user-content-fn-zod-safeparse",children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"SafeParseReturnType<Input, Output>"})," and\n",(0,r.jsx)(n.code,{children:"SafeParseError<Input>"})," from the published ",(0,r.jsx)(n.code,{children:"zod@3.23.8"})," type definitions show\nthat failure errors are parameterised over the input payload. See\n",(0,r.jsx)(n.code,{children:"package/v3/types.d.ts"})," lines 44-70 inside the npm tarball:\n",(0,r.jsx)(n.a,{href:"https://registry.npmjs.org/zod/-/zod-3.23.8.tgz",children:"https://registry.npmjs.org/zod/-/zod-3.23.8.tgz"})," ",(0,r.jsx)(n.a,{href:"#user-content-fnref-zod-safeparse","data-footnote-backref":"","aria-label":"Back to reference 5",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},7678:(e,n,i)=>{i.d(n,{R:()=>c,x:()=>o});var s=i(9430);const r={},t=s.createContext(r);function c(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);