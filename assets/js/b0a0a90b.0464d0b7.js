"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[8806],{6747:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"automation-execution-system-design","title":"Runtime Automation Execution System Design","description":"Document Control","source":"@site/../../docs/automation-execution-system-design.md","sourceDirName":".","slug":"/automation-execution-system-design","permalink":"/Idle-Game-Engine/automation-execution-system-design","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/automation-execution-system-design.md","tags":[],"version":"current","sidebarPosition":12,"frontMatter":{"title":"Runtime Automation Execution System Design","sidebar_position":12}}');var s=t(5270),r=t(7678);const o={title:"Runtime Automation Execution System Design",sidebar_position:12},a="Runtime Automation Execution System Design",l={},d=[{value:"Document Control",id:"document-control",level:2},{value:"1. Summary",id:"1-summary",level:2},{value:"2. Context &amp; Problem Statement",id:"2-context--problem-statement",level:2},{value:"Background",id:"background",level:3},{value:"Problem",id:"problem",level:3},{value:"Forces",id:"forces",level:3},{value:"3. Goals &amp; Non-Goals",id:"3-goals--non-goals",level:2},{value:"Goals",id:"goals",level:3},{value:"Non-Goals",id:"non-goals",level:3},{value:"4. Stakeholders, Agents &amp; Impacted Surfaces",id:"4-stakeholders-agents--impacted-surfaces",level:2},{value:"Primary Stakeholders",id:"primary-stakeholders",level:3},{value:"Agent Roles",id:"agent-roles",level:3},{value:"Affected Packages/Services",id:"affected-packagesservices",level:3},{value:"Compatibility Considerations",id:"compatibility-considerations",level:3},{value:"5. Current State",id:"5-current-state",level:2},{value:"Existing Infrastructure",id:"existing-infrastructure",level:3},{value:"Gaps",id:"gaps",level:3},{value:"6. Proposed Solution",id:"6-proposed-solution",level:2},{value:"6.1 Architecture Overview",id:"61-architecture-overview",level:3},{value:"6.2 Detailed Design",id:"62-detailed-design",level:3},{value:"6.2.1 State Management",id:"621-state-management",level:4},{value:"6.2.2 Trigger Evaluation Algorithms",id:"622-trigger-evaluation-algorithms",level:4},{value:"6.2.3 Command Enqueueing",id:"623-command-enqueueing",level:4},{value:"6.2.4 Resource Cost Handling",id:"624-resource-cost-handling",level:4},{value:"6.2.5 Cooldown Management",id:"625-cooldown-management",level:4},{value:"6.2.6 System Implementation",id:"626-system-implementation",level:4},{value:"6.2.7 Integration with Runtime Worker",id:"627-integration-with-runtime-worker",level:4},{value:"6.3 Operational Considerations",id:"63-operational-considerations",level:3},{value:"Deployment",id:"deployment",level:4},{value:"Telemetry &amp; Observability",id:"telemetry--observability",level:4},{value:"Security &amp; Compliance",id:"security--compliance",level:4},{value:"7. Work Breakdown &amp; Delivery Plan",id:"7-work-breakdown--delivery-plan",level:2},{value:"7.1 Issue Map",id:"71-issue-map",level:3},{value:"7.2 Milestones",id:"72-milestones",level:3},{value:"7.3 Coordination Notes",id:"73-coordination-notes",level:3},{value:"8. Agent Guidance &amp; Guardrails",id:"8-agent-guidance--guardrails",level:2},{value:"Context Packets",id:"context-packets",level:3},{value:"Prompting &amp; Constraints",id:"prompting--constraints",level:3},{value:"Safety Rails",id:"safety-rails",level:3},{value:"Validation Hooks",id:"validation-hooks",level:3},{value:"9. Alternatives Considered",id:"9-alternatives-considered",level:2},{value:"Alternative 1: Poll-Based Trigger Evaluation",id:"alternative-1-poll-based-trigger-evaluation",level:3},{value:"Alternative 2: Separate Automation Worker",id:"alternative-2-separate-automation-worker",level:3},{value:"Alternative 3: Lua/JS Scripting for Custom Triggers",id:"alternative-3-luajs-scripting-for-custom-triggers",level:3},{value:"10. Testing &amp; Validation Plan",id:"10-testing--validation-plan",level:2},{value:"Unit Tests",id:"unit-tests",level:3},{value:"Integration Tests",id:"integration-tests",level:3},{value:"Performance Tests",id:"performance-tests",level:3},{value:"Property-Based Tests",id:"property-based-tests",level:3},{value:"Accessibility Tests",id:"accessibility-tests",level:3},{value:"11. Risks &amp; Mitigations",id:"11-risks--mitigations",level:2},{value:"Risk: Performance Degradation with Large Automation Counts",id:"risk-performance-degradation-with-large-automation-counts",level:3},{value:"Risk: Infinite Trigger Loops",id:"risk-infinite-trigger-loops",level:3},{value:"Risk: Determinism Violations",id:"risk-determinism-violations",level:3},{value:"Risk: Save Migration Failures",id:"risk-save-migration-failures",level:3},{value:"12. Rollout Plan",id:"12-rollout-plan",level:2},{value:"Milestones",id:"milestones",level:3},{value:"Migration Strategy",id:"migration-strategy",level:3},{value:"Communication",id:"communication",level:3},{value:"13. Open Questions",id:"13-open-questions",level:2},{value:"14. Follow-Up Work",id:"14-follow-up-work",level:2},{value:"15. References",id:"15-references",level:2},{value:"Appendix A \u2014 Glossary",id:"appendix-a--glossary",level:2},{value:"Appendix B \u2014 Change Log",id:"appendix-b--change-log",level:2}];function c(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"runtime-automation-execution-system-design",children:"Runtime Automation Execution System Design"})}),"\n",(0,s.jsx)(n.h2,{id:"document-control",children:"Document Control"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Title"}),": Runtime automation execution system"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Authors"}),": Claude Code (AI Assistant)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Reviewers"}),": Engineering team, content designers"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Status"}),": Draft"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Last Updated"}),": 2025-11-03"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Related Issues"}),": #319"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Execution Mode"}),": AI-led"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"1-summary",children:"1. Summary"}),"\n",(0,s.jsxs)(n.p,{children:["Automations are fully schematized in ",(0,s.jsx)(n.code,{children:"@idle-engine/content-schema"})," but not executed by the runtime, creating a critical gap for idle game mechanics. This design specifies a new ",(0,s.jsx)(n.code,{children:"AutomationSystem"})," that evaluates four trigger types (interval, resourceThreshold, commandQueueEmpty, event), manages automation state (enabled/disabled, cooldowns, last-fired timestamps), and enqueues commands at ",(0,s.jsx)(n.code,{children:"CommandPriority.AUTOMATION"})," when triggers activate. The system integrates with the existing ",(0,s.jsx)(n.code,{children:"IdleEngineRuntime"})," tick loop, ",(0,s.jsx)(n.code,{children:"EventBus"}),", and ",(0,s.jsx)(n.code,{children:"ProgressionCoordinator"})," to enable content-driven automated gameplay without manual player intervention."]}),"\n",(0,s.jsx)(n.h2,{id:"2-context--problem-statement",children:"2. Context & Problem Statement"}),"\n",(0,s.jsx)(n.h3,{id:"background",children:"Background"}),"\n",(0,s.jsxs)(n.p,{children:["The Idle Game Engine is a data-driven idle game framework where game mechanics are defined in content packs (JSON) and executed by a deterministic runtime. The content schema (",(0,s.jsx)(n.code,{children:"packages/content-schema/src/modules/automations.ts"}),") defines a complete automation DSL supporting:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"4 trigger types"}),": ",(0,s.jsx)(n.code,{children:"interval"}),", ",(0,s.jsx)(n.code,{children:"resourceThreshold"}),", ",(0,s.jsx)(n.code,{children:"commandQueueEmpty"}),", ",(0,s.jsx)(n.code,{children:"event"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Target types"}),": ",(0,s.jsx)(n.code,{children:"generator"}),", ",(0,s.jsx)(n.code,{children:"upgrade"}),", ",(0,s.jsx)(n.code,{children:"system"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Optional features"}),": cooldowns, resource costs, unlock conditions, toggle state"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Supporting events"}),": ",(0,s.jsx)(n.code,{children:"automation:toggled"}),", ",(0,s.jsx)(n.code,{children:"resource:threshold-reached"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The runtime (",(0,s.jsx)(n.code,{children:"packages/core/src/index.ts"}),") provides:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["System registration via ",(0,s.jsx)(n.code,{children:"IdleEngineRuntime.addSystem()"})]}),"\n",(0,s.jsx)(n.li,{children:"Fixed-step tick loop (default 100ms)"}),"\n",(0,s.jsxs)(n.li,{children:["Command queue with ",(0,s.jsx)(n.code,{children:"CommandPriority.AUTOMATION"})," priority tier"]}),"\n",(0,s.jsx)(n.li,{children:"Event bus for inter-system communication"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["However, ",(0,s.jsx)(n.strong,{children:"no automation system implementation exists"}),". Content packs can define automations, but these definitions are validated and then ignored during gameplay."]}),"\n",(0,s.jsx)(n.h3,{id:"problem",children:"Problem"}),"\n",(0,s.jsx)(n.p,{children:'Without automation execution, the engine fails to deliver on the core promise of "idle" gameplay:'}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Manual clicking required"}),": Players must manually trigger generators and upgrades, defeating idle mechanics"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Dead schema"}),": Automation definitions are validated but never executed, creating confusion"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Missing core loop"}),": Idle games require automation \u2192 offline progress \u2192 prestige, but only the first step is missing"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Wasted infrastructure"}),": Events (",(0,s.jsx)(n.code,{children:"automation:toggled"}),"), priority tiers (",(0,s.jsx)(n.code,{children:"CommandPriority.AUTOMATION"}),"), and trigger schemas exist but remain unused"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"forces",children:"Forces"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Performance budget"}),": Automation evaluation must complete within per-tick budget (<2ms for trigger checks)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Determinism"}),": Trigger evaluation must be reproducible across replays and platforms"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Content flexibility"}),": Content authors should define automation logic without code changes"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"State persistence"}),": Automation state (enabled, cooldown, last-fired) must survive saves/loads"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Backward compatibility"}),": Existing saves without automation state must migrate cleanly"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"3-goals--non-goals",children:"3. Goals & Non-Goals"}),"\n",(0,s.jsx)(n.h3,{id:"goals",children:"Goals"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Execute all four trigger types"})," (",(0,s.jsx)(n.code,{children:"interval"}),", ",(0,s.jsx)(n.code,{children:"resourceThreshold"}),", ",(0,s.jsx)(n.code,{children:"commandQueueEmpty"}),", ",(0,s.jsx)(n.code,{children:"event"}),") as specified in schema"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Enqueue commands"})," at ",(0,s.jsx)(n.code,{children:"CommandPriority.AUTOMATION"})," when triggers activate"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Persist automation state"})," (enabled/disabled, cooldown timers, last-fired step) in save files"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Respect unlock conditions"})," (automations unlock/lock dynamically based on progression)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Honor cooldowns"})," (prevent rapid-fire triggers via cooldown enforcement)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Support resource costs"})," (deduct resources when automation fires, skip if insufficient)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Provide toggle API"})," (enable/disable automations via commands, publish ",(0,s.jsx)(n.code,{children:"automation:toggled"})," events)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Deterministic evaluation"})," (same step + same state = same trigger decisions)"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"non-goals",children:"Non-Goals"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Custom scripting"}),": No Lua/JS execution for custom trigger logic (use existing schema only)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"UI implementation"}),": Dashboard for automation management (deferred to #320+)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Priority configuration"}),": Automation execution order within AUTOMATION priority tier (FIFO for MVP)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"A/B testing hooks"}),": Telemetry for automation effectiveness (deferred to analytics milestone)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Cross-automation dependencies"}),": Triggers based on other automation states (future work)"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"4-stakeholders-agents--impacted-surfaces",children:"4. Stakeholders, Agents & Impacted Surfaces"}),"\n",(0,s.jsx)(n.h3,{id:"primary-stakeholders",children:"Primary Stakeholders"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Runtime engineering team"}),": Implementation and integration"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Content designers"}),": Defining automations in content packs"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"QA engineers"}),": Testing automation behavior and edge cases"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"agent-roles",children:"Agent Roles"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Runtime Implementation Agent"}),": Core automation system, trigger evaluators, state management"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Testing Agent"}),": Unit tests, integration tests, property-based tests for trigger logic"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Migration Agent"}),": Schema migration for save file compatibility"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Documentation Agent"}),": API docs, content authoring guide for automations"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"affected-packagesservices",children:"Affected Packages/Services"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/core"}),": New ",(0,s.jsx)(n.code,{children:"AutomationSystem"}),", state types, command handlers"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/shell-web"}),": Integration into ",(0,s.jsx)(n.code,{children:"runtime.worker.ts"}),", save migrations"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/content-schema"}),": No changes (schema already complete)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/content-sample"}),": Example automations for testing and reference"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"compatibility-considerations",children:"Compatibility Considerations"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Save migration"}),": Add automation state to existing saves (default: all automations disabled)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Content versioning"}),": Automations are optional; packs without them function unchanged"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Event compatibility"}),": ",(0,s.jsx)(n.code,{children:"automation:toggled"})," and ",(0,s.jsx)(n.code,{children:"resource:threshold-reached"})," events already defined"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"5-current-state",children:"5. Current State"}),"\n",(0,s.jsx)(n.h3,{id:"existing-infrastructure",children:"Existing Infrastructure"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Automation Schema"})," (",(0,s.jsx)(n.code,{children:"packages/content-schema/src/modules/automations.ts:1-184"}),"):"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Fully defined with Zod validation"}),"\n",(0,s.jsx)(n.li,{children:"Supports 4 trigger types via discriminated union"}),"\n",(0,s.jsx)(n.li,{children:"Includes cooldown, resource cost, unlock condition, enabled-by-default fields"}),"\n",(0,s.jsx)(n.li,{children:"Validates target types (generator/upgrade/system)"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Event System"})," (",(0,s.jsx)(n.code,{children:"packages/core/src/events/runtime-event-catalog.ts:1-70"}),"):"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"automation:toggled"})," event (id, enabled)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"resource:threshold-reached"})," event (resourceId, threshold)"]}),"\n",(0,s.jsxs)(n.li,{children:["Event channels registered in ",(0,s.jsx)(n.code,{children:"RUNTIME_EVENT_CHANNELS"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Command Queue"})," (",(0,s.jsx)(n.code,{children:"packages/core/src/command-queue.ts:34-37"}),"):"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Three priority lanes: SYSTEM (0), PLAYER (1), AUTOMATION (2)"}),"\n",(0,s.jsxs)(n.li,{children:["Priority-based dequeuing via ",(0,s.jsx)(n.code,{children:"COMMAND_PRIORITY_ORDER"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Runtime Architecture"})," (",(0,s.jsx)(n.code,{children:"packages/core/src/index.ts:82-156"}),"):"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"IdleEngineRuntime.addSystem()"})," for system registration"]}),"\n",(0,s.jsxs)(n.li,{children:["System lifecycle: ",(0,s.jsx)(n.code,{children:"setup(context)"})," for event subscriptions, ",(0,s.jsx)(n.code,{children:"tick(context)"})," for per-step execution"]}),"\n",(0,s.jsx)(n.li,{children:"Fixed-step tick loop with deterministic command dispatch"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Progression Coordinator"})," (",(0,s.jsx)(n.code,{children:"packages/core/src/progression-coordinator.ts"}),"):"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Manages resource, generator, upgrade state"}),"\n",(0,s.jsx)(n.li,{children:"Provides purchase evaluators for cost calculations"}),"\n",(0,s.jsx)(n.li,{children:"Hydrates state from serialized saves"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"gaps",children:"Gaps"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u274c No ",(0,s.jsx)(n.code,{children:"AutomationSystem"})," implementation"]}),"\n",(0,s.jsx)(n.li,{children:"\u274c No trigger evaluation logic (interval timers, threshold checks, event listeners)"}),"\n",(0,s.jsx)(n.li,{children:"\u274c No automation state tracking (enabled/disabled, cooldown, last-fired)"}),"\n",(0,s.jsx)(n.li,{children:"\u274c No command enqueueing when triggers fire"}),"\n",(0,s.jsxs)(n.li,{children:["\u274c No system registered in ",(0,s.jsx)(n.code,{children:"runtime.worker.ts"})]}),"\n",(0,s.jsx)(n.li,{children:"\u274c No save migration for automation state"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"6-proposed-solution",children:"6. Proposed Solution"}),"\n",(0,s.jsx)(n.h3,{id:"61-architecture-overview",children:"6.1 Architecture Overview"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"AutomationSystem"})," is a runtime system registered with ",(0,s.jsx)(n.code,{children:"IdleEngineRuntime"})," that:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Loads automations"})," from content pack during initialization"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Subscribes to events"})," during ",(0,s.jsx)(n.code,{children:"setup()"})," (for event-based and threshold triggers)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Evaluates triggers"})," on every ",(0,s.jsx)(n.code,{children:"tick()"})," (interval, threshold, queue-empty checks)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Enqueues commands"})," when triggers activate and conditions are met"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Manages state"})," (enabled flags, cooldown timers, last-fired steps) in ",(0,s.jsx)(n.code,{children:"ProgressionAuthoritativeState"})]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Content Pack (automations.json)\n        \u2193\nAutomationSystem.loadAutomations()\n        \u2193\nsetup(context) \u2192 Subscribe to events\n        \u2193\ntick(context) \u2192 Evaluate triggers\n        \u2193\n   [Trigger fires?]\n        \u2193 yes\n   [Check cooldown, unlock, resources]\n        \u2193 pass\n   Enqueue command @ AUTOMATION priority\n        \u2193\nCommandQueue \u2192 CommandDispatcher \u2192 Handler\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Trigger Evaluation Flow"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Every tick:\n  For each unlocked automation:\n    If cooldown active \u2192 skip\n    If not enabled \u2192 skip\n    Evaluate trigger:\n      interval \u2192 elapsed >= interval?\n      resourceThreshold \u2192 resource comparator threshold?\n      commandQueueEmpty \u2192 queue.size === 0?\n      event \u2192 received event this tick?\n    If triggered:\n      Check resource cost\n      Deduct resources (if cost specified)\n      Enqueue command\n      Update last-fired step\n      Start cooldown timer\n"})}),"\n",(0,s.jsx)(n.h3,{id:"62-detailed-design",children:"6.2 Detailed Design"}),"\n",(0,s.jsx)(n.h4,{id:"621-state-management",children:"6.2.1 State Management"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Automation State Schema"})," (added to ",(0,s.jsx)(n.code,{children:"ProgressionAuthoritativeState"}),"):"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface AutomationState {\n  readonly id: string;\n  enabled: boolean;\n  lastFiredStep: number;\n  cooldownExpiresStep: number;\n  unlocked: boolean;\n}\n\ninterface ProgressionAutomationState {\n  readonly automations: Record<string, AutomationState>;\n}\n\n// Extended ProgressionAuthoritativeState\ninterface ProgressionAuthoritativeState {\n  // ... existing fields\n  automationState?: ProgressionAutomationState;\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Initialization"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Automations default to ",(0,s.jsx)(n.code,{children:"enabledByDefault"})," from schema"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"lastFiredStep = -Infinity"})," (never fired)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"cooldownExpiresStep = 0"})," (no cooldown)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"unlocked"})," evaluated from ",(0,s.jsx)(n.code,{children:"unlockCondition"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Persistence"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Automation state serialized in save file"}),"\n",(0,s.jsx)(n.li,{children:"Migration adds default state for old saves"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"622-trigger-evaluation-algorithms",children:"6.2.2 Trigger Evaluation Algorithms"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Interval Trigger"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"function evaluateIntervalTrigger(\n  automation: AutomationDefinition,\n  state: AutomationState,\n  currentStep: number,\n  stepDurationMs: number,\n): boolean {\n  if (state.lastFiredStep === -Infinity) {\n    return true; // Fire immediately on first tick\n  }\n\n  const intervalMs = evaluateNumericFormula(\n    automation.trigger.interval,\n    context,\n  );\n  const intervalSteps = Math.ceil(intervalMs / stepDurationMs);\n  const stepsSinceLastFired = currentStep - state.lastFiredStep;\n\n  return stepsSinceLastFired >= intervalSteps;\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Resource Threshold Trigger"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"/**\n * Evaluates whether a resourceThreshold condition is currently satisfied.\n *\n * NOTE: This returns the current state. To detect crossings, the caller must\n * track the previous state (AutomationState.lastThresholdSatisfied) and\n * fire only on transitions: currentlySatisfied && !previouslySatisfied.\n */\nfunction evaluateResourceThresholdTrigger(\n  automation: AutomationDefinition,\n  resourceState: ResourceState,\n  context: FormulaContext,\n): boolean {\n  const { resourceId, comparator, threshold } = automation.trigger;\n  const resource = resourceState.getResource(resourceId);\n  const thresholdValue = evaluateNumericFormula(threshold, context);\n\n  switch (comparator) {\n    case 'gte': return resource.amount >= thresholdValue;\n    case 'gt': return resource.amount > thresholdValue;\n    case 'lte': return resource.amount <= thresholdValue;\n    case 'lt': return resource.amount < thresholdValue;\n  }\n}\n\n// In tick() loop:\nconst currentlySatisfied = evaluateResourceThresholdTrigger(automation, resourceState, context);\nconst previouslySatisfied = state.lastThresholdSatisfied ?? false;\ntriggered = currentlySatisfied && !previouslySatisfied;\nstate.lastThresholdSatisfied = currentlySatisfied; // Track for next tick\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Command Queue Empty Trigger"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"function evaluateCommandQueueEmptyTrigger(\n  commandQueue: CommandQueue,\n): boolean {\n  return commandQueue.size === 0;\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Event Trigger"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// During setup():\nif (automation.trigger.kind === 'event') {\n  context.events.on(automation.trigger.eventId, (payload) => {\n    pendingEventTriggers.add(automation.id);\n  });\n}\n\n// During tick():\nfunction evaluateEventTrigger(\n  automation: AutomationDefinition,\n  pendingEventTriggers: Set<string>,\n): boolean {\n  return pendingEventTriggers.has(automation.id);\n}\n\n// After processing:\npendingEventTriggers.clear();\n"})}),"\n",(0,s.jsx)(n.h4,{id:"623-command-enqueueing",children:"6.2.3 Command Enqueueing"}),"\n",(0,s.jsx)(n.p,{children:"When a trigger fires:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"function enqueueAutomationCommand(\n  automation: AutomationDefinition,\n  commandQueue: CommandQueue,\n  currentStep: number,\n  timestamp: number,\n): void {\n  const { targetType, targetId, systemTargetId } = automation;\n\n  let commandType: string;\n  let payload: unknown;\n\n  if (targetType === 'generator') {\n    commandType = RUNTIME_COMMAND_TYPES.TOGGLE_GENERATOR;\n    payload = { generatorId: targetId };\n  } else if (targetType === 'upgrade') {\n    commandType = RUNTIME_COMMAND_TYPES.PURCHASE_UPGRADE;\n    payload = { upgradeId: targetId, quantity: 1 };\n  } else if (targetType === 'system') {\n    // System automations require custom handling\n    commandType = systemTargetId; // e.g., 'system:prestige'\n    payload = {};\n  }\n\n  commandQueue.enqueue({\n    type: commandType,\n    payload,\n    priority: CommandPriority.AUTOMATION,\n    timestamp,\n    step: currentStep + 1, // Execute next step\n  });\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"624-resource-cost-handling",children:"6.2.4 Resource Cost Handling"}),"\n",(0,s.jsx)(n.p,{children:"Before enqueueing:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"function canAffordAutomation(\n  automation: AutomationDefinition,\n  resourceState: ResourceState,\n  context: FormulaContext,\n): boolean {\n  if (!automation.resourceCost) {\n    return true;\n  }\n\n  const { resourceId, rate } = automation.resourceCost;\n  const cost = evaluateNumericFormula(rate, context);\n  const resource = resourceState.getResource(resourceId);\n\n  return resource.amount >= cost;\n}\n\nfunction deductAutomationCost(\n  automation: AutomationDefinition,\n  resourceState: ResourceState,\n  context: FormulaContext,\n): void {\n  if (!automation.resourceCost) {\n    return;\n  }\n\n  const { resourceId, rate } = automation.resourceCost;\n  const cost = evaluateNumericFormula(rate, context);\n  resourceState.spend(resourceId, cost);\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"625-cooldown-management",children:"6.2.5 Cooldown Management"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"function updateCooldown(\n  automation: AutomationDefinition,\n  state: AutomationState,\n  currentStep: number,\n  stepDurationMs: number,\n): void {\n  if (!automation.cooldown) {\n    state.cooldownExpiresStep = 0;\n    return;\n  }\n\n  const cooldownSteps = Math.ceil(automation.cooldown / stepDurationMs);\n  // +1 accounts for command execution delay: commands enqueued at currentStep\n  // execute at currentStep + 1, so cooldown must be measured from that step.\n  state.cooldownExpiresStep = currentStep + cooldownSteps + 1;\n}\n\nfunction isCooldownActive(\n  state: AutomationState,\n  currentStep: number,\n): boolean {\n  return currentStep < state.cooldownExpiresStep;\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"626-system-implementation",children:"6.2.6 System Implementation"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"File"}),": ",(0,s.jsx)(n.code,{children:"packages/core/src/automation-system.ts"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"export interface AutomationSystemOptions {\n  readonly automations: readonly AutomationDefinition[];\n  readonly commandQueue: CommandQueue;\n  readonly resourceState: ResourceState;\n  readonly stepDurationMs: number;\n  readonly initialState?: ProgressionAutomationState;\n}\n\nexport function createAutomationSystem(\n  options: AutomationSystemOptions,\n): System {\n  const automationStates = new Map<string, AutomationState>();\n  const pendingEventTriggers = new Set<string>();\n\n  // Initialize states\n  for (const automation of options.automations) {\n    const existingState = options.initialState?.automations[automation.id];\n    automationStates.set(automation.id, existingState ?? {\n      id: automation.id,\n      enabled: automation.enabledByDefault,\n      lastFiredStep: -Infinity,\n      cooldownExpiresStep: 0,\n      unlocked: false, // Evaluated during first tick\n    });\n  }\n\n  return {\n    id: 'automation',\n\n    setup(context) {\n      // Subscribe to event triggers\n      for (const automation of options.automations) {\n        if (automation.trigger.kind === 'event') {\n          context.events.on(automation.trigger.eventId, () => {\n            pendingEventTriggers.add(automation.id);\n          });\n        }\n      }\n\n      // Subscribe to automation toggle commands\n      context.events.on('automation:toggled', (payload) => {\n        const state = automationStates.get(payload.automationId);\n        if (state) {\n          state.enabled = payload.enabled;\n        }\n      });\n    },\n\n    tick(context) {\n      for (const automation of options.automations) {\n        const state = automationStates.get(automation.id);\n        if (!state) continue;\n\n        // Update unlock status\n        state.unlocked = evaluateCondition(\n          automation.unlockCondition,\n          conditionContext,\n        );\n\n        if (!state.unlocked || !state.enabled) {\n          continue;\n        }\n\n        if (isCooldownActive(state, context.step)) {\n          continue;\n        }\n\n        // Evaluate trigger\n        let triggered = false;\n        switch (automation.trigger.kind) {\n          case 'interval':\n            triggered = evaluateIntervalTrigger(\n              automation,\n              state,\n              context.step,\n              options.stepDurationMs,\n            );\n            break;\n          case 'resourceThreshold':\n            triggered = evaluateResourceThresholdTrigger(\n              automation,\n              options.resourceState,\n              formulaContext,\n            );\n            break;\n          case 'commandQueueEmpty':\n            triggered = evaluateCommandQueueEmptyTrigger(\n              options.commandQueue,\n            );\n            break;\n          case 'event':\n            triggered = evaluateEventTrigger(\n              automation,\n              pendingEventTriggers,\n            );\n            break;\n        }\n\n        if (!triggered) {\n          continue;\n        }\n\n        // Check resource cost\n        if (!canAffordAutomation(automation, options.resourceState, formulaContext)) {\n          continue;\n        }\n\n        // Deduct cost and enqueue command\n        deductAutomationCost(automation, options.resourceState, formulaContext);\n        enqueueAutomationCommand(\n          automation,\n          options.commandQueue,\n          context.step,\n          context.events.timestamp,\n        );\n\n        // Update state\n        state.lastFiredStep = context.step;\n        updateCooldown(automation, state, context.step, options.stepDurationMs);\n      }\n\n      // Clear event triggers for next tick\n      pendingEventTriggers.clear();\n    },\n  };\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"627-integration-with-runtime-worker",children:"6.2.7 Integration with Runtime Worker"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"File"}),": ",(0,s.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.ts"})]}),"\n",(0,s.jsxs)(n.p,{children:["Add after line 166 (after ",(0,s.jsx)(n.code,{children:"registerResourceCommandHandlers"}),"):"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { createAutomationSystem } from '@idle-engine/core';\n\n// ... existing code ...\n\nconst automationSystem = createAutomationSystem({\n  automations: sampleContent.automations,\n  commandQueue: runtime.getCommandQueue(),\n  resourceState: progressionCoordinator.resourceState,\n  stepDurationMs,\n  initialState: initialProgression?.automationState,\n});\n\nruntime.addSystem(automationSystem);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"63-operational-considerations",children:"6.3 Operational Considerations"}),"\n",(0,s.jsx)(n.h4,{id:"deployment",children:"Deployment"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Feature flag"}),": None required; automations gracefully no-op if content pack has empty ",(0,s.jsx)(n.code,{children:"automations"})," array"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Rollout"}),": Deploy to all environments simultaneously (no content changes required)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Rollback"}),": Safe to rollback; automation state ignored by older runtime versions"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"telemetry--observability",children:"Telemetry & Observability"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Metrics"}),": Automation trigger counts, skipped triggers (cooldown/cost), average triggers per tick"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Logging"}),": Automation fires logged at debug level with automation ID and target"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Diagnostics"}),": Automation state exposed in diagnostic timeline for debugging"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"security--compliance",children:"Security & Compliance"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Threat model"}),": No new attack surface; automations use existing command system"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"PII handling"}),": No PII in automation state"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Permissions"}),": Automations execute at AUTOMATION priority (lower than PLAYER)"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"7-work-breakdown--delivery-plan",children:"7. Work Breakdown & Delivery Plan"}),"\n",(0,s.jsx)(n.h3,{id:"71-issue-map",children:"7.1 Issue Map"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Issue Title"}),(0,s.jsx)(n.th,{children:"Scope Summary"}),(0,s.jsx)(n.th,{children:"Proposed Assignee/Agent"}),(0,s.jsx)(n.th,{children:"Dependencies"}),(0,s.jsx)(n.th,{children:"Acceptance Criteria"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"feat(core): implement AutomationSystem core"}),(0,s.jsxs)(n.td,{children:["Create ",(0,s.jsx)(n.code,{children:"AutomationSystem"})," class with state management and trigger evaluation logic"]}),(0,s.jsx)(n.td,{children:"Runtime Implementation Agent"}),(0,s.jsx)(n.td,{children:"Doc approval"}),(0,s.jsx)(n.td,{children:"Unit tests pass; all 4 trigger types evaluated correctly; state persisted"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"feat(core): integrate AutomationSystem into runtime"}),(0,s.jsxs)(n.td,{children:["Register AutomationSystem in ",(0,s.jsx)(n.code,{children:"runtime.worker.ts"})," and wire to ProgressionCoordinator"]}),(0,s.jsx)(n.td,{children:"Runtime Implementation Agent"}),(0,s.jsx)(n.td,{children:"AutomationSystem core"}),(0,s.jsx)(n.td,{children:"Integration tests pass; automations fire in worker context"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"feat(core): add automation toggle command handler"}),(0,s.jsxs)(n.td,{children:["Implement ",(0,s.jsx)(n.code,{children:"TOGGLE_AUTOMATION"})," command and emit ",(0,s.jsx)(n.code,{children:"automation:toggled"})," events"]}),(0,s.jsx)(n.td,{children:"Runtime Implementation Agent"}),(0,s.jsx)(n.td,{children:"AutomationSystem core"}),(0,s.jsx)(n.td,{children:"Command toggles automation state; event published"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"test(core): property-based automation tests"}),(0,s.jsx)(n.td,{children:"Generate random automation sequences and verify trigger invariants"}),(0,s.jsx)(n.td,{children:"Testing Agent"}),(0,s.jsx)(n.td,{children:"AutomationSystem core"}),(0,s.jsx)(n.td,{children:"1000+ test cases pass; edge cases documented"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"feat(shell-web): automation state migration"}),(0,s.jsx)(n.td,{children:"Add migration for saves without automation state"}),(0,s.jsx)(n.td,{children:"Migration Agent"}),(0,s.jsx)(n.td,{children:"AutomationSystem integration"}),(0,s.jsx)(n.td,{children:"Old saves load with default automation state; tests verify"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"feat(content-sample): add example automations"}),(0,s.jsx)(n.td,{children:"Create sample automations for each trigger type in sample pack"}),(0,s.jsx)(n.td,{children:"Runtime Implementation Agent"}),(0,s.jsx)(n.td,{children:"None"}),(0,s.jsx)(n.td,{children:"Sample pack includes 4+ automations; validated against schema"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"docs(core): automation system API docs"}),(0,s.jsx)(n.td,{children:"Document AutomationSystem API and content authoring guide"}),(0,s.jsx)(n.td,{children:"Documentation Agent"}),(0,s.jsx)(n.td,{children:"AutomationSystem core"}),(0,s.jsx)(n.td,{children:"API docs published; authoring guide includes examples"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"72-milestones",children:"7.2 Milestones"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Phase 1: Core Implementation"})," (3-5 days)"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Deliverables: AutomationSystem implementation, trigger evaluators, state management"}),"\n",(0,s.jsx)(n.li,{children:"Gating criteria: Unit tests pass with 100% coverage"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Phase 2: Integration"})," (2-3 days)"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Deliverables: Runtime worker integration, command handlers, event subscriptions"}),"\n",(0,s.jsx)(n.li,{children:"Gating criteria: Integration tests pass; automations fire in worker context"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Phase 3: Testing & Polish"})," (2 days)"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Deliverables: Property-based tests, migration tests, sample automations"}),"\n",(0,s.jsx)(n.li,{children:"Gating criteria: All tests pass; example automations validated"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Phase 4: Documentation"})," (1 day)"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Deliverables: API docs, authoring guide, migration notes"}),"\n",(0,s.jsx)(n.li,{children:"Gating criteria: Docs reviewed and merged"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"73-coordination-notes",children:"7.3 Coordination Notes"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Hand-off Package"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"This design document (all sections)"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/content-schema/src/modules/automations.ts"})," (schema reference)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/core/src/index.ts"})," (system registration pattern)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/core/src/progression-coordinator.ts"})," (state management pattern)"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Communication Cadence"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Daily status updates in #319 (GitHub issue)"}),"\n",(0,s.jsx)(n.li,{children:"Review checkpoint after Phase 1 completion"}),"\n",(0,s.jsx)(n.li,{children:"Escalation path: Tag engineering lead if blocked >1 day"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"8-agent-guidance--guardrails",children:"8. Agent Guidance & Guardrails"}),"\n",(0,s.jsx)(n.h3,{id:"context-packets",children:"Context Packets"}),"\n",(0,s.jsx)(n.p,{children:"Agents must load before execution:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/content-schema/src/modules/automations.ts"})," (automation schema)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/core/src/index.ts"})," (runtime architecture)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/core/src/command.ts"})," (command priority definitions)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/core/src/events/runtime-event-catalog.ts"})," (event definitions)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/core/src/progression-coordinator.ts"})," (state management patterns)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"docs/runtime-command-queue-design.md"})," (command queue design)"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"prompting--constraints",children:"Prompting & Constraints"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Canonical Instructions"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Use imperative commit messages: ",(0,s.jsx)(n.code,{children:"feat(core): add AutomationSystem"})," not ",(0,s.jsx)(n.code,{children:"Added AutomationSystem"})]}),"\n",(0,s.jsxs)(n.li,{children:["Follow existing naming: ",(0,s.jsx)(n.code,{children:"evaluateTrigger()"})," not ",(0,s.jsx)(n.code,{children:"checkTrigger()"})," (match ",(0,s.jsx)(n.code,{children:"evaluateCondition()"})," pattern)"]}),"\n",(0,s.jsx)(n.li,{children:"Maintain 100% test coverage for public APIs (use Vitest)"}),"\n",(0,s.jsxs)(n.li,{children:["Export all new types from ",(0,s.jsx)(n.code,{children:"packages/core/src/index.ts"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Performance Requirements"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Automation evaluation must complete in <2ms per tick for 100 automations"}),"\n",(0,s.jsx)(n.li,{children:"Use memoization for expensive formula evaluations"}),"\n",(0,s.jsx)(n.li,{children:"Avoid O(n\xb2) loops; prefer Map lookups over array scans"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Determinism Requirements"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Trigger evaluation must be pure (same inputs \u2192 same outputs)"}),"\n",(0,s.jsxs)(n.li,{children:["No ",(0,s.jsx)(n.code,{children:"Date.now()"})," or ",(0,s.jsx)(n.code,{children:"Math.random()"})," in trigger logic"]}),"\n",(0,s.jsxs)(n.li,{children:["Use ",(0,s.jsx)(n.code,{children:"context.step"})," and ",(0,s.jsx)(n.code,{children:"context.timestamp"})," for timing"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"safety-rails",children:"Safety Rails"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Forbidden Actions"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"NEVER reset git history or force push to main"}),"\n",(0,s.jsx)(n.li,{children:"DO NOT modify existing command priority values"}),"\n",(0,s.jsx)(n.li,{children:"DO NOT skip validation of automation schema"}),"\n",(0,s.jsxs)(n.li,{children:["NEVER use ",(0,s.jsx)(n.code,{children:"any"})," type; use proper TypeScript types"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Data Privacy"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Automation state contains no PII"}),"\n",(0,s.jsx)(n.li,{children:"Telemetry must not log resource IDs containing user data"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Rollback Procedures"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"If automation system crashes runtime, disable via feature flag"}),"\n",(0,s.jsx)(n.li,{children:"Revert automation state migration if save corruption detected"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"validation-hooks",children:"Validation Hooks"}),"\n",(0,s.jsx)(n.p,{children:"Agents must run before marking tasks complete:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"pnpm test --filter core"})," (all core tests pass)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"pnpm test --filter shell-web"})," (all shell-web tests pass)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"pnpm lint --filter core"})," (no lint errors)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"pnpm build"})," (TypeScript compilation succeeds)"]}),"\n",(0,s.jsx)(n.li,{children:"Verify automation fires in worker context (integration test)"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"9-alternatives-considered",children:"9. Alternatives Considered"}),"\n",(0,s.jsx)(n.h3,{id:"alternative-1-poll-based-trigger-evaluation",children:"Alternative 1: Poll-Based Trigger Evaluation"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Approach"}),": Evaluate all triggers on every tick, regardless of type."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Rejected because"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Wasteful for event-based triggers (polling vs. subscription)"}),"\n",(0,s.jsx)(n.li,{children:"Poor performance for large automation counts (O(n) every tick)"}),"\n",(0,s.jsx)(n.li,{children:"Misses event-based triggers between ticks"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Trade-offs"}),": Simpler implementation but unacceptable performance characteristics."]}),"\n",(0,s.jsx)(n.h3,{id:"alternative-2-separate-automation-worker",children:"Alternative 2: Separate Automation Worker"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Approach"}),": Run automation evaluation in dedicated web worker."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Rejected because"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Adds complexity (message passing, state synchronization)"}),"\n",(0,s.jsx)(n.li,{children:"No performance benefit (automation evaluation is cheap)"}),"\n",(0,s.jsx)(n.li,{children:"Increases latency (cross-worker communication overhead)"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Trade-offs"}),": Better isolation but unjustified complexity for current scale."]}),"\n",(0,s.jsx)(n.h3,{id:"alternative-3-luajs-scripting-for-custom-triggers",children:"Alternative 3: Lua/JS Scripting for Custom Triggers"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Approach"}),": Allow content authors to write custom trigger logic in scripts."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Rejected because"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Security risk (arbitrary code execution)"}),"\n",(0,s.jsx)(n.li,{children:"Non-deterministic (hard to validate reproducibility)"}),"\n",(0,s.jsx)(n.li,{children:"Complexity (requires sandboxing, API design)"}),"\n",(0,s.jsx)(n.li,{children:"Out of scope for MVP"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Trade-offs"}),": Maximum flexibility but unacceptable security/determinism trade-offs."]}),"\n",(0,s.jsx)(n.h2,{id:"10-testing--validation-plan",children:"10. Testing & Validation Plan"}),"\n",(0,s.jsx)(n.h3,{id:"unit-tests",children:"Unit Tests"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Trigger Evaluators"}),": Test each trigger type with edge cases","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Interval: First tick, exact interval, sub-interval deltas"}),"\n",(0,s.jsx)(n.li,{children:"Resource threshold: All comparators (gte/gt/lte/lt), boundary values"}),"\n",(0,s.jsx)(n.li,{children:"Command queue empty: Empty queue, non-empty queue"}),"\n",(0,s.jsx)(n.li,{children:"Event: Event received, event not received, multiple events"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"State Management"}),": Enable/disable, cooldowns, last-fired tracking"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Resource Costs"}),": Sufficient resources, insufficient resources, no cost"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Unlock Conditions"}),": Locked automations skipped, unlock transitions"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"integration-tests",children:"Integration Tests"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"End-to-End Automation"}),": Define automation in content pack \u2192 trigger fires \u2192 command executed"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Multiple Automations"}),": 10+ automations with different triggers fire correctly"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Priority Ordering"}),": Automation commands execute after PLAYER commands"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Event Integration"}),": Event triggers subscribe and fire correctly"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Save/Load Cycle"}),": Automation state persists and restores correctly"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"performance-tests",children:"Performance Tests"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Benchmark"}),": 100 automations evaluated in <2ms per tick (target: <1ms)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Memory"}),": Automation state memory usage <1KB per automation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Stress Test"}),": 1000 automations do not degrade tick performance below 60 FPS"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"property-based-tests",children:"Property-Based Tests"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Random Automation Sequences"}),": Generate random automation definitions and verify:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"No crashes or exceptions"}),"\n",(0,s.jsx)(n.li,{children:"Cooldowns always enforced"}),"\n",(0,s.jsx)(n.li,{children:"Resource costs always deducted"}),"\n",(0,s.jsx)(n.li,{children:"Commands always enqueued at AUTOMATION priority"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Invariants"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"lastFiredStep <= currentStep"})," always true"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"cooldownExpiresStep >= currentStep"})," when cooldown active"]}),"\n",(0,s.jsx)(n.li,{children:"Disabled automations never fire"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"accessibility-tests",children:"Accessibility Tests"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Not applicable (no UI in this milestone)"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"11-risks--mitigations",children:"11. Risks & Mitigations"}),"\n",(0,s.jsx)(n.h3,{id:"risk-performance-degradation-with-large-automation-counts",children:"Risk: Performance Degradation with Large Automation Counts"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Impact"}),": High (>100 automations could exceed tick budget)\n",(0,s.jsx)(n.strong,{children:"Likelihood"}),": Medium (power users may create many automations)\n",(0,s.jsx)(n.strong,{children:"Mitigation"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Benchmark with 100+ automations during development"}),"\n",(0,s.jsx)(n.li,{children:"Implement lazy evaluation (skip locked/disabled automations early)"}),"\n",(0,s.jsx)(n.li,{children:"Document performance limits in content authoring guide"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"risk-infinite-trigger-loops",children:"Risk: Infinite Trigger Loops"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Impact"}),": High (automation triggers itself \u2192 infinite commands)\n",(0,s.jsx)(n.strong,{children:"Likelihood"}),": Low (requires specific content misconfiguration)\n",(0,s.jsx)(n.strong,{children:"Mitigation"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Cooldowns prevent rapid re-triggers"}),"\n",(0,s.jsx)(n.li,{children:"Document anti-patterns in authoring guide"}),"\n",(0,s.jsx)(n.li,{children:"Add telemetry to detect high-frequency triggers"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"risk-determinism-violations",children:"Risk: Determinism Violations"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Impact"}),": Critical (non-deterministic triggers break replays)\n",(0,s.jsx)(n.strong,{children:"Likelihood"}),": Low (strict testing enforces determinism)\n",(0,s.jsx)(n.strong,{children:"Mitigation"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Property-based tests verify reproducibility"}),"\n",(0,s.jsx)(n.li,{children:"Code review checklist includes determinism verification"}),"\n",(0,s.jsxs)(n.li,{children:["Reject any use of ",(0,s.jsx)(n.code,{children:"Date.now()"})," or ",(0,s.jsx)(n.code,{children:"Math.random()"})]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"risk-save-migration-failures",children:"Risk: Save Migration Failures"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Impact"}),": High (players lose automation state)\n",(0,s.jsx)(n.strong,{children:"Likelihood"}),": Low (migration adds default state, no data loss)\n",(0,s.jsx)(n.strong,{children:"Mitigation"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Migration tests verify old saves load correctly"}),"\n",(0,s.jsx)(n.li,{children:"Default state (disabled) is safe fallback"}),"\n",(0,s.jsx)(n.li,{children:"Rollback plan: revert migration, automation state optional"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"12-rollout-plan",children:"12. Rollout Plan"}),"\n",(0,s.jsx)(n.h3,{id:"milestones",children:"Milestones"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"M1: Core Implementation"})," (Week 1): AutomationSystem and trigger evaluators"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"M2: Integration"})," (Week 2): Runtime worker integration and command handlers"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"M3: Testing"})," (Week 2): Property-based tests and migration validation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"M4: Documentation"})," (Week 3): API docs and content authoring guide"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"migration-strategy",children:"Migration Strategy"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Save Format"}),": Add ",(0,s.jsx)(n.code,{children:"automationState"})," field to ",(0,s.jsx)(n.code,{children:"ProgressionAuthoritativeState"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Migration Logic"}),": If ",(0,s.jsx)(n.code,{children:"automationState"})," missing, initialize with defaults (all disabled)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Backward Compatibility"}),": Old runtime ignores ",(0,s.jsx)(n.code,{children:"automationState"})," field"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Forward Compatibility"}),": New runtime handles missing field gracefully"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"communication",children:"Communication"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Release Notes"}),': "Automation system now executes automation definitions from content packs. Existing saves will have all automations disabled by default."']}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Content Authors"}),': "Automations are now functional! See docs/automation-authoring-guide.md for examples."']}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Players"}),": No user-facing message (feature enabled by content packs)"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"13-open-questions",children:"13. Open Questions"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Q"}),": Should automations fire during offline catch-up?\n",(0,s.jsx)(n.strong,{children:"A"}),": Deferred to offline progression design (#350+). For MVP, automations only fire during active ticks."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Q"}),": How should automation state be exposed to UI?\n",(0,s.jsx)(n.strong,{children:"A"}),": Deferred to automation UI design (#320+). For MVP, state exists but no dashboard."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Q"}),": Should resource threshold triggers fire every tick while threshold is met?\n",(0,s.jsx)(n.strong,{children:"A"}),": \u2705 ",(0,s.jsx)(n.strong,{children:"DECIDED"}),": Fire once per threshold crossing (track ",(0,s.jsx)(n.code,{children:"lastThresholdSatisfied"})," state). Implemented in ",(0,s.jsx)(n.code,{children:"AutomationState.lastThresholdSatisfied"})," field. Triggers fire only on transitions from not-met to met (false \u2192 true)."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Q"}),": What happens if automation target (generator/upgrade) is locked?\n",(0,s.jsx)(n.strong,{children:"A"}),": Command is enqueued but authorization fails. ",(0,s.jsx)(n.strong,{children:"Recommendation"}),": Check unlock status before enqueueing."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"14-follow-up-work",children:"14. Follow-Up Work"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Task"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Owner"}),(0,s.jsx)(n.th,{children:"Timing"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"#320"}),(0,s.jsx)(n.td,{children:"Automation dashboard UI"}),(0,s.jsx)(n.td,{children:"Shell-web team"}),(0,s.jsx)(n.td,{children:"After core implementation"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"#321"}),(0,s.jsx)(n.td,{children:"Automation telemetry and A/B testing"}),(0,s.jsx)(n.td,{children:"Analytics team"}),(0,s.jsx)(n.td,{children:"Q2 2025"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"#322"}),(0,s.jsx)(n.td,{children:"Cross-automation dependencies"}),(0,s.jsx)(n.td,{children:"Runtime team"}),(0,s.jsx)(n.td,{children:"Future milestone"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"#323"}),(0,s.jsx)(n.td,{children:"Offline automation catch-up"}),(0,s.jsx)(n.td,{children:"Runtime team"}),(0,s.jsx)(n.td,{children:"After offline progression design"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"#324"}),(0,s.jsx)(n.td,{children:"Automation priority ordering"}),(0,s.jsx)(n.td,{children:"Content team"}),(0,s.jsx)(n.td,{children:"If requested by users"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"15-references",children:"15. References"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Issue #319: Design: Runtime automation execution system"}),"\n",(0,s.jsx)(n.li,{children:"Issue #298: feat(shell-web): resource dashboard UI (related work)"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/content-schema/src/modules/automations.ts"})," (schema)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/core/src/index.ts:116-156"})," (system registration)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/core/src/events/runtime-event-catalog.ts:7-22"})," (automation events)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/core/src/command.ts:76-90"})," (command priorities)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"docs/runtime-command-queue-design.md"})," (command queue design)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"docs/content-dsl-schema-design.md"})," (content authoring)"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"appendix-a--glossary",children:"Appendix A \u2014 Glossary"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Automation"}),": A content-defined rule that triggers commands without player interaction"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Trigger"}),": Condition that causes an automation to fire (interval, threshold, event, queue-empty)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Cooldown"}),": Minimum time between automation firings"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Resource Cost"}),": Optional resource deduction when automation fires"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Unlock Condition"}),": Condition that determines if automation is available"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Event Trigger"}),": Automation that fires when a specific runtime event is published"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Interval Trigger"}),": Automation that fires periodically based on elapsed time"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Resource Threshold Trigger"}),": Automation that fires when resource amount crosses threshold"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Command Queue Empty Trigger"}),": Automation that fires when no commands are pending"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"appendix-b--change-log",children:"Appendix B \u2014 Change Log"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Date"}),(0,s.jsx)(n.th,{children:"Author"}),(0,s.jsx)(n.th,{children:"Change Summary"})]})}),(0,s.jsx)(n.tbody,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"2025-11-03"}),(0,s.jsx)(n.td,{children:"Claude Code"}),(0,s.jsx)(n.td,{children:"Initial draft based on issue #319 requirements"})]})})]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},7678:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>a});var i=t(9430);const s={},r=i.createContext(s);function o(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);