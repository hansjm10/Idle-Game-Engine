"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[48],{3407:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>m,frontMatter:()=>o,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"runtime-command-queue-design","title":"Runtime Command Queue Design","description":"Document Control","source":"@site/../../docs/runtime-command-queue-design.md","sourceDirName":".","slug":"/runtime-command-queue-design","permalink":"/Idle-Game-Engine/runtime-command-queue-design","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/runtime-command-queue-design.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"title":"Runtime Command Queue Design","sidebar_position":4},"sidebar":"developerSidebar","previous":{"title":"Runtime Step Lifecycle Alignment","permalink":"/Idle-Game-Engine/runtime-step-lifecycle"},"next":{"title":"Controls Contract Design (Issue 705)","permalink":"/Idle-Game-Engine/controls-contract-design-issue-705"}}');var r=t(5270),s=t(7678);const o={title:"Runtime Command Queue Design",sidebar_position:4},a="Runtime Command Queue Design",d={},l=[{value:"Document Control",id:"document-control",level:2},{value:"1. Summary",id:"1-summary",level:2},{value:"2. Context &amp; Problem Statement",id:"2-context--problem-statement",level:2},{value:"Background",id:"background",level:3},{value:"Problem",id:"problem",level:3},{value:"Forces",id:"forces",level:3},{value:"3. Goals &amp; Non-Goals",id:"3-goals--non-goals",level:2},{value:"Goals",id:"goals",level:3},{value:"Non-Goals",id:"non-goals",level:3},{value:"4. Stakeholders, Agents &amp; Impacted Surfaces",id:"4-stakeholders-agents--impacted-surfaces",level:2},{value:"Primary Stakeholders",id:"primary-stakeholders",level:3},{value:"Agent Roles",id:"agent-roles",level:3},{value:"Affected Packages/Services",id:"affected-packagesservices",level:3},{value:"Compatibility Considerations",id:"compatibility-considerations",level:3},{value:"5. Current State",id:"5-current-state",level:2},{value:"6. Proposed Solution",id:"6-proposed-solution",level:2},{value:"6.1 Architecture Overview",id:"61-architecture-overview",level:3},{value:"6.2 Detailed Design",id:"62-detailed-design",level:3},{value:"Runtime Changes",id:"runtime-changes",level:4},{value:"State Graph Structure Requirements",id:"state-graph-structure-requirements",level:5},{value:"Command Interface",id:"command-interface",level:5},{value:"Command Queue Structure",id:"command-queue-structure",level:5},{value:"Step Field Population",id:"step-field-population",level:5},{value:"Command Execution Flow",id:"command-execution-flow",level:5},{value:"Command Dispatcher",id:"command-dispatcher",level:5},{value:"ResourceState Integration",id:"resourcestate-integration",level:5},{value:"Data &amp; Schemas",id:"data--schemas",level:4},{value:"Command Types (Initial Set)",id:"command-types-initial-set",level:5},{value:"Priority Resolution",id:"priority-resolution",level:5},{value:"APIs &amp; Contracts",id:"apis--contracts",level:4},{value:"Worker Bridge API",id:"worker-bridge-api",level:5},{value:"Command Recording &amp; Replay",id:"command-recording--replay",level:5},{value:"6.3 Operational Considerations",id:"63-operational-considerations",level:3},{value:"Deployment",id:"deployment",level:4},{value:"Telemetry &amp; Observability",id:"telemetry--observability",level:4},{value:"Security &amp; Compliance",id:"security--compliance",level:4},{value:"6.4 Transport Protocol Usage (Issue 545)",id:"64-transport-protocol-usage-issue-545",level:3},{value:"7. Work Breakdown &amp; Delivery Plan",id:"7-work-breakdown--delivery-plan",level:2},{value:"7.1 Issue Map",id:"71-issue-map",level:3},{value:"7.2 Milestones",id:"72-milestones",level:3},{value:"7.3 Coordination Notes",id:"73-coordination-notes",level:3},{value:"8. Agent Guidance &amp; Guardrails",id:"8-agent-guidance--guardrails",level:2},{value:"Context Packets",id:"context-packets",level:3},{value:"Prompting &amp; Constraints",id:"prompting--constraints",level:3},{value:"Safety Rails",id:"safety-rails",level:3},{value:"Validation Hooks",id:"validation-hooks",level:3},{value:"9. Alternatives Considered",id:"9-alternatives-considered",level:2},{value:"Alternative 1: Direct State Mutation",id:"alternative-1-direct-state-mutation",level:3},{value:"Alternative 2: Event Bus Pattern",id:"alternative-2-event-bus-pattern",level:3},{value:"Alternative 3: Transaction Log",id:"alternative-3-transaction-log",level:3},{value:"10. Testing &amp; Validation Plan",id:"10-testing--validation-plan",level:2},{value:"Unit / Integration",id:"unit--integration",level:3},{value:"Performance",id:"performance",level:3},{value:"Tooling / A11y",id:"tooling--a11y",level:3},{value:"11. Risks &amp; Mitigations",id:"11-risks--mitigations",level:2},{value:"12. Rollout Plan",id:"12-rollout-plan",level:2},{value:"Milestones",id:"milestones",level:3},{value:"Migration Strategy",id:"migration-strategy",level:3},{value:"Communication",id:"communication",level:3},{value:"13. Open Questions",id:"13-open-questions",level:2},{value:"14. Follow-Up Work",id:"14-follow-up-work",level:2},{value:"15. References",id:"15-references",level:2},{value:"Appendix A \u2014 Glossary",id:"appendix-a--glossary",level:2},{value:"Appendix B \u2014 Change Log",id:"appendix-b--change-log",level:2},{value:"Appendix C \u2014 Resolved Decisions",id:"appendix-c--resolved-decisions",level:2},{value:"Appendix D \u2014 Implementation Status",id:"appendix-d--implementation-status",level:2},{value:"Completed Tasks (Week 1)",id:"completed-tasks-week-1",level:3},{value:"In Progress (Week 2)",id:"in-progress-week-2",level:3},{value:"Pending (Week 3)",id:"pending-week-3",level:3},{value:"Success Criteria Status",id:"success-criteria-status",level:3}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",header:"header",input:"input",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"runtime-command-queue-design",children:"Runtime Command Queue Design"})}),"\n",(0,r.jsx)(n.h2,{id:"document-control",children:"Document Control"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Title"}),": Introduce deterministic command queue for runtime state mutations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Authors"}),": Runtime Core Team"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Reviewers"}),": N/A"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Status"}),": Approved"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Last Updated"}),": 2025-10-11"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Related Issues"}),": #6"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Execution Mode"}),": AI-led"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"1-summary",children:"1. Summary"}),"\n",(0,r.jsx)(n.p,{children:"The command queue is a core runtime component that enables deterministic, replayable game state mutations. It decouples user input, automation systems, and server-confirmed actions from immediate execution, allowing the runtime to process all state changes within the fixed-step tick loop. By routing all mutations through a priority-based queue, the system ensures reproducible simulation for offline catch-up, debugging, and potential multiplayer synchronization while maintaining strict performance budgets and type safety."}),"\n",(0,r.jsx)(n.h2,{id:"2-context--problem-statement",children:"2. Context & Problem Statement"}),"\n",(0,r.jsx)(n.h3,{id:"background",children:"Background"}),"\n",(0,r.jsx)(n.p,{children:"The Idle Engine runtime requires a mechanism to manage state mutations from multiple sources (player input, automation systems, engine operations) within its fixed-step tick loop. Without a structured approach, state changes would occur unpredictably, making deterministic replay impossible and complicating debugging."}),"\n",(0,r.jsx)(n.h3,{id:"problem",children:"Problem"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Multiple systems need to mutate game state (UI layer, automation, engine migrations)"}),"\n",(0,r.jsx)(n.li,{children:"Direct state mutation breaks determinism required for offline catch-up and debugging"}),"\n",(0,r.jsx)(n.li,{children:"No mechanism exists to prioritize conflicting operations (e.g., player input vs automation)"}),"\n",(0,r.jsx)(n.li,{children:"Command execution must occur within the 100ms tick budget while maintaining type safety"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"forces",children:"Forces"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Performance target: Minimal overhead for command enqueueing and processing within 100ms tick budget"}),"\n",(0,r.jsx)(n.li,{children:"Determinism requirement: Reproducible simulation for offline catch-up and debugging"}),"\n",(0,r.jsx)(n.li,{children:"Type safety: Strongly-typed command payloads that prevent invalid mutations at compile time"}),"\n",(0,r.jsx)(n.li,{children:"Priority handling: Support multiple command sources with configurable priority tiers"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"3-goals--non-goals",children:"3. Goals & Non-Goals"}),"\n",(0,r.jsx)(n.h3,{id:"goals",children:"Goals"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Determinism"}),": All state mutations occur through commands executed within tick steps, ensuring reproducible simulation for offline catch-up and debugging"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Priority Control"}),": Support multiple command sources (player, automation, system) with configurable priority tiers to resolve execution order conflicts"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Serialization"}),": Enable command recording/replay for debugging, testing, and potential multiplayer synchronization"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Performance"}),": Minimal overhead for command enqueueing and processing within the 100ms tick budget"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Type Safety"}),": Strongly-typed command payloads that prevent invalid mutations at compile time"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"non-goals",children:"Non-Goals"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Network synchronization protocols (out of scope for prototype milestone)"}),"\n",(0,r.jsx)(n.li,{children:"Complex undo/redo UI flows (out of scope for prototype milestone)"}),"\n",(0,r.jsx)(n.li,{children:"Cross-tick command scheduling (time-based tasks use dedicated Task Scheduler system)"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"4-stakeholders-agents--impacted-surfaces",children:"4. Stakeholders, Agents & Impacted Surfaces"}),"\n",(0,r.jsx)(n.h3,{id:"primary-stakeholders",children:"Primary Stakeholders"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Runtime Core Team: Responsible for implementation and maintenance"}),"\n",(0,r.jsx)(n.li,{children:"Content Module Authors: Consumers of the command API"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"agent-roles",children:"Agent Roles"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Runtime Implementation Agent: Implements core command queue and dispatcher logic"}),"\n",(0,r.jsx)(n.li,{children:"Integration Agent: Connects command queue to tick loop and external command ingress"}),"\n",(0,r.jsx)(n.li,{children:"Testing Agent: Creates unit and integration tests for command flow"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"affected-packagesservices",children:"Affected Packages/Services"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"packages/core"}),": Command queue, dispatcher, recorder implementations"]}),"\n",(0,r.jsx)(n.li,{children:"Presentation shells (archived): Worker bridge integration for command submission"}),"\n",(0,r.jsx)(n.li,{children:"Runtime worker: Tick loop integration and command execution"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"compatibility-considerations",children:"Compatibility Considerations"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Command payloads must be structured-cloneable for worker communication"}),"\n",(0,r.jsx)(n.li,{children:"Backward compatibility for command log format versioning"}),"\n",(0,r.jsx)(n.li,{children:"API stability for command handler registration"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"5-current-state",children:"5. Current State"}),"\n",(0,r.jsx)(n.p,{children:"Prior to this design, the runtime lacked a formalized command system. State mutations occurred directly within systems or handlers, making deterministic replay impossible. There was no mechanism to prioritize operations from different sources or to record the sequence of state changes for debugging purposes."}),"\n",(0,r.jsx)(n.h2,{id:"6-proposed-solution",children:"6. Proposed Solution"}),"\n",(0,r.jsx)(n.h3,{id:"61-architecture-overview",children:"6.1 Architecture Overview"}),"\n",(0,r.jsx)(n.p,{children:"The command queue system consists of three primary components:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"CommandQueue"}),": Priority-based queue structure that maintains separate FIFO lanes per priority tier"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"CommandDispatcher"}),": Routes commands to type-specific handlers and manages execution context"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"CommandRecorder"}),": Captures command history and initial state for replay and debugging"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Commands flow through the system as follows:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"External sources (UI, automation) enqueue commands with priority and payload"}),"\n",(0,r.jsx)(n.li,{children:"Tick loop dequeues all commands at the start of each step"}),"\n",(0,r.jsx)(n.li,{children:"Dispatcher executes commands in priority order"}),"\n",(0,r.jsx)(n.li,{children:"Handlers mutate state through well-defined interfaces"}),"\n",(0,r.jsx)(n.li,{children:"Recorder captures executed commands for replay"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"62-detailed-design",children:"6.2 Detailed Design"}),"\n",(0,r.jsx)(n.h4,{id:"runtime-changes",children:"Runtime Changes"}),"\n",(0,r.jsx)(n.h5,{id:"state-graph-structure-requirements",children:"State Graph Structure Requirements"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Decision"}),": The runtime supports ",(0,r.jsx)(n.strong,{children:"cyclic state graphs"})," with ",(0,r.jsx)(n.strong,{children:"structured-cloneable types"}),"."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Supported State Structures"})}),"\n",(0,r.jsx)(n.p,{children:"The runtime state graph can contain:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Cyclic References"}),": Parent-child relationships and entity cross-references are fully supported"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface Entity {\n  id: string;\n  parent?: Entity; // Cycle: child \u2192 parent \u2192 child\n  children: Entity[];\n  dependencies: Set<Entity>; // Cross-references\n}\n\nconst parent: Entity = { id: 'p', children: [] };\nconst child: Entity = { id: 'c', parent, children: [] };\nparent.children.push(child); // Cycle created\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Collection Types"}),": Map, Set, and native collections are first-class citizens"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface GameState {\n  entities: Map<string, Entity>; // Entity registry\n  activeIds: Set<string>; // Active entity tracking\n  resourceGraph: Map<string, Set<string>>; // Adjacency list\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Complex Nested Structures"}),": Arbitrary nesting depth is supported"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface GameState {\n  resources: {\n    byType: Map<string, {\n      instances: Map<string, Resource>;\n      producers: Set<Entity>;\n    }>;\n  };\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Cloning Behavior"})}),"\n",(0,r.jsxs)(n.p,{children:["The recorder uses ",(0,r.jsx)(n.code,{children:"structuredClone()"})," which provides:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Cycle Preservation"}),": Circular references are cloned correctly"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Collection Cloning"}),": Map and Set are deeply cloned"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Type Preservation"}),": Objects maintain their identity (Date, Map, Uint8Array, etc.)"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Unsupported Types"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"structuredClone()"})," and ",(0,r.jsx)(n.code,{children:"deepFreeze()"})," cannot handle:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Functions"}),"\n",(0,r.jsx)(n.li,{children:"Class instances with methods"}),"\n",(0,r.jsx)(n.li,{children:"DOM Nodes and Browser APIs"}),"\n",(0,r.jsx)(n.li,{children:"WeakMap/WeakSet"}),"\n",(0,r.jsx)(n.li,{children:"Symbol-keyed properties"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"State Design Guidelines"})}),"\n",(0,r.jsx)(n.p,{children:"Recommended pattern: Plain data with Maps/Sets/Arrays"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface GameState {\n  resources: Map<string, {\n    id: string;\n    amount: number;\n    rate: number;\n  }>;\n  entities: Map<string, {\n    id: string;\n    parent?: EntityNode; // Cycle preserved\n    children: EntityNode[];\n  }>;\n  timeline: {\n    started: Date;\n    events: Array<{ at: Date; type: string }>;\n  };\n  version: string;\n  seed: number; // RNG seed for determinism\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Performance Implications"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Clone Cost"}),": ",(0,r.jsx)(n.code,{children:"structuredClone()"})," has O(n) cost where n = object graph size"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Typical game state (10k entities): ~5-10ms clone time"}),"\n",(0,r.jsx)(n.li,{children:"Large state (100k entities): ~50-100ms clone time"}),"\n",(0,r.jsx)(n.li,{children:"Mitigation: Only clone at recording start, not per command"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Freeze Cost"}),": ",(0,r.jsx)(n.code,{children:"deepFreeze()"})," traverses entire graph once"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Same complexity as clone: O(n)"}),"\n",(0,r.jsxs)(n.li,{children:["Only called during ",(0,r.jsx)(n.code,{children:"export()"}),", not on hot path"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Memory"}),": Snapshot holds complete state copy"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Budget: ~5 MB for moderate game state"}),"\n",(0,r.jsx)(n.li,{children:"Monitor via telemetry if state grows beyond budget"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h5,{id:"command-interface",children:"Command Interface"}),"\n",(0,r.jsx)(n.p,{children:"Commands follow the classic Command pattern with typed payloads:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export interface Command<TPayload = unknown> {\n  readonly type: string;\n  readonly priority: CommandPriority;\n  readonly payload: TPayload;\n  readonly timestamp: number; // For ordering within same priority\n  readonly step: number; // Simulation tick that will execute the command\n}\n\ntype ImmutablePrimitive =\n  | string\n  | number\n  | bigint\n  | boolean\n  | symbol\n  | null\n  | undefined;\n\ntype ImmutableFunction = (...args: unknown[]) => unknown;\n\ntype ImmutableArrayLike<T> = readonly ImmutablePayload<T>[];\n\nexport type ImmutablePayload<T> = T extends ImmutablePrimitive\n  ? T\n  : T extends ImmutableFunction\n    ? T\n    : T extends ArrayBuffer\n      ? ImmutableArrayBufferSnapshot\n      : T extends SharedArrayBuffer\n        ? ImmutableSharedArrayBufferSnapshot\n        : T extends Map<infer K, infer V>\n          ? ReadonlyMap<ImmutablePayload<K>, ImmutablePayload<V>>\n          : T extends Set<infer V>\n            ? ReadonlySet<ImmutablePayload<V>>\n            : T extends Array<infer U>\n              ? ImmutableArrayLike<U>\n              : T extends ReadonlyArray<infer U>\n                ? ImmutableArrayLike<U>\n                : T extends object\n                  ? { readonly [K in keyof T]: ImmutablePayload<T[K]> }\n                  : T;\n\nexport type CommandSnapshot<TPayload = unknown> = ImmutablePayload<\n  Command<TPayload>\n>;\n\nexport type CommandSnapshotPayload<TPayload> = ImmutablePayload<TPayload>;\n\nexport enum CommandPriority {\n  SYSTEM = 0,    // Engine-generated (migrations, prestige resets)\n  PLAYER = 1,    // Direct user input (purchase, toggle)\n  AUTOMATION = 2 // Automated systems (auto-buy, auto-prestige)\n}\n"})}),"\n",(0,r.jsx)(n.h5,{id:"command-queue-structure",children:"Command Queue Structure"}),"\n",(0,r.jsx)(n.p,{children:"The queue maintains separate lanes per priority with FIFO ordering within each lane:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface CommandQueueEntry<TCommand extends Command = Command> {\n  readonly command: TCommand;\n  readonly sequence: number; // Tie-breaker when timestamps match\n}\n\nexport class CommandQueue {\n  private readonly queues: Map<\n    CommandPriority,\n    CommandQueueEntry<CommandSnapshot>[]\n  > = new Map([\n    [CommandPriority.SYSTEM, []],\n    [CommandPriority.PLAYER, []],\n    [CommandPriority.AUTOMATION, []]\n  ]);\n  private static readonly PRIORITY_ORDER: CommandPriority[] = [\n    CommandPriority.SYSTEM,\n    CommandPriority.PLAYER,\n    CommandPriority.AUTOMATION\n  ];\n\n  private nextSequence = 0;\n  private totalSize = 0;\n  private readonly maxSize: number;\n\n  constructor(maxSize: number) {\n    this.maxSize = maxSize;\n  }\n\n  enqueue(command: Command): boolean {\n    if (this.totalSize >= this.maxSize) {\n      return false;\n    }\n\n    const queue = this.queues.get(command.priority);\n    if (!queue) {\n      throw new Error(`Invalid priority: ${command.priority}`);\n    }\n\n    const storedCommand = cloneCommand(command);\n    const entry: CommandQueueEntry<CommandSnapshot> = {\n      command: storedCommand,\n      sequence: this.nextSequence++\n    };\n\n    // Binary search insertion for deterministic ordering\n    let lo = 0;\n    let hi = queue.length;\n    while (lo < hi) {\n      const mid = (lo + hi) >>> 1;\n      const other = queue[mid];\n      if (\n        other.command.timestamp < entry.command.timestamp ||\n        (other.command.timestamp === entry.command.timestamp &&\n          other.sequence < entry.sequence)\n      ) {\n        lo = mid + 1;\n      } else {\n        hi = mid;\n      }\n    }\n    queue.splice(lo, 0, entry);\n    this.totalSize++;\n    return true;\n  }\n\n  dequeueAll(): CommandSnapshot[] {\n    const result: CommandSnapshot[] = [];\n    for (const priority of CommandQueue.PRIORITY_ORDER) {\n      const queue = this.queues.get(priority);\n      if (queue && queue.length > 0) {\n        const laneLength = queue.length;\n        for (const entry of queue) {\n          result.push(entry.command);\n        }\n        queue.length = 0;\n        this.totalSize -= laneLength;\n      }\n    }\n    return result;\n  }\n\n  clear(): void {\n    for (const queue of this.queues.values()) {\n      this.totalSize -= queue.length;\n      queue.length = 0;\n    }\n    this.totalSize = 0;\n  }\n\n  get size(): number {\n    return this.totalSize;\n  }\n}\n\nfunction cloneCommand(command: Command): CommandSnapshot {\n  const snapshot = structuredClone(command);\n  return deepFreezeInPlace(snapshot);\n}\n"})}),"\n",(0,r.jsx)(n.h5,{id:"step-field-population",children:"Step Field Population"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Critical Design Pattern"}),": The ",(0,r.jsx)(n.code,{children:"step"})," field stores the ",(0,r.jsx)(n.strong,{children:"simulation tick that will execute the command"}),". The queuing site is responsible for stamping the step as the command crosses into the queue."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step Stamping Locations"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"UI Commands (from Main Thread)"}),": Worker runtime stamps with ",(0,r.jsx)(n.code,{children:"nextExecutableStep"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"System-Generated Commands (inside Worker)"}),": Systems stamp with ",(0,r.jsx)(n.code,{children:"context.step + 1"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Engine Commands (inside Worker)"}),": Engine code stamps with ",(0,r.jsx)(n.code,{children:"currentStep + 1"})]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step Lifecycle"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Tick N                                                      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 1. currentStep = N                                          \u2502\n\u2502 2. Capture commands for step N (dequeueAll)                \u2502\n\u2502    - Immediately set nextExecutableStep = N+1              \u2502\n\u2502 3. Execute queued commands (all have step = N)             \u2502\n\u2502    - Handlers see ctx.step = cmd.step = N                  \u2502\n\u2502    - Follow-on enqueues are stamped with step = N+1        \u2502\n\u2502 4. Systems tick() with context.step = N                    \u2502\n\u2502    - Each system enqueues commands stamped with step = N+1 \u2502\n\u2502 5. currentStep++ (becomes N+1)                             \u2502\n\u2502    - nextExecutableStep \u2190 currentStep (now N+1)            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(n.h5,{id:"command-execution-flow",children:"Command Execution Flow"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"let currentStep = 0;\nlet nextExecutableStep = 0;\n\nfunction runTick(deltaMs: number) {\n  accumulator += deltaMs;\n  const steps = clamp(floor(accumulator / FIXED_STEP_MS), 0, MAX_STEPS_PER_FRAME);\n  accumulator -= steps * FIXED_STEP_MS;\n\n  for (let i = 0; i < steps; i++) {\n    nextExecutableStep = currentStep;\n    const commands = commandQueue.dequeueAll();\n    nextExecutableStep = currentStep + 1;\n\n    for (const cmd of commands) {\n      if (cmd.step !== currentStep) {\n        telemetry.recordError('CommandStepMismatch', {\n          expectedStep: currentStep,\n          commandStep: cmd.step,\n          type: cmd.type\n        });\n        continue;\n      }\n      commandDispatcher.execute(cmd);\n    }\n\n    const systemContext: TickContext = {\n      step: currentStep,\n      deltaMs: FIXED_STEP_MS\n    };\n\n    const stateView =\n      process.env.NODE_ENV === 'development'\n        ? createReadOnlyProxy(gameState)\n        : gameState;\n\n    automationSystem.tick(stateView, systemContext);\n    productionSystem.tick(stateView, systemContext);\n    progressionSystem.tick(stateView, systemContext);\n    eventSystem.tick(stateView, systemContext);\n    telemetry.recordTick();\n\n    currentStep++;\n    nextExecutableStep = currentStep;\n  }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"System Constraints"})}),"\n",(0,r.jsxs)(n.p,{children:["Systems MUST NOT mutate state directly during ",(0,r.jsx)(n.code,{children:"tick()"}),". Instead, they analyze current state and enqueue commands that will be executed in the ",(0,r.jsx)(n.strong,{children:"next"})," tick step. This ensures:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["All mutations flow through the command queue and are captured by ",(0,r.jsx)(n.code,{children:"CommandRecorder"})]}),"\n",(0,r.jsx)(n.li,{children:"System logic remains pure and testable (reads state, outputs commands)"}),"\n",(0,r.jsx)(n.li,{children:"Replaying a command log reproduces identical state without re-running systems"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"System-Queue Interaction Model"})}),"\n",(0,r.jsxs)(n.p,{children:["Systems interact with the command queue ",(0,r.jsx)(n.strong,{children:"only by enqueueing commands"}),". They never need to be instrumented for replay. During replay, systems are NOT executed\u2014only commands are re-executed via the dispatcher."]}),"\n",(0,r.jsx)(n.h5,{id:"command-dispatcher",children:"Command Dispatcher"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export interface ExecutionContext {\n  readonly step: number;\n  readonly timestamp: number;\n  readonly priority: CommandPriority;\n}\n\nexport type CommandHandler<T = unknown> = (\n  payload: T,\n  context: ExecutionContext\n) => void | Promise<void>;\n\nexport class CommandDispatcher {\n  private readonly handlers = new Map<string, CommandHandler>();\n\n  register<T>(type: string, handler: CommandHandler<T>): void {\n    this.handlers.set(type, handler);\n  }\n\n  getHandler(type: string): CommandHandler | undefined {\n    return this.handlers.get(type);\n  }\n\n  forEachHandler(callback: (type: string, handler: CommandHandler) => void): void {\n    for (const [type, handler] of this.handlers.entries()) {\n      callback(type, handler);\n    }\n  }\n\n  execute(command: Command): void {\n    const handler = this.handlers.get(command.type);\n    if (!handler) {\n      telemetry.recordError('UnknownCommandType', { type: command.type });\n      return;\n    }\n\n    const context: ExecutionContext = {\n      step: command.step,\n      timestamp: command.timestamp,\n      priority: command.priority\n    };\n\n    try {\n      const result = handler(command.payload, context);\n      if (isPromiseLike(result)) {\n        result.catch((err) => {\n          telemetry.recordError('CommandExecutionFailed', {\n            type: command.type,\n            error: err instanceof Error ? err.message : String(err)\n          });\n        });\n      }\n    } catch (err) {\n      telemetry.recordError('CommandExecutionFailed', {\n        type: command.type,\n        error: err instanceof Error ? err.message : String(err)\n      });\n    }\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h5,{id:"resourcestate-integration",children:"ResourceState Integration"}),"\n",(0,r.jsxs)(n.p,{children:["Command handlers depend on the ",(0,r.jsx)(n.code,{children:"ResourceState"})," fa\xe7ade exported from ",(0,r.jsx)(n.code,{children:"@idle-engine/core"}),". The fa\xe7ade centralizes index lookups, dirty tracking, and telemetry:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { type ResourceState } from '@idle-engine/core';\n\nconst resources: ResourceState = runtimeResources;\n\ndispatcher.register<CollectResourcePayload>(\n  'COLLECT_RESOURCE',\n  (payload, ctx) => {\n    const index = resources.requireIndex(payload.resourceId);\n    const applied = resources.addAmount(index, payload.amount);\n    if (applied !== payload.amount) {\n      telemetry.recordWarning('ResourceCollectClamped', {\n        command: 'COLLECT_RESOURCE',\n        resourceId: payload.resourceId,\n        requested: payload.amount,\n        applied,\n        step: ctx.step,\n      });\n    }\n  },\n);\n"})}),"\n",(0,r.jsx)(n.p,{children:"Key invariants for handlers:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Index acquisition"}),": ",(0,r.jsx)(n.code,{children:"requireIndex(id)"})," throws after recording telemetry when handed an unknown id"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Mutation helpers"}),": ",(0,r.jsx)(n.code,{children:"addAmount"}),", ",(0,r.jsx)(n.code,{children:"spendAmount"}),", ",(0,r.jsx)(n.code,{children:"setCapacity"}),", etc. clamp values and emit telemetry"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Dirty propagation"}),": Successful mutations mark indices dirty for publish snapshots"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"data--schemas",children:"Data & Schemas"}),"\n",(0,r.jsx)(n.h5,{id:"command-types-initial-set",children:"Command Types (Initial Set)"}),"\n",(0,r.jsx)(n.p,{children:"For the prototype milestone, we define commands for core interactions:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Resource Commands"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface PurchaseGeneratorPayload {\n  generatorId: string;\n  count: number;\n}\n\ninterface ToggleGeneratorPayload {\n  generatorId: string;\n  enabled: boolean;\n}\n\ninterface CollectResourcePayload {\n  resourceId: string;\n  amount: number;\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Prestige Commands"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface PrestigeResetPayload {\n  layer: number;\n  confirmationToken?: string;\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"System Commands"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface OfflineCatchupPayload {\n  elapsedMs: number;\n  resourceDeltas: Record<string, number>;\n  maxElapsedMs?: number;\n  maxSteps?: number;\n}\n\ninterface ApplyMigrationPayload {\n  fromVersion: string;\n  toVersion: string;\n  transformations: MigrationStep[];\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"maxElapsedMs"})," must be a non-negative finite number, and ",(0,r.jsx)(n.code,{children:"maxSteps"})," must be a non-negative integer; invalid values are rejected during restore validation."]}),"\n",(0,r.jsx)(n.h5,{id:"priority-resolution",children:"Priority Resolution"}),"\n",(0,r.jsx)(n.p,{children:"When multiple commands are enqueued during a single frame:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"System commands"})," (priority 0) execute first"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Player commands"})," (priority 1) execute next"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Automation commands"})," (priority 2) execute last"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Within the same priority tier, commands execute in timestamp order (FIFO)."}),"\n",(0,r.jsx)(n.h4,{id:"apis--contracts",children:"APIs & Contracts"}),"\n",(0,r.jsx)(n.h5,{id:"worker-bridge-api",children:"Worker Bridge API"}),"\n",(0,r.jsx)(n.p,{children:"Presentation integrations should provide a type-safe command interface for the UI layer:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export enum CommandSource {\n  PLAYER = 'PLAYER',\n  AUTOMATION = 'AUTOMATION',\n  SYSTEM = 'SYSTEM'\n}\n\nexport interface WorkerBridge {\n  sendCommand<T = unknown>(type: string, payload: T): void;\n  onStateUpdate(callback: (state: GameState) => void): void;\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The bridge implementation wraps commands with metadata and posts to the Worker. The Worker runtime stamps external commands with ",(0,r.jsx)(n.code,{children:"nextExecutableStep"})," before enqueueing."]}),"\n",(0,r.jsx)(n.h5,{id:"command-recording--replay",children:"Command Recording & Replay"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Recorder Snapshot Lifecycle"})}),"\n",(0,r.jsxs)(n.p,{children:["The recorder captures its state snapshot at ",(0,r.jsx)(n.strong,{children:"construction time"}),", before any commands are recorded."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export interface CommandLog {\n  readonly version: string;\n  readonly startState: StateSnapshot;\n  readonly commands: readonly Command[];\n  readonly metadata: {\n    readonly recordedAt: number;\n    readonly seed?: number;\n    readonly lastStep: number;\n  };\n}\n\nexport class CommandRecorder {\n  private readonly recorded: Command[] = [];\n  private startState: StateSnapshot;\n  private rngSeed: number | undefined;\n  private lastRecordedStep = -1;\n\n  constructor(currentState: GameState, options?: { seed?: number }) {\n    this.startState = cloneDeep(currentState);\n    deepFreezeInPlace(this.startState);\n    this.rngSeed = options?.seed ?? getCurrentRNGSeed?.();\n  }\n\n  record(command: Command): void {\n    const snapshot = cloneDeep(command);\n    deepFreezeInPlace(snapshot);\n    this.recorded.push(snapshot);\n    this.lastRecordedStep = Math.max(this.lastRecordedStep, command.step);\n  }\n\n  export(): CommandLog {\n    const exportedLog = {\n      version: '0.1.0',\n      startState: cloneDeep(this.startState),\n      commands: this.recorded.map(cloneDeep),\n      metadata: {\n        recordedAt: Date.now(),\n        seed: this.rngSeed,\n        lastStep: this.lastRecordedStep\n      }\n    };\n    return deepFreezeInPlace(exportedLog);\n  }\n\n  replay(log: CommandLog, dispatcher: CommandDispatcher): void {\n    for (const cmd of log.commands) {\n      const handler = dispatcher.getHandler(cmd.type);\n      if (handler) {\n        handler(cmd.payload, {\n          step: cmd.step,\n          timestamp: cmd.timestamp,\n          priority: cmd.priority\n        });\n      }\n    }\n  }\n\n  clear(nextState: GameState, options?: { seed?: number }): void {\n    this.recorded.length = 0;\n    this.startState = cloneDeep(nextState);\n    deepFreezeInPlace(this.startState);\n    this.rngSeed = options?.seed ?? getCurrentRNGSeed?.();\n    this.lastRecordedStep = -1;\n  }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Usage Patterns"})}),"\n",(0,r.jsx)(n.p,{children:"Session Recording (typical use case):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const gameState = await loadSaveOrCreateNew();\nconst sessionRecorder = new CommandRecorder(gameState);\n\nfunction executeAndRecord(cmd: Command) {\n  sessionRecorder.record(cmd);\n  dispatcher.execute(cmd);\n}\n\nconst log = sessionRecorder.export();\nsendToServer(log);\n"})}),"\n",(0,r.jsx)(n.p,{children:"Deterministic Testing:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const testState = { resources: { energy: 100 }, generators: {} };\nconst recorder = new CommandRecorder(testState);\n\nfor (const cmd of commands) {\n  recorder.record(cmd);\n  dispatcher.execute(cmd);\n}\n\nconst log = recorder.export();\nconst replayState = await replayLog(log);\nexpect(replayState).toEqual(currentState);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"63-operational-considerations",children:"6.3 Operational Considerations"}),"\n",(0,r.jsx)(n.h4,{id:"deployment",children:"Deployment"}),"\n",(0,r.jsx)(n.p,{children:"The command queue is integrated into the runtime core package and deployed as part of the Worker bundle. No separate deployment or rollout is required."}),"\n",(0,r.jsx)(n.h4,{id:"telemetry--observability",children:"Telemetry & Observability"}),"\n",(0,r.jsx)(n.p,{children:"Key metrics exposed:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"CommandQueueDepth"}),": Current size of each priority lane"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"CommandExecutionTime"}),": Time spent processing commands per tick"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"CommandStepMismatch"}),": Commands with incorrect step stamps"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"CommandDropped"}),": Commands evicted due to queue overflow"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"UnknownCommandType"}),": Unregistered command types"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"CommandExecutionFailed"}),": Handler exceptions"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"security--compliance",children:"Security & Compliance"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Command payloads from external sources are validated before execution"}),"\n",(0,r.jsx)(n.li,{children:"Queue size limits prevent memory exhaustion attacks"}),"\n",(0,r.jsx)(n.li,{children:"Command logs may contain sensitive game state\u2014encryption required for transmission"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"64-transport-protocol-usage-issue-545",children:"6.4 Transport Protocol Usage (Issue 545)"}),"\n",(0,r.jsxs)(n.p,{children:["When commands cross process or network boundaries, the command queue remains the execution authority while the transport layer adds envelopes, acknowledgments, and idempotency handling. Use ",(0,r.jsx)(n.code,{children:"CommandEnvelope"}),"/",(0,r.jsx)(n.code,{children:"CommandResponse"}),", the idempotency registry, and the pending tracker as described in ",(0,r.jsx)(n.a,{href:"/Idle-Game-Engine/runtime-command-transport-design-issue-545",children:"Runtime Command Transport Design (Issue 545)"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"7-work-breakdown--delivery-plan",children:"7. Work Breakdown & Delivery Plan"}),"\n",(0,r.jsx)(n.h3,{id:"71-issue-map",children:"7.1 Issue Map"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Issue Title"}),(0,r.jsx)(n.th,{children:"Scope Summary"}),(0,r.jsx)(n.th,{children:"Proposed Assignee/Agent"}),(0,r.jsx)(n.th,{children:"Dependencies"}),(0,r.jsx)(n.th,{children:"Acceptance Criteria"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"feat(core): implement CommandQueue data structure"}),(0,r.jsx)(n.td,{children:"Priority-based queue with FIFO lanes"}),(0,r.jsx)(n.td,{children:"Runtime Implementation Agent"}),(0,r.jsx)(n.td,{children:"Design approval"}),(0,r.jsx)(n.td,{children:"Unit tests pass; deterministic ordering verified"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"feat(core): implement CommandDispatcher"}),(0,r.jsx)(n.td,{children:"Handler registration and execution"}),(0,r.jsx)(n.td,{children:"Runtime Implementation Agent"}),(0,r.jsx)(n.td,{children:"CommandQueue complete"}),(0,r.jsx)(n.td,{children:"Handler registration works; execution context correct"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"feat(core): add command types for resource operations"}),(0,r.jsx)(n.td,{children:"Payload interfaces for core commands"}),(0,r.jsx)(n.td,{children:"Runtime Implementation Agent"}),(0,r.jsx)(n.td,{children:"None"}),(0,r.jsx)(n.td,{children:"TypeScript compilation; payload validation"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"feat(core): integrate command queue into tick loop"}),(0,r.jsx)(n.td,{children:"Connect queue to runtime execution"}),(0,r.jsx)(n.td,{children:"Integration Agent"}),(0,r.jsx)(n.td,{children:"CommandQueue, CommandDispatcher"}),(0,r.jsx)(n.td,{children:"Commands execute in correct order within tick"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"feat(core): implement command handlers"}),(0,r.jsx)(n.td,{children:"Resource operation handlers"}),(0,r.jsx)(n.td,{children:"Integration Agent"}),(0,r.jsx)(n.td,{children:"Tick loop integration"}),(0,r.jsx)(n.td,{children:"Handlers mutate state correctly; telemetry emitted"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"feat(presentation-shell): add worker bridge command handler (archived)"}),(0,r.jsx)(n.td,{children:"Message handling for external commands"}),(0,r.jsx)(n.td,{children:"Integration Agent"}),(0,r.jsx)(n.td,{children:"Tick loop integration"}),(0,r.jsx)(n.td,{children:"Commands from UI reach runtime; step stamping correct"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"feat(core): implement CommandRecorder"}),(0,r.jsx)(n.td,{children:"Recording and replay functionality"}),(0,r.jsx)(n.td,{children:"Runtime Implementation Agent"}),(0,r.jsx)(n.td,{children:"CommandDispatcher"}),(0,r.jsx)(n.td,{children:"Replay produces identical state; logs are immutable"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"feat(core): add queue capacity limits"}),(0,r.jsx)(n.td,{children:"Overflow handling and eviction"}),(0,r.jsx)(n.td,{children:"Runtime Implementation Agent"}),(0,r.jsx)(n.td,{children:"CommandQueue"}),(0,r.jsx)(n.td,{children:"Queue respects limits; telemetry on overflow"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"docs(core): document command API contracts"}),(0,r.jsx)(n.td,{children:"API documentation for content modules"}),(0,r.jsx)(n.td,{children:"Documentation Agent"}),(0,r.jsx)(n.td,{children:"All implementation complete"}),(0,r.jsx)(n.td,{children:"Clear usage examples; common patterns documented"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"72-milestones",children:"7.2 Milestones"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Phase 1: Core Implementation (Week 1)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"CommandQueue and CommandDispatcher implementation"}),"\n",(0,r.jsx)(n.li,{children:"Basic command types and payload interfaces"}),"\n",(0,r.jsx)(n.li,{children:"Unit tests for queue ordering and priority resolution"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Phase 2: Integration (Week 2)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Tick loop integration"}),"\n",(0,r.jsx)(n.li,{children:"Command handlers for core operations"}),"\n",(0,r.jsx)(n.li,{children:"External command ingress handling (archived)"}),"\n",(0,r.jsx)(n.li,{children:"Integration tests for end-to-end flow"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Phase 3: Recording & Polish (Week 3)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"CommandRecorder implementation"}),"\n",(0,r.jsx)(n.li,{children:"Queue capacity limits and error handling"}),"\n",(0,r.jsx)(n.li,{children:"API documentation"}),"\n",(0,r.jsx)(n.li,{children:"Performance profiling"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"73-coordination-notes",children:"7.3 Coordination Notes"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Hand-off Package"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Source files: ",(0,r.jsx)(n.code,{children:"packages/core/src/command-queue.ts"}),", ",(0,r.jsx)(n.code,{children:"packages/core/src/command-dispatcher.ts"}),", ",(0,r.jsx)(n.code,{children:"packages/core/src/command-recorder.ts"})]}),"\n",(0,r.jsxs)(n.li,{children:["Test files: ",(0,r.jsx)(n.code,{children:"packages/core/src/command-queue.test.ts"}),", ",(0,r.jsx)(n.code,{children:"packages/core/src/index.test.ts"})]}),"\n",(0,r.jsxs)(n.li,{children:["Integration points: ",(0,r.jsx)(n.code,{children:"packages/core/src/index.ts"})," (tick loop), worker bridge harnesses (archived)"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Communication Cadence"}),": Daily status updates during active implementation; review checkpoints at end of each phase"]}),"\n",(0,r.jsx)(n.h2,{id:"8-agent-guidance--guardrails",children:"8. Agent Guidance & Guardrails"}),"\n",(0,r.jsx)(n.h3,{id:"context-packets",children:"Context Packets"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Review Idle Engine Design Document (Section 9.1 - Tick Pseudocode)"}),"\n",(0,r.jsx)(n.li,{children:"Review Resource State Storage Design (Section 5.2 - Runtime API Surface)"}),"\n",(0,r.jsx)(n.li,{children:"Review Implementation Plan (Section 4 - Runtime Core Tasks)"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"prompting--constraints",children:"Prompting & Constraints"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"All command interfaces must be readonly to enforce immutability"}),"\n",(0,r.jsxs)(n.li,{children:["Use ",(0,r.jsx)(n.code,{children:"structuredClone()"})," for defensive copying"]}),"\n",(0,r.jsxs)(n.li,{children:["Apply ",(0,r.jsx)(n.code,{children:"deepFreezeInPlace()"})," to command snapshots in development builds"]}),"\n",(0,r.jsxs)(n.li,{children:["Follow naming convention: ",(0,r.jsx)(n.code,{children:"Command"})," suffix for interfaces, ",(0,r.jsx)(n.code,{children:"Payload"})," suffix for data types"]}),"\n",(0,r.jsxs)(n.li,{children:["Commit messages must follow conventional commits format: ",(0,r.jsx)(n.code,{children:"feat(core): <description>"})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"safety-rails",children:"Safety Rails"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Do not mutate state directly in systems\u2014always enqueue commands"}),"\n",(0,r.jsx)(n.li,{children:"Do not skip command validation\u2014handlers must verify preconditions"}),"\n",(0,r.jsx)(n.li,{children:"Do not ignore telemetry\u2014emit events for all error conditions"}),"\n",(0,r.jsxs)(n.li,{children:["Do not use ",(0,r.jsx)(n.code,{children:"Math.random()"}),"\u2014use seeded PRNG for determinism"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"validation-hooks",children:"Validation Hooks"}),"\n",(0,r.jsx)(n.p,{children:"Before marking implementation complete:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Run ",(0,r.jsx)(n.code,{children:"npm test"})," and verify all tests pass"]}),"\n",(0,r.jsxs)(n.li,{children:["Run ",(0,r.jsx)(n.code,{children:"npm run build"})," and verify no TypeScript errors"]}),"\n",(0,r.jsxs)(n.li,{children:["Run ",(0,r.jsx)(n.code,{children:"npm run lint"})," and verify no linting errors"]}),"\n",(0,r.jsx)(n.li,{children:"Verify command replay produces identical state in integration tests"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"9-alternatives-considered",children:"9. Alternatives Considered"}),"\n",(0,r.jsx)(n.h3,{id:"alternative-1-direct-state-mutation",children:"Alternative 1: Direct State Mutation"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Description"}),": Allow systems to mutate state directly without a command queue"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Pros"}),": Simpler implementation, lower overhead"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Cons"}),": Non-deterministic replay, difficult debugging, no priority control"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Decision"}),": Rejected. Determinism is a core requirement for offline catch-up."]}),"\n",(0,r.jsx)(n.h3,{id:"alternative-2-event-bus-pattern",children:"Alternative 2: Event Bus Pattern"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Description"}),": Publish/subscribe event system for state changes"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Pros"}),": Decoupled components, extensible"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Cons"}),": Execution order non-deterministic, harder to replay, performance overhead from event dispatching"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Decision"}),": Rejected. Command pattern provides better determinism guarantees."]}),"\n",(0,r.jsx)(n.h3,{id:"alternative-3-transaction-log",children:"Alternative 3: Transaction Log"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Description"}),": Record state diffs instead of commands"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Pros"}),": Smaller log size, faster replay"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Cons"}),": Complex diff calculation, harder to debug (diffs less readable than commands), replay requires perfect state reconstruction"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Decision"}),": Rejected. Commands are more debuggable and easier to reason about."]}),"\n",(0,r.jsx)(n.h2,{id:"10-testing--validation-plan",children:"10. Testing & Validation Plan"}),"\n",(0,r.jsx)(n.h3,{id:"unit--integration",children:"Unit / Integration"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Unit Tests"})," (",(0,r.jsx)(n.code,{children:"packages/core/src/command-queue.test.ts"}),"):"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Commands execute in priority order"}),"\n",(0,r.jsx)(n.li,{children:"FIFO ordering maintained within same priority"}),"\n",(0,r.jsx)(n.li,{children:"Timestamp-based ordering with sequence fallback"}),"\n",(0,r.jsx)(n.li,{children:"Queue size tracking accurate"}),"\n",(0,r.jsx)(n.li,{children:"Clear operation resets state"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Integration Tests"})," (",(0,r.jsx)(n.code,{children:"packages/core/src/index.test.ts"}),"):"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Commands execute correctly within tick loop"}),"\n",(0,r.jsx)(n.li,{children:"Step stamping accurate for all sources"}),"\n",(0,r.jsx)(n.li,{children:"System-generated commands enqueue for next tick"}),"\n",(0,r.jsx)(n.li,{children:"State mutations apply through ResourceState facade"}),"\n",(0,r.jsx)(n.li,{children:"Telemetry emitted on errors"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Replay Tests"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Replaying command log reproduces identical state"}),"\n",(0,r.jsx)(n.li,{children:"Exported logs are immutable"}),"\n",(0,r.jsx)(n.li,{children:"Seed restoration works correctly"}),"\n",(0,r.jsx)(n.li,{children:"Clear operation resets recorder state"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"performance",children:"Performance"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Benchmarks"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["10,000 queued commands process in ",(0,r.jsx)(n.code,{children:"<5ms"})]}),"\n",(0,r.jsxs)(n.li,{children:["Command overhead ",(0,r.jsx)(n.code,{children:"<5%"})," of 100ms tick budget"]}),"\n",(0,r.jsxs)(n.li,{children:["Memory footprint ",(0,r.jsx)(n.code,{children:"<3MB"})," for typical queue depth"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Profiling Methodology"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Use Chrome DevTools performance profiling in Worker context"}),"\n",(0,r.jsx)(n.li,{children:"Measure enqueue, dequeue, and execute separately"}),"\n",(0,r.jsx)(n.li,{children:"Test with realistic command mix (70% automation, 20% player, 10% system)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Success Thresholds"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Enqueue: ",(0,r.jsx)(n.code,{children:"<1\xb5s"})," per command"]}),"\n",(0,r.jsxs)(n.li,{children:["Dequeue: ",(0,r.jsx)(n.code,{children:"<5ms"})," for full queue drain"]}),"\n",(0,r.jsxs)(n.li,{children:["Execute: ",(0,r.jsx)(n.code,{children:"<10\xb5s"})," per command (handler-dependent)"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"tooling--a11y",children:"Tooling / A11y"}),"\n",(0,r.jsx)(n.p,{children:"N/A - This is a runtime-only feature with no UI components."}),"\n",(0,r.jsx)(n.h2,{id:"11-risks--mitigations",children:"11. Risks & Mitigations"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Risk"}),": Queue overflow from runaway automation\n",(0,r.jsx)(n.strong,{children:"Mitigation"}),": Implement ",(0,r.jsx)(n.code,{children:"MAX_QUEUE_SIZE"})," limit with priority-based eviction. Emit telemetry on overflow for monitoring."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Risk"}),": Non-deterministic command generation in systems\n",(0,r.jsx)(n.strong,{children:"Mitigation"}),": Enforce read-only state proxies in development builds. Document determinism requirements clearly."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Risk"}),": Handler exceptions breaking tick loop\n",(0,r.jsx)(n.strong,{children:"Mitigation"}),": Wrap handler execution in try-catch. Log errors via telemetry but continue processing remaining commands."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Risk"}),": Replay divergence due to missing RNG seed\n",(0,r.jsx)(n.strong,{children:"Mitigation"}),": Capture RNG seed in CommandLog metadata. Restore seed before replay."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Risk"}),": Performance degradation with large command logs\n",(0,r.jsx)(n.strong,{children:"Mitigation"}),": Batch replay in chunks of 1000 commands. Profile and optimize hot paths."]}),"\n",(0,r.jsx)(n.h2,{id:"12-rollout-plan",children:"12. Rollout Plan"}),"\n",(0,r.jsx)(n.h3,{id:"milestones",children:"Milestones"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Week 1"}),": Core implementation complete, unit tests passing"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Week 2"}),": Integration complete, end-to-end tests passing"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Week 3"}),": Recording/replay complete, documentation published"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"migration-strategy",children:"Migration Strategy"}),"\n",(0,r.jsx)(n.p,{children:"No migration required\u2014this is a new feature. Existing systems will be refactored to use command queue as they are implemented."}),"\n",(0,r.jsx)(n.h3,{id:"communication",children:"Communication"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Publish API documentation in ",(0,r.jsx)(n.code,{children:"/docs"})," directory"]}),"\n",(0,r.jsx)(n.li,{children:"Add usage examples in implementation plan"}),"\n",(0,r.jsx)(n.li,{children:"Notify content module authors of command API availability"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"13-open-questions",children:"13. Open Questions"}),"\n",(0,r.jsx)(n.p,{children:"All design questions have been resolved through the development process. See Section 15 (Resolved Decisions) for documentation of key decisions."}),"\n",(0,r.jsx)(n.h2,{id:"14-follow-up-work",children:"14. Follow-Up Work"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Post-Prototype Enhancements"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Conditional Commands: Commands that execute only when predicates are met"}),"\n",(0,r.jsx)(n.li,{children:"Macro Commands: Composite commands for complex multi-step actions"}),"\n",(0,r.jsx)(n.li,{children:"Network Sync: Serialize command stream for multiplayer synchronization"}),"\n",(0,r.jsx)(n.li,{children:"Rollback: Store command checkpoints for efficient undo/redo"}),"\n",(0,r.jsx)(n.li,{children:"Compression: Delta-encode command logs for reduced storage/bandwidth"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Technical Debt"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Extend read-only proxy to wrap Map/Set accessor results"}),"\n",(0,r.jsx)(n.li,{children:"Implement multiple RNG stream registration API"}),"\n",(0,r.jsx)(n.li,{children:"Add command log encryption for secure transmission"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"15-references",children:"15. References"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://gameprogrammingpatterns.com/command.html",children:"Game Programming Patterns: Command"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://gameprogrammingpatterns.com/event-queue.html",children:"Game Programming Patterns: Event Queue"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/Idle-Game-Engine/idle-engine-design",children:"Idle Engine Design Document"})," (Section 9.1 - Tick Pseudocode)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/Idle-Game-Engine/resource-state-storage-design",children:"Resource State Storage Design"})," (Section 5.2 - Runtime API Surface)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/Idle-Game-Engine/implementation-plan",children:"Implementation Plan"})," (Section 4 - Runtime Core Tasks)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/Idle-Game-Engine/tick-accumulator-coverage-design",children:"Tick Accumulator Coverage Design"})," (Sections 5.1-5.3)"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Relevant Code Paths"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"packages/core/src/command-queue.ts"}),": CommandQueue implementation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"packages/core/src/command-dispatcher.ts"}),": CommandDispatcher implementation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"packages/core/src/command-recorder.ts"}),": CommandRecorder implementation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"packages/core/src/index.ts:120"}),": Tick loop integration"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"packages/core/src/command-queue.test.ts:553"}),": Priority resolution tests"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"packages/core/src/index.test.ts:193"}),": Integration tests"]}),"\n",(0,r.jsx)(n.li,{children:"Archived worker bridge tests (removed with presentation shell deprecation)"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"appendix-a--glossary",children:"Appendix A \u2014 Glossary"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Command"}),": An object representing a state mutation with type, priority, payload, timestamp, and step"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Command Queue"}),": Priority-based queue structure maintaining separate FIFO lanes per priority tier"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Command Dispatcher"}),": Routes commands to type-specific handlers and manages execution context"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Command Recorder"}),": Captures command history and initial state for replay and debugging"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Command Priority"}),": Enumeration defining execution order (SYSTEM < PLAYER < AUTOMATION)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Command Snapshot"}),": Immutable, frozen copy of a command for replay and logging"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Execution Context"}),": Metadata passed to handlers (step, timestamp, priority)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Step"}),": Simulation tick number when a command will execute"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Structured Clone"}),": Deep copy operation supporting cycles, Maps, Sets, and typed arrays"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Deep Freeze"}),": Recursive immutability enforcement via ",(0,r.jsx)(n.code,{children:"Object.freeze()"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"FIFO"}),": First-In-First-Out ordering within priority lanes"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Determinism"}),": Property ensuring identical inputs produce identical outputs"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"appendix-b--change-log",children:"Appendix B \u2014 Change Log"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Date"}),(0,r.jsx)(n.th,{children:"Author"}),(0,r.jsx)(n.th,{children:"Change Summary"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"2025-10-11"}),(0,r.jsx)(n.td,{children:"Runtime Core Team"}),(0,r.jsx)(n.td,{children:"Migrated to design document template format"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"2025-10-11"}),(0,r.jsx)(n.td,{children:"Runtime Core Team"}),(0,r.jsx)(n.td,{children:"Added accumulator diagnostics coverage; documented system execution order, error handling, and deferred enqueue behavior; strengthened priority guarantees; validated monotonic clock behavior"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"appendix-c--resolved-decisions",children:"Appendix C \u2014 Resolved Decisions"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Automation throttling"}),": No per-tick throttle in the initial release. We rely on ",(0,r.jsx)(n.code,{children:"MAX_QUEUE_SIZE"}),", per-priority depth telemetry, and ",(0,r.jsx)(n.code,{children:"CommandQueueOverflow"}),"/",(0,r.jsx)(n.code,{children:"CommandDropped"})," signals to surface runaway automation. If telemetry shows chronic starvation, we will introduce targeted throttles as a follow-up enhancement."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Command conflicts"}),": Handlers must revalidate state at execution time and gracefully no-op when their preconditions are invalidated (emitting ",(0,r.jsx)(n.code,{children:"telemetry.recordWarning('CommandConflict', \u2026)"}),"). Destructive operations such as prestige reset must flush or invalidate dependent state via their handlers; the queue itself remains FIFO and does not perform speculative reordering."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Multiple RNG streams"}),": Yes. Each subsystem that owns an independent PRNG must register with the runtime RNG module so the recorder can capture and restore every active seed. The RNG helper will expose ",(0,r.jsx)(n.code,{children:"registerRNGStream(id, getSeed, setSeed)"})," to supplement the existing global seed capture."]}),"\n",(0,r.jsx)(n.h2,{id:"appendix-d--implementation-status",children:"Appendix D \u2014 Implementation Status"}),"\n",(0,r.jsx)(n.h3,{id:"completed-tasks-week-1",children:"Completed Tasks (Week 1)"}),"\n",(0,r.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",checked:!0,disabled:!0})," ","Implement ",(0,r.jsx)(n.code,{children:"CommandQueue"})," data structure with priority lanes"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",checked:!0,disabled:!0})," ","Implement ",(0,r.jsx)(n.code,{children:"CommandDispatcher"})," with handler registration"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",checked:!0,disabled:!0})," ","Add command types and payload interfaces for resource operations"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",checked:!0,disabled:!0})," ","Write unit tests for queue ordering and priority resolution (",(0,r.jsx)(n.code,{children:"packages/core/src/command-queue.test.ts:553"}),")"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"in-progress-week-2",children:"In Progress (Week 2)"}),"\n",(0,r.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Integrate command queue into tick loop (update ",(0,r.jsx)(n.code,{children:"IdleEngineRuntime"}),")"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Implement command handlers for purchase/toggle operations"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Add external command ingress handling in downstream shells (archived)"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",checked:!0,disabled:!0})," ","Write integration tests for end-to-end command flow (",(0,r.jsx)(n.code,{children:"packages/core/src/index.test.ts:193"}),")"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"pending-week-3",children:"Pending (Week 3)"}),"\n",(0,r.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Implement ",(0,r.jsx)(n.code,{children:"CommandRecorder"})," for debugging/replay"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Add validation layer with error handling"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Implement queue capacity limits and overflow handling"]}),"\n",(0,r.jsxs)(n.li,{className:"task-list-item",children:[(0,r.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Document command API contracts for content modules"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"success-criteria-status",children:"Success Criteria Status"}),"\n",(0,r.jsx)(n.p,{children:"The command queue is complete when:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Determinism"}),": Replaying a command log produces identical final state (verified by property tests) - IN PROGRESS"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Priority"}),": Commands execute in correct priority order across 1000+ enqueued commands (benchmark) - COMPLETE"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Performance"}),": Command processing overhead stays under 5% of the tick budget at 60 ticks/sec (profiled) - PENDING"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Integration"}),": Downstream shells can enqueue commands, runtime executes them, state updates reflected in UI (E2E test) - IN PROGRESS"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Observability"}),": Command queue depth and execution metrics exposed via diagnostics interface - PENDING"]}),"\n"]})]})}function m(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},7678:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>a});var i=t(9430);const r={},s=i.createContext(r);function o(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);