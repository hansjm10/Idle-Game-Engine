"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[174],{6726:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>m,frontMatter:()=>c,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"runtime-step-lifecycle","title":"Runtime Step Lifecycle Alignment","description":"This note cross-references the implementation with","source":"@site/../../docs/runtime-step-lifecycle.md","sourceDirName":".","slug":"/runtime-step-lifecycle","permalink":"/Idle-Game-Engine/runtime-step-lifecycle","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/runtime-step-lifecycle.md","tags":[],"version":"current","frontMatter":{},"sidebar":"developerSidebar","previous":{"title":"Idle Engine Design Document","permalink":"/Idle-Game-Engine/idle-engine-design"},"next":{"title":"Runtime Command Queue Design Document","permalink":"/Idle-Game-Engine/runtime-command-queue-design"}}');var s=t(5270),r=t(7678);const c={},o="Runtime Step Lifecycle Alignment",l={},d=[{value:"IdleEngineRuntime (Worker)",id:"idleengineruntime-worker",level:2},{value:"Worker Bridge",id:"worker-bridge",level:2},{value:"Presentation Shell",id:"presentation-shell",level:2},{value:"Automation System Timestamps",id:"automation-system-timestamps",level:2},{value:"Diagnostics Timeline",id:"diagnostics-timeline",level:2}];function a(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"runtime-step-lifecycle-alignment",children:"Runtime Step Lifecycle Alignment"})}),"\n",(0,s.jsxs)(n.p,{children:["This note cross-references the implementation with\n",(0,s.jsx)(n.code,{children:"docs/runtime-command-queue-design.md"})," \xa74.3 to confirm that runtime, systems,\nand UI sources stamp commands consistently."]}),"\n",(0,s.jsx)(n.h2,{id:"idleengineruntime-worker",children:"IdleEngineRuntime (Worker)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/core/src/index.ts"})," manages ",(0,s.jsx)(n.code,{children:"currentStep"})," / ",(0,s.jsx)(n.code,{children:"nextExecutableStep"}),"\nexactly as described in the design. The tick loop sets\n",(0,s.jsx)(n.code,{children:"nextExecutableStep = currentStep"})," before capturing the queue batch, advances\nit to ",(0,s.jsx)(n.code,{children:"currentStep + 1"})," as soon as the batch is secured, and records a\n",(0,s.jsx)(n.code,{children:"CommandStepMismatch"})," telemetry event if a queued command is stamped for a\ndifferent tick."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"TickContext.step"})," surfaces the just-executed tick so internal systems stamp\nfollow-up commands with ",(0,s.jsx)(n.code,{children:"context.step + 1"}),", aligning system enqueues with the\nnext tick boundary."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"worker-bridge",children:"Worker Bridge"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.ts"})," acts as the security boundary for UI\ncommands. Incoming messages are always treated as ",(0,s.jsx)(n.code,{children:"PLAYER"})," priority and\nstamped with the Worker's monotonic clock plus the runtime's\n",(0,s.jsx)(n.code,{children:"getNextExecutableStep()"})," value before entering the queue (\xa77.2). Systems\nrunning inside the Worker can enqueue with elevated priorities because they\nalready execute within the trusted boundary."]}),"\n",(0,s.jsx)(n.li,{children:"The Worker runs the simulation loop on a fixed interval, forwarding the\ncurrent step back to the UI so presentation code can confirm progression\nwithout accessing internal counters directly."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"presentation-shell",children:"Presentation Shell"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/shell-web/src/modules/worker-bridge.ts"})," exposes ",(0,s.jsx)(n.code,{children:"sendCommand"})," that\nmirrors the design\u2019s ",(0,s.jsx)(n.code,{children:"WorkerBridge"})," API (\xa77.1). The bridge wraps UI commands\nwith ",(0,s.jsx)(n.code,{children:"CommandSource.PLAYER"})," and a UI-side timestamp while delegating actual\nstep stamping to the Worker."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"packages/shell-web/src/modules/App.tsx"})," consumes the bridge and reacts to\nstate updates, keeping UI logic aligned with the Worker-driven tick lifecycle\nrather than assuming direct access to runtime internals."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Together these pieces keep live execution, system automation, and UI command\nentry synchronized with the fixed-step lifecycle detailed in the design doc."}),"\n",(0,s.jsx)(n.h2,{id:"automation-system-timestamps",children:"Automation System Timestamps"}),"\n",(0,s.jsxs)(n.p,{children:["The automation system enqueues commands using deterministic timestamps derived\nfrom ",(0,s.jsx)(n.code,{children:"step * stepDurationMs"})," rather than wall-clock time (",(0,s.jsx)(n.code,{children:"Date.now()"})," or\n",(0,s.jsx)(n.code,{children:"performance.now()"}),"). This ensures that replaying the same simulation state\nproduces identical command queue ordering, which is critical for:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Reproducibility"}),": Offline progression and catch-up simulations produce\nconsistent results across different execution environments."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Debugging"}),": Command recorder logs can be reliably replayed to reproduce\nissues without timing-dependent variations."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Testing"}),": Integration tests verify deterministic behavior by comparing\ncommand timestamps across multiple runs."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"enqueueAutomationCommand"})," function in\n",(0,s.jsx)(n.code,{children:"packages/core/src/automation-system.ts"})," accepts ",(0,s.jsx)(n.code,{children:"stepDurationMs"})," as a parameter\nand calculates ",(0,s.jsx)(n.code,{children:"timestamp = currentStep * stepDurationMs"})," before enqueueing. This\naligns with the runtime's fixed-step tick lifecycle and ensures all automation\ncommands use simulation time rather than real-world time."]}),"\n",(0,s.jsx)(n.h2,{id:"diagnostics-timeline",children:"Diagnostics Timeline"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Enable diagnostics by providing ",(0,s.jsx)(n.code,{children:"diagnostics: { timeline: { enabled: true } }"})," when constructing ",(0,s.jsx)(n.code,{children:"IdleEngineRuntime"})," or calling ",(0,s.jsx)(n.code,{children:"runtime.enableDiagnostics({ enabled: true })"})," mid-session. The controller resolves budgets from the runtime configuration so thresholds stay consistent across hosts."]}),"\n",(0,s.jsxs)(n.li,{children:["The devtools helper ",(0,s.jsx)(n.code,{children:"formatLatestDiagnosticTimelineEntry()"})," (",(0,s.jsx)(n.code,{children:"packages/core/src/devtools/diagnostics.ts"}),") converts the most recent timeline entry into a console-friendly message while preserving full metadata for inspection."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"import { formatLatestDiagnosticTimelineEntry } from '@idle-engine/core/devtools/diagnostics';\n\nconst diagnostics = runtime.readDiagnosticsDelta();\nconst formatted = formatLatestDiagnosticTimelineEntry(diagnostics);\nif (formatted) {\n  console.info(formatted.message, formatted.context.entry);\n}\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["When the Prometheus telemetry adapter is active, slow ticks increment ",(0,s.jsx)(n.code,{children:"runtime_ticks_over_budget_total"})," and slow systems increment ",(0,s.jsx)(n.code,{children:'runtime_system_slow_total{system_id="\u2026"}'}),", aligning counters with the runtime warning thresholds."]}),"\n"]})]})}function m(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},7678:(e,n,t)=>{t.d(n,{R:()=>c,x:()=>o});var i=t(9430);const s={},r=i.createContext(s);function c(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);