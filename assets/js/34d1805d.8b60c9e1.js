"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[608],{5702:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>t,contentTitle:()=>c,default:()=>h,frontMatter:()=>d,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"global-economy-ledger-design","title":"Stabilise Global Economy with Server-Authoritative Ledger","description":"Document Control","source":"@site/../../docs/global-economy-ledger-design.md","sourceDirName":".","slug":"/global-economy-ledger-design","permalink":"/Idle-Game-Engine/global-economy-ledger-design","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/global-economy-ledger-design.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"title":"Stabilise Global Economy with Server-Authoritative Ledger","sidebar_position":4}}');var r=i(5270),l=i(7678);const d={title:"Stabilise Global Economy with Server-Authoritative Ledger",sidebar_position:4},c="Stabilise Global Economy with Server-Authoritative Ledger",t={},o=[{value:"Document Control",id:"document-control",level:2},{value:"1. Summary",id:"1-summary",level:2},{value:"2. Context &amp; Problem Statement",id:"2-context--problem-statement",level:2},{value:"3. Goals &amp; Non-Goals",id:"3-goals--non-goals",level:2},{value:"4. Stakeholders, Agents &amp; Impacted Surfaces",id:"4-stakeholders-agents--impacted-surfaces",level:2},{value:"5. Current State",id:"5-current-state",level:2},{value:"6. Proposed Solution",id:"6-proposed-solution",level:2},{value:"6.1 Architecture Overview",id:"61-architecture-overview",level:3},{value:"6.2 Detailed Design",id:"62-detailed-design",level:3},{value:"6.3 Operational Considerations",id:"63-operational-considerations",level:3},{value:"7. Work Breakdown &amp; Delivery Plan",id:"7-work-breakdown--delivery-plan",level:2},{value:"7.1 Issue Map",id:"71-issue-map",level:3},{value:"7.2 Milestones",id:"72-milestones",level:3},{value:"7.3 Coordination Notes",id:"73-coordination-notes",level:3},{value:"8. Agent Guidance &amp; Guardrails",id:"8-agent-guidance--guardrails",level:2},{value:"9. Alternatives Considered",id:"9-alternatives-considered",level:2},{value:"10. Testing &amp; Validation Plan",id:"10-testing--validation-plan",level:2},{value:"11. Risks &amp; Mitigations",id:"11-risks--mitigations",level:2},{value:"12. Rollout Plan",id:"12-rollout-plan",level:2},{value:"13. Open Questions",id:"13-open-questions",level:2},{value:"14. Follow-Up Work",id:"14-follow-up-work",level:2},{value:"15. References",id:"15-references",level:2},{value:"Appendix A \u2014 Glossary",id:"appendix-a--glossary",level:2},{value:"Appendix B \u2014 Change Log",id:"appendix-b--change-log",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"stabilise-global-economy-with-server-authoritative-ledger",children:"Stabilise Global Economy with Server-Authoritative Ledger"})}),"\n",(0,r.jsx)(n.h2,{id:"document-control",children:"Document Control"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Title"}),": Stabilise Global Economy with Server-Authoritative Ledger (initiative token: ",(0,r.jsx)(n.code,{children:"GEL-001"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Authors"}),": Idle Engine design-authoring agent (AI); Jordan Hans (hansjm10)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Reviewers"}),": Jordan Hans (hansjm10); Runtime Core Maintainers; Social Service Maintainers; Content/Design Maintainers"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Status"}),": Approved (Design Ready for Implementation)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Last Updated"}),": 2025-11-17"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Related Issues"}),": ",(0,r.jsx)(n.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/397",children:"#397"}),", ",(0,r.jsx)(n.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/399",children:"#399"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Execution Mode"}),": AI-led"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"1-summary",children:"1. Summary"}),"\n",(0,r.jsxs)(n.p,{children:["This document specifies the design for the initiative ",(0,r.jsx)(n.code,{children:"GEL-001"}),": stabilising the Idle Engine\u2019s ",(0,r.jsx)(n.strong,{children:"global economy"})," by introducing a ",(0,r.jsx)(n.strong,{children:"server-authoritative ledger"})," and economy APIs in ",(0,r.jsx)(n.code,{children:"services/social"}),", while keeping per-player simulation client-side and deterministic via ",(0,r.jsx)(n.code,{children:"@idle-engine/core"}),". The proposal formalises a split between ",(0,r.jsx)(n.strong,{children:"local, client-authoritative soft progression"})," and ",(0,r.jsx)(n.strong,{children:"server-authoritative hard economic state"})," that underpins leaderboards, guilds, and shared world features. Using this design, the social service enforces invariants on spends, trades, and contributions without running a continuous per-player simulation, relying instead on deterministic replay and bounded validation. The impact is a globally consistent economy that tolerates untrusted clients, supports cross-device play, and scales operationally without a full server-side sim for every player."]}),"\n",(0,r.jsx)(n.h2,{id:"2-context--problem-statement",children:"2. Context & Problem Statement"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Background"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["The Idle Engine core runtime (",(0,r.jsx)(n.code,{children:"packages/core/src/index.ts"}),") implements a deterministic fixed-step loop with a command queue, event bus, and diagnostics timeline suitable for browser and Node execution."]}),"\n",(0,r.jsx)(n.li,{children:"Archived presentation shells previously ran the core in a worker for UI consumption; no active shell is maintained in the workspace."}),"\n",(0,r.jsxs)(n.li,{children:["The social backend (",(0,r.jsx)(n.code,{children:"services/social/src/index.ts"}),") currently exposes stubbed ",(0,r.jsx)(n.code,{children:"leaderboard"})," and ",(0,r.jsx)(n.code,{children:"guild"})," routes but does not own any economic state; responses are placeholder-only."]}),"\n",(0,r.jsxs)(n.li,{children:["Design goals in ",(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"})," emphasise:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Web-first runtime, portable to Node and native shells."}),"\n",(0,r.jsx)(n.li,{children:"Optional social services for leaderboards and guild coordination."}),"\n",(0,r.jsxs)(n.li,{children:["Deterministic, low-overhead simulations and Node-based headless runs (",(0,r.jsx)(n.code,{children:"tools/runtime-sim/index.ts"}),") for diagnostics and analytics."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["In recent discussions, we asserted that the ",(0,r.jsx)(n.strong,{children:"global economy must be stable"}),", implying we should not fully trust clients for shared economic state."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Problem"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Today, there is no defined concept of ",(0,r.jsx)(n.strong,{children:"hard vs soft currencies"}),", no server-authoritative economic ledger, and no invariants enforced on leaderboard submissions or guild contributions."]}),"\n",(0,r.jsxs)(n.li,{children:["All social endpoints in ",(0,r.jsx)(n.code,{children:"services/social"})," are effectively ",(0,r.jsx)(n.strong,{children:"stateless stubs"})," returning fixed shapes, providing no real protection against:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Inflated or forged scores."}),"\n",(0,r.jsx)(n.li,{children:"Illegitimate contributions to shared resources (guild banks, world events)."}),"\n",(0,r.jsx)(n.li,{children:"Economic exploits that would destabilise a global market or progression path."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Running the entire simulation on the server for every player to address these issues would be ",(0,r.jsx)(n.strong,{children:"resource-exhaustive and operationally complex"}),", contradicting the design\u2019s web-first, client-centric runtime."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Forces"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Constraints"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Maintain web-first, browser-run simulation per ",(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Avoid per-player continuous server ticks; server CPU budgets should remain bounded and predictable."}),"\n",(0,r.jsxs)(n.li,{children:["Preserve deterministic behaviour of ",(0,r.jsx)(n.code,{children:"IdleEngineRuntime"})," (",(0,r.jsx)(n.code,{children:"packages/core/src/index.ts"}),") across client and server."]}),"\n",(0,r.jsx)(n.li,{children:"Uphold API stability for social endpoints as they evolve beyond stubs."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"External Requirements"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Global leaderboards and guild features must reflect ",(0,r.jsx)(n.strong,{children:"canonical, server-validated state"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Clients may be untrusted; malicious actors must not be able to destabilise the global economy."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Timelines"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Initial implementation must be small, testable, and incrementally deployable (no big-bang migration)."}),"\n",(0,r.jsxs)(n.li,{children:["The initiative ",(0,r.jsx)(n.code,{children:"GEL-001"})," should be deliverable in phases that can be executed by AI agents following this document."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"3-goals--non-goals",children:"3. Goals & Non-Goals"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Goals"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Define a clear split between ",(0,r.jsx)(n.strong,{children:"hard, server-authoritative economies"})," and ",(0,r.jsx)(n.strong,{children:"soft, client-authoritative progression"})," within initiative ",(0,r.jsx)(n.code,{children:"GEL-001"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Extend ",(0,r.jsx)(n.code,{children:"services/social"})," with a ",(0,r.jsx)(n.strong,{children:"persistent ledger and APIs"})," for balances, spends, trades, and contributions, enforcing economic invariants."]}),"\n",(0,r.jsxs)(n.li,{children:["Ensure ",(0,r.jsx)(n.strong,{children:"leaderboard and guild endpoints"})," rely on server-authoritative values, not client-reported totals."]}),"\n",(0,r.jsxs)(n.li,{children:["Provide a ",(0,r.jsx)(n.strong,{children:"validation model"})," that uses deterministic replay via ",(0,r.jsx)(n.code,{children:"IdleEngineRuntime"})," in Node only for bounded, on-demand verification (e.g., suspicious updates), not continuous per-player ticking."]}),"\n",(0,r.jsxs)(n.li,{children:["Instrument economic flows with ",(0,r.jsx)(n.strong,{children:"telemetry and diagnostics"})," (e.g., counters for rejected operations, anomaly flags)."]}),"\n",(0,r.jsxs)(n.li,{children:["Provide an ",(0,r.jsx)(n.strong,{children:"AI-ready work breakdown"})," and guardrails so autonomous agents can implement initiative ",(0,r.jsx)(n.code,{children:"GEL-001"})," safely."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Non-Goals"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Implement a full in-game marketplace, auction house, or complex derivatives systems; this design focuses on linear balances and simple trades."}),"\n",(0,r.jsx)(n.li,{children:"Ship a GUI for economy tuning; balancing remains a content/design activity defined via existing content packs."}),"\n",(0,r.jsxs)(n.li,{children:["Overhaul the entire simulation model in ",(0,r.jsx)(n.code,{children:"@idle-engine/core"}),"; we only integrate with it for verification and offline/analytic workloads."]}),"\n",(0,r.jsxs)(n.li,{children:["Replace or redesign the authentication stack (Keycloak/OIDC) already used in ",(0,r.jsx)(n.code,{children:"services/social/src/middleware/auth.ts"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Guarantee perfect anti-cheat; we target ",(0,r.jsx)(n.strong,{children:"pragmatic stability of the global economy"}),", not absolute attack elimination."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"4-stakeholders-agents--impacted-surfaces",children:"4. Stakeholders, Agents & Impacted Surfaces"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Primary Stakeholders"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Runtime Team: owners of ",(0,r.jsx)(n.code,{children:"packages/core"})," and deterministic sim semantics."]}),"\n",(0,r.jsxs)(n.li,{children:["Social Service Team: owners of ",(0,r.jsx)(n.code,{children:"services/social"})," and economic APIs."]}),"\n",(0,r.jsx)(n.li,{children:"Content/Design Team: defines which currencies are \u201chard\u201d vs \u201csoft\u201d and the intended economic constraints."}),"\n",(0,r.jsxs)(n.li,{children:["Dev Experience & Tooling: owners of ",(0,r.jsx)(n.code,{children:"tools/runtime-sim"})," and CI integration."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Agent Roles"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Runtime Implementation Agent"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Modifies ",(0,r.jsx)(n.code,{children:"packages/core"})," only where needed to support economic verification hooks and diagnostic exports for initiative ",(0,r.jsx)(n.code,{children:"GEL-001"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Maintains determinism and test coverage."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Social Service Implementation Agent"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Implements ledger schemas, routes, and persistence in ",(0,r.jsx)(n.code,{children:"services/social"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Adds validations and guards to protect the global economy."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Content/Schema Agent"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Updates ",(0,r.jsx)(n.code,{children:"content-schema"})," and ",(0,r.jsx)(n.code,{children:"content-sample"})," if economy classifications (hard/soft currencies) need schema-level representation."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Docs & Design Agent"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Maintains this design and related docs in ",(0,r.jsx)(n.code,{children:"docs/"}),", ensuring they track the implementation status of initiative ",(0,r.jsx)(n.code,{children:"GEL-001"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Testing & Validation Agent"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Extends Vitest suites in ",(0,r.jsx)(n.code,{children:"packages/core"})," and ",(0,r.jsx)(n.code,{children:"services/social"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Affected Packages/Services"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"packages/core/src/index.ts"})," (runtime interface for diagnostics/verification)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"services/social/src/index.ts"}),", ",(0,r.jsx)(n.code,{children:"services/social/src/routes/*"}),", ",(0,r.jsx)(n.code,{children:"services/social/src/types/*"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"content-schema"})," and ",(0,r.jsx)(n.code,{children:"content-sample"})," (if currency classification is exposed to content authors)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tools/runtime-sim/index.ts"})," (for reuse or extension in verification flows)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"})," and related design docs referencing economy behaviour."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Compatibility Considerations"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Existing stub social endpoints must remain ",(0,r.jsx)(n.strong,{children:"backward compatible in shape"})," where external integrations exist; new fields should be additive."]}),"\n",(0,r.jsxs)(n.li,{children:["Authentication semantics (",(0,r.jsx)(n.code,{children:"req.user"})," from ",(0,r.jsx)(n.code,{children:"createAuthMiddleware"})," in ",(0,r.jsx)(n.code,{children:"services/social/src/middleware/auth.ts"}),") must remain stable."]}),"\n",(0,r.jsxs)(n.li,{children:["The runtime\u2019s public API in ",(0,r.jsx)(n.code,{children:"packages/core/src/index.ts"})," must not silently change semantics (tick behaviour, diagnostics contracts) without versioning."]}),"\n",(0,r.jsx)(n.li,{children:"Where breaking changes to social APIs are unavoidable, they must be gated behind versioned paths or feature flags."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"5-current-state",children:"5. Current State"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Runtime (",(0,r.jsx)(n.code,{children:"@idle-engine/core"}),")"]})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Implements ",(0,r.jsx)(n.code,{children:"IdleEngineRuntime"})," in ",(0,r.jsx)(n.code,{children:"packages/core/src/index.ts"}),", which:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Runs a fixed-step tick loop (",(0,r.jsx)(n.code,{children:"tick(deltaMs)"}),"), bounded by ",(0,r.jsx)(n.code,{children:"maxStepsPerFrame"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Uses a ",(0,r.jsx)(n.code,{children:"CommandQueue"})," and ",(0,r.jsx)(n.code,{children:"CommandDispatcher"})," to process commands deterministically."]}),"\n",(0,r.jsxs)(n.li,{children:["Emits diagnostics via ",(0,r.jsx)(n.code,{children:"createRuntimeDiagnosticsController"})," and ",(0,r.jsx)(n.code,{children:"getDiagnosticTimelineSnapshot()"})," for offline analysis and CI (",(0,r.jsx)(n.code,{children:"tools/runtime-sim/index.ts"}),")."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"No explicit concept of \u201ceconomy verification\u201d exists; the runtime is agnostic to whether it is used in a client or server context."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Presentation shells (archived)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"No active presentation shell is maintained; downstream clients must integrate their own UI surfaces."}),"\n",(0,r.jsxs)(n.li,{children:["Currently assumes the client owns the moment-to-moment sim and fetches social data from ",(0,r.jsx)(n.code,{children:"services/social"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Social Service (",(0,r.jsx)(n.code,{children:"services/social"}),")"]})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Express server entrypoint at ",(0,r.jsx)(n.code,{children:"services/social/src/index.ts"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Uses Helmet, JSON body parsing, and request logging."}),"\n",(0,r.jsxs)(n.li,{children:["Applies ",(0,r.jsx)(n.code,{children:"createAuthMiddleware"})," to all routes, enforcing OIDC via Keycloak (",(0,r.jsx)(n.code,{children:"services/social/src/middleware/auth.ts"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Mounts ",(0,r.jsx)(n.code,{children:"leaderboardRouter"})," and ",(0,r.jsx)(n.code,{children:"guildRouter"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"leaderboardRouter"})," (",(0,r.jsx)(n.code,{children:"services/social/src/routes/leaderboard.ts"}),"):","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"GET /leaderboard/:leaderboardId"}),": returns a stub entry for the current user with score 0, no persistence."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"POST /leaderboard/submit"}),": validates payload using zod but only echoes back a \u201cqueued\u201d response, with no ledger update."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"guildRouter"})," (",(0,r.jsx)(n.code,{children:"services/social/src/routes/guild.ts"}),"):","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"GET /guilds/mine"}),": returns ",(0,r.jsx)(n.code,{children:"guild: null"})," stub."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"POST /guilds"}),": validates, generates a synthetic ",(0,r.jsx)(n.code,{children:"guildId"}),", and returns an accepted response; no persistence or economic rules."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["No DB or durable storage is configured; ",(0,r.jsx)(n.code,{children:"docker-compose.yml"})," starts the social service alongside Keycloak but without an attached datastore."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Content & Schema"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Content modules and schemas define resources, generators, upgrades, etc., but there is no explicit notion of ",(0,r.jsx)(n.strong,{children:"hard"})," vs ",(0,r.jsx)(n.strong,{children:"soft"})," currencies encoded at the schema level (follow-up work may be needed)."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Testing & Observability"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Vitest and diagnostics coverage for the runtime and social service exist but are not focused on economic invariants."}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tools/runtime-sim/index.ts"})," shows how the runtime is executed under Node with a diagnostics timeline."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"6-proposed-solution",children:"6. Proposed Solution"}),"\n",(0,r.jsx)(n.h3,{id:"61-architecture-overview",children:"6.1 Architecture Overview"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Narrative"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Initiative `` introduces a ",(0,r.jsx)(n.strong,{children:"server-authoritative economic ledger"})," in ",(0,r.jsx)(n.code,{children:"services/social"})," responsible for:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Tracking balances of designated ",(0,r.jsx)(n.strong,{children:"hard currencies"})," per authenticated user."]}),"\n",(0,r.jsx)(n.li,{children:"Applying and validating economic operations (earn, spend, trade, contribute)."}),"\n",(0,r.jsx)(n.li,{children:"Powering leaderboards and guild resource views using canonical server values."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["The ",(0,r.jsx)(n.strong,{children:"client"})," (web shell and future native shells):","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Runs the full simulation using ",(0,r.jsx)(n.code,{children:"IdleEngineRuntime"})," locally."]}),"\n",(0,r.jsx)(n.li,{children:"Treats hard currency balances from the social service as authoritative."}),"\n",(0,r.jsxs)(n.li,{children:["Performs ",(0,r.jsx)(n.strong,{children:"optimistic UI updates"})," but reconciles against server-ledger responses and clamps to server-provided values."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["The server ",(0,r.jsx)(n.strong,{children:"does not"})," tick the simulation for each player:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Instead, it accepts ",(0,r.jsx)(n.strong,{children:"commands/events"})," that mutate the ledger directly."]}),"\n",(0,r.jsxs)(n.li,{children:["For certain high-risk operations or suspicious patterns, it uses ",(0,r.jsx)(n.strong,{children:"deterministic replay"})," of the runtime under Node (borrowing from ",(0,r.jsx)(n.code,{children:"tools/runtime-sim"}),") to verify plausibility within bounded time windows."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Diagram"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Conceptual flow (to be formalised as a diagram in a follow-up PR):"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Client:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"IdleEngineRuntime"})," (local sim) \u2192 generates resource deltas and proposed actions (spend/trade/contribute)."]}),"\n",(0,r.jsxs)(n.li,{children:["Actions \u2192 ",(0,r.jsx)(n.code,{children:"services/social"})," API calls with minimal data (operation type, amount, relevant identifiers, client-side state hints)."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Server:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Auth middleware attaches ",(0,r.jsx)(n.code,{children:"user.id"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Economy controller validates operation:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Checks ledger balances and invariants."}),"\n",(0,r.jsx)(n.li,{children:"Optionally triggers deterministic replay verification for flagged cases."}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Ledger state updated in DB."}),"\n",(0,r.jsx)(n.li,{children:"Responses include authoritative balances and outcome metadata, which the client uses to reconcile."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"62-detailed-design",children:"6.2 Detailed Design"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Runtime Changes"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Expose or refine an API in ",(0,r.jsx)(n.code,{children:"packages/core/src/index.ts"})," to:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Generate a ",(0,r.jsx)(n.strong,{children:"compact summary"})," of a player\u2019s economic state at a given tick (e.g., resource rates, key milestones) for replay scenarios."]}),"\n",(0,r.jsxs)(n.li,{children:["Initialise ",(0,r.jsx)(n.code,{children:"IdleEngineRuntime"})," from such a summary for deterministic replay on the server."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Provide a ",(0,r.jsx)(n.strong,{children:"\u201cverification mode\u201d"})," helper (e.g., ",(0,r.jsx)(n.code,{children:"createVerificationRuntime"}),") that:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Runs a truncated number of ticks with specified content configuration."}),"\n",(0,r.jsx)(n.li,{children:"Returns computed expected economic deltas for a given timeframe."}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Ensure any changes maintain backwards compatibility and determinism across browser and Node."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Data & Schemas"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Introduce an economy schema in ",(0,r.jsx)(n.code,{children:"services/social/src/types/economy.ts"})," (new file):","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"HardCurrencyId"})," enum or string union (e.g., ",(0,r.jsx)(n.code,{children:'"GEMS"'}),", ",(0,r.jsx)(n.code,{children:'"BONDS"'}),", ",(0,r.jsx)(n.code,{children:'"GUILD_TOKENS"'}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"LedgerEntry"})," type: ",(0,r.jsx)(n.code,{children:"{ userId, currencyId, balance, updatedAt }"}),", representing the latest canonical balance for a given ",(0,r.jsx)(n.code,{children:"(userId, currencyId)"})," pair."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"EconomyOperationKind"})," union: ",(0,r.jsx)(n.code,{children:'"Earn" | "Spend" | "Transfer" | "GuildContribution"'}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"EconomyOperationInput"})," type: request payloads for each operation kind (what the client sends)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"EconomyOperationRecord"})," type: an immutable, persisted transaction history record:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"{ id, userId, currencyId, kind, amount, source, reason, occurredAt, clientTimestamp?, guildId?, counterpartyUserId?, correlationId?, metadata? }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"occurredAt"})," is the server timestamp used for rate limiting and replay windows; ",(0,r.jsx)(n.code,{children:"clientTimestamp"})," is kept for anomaly detection."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"source"}),"/",(0,r.jsx)(n.code,{children:"reason"})," capture where the operation originated (e.g., quest reward, shop purchase) for telemetry."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Persistence:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Represent balances in a table or collection like ",(0,r.jsx)(n.code,{children:"economy_ledger_entries"})," keyed by ",(0,r.jsx)(n.code,{children:"(user_id, currency_id)"}),", mapping to ",(0,r.jsx)(n.code,{children:"LedgerEntry"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Represent transaction history in an append-only ",(0,r.jsx)(n.code,{children:"economy_operations"})," store keyed by ",(0,r.jsx)(n.code,{children:"id"}),", mapping to ",(0,r.jsx)(n.code,{children:"EconomyOperationRecord"})," and indexed by ",(0,r.jsx)(n.code,{children:"user_id"}),", ",(0,r.jsx)(n.code,{children:"guild_id"}),", ",(0,r.jsx)(n.code,{children:"currency_id"}),", ",(0,r.jsx)(n.code,{children:"kind"}),", and ",(0,r.jsx)(n.code,{children:"occurred_at"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Initial implementation may start with an ",(0,r.jsx)(n.strong,{children:"in-memory store"})," that still keeps a full per-user operation log alongside ledger entries, with a clear interface that can be backed by a database in a later milestone."]}),"\n",(0,r.jsxs)(n.li,{children:["The ledger abstraction must compute balances from the ordered ",(0,r.jsx)(n.code,{children:"EconomyOperationRecord"})," stream and expose helpers for:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Querying operations for a user/currency/kind over a time window (e.g., \u201clast 24h spends\u201d) to enforce configurable max spend rates."}),"\n",(0,r.jsx)(n.li,{children:"Reconstructing a sequence of operations for deterministic replay and audit (e.g., recomputing expected balances for suspicious submissions)."}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"The abstraction boundary should allow swapping implementation without changing route handlers."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Optional schema updates in ",(0,r.jsx)(n.code,{children:"content-schema"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Flag each resource as ",(0,r.jsx)(n.code,{children:"hard"})," or ",(0,r.jsx)(n.code,{children:"soft"}),", so the runtime and social service can agree on which resources must be mediated by the ledger."]}),"\n",(0,r.jsx)(n.li,{children:"TODO: Content/Schema Agent to propose specific fields and validations."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"APIs & Contracts"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["New endpoints (versioned under ",(0,r.jsx)(n.code,{children:"/economy"})," in ",(0,r.jsx)(n.code,{children:"services/social"}),"):","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"GET /economy/balances"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Returns current balances for all hard currencies for ",(0,r.jsx)(n.code,{children:"req.user.id"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"POST /economy/earn"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Payload: ",(0,r.jsx)(n.code,{children:"{ currencyId, amount, source, clientTimestamp, simMetadata? }"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Use primarily for server-driven rewards (events, achievements); client-submitted earns are treated conservatively and often unnecessary if hard currency creation is server-triggered."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"POST /economy/spend"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Payload: ",(0,r.jsx)(n.code,{children:"{ currencyId, amount, reason, clientTimestamp, simMetadata? }"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Validation: server checks user\u2019s balance and configurable max spend rate, applies spend atomically, returns new balance."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"POST /economy/transfer"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Payload: ",(0,r.jsx)(n.code,{children:"{ currencyId, amount, toUserId, reason, clientTimestamp, simMetadata? }"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Validation: checks sender\u2019s balance, optional min/max limits, and anti-abuse policies before updating both ledgers."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"POST /economy/guild-contribute"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Payload: ",(0,r.jsx)(n.code,{children:"{ currencyId, amount, guildId, clientTimestamp, simMetadata? }"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Updates guild bank ledger, powers guild views and shared contributions."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Leaderboards and guild routes update:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"GET /leaderboard/:leaderboardId"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Data source: aggregated ledger values and precomputed ranks, not client-submitted scores."}),"\n",(0,r.jsx)(n.li,{children:"In the initial phase, scores may still be stubbed but the shape should anticipate server-authoritative scores."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"POST /leaderboard/submit"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Transitions from \u201cqueued\u201d stub to:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Validating submissions against known ledger state (e.g., verifying that global scores correlate with ledgered hard currency or key stats)."}),"\n",(0,r.jsx)(n.li,{children:"Optionally scheduling asynchronous verification jobs."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Request metadata:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"simMetadata"})," field (optional) may contain:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"lastKnownServerBalance"}),", ",(0,r.jsx)(n.code,{children:"clientClaimedBalance"}),", ",(0,r.jsx)(n.code,{children:"sessionsSinceLastSync"}),", ",(0,r.jsx)(n.code,{children:"offlineDurationMs"}),", ",(0,r.jsx)(n.code,{children:"runtimeVersion"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"This metadata is used by the server to detect anomalies, not to accept client balances as truth."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Tooling & Automation"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Extend ",(0,r.jsx)(n.code,{children:"tools/runtime-sim"})," or add a sibling CLI:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Command: ",(0,r.jsx)(n.code,{children:"pnpm core:economy-verify --ticks <n> --snapshot <file>"})," (exact API TBD)."]}),"\n",(0,r.jsx)(n.li,{children:"Given a snapshot describing a player\u2019s state and offline duration, computes the maximum plausible hard currency gain under current content."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["CI integration:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Add targeted tests under ",(0,r.jsx)(n.code,{children:"services/social"})," to ensure invariants:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Cannot overspend."}),"\n",(0,r.jsx)(n.li,{children:"Cannot transfer more than balance."}),"\n",(0,r.jsx)(n.li,{children:"Rate limits for earns/spends per time window."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Developer tooling:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Scripts to seed test users and ledgers for manual QA and Playwright tests (e.g., ",(0,r.jsx)(n.code,{children:"tools/scripts/seed-economy-users.ts"}),", TODO)."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"63-operational-considerations",children:"6.3 Operational Considerations"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Deployment"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Continue using ",(0,r.jsx)(n.code,{children:"docker-compose.yml"})," for local Keycloak + social service; extend configuration to include persistent storage for the ledger when adopted."]}),"\n",(0,r.jsx)(n.li,{children:"For initial milestones, in-memory ledger is acceptable for development; production deployments MUST configure a persistent store before enabling real economic features (TODO: choose DB technology)."}),"\n",(0,r.jsxs)(n.li,{children:["CI must run ",(0,r.jsx)(n.code,{children:"pnpm test --filter @idle-engine/social-service"})," to validate economic routes and invariants."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Telemetry & Observability"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Metrics:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Count of operations by type: ",(0,r.jsx)(n.code,{children:"economy.operations_total{type=Earn|Spend|Transfer|GuildContribution}"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Count of rejected operations: ",(0,r.jsx)(n.code,{children:"economy.rejections_total{reason=InsufficientFunds|RateLimit|InvalidPayload|ReplayMismatch}"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Anomaly flags: ",(0,r.jsx)(n.code,{children:"economy.anomalies_total{type=ReplayMismatch|SuspiciousOfflineGain}"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Logging:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Structured logs for each economic operation with user ID, operation type, amounts, and decision outcome."}),"\n",(0,r.jsx)(n.li,{children:"Avoid logging PII beyond stable identifiers (user ID, guild ID)."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Diagnostics:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"For replay-based verification, log operation IDs and diagnostic summaries without dumping full state."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Security & Compliance"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["All economy endpoints must require authentication via Keycloak (",(0,r.jsx)(n.code,{children:"createAuthMiddleware"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Input must be validated with zod schemas (following existing pattern in ",(0,r.jsx)(n.code,{children:"leaderboard.ts"})," and ",(0,r.jsx)(n.code,{children:"guild.ts"}),")."]}),"\n",(0,r.jsx)(n.li,{children:"Avoid storing sensitive personal data beyond what is already implied by OIDC (user IDs, usernames)."}),"\n",(0,r.jsx)(n.li,{children:"Implement basic rate limiting for economic endpoints (middleware or reverse proxy rules; TODO for infra owner)."}),"\n",(0,r.jsxs)(n.li,{children:["Audit logging should make it possible to trace economic changes per user and per guild by referencing ",(0,r.jsx)(n.code,{children:"EconomyOperationRecord.id"})," and correlating log entries with stored operations."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"7-work-breakdown--delivery-plan",children:"7. Work Breakdown & Delivery Plan"}),"\n",(0,r.jsx)(n.h3,{id:"71-issue-map",children:"7.1 Issue Map"}),"\n",(0,r.jsxs)(n.p,{children:["Populate GitHub issues based on the following table; all issues reference initiative ",(0,r.jsx)(n.code,{children:"GEL-001"})," in their descriptions."]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Issue Title"}),(0,r.jsx)(n.th,{children:"Scope Summary"}),(0,r.jsx)(n.th,{children:"Proposed Assignee/Agent"}),(0,r.jsx)(n.th,{children:"Dependencies"}),(0,r.jsx)(n.th,{children:"Acceptance Criteria"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:["feat(design): formalise global economy stability (",(0,r.jsx)(n.code,{children:"GEL-001"}),")"]}),(0,r.jsxs)(n.td,{children:["Capture final design doc in ",(0,r.jsx)(n.code,{children:"docs/"})," and link to related specs"]}),(0,r.jsx)(n.td,{children:"Docs & Design Agent"}),(0,r.jsx)(n.td,{children:"None"}),(0,r.jsxs)(n.td,{children:["Design merged; referenced from ",(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"}),"; reviewers sign off"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"feat(schema): classify hard vs soft currencies"}),(0,r.jsx)(n.td,{children:"Extend content schema to mark hard currencies and sample content to use them"}),(0,r.jsx)(n.td,{children:"Content/Schema Agent"}),(0,r.jsx)(n.td,{children:"Design approval"}),(0,r.jsxs)(n.td,{children:["Schema/docs updated; tests in ",(0,r.jsx)(n.code,{children:"content-schema"})," pass; sample packs compile"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"feat(social): introduce server-authoritative ledger abstraction"}),(0,r.jsxs)(n.td,{children:["Add in-memory ledger types and interfaces in ",(0,r.jsx)(n.code,{children:"services/social/src/types"})]}),(0,r.jsx)(n.td,{children:"Social Service Implementation Agent"}),(0,r.jsx)(n.td,{children:"Schema classification (optional)"}),(0,r.jsx)(n.td,{children:"Ledger API supports create/read/update operations; unit tests cover basic operations"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"feat(social): implement economy routes (/economy)"}),(0,r.jsx)(n.td,{children:"Add balances, spend, transfer, and guild contribution endpoints"}),(0,r.jsx)(n.td,{children:"Social Service Implementation Agent"}),(0,r.jsx)(n.td,{children:"Ledger abstraction"}),(0,r.jsx)(n.td,{children:"Routes validated with zod, protected by auth; tests verify invariants (no overspend, etc.)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"feat(social): wire leaderboards and guilds to ledger"}),(0,r.jsx)(n.td,{children:"Drive leaderboard scores and guild resources from ledger data"}),(0,r.jsx)(n.td,{children:"Social Service Implementation Agent"}),(0,r.jsx)(n.td,{children:"Economy routes"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"GET /leaderboard/:id"})," and ",(0,r.jsx)(n.code,{children:"GET /guilds/mine"})," use ledger-derived values; tests updated"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"feat(core): add verification runtime helpers"}),(0,r.jsx)(n.td,{children:"Expose runtime helpers to support deterministic economy replay"}),(0,r.jsx)(n.td,{children:"Runtime Implementation Agent"}),(0,r.jsx)(n.td,{children:"Design approval"}),(0,r.jsx)(n.td,{children:"New APIs documented; tests confirm deterministic behaviour in Node and browser"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"feat(tools): add economy verification CLI"}),(0,r.jsx)(n.td,{children:"CLI wrapper around runtime helper for economic replay/validation"}),(0,r.jsx)(n.td,{children:"Runtime Implementation Agent"}),(0,r.jsx)(n.td,{children:"Verification helpers"}),(0,r.jsx)(n.td,{children:"CLI runs on snapshots; emits JSON; used in at least one test"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"chore(test): add economic invariants to social tests"}),(0,r.jsxs)(n.td,{children:["Expand Vitest suites under ",(0,r.jsx)(n.code,{children:"services/social"})]}),(0,r.jsx)(n.td,{children:"Testing & Validation Agent"}),(0,r.jsx)(n.td,{children:"Economy routes implemented"}),(0,r.jsx)(n.td,{children:"Tests fail on invariant violations; coverage includes all economic operations"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"chore(ui): add economy UI tests in downstream shells (archived)"}),(0,r.jsx)(n.td,{children:"Ensure economic UI interactions do not regress accessibility"}),(0,r.jsx)(n.td,{children:"Testing & Validation Agent"}),(0,r.jsx)(n.td,{children:"Basic economy UI implemented in shell"}),(0,r.jsx)(n.td,{children:"Shell-specific test commands documented in downstream repos"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"chore(docs): update idle-engine-design.md with economy model"}),(0,r.jsx)(n.td,{children:"Summarise hard/soft currency model & ledger in main design doc"}),(0,r.jsx)(n.td,{children:"Docs & Design Agent"}),(0,r.jsx)(n.td,{children:"Implementation stable"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"})," references this document; glossary updated"]})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"72-milestones",children:"7.2 Milestones"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Phase 1: Foundations"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Finalise this design (initiative ",(0,r.jsx)(n.code,{children:"GEL-001"}),"), including updated ",(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Implement ledger abstraction and in-memory store in ",(0,r.jsx)(n.code,{children:"services/social"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Add ",(0,r.jsx)(n.code,{children:"/economy/balances"})," and ",(0,r.jsx)(n.code,{children:"/economy/spend"})," endpoints with strong validation."]}),"\n",(0,r.jsx)(n.li,{children:"Establish economic tests and metrics."}),"\n",(0,r.jsxs)(n.li,{children:["Gating criteria:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"All new tests pass locally and in CI."}),"\n",(0,r.jsx)(n.li,{children:"No breaking changes to existing social routes; stubs still functional."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Phase 2: Integration"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Wire leaderboards and guilds to the ledger."}),"\n",(0,r.jsx)(n.li,{children:"Integrate downstream shells with economy endpoints (client reconciliation logic)."}),"\n",(0,r.jsx)(n.li,{children:"Introduce optional replay-based verification for high-risk flows."}),"\n",(0,r.jsxs)(n.li,{children:["Gating criteria:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Leaderboard and guild endpoints operate against ledger state."}),"\n",(0,r.jsx)(n.li,{children:"End-to-end flows (client \u2192 social \u2192 ledger) pass manual and automated QA."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Phase 3: Hardening & Scale"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Move ledger to a persistent store and configure in deployment pipelines."}),"\n",(0,r.jsx)(n.li,{children:"Add rate limiting, anomaly detection, and operational runbooks."}),"\n",(0,r.jsx)(n.li,{children:"Tune economic parameters based on early telemetry and tests."}),"\n",(0,r.jsxs)(n.li,{children:["Gating criteria:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"No known class of exploit allows unlimited hard currency creation or transfer."}),"\n",(0,r.jsx)(n.li,{children:"Operational dashboards show stable economic metrics over time."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"73-coordination-notes",children:"7.3 Coordination Notes"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Hand-off Package"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["This design document (",(0,r.jsx)(n.code,{children:"docs/global-economy-ledger-design.md"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["References to runtime code (",(0,r.jsx)(n.code,{children:"packages/core/src/index.ts"}),"), social service (",(0,r.jsx)(n.code,{children:"services/social/src"}),"), and tools (",(0,r.jsx)(n.code,{children:"tools/runtime-sim/index.ts"}),")."]}),"\n",(0,r.jsx)(n.li,{children:"Example payloads and JSON contracts for economy endpoints."}),"\n",(0,r.jsxs)(n.li,{children:["Test commands: ",(0,r.jsx)(n.code,{children:"pnpm test --filter @idle-engine/social-service"}),", ",(0,r.jsx)(n.code,{children:"pnpm test --filter @idle-engine/core"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Communication Cadence"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Weekly status update on initiative ",(0,r.jsx)(n.code,{children:"GEL-001"})," summarising merged PRs and risk items."]}),"\n",(0,r.jsx)(n.li,{children:"Design reviews at the end of Phase 1 and Phase 2."}),"\n",(0,r.jsx)(n.li,{children:"Escalation path: runtime lead \u2192 social lead \u2192 project owner."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"8-agent-guidance--guardrails",children:"8. Agent Guidance & Guardrails"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Context Packets"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Before work on initiative ",(0,r.jsx)(n.code,{children:"GEL-001"}),", agents must load:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"})}),"\n",(0,r.jsx)(n.li,{children:"This design document."}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"packages/core/src/index.ts"})," and tests under ",(0,r.jsx)(n.code,{children:"packages/core/src/__tests__"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"services/social/src/index.ts"}),", routes, middleware, and types."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tools/runtime-sim/index.ts"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Environment:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Use ",(0,r.jsx)(n.code,{children:"nvm use"})," to adopt ",(0,r.jsx)(n.code,{children:".nvmrc"})," Node version."]}),"\n",(0,r.jsxs)(n.li,{children:["Use ",(0,r.jsx)(n.code,{children:"pnpm"})," as per ",(0,r.jsx)(n.code,{children:"package.json"})," and root ",(0,r.jsx)(n.code,{children:"README.md"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Prompting & Constraints"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Agents must:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Follow the repository guidelines in ",(0,r.jsx)(n.code,{children:"AGENTS.md"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Use TypeScript with existing lint rules; prefer pure functions for ledger logic."}),"\n",(0,r.jsxs)(n.li,{children:["Respect ",(0,r.jsx)(n.code,{children:"@typescript-eslint/consistent-type-imports"}),"/exports."]}),"\n",(0,r.jsxs)(n.li,{children:["Structure commits as Conventional Commits (e.g., ",(0,r.jsx)(n.code,{children:"feat(social): add economy routes"}),")."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Canonical scripting:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Run ",(0,r.jsx)(n.code,{children:"pnpm lint"})," and appropriate ",(0,r.jsx)(n.code,{children:"pnpm test --filter ..."})," before considering work complete."]}),"\n",(0,r.jsxs)(n.li,{children:["Do not edit generated ",(0,r.jsx)(n.code,{children:"dist/"})," artifacts by hand."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Safety Rails"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Forbidden:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Resetting git history or force-pushing without explicit human approval."}),"\n",(0,r.jsx)(n.li,{children:"Bypassing authentication checks on social routes."}),"\n",(0,r.jsx)(n.li,{children:"Logging access tokens or other secrets; log only stable IDs and high-level metadata."}),"\n",(0,r.jsxs)(n.li,{children:["Manually editing ",(0,r.jsx)(n.code,{children:"docs/coverage/index.md"}),"; regenerate via ",(0,r.jsx)(n.code,{children:"pnpm coverage:md"})," only when required."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Rollback procedures:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"If a change destabilises tests or lint, agents must revert the specific commit or open a follow-up fix before proceeding."}),"\n",(0,r.jsx)(n.li,{children:"For economic changes, include feature flags or configuration toggles to disable new behaviour if needed."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Validation Hooks"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Required commands before closing issues:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"pnpm lint"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"pnpm test --filter @idle-engine/social-service"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"pnpm test --filter @idle-engine/core"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["For CLI additions:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Ensure CLIs print final results as single-line JSON when intended for machine consumption (follow ",(0,r.jsx)(n.code,{children:"tools/runtime-sim/index.ts"})," pattern)."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"9-alternatives-considered",children:"9. Alternatives Considered"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Fully Client-Authoritative Economy"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Description: All economic values are computed and stored on the client; server only echoes or passively records data."}),"\n",(0,r.jsxs)(n.li,{children:["Pros:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"No server CPU or storage requirements for economy."}),"\n",(0,r.jsx)(n.li,{children:"Simplest implementation."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Cons:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Trivially exploitable; players can freely forge balances and destabilise any global system."}),"\n",(0,r.jsxs)(n.li,{children:["Incompatible with \u201cglobal economy must be stable\u201d requirement of initiative ",(0,r.jsx)(n.code,{children:"GEL-001"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Decision: Rejected."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Fully Server-Authoritative Per-Player Simulation"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Description: Move the entire ",(0,r.jsx)(n.code,{children:"IdleEngineRuntime"})," for each player to a server process, with clients acting as thin terminals."]}),"\n",(0,r.jsxs)(n.li,{children:["Pros:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Strong anti-cheat; the server is the single source of truth for all state."}),"\n",(0,r.jsx)(n.li,{children:"Simplifies economic verification (no need for replay; server is always right)."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Cons:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Very high resource usage and operational complexity."}),"\n",(0,r.jsx)(n.li,{children:"Latency-sensitive; idle gameplay responsiveness may suffer."}),"\n",(0,r.jsxs)(n.li,{children:["Contradicts web-first, offline-capable design goals in ",(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Decision: Rejected as the primary model; may be used selectively for high-value segments in future."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Aggregated Analytics-Only Checks"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Description: Keep economy client-authoritative but use periodic analytics jobs to detect anomalies after the fact."}),"\n",(0,r.jsxs)(n.li,{children:["Pros:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Lower implementation complexity than a full ledger."}),"\n",(0,r.jsx)(n.li,{children:"No need to change social APIs significantly."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Cons:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Detection is reactive; exploits may damage the economy before detection."}),"\n",(0,r.jsx)(n.li,{children:"No guaranteed global consistency at any point in time."}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Decision: Rejected as primary strategy; some anomaly detection may still be layered on top of the server-authoritative ledger."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"10-testing--validation-plan",children:"10. Testing & Validation Plan"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Unit / Integration"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"services/social"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Unit tests for ledger operations: earns, spends, transfers, guild contributions, and edge cases (insufficient funds, rate limits)."}),"\n",(0,r.jsxs)(n.li,{children:["Route tests for ",(0,r.jsx)(n.code,{children:"/economy/*"}),", ",(0,r.jsx)(n.code,{children:"/leaderboard/*"}),", and ",(0,r.jsx)(n.code,{children:"/guilds/*"})," verifying invariants and error responses."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"packages/core"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Tests for any new verification runtime helpers to ensure deterministic replay across Node and browser environments."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Integration tests:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Simulate a full flow where a user earns and spends hard currency via social APIs and confirm ledger consistency."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Performance"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Benchmarks:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Measure throughput of typical economy operations under load (earn/spend) in ",(0,r.jsx)(n.code,{children:"services/social"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Ensure replay-based verification runs within a bounded time (e.g., < 200ms per operation for typical cases)."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Targets:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Economy endpoints should handle at least a baseline of X operations/sec (TODO: define SLO) without degrading latency beyond Y ms at p95."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Tooling"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Downstream shells should extend their UI accessibility coverage to include hard currency displays and rejected spend states."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"11-risks--mitigations",children:"11. Risks & Mitigations"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Risk: Misclassification of Currencies"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Hard currency incorrectly modelled as soft (or vice versa) can undermine the ledger."}),"\n",(0,r.jsxs)(n.li,{children:["Mitigation:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Require content/design sign-off on currency classification."}),"\n",(0,r.jsx)(n.li,{children:"Add schema validations and tests to enforce classification for new resources."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Risk: Ledger Implementation Bugs"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Incorrect balance updates could corrupt the global economy."}),"\n",(0,r.jsxs)(n.li,{children:["Mitigation:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Rigorous unit and integration tests."}),"\n",(0,r.jsx)(n.li,{children:"Use transaction-like semantics when transitioning to a real DB."}),"\n",(0,r.jsx)(n.li,{children:"Implement invariants and sanity checks as assertions (with safe handling in production)."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Risk: Replay Verification Cost"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Deterministic replay may be more expensive than anticipated."}),"\n",(0,r.jsxs)(n.li,{children:["Mitigation:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Limit replay to suspicious cases, not all operations."}),"\n",(0,r.jsx)(n.li,{children:"Constrain replay windows (e.g., maximum offline duration)."}),"\n",(0,r.jsx)(n.li,{children:"Profile and optimise runtime hotspots if needed."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Risk: Operational Overhead"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Additional metrics, logs, and DB operations may increase operational complexity."}),"\n",(0,r.jsxs)(n.li,{children:["Mitigation:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Start with minimal metrics and controlled logging levels."}),"\n",(0,r.jsx)(n.li,{children:"Provide clear runbooks and dashboards for operators."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Risk: Backwards Compatibility of APIs"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Changing social APIs could break existing clients or test harnesses."}),"\n",(0,r.jsxs)(n.li,{children:["Mitigation:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Maintain additive changes where possible."}),"\n",(0,r.jsx)(n.li,{children:"Version new endpoints if necessary."}),"\n",(0,r.jsx)(n.li,{children:"Update tests and docs concurrently."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"12-rollout-plan",children:"12. Rollout Plan"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Milestones"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Phase 1:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Design approval, ledger abstraction, foundational economy routes, baseline tests."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Phase 2:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Leaderboard and guild wiring, client integration, replay-based verification for selected flows."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Phase 3:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Persistent storage integration, hardening, operationalisation (metrics, runbooks)."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Migration Strategy"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Start with stub-compatible changes:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Keep existing routes functioning with their current shapes while introducing new ",(0,r.jsx)(n.code,{children:"/economy"})," endpoints."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Introduce ledger-backed scoreboard/guild features behind feature flags or config toggles."}),"\n",(0,r.jsx)(n.li,{children:"Once stable, gradually deprecate stub responses and rely solely on ledger-based data."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Communication"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Document user-visible behaviour changes in release notes and game patch notes."}),"\n",(0,r.jsx)(n.li,{children:"Notify internal stakeholders (runtime, social, content) before enabling ledger-backed features."}),"\n",(0,r.jsx)(n.li,{children:"Maintain an internal FAQ and runbooks for incident response involving economic anomalies."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"13-open-questions",children:"13. Open Questions"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["What are the exact ",(0,r.jsx)(n.strong,{children:"hard currency identifiers"})," to be supported in the first iteration, and how do they map to existing content resources?","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Owner: Content/Design Team."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["What are the ",(0,r.jsx)(n.strong,{children:"target SLOs"})," for economy endpoints (throughput, latency)?","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Owner: Social Service Team / Ops."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Which operations warrant ",(0,r.jsx)(n.strong,{children:"replay-based verification"})," vs simple heuristic checks?","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Owner: Runtime + Social leads."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["What ",(0,r.jsx)(n.strong,{children:"database technology"})," will back the ledger in production (PostgreSQL, Redis, etc.)?","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Owner: Infra/Ops."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Are there regulatory or platform-specific ",(0,r.jsx)(n.strong,{children:"compliance requirements"})," (e.g., regional data residency) that affect storage of economic data?","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Owner: Product/Legal."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"14-follow-up-work",children:"14. Follow-Up Work"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Design and implement a ",(0,r.jsx)(n.strong,{children:"marketplace/auction house"})," model on top of the ledger for player-to-player trading (out of scope for initiative ",(0,r.jsx)(n.code,{children:"GEL-001"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Evaluate and, if necessary, implement ",(0,r.jsx)(n.strong,{children:"currency sinks"})," to prevent runaway inflation (e.g., sink-only upgrades, fees)."]}),"\n",(0,r.jsxs)(n.li,{children:["Add ",(0,r.jsx)(n.strong,{children:"economy visualisation tools"})," (dashboards or exports) for designers to inspect global state and tune parameters."]}),"\n",(0,r.jsxs)(n.li,{children:["Explore a lightweight ",(0,r.jsx)(n.strong,{children:"fraud detection/ML layer"})," using telemetry from economic operations."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"15-references",children:"15. References"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"}),": Core runtime and social services overview."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"packages/core/src/index.ts"}),": ",(0,r.jsx)(n.code,{children:"IdleEngineRuntime"})," implementation and diagnostics API."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"services/social/src/index.ts"}),": Social service entrypoint and route wiring."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"services/social/src/routes/leaderboard.ts"}),": Current leaderboard endpoints."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"services/social/src/routes/guild.ts"}),": Current guild endpoints."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"services/social/src/middleware/auth.ts"}),": Auth middleware using Keycloak and JOSE."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tools/runtime-sim/index.ts"}),": Headless runtime simulator CLI."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"appendix-a--glossary",children:"Appendix A \u2014 Glossary"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Hard Currency"}),": A resource whose balance is maintained and enforced by the server (social service), e.g., premium currency, guild tokens."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Soft Currency"}),": Client-local resources that affect personal progression but do not directly impact shared global systems."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Ledger"}),": A durable record of economic balances and operations per user and/or guild, maintained by the server."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Deterministic Replay"}),": Re-running the core simulation with a known seed and content configuration to reconstruct expected economic outcomes."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsxs)(n.strong,{children:["Initiative ",(0,r.jsx)(n.code,{children:"GEL-001"})]}),": Token denoting this design\u2019s focus on global economy stability via a server-authoritative ledger."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"appendix-b--change-log",children:"Appendix B \u2014 Change Log"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Date"}),(0,r.jsx)(n.th,{children:"Author"}),(0,r.jsx)(n.th,{children:"Change Summary"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"2025-11-16"}),(0,r.jsx)(n.td,{children:"Idle Engine design-authoring AI"}),(0,r.jsxs)(n.td,{children:["Initial draft of global economy stability design for ",(0,r.jsx)(n.code,{children:"GEL-001"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"2025-11-17"}),(0,r.jsx)(n.td,{children:"Idle Engine design-authoring AI"}),(0,r.jsxs)(n.td,{children:["Mark design as Approved and link initiative ",(0,r.jsx)(n.code,{children:"GEL-001"})," from ",(0,r.jsx)(n.code,{children:"docs/idle-engine-design.md"})," (#399)"]})]})]})]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},7678:(e,n,i)=>{i.d(n,{R:()=>d,x:()=>c});var s=i(9430);const r={},l=s.createContext(r);function d(e){const n=s.useContext(l);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),s.createElement(l.Provider,{value:n},e.children)}}}]);