"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[781],{219:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>d,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"runtime-command-transport-design-issue-545","title":"Runtime Command Transport Design (Issue 545)","description":"Document Control","source":"@site/../../docs/runtime-command-transport-design-issue-545.md","sourceDirName":".","slug":"/runtime-command-transport-design-issue-545","permalink":"/Idle-Game-Engine/runtime-command-transport-design-issue-545","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/runtime-command-transport-design-issue-545.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"title":"Runtime Command Transport Design (Issue 545)","sidebar_position":4}}');var i=s(5270),t=s(7678);const d={title:"Runtime Command Transport Design (Issue 545)",sidebar_position:4},o="Runtime Command Transport Design (Issue 545)",c={},a=[{value:"Document Control",id:"document-control",level:2},{value:"1. Summary",id:"1-summary",level:2},{value:"2. Context &amp; Problem Statement",id:"2-context--problem-statement",level:2},{value:"3. Goals &amp; Non-Goals",id:"3-goals--non-goals",level:2},{value:"4. Stakeholders, Agents &amp; Impacted Surfaces",id:"4-stakeholders-agents--impacted-surfaces",level:2},{value:"5. Current State",id:"5-current-state",level:2},{value:"6. Proposed Solution",id:"6-proposed-solution",level:2},{value:"6.1 Architecture Overview",id:"61-architecture-overview",level:3},{value:"6.2 Detailed Design",id:"62-detailed-design",level:3},{value:"6.3 Operational Considerations",id:"63-operational-considerations",level:3},{value:"7. Work Breakdown &amp; Delivery Plan",id:"7-work-breakdown--delivery-plan",level:2},{value:"7.1 Issue Map",id:"71-issue-map",level:3},{value:"7.2 Milestones",id:"72-milestones",level:3},{value:"7.3 Coordination Notes",id:"73-coordination-notes",level:3},{value:"8. Agent Guidance &amp; Guardrails",id:"8-agent-guidance--guardrails",level:2},{value:"9. Alternatives Considered",id:"9-alternatives-considered",level:2},{value:"10. Testing &amp; Validation Plan",id:"10-testing--validation-plan",level:2},{value:"11. Risks &amp; Mitigations",id:"11-risks--mitigations",level:2},{value:"12. Rollout Plan",id:"12-rollout-plan",level:2},{value:"13. Open Questions",id:"13-open-questions",level:2},{value:"14. Follow-Up Work",id:"14-follow-up-work",level:2},{value:"15. References",id:"15-references",level:2},{value:"Appendix A - Glossary",id:"appendix-a---glossary",level:2},{value:"Appendix B - Change Log",id:"appendix-b---change-log",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"runtime-command-transport-design-issue-545",children:"Runtime Command Transport Design (Issue 545)"})}),"\n",(0,i.jsx)(n.h2,{id:"document-control",children:"Document Control"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Title"}),": Introduce command transport envelope, responses, and idempotency for Issue 545"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Authors"}),": TODO (Owner: Runtime Core Maintainer)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Reviewers"}),": TODO (Owner: Runtime Core Maintainers)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Status"}),": Draft"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Last Updated"}),": 2025-12-27"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Related Issues"}),": ",(0,i.jsx)(n.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/545",children:"https://github.com/hansjm10/Idle-Game-Engine/issues/545"}),", ",(0,i.jsx)(n.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/666",children:"https://github.com/hansjm10/Idle-Game-Engine/issues/666"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Execution Mode"}),": AI-led"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"1-summary",children:"1. Summary"}),"\n",(0,i.jsx)(n.p,{children:"Issue 545 defines a command transport layer that wraps runtime commands in a network-ready envelope, produces authoritative acknowledgments or rejections, and enforces idempotency with client-side pending tracking so networked command execution can be built without altering Idle Engine determinism."}),"\n",(0,i.jsx)(n.h2,{id:"2-context--problem-statement",children:"2. Context & Problem Statement"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Background"}),": Issue 545 builds on the existing command model with optional request identifiers (",(0,i.jsx)(n.code,{children:"packages/core/src/command.ts:18"}),"), deterministic queueing and serialization (",(0,i.jsx)(n.code,{children:"packages/core/src/command-queue.ts:33"}),", ",(0,i.jsx)(n.code,{children:"packages/core/src/command-queue.ts:207"}),"), and dispatcher error reporting (",(0,i.jsx)(n.code,{children:"packages/core/src/command-dispatcher.ts:7"}),"), while state sync documentation explicitly defers transport (",(0,i.jsx)(n.code,{children:"docs/state-synchronization-protocol-design.md"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Problem"}),": Issue 545 highlights missing transport primitives: no command envelope with ",(0,i.jsx)(n.code,{children:"clientId"}),"/",(0,i.jsx)(n.code,{children:"requestId"}),", no acknowledgment or rejection response protocol, no idempotency registry, and no client-side pending tracker."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Forces"}),": Issue 545 must preserve deterministic tick execution, remain transport-agnostic inside ",(0,i.jsx)(n.code,{children:"packages/core"}),", avoid breaking existing command serialization, and keep tests stable for ",(0,i.jsx)(n.code,{children:"pnpm test --filter @idle-engine/core"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"3-goals--non-goals",children:"3. Goals & Non-Goals"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Goals"}),": Issue 545 will define ",(0,i.jsx)(n.code,{children:"CommandEnvelope"})," and ",(0,i.jsx)(n.code,{children:"CommandResponse"})," types, add an idempotency registry with configurable retention, add a pending command tracker for acknowledgments and timeouts, and deliver acceptance tests for accepted, rejected, and duplicate flows."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Non-Goals"}),": Issue 545 does not implement WebSocket/HTTP transports, authentication, compression, client prediction, or changes to the deterministic queue semantics."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"4-stakeholders-agents--impacted-surfaces",children:"4. Stakeholders, Agents & Impacted Surfaces"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Primary Stakeholders"}),": Issue 545 is owned by Runtime Core maintainers, with Shell maintainers and QA as secondary stakeholders."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Agent Roles"}),":"]}),"\n"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Agent"}),(0,i.jsx)(n.th,{children:"Responsibilities"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Transport Protocol Agent"}),(0,i.jsx)(n.td,{children:"Define Issue 545 transport types, registries, and exports."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Runtime Implementation Agent"}),(0,i.jsxs)(n.td,{children:["Integrate Issue 545 outcomes and server adapter hooks in ",(0,i.jsx)(n.code,{children:"packages/core"}),"."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Testing Agent"}),(0,i.jsx)(n.td,{children:"Add Issue 545 unit and integration coverage."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Docs Agent"}),(0,i.jsx)(n.td,{children:"Maintain Issue 545 documentation and references."})]})]})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Affected Packages/Services"}),": Issue 545 impacts ",(0,i.jsx)(n.code,{children:"packages/core"})," and related runtime-facing docs under ",(0,i.jsx)(n.code,{children:"docs/"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Compatibility Considerations"}),": Issue 545 APIs are additive, ",(0,i.jsx)(n.code,{children:"Command.requestId"})," remains optional for local commands (",(0,i.jsx)(n.code,{children:"packages/core/src/command.ts:18"}),"), and serialized command queue formats remain unchanged (",(0,i.jsx)(n.code,{children:"packages/core/src/command-queue.ts:207"}),")."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"5-current-state",children:"5. Current State"}),"\n",(0,i.jsxs)(n.p,{children:["Issue 545 starts from a runtime that queues and serializes commands without transport metadata (",(0,i.jsx)(n.code,{children:"packages/core/src/command-queue.ts:207"}),"), uses ",(0,i.jsx)(n.code,{children:"CommandError"})," for failures (",(0,i.jsx)(n.code,{children:"packages/core/src/command-dispatcher.ts:7"}),"), and exposes only failure draining (",(0,i.jsx)(n.code,{children:"packages/core/src/index.ts:237"}),"). There is no idempotency registry, no pending command tracker, and no integration tests for request/response flows beyond queue unit tests (",(0,i.jsx)(n.code,{children:"packages/core/src/command-queue.test.ts:39"}),")."]}),"\n",(0,i.jsx)(n.h2,{id:"6-proposed-solution",children:"6. Proposed Solution"}),"\n",(0,i.jsx)(n.h3,{id:"61-architecture-overview",children:"6.1 Architecture Overview"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Narrative"}),": Issue 545 adds a transport protocol layer that wraps serialized commands in an envelope, routes them through an idempotency registry and server adapter, and returns an acknowledgment or rejection response while leaving deterministic runtime execution unchanged."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Diagram"}),":"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-text",children:"Client                         Transport Layer                          Server\n--------------  CommandEnvelope  -----------------------  CommandEnvelope  -----------------\nRuntime UI   -> Pending Tracker -> Network Adapter   ->  Transport Server -> Idle Runtime\nRuntime UI   <- CommandResponse <- Pending Tracker <-    Idempotency Reg  <- CommandQueue\n--------------                  -----------------------                  -----------------\n"})}),"\n",(0,i.jsx)(n.h3,{id:"62-detailed-design",children:"6.2 Detailed Design"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Runtime Changes"}),": Issue 545 adds a ",(0,i.jsx)(n.code,{children:"CommandExecutionOutcome"})," stream (success or failure with ",(0,i.jsx)(n.code,{children:"requestId"}),", ",(0,i.jsx)(n.code,{children:"serverStep"}),", and ",(0,i.jsx)(n.code,{children:"CommandError"}),") and a ",(0,i.jsx)(n.code,{children:"drainCommandOutcomes()"})," API alongside ",(0,i.jsx)(n.code,{children:"drainCommandFailures()"})," (",(0,i.jsx)(n.code,{children:"packages/core/src/index.ts:237"}),"). The transport server uses these outcomes to finalize responses without changing command queue order (",(0,i.jsx)(n.code,{children:"packages/core/src/command-queue.ts:74"}),") and serializes ",(0,i.jsx)(n.code,{children:"CommandError"})," into a JSON-safe transport error."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Data & Schemas"}),": Issue 545 introduces a JSON-safe ",(0,i.jsx)(n.code,{children:"SerializedCommand"})," and transport wrappers aligned with existing payload serialization (",(0,i.jsx)(n.code,{children:"packages/core/src/command-queue.ts:33"}),")."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"export type SerializedCommand = Readonly<{\n  readonly type: string;\n  readonly priority: CommandPriority;\n  readonly timestamp: number;\n  readonly step: number;\n  readonly payload: JsonValue;\n  readonly requestId?: string;\n}>;\n\nexport interface CommandEnvelope {\n  readonly requestId: string;\n  readonly clientId: string;\n  readonly command: SerializedCommand;\n  readonly sentAt: number;\n}\n\nexport type CommandResponseError = Readonly<{\n  readonly code: string;\n  readonly message: string;\n  readonly details?: JsonValue;\n}>;\n\nexport interface CommandResponse {\n  readonly requestId: string;\n  readonly status: 'accepted' | 'rejected' | 'duplicate';\n  readonly serverStep: number;\n  readonly error?: CommandResponseError;\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"APIs & Contracts"}),": Issue 545 adds idempotency and pending tracking interfaces with deterministic, in-memory implementations."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"export interface IdempotencyRegistry {\n  get(key: string): CommandResponse | undefined;\n  record(key: string, response: CommandResponse, expiresAt: number): void;\n  purgeExpired(now: number): void;\n  size(): number;\n}\n\nexport interface PendingCommandTracker {\n  track(envelope: CommandEnvelope): void;\n  resolve(response: CommandResponse): void;\n  expire(now: number): CommandEnvelope[];\n  getPending(): readonly CommandEnvelope[];\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Tooling & Automation"}),": Issue 545 exports transport types and helpers from ",(0,i.jsx)(n.code,{children:"packages/core/src/index.ts"}),", adds unit/integration tests in ",(0,i.jsx)(n.code,{children:"packages/core/src"}),", and updates docs references in ",(0,i.jsx)(n.code,{children:"docs/"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"63-operational-considerations",children:"6.3 Operational Considerations"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Deployment"}),": Issue 545 is additive and requires no runtime deployment changes."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Telemetry & Observability"}),": Issue 545 adds telemetry events for duplicate requests and timeouts without logging payload contents."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Security & Compliance"}),": Issue 545 validates ",(0,i.jsx)(n.code,{children:"clientId"}),"/",(0,i.jsx)(n.code,{children:"requestId"})," length and format, and scopes idempotency keys to ",(0,i.jsx)(n.code,{children:"{clientId, requestId}"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"7-work-breakdown--delivery-plan",children:"7. Work Breakdown & Delivery Plan"}),"\n",(0,i.jsx)(n.h3,{id:"71-issue-map",children:"7.1 Issue Map"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Issue Title"}),(0,i.jsx)(n.th,{children:"Scope Summary"}),(0,i.jsx)(n.th,{children:"Proposed Assignee/Agent"}),(0,i.jsx)(n.th,{children:"Dependencies"}),(0,i.jsx)(n.th,{children:"Acceptance Criteria"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"feat(core): add transport types for Issue 545"}),(0,i.jsxs)(n.td,{children:["Define ",(0,i.jsx)(n.code,{children:"SerializedCommand"}),", ",(0,i.jsx)(n.code,{children:"CommandEnvelope"}),", ",(0,i.jsx)(n.code,{children:"CommandResponse"})," and exports"]}),(0,i.jsx)(n.td,{children:"Transport Protocol Agent"}),(0,i.jsx)(n.td,{children:"Design approval"}),(0,i.jsxs)(n.td,{children:["Types exported; lint clean; ",(0,i.jsx)(n.code,{children:"pnpm test --filter @idle-engine/core"})," passes"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"feat(core): add idempotency registry for Issue 545"}),(0,i.jsx)(n.td,{children:"Implement registry interface + default in-memory registry"}),(0,i.jsx)(n.td,{children:"Runtime Implementation Agent"}),(0,i.jsx)(n.td,{children:"Transport types"}),(0,i.jsx)(n.td,{children:"Registry handles duplicates with TTL; unit tests added"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"feat(core): add pending command tracker for Issue 545"}),(0,i.jsx)(n.td,{children:"Implement client-side tracker for in-flight commands"}),(0,i.jsx)(n.td,{children:"Runtime Implementation Agent"}),(0,i.jsx)(n.td,{children:"Transport types"}),(0,i.jsx)(n.td,{children:"Timeouts tracked; retry hooks defined; unit tests added"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"feat(core): add command outcome drain for Issue 545"}),(0,i.jsx)(n.td,{children:"Expose success/failure outcomes with requestId"}),(0,i.jsx)(n.td,{children:"Runtime Implementation Agent"}),(0,i.jsx)(n.td,{children:"Transport types"}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"drainCommandOutcomes()"})," returns accepted/rejected outcomes; tests updated"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"feat(core): add transport server adapter for Issue 545"}),(0,i.jsx)(n.td,{children:"Convert envelopes to runtime commands and responses"}),(0,i.jsx)(n.td,{children:"Transport Protocol Agent"}),(0,i.jsx)(n.td,{children:"Registry + outcomes"}),(0,i.jsx)(n.td,{children:"Accept/reject/duplicate behavior verified; integration tests added"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"test(core): cover transport flows for Issue 545"}),(0,i.jsx)(n.td,{children:"Add accept/reject/duplicate integration tests"}),(0,i.jsx)(n.td,{children:"Testing Agent"}),(0,i.jsx)(n.td,{children:"Server adapter"}),(0,i.jsxs)(n.td,{children:["Tests added for ack, rejection, duplicate; ",(0,i.jsx)(n.code,{children:"pnpm test --filter @idle-engine/core"})," passes"]})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"72-milestones",children:"7.2 Milestones"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Phase 1"}),": Issue 545 transport types, registry, and pending tracker implemented and tested."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Phase 2"}),": Issue 545 runtime outcomes, server adapter, and integration tests completed."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"73-coordination-notes",children:"7.3 Coordination Notes"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Hand-off Package"}),": Issue 545 context includes ",(0,i.jsx)(n.code,{children:"docs/runtime-command-queue-design.md"}),", ",(0,i.jsx)(n.code,{children:"docs/state-synchronization-protocol-design.md"}),", ",(0,i.jsx)(n.code,{children:"packages/core/src/command.ts:18"}),", ",(0,i.jsx)(n.code,{children:"packages/core/src/command-dispatcher.ts:7"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Communication Cadence"}),": Issue 545 status updates daily until Phase 2 completion, with a review checkpoint after Phase 1."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"8-agent-guidance--guardrails",children:"8. Agent Guidance & Guardrails"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Context Packets"}),": Issue 545 agents must load ",(0,i.jsx)(n.code,{children:"packages/core/src/command.ts"}),", ",(0,i.jsx)(n.code,{children:"packages/core/src/command-queue.ts"}),", ",(0,i.jsx)(n.code,{children:"packages/core/src/command-dispatcher.ts"}),", ",(0,i.jsx)(n.code,{children:"packages/core/src/index.ts"}),", and ",(0,i.jsx)(n.code,{children:"docs/state-synchronization-protocol-design.md"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Prompting & Constraints"}),': Issue 545 agent prompt example: "You are the Runtime Implementation Agent for Issue 545. Implement idempotency registry and pending tracker in ',(0,i.jsx)(n.code,{children:"packages/core"}),", use type-only imports, do not alter command queue ordering, and run ",(0,i.jsx)(n.code,{children:"pnpm test --filter @idle-engine/core"}),'."']}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Safety Rails"}),": Issue 545 agents must not edit ",(0,i.jsx)(n.code,{children:"dist/"})," outputs, must avoid console output that could disrupt Vitest JSON reporting, and must not add network dependencies to ",(0,i.jsx)(n.code,{children:"packages/core"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Validation Hooks"}),": Issue 545 completion requires ",(0,i.jsx)(n.code,{children:"pnpm lint"})," and ",(0,i.jsx)(n.code,{children:"pnpm test --filter @idle-engine/core"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"9-alternatives-considered",children:"9. Alternatives Considered"}),"\n",(0,i.jsx)(n.p,{children:"Issue 545 alternatives considered:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Implement transport in shell code only (rejected: fragments protocol definitions and reduces test coverage)."}),"\n",(0,i.jsx)(n.li,{children:"Extend command queue serialization to serve as transport (rejected: lacks acknowledgment and idempotency semantics)."}),"\n",(0,i.jsx)(n.li,{children:"Use state sync snapshots for command delivery (rejected: excessive bandwidth and mismatch with request/response flows)."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"10-testing--validation-plan",children:"10. Testing & Validation Plan"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Unit / Integration"}),": Issue 545 adds unit tests for idempotency registry and pending tracker plus integration tests for accept, reject, and duplicate flows."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Performance"}),": Issue 545 validates O(1) average registry operations and TTL eviction behavior."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Tooling / A11y"}),": Issue 545 has no UI surface, so accessibility validation is not applicable."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"11-risks--mitigations",children:"11. Risks & Mitigations"}),"\n",(0,i.jsx)(n.p,{children:"Issue 545 risks and mitigations:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Duplicate requestId collisions across clients lead to incorrect responses. Mitigation: scope registry keys by ",(0,i.jsx)(n.code,{children:"{clientId, requestId}"})," and validate input formats."]}),"\n",(0,i.jsx)(n.li,{children:"Pending tracker leaks entries when no response arrives. Mitigation: require timeout eviction and expose pending counts for diagnostics."}),"\n",(0,i.jsxs)(n.li,{children:["Command rejection lacks explicit error payload. Mitigation: standardize rejection errors using ",(0,i.jsx)(n.code,{children:"CommandError"})," (",(0,i.jsx)(n.code,{children:"packages/core/src/command-dispatcher.ts:7"}),") and serialize to ",(0,i.jsx)(n.code,{children:"CommandResponseError"})," for transport."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"12-rollout-plan",children:"12. Rollout Plan"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Milestones"}),": Issue 545 ships in two phases (types/registry first, adapter and tests second)."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Migration Strategy"}),": Issue 545 introduces additive APIs with no data migration."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Communication"}),": Issue 545 release notes should link to this doc and reference issue 545 acceptance criteria."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"13-open-questions",children:"13. Open Questions"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Issue 545 TODO (Owner: Runtime Core Maintainer): Should ",(0,i.jsx)(n.code,{children:"serverStep"})," in ",(0,i.jsx)(n.code,{children:"CommandResponse"})," reflect enqueue step or execution step?"]}),"\n",(0,i.jsx)(n.li,{children:"Issue 545 TODO (Owner: Transport Protocol Agent): What are the default TTL and timeout durations for idempotency and pending tracking?"}),"\n",(0,i.jsx)(n.li,{children:"Issue 545 TODO (Owner: Docs Agent): Where should transport protocol usage be documented beyond this design doc?"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"14-follow-up-work",children:"14. Follow-Up Work"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Issue 545 follow-up: build concrete WebSocket/HTTP transport adapters in shell repos."}),"\n",(0,i.jsx)(n.li,{children:"Issue 545 follow-up: add metrics dashboards for transport acknowledgments."}),"\n",(0,i.jsx)(n.li,{children:"Issue 545 follow-up: evaluate batching/compression strategies for command envelopes."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"15-references",children:"15. References"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/545",children:"https://github.com/hansjm10/Idle-Game-Engine/issues/545"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"docs/runtime-command-queue-design.md"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"docs/state-synchronization-protocol-design.md"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"packages/core/src/command.ts:18"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"packages/core/src/command.ts:230"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"packages/core/src/command-queue.ts:33"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"packages/core/src/command-queue.ts:207"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"packages/core/src/command-dispatcher.ts:7"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"packages/core/src/index.ts:237"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"packages/core/src/command-queue.test.ts:39"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"appendix-a---glossary",children:"Appendix A - Glossary"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Issue 545 CommandEnvelope"}),": Transport wrapper containing ",(0,i.jsx)(n.code,{children:"clientId"}),", ",(0,i.jsx)(n.code,{children:"requestId"}),", ",(0,i.jsx)(n.code,{children:"command"}),", and ",(0,i.jsx)(n.code,{children:"sentAt"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Issue 545 CommandResponse"}),": Server response with acceptance, rejection, or duplication status."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Issue 545 Idempotency Registry"}),": Server-side cache preventing duplicate command execution."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Issue 545 Pending Command Tracker"}),": Client-side tracker for in-flight command acknowledgments and timeouts."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Issue 545 SerializedCommand"}),": JSON-safe command payload used for transport."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"appendix-b---change-log",children:"Appendix B - Change Log"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Date"}),(0,i.jsx)(n.th,{children:"Author"}),(0,i.jsx)(n.th,{children:"Change Summary"})]})}),(0,i.jsx)(n.tbody,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"2025-12-27"}),(0,i.jsx)(n.td,{children:"TODO (Owner: Runtime Core Maintainer)"}),(0,i.jsx)(n.td,{children:"Initial Issue 545 draft"})]})})]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},7678:(e,n,s)=>{s.d(n,{R:()=>d,x:()=>o});var r=s(9430);const i={},t=r.createContext(i);function d(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);