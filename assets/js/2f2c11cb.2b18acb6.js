"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[9783],{1226:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"progression-coordinator-design","title":"Progression Coordinator Pattern","description":"Document Control","source":"@site/../../docs/progression-coordinator-design.md","sourceDirName":".","slug":"/progression-coordinator-design","permalink":"/Idle-Game-Engine/progression-coordinator-design","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/progression-coordinator-design.md","tags":[],"version":"current","frontMatter":{}}');var i=s(5270),t=s(7678);const o={},l="Progression Coordinator Pattern",c={},d=[{value:"Document Control",id:"document-control",level:2},{value:"1. Summary",id:"1-summary",level:2},{value:"2. Context &amp; Problem Statement",id:"2-context--problem-statement",level:2},{value:"3. Goals &amp; Non-Goals",id:"3-goals--non-goals",level:2},{value:"4. Stakeholders, Agents &amp; Impacted Surfaces",id:"4-stakeholders-agents--impacted-surfaces",level:2},{value:"5. Current State",id:"5-current-state",level:2},{value:"6. Proposed Solution",id:"6-proposed-solution",level:2},{value:"6.1 Architecture Overview",id:"61-architecture-overview",level:3},{value:"6.2 Detailed Design",id:"62-detailed-design",level:3},{value:"6.2.1 Public API Contract",id:"621-public-api-contract",level:4},{value:"6.2.2 State Management Strategy",id:"622-state-management-strategy",level:4},{value:"6.2.3 Initialization Flow",id:"623-initialization-flow",level:4},{value:"6.2.4 Per-Tick Update Logic",id:"624-per-tick-update-logic",level:4},{value:"6.2.5 Hydration from Saves",id:"625-hydration-from-saves",level:4},{value:"6.2.6 Purchase Evaluators",id:"626-purchase-evaluators",level:4},{value:"6.2.7 Cost Calculation",id:"627-cost-calculation",level:4},{value:"6.2.8 Upgrade Status Resolution",id:"628-upgrade-status-resolution",level:4},{value:"6.3 Operational Considerations",id:"63-operational-considerations",level:3},{value:"7. Work Breakdown &amp; Delivery Plan",id:"7-work-breakdown--delivery-plan",level:2},{value:"8. Agent Guidance &amp; Guardrails",id:"8-agent-guidance--guardrails",level:2},{value:"9. Alternatives Considered",id:"9-alternatives-considered",level:2},{value:"10. Testing &amp; Validation Plan",id:"10-testing--validation-plan",level:2},{value:"11. Risks &amp; Mitigations",id:"11-risks--mitigations",level:2},{value:"12. Rollout Plan",id:"12-rollout-plan",level:2},{value:"13. Open Questions",id:"13-open-questions",level:2},{value:"14. Follow-Up Work",id:"14-follow-up-work",level:2},{value:"15. References",id:"15-references",level:2},{value:"Implementation Files",id:"implementation-files",level:3},{value:"Design Documents",id:"design-documents",level:3},{value:"Related Issues",id:"related-issues",level:3},{value:"Appendix A \u2014 Glossary",id:"appendix-a--glossary",level:2},{value:"Appendix B \u2014 Change Log",id:"appendix-b--change-log",level:2}];function a(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"progression-coordinator-pattern",children:"Progression Coordinator Pattern"})}),"\n",(0,i.jsx)(n.h2,{id:"document-control",children:"Document Control"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Title"}),": Progression Coordinator Pattern for Hydrating Progression Snapshots"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Authors"}),": Design Documentation Agent (Retroactive Documentation)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Reviewers"}),": Runtime Core Maintainers; Shell UX Maintainers"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Status"}),": Approved (Documenting Existing Implementation)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Last Updated"}),": 2025-11-01"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Related Issues"}),": #302, #303"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Execution Mode"}),": N/A (Retroactive documentation of shipped code)"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"1-summary",children:"1. Summary"}),"\n",(0,i.jsxs)(n.p,{children:["This document describes the ",(0,i.jsx)(n.strong,{children:"Progression Coordinator pattern"})," implemented in PR #303, which centralizes progression state management for resources, generators, and upgrades. The coordinator owns authoritative progression state, evaluates unlock/visibility conditions per game step, provides purchase cost evaluators to command handlers, and supports hydration from serialized saves. This is ",(0,i.jsx)(n.strong,{children:"retroactive documentation"})," of the existing implementation in ",(0,i.jsx)(n.code,{children:"packages/core/src/progression-coordinator.ts"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"2-context--problem-statement",children:"2. Context & Problem Statement"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Background"}),": Prior to PR #303, the runtime worker directly managed progression state through scattered command handlers (",(0,i.jsx)(n.code,{children:"packages/core/src/resource-command-handlers.ts"}),"). The worker lacked a centralized mechanism to evaluate unlock conditions, manage generator/upgrade visibility, or hydrate progression state from saves."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Problem"}),": Without a coordinator pattern, progression logic was fragmented across command handlers, making it difficult to:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Evaluate complex unlock conditions defined in content packs"}),"\n",(0,i.jsx)(n.li,{children:"Maintain consistent state between fresh sessions and restored saves"}),"\n",(0,i.jsx)(n.li,{children:"Provide unified purchase cost quotes to the presentation layer"}),"\n",(0,i.jsx)(n.li,{children:"Update generator/upgrade visibility dynamically based on game state"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Forces"}),": The solution needed to preserve deterministic command execution, integrate with existing resource state management (",(0,i.jsx)(n.code,{children:"packages/core/src/resource-state.ts"}),"), support the progression snapshot schema defined in ",(0,i.jsx)(n.code,{children:"docs/build-resource-generator-upgrade-ui-components-design.md"})," \xa76.2, and enable session restoration as specified in ",(0,i.jsx)(n.code,{children:"docs/runtime-react-worker-bridge-design.md"})," \xa714.1."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"3-goals--non-goals",children:"3. Goals & Non-Goals"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Goals"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Centralize ownership of authoritative progression state in a single coordinator"}),"\n",(0,i.jsx)(n.li,{children:"Evaluate unlock and visibility conditions from content pack definitions"}),"\n",(0,i.jsxs)(n.li,{children:["Provide purchase evaluators implementing ",(0,i.jsx)(n.code,{children:"GeneratorPurchaseEvaluator"})," and ",(0,i.jsx)(n.code,{children:"UpgradePurchaseEvaluator"})," interfaces"]}),"\n",(0,i.jsxs)(n.li,{children:["Support hydration from ",(0,i.jsx)(n.code,{children:"SerializedResourceState"})," for session restoration"]}),"\n",(0,i.jsx)(n.li,{children:"Maintain per-tick state updates for dynamic condition evaluation"}),"\n",(0,i.jsxs)(n.li,{children:["Enable building immutable ",(0,i.jsx)(n.code,{children:"ProgressionSnapshot"})," for shell consumption"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Non-Goals"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Modifying core resource state storage architecture (remains in ",(0,i.jsx)(n.code,{children:"@idle-engine/core"}),")"]}),"\n",(0,i.jsx)(n.li,{children:"Implementing new condition types beyond those in content schema"}),"\n",(0,i.jsx)(n.li,{children:"Changing command queue execution model"}),"\n",(0,i.jsx)(n.li,{children:"Adding new progression features beyond what PR #303 delivered"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"4-stakeholders-agents--impacted-surfaces",children:"4. Stakeholders, Agents & Impacted Surfaces"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Primary Stakeholders"}),": Runtime Core maintainers; Shell UX team consuming snapshots"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Agent Roles"}),": N/A (existing implementation)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Affected Packages/Services"}),": ",(0,i.jsx)(n.code,{children:"packages/core"})," (coordinator implementation, interfaces, resource state, progression types); ",(0,i.jsx)(n.code,{children:"packages/shell-web"})," (worker integration, UI consumption); ",(0,i.jsx)(n.code,{children:"packages/content-sample"})," (consumed by coordinator)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Compatibility Considerations"}),": Coordinator integrates with existing command handlers; saves from pre-PR#303 require migration handled by resource state reconciliation"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"5-current-state",children:"5. Current State"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"As implemented in PR #303"})," (",(0,i.jsx)(n.code,{children:"packages/core/src/progression-coordinator.ts"}),"):"]}),"\n",(0,i.jsx)(n.p,{children:"The coordinator is a facade that:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Owns a ",(0,i.jsx)(n.code,{children:"ResourceState"})," instance for managing resource amounts/capacity/flags"]}),"\n",(0,i.jsx)(n.li,{children:"Maintains internal mutable records for generators and upgrades"}),"\n",(0,i.jsxs)(n.li,{children:["Exposes frozen ",(0,i.jsx)(n.code,{children:"ProgressionAuthoritativeState"})," to external consumers"]}),"\n",(0,i.jsxs)(n.li,{children:["Provides ",(0,i.jsx)(n.code,{children:"GeneratorPurchaseEvaluator"})," and ",(0,i.jsx)(n.code,{children:"UpgradePurchaseEvaluator"})," implementations"]}),"\n",(0,i.jsxs)(n.li,{children:["Evaluates content-defined conditions via ",(0,i.jsx)(n.code,{children:"condition-evaluator.ts"})]}),"\n",(0,i.jsxs)(n.li,{children:["Updates all progression state in ",(0,i.jsx)(n.code,{children:"updateForStep()"})," called every game tick"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Integration point"})," (",(0,i.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.ts:134-160"}),"):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Worker creates coordinator with ",(0,i.jsx)(n.code,{children:"sampleContent"})," and optional ",(0,i.jsx)(n.code,{children:"initialState"})," from saved game"]}),"\n",(0,i.jsx)(n.li,{children:"Coordinator's evaluators are registered with command handlers"}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"updateForStep()"})," is called after runtime step advances (line 225)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"buildProgressionSnapshot()"})," uses coordinator's authoritative state (lines 228-232)"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"6-proposed-solution",children:"6. Proposed Solution"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Note"}),": This section describes the ",(0,i.jsx)(n.strong,{children:"existing implementation"})," from PR #303, not future work."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"61-architecture-overview",children:"6.1 Architecture Overview"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Pattern"}),": Facade + Dependency Injection"]}),"\n",(0,i.jsx)(n.p,{children:"The coordinator acts as a facade over:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Resource state (struct-of-arrays storage from ",(0,i.jsx)(n.code,{children:"@idle-engine/core"}),")"]}),"\n",(0,i.jsx)(n.li,{children:"Generator records (mutable internal state mapped to content definitions)"}),"\n",(0,i.jsx)(n.li,{children:"Upgrade records (mutable internal state with purchase tracking)"}),"\n",(0,i.jsx)(n.li,{children:"Condition evaluation context (provides state access for condition DSL)"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Diagram"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   Runtime Worker                \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 ProgressionCoordinator   \u2502   \u2502\n\u2502  \u2502                          \u2502   \u2502\n\u2502  \u2502  state: Authoritative    \u2502\u25c4\u2500\u2500\u253c\u2500\u2500 buildProgressionSnapshot()\n\u2502  \u2502  resourceState: Mutable  \u2502   \u2502\n\u2502  \u2502  generatorEvaluator      \u2502\u25c4\u2500\u2500\u253c\u2500\u2500 Command Handlers\n\u2502  \u2502  upgradeEvaluator        \u2502   \u2502\n\u2502  \u2502                          \u2502   \u2502\n\u2502  \u2502  updateForStep(step)     \u2502\u25c4\u2500\u2500\u253c\u2500\u2500 Per-tick update\n\u2502  \u2502  hydrateResources(save)  \u2502\u25c4\u2500\u2500\u253c\u2500\u2500 Session restore\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502           \u2502                     \u2502\n\u2502           \u25bc                     \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           \u2502\n\u2502  \u2502 Condition        \u2502           \u2502\n\u2502  \u2502 Evaluator        \u2502           \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2502\n\u2502           \u2502                     \u2502\n\u2502           \u25bc                     \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 Content Pack             \u2502   \u2502\n\u2502  \u2502 (generators, upgrades,   \u2502   \u2502\n\u2502  \u2502  unlock conditions)      \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,i.jsx)(n.h3,{id:"62-detailed-design",children:"6.2 Detailed Design"}),"\n",(0,i.jsx)(n.h4,{id:"621-public-api-contract",children:"6.2.1 Public API Contract"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Interface"})," (",(0,i.jsx)(n.code,{children:"packages/core/src/progression-coordinator.ts"}),"):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"export interface ProgressionCoordinator {\n  readonly state: ProgressionAuthoritativeState;\n  readonly resourceState: ResourceState;\n  readonly generatorEvaluator: GeneratorPurchaseEvaluator;\n  readonly upgradeEvaluator?: UpgradePurchaseEvaluator;  // undefined if no upgrades\n\n  hydrateResources(serialized: SerializedResourceState | undefined): void;\n  updateForStep(step: number): void;\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Factory Function"})," (",(0,i.jsx)(n.code,{children:"packages/core/src/progression-coordinator.ts"}),"):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"export function createProgressionCoordinator(\n  options: ProgressionCoordinatorOptions,\n): ProgressionCoordinator\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Options"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"content: NormalizedContentPack"})," - Content definitions for resources/generators/upgrades"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"stepDurationMs: number"})," - Game tick duration (must be non-negative)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"initialState?: ProgressionAuthoritativeState"})," - Optional save state to restore"]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"622-state-management-strategy",children:"6.2.2 State Management Strategy"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Hybrid Mutability"}),":"]}),"\n",(0,i.jsxs)(n.p,{children:["The coordinator uses ",(0,i.jsx)(n.strong,{children:"mutable internal records"})," for performance (",(0,i.jsx)(n.code,{children:"packages/core/src/progression-coordinator.ts"}),"):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"type GeneratorRecord = {\n  readonly definition: NormalizedGenerator;\n  readonly state: Mutable<ProgressionGeneratorState>;\n};\n\ntype UpgradeRecord = {\n  readonly definition: NormalizedUpgrade;\n  readonly state: MutableUpgradeState;\n  purchases: number;\n};\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Rationale"}),": Avoiding allocation churn during per-tick ",(0,i.jsx)(n.code,{children:"updateForStep()"})," calls. Mutating records in-place prevents creating new state objects every tick when conditions are re-evaluated."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"External API"}),": The ",(0,i.jsx)(n.code,{children:"state"})," property exposes a ",(0,i.jsx)(n.strong,{children:"frozen view"})," (",(0,i.jsx)(n.code,{children:"ProgressionAuthoritativeState"}),") where consumers cannot mutate progression state. This prevents accidental mutation from command handlers or snapshot builders."]}),"\n",(0,i.jsx)(n.h4,{id:"623-initialization-flow",children:"6.2.3 Initialization Flow"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Constructor"})," (",(0,i.jsx)(n.code,{children:"packages/core/src/progression-coordinator.ts"}),"):"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Convert content resources to definitions"})," (lines 194-206):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Maps ",(0,i.jsx)(n.code,{children:"NormalizedResource"})," \u2192 ",(0,i.jsx)(n.code,{children:"ResourceDefinition"})]}),"\n",(0,i.jsxs)(n.li,{children:["Applies defaults (",(0,i.jsx)(n.code,{children:"startAmount"}),", ",(0,i.jsx)(n.code,{children:"capacity"}),", ",(0,i.jsx)(n.code,{children:"unlocked"}),", ",(0,i.jsx)(n.code,{children:"visible"}),")"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Create or restore resource state"})," (lines 210-214):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["If ",(0,i.jsx)(n.code,{children:"initialState?.resources?.state"})," exists, reuse it"]}),"\n",(0,i.jsxs)(n.li,{children:["Otherwise create fresh ",(0,i.jsx)(n.code,{children:"ResourceState"})," with ",(0,i.jsx)(n.code,{children:"createResourceState(definitions)"})]}),"\n",(0,i.jsxs)(n.li,{children:["Call ",(0,i.jsx)(n.code,{children:"hydrateResources()"})," with serialized state if available"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Build generator records"})," (lines 223-234):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Map content generators to internal ",(0,i.jsx)(n.code,{children:"GeneratorRecord"})]}),"\n",(0,i.jsxs)(n.li,{children:["Restore saved generator state if ",(0,i.jsx)(n.code,{children:"initialState"})," provided"]}),"\n",(0,i.jsx)(n.li,{children:"Initialize unlocked/visible flags, owned count, cost arrays"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Build upgrade records"})," (lines 236-247):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Map content upgrades to internal ",(0,i.jsx)(n.code,{children:"UpgradeRecord"})]}),"\n",(0,i.jsxs)(n.li,{children:["Restore saved upgrade state if ",(0,i.jsx)(n.code,{children:"initialState"})," provided"]}),"\n",(0,i.jsx)(n.li,{children:"Infer purchase count from status if not saved (lines 684-693)"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Create condition evaluation context"})," (lines 249-264):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Provides closures accessing resource amounts, generator levels, upgrade purchases"}),"\n",(0,i.jsxs)(n.li,{children:["Context is dependency-injected into ",(0,i.jsx)(n.code,{children:"evaluateCondition()"})," calls"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Instantiate evaluators"})," (lines 266-270):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"generatorEvaluator = new ContentGeneratorEvaluator(this)"})}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"upgradeEvaluator = new ContentUpgradeEvaluator(this)"})," if upgrades exist"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Assemble authoritative state"})," (lines 272-282):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Populate ",(0,i.jsx)(n.code,{children:"ProgressionAuthoritativeState"})," with references to resource state, evaluators, and record arrays"]}),"\n",(0,i.jsx)(n.li,{children:"State is reused across ticks; properties are reassigned rather than recreated"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Initial update"})," (line 284):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Call ",(0,i.jsx)(n.code,{children:"updateForStep(0)"})," to evaluate initial unlock/visibility conditions"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"624-per-tick-update-logic",children:"6.2.4 Per-Tick Update Logic"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"updateForStep(step)"})})," (",(0,i.jsx)(n.code,{children:"packages/core/src/progression-coordinator.ts"}),"):"]}),"\n",(0,i.jsxs)(n.p,{children:["Called by runtime worker after step advances (",(0,i.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.ts:225"}),")."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Generator update loop"})," (lines 304-329):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"for (const record of this.generatorList) {\n  // Evaluate base unlock condition\n  const baseUnlock = evaluateCondition(\n    record.definition.baseUnlock,\n    this.conditionContext,\n  );\n\n  // Persistent unlock semantics: once unlocked, never revert\n  if (!record.state.isUnlocked && baseUnlock) {\n    record.state.isUnlocked = true;\n  }\n\n  // Visibility can toggle based on current state\n  const visibleCondition = record.definition.visibilityCondition;\n  record.state.isVisible = visibleCondition\n    ? evaluateCondition(visibleCondition, this.conditionContext)\n    : true;\n\n  // Initialize or update nextPurchaseReadyAtStep\n  if (!Number.isFinite(record.state.nextPurchaseReadyAtStep)) {\n    record.state.nextPurchaseReadyAtStep = step + 1;\n  } else if (!wasUnlocked && record.state.isUnlocked) {\n    // Reset cooldown on unlock transition\n    record.state.nextPurchaseReadyAtStep = step + 1;\n  }\n\n  // Clamp owned count to maxLevel if defined\n  record.state.owned = clampOwned(record.state.owned, record.definition.maxLevel);\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Critical Behavior - Persistent Unlocks"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"baseUnlock"})," condition evaluated every tick"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsxs)(n.strong,{children:["Once ",(0,i.jsx)(n.code,{children:"isUnlocked"})," transitions to ",(0,i.jsx)(n.code,{children:"true"}),", it NEVER reverts"]})," (line 310-312)"]}),"\n",(0,i.jsx)(n.li,{children:"This ensures generators remain available after unlock conditions are met, even if conditions later fail (e.g., player spends resources below threshold)"}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Prestige reset exception"}),": When a prestige layer resets a generator/resource, the prestige evaluator may re-lock unlock/visibility back to content defaults as part of the reset flow."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Upgrade update loop"})," (lines 331-349):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"for (const record of this.upgradeList) {\n  // Resolve status based on prerequisites, unlock condition, purchase count\n  const status = this.resolveUpgradeStatus(record);\n  record.state.status = status;\n\n  // Evaluate visibility condition\n  const visibilityCondition = record.definition.visibilityCondition;\n  record.state.isVisible = visibilityCondition\n    ? evaluateCondition(visibilityCondition, this.conditionContext)\n    : true;\n\n  // Generate unlock hint for locked upgrades\n  record.state.unlockHint = status === 'locked'\n    ? describeCondition(\n        record.definition.unlockCondition ??\n        combineConditions(record.definition.prerequisites)\n      )\n    : undefined;\n\n  // Compute current costs\n  record.state.costs = this.computeUpgradeCosts(record);\n  record.state.purchases = record.purchases;\n}\n"})}),"\n",(0,i.jsx)(n.h4,{id:"625-hydration-from-saves",children:"6.2.5 Hydration from Saves"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"hydrateResources(serialized)"})})," (",(0,i.jsx)(n.code,{children:"packages/core/src/progression-coordinator.ts"}),"):"]}),"\n",(0,i.jsxs)(n.p,{children:["Delegates to ",(0,i.jsx)(n.code,{children:"hydrateResourceState()"})," utility (lines 741-788):"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Reconcile save against current definitions"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Calls ",(0,i.jsx)(n.code,{children:"reconcileSaveAgainstDefinitions(serialized, definitions)"})," from ",(0,i.jsx)(n.code,{children:"@idle-engine/core"})]}),"\n",(0,i.jsxs)(n.li,{children:["Returns ",(0,i.jsx)(n.code,{children:"{ remap: number[] }"})," mapping saved indices to live indices"]}),"\n",(0,i.jsx)(n.li,{children:"Handles added/removed resources between save and current schema"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Restore resource state"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Set capacities from ",(0,i.jsx)(n.code,{children:"serialized.capacities[savedIndex]"})]}),"\n",(0,i.jsxs)(n.li,{children:["Adjust amounts: add or spend to match ",(0,i.jsx)(n.code,{children:"serialized.amounts[savedIndex]"})]}),"\n",(0,i.jsx)(n.li,{children:"Restore unlocked/visible flags from bitsets"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Publish snapshot"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Call ",(0,i.jsx)(n.code,{children:"state.snapshot({ mode: 'publish' })"})," to flush changes to published buffer"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Integration"})," (",(0,i.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.ts:652-798"}),"):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Worker receives ",(0,i.jsx)(n.code,{children:"RESTORE_SESSION"})," message with ",(0,i.jsx)(n.code,{children:"state: SerializedResourceState"})]}),"\n",(0,i.jsx)(n.li,{children:"Preserves coordinator's resource metadata (line 746)"}),"\n",(0,i.jsx)(n.li,{children:"Stores serialized state for reference (line 747)"}),"\n",(0,i.jsxs)(n.li,{children:["Calls ",(0,i.jsx)(n.code,{children:"progressionCoordinator.hydrateResources(message.state)"})," (line 749)"]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"626-purchase-evaluators",children:"6.2.6 Purchase Evaluators"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Generator Evaluator"})," (",(0,i.jsx)(n.code,{children:"packages/core/src/progression-coordinator.ts"}),"):"]}),"\n",(0,i.jsxs)(n.p,{children:["Implements ",(0,i.jsx)(n.code,{children:"GeneratorPurchaseEvaluator"})," interface from ",(0,i.jsx)(n.code,{children:"@idle-engine/core"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"getPurchaseQuote(generatorId, count)"})})," (lines 486-549):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Validates count is positive integer"}),"\n",(0,i.jsx)(n.li,{children:"Checks generator is unlocked and visible"}),"\n",(0,i.jsxs)(n.li,{children:["Validates bulk purchase limit (",(0,i.jsx)(n.code,{children:"maxBulk"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:["Validates not exceeding ",(0,i.jsx)(n.code,{children:"maxLevel"})]}),"\n",(0,i.jsx)(n.li,{children:"Computes total costs by summing purchase costs per resource across the requested count"}),"\n",(0,i.jsxs)(n.li,{children:["Returns ",(0,i.jsx)(n.code,{children:"GeneratorPurchaseQuote"})," with ",(0,i.jsx)(n.code,{children:"costs: [{ resourceId, amount }, ...]"})]}),"\n",(0,i.jsxs)(n.li,{children:["Returns ",(0,i.jsx)(n.code,{children:"undefined"})," if any validation fails"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"applyPurchase(generatorId, count)"})})," (lines 551-556):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Increments generator owned count via ",(0,i.jsx)(n.code,{children:"incrementGeneratorOwned()"})]}),"\n",(0,i.jsxs)(n.li,{children:["Clamps result to ",(0,i.jsx)(n.code,{children:"maxLevel"})]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Upgrade Evaluator"})," (",(0,i.jsx)(n.code,{children:"packages/core/src/progression-coordinator.ts"}),"):"]}),"\n",(0,i.jsxs)(n.p,{children:["Implements ",(0,i.jsx)(n.code,{children:"UpgradePurchaseEvaluator"})," interface from ",(0,i.jsx)(n.code,{children:"@idle-engine/core"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"getPurchaseQuote(upgradeId)"})})," (lines 562-599):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Resolves upgrade status (",(0,i.jsx)(n.code,{children:"locked"})," | ",(0,i.jsx)(n.code,{children:"available"})," | ",(0,i.jsx)(n.code,{children:"purchased"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:["Computes costs via ",(0,i.jsx)(n.code,{children:"computeUpgradeCosts()"})]}),"\n",(0,i.jsx)(n.li,{children:"Returns quote with status and costs"}),"\n",(0,i.jsxs)(n.li,{children:["For ",(0,i.jsx)(n.code,{children:"locked"})," upgrades, includes costs even though purchase unavailable (for UI display)"]}),"\n",(0,i.jsxs)(n.li,{children:["Returns ",(0,i.jsx)(n.code,{children:"undefined"})," if cost computation fails"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"applyPurchase(upgradeId)"})})," (lines 601-603):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Increments purchase count via ",(0,i.jsx)(n.code,{children:"incrementUpgradePurchases()"})]}),"\n",(0,i.jsxs)(n.li,{children:["Clamps to ",(0,i.jsx)(n.code,{children:"maxPurchases"})," for repeatable upgrades"]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"627-cost-calculation",children:"6.2.7 Cost Calculation"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Generator Costs"})," (",(0,i.jsx)(n.code,{children:"packages/core/src/progression-coordinator.ts"}),"):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"computeGeneratorCosts(generatorId: string, purchaseIndex: number): readonly GeneratorResourceCost[] | undefined\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Formula (single-currency)"}),":\n",(0,i.jsx)(n.code,{children:"amount = baseCost \xd7 costCurve(purchaseIndex)"})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Formula (multi-resource)"}),":\nFor each cost entry ",(0,i.jsx)(n.code,{children:"i"}),":\n",(0,i.jsx)(n.code,{children:"amount\u1d62 = baseCost\u1d62 \xd7 costCurve\u1d62(purchaseIndex)"})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Upgrade Costs"})," (",(0,i.jsx)(n.code,{children:"packages/core/src/progression-coordinator.ts"}),"):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"computeUpgradeCosts(record: UpgradeRecord): readonly UpgradeResourceCost[] | undefined {\n  const purchaseLevel = record.purchases;\n  const baseCost = record.definition.cost.baseCost;\n  const evaluatedCost = evaluateCostFormula(\n    record.definition.cost.costCurve,\n    purchaseLevel,\n  );\n  let amount = evaluatedCost * baseCost;\n\n  // Apply repeatable cost curve if upgrade is repeatable\n  const repeatableCostCurve = record.definition.repeatable?.costCurve;\n  if (repeatableCostCurve) {\n    const repeatableAdjustment = evaluateCostFormula(repeatableCostCurve, purchaseLevel);\n    amount *= repeatableAdjustment;\n  }\n\n  return [{ resourceId, amount }, ...];\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Formula for repeatable upgrades"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"amount = baseCost \xd7 costCurve(purchaseLevel) \xd7 repeatableCostCurve(purchaseLevel)\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Cost formula evaluation"})," (lines 790-798):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Evaluates ",(0,i.jsx)(n.code,{children:"NumericFormula"})," with ",(0,i.jsx)(n.code,{children:"{ variables: { level: purchaseLevel } }"})]}),"\n",(0,i.jsxs)(n.li,{children:["Returns ",(0,i.jsx)(n.code,{children:"undefined"})," if result is not finite"]}),"\n",(0,i.jsxs)(n.li,{children:["Distinguishes from ",(0,i.jsx)(n.strong,{children:"static threshold evaluation"})," which uses ",(0,i.jsx)(n.code,{children:"level: 0"})]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"628-upgrade-status-resolution",children:"6.2.8 Upgrade Status Resolution"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"resolveUpgradeStatus(record)"})})," (",(0,i.jsx)(n.code,{children:"packages/core/src/progression-coordinator.ts"}),"):"]}),"\n",(0,i.jsxs)(n.p,{children:["Returns ",(0,i.jsx)(n.code,{children:"'purchased' | 'available' | 'locked'"})," based on:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Already purchased"}),": ",(0,i.jsx)(n.code,{children:"purchases >= maxPurchases"})," \u2192 ",(0,i.jsx)(n.code,{children:"'purchased'"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Prerequisites not met"}),": Any prerequisite condition fails \u2192 ",(0,i.jsx)(n.code,{children:"'locked'"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Unlock condition"}),":","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["If ",(0,i.jsx)(n.code,{children:"unlockCondition"})," defined and fails \u2192 ",(0,i.jsx)(n.code,{children:"'locked'"})]}),"\n",(0,i.jsxs)(n.li,{children:["If ",(0,i.jsx)(n.code,{children:"unlockCondition"})," passes (or undefined) \u2192 ",(0,i.jsx)(n.code,{children:"'available'"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Repeatable upgrades"}),": For upgrades with ",(0,i.jsx)(n.code,{children:"repeatable"})," config and no ",(0,i.jsx)(n.code,{children:"maxPurchases"}),", ",(0,i.jsx)(n.code,{children:"maxPurchases"})," defaults to ",(0,i.jsx)(n.code,{children:"Infinity"}),", so status remains ",(0,i.jsx)(n.code,{children:"'available'"})," after purchase (tested in ",(0,i.jsx)(n.code,{children:"progression-coordinator.test.ts:203-260"}),")."]}),"\n",(0,i.jsx)(n.h3,{id:"63-operational-considerations",children:"6.3 Operational Considerations"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Deployment"}),": Shipped in PR #303; no feature flags or rollout strategy (core infrastructure)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Telemetry & Observability"}),": Coordinator does not emit telemetry directly; telemetry handled by command handlers consuming evaluators"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Security & Compliance"}),": No PII; coordinator runs in worker isolation; no security implications"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"7-work-breakdown--delivery-plan",children:"7. Work Breakdown & Delivery Plan"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"N/A"})," - This documents completed work from PR #303."]}),"\n",(0,i.jsx)(n.h2,{id:"8-agent-guidance--guardrails",children:"8. Agent Guidance & Guardrails"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"N/A"})," - This is retroactive documentation."]}),"\n",(0,i.jsx)(n.h2,{id:"9-alternatives-considered",children:"9. Alternatives Considered"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Alternative 1: Direct evaluator access without coordinator"})}),"\n",(0,i.jsx)(n.p,{children:"Have command handlers directly instantiate generator/upgrade evaluators and evaluate conditions inline."}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Rejected because"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Scatters progression logic across multiple command handlers"}),"\n",(0,i.jsx)(n.li,{children:"Duplicates condition evaluation code"}),"\n",(0,i.jsx)(n.li,{children:"Makes hydration from saves difficult (no centralized state ownership)"}),"\n",(0,i.jsx)(n.li,{children:"Complicates testing (must mock multiple handlers instead of single coordinator)"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Alternative 2: Store progression state in ResourceState"})}),"\n",(0,i.jsxs)(n.p,{children:["Extend ",(0,i.jsx)(n.code,{children:"ResourceState"})," to also track generators and upgrades."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Rejected because"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ResourceState"})," is optimized for struct-of-arrays resource storage; adding generators/upgrades would break that model"]}),"\n",(0,i.jsx)(n.li,{children:"Generators/upgrades have different update semantics (unlock conditions, visibility, purchase counts)"}),"\n",(0,i.jsxs)(n.li,{children:["Would bloat ",(0,i.jsx)(n.code,{children:"@idle-engine/core"})," package with shell-specific concerns"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Alternative 3: Immutable state updates"})}),"\n",(0,i.jsx)(n.p,{children:"Create new state objects every tick instead of mutating records."}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Rejected because"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Per-tick allocation churn (every generator/upgrade creates new object)"}),"\n",(0,i.jsx)(n.li,{children:"Performance cost for large content packs"}),"\n",(0,i.jsx)(n.li,{children:"Frozen external API already prevents accidental mutation"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"10-testing--validation-plan",children:"10. Testing & Validation Plan"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Existing test coverage"})," (",(0,i.jsx)(n.code,{children:"packages/core/src/progression-coordinator.test.ts"}),"):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"789 lines of integration tests"})," covering:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Repeatable upgrade behavior (lines 203-260)"}),"\n",(0,i.jsx)(n.li,{children:"Generator unlock with persistent semantics (lines 278-362)"}),"\n",(0,i.jsx)(n.li,{children:"Visibility condition evaluation (lines 299-321)"}),"\n",(0,i.jsx)(n.li,{children:"Cost calculation for generators and upgrades"}),"\n",(0,i.jsx)(n.li,{children:"Full game loop simulations with resource accumulation"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Condition evaluator tests"})," (",(0,i.jsx)(n.code,{children:"packages/core/src/condition-evaluator.test.ts"}),"):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"556 lines of unit tests"})," covering all condition types, comparators, error handling"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Runtime worker integration tests"})," (",(0,i.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.test.ts"}),"):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'Test "hydrates progression snapshot from sample content state" (line 202)'}),"\n",(0,i.jsx)(n.li,{children:'Test "hydrates live resource state from serialized progression when reusing game state" (line 327)'}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Core progression tests"})," (",(0,i.jsx)(n.code,{children:"packages/core/src/progression.test.ts"}),"):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Test ",(0,i.jsx)(n.code,{children:"nextPurchaseReadyAtStep"})," defaulting (lines 207-235)"]}),"\n",(0,i.jsx)(n.li,{children:"Test upgrade cost propagation with/without evaluators (lines 237-320)"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"11-risks--mitigations",children:"11. Risks & Mitigations"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Risk"}),": Per-tick condition evaluation has O(n) cost as content scales"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Current Impact"}),": Low (sample content has ~10 generators/upgrades)"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Mitigation"}),": If needed in future:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Add dirty tracking (only re-evaluate when dependencies change)"}),"\n",(0,i.jsx)(n.li,{children:"Cache condition evaluation results"}),"\n",(0,i.jsx)(n.li,{children:"Implement incremental evaluation for static conditions"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Risk"}),': Persistent unlock semantics could conflict with future "conditional unlock reversion" feature']}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Impact"}),": Medium (would require breaking change)"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Mitigation"}),": Document persistent unlock behavior as ",(0,i.jsx)(n.strong,{children:"intentional design decision"}),". If reversion needed, add ",(0,i.jsx)(n.code,{children:"revokeUnlock"})," API rather than changing ",(0,i.jsx)(n.code,{children:"updateForStep()"})," behavior."]}),"\n",(0,i.jsx)(n.h2,{id:"12-rollout-plan",children:"12. Rollout Plan"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"N/A"})," - Shipped in PR #303 as core infrastructure."]}),"\n",(0,i.jsx)(n.h2,{id:"13-open-questions",children:"13. Open Questions"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"None"})," - This documents completed implementation."]}),"\n",(0,i.jsx)(n.h2,{id:"14-follow-up-work",children:"14. Follow-Up Work"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Potential future enhancements"})," (not planned):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Incremental condition evaluation"}),": Track condition dependencies and only re-evaluate when state changes"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Telemetry integration"}),": Emit events when generators unlock or upgrades become available"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Schema versioning"}),": Add version field to ",(0,i.jsx)(n.code,{children:"ProgressionAuthoritativeState"})," for future migrations"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Performance profiling"}),": Benchmark ",(0,i.jsx)(n.code,{children:"updateForStep()"})," with large content packs (1000+ generators)"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"15-references",children:"15. References"}),"\n",(0,i.jsx)(n.h3,{id:"implementation-files",children:"Implementation Files"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"packages/core/src/progression-coordinator.ts"})," - Coordinator implementation"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"packages/core/src/condition-evaluator.ts"})," - Condition evaluation system"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"packages/core/src/progression-coordinator.test.ts"})," - Integration tests"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.ts:134-160"})," - Worker integration"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.ts:225"})," - Per-tick update call"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"packages/shell-web/src/runtime.worker.ts:652-798"})," - Session restore integration"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"packages/core/src/progression.ts:1-400"})," - Snapshot builder"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"packages/core/src/resource-state.ts"})," - Resource state storage"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"design-documents",children:"Design Documents"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"docs/build-resource-generator-upgrade-ui-components-design.md"})," \xa76.2 - Progression snapshot schema"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"docs/runtime-react-worker-bridge-design.md"})," \xa714.1 - Session restore flow"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"docs/resource-state-storage-design.md"})," \xa75.3 - Resource hydration mechanics"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"related-issues",children:"Related Issues"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"#302 - Issue tracking progression snapshot hydration"}),"\n",(0,i.jsx)(n.li,{children:"#303 - PR implementing progression coordinator"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"appendix-a--glossary",children:"Appendix A \u2014 Glossary"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Progression Coordinator"}),": Facade pattern centralizing progression state ownership and condition evaluation"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Authoritative State"}),": Frozen view of progression state exposed to external consumers"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Purchase Evaluator"}),": Interface for calculating and applying generator/upgrade purchases"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Condition Context"}),": Dependency-injected interface providing state access for condition evaluation"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Persistent Unlock"}),": Once a generator's ",(0,i.jsx)(n.code,{children:"baseUnlock"})," condition passes, ",(0,i.jsx)(n.code,{children:"isUnlocked"})," never reverts"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Static Threshold"}),": Unlock conditions evaluated with ",(0,i.jsx)(n.code,{children:"level: 0"})," (constant thresholds)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Dynamic Cost Curve"}),": Purchase costs evaluated with ",(0,i.jsx)(n.code,{children:"level: purchaseIndex"})," (scaling curves)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Hydration"}),": Restoring progression state from serialized save data"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"appendix-b--change-log",children:"Appendix B \u2014 Change Log"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Date"}),(0,i.jsx)(n.th,{children:"Author"}),(0,i.jsx)(n.th,{children:"Change Summary"})]})}),(0,i.jsx)(n.tbody,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"2025-11-01"}),(0,i.jsx)(n.td,{children:"Design Documentation Agent"}),(0,i.jsx)(n.td,{children:"Retroactive documentation of PR #303 implementation"})]})})]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},7678:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>l});var r=s(9430);const i={},t=r.createContext(i);function o(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);