"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[8034],{1753:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"shell-state-provider-readiness-design-issue-394","title":"Deterministic Shell State Readiness Contract for ShellStateProvider","description":"Use this document to define and implement a deterministic async boundary for Shell state initialisation and telemetry in the web shell, replacing the historical flushMicrotasks-based workaround in ShellStateProvider tests (GitHub issue #394).","source":"@site/../../docs/shell-state-provider-readiness-design-issue-394.md","sourceDirName":".","slug":"/shell-state-provider-readiness-design-issue-394","permalink":"/Idle-Game-Engine/shell-state-provider-readiness-design-issue-394","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/shell-state-provider-readiness-design-issue-394.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"title":"Deterministic Shell State Readiness Contract for ShellStateProvider","sidebar_position":4}}');var l=n(5270),r=n(7678);const t={title:"Deterministic Shell State Readiness Contract for ShellStateProvider",sidebar_position:4},d="Deterministic Shell State Readiness Contract for ShellStateProvider",c={},o=[{value:"Document Control",id:"document-control",level:2},{value:"1. Summary",id:"1-summary",level:2},{value:"2. Context &amp; Problem Statement",id:"2-context--problem-statement",level:2},{value:"3. Goals &amp; Non-Goals",id:"3-goals--non-goals",level:2},{value:"4. Stakeholders, Agents &amp; Impacted Surfaces",id:"4-stakeholders-agents--impacted-surfaces",level:2},{value:"5. Current State",id:"5-current-state",level:2},{value:"6. Proposed Solution",id:"6-proposed-solution",level:2},{value:"6.1 Architecture Overview",id:"61-architecture-overview",level:3},{value:"6.2 Detailed Design",id:"62-detailed-design",level:3},{value:"6.3 Operational Considerations",id:"63-operational-considerations",level:3},{value:"7. Work Breakdown &amp; Delivery Plan",id:"7-work-breakdown--delivery-plan",level:2},{value:"7.1 Issue Map",id:"71-issue-map",level:3},{value:"7.2 Milestones",id:"72-milestones",level:3},{value:"7.3 Coordination Notes",id:"73-coordination-notes",level:3},{value:"8. Agent Guidance &amp; Guardrails",id:"8-agent-guidance--guardrails",level:2},{value:"9. Alternatives Considered",id:"9-alternatives-considered",level:2},{value:"10. Testing &amp; Validation Plan",id:"10-testing--validation-plan",level:2},{value:"11. Risks &amp; Mitigations",id:"11-risks--mitigations",level:2},{value:"12. Rollout Plan",id:"12-rollout-plan",level:2},{value:"13. Open Questions",id:"13-open-questions",level:2},{value:"14. Follow-Up Work",id:"14-follow-up-work",level:2},{value:"15. References",id:"15-references",level:2},{value:"Appendix A \u2014 Glossary",id:"appendix-a--glossary",level:2},{value:"Appendix B \u2014 Change Log",id:"appendix-b--change-log",level:2}];function a(e){const s={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(s.header,{children:(0,l.jsx)(s.h1,{id:"deterministic-shell-state-readiness-contract-for-shellstateprovider",children:"Deterministic Shell State Readiness Contract for ShellStateProvider"})}),"\n",(0,l.jsxs)(s.p,{children:["Use this document to define and implement a deterministic async boundary for Shell state initialisation and telemetry in the web shell, replacing the historical ",(0,l.jsx)(s.code,{children:"flushMicrotasks"}),"-based workaround in ",(0,l.jsx)(s.code,{children:"ShellStateProvider"})," tests (GitHub issue #394)."]}),"\n",(0,l.jsx)(s.h2,{id:"document-control",children:"Document Control"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Title"}),": Introduce deterministic Shell state readiness contract for ShellStateProvider"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Authors"}),": Idle Engine Design-Authoring Agent (Shell Web)"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Reviewers"}),": Shell Web Maintainer(s); Runtime/Bridge Maintainer(s)"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Status"}),": Implemented"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Last Updated"}),": 2025-11-16"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Related Issues"}),": ",(0,l.jsx)(s.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/394",children:"#394"})]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Execution Mode"}),": AI-led"]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"1-summary",children:"1. Summary"}),"\n",(0,l.jsxs)(s.p,{children:["This design defines a deterministic Shell state readiness contract for ",(0,l.jsx)(s.code,{children:"ShellStateProvider"})," in ",(0,l.jsx)(s.code,{children:"shell-web"})," and replaces the brittle ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," test helper with an explicit, documented async boundary. Historically, Shell tests relied on chained microtasks and ",(0,l.jsx)(s.code,{children:"setTimeout(0)"})," to \u201chope\u201d the provider had completed its initial async work; this resulted in non-obvious coupling to the event loop and potential flakiness. The implemented solution introduces a canonical readiness condition, exposed via Shell state and a dedicated test helper, so tests (and future automation) can await ",(0,l.jsx)(s.code,{children:"ShellStateProvider"})," initialisation and telemetry wiring without relying on event-loop timing. The change is scoped to ",(0,l.jsx)(s.code,{children:"shell-web"})," and preserves existing progression and telemetry behaviour while enabling AI-led agents to update tests and implementation safely."]}),"\n",(0,l.jsx)(s.h2,{id:"2-context--problem-statement",children:"2. Context & Problem Statement"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Background"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"ShellStateProvider"})," wraps the runtime worker bridge and exposes Shell state, progression, diagnostics, and social APIs to the web shell UI.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Provider implementation: ",(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/ShellStateProvider.tsx"})," (e.g., readiness/restore effects at ",(0,l.jsx)(s.code,{children:":308"})," and ",(0,l.jsx)(s.code,{children:":448"}),")."]}),"\n",(0,l.jsxs)(s.li,{children:["Shell state reducer: ",(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/shell-state-store.ts:30"}),"\u2013",(0,l.jsx)(s.code,{children:":189"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["The provider already:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Awaits ",(0,l.jsx)(s.code,{children:"bridge.awaitReady()"})," and dispatches a ",(0,l.jsx)(s.code,{children:"bridge-ready"})," action (",(0,l.jsx)(s.code,{children:"ShellStateProvider.tsx:308"}),"\u2013",(0,l.jsx)(s.code,{children:":329"}),", ",(0,l.jsx)(s.code,{children:"shell-state-store.tsx:149"}),"\u2013",(0,l.jsx)(s.code,{children:":163"}),")."]}),"\n",(0,l.jsxs)(s.li,{children:["Orchestrates restore via ",(0,l.jsx)(s.code,{children:"bridge.awaitReady()"})," followed by ",(0,l.jsx)(s.code,{children:"restoreSession"}),", with telemetry on failure (",(0,l.jsx)(s.code,{children:"ShellStateProvider.tsx:448"}),"\u2013",(0,l.jsx)(s.code,{children:":486"}),")."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Prior to PR #396, tests for Shell state and telemetry defined local ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," helpers that relied on multiple microtask and macrotask hops before making assertions about progression APIs and telemetry events in the Shell environment:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/ShellStateProvider.test.tsx"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/ShellStateProvider.telemetry.test.tsx"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Those helpers have since been removed in favour of an explicit readiness helper and targeted ",(0,l.jsx)(s.code,{children:"waitFor"}),"-based assertions."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Problem"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Tests have no explicit, semantic contract for \u201cShell state is ready\u201d; they instead depend on:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Two ",(0,l.jsx)(s.code,{children:"await Promise.resolve()"})," calls plus ",(0,l.jsx)(s.code,{children:"setTimeout(0)"})," to flush effects and timers."]}),"\n",(0,l.jsx)(s.li,{children:"Implicit coupling to the timing of React effects and the worker bridge\u2019s internal scheduling."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["This leads to:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Fragile tests that may break when React\u2019s scheduling, bridge behaviour, or effect structure changes, even if user-facing behaviour is unchanged."}),"\n",(0,l.jsxs)(s.li,{children:["Inability for AI agents to reason about the readiness boundary in a first-class way; they must treat ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," as a magic incantation."]}),"\n",(0,l.jsx)(s.li,{children:"No reusable or documented mechanism for other Shell tests to await readiness."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["The absence of a deterministic async boundary contradicts the goal of a deterministic, simulation-driven engine and makes it harder to reason about telemetry failures (e.g., ",(0,l.jsx)(s.code,{children:"ShellStateProviderAwaitReadyFailed"}),", ",(0,l.jsx)(s.code,{children:"ShellStateProviderRestoreEffectFailed"}),")."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Forces"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Determinism"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Test runs must remain deterministic and not rely on arbitrary timing delays."}),"\n",(0,l.jsx)(s.li,{children:"Readiness should be described in terms of state/contract, not discrete microtasks."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Compatibility"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["The current UI contract (e.g., loading behaviour based on ",(0,l.jsx)(s.code,{children:"bridge.isReady"})," and ",(0,l.jsx)(s.code,{children:"lastUpdateAt"}),") must be preserved:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"ResourceDashboard"}),": ",(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/ResourceDashboard.tsx:242"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"GeneratorPanel"}),": ",(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/GeneratorPanel.tsx:124"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"React & StrictMode"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"ShellStateProvider"})," is already written to be StrictMode-safe (e.g., ",(0,l.jsx)(s.code,{children:"lastAwaitedBridgeRef"}),", payload/bridge tracking)."]}),"\n",(0,l.jsx)(s.li,{children:"Any new readiness handling must avoid double-dispatch bugs and work under StrictMode double-mount."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Scope & Velocity"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["The primary initiative is to support GitHub issue #394: deterministic Shell state readiness and removal of ",(0,l.jsx)(s.code,{children:"flushMicrotasks"}),"."]}),"\n",(0,l.jsx)(s.li,{children:"The design should be implementable by AI-led agents with minimal human intervention and clear guardrails."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"3-goals--non-goals",children:"3. Goals & Non-Goals"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Goals"})}),"\n",(0,l.jsxs)(s.ol,{children:["\n",(0,l.jsxs)(s.li,{children:["Define a clear, documented readiness contract for ",(0,l.jsx)(s.code,{children:"ShellStateProvider"})," initialisation (\u201cShell state readiness contract for ShellStateProvider\u201d)."]}),"\n",(0,l.jsx)(s.li,{children:"Provide a deterministic, awaitable test helper (or helpers) that encode this contract without reliance on microtask/macrotask flushing."}),"\n",(0,l.jsxs)(s.li,{children:["Migrate ",(0,l.jsx)(s.code,{children:"ShellStateProvider"})," and telemetry tests to the new contract, fully removing inline ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," helpers."]}),"\n",(0,l.jsxs)(s.li,{children:["Maintain existing Shell progression and telemetry behaviour, including error telemetry for ",(0,l.jsx)(s.code,{children:"awaitReady"})," and restore failures."]}),"\n",(0,l.jsx)(s.li,{children:"Enable AI-led agents to safely extend the readiness contract to new tests or Shell surfaces using consistent patterns."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Non-Goals"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Redesign the underlying worker bridge protocol or ",(0,l.jsx)(s.code,{children:"@idle-engine/core"})," runtime."]}),"\n",(0,l.jsxs)(s.li,{children:["Change production loading UX, including how ",(0,l.jsx)(s.code,{children:"ResourceDashboard"})," and ",(0,l.jsx)(s.code,{children:"GeneratorPanel"})," compute ",(0,l.jsx)(s.code,{children:"isLoading"}),"."]}),"\n",(0,l.jsx)(s.li,{children:"Generalise readiness semantics to all subsystems (e.g., social backend, content loading) beyond what is necessary for Shell state initialisation and telemetry."}),"\n",(0,l.jsxs)(s.li,{children:["Introduce cross-package synchronization primitives outside ",(0,l.jsx)(s.code,{children:"shell-web"})," for this initiative."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"4-stakeholders-agents--impacted-surfaces",children:"4. Stakeholders, Agents & Impacted Surfaces"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Primary Stakeholders"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Shell Web maintainers (owners of ",(0,l.jsx)(s.code,{children:"packages/shell-web"}),")."]}),"\n",(0,l.jsxs)(s.li,{children:["Runtime/Bridge maintainers (owners of ",(0,l.jsx)(s.code,{children:"worker-bridge"})," integration)."]}),"\n",(0,l.jsxs)(s.li,{children:["Testing & CI maintainers (owners of ",(0,l.jsx)(s.code,{children:"@idle-engine/config-vitest"})," and test flakiness triage)."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Agent Roles"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Design-Authoring Agent (this document)"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Produces and maintains this design document."}),"\n",(0,l.jsx)(s.li,{children:"Ensures alignment with existing code and testing patterns."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Shell-Web Implementation Agent"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Implements readiness helpers and any necessary provider changes in ",(0,l.jsx)(s.code,{children:"packages/shell-web"}),"."]}),"\n",(0,l.jsx)(s.li,{children:"Refactors tests to the new pattern."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Test & Tooling Agent"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Validates test stability post-change."}),"\n",(0,l.jsx)(s.li,{children:"Adjusts any shared test utilities or Vitest configuration if needed."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Review & Governance Agent"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Monitors adherence to agent guardrails and coding standards."}),"\n",(0,l.jsxs)(s.li,{children:["Ensures changes are linked to ",(0,l.jsx)(s.code,{children:"Fixes #394"})," and documented."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Affected Packages/Services"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"src/modules/ShellStateProvider.tsx:308"}),"\u2013",(0,l.jsx)(s.code,{children:":339"}),", ",(0,l.jsx)(s.code,{children:":448"}),"\u2013",(0,l.jsx)(s.code,{children:":486"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"src/modules/shell-state-store.ts:30"}),"\u2013",(0,l.jsx)(s.code,{children:":189"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"src/modules/ShellStateProvider.test.tsx:80"}),"\u2013",(0,l.jsx)(s.code,{children:":220"}),", ",(0,l.jsx)(s.code,{children:":364"}),"\u2013",(0,l.jsx)(s.code,{children:":399"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"src/modules/ShellStateProvider.telemetry.test.tsx:575"}),"\u2013",(0,l.jsx)(s.code,{children:":638"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["No direct changes expected in ",(0,l.jsx)(s.code,{children:"packages/core"})," or backend services for this initiative."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Compatibility Considerations"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["The readiness contract should:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Be backwards compatible in production: UI components should continue to rely on ",(0,l.jsx)(s.code,{children:"bridge.isReady"})," and ",(0,l.jsx)(s.code,{children:"lastUpdateAt"})," semantics."]}),"\n",(0,l.jsxs)(s.li,{children:["Avoid breaking ",(0,l.jsx)(s.code,{children:"ShellBridgeApi"})," consumers (e.g., ",(0,l.jsx)(s.code,{children:"useShellBridge"})," usage patterns)."]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.li,{children:"Any new test-only exports must not be inadvertently used in production code."}),"\n",(0,l.jsxs)(s.li,{children:["The contract should be robust to future changes in ",(0,l.jsx)(s.code,{children:"ShellStateProvider"})," internals (e.g., additional effects)."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"5-current-state",children:"5. Current State"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Provider & State"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"ShellStateProvider"}),":","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Creates Shell state via ",(0,l.jsx)(s.code,{children:"createInitialShellState"})," and ",(0,l.jsx)(s.code,{children:"createShellStateReducer"})," (",(0,l.jsx)(s.code,{children:"ShellStateProvider.tsx:40"}),"\u2013",(0,l.jsx)(s.code,{children:":55"}),", ",(0,l.jsx)(s.code,{children:"shell-state-store.ts:64"}),"\u2013",(0,l.jsx)(s.code,{children:":96"}),")."]}),"\n",(0,l.jsxs)(s.li,{children:["Tracks bridge readiness via a ",(0,l.jsx)(s.code,{children:"useEffect"})," that calls ",(0,l.jsx)(s.code,{children:"bridge.awaitReady()"})," and dispatches a ",(0,l.jsx)(s.code,{children:"bridge-ready"})," action (",(0,l.jsx)(s.code,{children:"ShellStateProvider.tsx:308"}),"\u2013",(0,l.jsx)(s.code,{children:":329"}),")."]}),"\n",(0,l.jsxs)(s.li,{children:["Orchestrates restore when ",(0,l.jsx)(s.code,{children:"restorePayload"})," or the bridge changes:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Awaits ",(0,l.jsx)(s.code,{children:"bridge.awaitReady()"})," and then ",(0,l.jsx)(s.code,{children:"restoreSession(restorePayload)"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:["Emits telemetry on failure: ",(0,l.jsx)(s.code,{children:"ShellStateProviderRestoreEffectFailed"})," (",(0,l.jsx)(s.code,{children:"ShellStateProvider.tsx:448"}),"\u2013",(0,l.jsx)(s.code,{children:":486"}),")."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"ShellState"}),":","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Includes ",(0,l.jsx)(s.code,{children:"bridge.isReady"}),", ",(0,l.jsx)(s.code,{children:"bridge.isRestoring"}),", and ",(0,l.jsx)(s.code,{children:"runtime.lastSnapshot"})," (",(0,l.jsx)(s.code,{children:"shell-state-store.ts:103"}),"\u2013",(0,l.jsx)(s.code,{children:":131"}),")."]}),"\n",(0,l.jsxs)(s.li,{children:["Sets ",(0,l.jsx)(s.code,{children:"isReady: true"})," on ",(0,l.jsx)(s.code,{children:"bridge-ready"})," (",(0,l.jsx)(s.code,{children:"shell-state-store.ts:149"}),"\u2013",(0,l.jsx)(s.code,{children:":163"}),")."]}),"\n",(0,l.jsxs)(s.li,{children:["Uses ",(0,l.jsx)(s.code,{children:"restore-started"}),"/",(0,l.jsx)(s.code,{children:"restore-complete"})," to track restore status (",(0,l.jsx)(s.code,{children:"shell-state-store.ts:177"}),"\u2013",(0,l.jsx)(s.code,{children:":201"}),")."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"UI Consumption"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"ResourceDashboard"})," and ",(0,l.jsx)(s.code,{children:"GeneratorPanel"})," derive loading state from Shell bridge state:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"isLoading = !bridge.isReady || bridge.lastUpdateAt === null"})," (",(0,l.jsx)(s.code,{children:"ResourceDashboard.tsx:242"}),", ",(0,l.jsx)(s.code,{children:"GeneratorPanel.tsx:124"}),")."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["This implies an implicit contract: the Shell is \u201cready\u201d for UI when ",(0,l.jsx)(s.code,{children:"bridge.isReady === true"})," and at least one state update has occurred (",(0,l.jsx)(s.code,{children:"lastUpdateAt !== null"}),"), though tests currently do not wait on this combination semantically."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Test Behaviour"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"ShellStateProvider.test.tsx"}),":","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Defines an inline ",(0,l.jsx)(s.code,{children:"async function flushMicrotasks()"})," that awaits two microtasks plus a ",(0,l.jsx)(s.code,{children:"setTimeout(0)"})," before assertions (",(0,l.jsx)(s.code,{children:"ShellStateProvider.test.tsx:80"}),"\u2013",(0,l.jsx)(s.code,{children:":99"}),")."]}),"\n",(0,l.jsxs)(s.li,{children:["Uses ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," across multiple test cases to wait for:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"useShellProgression"})," to return a non-null API."]}),"\n",(0,l.jsx)(s.li,{children:"Restore effects to fire when bridge or payload changes."}),"\n",(0,l.jsxs)(s.li,{children:["State update handlers to be registered (",(0,l.jsx)(s.code,{children:"ShellStateProvider.test.tsx:191"}),"\u2013",(0,l.jsx)(s.code,{children:":200"}),")."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"ShellStateProvider.telemetry.test.tsx"}),":","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Defines a similar ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," helper (",(0,l.jsx)(s.code,{children:"ShellStateProvider.telemetry.test.tsx:587"}),"\u2013",(0,l.jsx)(s.code,{children:":593"}),")."]}),"\n",(0,l.jsxs)(s.li,{children:["Relies on it to:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Allow restore effects to fail and be reported via telemetry (",(0,l.jsx)(s.code,{children:"ShellStateProvider.telemetry.test.tsx:192"}),"\u2013",(0,l.jsx)(s.code,{children:":212"}),")."]}),"\n",(0,l.jsxs)(s.li,{children:["Allow ",(0,l.jsx)(s.code,{children:"awaitReady"})," failures to be reported (",(0,l.jsx)(s.code,{children:"ShellStateProvider.telemetry.test.tsx:208"}),"\u2013",(0,l.jsx)(s.code,{children:":216"}),")."]}),"\n",(0,l.jsx)(s.li,{children:"Ensure bridge error handling and telemetry are wired before unmount."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Gaps"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"No explicit \u201cShell state readiness contract for ShellStateProvider\u201d is defined in code or docs."}),"\n",(0,l.jsxs)(s.li,{children:["Tests depend on the incidental timing of React effects and worker bridge behaviour via ",(0,l.jsx)(s.code,{children:"flushMicrotasks"}),"."]}),"\n",(0,l.jsx)(s.li,{children:"There is no reusable or documented helper for other tests to await readiness; each suite reimplements a microtask flusher."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"6-proposed-solution",children:"6. Proposed Solution"}),"\n",(0,l.jsx)(s.h3,{id:"61-architecture-overview",children:"6.1 Architecture Overview"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Narrative"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Define a formal readiness contract for ",(0,l.jsx)(s.code,{children:"ShellStateProvider"})," based on Shell state:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Shell is considered ",(0,l.jsx)(s.em,{children:"ready"})," when:","\n",(0,l.jsxs)(s.ol,{children:["\n",(0,l.jsxs)(s.li,{children:["The worker bridge has reported readiness (",(0,l.jsx)(s.code,{children:"bridge.isReady === true"}),")."]}),"\n",(0,l.jsxs)(s.li,{children:["The provider is not currently restoring (",(0,l.jsx)(s.code,{children:"bridge.isRestoring === false"}),")."]}),"\n",(0,l.jsxs)(s.li,{children:["At least one runtime snapshot has been processed and recorded:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.code,{children:"bridge.lastUpdateAt !== null"})}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.code,{children:"runtime.lastSnapshot !== undefined"})}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.code,{children:"state.runtime.progression.snapshot !== null"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Expose this contract in two ways:","\n",(0,l.jsxs)(s.ol,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"State-Level Contract"}),": Document these invariants as the official readiness definition, accessible via ",(0,l.jsx)(s.code,{children:"useShellState"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Test-Level Helper"}),": Introduce a dedicated test helper ",(0,l.jsx)(s.code,{children:"awaitShellStateReady"})," in ",(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/__tests__/shell-state-ready.ts"})," (or similar test-only module) that:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Consumes ",(0,l.jsx)(s.code,{children:"useShellState"})," (or a provided getter) and ",(0,l.jsx)(s.code,{children:"waitFor"})," from ",(0,l.jsx)(s.code,{children:"@testing-library/react"}),"."]}),"\n",(0,l.jsx)(s.li,{children:"Awaits the readiness condition above with a bounded timeout."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Update ",(0,l.jsx)(s.code,{children:"ShellStateProvider"})," tests to:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Replace ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," with ",(0,l.jsx)(s.code,{children:"awaitShellStateReady"}),"."]}),"\n",(0,l.jsx)(s.li,{children:"Use the helper wherever they currently \u201cwait for things to settle\u201d."}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.li,{children:"Keep production API and UI semantics unchanged while providing agents and developers a clear readiness boundary."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Diagram (conceptual)"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Initialisation flow"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"ShellStateProvider"})," mount\n\u2192 ",(0,l.jsx)(s.code,{children:"useWorkerBridge"})," obtains ",(0,l.jsx)(s.code,{children:"bridge"}),"\n\u2192 Effect A: ",(0,l.jsx)(s.code,{children:"bridge.awaitReady()"})," \u2192 dispatch ",(0,l.jsx)(s.code,{children:"bridge-ready"}),"\n\u2192 Effect B: ",(0,l.jsx)(s.code,{children:"bridge.awaitReady()"})," \u2192 ",(0,l.jsx)(s.code,{children:"restoreSession(restorePayload)"})," (if configured)\n\u2192 Effects: state update listeners, diagnostics, error listeners\n\u2192 ",(0,l.jsx)(s.code,{children:"ShellState"})," transitions to:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.code,{children:"bridge.isReady === true"})}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.code,{children:"bridge.isRestoring === false"})}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.code,{children:"bridge.lastUpdateAt !== null"})}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"runtime.lastSnapshot !== undefined"})," (after first snapshot)"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"state.runtime.progression.snapshot !== null"})," (first progression snapshot)\n\u2192 ",(0,l.jsx)(s.code,{children:"awaitShellStateReady"})," resolves."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h3,{id:"62-detailed-design",children:"6.2 Detailed Design"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Runtime Changes"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["No changes to the underlying worker runtime or ",(0,l.jsx)(s.code,{children:"@idle-engine/core"}),"."]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Minimal internal changes to ",(0,l.jsx)(s.code,{children:"ShellStateProvider"}),":"]}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Ensure that:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"bridge-ready"})," is always dispatched after ",(0,l.jsx)(s.code,{children:"bridge.awaitReady()"})," resolves."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"restore-started"})," and ",(0,l.jsx)(s.code,{children:"restore-complete"})," correctly bracket restore operations."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Confirm invariants:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["After a successful ",(0,l.jsx)(s.code,{children:"restoreSession"})," in the restore effect, ",(0,l.jsx)(s.code,{children:"bridge.isRestoring"})," is ",(0,l.jsx)(s.code,{children:"false"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:["On a best-effort basis, at least one ",(0,l.jsx)(s.code,{children:"state-update"})," has been dispatched following readiness (existing behaviour should already satisfy this)."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Optionally, small internal refactoring to make readiness criteria easier to read for future maintainers (e.g., a derived boolean used only within tests and documentation)."}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Data & Schemas"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"No changes to runtime data schemas or worker messages."}),"\n",(0,l.jsxs)(s.li,{children:["Clarify semantics of existing state fields:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"ShellBridgeState.isReady"}),": \u201c",(0,l.jsx)(s.code,{children:"bridge.awaitReady()"})," has successfully completed at least once for the current bridge instance.\u201d"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"ShellBridgeState.isRestoring"}),": \u201cA restore operation started by the provider is currently in-flight.\u201d"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"ShellRuntimeState.lastSnapshot"}),": \u201cThe latest runtime snapshot received; omitted / ",(0,l.jsx)(s.code,{children:"undefined"})," indicates no snapshot has been processed yet (type ",(0,l.jsx)(s.code,{children:"RuntimeStateSnapshot | undefined"}),").\u201d"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"APIs & Contracts"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Readiness Contract (logical)"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Define ",(0,l.jsx)(s.code,{children:"ShellStateProvider"})," readiness as the following predicate evaluated over ",(0,l.jsx)(s.code,{children:"ShellState"}),":","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.code,{children:"bridge.isReady === true"})}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.code,{children:"bridge.isRestoring === false"})}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.code,{children:"bridge.lastUpdateAt !== null"})}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.code,{children:"runtime.lastSnapshot !== undefined"})}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.code,{children:"state.runtime.progression.snapshot !== null"})}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["This contract is:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["The canonical definition used by ",(0,l.jsx)(s.code,{children:"awaitShellStateReady"}),"."]}),"\n",(0,l.jsx)(s.li,{children:"A documented expectation for future tests that need a ready Shell."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Test Helper API"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsxs)(s.p,{children:["Implement a test-only helper module at ",(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/__tests__/shell-state-ready.ts"}),", exporting:"]}),"\n",(0,l.jsx)(s.pre,{children:(0,l.jsx)(s.code,{className:"language-ts",children:"export interface ShellReadyOptions {\n  readonly timeoutMs?: number;\n}\n\nexport async function awaitShellStateReady(\n  getShellState: () => ShellState,\n  options?: ShellReadyOptions,\n): Promise<void>;\n"})}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Implementation sketch:"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Uses ",(0,l.jsx)(s.code,{children:"waitFor"})," from ",(0,l.jsx)(s.code,{children:"@testing-library/react"})," with a default timeout (e.g. 1\u20132 seconds) to poll ",(0,l.jsx)(s.code,{children:"getShellState()"})," until the readiness predicate holds."]}),"\n",(0,l.jsx)(s.li,{children:"Throws a descriptive error if the timeout elapses, including partial state for debugging."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:"Usage patterns:"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["For ",(0,l.jsx)(s.code,{children:"renderHook"})," tests:","\n",(0,l.jsx)(s.pre,{children:(0,l.jsx)(s.code,{className:"language-ts",children:"const { result } = renderHook(() => useShellState(), { wrapper });\nawait awaitShellStateReady(() => result.current);\n"})}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["For integration tests using container probes:","\n",(0,l.jsx)(s.pre,{children:(0,l.jsx)(s.code,{className:"language-ts",children:"const shellStateRef = { current: null as ShellState | null };\n// Probe component sets shellStateRef.current from context\nawait awaitShellStateReady(() => {\n  if (!shellStateRef.current) throw new Error('Shell state not yet attached');\n  return shellStateRef.current;\n});\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Test Refactoring"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"ShellStateProvider.test.tsx"}),":","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Remove the inline ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," helper."]}),"\n",(0,l.jsxs)(s.li,{children:["Introduce a focused \u201creadiness helper\u201d test that uses ",(0,l.jsx)(s.code,{children:"awaitShellStateReady"})," together with a mocked ",(0,l.jsx)(s.code,{children:"state-update"})," to verify the readiness predicate over ",(0,l.jsx)(s.code,{children:"ShellState"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:["For other cases, where tests rely on specific observable effects rather than full readiness (e.g. progression selector shapes, diagnostics toggling), use ",(0,l.jsx)(s.code,{children:"waitFor"})," with local predicates."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"ShellStateProvider.telemetry.test.tsx"}),":","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Remove its local ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," helper."]}),"\n",(0,l.jsxs)(s.li,{children:["Use ",(0,l.jsx)(s.code,{children:"waitFor"})," to observe telemetry calls in response to restore and ",(0,l.jsx)(s.code,{children:"awaitReady"})," failures, and to diagnostics enable/disable behaviour."]}),"\n",(0,l.jsxs)(s.li,{children:["For diagnostics unsubscribe cleanup, rely on fake timers plus ",(0,l.jsx)(s.code,{children:"vi.runAllTimers()"})," wrapped in ",(0,l.jsx)(s.code,{children:"act"})," to flush the provider\u2019s deferred reconciliation without introducing new timing helpers."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Tooling & Automation"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Maintain Vitest-based tests; no new frameworks introduced."}),"\n",(0,l.jsx)(s.li,{children:"Update any existing shared test utilities that may benefit from the readiness helper (optional but recommended)."}),"\n",(0,l.jsxs)(s.li,{children:["Ensure the helper module is not imported into production bundles:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Place it under a ",(0,l.jsx)(s.code,{children:"__tests__"})," or clearly test-only path."]}),"\n",(0,l.jsxs)(s.li,{children:["Avoid exporting it from main ",(0,l.jsx)(s.code,{children:"modules/index.ts"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h3,{id:"63-operational-considerations",children:"6.3 Operational Considerations"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Deployment"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"No special deployment changes; this is a test-focused improvement with minor provider internals clarification."}),"\n",(0,l.jsxs)(s.li,{children:["Merged as part of regular ",(0,l.jsx)(s.code,{children:"shell-web"})," changes, gated by CI:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.code,{children:"pnpm test --filter shell-web"})}),"\n",(0,l.jsx)(s.li,{children:(0,l.jsx)(s.code,{children:"pnpm lint --filter shell-web"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Telemetry & Observability"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Maintain existing telemetry events:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"ShellStateProviderAwaitReadyFailed"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"ShellStateProviderRestoreEffectFailed"}),"."]}),"\n",(0,l.jsx)(s.li,{children:"Social and diagnostics-related telemetry."}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.li,{children:"Optionally log additional context in tests when readiness fails to be reached within timeout, but avoid production logging changes."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Security & Compliance"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"No changes to PII handling or permissions."}),"\n",(0,l.jsx)(s.li,{children:"Test helper must not expose additional secrets or environment details."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"7-work-breakdown--delivery-plan",children:"7. Work Breakdown & Delivery Plan"}),"\n",(0,l.jsx)(s.h3,{id:"71-issue-map",children:"7.1 Issue Map"}),"\n",(0,l.jsx)(s.p,{children:"Populate the table as the canonical source for downstream GitHub issues."}),"\n",(0,l.jsxs)(s.table,{children:[(0,l.jsx)(s.thead,{children:(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.th,{children:"Issue Title"}),(0,l.jsx)(s.th,{children:"Scope Summary"}),(0,l.jsx)(s.th,{children:"Proposed Assignee/Agent"}),(0,l.jsx)(s.th,{children:"Dependencies"}),(0,l.jsx)(s.th,{children:"Acceptance Criteria"})]})}),(0,l.jsxs)(s.tbody,{children:[(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"feat(shell-web): define ShellStateProvider readiness contract"}),(0,l.jsxs)(s.td,{children:["Document and validate the logical readiness predicate over ",(0,l.jsx)(s.code,{children:"ShellState"})," and ensure provider effects maintain it"]}),(0,l.jsx)(s.td,{children:"Shell-Web Implementation Agent"}),(0,l.jsx)(s.td,{children:"This design approved"}),(0,l.jsx)(s.td,{children:"Predicate is captured in code comments and/or docstrings; unit tests assert readiness invariants via reducer/state tests"})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"test(shell-web): add awaitShellStateReady helper"}),(0,l.jsxs)(s.td,{children:["Implement ",(0,l.jsx)(s.code,{children:"awaitShellStateReady"})," test helper and initial unit tests for the helper"]}),(0,l.jsx)(s.td,{children:"Test & Tooling Agent"}),(0,l.jsx)(s.td,{children:"Readiness predicate defined"}),(0,l.jsxs)(s.td,{children:["Helper module exists under ",(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/__tests__/"}),"; tests pass; helper is not exported into production bundles"]})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"test(shell-web): migrate ShellStateProvider tests off flushMicrotasks"}),(0,l.jsxs)(s.td,{children:["Refactor ",(0,l.jsx)(s.code,{children:"ShellStateProvider.test.tsx"})," to use readiness helper and targeted ",(0,l.jsx)(s.code,{children:"waitFor"})," instead of ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})]}),(0,l.jsx)(s.td,{children:"Shell-Web Implementation Agent"}),(0,l.jsx)(s.td,{children:"Helper implemented"}),(0,l.jsxs)(s.td,{children:["No ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," function remains in ",(0,l.jsx)(s.code,{children:"ShellStateProvider.test.tsx"}),"; tests pass and remain deterministic"]})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"test(shell-web): migrate ShellStateProvider telemetry tests off flushMicrotasks"}),(0,l.jsx)(s.td,{children:"Refactor telemetry tests to await readiness and specific telemetry events without microtask flushing"}),(0,l.jsx)(s.td,{children:"Shell-Web Implementation Agent"}),(0,l.jsx)(s.td,{children:"Helper implemented"}),(0,l.jsxs)(s.td,{children:["No ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," function remains in ",(0,l.jsx)(s.code,{children:"ShellStateProvider.telemetry.test.tsx"}),"; telemetry assertions are stable"]})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"chore(shell-web): remove legacy microtask helpers & document readiness"}),(0,l.jsx)(s.td,{children:"Remove any remaining microtask-based helpers in Shell state tests; add a short section to docs or test README summarising the readiness contract"}),(0,l.jsx)(s.td,{children:"Shell-Web Implementation Agent"}),(0,l.jsx)(s.td,{children:"All migrations completed"}),(0,l.jsxs)(s.td,{children:[(0,l.jsx)(s.code,{children:"flushMicrotasks"})," no longer appears in the repo; docs/tests reference the readiness helper and contract; CI is green"]})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"meta: drive Fixes #394 PR"}),(0,l.jsxs)(s.td,{children:["Integrate all work on a dedicated branch, run tests, and open a PR referencing ",(0,l.jsx)(s.code,{children:"Fixes #394"})]}),(0,l.jsx)(s.td,{children:"Review & Governance Agent"}),(0,l.jsx)(s.td,{children:"All above issues closed"}),(0,l.jsxs)(s.td,{children:["PR merged with message and description including ",(0,l.jsx)(s.code,{children:"Fixes #394"}),"; GitHub issue auto-closes"]})]})]})]}),"\n",(0,l.jsx)(s.h3,{id:"72-milestones",children:"7.2 Milestones"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Phase 1: Contract & Helper (1\u20132 days)"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Finalise readiness predicate in code comments."}),"\n",(0,l.jsxs)(s.li,{children:["Implement ",(0,l.jsx)(s.code,{children:"awaitShellStateReady"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:["Add unit tests for the helper using simple mocked ",(0,l.jsx)(s.code,{children:"ShellState"})," transitions."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Phase 2: Test Migration (1\u20132 days)"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Refactor ",(0,l.jsx)(s.code,{children:"ShellStateProvider.test.tsx"})," and telemetry tests to the new helper."]}),"\n",(0,l.jsxs)(s.li,{children:["Remove ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," definitions."]}),"\n",(0,l.jsx)(s.li,{children:"Validate tests locally and in CI."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Phase 3: Documentation & Cleanup (\u22641 day)"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Add short documentation snippet (either within test files or a ",(0,l.jsx)(s.code,{children:"docs/"})," note) describing the readiness contract."]}),"\n",(0,l.jsxs)(s.li,{children:["Confirm no other tests rely on ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," or similar patterns."]}),"\n",(0,l.jsxs)(s.li,{children:["Land PR with ",(0,l.jsx)(s.code,{children:"Fixes #394"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h3,{id:"73-coordination-notes",children:"7.3 Coordination Notes"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Hand-off Package"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"This design document."}),"\n",(0,l.jsxs)(s.li,{children:["Relevant source files:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/ShellStateProvider.tsx"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/shell-state-store.ts"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/ShellStateProvider.test.tsx"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/ShellStateProvider.telemetry.test.tsx"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Commands:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"pnpm test --filter shell-web"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"pnpm lint --filter shell-web"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Communication Cadence"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Agents should:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Update the GitHub issue #394 with progress notes per phase."}),"\n",(0,l.jsx)(s.li,{children:"Request human review once tests are migrated and passing."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Escalation path:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Shell Web maintainer for design ambiguities."}),"\n",(0,l.jsxs)(s.li,{children:["Runtime/Bridge maintainer for questions about ",(0,l.jsx)(s.code,{children:"awaitReady"})," guarantees."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"8-agent-guidance--guardrails",children:"8. Agent Guidance & Guardrails"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Context Packets"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Agents must load:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"This design document."}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/ShellStateProvider.tsx"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/shell-state-store.ts"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/ShellStateProvider.test.tsx"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/ShellStateProvider.telemetry.test.tsx"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Environment assumptions:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Node \u2265 20.10."}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"pnpm"})," \u2265 8."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"pnpm install"})," has been run at repo root."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Prompting & Constraints"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Agents should follow:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Repository coding conventions in ",(0,l.jsx)(s.code,{children:"AGENTS.md"})," and ",(0,l.jsx)(s.code,{children:"eslint.config.mjs"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:["TypeScript style guidelines:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Use ",(0,l.jsx)(s.code,{children:"import type { ... }"})," for type-only imports."]}),"\n",(0,l.jsx)(s.li,{children:"Co-locate test helpers with tests when appropriate."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Commit/PR conventions:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Use Conventional Commits; final PR must include ",(0,l.jsx)(s.code,{children:"Fixes #394"})," in description."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Example agent prompt snippet:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\u201cUpdate ",(0,l.jsx)(s.code,{children:"ShellStateProvider"})," tests to replace the ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," helper with the ",(0,l.jsx)(s.code,{children:"awaitShellStateReady"})," helper, using the readiness contract defined in ",(0,l.jsx)(s.code,{children:"docs/deterministic-shell-state-readiness.md"})," (or this design). Ensure tests remain deterministic and do not rely on ",(0,l.jsx)(s.code,{children:"setTimeout(0)"}),".\u201d"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Safety Rails"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Forbidden actions:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Do not modify ",(0,l.jsx)(s.code,{children:"dist/"})," outputs."]}),"\n",(0,l.jsxs)(s.li,{children:["Do not change core runtime semantics in ",(0,l.jsx)(s.code,{children:"packages/core"})," as part of this initiative."]}),"\n",(0,l.jsx)(s.li,{children:"Do not disable or bypass tests; fix them."}),"\n",(0,l.jsxs)(s.li,{children:["Do not introduce arbitrary sleeps (",(0,l.jsx)(s.code,{children:"setTimeout"}),"-based waits) in tests."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Rollback procedures:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["If readiness helper introduces new flakiness:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Revert the helper and test changes in a dedicated revert commit."}),"\n",(0,l.jsx)(s.li,{children:"File a follow-up issue documenting observed failures and logs."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Validation Hooks"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Before marking tasks complete, agents must run:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"pnpm test --filter shell-web"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"pnpm lint --filter shell-web"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Optionally:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"pnpm test:a11y"})," when Shell UI flows are affected (should not be necessary for this test-focused change but can be run as a safety check)."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"9-alternatives-considered",children:"9. Alternatives Considered"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsxs)(s.strong,{children:["Alternative A: Extend ShellBridgeApi with a public ",(0,l.jsx)(s.code,{children:"ready"})," Promise"]})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Description:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Add a ",(0,l.jsx)(s.code,{children:"ready: Promise<void>"})," property to ",(0,l.jsx)(s.code,{children:"ShellBridgeApi"}),", backed by ",(0,l.jsx)(s.code,{children:"bridge.awaitReady()"}),", and have tests await ",(0,l.jsx)(s.code,{children:"useShellBridge().ready"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Pros:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Simple consumption from tests and potentially application code."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Cons:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Introduces new public API with ambiguous semantics relative to ",(0,l.jsx)(s.code,{children:"awaitReady()"}),"."]}),"\n",(0,l.jsx)(s.li,{children:"Does not directly capture restore completion or initial snapshot availability."}),"\n",(0,l.jsx)(s.li,{children:"Risks encouraging production code to block on readiness in ways that might hurt UX."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Reason rejected:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"The problem is primarily test-facing; adding a production API is unnecessary scope."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Alternative B: Deterministic \u201ctick\u201d API in the runtime"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Description:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Add a \u201ctick\u201d or \u201cdrain\u201d API to the worker/runtime, allowing tests to advance the simulation deterministically."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Pros:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Strong deterministic semantics across many subsystems."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Cons:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Requires changes to ",(0,l.jsx)(s.code,{children:"@idle-engine/core"})," and worker protocols."]}),"\n",(0,l.jsxs)(s.li,{children:["Overkill for the narrow goal of Shell state readiness in ",(0,l.jsx)(s.code,{children:"shell-web"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Reason rejected:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Too large and cross-cutting for issue #394; may be revisited for broader deterministic testing."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsxs)(s.strong,{children:["Alternative C: Keep ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," but share it as a utility"]})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Description:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Refactor the existing microtask-based helper into a shared test util and document it."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Pros:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Minimal code changes."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Cons:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Retains brittle reliance on event-loop details."}),"\n",(0,l.jsx)(s.li,{children:"Fails to provide a semantic readiness contract."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Reason rejected:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Does not meet the acceptance criteria of deterministic, contract-based readiness."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"10-testing--validation-plan",children:"10. Testing & Validation Plan"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Unit / Integration"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Add tests for readiness helper:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Simulate ",(0,l.jsx)(s.code,{children:"ShellState"})," transitions and assert that ",(0,l.jsx)(s.code,{children:"awaitShellStateReady"})," resolves when the predicate is satisfied and times out otherwise."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Update and re-run:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"ShellStateProvider.test.tsx"}),":","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Verify all existing scenarios (progression API, restore behaviour, error handling) using the new helper."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"ShellStateProvider.telemetry.test.tsx"}),":","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Ensure telemetry events (",(0,l.jsx)(s.code,{children:"RestoreEffectFailed"}),", ",(0,l.jsx)(s.code,{children:"AwaitReadyFailed"}),", social failures) still fire as expected."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Use Vitest filters for targeted runs:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"pnpm test --filter shell-web -- ShellStateProvider"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"pnpm test --filter shell-web -- ShellStateProvider.telemetry"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Performance"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["No explicit performance benchmarks required; however:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Ensure readiness helper timeout is reasonable and does not materially slow tests."}),"\n",(0,l.jsx)(s.li,{children:"Monitor test duration regressions in CI runs."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Tooling / A11y"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"No direct impact on Playwright or accessibility tests."}),"\n",(0,l.jsxs)(s.li,{children:["Optionally run:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"pnpm test:a11y"})," after changes to guard against unexpected UI regressions from provider tweaks."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"11-risks--mitigations",children:"11. Risks & Mitigations"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Risk 1: Mis-specified readiness predicate"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Impact:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Tests may hang or fail if readiness is never reached, or assert too early if predicate is too weak."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Mitigations:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Derive predicate from existing UI semantics (",(0,l.jsx)(s.code,{children:"isLoading"})," usage)."]}),"\n",(0,l.jsxs)(s.li,{children:["Add focused tests that assert the relationship between ",(0,l.jsx)(s.code,{children:"bridge-ready"}),", ",(0,l.jsx)(s.code,{children:"restore"})," actions, and readiness."]}),"\n",(0,l.jsx)(s.li,{children:"Include state snapshots in error messages on timeout to aid debugging."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Risk 2: StrictMode interactions"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Impact:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Double-mount behaviour may cause multiple ",(0,l.jsx)(s.code,{children:"awaitReady"})," / restore sequences and subtle ordering issues."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Mitigations:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["The provider already guards against duplicate awaits (",(0,l.jsx)(s.code,{children:"lastAwaitedBridgeRef"}),", ",(0,l.jsx)(s.code,{children:"lastRestorePayloadRef"}),", ",(0,l.jsx)(s.code,{children:"lastRestoreBridgeRef"}),")."]}),"\n",(0,l.jsx)(s.li,{children:"Ensure readiness predicate does not depend on transient intermediate states and is idempotent."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsxs)(s.strong,{children:["Risk 3: Hidden consumers of ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})]})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Impact:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Other tests may implicitly rely on ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," or similar patterns; removal could cause regressions."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Mitigations:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Search the codebase (",(0,l.jsx)(s.code,{children:'rg "flushMicrotasks" -n'}),") before removal."]}),"\n",(0,l.jsx)(s.li,{children:"Migrate or explicitly document any remaining usage; if unavoidable, keep such usage narrowly scoped and justified."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Risk 4: Overfitting to current provider implementation"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Impact:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Future changes to ",(0,l.jsx)(s.code,{children:"ShellStateProvider"})," effects may unintentionally break the readiness helper."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Mitigations:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Keep readiness defined in terms of ",(0,l.jsx)(s.code,{children:"ShellState"}),", not internal effect order."]}),"\n",(0,l.jsx)(s.li,{children:"Revisit the helper and tests when provider internals change; update references accordingly."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"12-rollout-plan",children:"12. Rollout Plan"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Milestones"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"M1: Helper implemented and validated locally."}),"\n",(0,l.jsxs)(s.li,{children:["M2: ",(0,l.jsx)(s.code,{children:"ShellStateProvider"})," tests migrated and passing."]}),"\n",(0,l.jsxs)(s.li,{children:["M3: Telemetry tests migrated; ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," removed."]}),"\n",(0,l.jsxs)(s.li,{children:["M4: PR merged with ",(0,l.jsx)(s.code,{children:"Fixes #394"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Migration Strategy"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Implement helper and migrate tests within the same feature branch (",(0,l.jsx)(s.code,{children:"issue-394"}),")."]}),"\n",(0,l.jsxs)(s.li,{children:["Avoid partial migration where tests mix ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," and readiness helper in confusing ways."]}),"\n",(0,l.jsx)(s.li,{children:"Maintain backwards compatibility with runtime and UI by not changing public APIs."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["\n",(0,l.jsx)(s.p,{children:(0,l.jsx)(s.strong,{children:"Communication"})}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Document the readiness contract at the top of the helper module and in a brief comment in ",(0,l.jsx)(s.code,{children:"ShellStateProvider.test.tsx"}),"."]}),"\n",(0,l.jsx)(s.li,{children:"Mention the new pattern and helper in the PR description and link to this design document."}),"\n",(0,l.jsx)(s.li,{children:"If test flakiness is discovered, note it in the GitHub issue and consider a follow-up design for broader deterministic testing."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"13-open-questions",children:"13. Open Questions"}),"\n",(0,l.jsxs)(s.ol,{children:["\n",(0,l.jsxs)(s.li,{children:["Should the readiness helper be exported from a central ",(0,l.jsx)(s.code,{children:"test-utils"})," module (",(0,l.jsx)(s.code,{children:"packages/shell-web/src/test-utils.ts"}),") instead of a ",(0,l.jsx)(s.code,{children:"__tests__"}),"-local file to encourage reuse?","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Decision"}),": Keep the readiness helper out of the shared worker harness utilities and scope it to React-only test modules (e.g., ",(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/test-helpers.ts"})," or a ",(0,l.jsx)(s.code,{children:"modules/__tests__/shell-state-ready.ts"}),"-style helper)."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Rationale"}),": ",(0,l.jsx)(s.code,{children:"packages/shell-web/src/test-utils.ts"})," is imported by worker-centric suites such as ",(0,l.jsx)(s.code,{children:"packages/shell-web/src/runtime.worker.test.ts"})," and ",(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/session-persistence-integration.test.ts"}),", which deliberately avoid React or DOM-specific dependencies so they can run in the Node-based worker harness. Exporting a React Testing Library\u2013based readiness helper from that module would force those suites to pull in unnecessary DOM tooling and could break worker-only runs."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Owner"}),": Shell Web Maintainer \u2014 ",(0,l.jsx)(s.strong,{children:"CLOSED"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Do any other Shell tests (beyond ",(0,l.jsx)(s.code,{children:"ShellStateProvider*"}),") need to await the same readiness boundary?","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Decision"}),": The readiness helper only needs to replace the local ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," helpers in ",(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/ShellStateProvider.test.tsx"})," and ",(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/ShellStateProvider.telemetry.test.tsx"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Rationale"}),": A repository search shows that only these two suites currently rely on the implicit provider readiness boundary; other Shell UI tests either mock shell hooks or remain synchronous and do not need to await the provider. Keeping the helper\u2019s usage limited to these suites keeps the migration small and avoids touching unrelated tests."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Owner"}),": Test & Tooling Agent \u2014 ",(0,l.jsx)(s.strong,{children:"CLOSED"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Should we treat \u201cfirst snapshot received\u201d as mandatory for readiness, or is ",(0,l.jsx)(s.code,{children:"bridge.isReady && !isRestoring"})," sufficient?","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Decision"}),": Readiness is defined as the canonical predicate described in ",(0,l.jsx)(s.strong,{children:"Readiness Contract (logical)"}),": ",(0,l.jsx)(s.code,{children:"bridge.isReady === true"}),", ",(0,l.jsx)(s.code,{children:"bridge.isRestoring === false"}),", ",(0,l.jsx)(s.code,{children:"bridge.lastUpdateAt !== null"}),", ",(0,l.jsx)(s.code,{children:"state.runtime.lastSnapshot !== undefined"}),", and ",(0,l.jsx)(s.code,{children:"state.runtime.progression.snapshot !== null"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Rationale"}),": UI components such as ",(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/ResourceDashboard.tsx"})," and ",(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/GeneratorPanel.tsx"})," already treat readiness as \u201cbridge ready plus at least one snapshot,\u201d blocking on ",(0,l.jsx)(s.code,{children:"progression.select*()"})," returning data while gating their loading indicators on ",(0,l.jsx)(s.code,{children:"!bridge.isReady || bridge.lastUpdateAt === null"}),". Waiting for both ",(0,l.jsx)(s.code,{children:"lastSnapshot"})," to become defined and ",(0,l.jsx)(s.code,{children:"progression.snapshot"})," to become non-null keeps the helper aligned with real UI semantics and with the sentinel values used in ",(0,l.jsx)(s.code,{children:"shell-state-store.ts"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Owner"}),": Runtime/Bridge Maintainer \u2014 ",(0,l.jsx)(s.strong,{children:"CLOSED"}),"."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Is there value in exposing a limited, public ",(0,l.jsx)(s.code,{children:"useShellReady"})," hook for application code, or should readiness remain test-only for now?","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Decision"}),": Readiness remains a test-only concern; no public ",(0,l.jsx)(s.code,{children:"useShellReady"})," hook will be added at this stage."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Rationale"}),": Production components that care about readiness (e.g., ",(0,l.jsx)(s.code,{children:"ResourceDashboard"}),", ",(0,l.jsx)(s.code,{children:"GeneratorPanel"}),") already consume ",(0,l.jsx)(s.code,{children:"useShellState()"})," and check ",(0,l.jsx)(s.code,{children:"bridge.isReady"})," / ",(0,l.jsx)(s.code,{children:"bridge.lastUpdateAt"})," directly while handling ",(0,l.jsx)(s.code,{children:"progression"})," selectors that may be ",(0,l.jsx)(s.code,{children:"null"}),". Introducing a dedicated hook would expand the public API surface without current production consumers or clear benefit; it can be revisited when a concrete application use case emerges."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Owner"}),": Shell Web Maintainer \u2014 ",(0,l.jsx)(s.strong,{children:"CLOSED"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"14-follow-up-work",children:"14. Follow-Up Work"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:["Consider a broader deterministic testing strategy:","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsx)(s.li,{children:"Example: a general \u201csimulation tick\u201d helper for worker-driven components."}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Owner"}),": Runtime/Bridge Maintainer \u2014 ",(0,l.jsx)(s.strong,{children:"Timing"}),": Post-#394."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Audit other microtask-based test helpers across the monorepo and align them with similar contract-based patterns.","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Owner"}),": Test & Tooling Agent \u2014 ",(0,l.jsx)(s.strong,{children:"Timing"}),": After Shell readiness stabilises."]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(s.li,{children:["Evaluate whether readiness semantics should be shared with any backend or social features (e.g., ",(0,l.jsx)(s.code,{children:"services/social"}),").","\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Owner"}),": Social Service Maintainer \u2014 ",(0,l.jsx)(s.strong,{children:"Timing"}),": As needed."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"15-references",children:"15. References"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/ShellStateProvider.tsx:308"})," \u2014 Bridge readiness effect using ",(0,l.jsx)(s.code,{children:"awaitReady"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/ShellStateProvider.tsx:448"})," \u2014 Restore effect and telemetry on failure."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/shell-state-store.ts:103"})," \u2014 Initial Shell bridge state including ",(0,l.jsx)(s.code,{children:"isReady"})," and ",(0,l.jsx)(s.code,{children:"isRestoring"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/shell-state-store.ts:149"})," \u2014 Reducer handling ",(0,l.jsx)(s.code,{children:"bridge-ready"})," action."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/__tests__/shell-state-ready.ts:1"})," \u2014 Test-only ",(0,l.jsx)(s.code,{children:"awaitShellStateReady"})," helper implementing the readiness predicate."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/ShellStateProvider.test.tsx:264"})," \u2014 Readiness helper integration test exercising the contract over ",(0,l.jsx)(s.code,{children:"ShellState"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/ShellStateProvider.telemetry.test.tsx:187"})," \u2014 Telemetry tests using ",(0,l.jsx)(s.code,{children:"waitFor"})," to observe restore and readiness failures without microtask flushing."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/ResourceDashboard.tsx:242"})," \u2014 UI loading state based on ",(0,l.jsx)(s.code,{children:"bridge.isReady"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.code,{children:"packages/shell-web/src/modules/GeneratorPanel.tsx:124"})," \u2014 UI loading state based on ",(0,l.jsx)(s.code,{children:"bridge.isReady"}),"."]}),"\n",(0,l.jsxs)(s.li,{children:["GitHub issue ",(0,l.jsx)(s.code,{children:"#394"})," \u2014 \u201cInvestigate flushMicrotasks test helper and async boundaries\u201d."]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"appendix-a--glossary",children:"Appendix A \u2014 Glossary"}),"\n",(0,l.jsxs)(s.ul,{children:["\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Shell state readiness contract for ShellStateProvider"}),": The formal predicate over ",(0,l.jsx)(s.code,{children:"ShellState"})," that defines when the Shell is considered initialised and stable for tests and UI (bridge ready, not restoring, snapshot received)."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsxs)(s.strong,{children:[(0,l.jsx)(s.code,{children:"flushMicrotasks"})," helper"]}),": A legacy test-only function (removed in PR #396) that chained ",(0,l.jsx)(s.code,{children:"Promise.resolve()"})," and ",(0,l.jsx)(s.code,{children:"setTimeout(0)"})," calls to approximate completion of pending microtasks and macrotasks."]}),"\n",(0,l.jsxs)(s.li,{children:[(0,l.jsx)(s.strong,{children:"Worker bridge"}),": The abstraction that connects the web shell to the deterministic runtime worker, providing ",(0,l.jsx)(s.code,{children:"awaitReady"}),", state updates, telemetry, and social commands."]}),"\n"]}),"\n",(0,l.jsx)(s.h2,{id:"appendix-b--change-log",children:"Appendix B \u2014 Change Log"}),"\n",(0,l.jsxs)(s.table,{children:[(0,l.jsx)(s.thead,{children:(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.th,{children:"Date"}),(0,l.jsx)(s.th,{children:"Author"}),(0,l.jsx)(s.th,{children:"Change Summary"})]})}),(0,l.jsxs)(s.tbody,{children:[(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"2025-11-16"}),(0,l.jsx)(s.td,{children:"Idle Engine Design-Authoring Agent"}),(0,l.jsxs)(s.td,{children:["Initial draft of deterministic Shell state readiness contract for ShellStateProvider and test migration plan (targets ",(0,l.jsx)(s.code,{children:"Fixes #394"}),")."]})]}),(0,l.jsxs)(s.tr,{children:[(0,l.jsx)(s.td,{children:"2025-11-16"}),(0,l.jsx)(s.td,{children:"Shell-Web Implementation Agent"}),(0,l.jsxs)(s.td,{children:["Document updated to reflect implemented ",(0,l.jsx)(s.code,{children:"awaitShellStateReady"})," helper, removal of ",(0,l.jsx)(s.code,{children:"flushMicrotasks"})," from tests, and alignment with PR #396 (",(0,l.jsx)(s.code,{children:"Fixes #394"}),")."]})]})]})]})]})}function h(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,l.jsx)(s,{...e,children:(0,l.jsx)(a,{...e})}):a(e)}},7678:(e,s,n)=>{n.d(s,{R:()=>t,x:()=>d});var i=n(9430);const l={},r=i.createContext(l);function t(e){const s=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function d(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:t(e.components),i.createElement(r.Provider,{value:s},e.children)}}}]);