"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[3334],{6212:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>o,contentTitle:()=>t,default:()=>h,frontMatter:()=>d,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"issue-806-design","title":"shell-desktop: Handle Sim Worker Exit + postMessage Failures (Issue 806)","description":"Document Control","source":"@site/../../docs/issue-806-design.md","sourceDirName":".","slug":"/issue-806-design","permalink":"/Idle-Game-Engine/issue-806-design","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/issue-806-design.md","tags":[],"version":"current","sidebarPosition":99,"frontMatter":{"title":"shell-desktop: Handle Sim Worker Exit + postMessage Failures (Issue 806)","sidebar_position":99}}');var r=n(5270),l=n(7678);const d={title:"shell-desktop: Handle Sim Worker Exit + postMessage Failures (Issue 806)",sidebar_position:99},t="shell-desktop: Handle Sim Worker Exit + postMessage Failures (Issue 806)",o={},c=[{value:"Document Control",id:"document-control",level:2},{value:"1. Summary",id:"1-summary",level:2},{value:"2. Context &amp; Problem Statement",id:"2-context--problem-statement",level:2},{value:"3. Goals &amp; Non-Goals",id:"3-goals--non-goals",level:2},{value:"4. Stakeholders, Agents &amp; Impacted Surfaces",id:"4-stakeholders-agents--impacted-surfaces",level:2},{value:"5. Current State",id:"5-current-state",level:2},{value:"6. Proposed Solution",id:"6-proposed-solution",level:2},{value:"6.1 Architecture Overview",id:"61-architecture-overview",level:3},{value:"6.2 Detailed Design",id:"62-detailed-design",level:3},{value:"6.3 Operational Considerations",id:"63-operational-considerations",level:3},{value:"7. Work Breakdown &amp; Delivery Plan",id:"7-work-breakdown--delivery-plan",level:2},{value:"7.1 Issue Map",id:"71-issue-map",level:3},{value:"7.2 Milestones",id:"72-milestones",level:3},{value:"7.3 Coordination Notes",id:"73-coordination-notes",level:3},{value:"8. Agent Guidance &amp; Guardrails",id:"8-agent-guidance--guardrails",level:2},{value:"9. Alternatives Considered",id:"9-alternatives-considered",level:2},{value:"10. Testing &amp; Validation Plan",id:"10-testing--validation-plan",level:2},{value:"11. Risks &amp; Mitigations",id:"11-risks--mitigations",level:2},{value:"12. Rollout Plan",id:"12-rollout-plan",level:2},{value:"13. Open Questions",id:"13-open-questions",level:2},{value:"14. Follow-Up Work",id:"14-follow-up-work",level:2},{value:"15. References",id:"15-references",level:2},{value:"Appendix A \u2014 Glossary",id:"appendix-a--glossary",level:2},{value:"Appendix B \u2014 Change Log",id:"appendix-b--change-log",level:2}];function a(e){const s={a:"a",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"shell-desktop-handle-sim-worker-exit--postmessage-failures-issue-806",children:"shell-desktop: Handle Sim Worker Exit + postMessage Failures (Issue 806)"})}),"\n",(0,r.jsx)(s.h2,{id:"document-control",children:"Document Control"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Title"}),": Prevent Electron main-process crashes when the sim worker exits"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Authors"}),": Codex (AI)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Reviewers"}),": @hansjm10"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Status"}),": Draft"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Last Updated"}),": 2026-01-21"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Related Issues"}),": ",(0,r.jsx)(s.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/806",children:"https://github.com/hansjm10/Idle-Game-Engine/issues/806"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Execution Mode"}),": AI-led"]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"1-summary",children:"1. Summary"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"@idle-engine/shell-desktop"})," runs the simulation in a Node ",(0,r.jsx)(s.code,{children:"Worker"})," and pumps ",(0,r.jsx)(s.code,{children:"tick"})," messages on a ",(0,r.jsx)(s.code,{children:"setInterval"}),". Today, if the worker crashes/exits, the tick loop continues and ",(0,r.jsx)(s.code,{children:"worker.postMessage(...)"})," can throw, taking down the Electron main process. This design introduces explicit sim-worker lifecycle handling: stop the tick loop on worker failure, treat ",(0,r.jsx)(s.code,{children:"postMessage"})," exceptions as worker-fatal, and notify the renderer of a user-visible error (optionally with an automatic restart path) so the desktop app degrades gracefully instead of crashing."]}),"\n",(0,r.jsx)(s.h2,{id:"2-context--problem-statement",children:"2. Context & Problem Statement"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Background"}),": The desktop shell architecture (Issue 778) isolates the deterministic runtime in a worker thread and streams ",(0,r.jsx)(s.code,{children:"RenderCommandBuffer"})," frames to the renderer via IPC. In the current implementation, the main process (",(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/main.ts"}),") creates ",(0,r.jsx)(s.code,{children:"sim-worker.js"}),", sends ",(0,r.jsx)(s.code,{children:"init"}),", starts a 16ms interval after a ",(0,r.jsx)(s.code,{children:"ready"})," message, and forwards ",(0,r.jsx)(s.code,{children:"frames"})," to the renderer on ",(0,r.jsx)(s.code,{children:"IPC_CHANNELS.frame"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Problem"}),": The tick loop does not handle the worker exiting/crashing. If the worker exits unexpectedly, ",(0,r.jsx)(s.code,{children:"worker.postMessage(...)"})," can throw during the interval callback (or during control event forwarding), crashing the Electron main process and taking down the entire desktop app."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Forces"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Main process must stay resilient: worker failure is expected in the wild (crashes, OS kill, dev hot reload)."}),"\n",(0,r.jsx)(s.li,{children:"Renderer should receive a clear, user-visible error and a recovery path without requiring developer tooling."}),"\n",(0,r.jsx)(s.li,{children:"Avoid noisy/fragile behavior: no infinite restart loops and no console spam that obscures failures."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"3-goals--non-goals",children:"3. Goals & Non-Goals"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Goals"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"If the sim worker exits unexpectedly, the Electron main process does not crash."}),"\n",(0,r.jsx)(s.li,{children:"Tick loop stops cleanly when the worker is no longer usable."}),"\n",(0,r.jsx)(s.li,{children:"Renderer receives a clear \u201csim stopped/crashed\u201d status and a recovery path (restart/reload)."}),"\n",(0,r.jsxs)(s.li,{children:["Add/extend unit tests in ",(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/main.test.ts"})," to cover worker exit and ",(0,r.jsx)(s.code,{children:"postMessage"})," failure."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Non-Goals"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Persisting/restoring sim state across worker restarts (worker restart may reset demo state)."}),"\n",(0,r.jsx)(s.li,{children:"Implementing full crash reporting/telemetry infrastructure (beyond structured logs/status messages)."}),"\n",(0,r.jsxs)(s.li,{children:["Reworking the sim scheduling model (e.g., replacing ",(0,r.jsx)(s.code,{children:"setInterval"})," with a more sophisticated cadence)."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"4-stakeholders-agents--impacted-surfaces",children:"4. Stakeholders, Agents & Impacted Surfaces"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Primary Stakeholders"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Desktop shell maintainers (",(0,r.jsx)(s.code,{children:"packages/shell-desktop"}),")."]}),"\n",(0,r.jsx)(s.li,{children:"Runtime maintainers (worker isolation and determinism expectations from Issue 778)."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Agent Roles"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Docs Agent"}),": Maintain design doc and open questions (this change)."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Runtime/Shell Implementation Agent"}),": Implement worker lifecycle hardening in ",(0,r.jsx)(s.code,{children:"main.ts"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Test Agent"}),": Extend Vitest coverage in ",(0,r.jsx)(s.code,{children:"main.test.ts"})," (and preload/renderer tests if IPC surface changes)."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Affected Packages/Services"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/main.ts"})," (worker lifecycle + tick loop)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/main.test.ts"})," (exit + ",(0,r.jsx)(s.code,{children:"postMessage"})," failure coverage)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/ipc.ts"})," and ",(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/preload.cts"})," (if introducing a new sim-status IPC surface)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/renderer/index.ts"})," (user-visible sim status)"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Compatibility Considerations"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["New IPC event(s) should be additive and versioned via TypeScript types in ",(0,r.jsx)(s.code,{children:"ipc.ts"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["Avoid changing existing ",(0,r.jsx)(s.code,{children:"IPC_CHANNELS.frame"})," payload (",(0,r.jsx)(s.code,{children:"RenderCommandBuffer"}),") to keep renderer contract stable."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"5-current-state",children:"5. Current State"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/main.ts"})," creates a sim worker and drives it with an interval:"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Worker creation: ",(0,r.jsx)(s.code,{children:"new Worker(new URL('./sim-worker.js', import.meta.url))"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"postMessage"})," wrapper calls ",(0,r.jsx)(s.code,{children:"worker.postMessage(message)"})," with no ",(0,r.jsx)(s.code,{children:"try/catch"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["Tick loop uses ",(0,r.jsx)(s.code,{children:"setInterval"})," to ",(0,r.jsx)(s.code,{children:"postMessage({ kind: 'tick', deltaMs })"})," after receiving ",(0,r.jsx)(s.code,{children:"{ kind: 'ready' }"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["Main forwards frames (",(0,r.jsx)(s.code,{children:"{ kind: 'frames', frames }"}),") to the renderer via ",(0,r.jsx)(s.code,{children:"mainWindow.webContents.send(IPC_CHANNELS.frame, frame)"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["Worker ",(0,r.jsx)(s.code,{children:"message.kind === 'error'"})," and worker ",(0,r.jsx)(s.code,{children:"'error'"})," events are logged via ",(0,r.jsx)(s.code,{children:"console.error"}),", but do not stop the tick loop or notify the renderer."]}),"\n",(0,r.jsxs)(s.li,{children:["No ",(0,r.jsx)(s.code,{children:"'exit'"})," event handling exists for the worker."]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["Existing tests in ",(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/main.test.ts"})," validate:"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"IPC ping handler setup."}),"\n",(0,r.jsxs)(s.li,{children:["Tick loop start after ",(0,r.jsx)(s.code,{children:"ready"})," and forwarding ",(0,r.jsx)(s.code,{children:"frames"})," to the renderer."]}),"\n",(0,r.jsx)(s.li,{children:"Control events enqueue commands."}),"\n",(0,r.jsx)(s.li,{children:"Logging of worker errors."}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"There is currently no test coverage for:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Worker exit (",(0,r.jsx)(s.code,{children:"worker.on('exit', ...)"}),") behavior."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"worker.postMessage"})," throwing (interval tick and/or control event path)."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"6-proposed-solution",children:"6. Proposed Solution"}),"\n",(0,r.jsx)(s.h3,{id:"61-architecture-overview",children:"6.1 Architecture Overview"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Add a small sim-worker lifecycle state machine to the main process controller to model ",(0,r.jsx)(s.code,{children:"starting \u2192 running \u2192 failed/stopped"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["Harden all outbound messages (",(0,r.jsx)(s.code,{children:"init"}),", ",(0,r.jsx)(s.code,{children:"tick"}),", ",(0,r.jsx)(s.code,{children:"enqueueCommands"}),", and any future control messages) via a ",(0,r.jsx)(s.code,{children:"safePostMessage"})," wrapper that catches exceptions and transitions the worker to a failed state."]}),"\n",(0,r.jsxs)(s.li,{children:["Subscribe to worker ",(0,r.jsx)(s.code,{children:"'exit'"})," and treat unexpected exits as fatal:","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"stop the tick loop,"}),"\n",(0,r.jsx)(s.li,{children:"prevent further sends,"}),"\n",(0,r.jsx)(s.li,{children:"notify the renderer of an error state,"}),"\n",(0,r.jsx)(s.li,{children:"optionally attempt a bounded restart (dev-only or behind a flag)."}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(s.li,{children:"Introduce a renderer-visible status channel (additive IPC) so the UI can show \u201cSim crashed/stopped\u201d and present a recovery instruction (reload or restart)."}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"62-detailed-design",children:"6.2 Detailed Design"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Runtime Changes"}),":"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["In ",(0,r.jsx)(s.code,{children:"createSimWorkerController(...)"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Track lifecycle flags: ",(0,r.jsx)(s.code,{children:"isDisposing"}),", ",(0,r.jsx)(s.code,{children:"hasFailed"}),", and ",(0,r.jsx)(s.code,{children:"tickTimer"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["Implement ",(0,r.jsx)(s.code,{children:"stopTickLoop()"})," and call it from all failure paths."]}),"\n",(0,r.jsxs)(s.li,{children:["Wrap ",(0,r.jsx)(s.code,{children:"worker.postMessage"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"safePostMessage(message)"})," uses ",(0,r.jsx)(s.code,{children:"try/catch"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["On exception: stop tick loop, mark the worker failed, and (best-effort) ",(0,r.jsx)(s.code,{children:"terminate()"})," it."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["Handle worker ",(0,r.jsx)(s.code,{children:"'exit'"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["If ",(0,r.jsx)(s.code,{children:"isDisposing"})," is true, treat as expected shutdown."]}),"\n",(0,r.jsx)(s.li,{children:"Otherwise, treat as failure and perform the same stop/notify steps."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["Continue to handle worker ",(0,r.jsx)(s.code,{children:"'error'"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Prefer one unified ",(0,r.jsx)(s.code,{children:"handleWorkerFailure(source, details)"})," path so logs, renderer status, and restarts are consistent."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["Optional: also handle ",(0,r.jsx)(s.code,{children:"'messageerror'"})," to catch structured-clone failures explicitly."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Data & Schemas"}),":"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Keep ",(0,r.jsx)(s.code,{children:"RenderCommandBuffer"})," payloads unchanged."]}),"\n",(0,r.jsxs)(s.li,{children:["Add a new \u201csim status\u201d payload type in ",(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/ipc.ts"}),", for example:","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"starting | running | stopped | crashed"})," plus a human-readable ",(0,r.jsx)(s.code,{children:"reason"})," and (if available) ",(0,r.jsx)(s.code,{children:"exitCode"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"APIs & Contracts"}),":"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Extend ",(0,r.jsx)(s.code,{children:"IPC_CHANNELS"})," with an additive event channel (example): ",(0,r.jsx)(s.code,{children:"idle-engine:sim-status"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["Extend ",(0,r.jsx)(s.code,{children:"IdleEngineApi"})," with an additive subscription method (example): ",(0,r.jsx)(s.code,{children:"onSimStatus(handler)"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["Recovery path options (choose one for implementation):","\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Minimal"}),": Renderer displays error and instructs the user to use the existing app menu ",(0,r.jsx)(s.code,{children:"View \u2192 Reload"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Better UX"}),": Add an IPC-invoked ",(0,r.jsx)(s.code,{children:"restartSim()"})," API and a small renderer affordance (e.g., a keybind like ",(0,r.jsx)(s.code,{children:"R"})," or a button) to restart the worker."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Dev ergonomics"}),": Auto-restart worker with backoff (e.g., 1s, capped attempts) when ",(0,r.jsx)(s.code,{children:"isDev"})," is true or ",(0,r.jsx)(s.code,{children:"IDLE_ENGINE_SIM_AUTO_RESTART=1"})," is set."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Tooling & Automation"}),":"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["No new tooling is required; changes remain within the ",(0,r.jsx)(s.code,{children:"packages/shell-desktop"})," Vitest suite."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"63-operational-considerations",children:"6.3 Operational Considerations"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Deployment"}),": Additive behavior-only change; no migration required. Ensure that production builds do not enter infinite restart loops (cap attempts or require explicit user action)."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Telemetry & Observability"}),": Keep ",(0,r.jsx)(s.code,{children:"console.error"})," for now, but ensure it is emitted once per failure path (avoid spamming per tick)."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Security & Compliance"}),": Only send sanitized, user-safe error strings to the renderer (avoid leaking stack traces unless in dev mode)."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"7-work-breakdown--delivery-plan",children:"7. Work Breakdown & Delivery Plan"}),"\n",(0,r.jsx)(s.h3,{id:"71-issue-map",children:"7.1 Issue Map"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Issue Title"}),(0,r.jsx)(s.th,{children:"Scope Summary"}),(0,r.jsx)(s.th,{children:"Proposed Assignee/Agent"}),(0,r.jsx)(s.th,{children:"Dependencies"}),(0,r.jsx)(s.th,{children:"Acceptance Criteria"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"fix(shell-desktop): stop tick loop on sim-worker exit"})}),(0,r.jsxs)(s.td,{children:["Add worker ",(0,r.jsx)(s.code,{children:"exit"})," handling + tick stop"]}),(0,r.jsx)(s.td,{children:"Runtime/Shell Implementation Agent"}),(0,r.jsx)(s.td,{children:"None"}),(0,r.jsx)(s.td,{children:"Worker exit does not crash main; tick loop stops"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"fix(shell-desktop): treat postMessage failures as worker-fatal"})}),(0,r.jsxs)(s.td,{children:["Wrap ",(0,r.jsx)(s.code,{children:"postMessage"})," and route to unified failure handler"]}),(0,r.jsx)(s.td,{children:"Runtime/Shell Implementation Agent"}),(0,r.jsx)(s.td,{children:"Exit handling"}),(0,r.jsx)(s.td,{children:"No thrown exception from interval/control path"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"feat(shell-desktop): surface sim status to renderer"})}),(0,r.jsx)(s.td,{children:"Add IPC status event + renderer output update"}),(0,r.jsx)(s.td,{children:"Runtime/Shell Implementation Agent"}),(0,r.jsx)(s.td,{children:"Failure handler"}),(0,r.jsx)(s.td,{children:"Renderer shows sim stopped/crashed state and recovery hint"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"test(shell-desktop): cover worker exit + postMessage throw"})}),(0,r.jsxs)(s.td,{children:["Extend ",(0,r.jsx)(s.code,{children:"main.test.ts"})," worker mock and add tests"]}),(0,r.jsx)(s.td,{children:"Test Agent"}),(0,r.jsx)(s.td,{children:"Implementation"}),(0,r.jsx)(s.td,{children:"Vitest covers exit and throw scenarios"})]})]})]}),"\n",(0,r.jsx)(s.h3,{id:"72-milestones",children:"7.2 Milestones"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Phase 1"}),": Stop tick loop on worker failure; catch ",(0,r.jsx)(s.code,{children:"postMessage"})," exceptions; tests added."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Phase 2"}),": Add renderer-visible status channel and (optional) restart affordance."]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"73-coordination-notes",children:"7.3 Coordination Notes"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Hand-off Package"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/main.ts"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/main.test.ts"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/ipc.ts"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/preload.cts"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/renderer/index.ts"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Communication Cadence"}),": Single reviewer pass once Phase 1 is complete; follow-up review if IPC surface is extended."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"8-agent-guidance--guardrails",children:"8. Agent Guidance & Guardrails"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Context Packets"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Issue 806: ",(0,r.jsx)(s.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/806",children:"https://github.com/hansjm10/Idle-Game-Engine/issues/806"})]}),"\n",(0,r.jsxs)(s.li,{children:["Related design: ",(0,r.jsx)(s.code,{children:"docs/desktop-shell-webgpu-renderer-replay-design-issue-778.md"})]}),"\n",(0,r.jsxs)(s.li,{children:["Implementation entrypoints: ",(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/main.ts"}),", ",(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/sim-worker.ts"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Prompting & Constraints"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Do not edit generated ",(0,r.jsx)(s.code,{children:"packages/shell-desktop/dist/**"})," by hand."]}),"\n",(0,r.jsxs)(s.li,{children:["Preserve type-only imports/exports (",(0,r.jsx)(s.code,{children:"import type"})," / ",(0,r.jsx)(s.code,{children:"export type"}),")."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Safety Rails"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Ensure worker shutdown during app quit does not surface as a \u201ccrash\u201d (use an explicit disposing flag)."}),"\n",(0,r.jsx)(s.li,{children:"Avoid unbounded auto-restart loops; cap attempts or gate behind dev/flag."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Validation Hooks"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"pnpm test --filter @idle-engine/shell-desktop"})}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"pnpm lint --filter @idle-engine/shell-desktop"})," (if IPC surface/types change)"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"9-alternatives-considered",children:"9. Alternatives Considered"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Do nothing"}),": Leaves an easy main-process crash vector when worker exits unexpectedly."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Let the main process crash and rely on OS/app restart"}),": Poor UX and loses diagnostic context."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Run the sim in the renderer process"}),": Reduces isolation and reintroduces UI thread contention; contradicts the worker-isolated direction from Issue 778."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsxs)(s.strong,{children:["Encode errors into ",(0,r.jsx)(s.code,{children:"RenderCommandBuffer"})]}),": Pollutes the renderer contract and conflates \u201cpresentation frames\u201d with control-plane status."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"10-testing--validation-plan",children:"10. Testing & Validation Plan"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Unit / Integration"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Add a ",(0,r.jsx)(s.code,{children:"worker.emitExit(code)"})," helper to the ",(0,r.jsx)(s.code,{children:"Worker"})," mock in ",(0,r.jsx)(s.code,{children:"main.test.ts"})," and validate:","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["tick timer is cleared / stops issuing ",(0,r.jsx)(s.code,{children:"tick"})," messages after exit,"]}),"\n",(0,r.jsx)(s.li,{children:"renderer receives a sim status update (if implemented),"}),"\n",(0,r.jsx)(s.li,{children:"no uncaught exceptions occur."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["Make ",(0,r.jsx)(s.code,{children:"worker.postMessage"})," throw (once or always) and validate:","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"exception is caught,"}),"\n",(0,r.jsx)(s.li,{children:"tick loop stops,"}),"\n",(0,r.jsx)(s.li,{children:"failure is logged/forwarded once."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Performance"}),": N/A (behavioral hardening only)."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Tooling / A11y"}),": N/A for the current minimal renderer output view."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"11-risks--mitigations",children:"11. Risks & Mitigations"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Risk"}),": Worker exit during normal shutdown is misclassified as a crash.",(0,r.jsx)(s.br,{}),"\n",(0,r.jsx)(s.strong,{children:"Mitigation"}),": Track ",(0,r.jsx)(s.code,{children:"isDisposing"})," and ignore ",(0,r.jsx)(s.code,{children:"'exit'"})," when disposing."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Risk"}),": Auto-restart can loop forever if the worker always crashes.",(0,r.jsx)(s.br,{}),"\n",(0,r.jsx)(s.strong,{children:"Mitigation"}),": Cap retries; add exponential backoff; disable by default in production."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Risk"}),": Renderer doesn\u2019t show the failure, making the app appear frozen.",(0,r.jsx)(s.br,{}),"\n",(0,r.jsx)(s.strong,{children:"Mitigation"}),": Add explicit sim-status IPC event and render it prominently (same output block as IPC/WebGPU status)."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"12-rollout-plan",children:"12. Rollout Plan"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Milestones"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Land Phase 1 behavior hardening + tests."}),"\n",(0,r.jsx)(s.li,{children:"Land Phase 2 UI/status improvements (or combine if the IPC change is small)."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Migration Strategy"}),": None."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Communication"}),": Document in the PR description that main-process crash-on-worker-exit is fixed and include the new failure-mode tests."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"13-open-questions",children:"13. Open Questions"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Should the default recovery path be \u201cmanual reload\u201d or \u201crestart sim\u201d (via IPC) for production builds?"}),"\n",(0,r.jsx)(s.li,{children:"If we auto-restart, what retry policy should be used (attempt count, backoff schedule), and should it differ between dev and packaged builds?"}),"\n",(0,r.jsx)(s.li,{children:"Should sim-worker failures surface a stack trace in dev mode (for diagnosis) while keeping production messages user-friendly?"}),"\n",(0,r.jsxs)(s.li,{children:["Should ",(0,r.jsx)(s.code,{children:"dispose()"})," request a graceful worker shutdown (send ",(0,r.jsx)(s.code,{children:"{ kind: 'shutdown' }"}),") before ",(0,r.jsx)(s.code,{children:"terminate()"}),", or is ",(0,r.jsx)(s.code,{children:"terminate()"})," sufficient?"]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"14-follow-up-work",children:"14. Follow-Up Work"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Add a small in-renderer UI affordance (button) for restarting the sim worker instead of relying on keybinds or app reload."}),"\n",(0,r.jsx)(s.li,{children:"Add structured, machine-parseable error events for future crash reporting (without spamming logs)."}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"15-references",children:"15. References"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Issue 806: ",(0,r.jsx)(s.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/806",children:"https://github.com/hansjm10/Idle-Game-Engine/issues/806"})]}),"\n",(0,r.jsxs)(s.li,{children:["Related architecture: ",(0,r.jsx)(s.code,{children:"docs/desktop-shell-webgpu-renderer-replay-design-issue-778.md"})]}),"\n",(0,r.jsxs)(s.li,{children:["Worker tick loop + ",(0,r.jsx)(s.code,{children:"postMessage"}),": ",(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/main.ts"})]}),"\n",(0,r.jsxs)(s.li,{children:["IPC surface: ",(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/ipc.ts"}),", ",(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/preload.cts"})]}),"\n",(0,r.jsxs)(s.li,{children:["Worker implementation: ",(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/sim-worker.ts"})]}),"\n",(0,r.jsxs)(s.li,{children:["Renderer output loop: ",(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/renderer/index.ts"})]}),"\n",(0,r.jsxs)(s.li,{children:["Existing tests: ",(0,r.jsx)(s.code,{children:"packages/shell-desktop/src/main.test.ts"})]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"appendix-a--glossary",children:"Appendix A \u2014 Glossary"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Main process"}),": Electron process that owns app lifecycle and creates BrowserWindows; runs Node APIs."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Renderer process"}),": Chromium process that runs the web UI and WebGPU renderer."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Sim worker"}),": Node ",(0,r.jsx)(s.code,{children:"Worker"})," thread running the deterministic runtime and emitting frames."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Tick loop"}),": The main-process scheduler that periodically sends ",(0,r.jsx)(s.code,{children:"{ kind: 'tick', deltaMs }"})," to the sim worker."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"appendix-b--change-log",children:"Appendix B \u2014 Change Log"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Date"}),(0,r.jsx)(s.th,{children:"Author"}),(0,r.jsx)(s.th,{children:"Change Summary"})]})}),(0,r.jsx)(s.tbody,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"2026-01-21"}),(0,r.jsx)(s.td,{children:"Codex (AI)"}),(0,r.jsx)(s.td,{children:"Initial draft for Issue 806"})]})})]})]})}function h(e={}){const{wrapper:s}={...(0,l.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},7678:(e,s,n)=>{n.d(s,{R:()=>d,x:()=>t});var i=n(9430);const r={},l=i.createContext(r);function d(e){const s=i.useContext(l);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function t(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),i.createElement(l.Provider,{value:s},e.children)}}}]);