"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[822],{7678:(e,n,i)=>{i.d(n,{R:()=>c,x:()=>l});var s=i(9430);const t={},r=s.createContext(t);function c(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),s.createElement(r.Provider,{value:n},e.children)}},9157:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"content-schema-rollout-decisions","title":"Content Schema Rollout: Decision Log","description":"Issue #11)","source":"@site/../../docs/content-schema-rollout-decisions.md","sourceDirName":".","slug":"/content-schema-rollout-decisions","permalink":"/Idle-Game-Engine/content-schema-rollout-decisions","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/content-schema-rollout-decisions.md","tags":[],"version":"current","frontMatter":{},"sidebar":"developerSidebar","previous":{"title":"Content Compiler Design Document","permalink":"/Idle-Game-Engine/content-compiler-design"},"next":{"title":"Content Validation CLI Design Document","permalink":"/Idle-Game-Engine/content-validation-cli-design"}}');var t=i(5270),r=i(7678);const c={},l="Content Schema Rollout: Decision Log",a={},d=[{value:"1. Icon Path Default Generation",id:"1-icon-path-default-generation",level:2},{value:"Current State",id:"current-state",level:3},{value:"Analysis",id:"analysis",level:3},{value:"Decision",id:"decision",level:3},{value:"2. Guild Perk Persistence Integration",id:"2-guild-perk-persistence-integration",level:2},{value:"Current State",id:"current-state-1",level:3},{value:"Analysis",id:"analysis-1",level:3},{value:"Decision",id:"decision-1",level:3},{value:"3. Scripted Modifiers &amp; Effect Types",id:"3-scripted-modifiers--effect-types",level:2},{value:"Current State",id:"current-state-2",level:3},{value:"Analysis",id:"analysis-2",level:3},{value:"Decision",id:"decision-2",level:3},{value:"5. Compiler Adoption &amp; Troubleshooting",id:"5-compiler-adoption--troubleshooting",level:2},{value:"4. Schema Digest Migration Strategy",id:"4-schema-digest-migration-strategy",level:2},{value:"Current State",id:"current-state-3",level:3},{value:"Analysis",id:"analysis-3",level:3},{value:"Decision",id:"decision-3",level:3},{value:"5. Risk Mitigation Tracking",id:"5-risk-mitigation-tracking",level:2},{value:"5.1 Formula Explosion",id:"51-formula-explosion",level:3},{value:"5.2 Schema Drift vs Runtime",id:"52-schema-drift-vs-runtime",level:3},{value:"5.3 Author Friction",id:"53-author-friction",level:3},{value:"5.4 Compatibility Versioning",id:"54-compatibility-versioning",level:3},{value:"5.5 Transform Loops",id:"55-transform-loops",level:3},{value:"5.6 Performance",id:"56-performance",level:3},{value:"6. Property-Based Formula Sanitization Guidance",id:"6-property-based-formula-sanitization-guidance",level:2},{value:"Sanitization Invariants Enforced",id:"sanitization-invariants-enforced",level:3},{value:"Running the Property Suites Locally",id:"running-the-property-suites-locally",level:3},{value:"Troubleshooting &amp; Replay Tips",id:"troubleshooting--replay-tips",level:3},{value:"Open Questions &amp; Owners",id:"open-questions--owners",level:3},{value:"References for Downstream Agents",id:"references-for-downstream-agents",level:3},{value:"7. Summary &amp; Recommendations",id:"7-summary--recommendations",level:2},{value:"Decisions Made",id:"decisions-made",level:3},{value:"New Issues to Create",id:"new-issues-to-create",level:3},{value:"Phase 2 Unblocked",id:"phase-2-unblocked",level:3},{value:"Traceability to Issue #11",id:"traceability-to-issue-11",level:3},{value:"Next Actions",id:"next-actions",level:3}];function o(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",input:"input",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"content-schema-rollout-decision-log",children:"Content Schema Rollout: Decision Log"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Issue:"})," #137 (Parent: #11)\n",(0,t.jsx)(n.strong,{children:"Related Design:"})," docs/content-dsl-schema-design.md\n",(0,t.jsx)(n.strong,{children:"Date:"})," 2025-10-21\n",(0,t.jsx)(n.strong,{children:"Status:"})," Research Complete"]}),"\n",(0,t.jsx)(n.p,{children:"This document addresses the open questions from \xa710 and risk mitigations from \xa77 of the content schema design document."}),"\n",(0,t.jsx)(n.h2,{id:"1-icon-path-default-generation",children:"1. Icon Path Default Generation"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Question:"})," Should the schema expose calculated presentation defaults (e.g., auto-generated icon paths) or leave that to the compiler?"]}),"\n",(0,t.jsx)(n.h3,{id:"current-state",children:"Current State"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Icon fields are optional strings in all modules (resources, generators, upgrades, achievements, prestige layers, guild perks)"}),"\n",(0,t.jsxs)(n.li,{children:["Schema: ",(0,t.jsx)(n.code,{children:"icon: z.string().trim().min(1).max(256).optional()"})]}),"\n",(0,t.jsx)(n.li,{children:"No automatic path generation or validation exists"}),"\n",(0,t.jsx)(n.li,{children:"No convention for icon asset organization documented"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"analysis",children:"Analysis"}),"\n",(0,t.jsx)(n.p,{children:"Icon path generation involves several concerns:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Asset resolution:"})," Paths must be resolvable at runtime (relative vs absolute, asset bundling)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Convention vs configuration:"})," Auto-generation assumes naming conventions"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Build-time vs runtime:"})," Path resolution may depend on bundler configuration"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Presentation layer coupling:"})," Icon display is a UI concern, not a schema concern"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"decision",children:"Decision"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Leave icon path defaults to the compiler/presentation layer."})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Rationale:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Schema should remain presentation-agnostic per design principle \xa73 (Non-Goals)"}),"\n",(0,t.jsx)(n.li,{children:"Asset bundling and path resolution vary by deployment (Vite, Webpack, CDN)"}),"\n",(0,t.jsx)(n.li,{children:"Compiler can implement convention-based defaults when transforming packs"}),"\n",(0,t.jsx)(n.li,{children:"Allows flexibility for different presentation layers (web, mobile, terminal UI)"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Action Items:"})}),"\n",(0,t.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Document icon asset conventions in compiler specification (follow-up issue)"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Add optional ",(0,t.jsx)(n.code,{children:"iconPath"})," validation to check extension types (.svg, .png, .webp)"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Consider adding ",(0,t.jsx)(n.code,{children:"iconPathSchema"})," with URL validation when compiler spec lands"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Follow-up:"})," Create issue for DSL compiler icon resolution strategy (blocked on compiler design)"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"2-guild-perk-persistence-integration",children:"2. Guild Perk Persistence Integration"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Question:"})," How will guild perk costs interface with social-service data when live persistence lands?"]}),"\n",(0,t.jsx)(n.h3,{id:"current-state-1",children:"Current State"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Guild perk schema complete in ",(0,t.jsx)(n.code,{children:"packages/content-schema/src/modules/guild-perks.ts"})]}),"\n",(0,t.jsxs)(n.li,{children:["Social service has stub guild routes (",(0,t.jsx)(n.code,{children:"services/social/src/routes/guild.ts"}),")"]}),"\n",(0,t.jsx)(n.li,{children:"Persistence is in-memory only (Phase 5 work per implementation plan)"}),"\n",(0,t.jsx)(n.li,{children:"No database schema exists for guild perks or guild state"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"analysis-1",children:"Analysis"}),"\n",(0,t.jsx)(n.p,{children:"Guild perk costs reference several potential currency types:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Guild-scoped resources:"})," Contribution points, guild XP, treasury funds"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Player-scoped contributions:"})," Individual resource donations"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Time-gated unlocks:"})," Milestone-based availability"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Social metrics:"})," Member count, activity thresholds"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Current cost schema uses generic ",(0,t.jsx)(n.code,{children:"ContentId"})," references, which works for player resources but doesn't model guild-specific currencies."]}),"\n",(0,t.jsx)(n.h3,{id:"decision-1",children:"Decision"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Defer guild-specific cost modeling to Phase 5 persistence implementation."})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Rationale:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Current ",(0,t.jsx)(n.code,{children:"cost"})," schema is flexible enough for prototype phase (Issue #11, Phase 0-4)"]}),"\n",(0,t.jsx)(n.li,{children:"Guild persistence design is not yet finalized (Phase 5: Weeks 5-7)"}),"\n",(0,t.jsxs)(n.li,{children:["Schema can be extended with ",(0,t.jsx)(n.code,{children:"GuildCostSchema"})," when social service adds persistence"]}),"\n",(0,t.jsx)(n.li,{children:"FEATURE_GATES already restrict guild perks to runtime >=0.5.0"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Immediate Actions:"})}),"\n",(0,t.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",checked:!0,disabled:!0})," ","Verify guild perk ",(0,t.jsx)(n.code,{children:"cost"})," schema supports ",(0,t.jsx)(n.code,{children:"resourceId"})," references"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",checked:!0,disabled:!0})," ","Document that guild currencies must be defined as pack resources with ",(0,t.jsx)(n.code,{children:"category: 'currency'"})]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Phase 5 Follow-up (Issue #138 recommended):"})}),"\n",(0,t.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Design guild persistence schema (Postgres tables: guilds, guild_perks, member_contributions)"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Add ",(0,t.jsx)(n.code,{children:"GuildResourceDefinition"})," with ownership semantics (guild-scoped vs player-scoped)"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Extend cost schema with ",(0,t.jsx)(n.code,{children:"scope: 'player' | 'guild'"})," discriminator if needed"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Add validation ensuring guild perk costs only reference guild-category resources"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Acceptance Criteria for Phase 5:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Social service persists guild perk unlock state"}),"\n",(0,t.jsx)(n.li,{children:"Content packs can define guild-scoped currency resources"}),"\n",(0,t.jsx)(n.li,{children:"Validation ensures guild perk costs reference valid guild currencies"}),"\n",(0,t.jsx)(n.li,{children:"Documentation examples show guild contribution tracking"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"3-scripted-modifiers--effect-types",children:"3. Scripted Modifiers & Effect Types"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Question:"})," Do we need additional effect types (e.g., scripted modifiers) before schema v1.0, or can they wait for the scripting design doc?"]}),"\n",(0,t.jsx)(n.h3,{id:"current-state-2",children:"Current State"}),"\n",(0,t.jsx)(n.p,{children:"Upgrade effects are discriminated unions with these variants (upgrades.ts:79-124):"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"modifyResourceRate"}),": Formula-based resource adjustments"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"modifyResourceCapacity"}),": Formula-based resource capacity adjustments"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"modifyGeneratorRate"}),": Formula-based generator production"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"modifyGeneratorCost"}),": Formula-based cost scaling"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"grantAutomation"}),": Enable automation toggles"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"grantFlag"}),": Set boolean flags"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"unlockResource"})," / ",(0,t.jsx)(n.code,{children:"unlockGenerator"}),": Entity unlocking"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"alterDirtyTolerance"}),": Precision threshold adjustments"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"emitEvent"}),": Trigger runtime events"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["All modification effects use ",(0,t.jsx)(n.code,{children:"NumericFormula"})," (formulas.ts), which supports:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Structured expressions with typed references"}),"\n",(0,t.jsx)(n.li,{children:"Common curves (linear, exponential, polynomial, piecewise)"}),"\n",(0,t.jsx)(n.li,{children:"Safe math operations (add, sub, mul, div, pow, min, max)"}),"\n",(0,t.jsx)(n.li,{children:"Function calls against allowlist (clamp, lerp, etc.)"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"analysis-2",children:"Analysis"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:["Scripting Layer Status (",(0,t.jsx)(n.code,{children:"docs/idle-engine-design.md"})," \xa76.2):"]})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:'"Script layer exposes deterministic APIs (no direct async)"'}),"\n",(0,t.jsx)(n.li,{children:'"Script host provides whitelisted math/util modules and deterministic random via seeded RNG"'}),"\n",(0,t.jsx)(n.li,{children:"No scripting design document exists yet"}),"\n",(0,t.jsx)(n.li,{children:"Sandbox requirements not yet specified"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Current Formula Coverage:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Declarative formulas cover common idle game progressions (exponential scaling, piecewise curves)"}),"\n",(0,t.jsx)(n.li,{children:"Expression AST allows complex calculations without scripting"}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"script"})," and ",(0,t.jsx)(n.code,{children:"flag"})," conditions already exist for hook points"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Gaps Requiring Scripting:"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Conditional logic beyond formula evaluation (complex branching)"}),"\n",(0,t.jsx)(n.li,{children:"State queries across multiple entities (aggregate calculations)"}),"\n",(0,t.jsx)(n.li,{children:"Custom effect application (e.g., randomized bonuses, combinatorial effects)"}),"\n",(0,t.jsx)(n.li,{children:"Event-driven behaviors (trigger chains, cascading effects)"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"decision-2",children:"Decision"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Defer scripted modifiers until scripting design document and runtime sandbox land."})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Rationale:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Current formula system covers prototype phase needs (Phase 0-6 in implementation-plan.md)"}),"\n",(0,t.jsxs)(n.li,{children:["Scripting requires security sandbox design (",(0,t.jsx)(n.code,{children:"docs/idle-engine-design.md"}),' \xa76.3: "Sandbox third-party scripts")']}),"\n",(0,t.jsx)(n.li,{children:"Feature gate model supports incremental rollout (runtime-compat.ts FEATURE_GATES)"}),"\n",(0,t.jsx)(n.li,{children:"No content pack has requested scripted modifiers yet"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Schema v1.0 Requirements (Satisfied):"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u2705 Formula-based modifiers for common progressions"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Flag/script condition hooks for extensibility"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Event emission for trigger chains"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Effect composition via upgrade stacking"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Phase 7+ Follow-up (Issue #139 recommended):"})}),"\n",(0,t.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Author scripting design document (sandbox model, API surface, determinism guarantees)"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Implement script runtime with deterministic execution"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Add ",(0,t.jsx)(n.code,{children:"scriptedEffect"})," upgrade effect type:","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"{\n  kind: 'scriptedEffect';\n  scriptId: ScriptId;\n  payload?: Record<string, unknown>;\n}\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Update FEATURE_GATES with ",(0,t.jsx)(n.code,{children:"scriptedEffects"})," introduced in appropriate version"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Add content-schema validation ensuring scriptId references allowlisted scripts"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Acceptance Criteria for Scripted Modifiers:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Scripting design doc approved and sandbox implemented"}),"\n",(0,t.jsx)(n.li,{children:"Script execution is deterministic (seeded RNG, no async)"}),"\n",(0,t.jsx)(n.li,{children:"Scripts cannot access DOM or host environment"}),"\n",(0,t.jsx)(n.li,{children:"Validation enforces script allowlists per ContentSchemaOptions"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"5-compiler-adoption--troubleshooting",children:"5. Compiler Adoption & Troubleshooting"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Status:"})," The content compiler now emits deterministic artifacts during ",(0,t.jsx)(n.code,{children:"pnpm generate"}),", and ",(0,t.jsx)(n.code,{children:"@idle-engine/content-sample"})," imports the generated module instead of reparsing ",(0,t.jsx)(n.code,{children:"content/pack.json"}),"."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Required workflow:"})," ",(0,t.jsx)(n.code,{children:"pnpm generate"})," validates every discovered pack before the compiler writes artifacts. After editing any pack JSON, schema file, or runtime event manifest, run ",(0,t.jsx)(n.code,{children:"pnpm generate"})," (or ",(0,t.jsx)(n.code,{children:"pnpm generate --check"})," for CI/Lefthook) and commit the resulting updates under ",(0,t.jsx)(n.code,{children:"content/compiled/"}),", ",(0,t.jsx)(n.code,{children:"src/generated/"}),", and the workspace summary (",(0,t.jsx)(n.code,{children:"content/compiled/index.json"}),")."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Structured logging:"})," The CLI emits JSON events (",(0,t.jsx)(n.code,{children:"content_pack.validated"}),", ",(0,t.jsx)(n.code,{children:"content_pack.validation_failed"}),", ",(0,t.jsx)(n.code,{children:"content_pack.compiled"}),", ",(0,t.jsx)(n.code,{children:"content_pack.pruned"}),", ",(0,t.jsx)(n.code,{children:"watch.run"}),", etc.) that automation should parse instead of scraping console text. Watch mode keeps the process alive across failures while still surfacing non-zero exit codes on termination."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Summary contract:"})," Treat ",(0,t.jsx)(n.code,{children:"content/compiled/index.json"})," (or the path supplied via ",(0,t.jsx)(n.code,{children:"--summary"}),") as the canonical record of validation and compilation outcomes. If validation fails or ",(0,t.jsx)(n.code,{children:"pnpm generate --check"})," indicates drift, the summary is stale\u2014rerun the command before using compiled artifacts downstream."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Runtime guarantees:"})," The generated module rehydrates a frozen ",(0,t.jsx)(n.code,{children:"NormalizedContentPack"}),", exposes digest, artifact hash, module indices, and summary metadata, and fails fast if the compiler captured warnings. Downstream code should consume the exported summary (",(0,t.jsx)(n.code,{children:"sampleContentSummary"}),") instead of inferring metadata at runtime."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Digest verification:"})," ",(0,t.jsx)(n.code,{children:"rehydrateNormalizedPack"})," recomputes the digest whenever ",(0,t.jsx)(n.code,{children:"NODE_ENV !== 'production'"}),". To diagnose mismatches, rerun ",(0,t.jsx)(n.code,{children:"pnpm generate --clean"})," and compare the hash reported in the thrown error with ",(0,t.jsx)(n.code,{children:"content/compiled/sample-pack.normalized.json"}),". Production builds may opt out of digest verification by keeping ",(0,t.jsx)(n.code,{children:"NODE_ENV=production"}),", preserving the previous behaviour."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Common failures:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.em,{children:"Import-time warning error"}),": fix schema warnings surfaced in the compiler log or add contextual suppressions before retrying."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.em,{children:"Digest mismatch"}),": ensure artifacts were regenerated (use ",(0,t.jsx)(n.code,{children:"pnpm generate --clean"}),"), verify custom post-processing didn\u2019t mutate the generated module, and re-run tests."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.em,{children:"Stale summary"}),": if ",(0,t.jsx)(n.code,{children:"content/compiled/index.json"})," (or a custom summary path) reports outdated versions or warning counts, rerun ",(0,t.jsx)(n.code,{children:"pnpm generate"})," so validation and compilation refresh the summary before committing artifacts."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"4-schema-digest-migration-strategy",children:"4. Schema Digest Migration Strategy"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Question:"})," What is the migration strategy when schema digests change (e.g., do we embed the digest into save files similar to event manifests)?"]}),"\n",(0,t.jsx)(n.h3,{id:"current-state-3",children:"Current State"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Digest Implementation (pack.ts:381-404):"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"FNV-1a hash of pack metadata + module id lists"}),"\n",(0,t.jsxs)(n.li,{children:["Format: ",(0,t.jsx)(n.code,{children:"{ version: number; hash: string }"})," (e.g., ",(0,t.jsx)(n.code,{children:"fnv1a-a3c2f1b8"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:["Digest version: ",(0,t.jsx)(n.code,{children:"CONTENT_PACK_DIGEST_VERSION = 1"})]}),"\n",(0,t.jsxs)(n.li,{children:["Computed during ",(0,t.jsx)(n.code,{children:"normalizeContentPack"}),", included in ",(0,t.jsx)(n.code,{children:"NormalizedContentPack.digest"})]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Runtime Event Manifest Approach (runtime-event-manifest-authoring.md:38-43):"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Manifest hash embedded in event frames for replay validation"}),"\n",(0,t.jsx)(n.li,{children:"Hash checked during recording and playback"}),"\n",(0,t.jsx)(n.li,{children:'Failures trigger "rerun pnpm generate" guidance'}),"\n",(0,t.jsx)(n.li,{children:"Deterministic hash ensures replay integrity"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Save System Status (implementation-plan.md Phase 4):"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:'Phase 4: "Implement save slot manager (IndexedDB/localStorage) with migration hooks"'}),"\n",(0,t.jsxs)(n.li,{children:["Versioned schemas mentioned in design (",(0,t.jsx)(n.code,{children:"docs/idle-engine-design.md"})," \xa76.2)"]}),"\n",(0,t.jsx)(n.li,{children:"No save format specification exists yet"}),"\n",(0,t.jsx)(n.li,{children:"Migration pipeline not yet designed"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"analysis-3",children:"Analysis"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Digest Use Cases:"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Content pack versioning:"})," Track which pack version produced the save"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Compatibility checking:"})," Detect when content has changed"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Migration triggering:"})," Know when save data needs transformation"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Replay validation:"})," Ensure deterministic behavior (like event manifest)"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Embedding Trade-offs:"})}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Approach"}),(0,t.jsx)(n.th,{children:"Pros"}),(0,t.jsx)(n.th,{children:"Cons"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Embed digest in saves"}),(0,t.jsx)(n.td,{children:"Fast compatibility checks; no external lookups; supports offline validation"}),(0,t.jsx)(n.td,{children:"Save size increase; digest changes break compatibility even for safe content updates"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Store pack version only"}),(0,t.jsx)(n.td,{children:"Smaller saves; semantic versioning for compatibility"}),(0,t.jsx)(n.td,{children:"Requires pack registry lookup; version bumps may be infrequent"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Hybrid (version + digest)"}),(0,t.jsx)(n.td,{children:"Best of both; version for coarse checks, digest for exact match"}),(0,t.jsx)(n.td,{children:"Larger saves; more complex validation logic"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"No embedding"}),(0,t.jsx)(n.td,{children:"Smallest saves; validation on load"}),(0,t.jsx)(n.td,{children:"Cannot detect incompatibility before hydration; may corrupt state"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"decision-3",children:"Decision"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Embed both pack version AND digest in save files (hybrid approach)."})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Rationale:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Pack version (semver) enables human-readable compatibility decisions"}),"\n",(0,t.jsx)(n.li,{children:"Digest provides cryptographic-strength change detection like event manifests"}),"\n",(0,t.jsx)(n.li,{children:"Supports offline validation (no registry lookup needed)"}),"\n",(0,t.jsx)(n.li,{children:"Enables granular migration decisions (version -> which migration steps, digest -> exact content state)"}),"\n",(0,t.jsx)(n.li,{children:"Aligns with runtime event manifest pattern (proven approach)"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Proposed Save Format Extension:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface SaveFileMetadata {\n  version: number; // Save format version\n  createdAt: string; // ISO-8601 timestamp\n  runtimeVersion: string; // Engine version (semver)\n  contentPacks: Array<{\n    id: string; // Pack slug\n    version: string; // Pack version (semver)\n    digest: {\n      version: number; // Digest format version\n      hash: string; // FNV-1a hash\n    };\n  }>;\n  // ... other metadata\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Migration Decision Tree:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Load save:\n  1. Check runtimeVersion compatibility (semver range check)\n  2. For each contentPacks entry:\n     a. Lookup installed pack by id\n     b. Compare version (semver):\n        - Exact match -> check digest\n        - Compatible minor/patch -> check for migrations\n        - Incompatible major -> error or force migration\n     c. Compare digest:\n        - Match -> no migration needed\n        - Mismatch -> run pack-specific migrations\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Implementation Actions (Issue #140 recommended - Phase 4):"})}),"\n",(0,t.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Design save file format with content pack manifests"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Implement save metadata serialization including digests"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Add migration registry (packId + version range -> migration functions)"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Create ",(0,t.jsx)(n.code,{children:"validateSaveCompatibility(save, installedPacks)"})," utility"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Document migration authoring guide for content pack maintainers"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Add tests for cross-version save loading"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Edge Cases to Handle:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Pack removed:"})," User uninstalls pack but has save referencing it (warning + option to continue with missing content)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Digest mismatch, same version:"})," Content changed without version bump (warn but allow, or force version bump in CI)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Multiple packs, cascading dependencies:"})," Validate dependency graph before migration (see dependencies.ts)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Partial migration failure:"})," Rollback or fallback strategy (atomic migration transactions)"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Acceptance Criteria:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Save files include content pack manifests with versions and digests"}),"\n",(0,t.jsx)(n.li,{children:"Loading a save checks compatibility before hydration"}),"\n",(0,t.jsx)(n.li,{children:"Incompatible saves trigger migration flow with user consent"}),"\n",(0,t.jsx)(n.li,{children:"Migrations can be tested independently via fixtures"}),"\n",(0,t.jsx)(n.li,{children:"Documentation includes migration authoring examples"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"5-risk-mitigation-tracking",children:"5. Risk Mitigation Tracking"}),"\n",(0,t.jsx)(n.p,{children:"Review of risks from \xa77 and their current mitigation status:"}),"\n",(0,t.jsx)(n.h3,{id:"51-formula-explosion",children:"5.1 Formula Explosion"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Risk:"})," Recursive expression parsing may allow deeply nested structures, risking performance issues."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Mitigation Status:"})," \u2705 ",(0,t.jsx)(n.strong,{children:"IMPLEMENTED"})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Recursion limits in ",(0,t.jsx)(n.code,{children:"expressionNodeSchema"})," (formulas.ts)"]}),"\n",(0,t.jsx)(n.li,{children:"AST node count caps enforced during validation"}),"\n",(0,t.jsx)(n.li,{children:"Property-based tests for formula sanitization (formulas.test.ts)"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Tracking:"})," No additional action needed; covered by existing tests."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"52-schema-drift-vs-runtime",children:"5.2 Schema Drift vs Runtime"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Risk:"})," Runtime may evolve faster than schema updates."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Mitigation Status:"})," \u26a0\ufe0f ",(0,t.jsx)(n.strong,{children:"PARTIALLY IMPLEMENTED"})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"FEATURE_GATES map runtime versions to schema modules (runtime-compat.ts:3-29)"}),"\n",(0,t.jsxs)(n.li,{children:["Validation checks ",(0,t.jsx)(n.code,{children:"ContentSchemaOptions.runtimeVersion"})," compatibility"]}),"\n",(0,t.jsx)(n.li,{children:"CI validates core against schema digest (per acceptance criteria \xa79)"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Gaps:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["No CI check enforcing that ",(0,t.jsx)(n.code,{children:"@idle-engine/core"})," validates against schema before publish"]}),"\n",(0,t.jsx)(n.li,{children:"Runtime version must be manually kept in sync with FEATURE_GATES"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Action Items (Issue #141 recommended):"})}),"\n",(0,t.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Add CI step: ",(0,t.jsx)(n.code,{children:"pnpm --filter @idle-engine/core test:schema-compat"})]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Create test ensuring core package.json version satisfies all feature gate ranges"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Add pre-publish hook blocking core releases if schema validation fails"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Document schema evolution policy (when to bump FEATURE_GATES, how to coordinate with runtime releases)"]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"53-author-friction",children:"5.3 Author Friction"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Risk:"})," Strict schemas may frustrate early adopters."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Mitigation Status:"})," \u2705 ",(0,t.jsx)(n.strong,{children:"IMPLEMENTED"})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Descriptive error messages with structured ",(0,t.jsx)(n.code,{children:"SchemaWarning"})," (errors.ts)"]}),"\n",(0,t.jsx)(n.li,{children:"Non-fatal warnings for soft constraints (missing translations, steep curves)"}),"\n",(0,t.jsxs)(n.li,{children:["Severity levels (",(0,t.jsx)(n.code,{children:"error"}),", ",(0,t.jsx)(n.code,{children:"warning"}),", ",(0,t.jsx)(n.code,{children:"info"}),") allow progressive strictness"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"safeParse"})," returns warnings alongside successful parses"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Tracking:"})," Monitor GitHub issues for author feedback; adjust warning thresholds if patterns emerge."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"54-compatibility-versioning",children:"5.4 Compatibility Versioning"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Risk:"})," Packs targeting older runtime versions must continue to parse."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Mitigation Status:"})," \u2705 ",(0,t.jsx)(n.strong,{children:"IMPLEMENTED"})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"FEATURE_GATES enable feature-based versioning (runtime-compat.ts)"}),"\n",(0,t.jsx)(n.li,{children:"Metadata.engine field specifies runtime version range (metadata.ts)"}),"\n",(0,t.jsx)(n.li,{children:"Validation allows older packs with subset of features"}),"\n",(0,t.jsx)(n.li,{children:"Schema transforms can downgrade gracefully (design \xa77)"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Tracking:"})," Add integration tests for cross-version pack loading once save migration lands (Phase 4)."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"55-transform-loops",children:"5.5 Transform Loops"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Risk:"})," Misconfigured transforms may create runaway production chains."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Mitigation Status:"})," \u2705 ",(0,t.jsx)(n.strong,{children:"IMPLEMENTED"})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Safety guards in transform schema (transforms.ts):","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"maxRunsPerTick"})," caps executions per simulation step"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"maxOutstandingBatches"})," limits queued batch transforms"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:"Validation ensures transform I/O references exist (validateCrossReferences)"}),"\n",(0,t.jsx)(n.li,{children:"Cycle detection for unlock conditions (integration tests pending per integration.test.ts:155)"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Tracking:"})," Complete cycle detection implementation (currently TODO comment in integration.test.ts)."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Action Item (Issue #142 recommended):"})}),"\n",(0,t.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Implement full cycle detection for transform chains (extend existing unlock cycle detector)"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Add integration tests for circular transform references"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Document safe transform patterns in authoring guide"]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"56-performance",children:"5.6 Performance"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Risk:"})," Running complex validation on large content packs could be slow."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Mitigation Status:"})," \u26a0\ufe0f ",(0,t.jsx)(n.strong,{children:"DESIGN ONLY"})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Design recommends caching normalized results (\xa77)"}),"\n",(0,t.jsx)(n.li,{children:"Lookup maps included in NormalizedContentPack (pack.ts:142-173)"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Current Performance:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"No caching implemented yet"}),"\n",(0,t.jsx)(n.li,{children:"No performance benchmarks exist"}),"\n",(0,t.jsx)(n.li,{children:"No large content packs to test against"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Action Items (Issue #143 recommended - Phase 6):"})}),"\n",(0,t.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Implement validation result caching (memoize by pack id + version + digest)"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Add performance benchmarks for validation (target: under 100ms for packs with 100+ entities)"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Create large test pack (500+ resources, 200+ generators) for performance testing"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Profile validation bottlenecks (cross-reference checks, formula walking, cycle detection)"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Consider worker-based validation for large packs if main-thread blocking observed"]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"6-property-based-formula-sanitization-guidance",children:"6. Property-Based Formula Sanitization Guidance"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Property-based suites now gate formula authoring across schema and CLI surfaces; use the workflow below before submitting new packs or modifiers."}),"\n",(0,t.jsxs)(n.li,{children:["Guidance complements ",(0,t.jsx)(n.code,{children:"docs/property-based-formula-sanitization-design.md"})," and the CLI runbook in ",(0,t.jsx)(n.code,{children:"docs/content-validation-cli-design.md"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"sanitization-invariants-enforced",children:"Sanitization Invariants Enforced"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Formulas generated by ",(0,t.jsx)(n.code,{children:"createFormulaArbitrary"})," must parse successfully and evaluate to finite, non-negative numbers across deterministic evaluation contexts."]}),"\n",(0,t.jsxs)(n.li,{children:["Linear and exponential formulas are asserted to be monotonic in the ",(0,t.jsx)(n.code,{children:"level"})," variable, with growth rates clamped to positive ranges even when callers provide invalid bounds."]}),"\n",(0,t.jsxs)(n.li,{children:["Piecewise formulas require ordered ",(0,t.jsx)(n.code,{children:"untilLevel"})," thresholds and terminate with a catch-all segment so sanitizers never fall off the range of defined pieces."]}),"\n",(0,t.jsxs)(n.li,{children:["Expression arbitraries guard depth, root degree, and composed function usage so sanitizers keep results within ",(0,t.jsx)(n.code,{children:"MAX_FORMULA_DEPTH"})," and preserve non-negative outputs via ",(0,t.jsx)(n.code,{children:"max(0, \u2026)"})," guards."]}),"\n",(0,t.jsxs)(n.li,{children:["Entity references are validated against sanitized pools; the CLI suite rejects packs that point to undefined resources and emits actionable ",(0,t.jsx)(n.code,{children:"content_pack.validation_failed"})," payloads."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"running-the-property-suites-locally",children:"Running the Property Suites Locally"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Schema coverage:\\","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"pnpm --filter @idle-engine/content-schema test -- --run createFormulaArbitrary\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["CLI coverage:\\","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'pnpm --filter @idle-engine/content-validation-cli test -- --run "validateContentPacks property"\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Append ",(0,t.jsx)(n.code,{children:"--watch"})," while iterating, and keep reporters quiet so the ",(0,t.jsx)(n.code,{children:"vitest-llm-reporter"})," JSON summary remains the final console line for downstream agents."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"troubleshooting--replay-tips",children:"Troubleshooting & Replay Tips"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Both suites share ",(0,t.jsx)(n.code,{children:"DEFAULT_FORMULA_PROPERTY_SEED = 177013"})," (see ",(0,t.jsx)(n.code,{children:"packages/content-schema/src/base/formulas.arbitraries.ts"}),"); fast-check prints the failing seed and path whenever a counterexample is found."]}),"\n",(0,t.jsxs)(n.li,{children:["Copy the printed ",(0,t.jsx)(n.code,{children:"seed"})," and ",(0,t.jsx)(n.code,{children:"path"})," back into the local ",(0,t.jsx)(n.code,{children:"propertyConfig"})," helper (or temporarily override the exported constant) to replay the failing run with ",(0,t.jsx)(n.code,{children:"vitest"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Inspect CLI failures via the captured ",(0,t.jsx)(n.code,{children:"content_pack.validation_failed"})," event\u2014it contains the pack slug, manifest path, and schema issues array surfaced by ",(0,t.jsx)(n.code,{children:"ContentPackValidationError"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Schema-side failures surface the counterexample formula in the stack trace; evaluate it with ",(0,t.jsx)(n.code,{children:"evaluateNumericFormula"})," in a REPL to confirm which invariant was violated."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"open-questions--owners",children:"Open Questions & Owners"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Topic"}),(0,t.jsx)(n.th,{children:"Owner"}),(0,t.jsx)(n.th,{children:"Target Review"}),(0,t.jsx)(n.th,{children:"Tracking"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Long-term maintenance of shared formula arbitraries"}),(0,t.jsx)(n.td,{children:"Content Pipeline Maintainers"}),(0,t.jsx)(n.td,{children:"Implementation Plan Phase 2 exit (2025-11-15)"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"docs/property-based-formula-sanitization-design.md#13-open-questions"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Prestige-layer monotonicity requirements"}),(0,t.jsx)(n.td,{children:"Game Design Lead"}),(0,t.jsx)(n.td,{children:"Align with Prestige roadmap checkpoint (2025-12-01)"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"docs/property-based-formula-sanitization-design.md#13-open-questions"})})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"references-for-downstream-agents",children:"References for Downstream Agents"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Schema suite: ",(0,t.jsx)(n.code,{children:"packages/content-schema/src/base/formulas.property.test.ts"})]}),"\n",(0,t.jsxs)(n.li,{children:["Arbitrary definitions: ",(0,t.jsx)(n.code,{children:"packages/content-schema/src/base/formulas.arbitraries.ts"})]}),"\n",(0,t.jsxs)(n.li,{children:["CLI suite: ",(0,t.jsx)(n.code,{children:"tools/content-schema-cli/src/__tests__/validation.property.test.ts"})]}),"\n",(0,t.jsxs)(n.li,{children:["Design rationale: ",(0,t.jsx)(n.code,{children:"docs/property-based-formula-sanitization-design.md"})]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"7-summary--recommendations",children:"7. Summary & Recommendations"}),"\n",(0,t.jsx)(n.h3,{id:"decisions-made",children:"Decisions Made"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Icon defaults:"})," Leave to compiler/presentation layer"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Guild persistence:"})," Defer to Phase 5, extend schema then"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Scripted modifiers:"})," Defer until scripting design + sandbox land"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Digest migration:"})," Embed version + digest in save files (hybrid approach)"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Risk tracking:"})," Most mitigations implemented; gaps documented below"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"new-issues-to-create",children:"New Issues to Create"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Issue"}),(0,t.jsx)(n.th,{children:"Title"}),(0,t.jsx)(n.th,{children:"Priority"}),(0,t.jsx)(n.th,{children:"Blocking"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"#138"}),(0,t.jsx)(n.td,{children:"Design guild persistence schema and extend cost model"}),(0,t.jsx)(n.td,{children:"P2"}),(0,t.jsx)(n.td,{children:"Phase 5"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"#139"}),(0,t.jsx)(n.td,{children:"Scripting design document and scripted effect support"}),(0,t.jsx)(n.td,{children:"P3"}),(0,t.jsx)(n.td,{children:"Post-prototype"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"#140"}),(0,t.jsx)(n.td,{children:"Save file format with content pack manifests and migrations"}),(0,t.jsx)(n.td,{children:"P1"}),(0,t.jsx)(n.td,{children:"Phase 4"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"#141"}),(0,t.jsx)(n.td,{children:"CI schema compatibility checks for runtime releases"}),(0,t.jsx)(n.td,{children:"P1"}),(0,t.jsx)(n.td,{children:"Pre-v1.0"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"#142"}),(0,t.jsx)(n.td,{children:"Complete cycle detection for transform chains"}),(0,t.jsx)(n.td,{children:"P2"}),(0,t.jsx)(n.td,{children:"Phase 3"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"#143"}),(0,t.jsx)(n.td,{children:"Validation performance benchmarks and caching"}),(0,t.jsx)(n.td,{children:"P2"}),(0,t.jsx)(n.td,{children:"Phase 6"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"phase-2-unblocked",children:"Phase 2 Unblocked"}),"\n",(0,t.jsx)(n.p,{children:"Content schema is ready for production use in Phase 2 (Content DSL & Sample Pack, Weeks 2-4). Remaining work items are follow-ups for later phases or post-prototype features."}),"\n",(0,t.jsx)(n.h3,{id:"traceability-to-issue-11",children:"Traceability to Issue #11"}),"\n",(0,t.jsx)(n.p,{children:"This decision log addresses:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u2705 Section 10 open questions (all 4 questions + migration clarification)"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Section 7 risk mitigations (tracking status for all 6 risks)"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Acceptance criteria: Decision log exists with recommendations"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Findings linked back to parent issue #11 via references and new issue tracking"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"next-actions",children:"Next Actions"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Create tracking issues (#138-143) with details from this document"}),"\n",(0,t.jsx)(n.li,{children:"Link new issues to #11 as dependencies"}),"\n",(0,t.jsx)(n.li,{children:"Update implementation-plan.md Phase 5+ backlog with new tasks"}),"\n",(0,t.jsx)(n.li,{children:"Close issue #137 referencing this decision log"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}}}]);