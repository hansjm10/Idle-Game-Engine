"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[3581],{213:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>d,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"issue-847-design","title":"renderer-webgpu: investigate writeBuffer size validation error (Issue 847)","description":"Document Control","source":"@site/../../docs/issue-847-design.md","sourceDirName":".","slug":"/issue-847-design","permalink":"/Idle-Game-Engine/issue-847-design","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/issue-847-design.md","tags":[],"version":"current","sidebarPosition":99,"frontMatter":{"title":"renderer-webgpu: investigate writeBuffer size validation error (Issue 847)","sidebar_position":99}}');var r=s(5270),t=s(7678);const d={title:"renderer-webgpu: investigate writeBuffer size validation error (Issue 847)",sidebar_position:99},l="renderer-webgpu: investigate writeBuffer size validation error (Issue 847)",c={},o=[{value:"Document Control",id:"document-control",level:2},{value:"1. Summary",id:"1-summary",level:2},{value:"2. Findings",id:"2-findings",level:2},{value:"3. Decision",id:"3-decision",level:2},{value:"4. Design Alignment",id:"4-design-alignment",level:2},{value:"5. Verification Plan",id:"5-verification-plan",level:2},{value:"6. Follow-Up",id:"6-follow-up",level:2},{value:"7. References",id:"7-references",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"renderer-webgpu-investigate-writebuffer-size-validation-error-issue-847",children:"renderer-webgpu: investigate writeBuffer size validation error (Issue 847)"})}),"\n",(0,r.jsx)(n.h2,{id:"document-control",children:"Document Control"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Title"}),": Investigate root cause of WebGPU ",(0,r.jsx)(n.code,{children:"writeBuffer"}),' "Number of bytes to write is too large" error']}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Authors"}),": Codex (AI)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Reviewers"}),": @hansjm10"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Status"}),": Draft"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Last Updated"}),": 2026-02-19"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Related Issues"}),": ",(0,r.jsx)(n.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/847",children:"https://github.com/hansjm10/Idle-Game-Engine/issues/847"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Execution Mode"}),": AI-led"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"1-summary",children:"1. Summary"}),"\n",(0,r.jsxs)(n.p,{children:["Issue #847 reports intermittent WebGPU device loss with:\n",(0,r.jsx)(n.code,{children:"Failed to execute 'writeBuffer' on 'GPUQueue': Number of bytes to write is too large"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["The root cause is unit mismatch in ",(0,r.jsx)(n.code,{children:"GPUQueue.writeBuffer(...)"})," arguments when uploading instance data from a ",(0,r.jsx)(n.code,{children:"Float32Array"}),". The renderer passed ",(0,r.jsx)(n.code,{children:"usedBytes"})," as ",(0,r.jsx)(n.code,{children:"size"}),", but for typed-array uploads WebGPU interprets ",(0,r.jsx)(n.code,{children:"size"})," in ",(0,r.jsx)(n.strong,{children:"elements"}),", not bytes. This could request 4x more data than intended on ",(0,r.jsx)(n.code,{children:"Float32Array"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"2-findings",children:"2. Findings"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Upload path: ",(0,r.jsx)(n.code,{children:"packages/renderer-webgpu/src/webgpu-renderer.ts"})," ",(0,r.jsx)(n.code,{children:"#flushQuadBatch()"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Previous call shape:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"queue.writeBuffer(instanceBuffer, 0, batchBufferFloat32, 0, usedBytes)"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["With ",(0,r.jsx)(n.code,{children:"Float32Array"}),", that means:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["intended bytes: ",(0,r.jsx)(n.code,{children:"usedBytes"})]}),"\n",(0,r.jsxs)(n.li,{children:["interpreted bytes: ",(0,r.jsx)(n.code,{children:"usedBytes * Float32Array.BYTES_PER_ELEMENT"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Example from existing quad tests:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["22 instances => ",(0,r.jsx)(n.code,{children:"usedBytes = 22 * 52 = 1144"})]}),"\n",(0,r.jsxs)(n.li,{children:["incorrect interpreted write size => ",(0,r.jsx)(n.code,{children:"1144 * 4 = 4576"})," bytes"]}),"\n",(0,r.jsx)(n.li,{children:"destination GPU instance buffer may be smaller (e.g. 2048 bytes), which triggers the exact validation error."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"3-decision",children:"3. Decision"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Keep the typed-array upload path (no per-frame allocation/copy)."}),"\n",(0,r.jsxs)(n.li,{children:["Pass ",(0,r.jsx)(n.code,{children:"lengthFloats"})," (element count) as ",(0,r.jsx)(n.code,{children:"size"})," for ",(0,r.jsx)(n.code,{children:"Float32Array"})," uploads."]}),"\n",(0,r.jsx)(n.li,{children:"Add regression coverage that simulates strict validation semantics and fails if byte counts are passed as element counts."}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["This is a targeted, long-term fix and avoids the extra allocation overhead of converting every upload into a new exact-size ",(0,r.jsx)(n.code,{children:"ArrayBuffer"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"4-design-alignment",children:"4. Design Alignment"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"docs/desktop-shell-webgpu-renderer-replay-design-issue-778.md"})," expects robust renderer behavior under WebGPU runtime variance and device-loss scenarios."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"docs/issue-846-design.md"})," favors explicit handling of backend validation differences and regression tests to prevent recurrence."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"The Issue #847 fix aligns with both by encoding API semantics directly in the upload path and test suite."}),"\n",(0,r.jsx)(n.h2,{id:"5-verification-plan",children:"5. Verification Plan"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Unit tests in ",(0,r.jsx)(n.code,{children:"@idle-engine/renderer-webgpu"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"validate instance upload argument semantics,"}),"\n",(0,r.jsx)(n.li,{children:"preserve batching behavior and instance payload correctness."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Standard package checks:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"pnpm --filter @idle-engine/renderer-webgpu test"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"pnpm --filter @idle-engine/renderer-webgpu lint"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"pnpm --filter @idle-engine/renderer-webgpu build"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"6-follow-up",children:"6. Follow-Up"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["If future code paths use typed-array ",(0,r.jsx)(n.code,{children:"writeBuffer"})," with explicit ",(0,r.jsx)(n.code,{children:"size"}),", enforce the same element/byte rule in helper utilities or shared upload wrappers."]}),"\n",(0,r.jsx)(n.li,{children:"Keep a focused regression test around this API contract to avoid reintroducing byte/element confusion."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"7-references",children:"7. References"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Issue #847: ",(0,r.jsx)(n.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/847",children:"https://github.com/hansjm10/Idle-Game-Engine/issues/847"})]}),"\n",(0,r.jsxs)(n.li,{children:["WebGPU ",(0,r.jsx)(n.code,{children:"GPUQueue.writeBuffer"})," semantics (typed-array ",(0,r.jsx)(n.code,{children:"size"})," unit): ",(0,r.jsx)(n.a,{href:"https://www.w3.org/TR/2022/WD-webgpu-20220608/#dom-gpuqueue-writebuffer",children:"https://www.w3.org/TR/2022/WD-webgpu-20220608/#dom-gpuqueue-writebuffer"})]}),"\n",(0,r.jsxs)(n.li,{children:["Renderer file: ",(0,r.jsx)(n.code,{children:"packages/renderer-webgpu/src/webgpu-renderer.ts"})]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},7678:(e,n,s)=>{s.d(n,{R:()=>d,x:()=>l});var i=s(9430);const r={},t=i.createContext(r);function d(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);