"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[929],{7678:(e,s,n)=>{n.d(s,{R:()=>l,x:()=>d});var i=n(9430);const r={},t=i.createContext(r);function l(e){const s=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function d(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),i.createElement(t.Provider,{value:s},e.children)}},9282:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>o,contentTitle:()=>d,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"shell-state-provider-design","title":"Implement Shell State Provider Context","description":"Issue: #17 \u2014 Shell state provider context","source":"@site/../../docs/shell-state-provider-design.md","sourceDirName":".","slug":"/shell-state-provider-design","permalink":"/Idle-Game-Engine/shell-state-provider-design","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/shell-state-provider-design.md","tags":[],"version":"current","frontMatter":{}}');var r=n(5270),t=n(7678);const l={},d="Implement Shell State Provider Context",o={},c=[{value:"Document Control",id:"document-control",level:2},{value:"1. Summary",id:"1-summary",level:2},{value:"2. Context &amp; Problem Statement",id:"2-context--problem-statement",level:2},{value:"3. Goals &amp; Non-Goals",id:"3-goals--non-goals",level:2},{value:"4. Stakeholders, Agents &amp; Impacted Surfaces",id:"4-stakeholders-agents--impacted-surfaces",level:2},{value:"5. Current State",id:"5-current-state",level:2},{value:"6. Proposed Solution",id:"6-proposed-solution",level:2},{value:"6.1 Architecture Overview",id:"61-architecture-overview",level:3},{value:"6.2 Detailed Design",id:"62-detailed-design",level:3},{value:"6.3 Operational Considerations",id:"63-operational-considerations",level:3},{value:"7. Work Breakdown &amp; Delivery Plan",id:"7-work-breakdown--delivery-plan",level:2},{value:"7.1 Issue Map",id:"71-issue-map",level:3},{value:"7.2 Milestones",id:"72-milestones",level:3},{value:"7.3 Coordination Notes",id:"73-coordination-notes",level:3},{value:"8. Agent Guidance &amp; Guardrails",id:"8-agent-guidance--guardrails",level:2},{value:"9. Alternatives Considered",id:"9-alternatives-considered",level:2},{value:"10. Testing &amp; Validation Plan",id:"10-testing--validation-plan",level:2},{value:"11. Risks &amp; Mitigations",id:"11-risks--mitigations",level:2},{value:"12. Rollout Plan",id:"12-rollout-plan",level:2},{value:"13. Resolved Questions",id:"13-resolved-questions",level:2},{value:"14. Follow-Up Work",id:"14-follow-up-work",level:2},{value:"15. References",id:"15-references",level:2},{value:"Appendix A \u2014 Glossary",id:"appendix-a--glossary",level:2},{value:"Appendix B \u2014 Change Log",id:"appendix-b--change-log",level:2}];function a(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"implement-shell-state-provider-context",children:"Implement Shell State Provider Context"})}),"\n",(0,r.jsx)(s.p,{children:"Issue: #17 \u2014 Shell state provider context"}),"\n",(0,r.jsx)(s.h2,{id:"document-control",children:"Document Control"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Title"}),": Establish shell state provider and context for presentation layer"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Authors"}),": Idle Engine Design Authoring Agent (AI)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Reviewers"}),": TODO (Presentation Shell Lead)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Status"}),": Approved"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Last Updated"}),": 2025-10-31"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Related Issues"}),": ",(0,r.jsx)(s.a,{href:"https://github.com/hansjm10/Idle-Game-Engine/issues/17",children:"#17"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Execution Mode"}),": AI-led"]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"1-summary",children:"1. Summary"}),"\n",(0,r.jsxs)(s.p,{children:["This proposal defines a ",(0,r.jsx)(s.code,{children:"ShellStateProvider"})," and matching React context that centralise runtime snapshots, command dispatch, and diagnostics exposure for the presentation shell. A memoised state store wraps the existing worker bridge so every shell surface consumes deterministic engine data without duplicating glue code."]}),"\n",(0,r.jsx)(s.p,{children:"The provider formalises derived data such as event history and back-pressure analytics, exposes typed hooks for state/actions, and documents how downstream modules integrate with the shared context."}),"\n",(0,r.jsx)(s.h2,{id:"2-context--problem-statement",children:"2. Context & Problem Statement"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Background"}),": The shell currently relies on ad-hoc hooks to subscribe to runtime ticks (",(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/App.tsx:38"}),") and transform event payloads before handing them to panels like ",(0,r.jsx)(s.code,{children:"EventInspector"})," (",(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/EventInspector.tsx:12"}),"). The worker bridge design (",(0,r.jsx)(s.code,{children:"docs/runtime-react-worker-bridge-design.md:1"}),") documents message contracts, and the implementation plan (",(0,r.jsx)(s.code,{children:"docs/implementation-plan.md:105"}),") has long called for a dedicated context to host engine state."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Problem"}),": Components instantiate their own stores, duplicate event sorting, and risk race conditions when multiple subscribers call ",(0,r.jsx)(s.code,{children:"restoreSession()"})," on ",(0,r.jsx)(s.code,{children:"WorkerBridgeImpl"})," (",(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/worker-bridge.ts:310"}),"). The fragmentation slows feature work, complicates telemetry, and blocks reuse across future UI surfaces."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Forces"}),": The solution must honour deterministic ordering rules from the runtime worker (",(0,r.jsx)(s.code,{children:"packages/shell-web/src/runtime.worker.ts:153"}),"), stay compatible with existing analytics hooks (",(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/shell-analytics.ts:49"}),"), and leave space for planned persistence features described in ",(0,r.jsx)(s.code,{children:"docs/implementation-plan.md:60"}),"."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"3-goals--non-goals",children:"3. Goals & Non-Goals"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Goals"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Deliver a ",(0,r.jsx)(s.code,{children:"ShellStateProvider"})," that owns the worker lifecycle, session restore, and bounded event history aggregation (target 200 snapshots, configurable) for downstream consumers."]}),"\n",(0,r.jsxs)(s.li,{children:["Expose typed hooks (",(0,r.jsx)(s.code,{children:"useShellState"}),", ",(0,r.jsx)(s.code,{children:"useShellBridge"}),", ",(0,r.jsx)(s.code,{children:"useShellDiagnostics"}),") that wrap worker interactions with consistent error telemetry."]}),"\n",(0,r.jsx)(s.li,{children:"Document the provider contract so future design work referencing the shell state provider/context stays aligned."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Non-Goals"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Alter runtime command semantics or worker message formats (covered by ",(0,r.jsx)(s.code,{children:"docs/runtime-react-worker-bridge-design.md:15"}),")."]}),"\n",(0,r.jsx)(s.li,{children:"Ship visual redesigns or new panels; this effort only supplies shared state plumbing."}),"\n",(0,r.jsxs)(s.li,{children:["Implement persistence storage or offline replay (reserved for later phases in ",(0,r.jsx)(s.code,{children:"docs/implementation-plan.md:60"}),")."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"4-stakeholders-agents--impacted-surfaces",children:"4. Stakeholders, Agents & Impacted Surfaces"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Primary Stakeholders"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Presentation Shell workstream coordinating shared UI state."}),"\n",(0,r.jsx)(s.li,{children:"Runtime Core maintainers ensuring deterministic snapshots."}),"\n",(0,r.jsx)(s.li,{children:"Developer Experience owners enforcing lint/test automation."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Agent Roles"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Shell State Provider Implementation Agent \u2014 builds provider, reducer, and context exposure."}),"\n",(0,r.jsxs)(s.li,{children:["Shell Integration Migration Agent \u2014 replaces ad-hoc state in ",(0,r.jsx)(s.code,{children:"App"})," and future modules with context consumers."]}),"\n",(0,r.jsx)(s.li,{children:"Observability & QA Agent \u2014 extends analytics hooks and adds Vitest coverage."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Affected Packages/Services"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/App.tsx"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/worker-bridge.ts"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/SocialDevPanel.tsx"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/EventInspector.tsx"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Compatibility Considerations"}),":","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Preserve worker schema version negotiation (",(0,r.jsx)(s.code,{children:"@idle-engine/runtime-bridge-contracts"}),")."]}),"\n",(0,r.jsxs)(s.li,{children:["Maintain telemetry facade guarantees for errors emitted during provider init (",(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/shell-analytics.ts:76"}),")."]}),"\n",(0,r.jsxs)(s.li,{children:["Avoid breaking tests reliant on ",(0,r.jsx)(s.code,{children:"window.__IDLE_WORKER_BRIDGE__"})," debugging handles (",(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/worker-bridge.ts:635"}),")."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"5-current-state",children:"5. Current State"}),"\n",(0,r.jsxs)(s.p,{children:["The shell instantiates ",(0,r.jsx)(s.code,{children:"WorkerBridgeImpl"})," inside ",(0,r.jsx)(s.code,{children:"useWorkerBridge"})," and stores the singleton on ",(0,r.jsx)(s.code,{children:"window"})," for inspection (",(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/worker-bridge.ts:622"}),"). ",(0,r.jsx)(s.code,{children:"App.tsx"})," manually handles session restore, state subscription, and event history management (",(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/App.tsx:24"}),"), while social commands dispatch directly from ",(0,r.jsx)(s.code,{children:"SocialDevPanel"})," (",(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/SocialDevPanel.tsx:38"}),"). No shared context exists, forcing each component to recreate listeners and derive the same secondary data. The worker bridge spec (",(0,r.jsx)(s.code,{children:"docs/runtime-react-worker-bridge-design.md:18"}),") notes that a context was deferred pending this design."]}),"\n",(0,r.jsx)(s.h2,{id:"6-proposed-solution",children:"6. Proposed Solution"}),"\n",(0,r.jsx)(s.h3,{id:"61-architecture-overview",children:"6.1 Architecture Overview"}),"\n",(0,r.jsxs)(s.p,{children:["Introduce a layered architecture in which a ",(0,r.jsx)(s.code,{children:"ShellStateStore"})," encapsulates reducer-driven state derived from worker snapshots, a ",(0,r.jsx)(s.code,{children:"ShellStateProvider"})," component owns the worker instance and subscriptions, and memoised selectors feed React contexts for state and actions. Consumers import hooks instead of touching ",(0,r.jsx)(s.code,{children:"WorkerBridgeImpl"})," directly, while diagnostics and social operations remain proxied through provider-bound closures. A follow-up diagram will outline event flow through the provider."]}),"\n",(0,r.jsx)(s.h3,{id:"62-detailed-design",children:"6.2 Detailed Design"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Runtime Changes"}),": No structural updates to the runtime worker; the provider listens to ",(0,r.jsx)(s.code,{children:"STATE_UPDATE"})," envelopes already emitted (",(0,r.jsx)(s.code,{children:"packages/shell-web/src/runtime.worker.ts:162"}),"). Guardrails ensure provider consumers cannot mutate runtime state directly."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Data & Schemas"}),": Define ",(0,r.jsx)(s.code,{children:"ShellState"})," with fields for ",(0,r.jsx)(s.code,{children:"runtime"})," (step, events, backPressure, and the latest ",(0,r.jsx)(s.code,{children:"lastSnapshot"})," pointer), ",(0,r.jsx)(s.code,{children:"bridge"})," (ready flags, lastUpdateAt, error queue), and ",(0,r.jsx)(s.code,{children:"social"})," (pending request map plus the most recent ",(0,r.jsx)(s.code,{children:"lastFailure"})," metadata). Move the ",(0,r.jsx)(s.code,{children:"MAX_EVENT_HISTORY"})," constant from ",(0,r.jsx)(s.code,{children:"App.tsx:13"})," into the provider with configurability via props. Type definitions live in ",(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/shell-state.types.ts"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"APIs & Contracts"}),": Export ",(0,r.jsx)(s.code,{children:"ShellStateProvider"}),", ",(0,r.jsx)(s.code,{children:"useShellState"}),", ",(0,r.jsx)(s.code,{children:"useShellBridge"}),", and ",(0,r.jsx)(s.code,{children:"useShellDiagnostics"}),". Hooks throw descriptive errors if misused outside the provider. Session restore fires once during provider mount, respecting existing ",(0,r.jsx)(s.code,{children:"WorkerBridge"})," promise semantics. Social commands resolve through provider-managed ",(0,r.jsx)(s.code,{children:"pendingRequests"})," to expose optimistic UI state mirroring ",(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/worker-bridge.ts:340"}),". ",(0,r.jsx)(s.code,{children:"runtime.lastSnapshot"})," remains ",(0,r.jsx)(s.code,{children:"undefined"})," until the first ",(0,r.jsx)(s.code,{children:"STATE_UPDATE"}),", then mirrors the latest reducer snapshot so consumers can derive memoised selectors. ",(0,r.jsx)(s.code,{children:"social.lastFailure"})," surfaces the last failed request and persists until a subsequent failure overwrites it, allowing telemetry to inspect the most recent error without implicitly clearing on success."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Tooling & Automation"}),": Add Vitest suites covering reducer transitions, event history bounds, and error propagation. Extend analytics tests (",(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/shell-analytics.test.ts"}),") with provider-driven telemetry assertions. Update any stories or samples to mount components under the provider."]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"63-operational-considerations",children:"6.3 Operational Considerations"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Deployment"}),": No CI pipeline changes; provider ships within ",(0,r.jsx)(s.code,{children:"@idle-engine/shell-web"}),". Ensure build output stays in sync with checked-in ",(0,r.jsx)(s.code,{children:"dist/"})," artefacts (read-only per guidelines)."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Telemetry & Observability"}),": Route provider errors to ",(0,r.jsx)(s.code,{children:"recordTelemetryError"})," (",(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/worker-bridge.ts:280"}),") to keep analytics consistent. Emit structured console warnings when context usage is invalid."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Security & Compliance"}),": Maintain existing social command token handling (",(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/SocialDevPanel.tsx:44"}),"). Provider must not persist tokens in global state; they remain per-component to honour auth boundaries."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"7-work-breakdown--delivery-plan",children:"7. Work Breakdown & Delivery Plan"}),"\n",(0,r.jsx)(s.h3,{id:"71-issue-map",children:"7.1 Issue Map"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Issue Title"}),(0,r.jsx)(s.th,{children:"Scope Summary"}),(0,r.jsx)(s.th,{children:"Proposed Assignee/Agent"}),(0,r.jsx)(s.th,{children:"Dependencies"}),(0,r.jsx)(s.th,{children:"Acceptance Criteria"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"feat(shell-web): scaffold shell state provider"}),(0,r.jsx)(s.td,{children:"Implement provider, reducer, contexts, and initial tests."}),(0,r.jsx)(s.td,{children:"Shell State Provider Implementation Agent"}),(0,r.jsx)(s.td,{children:"Approval of this design"}),(0,r.jsx)(s.td,{children:"Reducer unit tests pass; provider exports documented; no lint violations."})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"feat(shell-web): migrate shell modules to provider"}),(0,r.jsxs)(s.td,{children:["Rewire ",(0,r.jsx)(s.code,{children:"App"}),", ",(0,r.jsx)(s.code,{children:"EventInspector"}),", and ",(0,r.jsx)(s.code,{children:"SocialDevPanel"})," to consume the context."]}),(0,r.jsx)(s.td,{children:"Shell Integration Migration Agent"}),(0,r.jsx)(s.td,{children:"Provider scaffold issue"}),(0,r.jsx)(s.td,{children:"UI renders unchanged; manual smoke run verifies commands/events."})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"test(shell-web): expand diagnostics & telemetry coverage"}),(0,r.jsx)(s.td,{children:"Add Vitest suites and telemetry assertions to validate provider instrumentation."}),(0,r.jsx)(s.td,{children:"Observability & QA Agent"}),(0,r.jsx)(s.td,{children:"Provider scaffold issue"}),(0,r.jsx)(s.td,{children:"Vitest suites stable; reporter JSON preserved; analytics warnings verified."})]})]})]}),"\n",(0,r.jsx)(s.h3,{id:"72-milestones",children:"7.2 Milestones"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Phase 1"}),": Provider scaffolding approved \u2192 PR merged \u2192 unit tests green (target two working days)."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Phase 2"}),": Consumer migration and diagnostics coverage complete \u2192 accessibility smoke test run (",(0,r.jsx)(s.code,{children:"pnpm test:a11y"}),") without regression (target next two working days)."]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"73-coordination-notes",children:"7.3 Coordination Notes"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Hand-off Package"}),": Share this design, the worker bridge spec (",(0,r.jsx)(s.code,{children:"docs/runtime-react-worker-bridge-design.md:1"}),"), and relevant code pointers (",(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/worker-bridge.ts:622"}),", ",(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/App.tsx:15"}),")."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Communication Cadence"}),": Daily async updates in the Presentation Shell channel; design checkpoints at provider PR open/merge; escalate blockers to the Presentation Shell Lead."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"8-agent-guidance--guardrails",children:"8. Agent Guidance & Guardrails"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Context Packets"}),": Agents must review this design, ",(0,r.jsx)(s.code,{children:"docs/runtime-react-worker-bridge-design.md:15"}),", and ",(0,r.jsx)(s.code,{children:"docs/resource-state-storage-design.md:1"})," before coding."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Prompting & Constraints"}),": Use the canonical prompt \u201cImplement ShellStateProvider per Issue #17; follow repo lint/test scripts.\u201d Enforce conventional commits (",(0,r.jsx)(s.code,{children:"feat(shell-web): \u2026"}),")."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Safety Rails"}),": Do not modify ",(0,r.jsx)(s.code,{children:"dist/"})," artefacts; avoid destructive git commands; keep telemetry facade intact; respect ",(0,r.jsx)(s.code,{children:"MAX_EVENT_HISTORY"})," configurability."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Validation Hooks"}),": Run ",(0,r.jsx)(s.code,{children:"pnpm lint"}),", ",(0,r.jsx)(s.code,{children:"pnpm test --filter shell-web"}),", and ",(0,r.jsx)(s.code,{children:"pnpm test:a11y"})," before completion; ensure the Vitest reporter JSON remains unmodified."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"9-alternatives-considered",children:"9. Alternatives Considered"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Status Quo per-component state"}),": Rejected due to duplicated logic, inconsistent event ordering, and harder persistence integration."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"External state manager (Redux/Zustand)"}),": Adds dependencies and complicates deterministic replay; provider pattern keeps footprint minimal."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Worker-driven push to global store"}),": Would bypass React lifecycle, risking stale renders and race conditions; context ensures controlled updates."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"10-testing--validation-plan",children:"10. Testing & Validation Plan"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Unit / Integration"}),": Add reducer tests in ",(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/__tests__/shell-state-provider.test.ts"}),"; component integration test mounting ",(0,r.jsx)(s.code,{children:"App"})," under the provider verifies event rendering."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Performance"}),": Measure provider update latency by logging reducer timing in development; ensure no additional allocations beyond existing ",(0,r.jsx)(s.code,{children:"MAX_EVENT_HISTORY"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Tooling / A11y"}),": Re-run ",(0,r.jsx)(s.code,{children:"pnpm test:a11y"})," after migration to confirm provider does not disrupt Playwright smoke flows (",(0,r.jsx)(s.code,{children:"docs/accessibility-smoke-tests-design.md:4"}),")."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"11-risks--mitigations",children:"11. Risks & Mitigations"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Risk"}),": Provider re-renders too frequently, impacting performance. ",(0,r.jsx)(s.strong,{children:"Mitigation"}),": Split state and action contexts; memoise selectors; add React DevTools profiling."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Risk"}),": Social commands leak tokens. ",(0,r.jsx)(s.strong,{children:"Mitigation"}),": Keep access tokens in local component state; provider only handles request lifecycle metadata."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Risk"}),": Diagnostics subscriptions conflict. ",(0,r.jsx)(s.strong,{children:"Mitigation"}),": Reference-count diagnostics listeners and fall back to noop when zero subscribers remain."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"12-rollout-plan",children:"12. Rollout Plan"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Milestones"}),": Provider PR merged \u2192 consumer migration PR \u2192 QA validation."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Migration Strategy"}),": Ship provider behind a feature flag prop if needed; migrate ",(0,r.jsx)(s.code,{children:"App"})," first, then opt in additional panels; remove old state hooks once parity is confirmed."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Communication"}),": Post release notes in the Presentation Shell changelog; reference this design and Issue #17 in PR descriptions."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"13-resolved-questions",children:"13. Resolved Questions"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Event history retention"}),": Presentation Shell confirmed the provider keeps a rotating window of runtime events with a default cap of 200 entries (matching ",(0,r.jsx)(s.code,{children:"DEFAULT_MAX_EVENT_HISTORY"}),"). Consumers can override ",(0,r.jsx)(s.code,{children:"maxEventHistory"})," when mounting the provider; eviction remains FIFO to bound memory. Telemetry should log capacity hits so the persistence workstream can validate truncation behaviour."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Future persistence payloads"}),": Runtime Core agreed the provider contract exposes restore payloads via the existing ",(0,r.jsx)(s.code,{children:"restoreSession"})," API and will support optional persistence hooks in a follow-up (",(0,r.jsx)(s.code,{children:"registerPersistenceHook"}),"/",(0,r.jsx)(s.code,{children:"unregisterPersistenceHook"})," slated for the persistence milestone roadmap). This keeps the reducer state immutable today while leaving space for IndexedDB/cloud checkpoints during the persistence milestone."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Debug handle strategy"}),": DX signed off on keeping ",(0,r.jsx)(s.code,{children:"window.__IDLE_WORKER_BRIDGE__"})," behind development-only guards. Builds strip the handle in production, with an explicit ",(0,r.jsx)(s.code,{children:"__ENABLE_IDLE_DEBUG__"})," opt-in for staging diagnostics. Documentation now highlights the guardrails so automated tests relying on the handle remain unaffected."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"14-follow-up-work",children:"14. Follow-Up Work"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Schedule persistence integration design to extend the provider with save/load channels."}),"\n",(0,r.jsxs)(s.li,{children:["Publish and maintain the ",(0,r.jsx)(s.a,{href:"/Idle-Game-Engine/shell-state-provider-guide",children:"Shell State Provider Integration Guide"})," so new contributors understand provider usage."]}),"\n",(0,r.jsx)(s.li,{children:"Plan future localisation-aware selectors once UI strings are externalised."}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"15-references",children:"15. References"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/App.tsx:15"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/EventInspector.tsx:12"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/SocialDevPanel.tsx:38"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/worker-bridge.ts:622"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"packages/shell-web/src/runtime.worker.ts:153"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"@idle-engine/runtime-bridge-contracts"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"packages/core/src/events/event-bus.ts:166"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"docs/runtime-react-worker-bridge-design.md:1"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"docs/implementation-plan.md:105"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"docs/accessibility-smoke-tests-design.md:4"})}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"appendix-a--glossary",children:"Appendix A \u2014 Glossary"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"ShellStateProvider"}),": React component delivering runtime context outlined in this design."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"ShellState"}),": Aggregated snapshot data structure supplied by the provider."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"WorkerBridge"}),": Abstraction around the runtime worker enabling command/state exchange."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Back Pressure Snapshot"}),": Runtime event buffer metrics defined in ",(0,r.jsx)(s.code,{children:"packages/core/src/events/event-bus.ts:166"}),"."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"appendix-b--change-log",children:"Appendix B \u2014 Change Log"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Date"}),(0,r.jsx)(s.th,{children:"Author"}),(0,r.jsx)(s.th,{children:"Change Summary"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"2025-10-30"}),(0,r.jsx)(s.td,{children:"Idle Engine Design Authoring Agent (AI)"}),(0,r.jsx)(s.td,{children:"Initial draft."})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"2025-10-30"}),(0,r.jsx)(s.td,{children:"Idle Engine Editorial Agent (AI)"}),(0,r.jsx)(s.td,{children:"Removed directive filler and clarified context."})]})]})]})]})}function h(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}}}]);