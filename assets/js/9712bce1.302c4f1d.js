"use strict";(globalThis.webpackChunk_idle_engine_docs=globalThis.webpackChunk_idle_engine_docs||[]).push([[2281],{6853:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>o,contentTitle:()=>d,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"shell-state-provider-guide","title":"Shell State Provider Integration Guide","description":"How presentation-shell modules consume ShellStateProvider hooks, diagnostics, and social command flows.","source":"@site/../../docs/shell-state-provider-guide.md","sourceDirName":".","slug":"/shell-state-provider-guide","permalink":"/Idle-Game-Engine/shell-state-provider-guide","draft":false,"unlisted":false,"editUrl":"https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/shell-state-provider-guide.md","tags":[],"version":"current","frontMatter":{"title":"Shell State Provider Integration Guide","description":"How presentation-shell modules consume ShellStateProvider hooks, diagnostics, and social command flows."}}');var r=n(5270),t=n(7678);const l={title:"Shell State Provider Integration Guide",description:"How presentation-shell modules consume ShellStateProvider hooks, diagnostics, and social command flows."},d="Shell State Provider Integration Guide",o={},a=[{value:"Before You Start",id:"before-you-start",level:2},{value:"1. Map the Provider Surface",id:"1-map-the-provider-surface",level:2},{value:"Provider Configuration",id:"provider-configuration",level:3},{value:"Restore Payloads",id:"restore-payloads",level:3},{value:"2. Consume Runtime State",id:"2-consume-runtime-state",level:2},{value:"3. Dispatch Commands Through the Bridge",id:"3-dispatch-commands-through-the-bridge",level:2},{value:"4. Integrate Diagnostics",id:"4-integrate-diagnostics",level:2},{value:"5. Migration Checklist",id:"5-migration-checklist",level:2},{value:"6. Validation &amp; Tooling",id:"6-validation--tooling",level:2},{value:"7. Reference Summary",id:"7-reference-summary",level:2}];function c(e){const s={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"shell-state-provider-integration-guide",children:"Shell State Provider Integration Guide"})}),"\n",(0,r.jsxs)(s.p,{children:["This guide fulfils the documentation follow-up in ",(0,r.jsx)(s.a,{href:"/Idle-Game-Engine/shell-state-provider-design#14-follow-up-work",children:"docs/shell-state-provider-design.md \xa714"}),". It explains how React modules integrate with the shared Shell state context, tying every step back to the approved design so contributors can migrate safely."]}),"\n",(0,r.jsx)(s.h2,{id:"before-you-start",children:"Before You Start"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Review the design\u2019s architecture notes, especially ",(0,r.jsx)(s.a,{href:"/Idle-Game-Engine/shell-state-provider-design#62-detailed-design",children:"\xa76.2 Detailed Design"})," for API contracts and ",(0,r.jsx)(s.a,{href:"/Idle-Game-Engine/shell-state-provider-design#73-coordination-notes",children:"\xa77.3 Coordination Notes"})," for affected modules."]}),"\n",(0,r.jsxs)(s.li,{children:["Scan the migration expectations in ",(0,r.jsx)(s.a,{href:"/Idle-Game-Engine/shell-state-provider-design#12-rollout-plan",children:"\xa712 Rollout Plan"})," so your rollout matches the planned sequencing."]}),"\n",(0,r.jsxs)(s.li,{children:["Ensure local setup matches the repository guidelines (Node \u226520.10, pnpm \u22658) and that you can run ",(0,r.jsx)(s.code,{children:"pnpm lint"}),", ",(0,r.jsx)(s.code,{children:"pnpm test"}),", and ",(0,r.jsx)(s.code,{children:"pnpm test:a11y"})," without failures."]}),"\n",(0,r.jsxs)(s.li,{children:["Keep these files handy while implementing:","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/ShellStateProvider.tsx"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/shell-state.types.ts"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/shell-state-store.ts"})}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/App.tsx"})," (reference implementation)"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"1-map-the-provider-surface",children:"1. Map the Provider Surface"}),"\n",(0,r.jsxs)(s.p,{children:["The provider colocates runtime snapshots, bridge commands, diagnostics, and social metadata behind a trio of hooks. Each hook throws if used outside the provider boundary, so ensure your component tree mounts ",(0,r.jsx)(s.code,{children:"<ShellStateProvider>"})," near the shell root."]}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Hook"}),(0,r.jsx)(s.th,{children:"Purpose"}),(0,r.jsx)(s.th,{children:"Common Uses"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"useShellState()"})}),(0,r.jsx)(s.td,{children:"Exposes aggregated runtime, bridge, social, and diagnostics state."}),(0,r.jsx)(s.td,{children:"Rendering ticks, event history, back-pressure metrics, pending social requests."})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"useShellBridge()"})}),(0,r.jsxs)(s.td,{children:["Wraps worker bridge commands (",(0,r.jsx)(s.code,{children:"awaitReady"}),", ",(0,r.jsx)(s.code,{children:"sendCommand"}),", ",(0,r.jsx)(s.code,{children:"sendSocialCommand"}),", ",(0,r.jsx)(s.code,{children:"restoreSession"}),", ",(0,r.jsx)(s.code,{children:"isSocialFeatureEnabled"}),")."]}),(0,r.jsx)(s.td,{children:"Dispatch runtime commands, kick off session restore, gate social UI."})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"useShellDiagnostics()"})}),(0,r.jsx)(s.td,{children:"Manages diagnostics subscription lifecycle and mirrors diagnostics timeline state."}),(0,r.jsx)(s.td,{children:"Enable profiling panels, stream timeline updates to charts."})]})]})]}),"\n",(0,r.jsxs)(s.blockquote,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Design tie-back:"})," These hooks implement the API contract committed in ",(0,r.jsx)(s.a,{href:"/Idle-Game-Engine/shell-state-provider-design#62-detailed-design",children:"design \xa76.2"}),". Avoid importing ",(0,r.jsx)(s.code,{children:"useWorkerBridge"})," directly\u2014doing so reintroduces the fragmentation called out in the problem statement."]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"provider-configuration",children:"Provider Configuration"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"ShellStateProvider"})," accepts optional configuration that mirrors the reducer defaults in ",(0,r.jsx)(s.code,{children:"shell-state-store.ts"}),":"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-tsx",metastring:'title="packages/shell-web/src/modules/App.tsx"',children:"const EVENT_HISTORY_LIMIT = 50;\n\nexport function App() {\n  return (\n    <ShellStateProvider maxEventHistory={EVENT_HISTORY_LIMIT}>\n      <ShellAppSurface />\n    </ShellStateProvider>\n  );\n}\n"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"maxEventHistory"})," defaults to ",(0,r.jsx)(s.code,{children:"DEFAULT_MAX_EVENT_HISTORY"})," (200) and bounds the FIFO snapshot window (see ",(0,r.jsx)(s.a,{href:"/Idle-Game-Engine/shell-state-provider-design#13-resolved-questions",children:"design \xa713"}),")."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"maxErrorHistory"})," defaults to ",(0,r.jsx)(s.code,{children:"DEFAULT_MAX_ERROR_HISTORY"})," and caps telemetry-visible bridge errors."]}),"\n",(0,r.jsx)(s.li,{children:"Only tune these limits when UX requirements demand it; keep the defaults aligned with runtime determinism guarantees."}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"restore-payloads",children:"Restore Payloads"}),"\n",(0,r.jsxs)(s.p,{children:["If you need to hydrate from a saved session, pass a ",(0,r.jsx)(s.code,{children:"restorePayload"})," prop. The provider invokes ",(0,r.jsx)(s.code,{children:"restoreSession(payload)"})," on mount and again whenever the ",(0,r.jsx)(s.code,{children:"restorePayload"})," reference changes, surfacing loading state through ",(0,r.jsx)(s.code,{children:"ShellState.bridge.isRestoring"}),". Keep the payload stable (e.g., via ",(0,r.jsx)(s.code,{children:"useMemo"}),") unless you intend to trigger another restore. Catch errors via telemetry (",(0,r.jsx)(s.code,{children:"ShellStateProviderRestoreFailed"})," / ",(0,r.jsx)(s.code,{children:"ShellStateProviderRestoreEffectFailed"}),") instead of wrapping restore in component-level try/catch. This behaviour matches the session flow described in ",(0,r.jsx)(s.a,{href:"/Idle-Game-Engine/shell-state-provider-design#62-detailed-design",children:"design \xa76.2 APIs & Contracts"}),"."]}),"\n",(0,r.jsx)(s.h2,{id:"2-consume-runtime-state",children:"2. Consume Runtime State"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"ShellState.runtime"})," exposes a derived snapshot assembled in the reducer. Typical patterns:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-tsx",children:"import { useShellState } from '@idle-engine/shell-web';\n\nexport function TickCounter(): JSX.Element {\n  const {\n    runtime: { currentStep, events, backPressure },\n  } = useShellState();\n\n  return (\n    <section>\n      <h2>Runtime</h2>\n      <p>Current deterministic step: {currentStep}</p>\n      <p>Events in buffer: {events.length}</p>\n      {backPressure ? (\n        <p>Soft limited channels: {backPressure.counters.softLimited}</p>\n      ) : null}\n    </section>\n  );\n}\n"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Treat values as read-only snapshots. Mutating event payloads breaks determinism."}),"\n",(0,r.jsxs)(s.li,{children:["When you need the latest worker frame, rely on ",(0,r.jsx)(s.code,{children:"runtime.lastSnapshot"})," rather than storing your own reference."]}),"\n",(0,r.jsx)(s.li,{children:"Use the existing selectors or derive new data in memoised components\u2014avoid extending the reducer unless the design explicitly calls for it."}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"3-dispatch-commands-through-the-bridge",children:"3. Dispatch Commands Through the Bridge"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"useShellBridge()"})," wraps ",(0,r.jsx)(s.code,{children:"useWorkerBridge"})," with telemetry-aware helpers:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-tsx",children:"const bridge = useShellBridge();\n\nconst handlePing = async () => {\n  await bridge.awaitReady();\n  bridge.sendCommand('PING', { issuedAt: performance.now() });\n};\n"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Always call ",(0,r.jsx)(s.code,{children:"awaitReady()"})," before the first command or social operation to honour the worker handshake. Failed awaits raise ",(0,r.jsx)(s.code,{children:"ShellStateProviderAwaitReadyFailed"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["For social operations, prefer ",(0,r.jsx)(s.code,{children:"sendSocialCommand(kind, payload)"}),". The provider tracks optimistic state in ",(0,r.jsx)(s.code,{children:"ShellState.social.pendingRequests"})," and records telemetry if the worker responds with domain-specific errors (",(0,r.jsx)(s.code,{children:"ShellStateProviderSocialCommandFailed"}),"). Display ",(0,r.jsx)(s.code,{children:"ShellState.social.lastFailure"})," to keep the operator informed."]}),"\n",(0,r.jsxs)(s.li,{children:["When gating UI on feature availability, use ",(0,r.jsx)(s.code,{children:"bridge.isSocialFeatureEnabled()"})," rather than importing feature flags manually\u2014the bridge reflects the env toggle documented in ",(0,r.jsx)(s.a,{href:"/Idle-Game-Engine/runtime-worker-bridge-runbook#33-configuration-knobs",children:"Runtime->React Worker Bridge Runbook \xa73.3 Configuration Knobs"}),"."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"4-integrate-diagnostics",children:"4. Integrate Diagnostics"}),"\n",(0,r.jsx)(s.p,{children:"Diagnostics fan out to subscribers while the provider manages worker reference counting:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-tsx",children:"const { latest, subscribe, isEnabled } = useShellDiagnostics();\n\nuseEffect(() => {\n  const unsubscribe = subscribe((timeline) => {\n    // Render charts or persist snapshots.\n  });\n  return unsubscribe;\n}, [subscribe]);\n"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Subscribing automatically calls ",(0,r.jsx)(s.code,{children:"bridge.enableDiagnostics()"})," when the first listener registers and disables diagnostics when the last listener unsubscribes (guarding the risk listed in ",(0,r.jsx)(s.a,{href:"/Idle-Game-Engine/shell-state-provider-design#11-risks--mitigations",children:"design \xa711"}),"). Use ",(0,r.jsx)(s.code,{children:"isEnabled"})," to reflect UI state, not to skip subscription."]}),"\n",(0,r.jsxs)(s.li,{children:["Guard subscription callbacks; exceptions are reported as ",(0,r.jsx)(s.code,{children:"ShellStateProviderDiagnosticsSubscriberError"})," with phase metadata."]}),"\n",(0,r.jsxs)(s.li,{children:["Access ",(0,r.jsx)(s.code,{children:"latest"})," for immediate renders\u2014",(0,r.jsx)(s.code,{children:"subscribe"})," emits the current timeline before the worker sends updates."]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"Implementation notes"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Do not dispatch or call setState from effect cleanup functions. The provider reconciles diagnostics subscriber membership after commit using a deferred effect keyed by an internal epoch, then toggles diagnostics only on 0\u21941 transitions. This avoids React\u2019s \u201cMaximum update depth exceeded\u201d loop when panels mount/unmount quickly."}),"\n",(0,r.jsxs)(s.li,{children:["The a11y smoke suite includes a diagnostics toggle test that repeatedly opens/closes the panel and asserts no console errors. Run ",(0,r.jsx)(s.code,{children:"pnpm test:a11y"})," after changing diagnostics UI or provider internals."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"5-migration-checklist",children:"5. Migration Checklist"}),"\n",(0,r.jsx)(s.p,{children:"When upgrading an existing module:"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["Wrap the surface with ",(0,r.jsx)(s.code,{children:"<ShellStateProvider>"})," (usually in ",(0,r.jsx)(s.code,{children:"App.tsx"}),") and remove direct calls to ",(0,r.jsx)(s.code,{children:"useWorkerBridge"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["Replace custom state stores with ",(0,r.jsx)(s.code,{children:"useShellState()"})," selectors. Keep derived state colocated with components to avoid reintroducing shared mutable caches."]}),"\n",(0,r.jsx)(s.li,{children:"Swap manual telemetry hooks for the provider-managed versions\u2014telemetry payload keys already match the design\u2019s schema."}),"\n",(0,r.jsxs)(s.li,{children:["Confirm diagnostics panels use ",(0,r.jsx)(s.code,{children:"useShellDiagnostics()"})," and drop obsolete bridge ",(0,r.jsx)(s.code,{children:"enableDiagnostics()/disableDiagnostics()"})," wiring."]}),"\n",(0,r.jsxs)(s.li,{children:["Update tests to mount the provider around components under test. Reuse helpers from ",(0,r.jsx)(s.code,{children:"ShellStateProvider.telemetry.test.tsx"})," when mocking the worker."]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["This sequence mirrors the rollout plan in ",(0,r.jsx)(s.a,{href:"/Idle-Game-Engine/shell-state-provider-design#12-rollout-plan",children:"design \xa712"})," and the coordination guidance in ",(0,r.jsx)(s.a,{href:"/Idle-Game-Engine/shell-state-provider-design#73-coordination-notes",children:"\xa77.3"}),"."]}),"\n",(0,r.jsx)(s.h2,{id:"6-validation--tooling",children:"6. Validation & Tooling"}),"\n",(0,r.jsx)(s.p,{children:"After changes:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"pnpm lint --filter shell-web\npnpm test --filter shell-web\n# Run when diagnostics or UI flows change per design guardrails.\npnpm test:a11y\n"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["The Vitest suites (e.g., ",(0,r.jsx)(s.code,{children:"ShellStateProvider.telemetry.test.tsx"}),") assert telemetry coverage promised in ",(0,r.jsx)(s.a,{href:"/Idle-Game-Engine/shell-state-provider-design#62-detailed-design",children:"design \xa76.2"}),". Extend them if you introduce new reducer events or telemetry codes."]}),"\n",(0,r.jsxs)(s.li,{children:["Keep console output clean so the ",(0,r.jsx)(s.code,{children:"vitest-llm-reporter"})," summary remains parseable."]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["If you uncover provider gaps (new reducer cases, telemetry fields, or diagnostics channels), document assumptions in your PR and sync with the Presentation Shell Lead as outlined in ",(0,r.jsx)(s.a,{href:"/Idle-Game-Engine/shell-state-provider-design#73-coordination-notes",children:"design \xa77.3 Coordination Notes"}),"."]}),"\n",(0,r.jsx)(s.h2,{id:"7-reference-summary",children:"7. Reference Summary"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Topic"}),(0,r.jsx)(s.th,{children:"Source"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Provider architecture, APIs, risks"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.a,{href:"/Idle-Game-Engine/shell-state-provider-design",children:"Shell State Provider Design"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Worker bridge contracts"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.a,{href:"/Idle-Game-Engine/runtime-react-worker-bridge-design",children:"Runtime React Worker Bridge Design"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Accessibility smoke expectations"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.a,{href:"/Idle-Game-Engine/accessibility-smoke-tests-design",children:"Accessibility Smoke Tests Design"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Existing provider usage"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/App.tsx"}),", ",(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/EventInspector.tsx"}),", ",(0,r.jsx)(s.code,{children:"packages/shell-web/src/modules/SocialDevPanel.tsx"})]})]})]})]}),"\n",(0,r.jsx)(s.p,{children:"Keep this guide updated as the provider evolves so future contributors inherit current integration practices."})]})}function h(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},7678:(e,s,n)=>{n.d(s,{R:()=>l,x:()=>d});var i=n(9430);const r={},t=i.createContext(r);function l(e){const s=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function d(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),i.createElement(t.Provider,{value:s},e.children)}}}]);