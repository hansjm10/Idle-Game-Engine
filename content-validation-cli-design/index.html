<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-content-validation-cli-design" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Content Validation CLI Design Document | Idle Engine Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hansjm10.github.io/Idle-Game-Engine/content-validation-cli-design"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Content Validation CLI Design Document | Idle Engine Docs"><meta data-rh="true" name="description" content="Issue: #13"><meta data-rh="true" property="og:description" content="Issue: #13"><link data-rh="true" rel="icon" href="/Idle-Game-Engine/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hansjm10.github.io/Idle-Game-Engine/content-validation-cli-design"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/content-validation-cli-design" hreflang="en"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/content-validation-cli-design" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Content Validation CLI Design Document","item":"https://hansjm10.github.io/Idle-Game-Engine/content-validation-cli-design"}]}</script><link rel="stylesheet" href="/Idle-Game-Engine/assets/css/styles.ddf7989c.css">
<script src="/Idle-Game-Engine/assets/js/runtime~main.5d5456dd.js" defer="defer"></script>
<script src="/Idle-Game-Engine/assets/js/main.b77089c9.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Idle-Game-Engine/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_li4T" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Idle-Game-Engine/"><div class="navbar__logo"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--light_vaEm"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--dark_axH8"></div><b class="navbar__title text--truncate">Idle Engine</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Idle-Game-Engine/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle__Exw colorModeToggle_Lslw"><button class="clean-btn toggleButton_AMBK toggleButtonDisabled_p4Bd" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 lightToggleIcon_p2sk"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 darkToggleIcon_B2qX"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 systemToggleIcon_PWgn"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_RKai"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_nqaE"><div class="docsWrapper_CSLE"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sOWX" type="button"></button><div class="docRoot_qxtV"><aside class="theme-doc-sidebar-container docSidebarContainer_Xlvo"><div class="sidebarViewport_tjEA"><div class="sidebar_ubOv"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_CfkH"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/Idle-Game-Engine/"><span title="Getting Started" class="categoryLinkLabel_ebxo">Getting Started</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/"><span title="Overview" class="linkLabel_KsAJ">Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/contributor-handbook"><span title="Contributor Handbook" class="linkLabel_KsAJ">Contributor Handbook</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/role-index"><span title="Role Index" class="linkLabel_KsAJ">Role Index</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/design-document-template"><span title="Design Document Template" class="linkLabel_KsAJ">Design Document Template</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/idle-engine-design"><span title="Core Runtime" class="categoryLinkLabel_ebxo">Core Runtime</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/Idle-Game-Engine/content-dsl-schema-design"><span title="Content Pipeline" class="categoryLinkLabel_ebxo">Content Pipeline</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/content-dsl-schema-design"><span title="Content DSL Schema Design" class="linkLabel_KsAJ">Content DSL Schema Design</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/content-dsl-usage-guidelines"><span title="Content DSL Usage Guidelines" class="linkLabel_KsAJ">Content DSL Usage Guidelines</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/content-compiler-design"><span title="Content Compiler Design Document" class="linkLabel_KsAJ">Content Compiler Design Document</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/content-schema-rollout-decisions"><span title="Content Schema Rollout: Decision Log" class="linkLabel_KsAJ">Content Schema Rollout: Decision Log</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Idle-Game-Engine/content-validation-cli-design"><span title="Content Validation CLI Design Document" class="linkLabel_KsAJ">Content Validation CLI Design Document</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/accessibility-smoke-tests-design"><span title="Shell Integration" class="categoryLinkLabel_ebxo">Shell Integration</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/implementation-plan"><span title="Operations &amp; Process" class="categoryLinkLabel_ebxo">Operations &amp; Process</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_tfRv"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_hyci"><div class="docItemContainer_tcAC"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_bxbs" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/Idle-Game-Engine/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_p1A9"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Content Pipeline</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Content Validation CLI Design Document</span></li></ul></nav><div class="tocCollapsible_WMbj theme-doc-toc-mobile tocMobile_wI3e"><button type="button" class="clean-btn tocCollapsibleButton_rjEa">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Content Validation CLI Design Document</h1></header>
<p><strong>Issue:</strong> #13<br>
<strong>Workstream:</strong> Content Pipeline<br>
<strong>Status:</strong> Design<br>
<strong>Last Updated:</strong> 2025-10-23</p>
<blockquote>
<p>Issue #13 wires the content validation tooling into the shared CLI so <code>pnpm generate</code> enforces schema health before the compiler emits artifacts. The design builds on <code>docs/idle-engine-design.md</code> §10 and the schema contracts from <code>docs/content-dsl-schema-design.md</code>.</p>
</blockquote>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="1-overview">1. Overview<a href="#1-overview" class="hash-link" aria-label="Direct link to 1. Overview" title="Direct link to 1. Overview" translate="no">​</a></h2>
<p>The Idle Engine repository currently ships a schema package (<code>@idle-engine/content-schema</code>) and a CLI scaffold under <code>tools/content-schema-cli</code>. The CLI generates the runtime event manifest but content packs can still ship invalid data because validation is not part of the default workflow. This document defines how the CLI discovers packs, runs validation with actionable diagnostics, and integrates the results with the compiler pipeline so contributors cannot land malformed content.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="2-goals">2. Goals<a href="#2-goals" class="hash-link" aria-label="Direct link to 2. Goals" title="Direct link to 2. Goals" translate="no">​</a></h2>
<ul>
<li class=""><strong>Deterministic enforcement:</strong> Every <code>pnpm generate</code> run must validate all discovered packs before emitting runtime artifacts, aborting on schema failures to protect the deterministic runtime loop (<code>docs/idle-engine-design.md</code> §6 &amp; §10).</li>
<li class=""><strong>Actionable diagnostics:</strong> Emit machine-readable JSON events (<code>content_pack.*</code>) that surface pack slug, file path, warning counts, and blocker details so CI and humans can triage quickly without parsing prose logs.</li>
<li class=""><strong>Workflow integration:</strong> Support one-shot, <code>--check</code>, and <code>--watch</code> modes with consistent exit codes, clean handling of drift, and optional pretty-printing to keep the developer experience aligned with other repo tooling.</li>
<li class=""><strong>Summary visibility:</strong> Persist a workspace-level summary (<code>content/compiled/index.json</code>) that records validation and compilation outcomes—even when validation aborts compilation—so downstream scripts never read stale success snapshots.</li>
<li class=""><strong>Build hygiene:</strong> Automatically build <code>@idle-engine/content-compiler</code> on demand, skip redundant rewrites, and prune stale artifacts so committed outputs always match authored packs.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="3-non-goals">3. Non-Goals<a href="#3-non-goals" class="hash-link" aria-label="Direct link to 3. Non-Goals" title="Direct link to 3. Non-Goals" translate="no">​</a></h2>
<ul>
<li class="">Replacing or redefining schema rules (tracked in Issue #11 and the schema design document).</li>
<li class="">Designing visual authoring tools or IDE plugins for content authors.</li>
<li class="">Shipping content balance heuristics, localisation audits, or runtime formula inspection (compiler follow-ups cover those capabilities).</li>
<li class="">Altering the runtime event manifest format; the CLI continues to call <code>buildRuntimeEventManifest</code> for that responsibility.</li>
<li class="">Introducing additional package managers or workflow orchestration beyond pnpm and chokidar.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="4-current-state">4. Current State<a href="#4-current-state" class="hash-link" aria-label="Direct link to 4. Current State" title="Direct link to 4. Current State" translate="no">​</a></h2>
<ul>
<li class=""><code>tools/content-schema-cli/src/generate.js</code> reads runtime event metadata, builds the manifest module, and exposes <code>validateContentPacks</code> but this function is not wired into the default command.</li>
<li class=""><code>pnpm generate</code> executes <code>pnpm --filter @idle-engine/content-validation-cli run compile</code>, which currently focuses on manifest regeneration and does not surface pack-level diagnostics or compiler integration.</li>
<li class="">Structured logging guidance in <code>docs/idle-engine-design.md</code> (§10) is unmet; existing runs emit human-readable console noise that downstream automation cannot parse reliably.</li>
<li class=""><code>packages/content-compiler</code> can compile packs into deterministic JSON/TypeScript artifacts (<code>docs/content-compiler-design.md</code>), but nothing triggers it during workspace routines and artifacts may drift.</li>
<li class="">CI and Lefthook depend on <code>pnpm generate</code>; without validation wiring, schema regressions slip through local workflows.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="5-requirements">5. Requirements<a href="#5-requirements" class="hash-link" aria-label="Direct link to 5. Requirements" title="Direct link to 5. Requirements" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="51-functional">5.1 Functional<a href="#51-functional" class="hash-link" aria-label="Direct link to 5.1 Functional" title="Direct link to 5.1 Functional" translate="no">​</a></h3>
<ul>
<li class="">Discover all packs under <code>packages/**/content/pack.(json|json5)</code> and validate them via <code>createContentPackValidator</code>, parsing JSON5 files with the JSON5 loader so comment/relaxed syntax remains supported.</li>
<li class="">Respect pack dependency metadata (<code>metadata.dependencies.requires</code>) so validation and compilation occur in a topologically sorted order.</li>
<li class="">Emit structured logs for validation successes (<code>content_pack.validated</code>) and failures (<code>content_pack.validation_failed</code>), including warning payloads.</li>
<li class="">Abort the command before compilation when any validation failure occurs; <code>process.exitCode</code> must be non-zero.</li>
<li class="">Forward schema options (<code>knownPacks</code>, <code>activePackIds</code>, <code>runtimeEventCatalogue</code>) from validation into the compiler to eliminate redundant scans.</li>
<li class="">Support the CLI options documented in §6.1 with consistent semantics across validation, manifest generation, and compilation.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="52-non-functional">5.2 Non-Functional<a href="#52-non-functional" class="hash-link" aria-label="Direct link to 5.2 Non-Functional" title="Direct link to 5.2 Non-Functional" translate="no">​</a></h3>
<ul>
<li class="">Maintain deterministic log ordering tied to pack discovery order so CI diffing is stable.</li>
<li class="">Avoid unnecessary rewrites by comparing byte content before writing generated modules, JSON artifacts, or the workspace summary.</li>
<li class="">Prevent watch mode from flooding logs by debouncing events, summarising triggers, and flagging repeated validation errors without dropping detail.</li>
<li class="">Keep the validation step performant for dozens of packs (parallel discovery, single validator instance).</li>
<li class="">Preserve compatibility with Node ≥20.10 and pnpm ≥8 as defined in <code>package.json</code>.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="6-proposed-solution">6. Proposed Solution<a href="#6-proposed-solution" class="hash-link" aria-label="Direct link to 6. Proposed Solution" title="Direct link to 6. Proposed Solution" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="61-cli-entry-points--usage">6.1 CLI Entry Points &amp; Usage<a href="#61-cli-entry-points--usage" class="hash-link" aria-label="Direct link to 6.1 CLI Entry Points &amp; Usage" title="Direct link to 6.1 CLI Entry Points &amp; Usage" translate="no">​</a></h3>
<ul>
<li class="">Retain <code>tools/content-schema-cli/src/compile.js</code> as the executable entrypoint invoked by <code>pnpm generate</code>.</li>
<li class="">Document and implement the following options:<!-- -->
<ul>
<li class=""><code>--check</code>: run without applying filesystem mutations; exit with code 1 if manifests, validation, or compiler artifacts would change.</li>
<li class=""><code>--clean</code>: force rewrites even when outputs match, ensuring stale artifacts are replaced (ignored in <code>--check</code> runs).</li>
<li class=""><code>--watch</code>: observe content, manifest metadata, and base manifest files with chokidar; rerun the pipeline with debouncing.</li>
<li class=""><code>--pretty</code>: pretty-print JSON log lines for human readability while keeping machine consumption viable.</li>
<li class=""><code>--cwd</code>/<code>-C</code>: override the workspace root (used for tests and sandboxes).</li>
<li class=""><code>--summary</code>: override the workspace summary output path, defaulting to <code>content/compiled/index.json</code>.</li>
</ul>
</li>
<li class="">Extend <code>printUsage()</code> to describe the integrated validation stage and log events.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="62-execution-pipeline">6.2 Execution Pipeline<a href="#62-execution-pipeline" class="hash-link" aria-label="Direct link to 6.2 Execution Pipeline" title="Direct link to 6.2 Execution Pipeline" translate="no">​</a></h3>
<ol>
<li class=""><strong>Detect workspace root</strong> and resolve options (<code>cwd</code>, <code>summary</code>, watch flags).</li>
<li class=""><strong>Ensure compiler availability</strong> by attempting to import <code>@idle-engine/content-compiler</code>; if it is missing, spawn <code>pnpm --filter @idle-engine/content-compiler run build</code> before retrying the import.</li>
<li class=""><strong>Build runtime event manifest</strong> via <code>buildRuntimeEventManifest</code>, capturing the generated source, manifest entries, and schema options (<code>manifestDefinitions</code>).</li>
<li class=""><strong>Validate content packs</strong> by calling <code>validateContentPacks(manifest.manifestDefinitions, options)</code>. The function:<!-- -->
<ul>
<li class="">Discovers pack documents.</li>
<li class="">Supports both <code>pack.json</code> and <code>pack.json5</code>, using JSON.parse for strict JSON files and the JSON5 parser for relaxed syntax.</li>
<li class="">Builds a validator with <code>createContentPackValidator</code>.</li>
<li class="">Emits a <code>content_pack.validated</code> log per pack, including warnings when present.</li>
<li class="">Emits <code>content_pack.validation_failed</code> logs for schema errors and throws when any failure occurs.</li>
<li class="">Serializes a failure summary to the workspace summary path before bubbling the error so consumers observe the latest validation status.</li>
<li class="">Returns schema options to seed the compiler (known packs, active IDs, runtime event catalogue) when validation succeeds.</li>
</ul>
</li>
<li class=""><strong>Write manifest</strong> using <code>writeRuntimeEventManifest</code>, respecting <code>check</code> and <code>clean</code>.</li>
<li class=""><strong>Compile packs</strong> by calling <code>compileWorkspacePacks</code> with the workspace filesystem implementation and schema options from step 4. The compiler:<!-- -->
<ul>
<li class="">Topologically sorts packs based on declared dependencies.</li>
<li class="">Serializes normalized packs to deterministic JSON and generated TypeScript modules.</li>
<li class="">Produces artifact operations (written, deleted, unchanged) for per-pack outputs and the workspace summary.</li>
</ul>
</li>
<li class=""><strong>Emit compiler logs</strong> using the logger returned by <code>loadContentCompiler().createLogger</code>, producing <code>content_pack.compiled</code>, <code>content_pack.skipped</code>, <code>content_pack.compilation_failed</code>, and <code>content_pack.pruned</code> events.</li>
<li class=""><strong>Summarise run</strong> by merging manifest and compiler results into a structured summary (pack totals, artifact actions, changed pack slugs). When validation fails, write a structured failure summary that captures the offending packs and skip compilation details. Watch mode emits an additional <code>watch.run</code> event with duration and trigger metadata.</li>
<li class=""><strong>Set exit codes</strong>: any validation failure, compiler failure, or drift in <code>--check</code> mode results in a non-zero exit status.</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="63-structured-logging--telemetry">6.3 Structured Logging &amp; Telemetry<a href="#63-structured-logging--telemetry" class="hash-link" aria-label="Direct link to 6.3 Structured Logging &amp; Telemetry" title="Direct link to 6.3 Structured Logging &amp; Telemetry" translate="no">​</a></h3>
<ul>
<li class="">Stick to JSON-per-line logs with no trailing commentary to protect downstream ingestion (aligned with <code>docs/idle-engine-design.md</code> §10 logging guidance).</li>
<li class="">Validation events include:<!-- -->
<ul>
<li class=""><code>content_pack.validated</code>: <code>{ event, packSlug, path, warningCount, warnings }</code>.</li>
<li class=""><code>content_pack.validation_failed</code>: <code>{ event, packSlug, packVersion, path, issues, message }</code> (with <code>packSlug</code>/<code>packVersion</code> populated when metadata can be read from the document).</li>
</ul>
</li>
<li class="">Compiler events include:<!-- -->
<ul>
<li class=""><code>content_pack.compiled</code>: <code>{ name, slug, path, durationMs, warnings, artifacts, check }</code>.</li>
<li class=""><code>content_pack.skipped</code>: same shape but indicates all artifacts unchanged during <code>--check</code>.</li>
<li class=""><code>content_pack.compilation_failed</code>: adds <code>message</code> and <code>stack</code>.</li>
<li class=""><code>content_pack.pruned</code>: emitted when stale artifacts are removed.</li>
</ul>
</li>
<li class="">Watch loop emits <code>watch.status</code>, <code>watch.hint</code>, and <code>watch.run</code> events summarising triggers and run outcomes.</li>
<li class="">All log emitters accept <code>pretty</code> to switch between single-line and indented JSON without changing field names.</li>
<li class="">Unexpected runtime errors surface as <code>cli.unhandled_error</code> events <code>{ event, message, stack, fatal, timestamp }</code>, keeping console output machine-readable while preserving stack traces.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="64-summary-artifact--drift-detection">6.4 Summary Artifact &amp; Drift Detection<a href="#64-summary-artifact--drift-detection" class="hash-link" aria-label="Direct link to 6.4 Summary Artifact &amp; Drift Detection" title="Direct link to 6.4 Summary Artifact &amp; Drift Detection" translate="no">​</a></h3>
<ul>
<li class="">Persist a deterministic workspace summary containing:<!-- -->
<ul>
<li class="">Pack totals (compiled, failed, warning counts).</li>
<li class="">Artifact action counts grouped by action.</li>
<li class="">Lists of changed and failed pack slugs.</li>
<li class="">Manifest and summary action states (<code>written</code>, <code>unchanged</code>, <code>would-write</code>, etc.).</li>
</ul>
</li>
<li class="">Default summary location: <code>content/compiled/index.json</code>, overrideable via <code>--summary</code>.</li>
<li class="">In <code>--check</code> mode, mark drift when the summary or any artifact would change; exit 1 to gate CI.</li>
<li class="">Provide helper metadata (e.g., timestamp, CLI version) for future analytics while keeping the JSON stable for diffing.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="65-watch-mode--developer-experience">6.5 Watch Mode &amp; Developer Experience<a href="#65-watch-mode--developer-experience" class="hash-link" aria-label="Direct link to 6.5 Watch Mode &amp; Developer Experience" title="Direct link to 6.5 Watch Mode &amp; Developer Experience" translate="no">​</a></h3>
<ul>
<li class="">Watch globs:<!-- -->
<ul>
<li class=""><code>packages/**/content/**/*.{json,json5}</code></li>
<li class=""><code>packages/**/content/event-types.json</code></li>
<li class=""><code>packages/core/src/events/runtime-event-base-metadata.json</code></li>
</ul>
</li>
<li class="">Ignore generated outputs (<code>content/compiled/**</code>, <code>src/generated/*.generated.ts</code>, <code>node_modules</code>).</li>
<li class="">Debounce events by 150 ms and cap logged trigger paths to avoid flooding (<code>MAX_TRIGGER_PATHS = 10</code>).</li>
<li class="">After each run, emit <code>watch.run</code> summarising status (<code>success</code>, <code>failed</code>, <code>skipped</code>), iteration count, duration, triggers, and changed/failed packs.</li>
<li class="">Keep the process alive despite validation failures; watch mode should continue listening after emitting failure events but surface a non-zero exit code on termination.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="66-failure-handling--exit-codes">6.6 Failure Handling &amp; Exit Codes<a href="#66-failure-handling--exit-codes" class="hash-link" aria-label="Direct link to 6.6 Failure Handling &amp; Exit Codes" title="Direct link to 6.6 Failure Handling &amp; Exit Codes" translate="no">​</a></h3>
<ul>
<li class="">Validation errors persist a failure summary before throwing, ensuring stale artifacts are not re-emitted when packs are invalid and downstream tooling observes the failure state.</li>
<li class="">Compiler failures for specific packs do not abort the entire run; they mark the pack as failed, emit diagnostics, and continue compiling independent packs. Exit code remains non-zero when any pack fails.</li>
<li class="">When <code>--check</code> is passed, drift (manifest or artifacts) sets <code>process.exitCode = 1</code> even if validation succeeds.</li>
<li class="">Unexpected exceptions emit a <code>cli.unhandled_error</code> event (carrying message and stack) before setting a non-zero exit code, keeping all console output structured.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="67-integration-points">6.7 Integration Points<a href="#67-integration-points" class="hash-link" aria-label="Direct link to 6.7 Integration Points" title="Direct link to 6.7 Integration Points" translate="no">​</a></h3>
<ul>
<li class="">Update repository docs (README, <code>docs/content-dsl-schema-design.md</code>, <code>docs/content-compiler-design.md</code>) to reference the new CLI behaviour.</li>
<li class="">Ensure Lefthook invokes <code>pnpm generate --check</code> so staged changes include fresh artifacts and validation passes.</li>
<li class="">CI pipelines continue to run <code>pnpm generate</code>; the structured logs enable future parsing for dashboards or gating on warning counts.</li>
<li class="">Provide TypeScript definitions for log events in <code>@idle-engine/content-compiler</code> (runtime entrypoint) to ease consumption by other tooling.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="7-implementation-plan">7. Implementation Plan<a href="#7-implementation-plan" class="hash-link" aria-label="Direct link to 7. Implementation Plan" title="Direct link to 7. Implementation Plan" translate="no">​</a></h2>
<ol>
<li class=""><strong>CLI Wiring</strong>
<ul>
<li class="">Import and invoke <code>validateContentPacks</code> from the compile entrypoint.</li>
<li class="">Plumb schema options into the compiler call.</li>
<li class="">Ensure manifest writing respects validation outcomes (skip when validation fails).</li>
<li class="">Extend pack discovery to read both <code>pack.json</code> and <code>pack.json5</code>, falling back to the JSON5 parser when relaxed syntax is detected.</li>
</ul>
</li>
<li class=""><strong>Logging Enhancements</strong>
<ul>
<li class="">Emit structured validation and compiler events with clear fields.</li>
<li class="">Include pack identifiers on validation failures and surface fatal errors via a <code>cli.unhandled_error</code> JSON payload instead of raw stack traces.</li>
<li class="">Add watch-mode status logs and usage text updates.</li>
</ul>
</li>
<li class=""><strong>Summary Output &amp; Drift Detection</strong>
<ul>
<li class="">Persist deterministic summary JSON via the compiler.</li>
<li class="">Persist a validation-failure summary before exiting so consumers see the most recent run state.</li>
<li class="">Update exit code logic for <code>--check</code> drift handling.</li>
</ul>
</li>
<li class=""><strong>Documentation &amp; Tests</strong>
<ul>
<li class="">Add Vitest coverage around the CLI argument parser, validation failure flows, watch trigger aggregation, and summary generation.</li>
<li class="">Update repository docs and onboarding guides to describe the new workflow.</li>
</ul>
</li>
</ol>
<p>Delivery order: steps 1 → 3 must complete before CI accepts the change; step 4 can land incrementally but should finish before closing the issue.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="8-testing-strategy">8. Testing Strategy<a href="#8-testing-strategy" class="hash-link" aria-label="Direct link to 8. Testing Strategy" title="Direct link to 8. Testing Strategy" translate="no">​</a></h2>
<ul>
<li class=""><strong>Unit tests</strong> (<code>tools/content-schema-cli/src/__tests__/compile.test.js</code>):<!-- -->
<ul>
<li class="">Validation success and failure scenarios, asserting exit codes and emitted logs.</li>
<li class="">Pack discovery covering both <code>pack.json</code> and <code>pack.json5</code> inputs, ensuring JSON5 parsing works and surfaces diagnostics.</li>
<li class=""><code>--check</code> drift detection for manifest and compiler artifacts.</li>
<li class="">Top-level error handling emits <code>cli.unhandled_error</code> JSON logs instead of raw stack traces.</li>
<li class="">Watch mode trigger summarisation and repeated failure handling.</li>
<li class="">Property-based sanitisation (<code>tools/content-schema-cli/src/__tests__/validation.property.test.ts</code>) reuses <code>DEFAULT_FORMULA_PROPERTY_SEED</code> from <code>@idle-engine/content-schema</code> with fixed offsets to keep <code>vitest-llm-reporter</code> JSON deterministic; update the documented offsets if seeds change. Authoring guidance lives in <code>docs/content-schema-rollout-decisions.md#6-property-based-formula-sanitization-guidance</code>.</li>
</ul>
</li>
<li class=""><strong>Integration tests</strong> in <code>packages/content-compiler</code>: verify schema options are honoured and dependency ordering works.</li>
<li class=""><strong>Manual verification</strong>:<!-- -->
<ul>
<li class="">Run <code>pnpm generate</code> after editing a pack to ensure artifacts update and logs show <code>content_pack.compiled</code>.</li>
<li class="">Run <code>pnpm generate --check</code> to confirm drift detection.</li>
<li class="">Run <code>pnpm generate --watch --pretty</code> and modify packs to ensure watch events fire.</li>
</ul>
</li>
<li class=""><strong>CI validation</strong>: extend the pipeline to parse the final log line and assert exit statuses, ensuring no console noise corrupts JSON output (supports <code>vitest-llm-reporter</code> downstream).</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="9-risks--mitigations">9. Risks &amp; Mitigations<a href="#9-risks--mitigations" class="hash-link" aria-label="Direct link to 9. Risks &amp; Mitigations" title="Direct link to 9. Risks &amp; Mitigations" translate="no">​</a></h2>
<ul>
<li class=""><strong>Log noise breaking JSON consumers:</strong> Constrain all console output to structured payloads; guard against incidental <code>console.log</code> calls by linting tests and reviewing diffs.</li>
<li class=""><strong>Performance degradation with many packs:</strong> Cache the validator instance, avoid repeated filesystem reads, and measure wall-clock time in tests; future optimisation includes parallel validation if necessary.</li>
<li class=""><strong>Watch mode instability:</strong> Debounce file system events, cap trigger logging, and provide clear status to avoid developer confusion when auto-runs fail repeatedly.</li>
<li class=""><strong>Schema/CLI version mismatch:</strong> Build the compiler on demand and bubble import errors with contextual messaging so developers know to run <code>pnpm install</code> or rebuild packages.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="10-open-questions--follow-ups">10. Open Questions &amp; Follow-Ups<a href="#10-open-questions--follow-ups" class="hash-link" aria-label="Direct link to 10. Open Questions &amp; Follow-Ups" title="Direct link to 10. Open Questions &amp; Follow-Ups" translate="no">​</a></h2>
<ul>
<li class="">Should warning thresholds escalate to failures in CI (e.g., treat warnings as errors via <code>--fail-on-warning</code>)?</li>
<li class="">Do we need a standalone <code>validate</code> subcommand for quick checks without manifest/compile work, or is the combined pipeline sufficient?</li>
<li class="">How should we expose the summary JSON schema to other tooling (publish types or JSON Schema artifact)?</li>
<li class="">When content packs specify optional digests or compatibility metadata, should validation enforce semantic version ranges beyond basic format checks (ties to Issue #138)?</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_QKxP"><a href="https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/content-validation-cli-design.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_wOWh" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_Basj"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/Idle-Game-Engine/content-schema-rollout-decisions"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Content Schema Rollout: Decision Log</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Idle-Game-Engine/accessibility-smoke-tests-design"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Automated Accessibility Smoke Tests</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_AUZ0 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-overview" class="table-of-contents__link toc-highlight">1. Overview</a></li><li><a href="#2-goals" class="table-of-contents__link toc-highlight">2. Goals</a></li><li><a href="#3-non-goals" class="table-of-contents__link toc-highlight">3. Non-Goals</a></li><li><a href="#4-current-state" class="table-of-contents__link toc-highlight">4. Current State</a></li><li><a href="#5-requirements" class="table-of-contents__link toc-highlight">5. Requirements</a><ul><li><a href="#51-functional" class="table-of-contents__link toc-highlight">5.1 Functional</a></li><li><a href="#52-non-functional" class="table-of-contents__link toc-highlight">5.2 Non-Functional</a></li></ul></li><li><a href="#6-proposed-solution" class="table-of-contents__link toc-highlight">6. Proposed Solution</a><ul><li><a href="#61-cli-entry-points--usage" class="table-of-contents__link toc-highlight">6.1 CLI Entry Points &amp; Usage</a></li><li><a href="#62-execution-pipeline" class="table-of-contents__link toc-highlight">6.2 Execution Pipeline</a></li><li><a href="#63-structured-logging--telemetry" class="table-of-contents__link toc-highlight">6.3 Structured Logging &amp; Telemetry</a></li><li><a href="#64-summary-artifact--drift-detection" class="table-of-contents__link toc-highlight">6.4 Summary Artifact &amp; Drift Detection</a></li><li><a href="#65-watch-mode--developer-experience" class="table-of-contents__link toc-highlight">6.5 Watch Mode &amp; Developer Experience</a></li><li><a href="#66-failure-handling--exit-codes" class="table-of-contents__link toc-highlight">6.6 Failure Handling &amp; Exit Codes</a></li><li><a href="#67-integration-points" class="table-of-contents__link toc-highlight">6.7 Integration Points</a></li></ul></li><li><a href="#7-implementation-plan" class="table-of-contents__link toc-highlight">7. Implementation Plan</a></li><li><a href="#8-testing-strategy" class="table-of-contents__link toc-highlight">8. Testing Strategy</a></li><li><a href="#9-risks--mitigations" class="table-of-contents__link toc-highlight">9. Risks &amp; Mitigations</a></li><li><a href="#10-open-questions--follow-ups" class="table-of-contents__link toc-highlight">10. Open Questions &amp; Follow-Ups</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/contributor-handbook">Contributor Handbook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Idle Engine.</div></div></div></footer></div>
</body>
</html>