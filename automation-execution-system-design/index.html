<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-automation-execution-system-design" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Runtime Automation Execution System Design | Idle Engine Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hansjm10.github.io/Idle-Game-Engine/automation-execution-system-design"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Runtime Automation Execution System Design | Idle Engine Docs"><meta data-rh="true" name="description" content="Document Control"><meta data-rh="true" property="og:description" content="Document Control"><link data-rh="true" rel="icon" href="/Idle-Game-Engine/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hansjm10.github.io/Idle-Game-Engine/automation-execution-system-design"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/automation-execution-system-design" hreflang="en"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/automation-execution-system-design" hreflang="x-default"><link rel="stylesheet" href="/Idle-Game-Engine/assets/css/styles.ddf7989c.css">
<script src="/Idle-Game-Engine/assets/js/runtime~main.274768de.js" defer="defer"></script>
<script src="/Idle-Game-Engine/assets/js/main.c241f68f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Idle-Game-Engine/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_li4T" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Idle-Game-Engine/"><div class="navbar__logo"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--light_vaEm"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--dark_axH8"></div><b class="navbar__title text--truncate">Idle Engine</b></a><a class="navbar__item navbar__link" href="/Idle-Game-Engine/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle__Exw colorModeToggle_Lslw"><button class="clean-btn toggleButton_AMBK toggleButtonDisabled_p4Bd" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 lightToggleIcon_p2sk"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 darkToggleIcon_B2qX"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 systemToggleIcon_PWgn"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_RKai"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_nqaE"><div class="docsWrapper_CSLE"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sOWX" type="button"></button><div class="docRoot_qxtV"><main class="docMainContainer_tfRv docMainContainerEnhanced_qAvX"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_hyci"><div class="docItemContainer_tcAC"><article><div class="tocCollapsible_WMbj theme-doc-toc-mobile tocMobile_wI3e"><button type="button" class="clean-btn tocCollapsibleButton_rjEa">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Runtime Automation Execution System Design</h1></header>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="document-control">Document Control<a href="#document-control" class="hash-link" aria-label="Direct link to Document Control" title="Direct link to Document Control" translate="no">​</a></h2>
<ul>
<li class=""><strong>Title</strong>: Runtime automation execution system</li>
<li class=""><strong>Authors</strong>: Claude Code (AI Assistant)</li>
<li class=""><strong>Reviewers</strong>: Engineering team, content designers</li>
<li class=""><strong>Status</strong>: Draft</li>
<li class=""><strong>Last Updated</strong>: 2025-11-03</li>
<li class=""><strong>Related Issues</strong>: #319</li>
<li class=""><strong>Execution Mode</strong>: AI-led</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="1-summary">1. Summary<a href="#1-summary" class="hash-link" aria-label="Direct link to 1. Summary" title="Direct link to 1. Summary" translate="no">​</a></h2>
<p>Automations are fully schematized in <code>@idle-engine/content-schema</code> but not executed by the runtime, creating a critical gap for idle game mechanics. This design specifies a new <code>AutomationSystem</code> that evaluates four trigger types (interval, resourceThreshold, commandQueueEmpty, event), manages automation state (enabled/disabled, cooldowns, last-fired timestamps), and enqueues commands at <code>CommandPriority.AUTOMATION</code> when triggers activate. The system integrates with the existing <code>IdleEngineRuntime</code> tick loop, <code>EventBus</code>, and <code>ProgressionCoordinator</code> to enable content-driven automated gameplay without manual player intervention.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="2-context--problem-statement">2. Context &amp; Problem Statement<a href="#2-context--problem-statement" class="hash-link" aria-label="Direct link to 2. Context &amp; Problem Statement" title="Direct link to 2. Context &amp; Problem Statement" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="background">Background<a href="#background" class="hash-link" aria-label="Direct link to Background" title="Direct link to Background" translate="no">​</a></h3>
<p>The Idle Game Engine is a data-driven idle game framework where game mechanics are defined in content packs (JSON) and executed by a deterministic runtime. The content schema (<code>packages/content-schema/src/modules/automations.ts</code>) defines a complete automation DSL supporting:</p>
<ul>
<li class=""><strong>4 trigger types</strong>: <code>interval</code>, <code>resourceThreshold</code>, <code>commandQueueEmpty</code>, <code>event</code></li>
<li class=""><strong>Target types</strong>: <code>generator</code>, <code>upgrade</code>, <code>system</code></li>
<li class=""><strong>Optional features</strong>: cooldowns, resource costs, unlock conditions, toggle state</li>
<li class=""><strong>Supporting events</strong>: <code>automation:toggled</code>, <code>resource:threshold-reached</code></li>
</ul>
<p>The runtime (<code>packages/core/src/index.ts</code>) provides:</p>
<ul>
<li class="">System registration via <code>IdleEngineRuntime.addSystem()</code></li>
<li class="">Fixed-step tick loop (default 100ms)</li>
<li class="">Command queue with <code>CommandPriority.AUTOMATION</code> priority tier</li>
<li class="">Event bus for inter-system communication</li>
</ul>
<p>However, <strong>no automation system implementation exists</strong>. Content packs can define automations, but these definitions are validated and then ignored during gameplay.</p>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="problem">Problem<a href="#problem" class="hash-link" aria-label="Direct link to Problem" title="Direct link to Problem" translate="no">​</a></h3>
<p>Without automation execution, the engine fails to deliver on the core promise of &quot;idle&quot; gameplay:</p>
<ol>
<li class=""><strong>Manual clicking required</strong>: Players must manually trigger generators and upgrades, defeating idle mechanics</li>
<li class=""><strong>Dead schema</strong>: Automation definitions are validated but never executed, creating confusion</li>
<li class=""><strong>Missing core loop</strong>: Idle games require automation → offline progress → prestige, but only the first step is missing</li>
<li class=""><strong>Wasted infrastructure</strong>: Events (<code>automation:toggled</code>), priority tiers (<code>CommandPriority.AUTOMATION</code>), and trigger schemas exist but remain unused</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="forces">Forces<a href="#forces" class="hash-link" aria-label="Direct link to Forces" title="Direct link to Forces" translate="no">​</a></h3>
<ul>
<li class=""><strong>Performance budget</strong>: Automation evaluation must complete within per-tick budget (&lt;2ms for trigger checks)</li>
<li class=""><strong>Determinism</strong>: Trigger evaluation must be reproducible across replays and platforms</li>
<li class=""><strong>Content flexibility</strong>: Content authors should define automation logic without code changes</li>
<li class=""><strong>State persistence</strong>: Automation state (enabled, cooldown, last-fired) must survive saves/loads</li>
<li class=""><strong>Backward compatibility</strong>: Existing saves without automation state must migrate cleanly</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="3-goals--non-goals">3. Goals &amp; Non-Goals<a href="#3-goals--non-goals" class="hash-link" aria-label="Direct link to 3. Goals &amp; Non-Goals" title="Direct link to 3. Goals &amp; Non-Goals" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="goals">Goals<a href="#goals" class="hash-link" aria-label="Direct link to Goals" title="Direct link to Goals" translate="no">​</a></h3>
<ol>
<li class=""><strong>Execute all four trigger types</strong> (<code>interval</code>, <code>resourceThreshold</code>, <code>commandQueueEmpty</code>, <code>event</code>) as specified in schema</li>
<li class=""><strong>Enqueue commands</strong> at <code>CommandPriority.AUTOMATION</code> when triggers activate</li>
<li class=""><strong>Persist automation state</strong> (enabled/disabled, cooldown timers, last-fired step) in save files</li>
<li class=""><strong>Respect unlock conditions</strong> (automations unlock/lock dynamically based on progression)</li>
<li class=""><strong>Honor cooldowns</strong> (prevent rapid-fire triggers via cooldown enforcement)</li>
<li class=""><strong>Support resource costs</strong> (deduct resources when automation fires, skip if insufficient)</li>
<li class=""><strong>Provide toggle API</strong> (enable/disable automations via commands, publish <code>automation:toggled</code> events)</li>
<li class=""><strong>Deterministic evaluation</strong> (same step + same state = same trigger decisions)</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="non-goals">Non-Goals<a href="#non-goals" class="hash-link" aria-label="Direct link to Non-Goals" title="Direct link to Non-Goals" translate="no">​</a></h3>
<ul>
<li class=""><strong>Custom scripting</strong>: No Lua/JS execution for custom trigger logic (use existing schema only)</li>
<li class=""><strong>UI implementation</strong>: Dashboard for automation management (deferred to #320+)</li>
<li class=""><strong>Priority configuration</strong>: Automation execution order within AUTOMATION priority tier (FIFO for MVP)</li>
<li class=""><strong>A/B testing hooks</strong>: Telemetry for automation effectiveness (deferred to analytics milestone)</li>
<li class=""><strong>Cross-automation dependencies</strong>: Triggers based on other automation states (future work)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="4-stakeholders-agents--impacted-surfaces">4. Stakeholders, Agents &amp; Impacted Surfaces<a href="#4-stakeholders-agents--impacted-surfaces" class="hash-link" aria-label="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" title="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="primary-stakeholders">Primary Stakeholders<a href="#primary-stakeholders" class="hash-link" aria-label="Direct link to Primary Stakeholders" title="Direct link to Primary Stakeholders" translate="no">​</a></h3>
<ul>
<li class=""><strong>Runtime engineering team</strong>: Implementation and integration</li>
<li class=""><strong>Content designers</strong>: Defining automations in content packs</li>
<li class=""><strong>QA engineers</strong>: Testing automation behavior and edge cases</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="agent-roles">Agent Roles<a href="#agent-roles" class="hash-link" aria-label="Direct link to Agent Roles" title="Direct link to Agent Roles" translate="no">​</a></h3>
<ul>
<li class=""><strong>Runtime Implementation Agent</strong>: Core automation system, trigger evaluators, state management</li>
<li class=""><strong>Testing Agent</strong>: Unit tests, integration tests, property-based tests for trigger logic</li>
<li class=""><strong>Migration Agent</strong>: Schema migration for save file compatibility</li>
<li class=""><strong>Documentation Agent</strong>: API docs, content authoring guide for automations</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="affected-packagesservices">Affected Packages/Services<a href="#affected-packagesservices" class="hash-link" aria-label="Direct link to Affected Packages/Services" title="Direct link to Affected Packages/Services" translate="no">​</a></h3>
<ul>
<li class=""><code>packages/core</code>: New <code>AutomationSystem</code>, state types, command handlers</li>
<li class=""><code>packages/shell-web</code>: Integration into <code>runtime.worker.ts</code>, save migrations</li>
<li class=""><code>packages/content-schema</code>: No changes (schema already complete)</li>
<li class=""><code>packages/content-sample</code>: Example automations for testing and reference</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="compatibility-considerations">Compatibility Considerations<a href="#compatibility-considerations" class="hash-link" aria-label="Direct link to Compatibility Considerations" title="Direct link to Compatibility Considerations" translate="no">​</a></h3>
<ul>
<li class=""><strong>Save migration</strong>: Add automation state to existing saves (default: all automations disabled)</li>
<li class=""><strong>Content versioning</strong>: Automations are optional; packs without them function unchanged</li>
<li class=""><strong>Event compatibility</strong>: <code>automation:toggled</code> and <code>resource:threshold-reached</code> events already defined</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="5-current-state">5. Current State<a href="#5-current-state" class="hash-link" aria-label="Direct link to 5. Current State" title="Direct link to 5. Current State" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="existing-infrastructure">Existing Infrastructure<a href="#existing-infrastructure" class="hash-link" aria-label="Direct link to Existing Infrastructure" title="Direct link to Existing Infrastructure" translate="no">​</a></h3>
<p><strong>Automation Schema</strong> (<code>packages/content-schema/src/modules/automations.ts:1-184</code>):</p>
<ul>
<li class="">Fully defined with Zod validation</li>
<li class="">Supports 4 trigger types via discriminated union</li>
<li class="">Includes cooldown, resource cost, unlock condition, enabled-by-default fields</li>
<li class="">Validates target types (generator/upgrade/system)</li>
</ul>
<p><strong>Event System</strong> (<code>packages/core/src/events/runtime-event-catalog.ts:1-70</code>):</p>
<ul>
<li class=""><code>automation:toggled</code> event (id, enabled)</li>
<li class=""><code>resource:threshold-reached</code> event (resourceId, threshold)</li>
<li class="">Event channels registered in <code>RUNTIME_EVENT_CHANNELS</code></li>
</ul>
<p><strong>Command Queue</strong> (<code>packages/core/src/command-queue.ts:34-37</code>):</p>
<ul>
<li class="">Three priority lanes: SYSTEM (0), PLAYER (1), AUTOMATION (2)</li>
<li class="">Priority-based dequeuing via <code>COMMAND_PRIORITY_ORDER</code></li>
</ul>
<p><strong>Runtime Architecture</strong> (<code>packages/core/src/index.ts:82-156</code>):</p>
<ul>
<li class=""><code>IdleEngineRuntime.addSystem()</code> for system registration</li>
<li class="">System lifecycle: <code>setup(context)</code> for event subscriptions, <code>tick(context)</code> for per-step execution</li>
<li class="">Fixed-step tick loop with deterministic command dispatch</li>
</ul>
<p><strong>Progression Coordinator</strong> (<code>packages/shell-web/src/modules/progression-coordinator.ts:1-100</code>):</p>
<ul>
<li class="">Manages resource, generator, upgrade state</li>
<li class="">Provides purchase evaluators for cost calculations</li>
<li class="">Hydrates state from serialized saves</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="gaps">Gaps<a href="#gaps" class="hash-link" aria-label="Direct link to Gaps" title="Direct link to Gaps" translate="no">​</a></h3>
<ul>
<li class="">❌ No <code>AutomationSystem</code> implementation</li>
<li class="">❌ No trigger evaluation logic (interval timers, threshold checks, event listeners)</li>
<li class="">❌ No automation state tracking (enabled/disabled, cooldown, last-fired)</li>
<li class="">❌ No command enqueueing when triggers fire</li>
<li class="">❌ No system registered in <code>runtime.worker.ts</code></li>
<li class="">❌ No save migration for automation state</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="6-proposed-solution">6. Proposed Solution<a href="#6-proposed-solution" class="hash-link" aria-label="Direct link to 6. Proposed Solution" title="Direct link to 6. Proposed Solution" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="61-architecture-overview">6.1 Architecture Overview<a href="#61-architecture-overview" class="hash-link" aria-label="Direct link to 6.1 Architecture Overview" title="Direct link to 6.1 Architecture Overview" translate="no">​</a></h3>
<p>The <code>AutomationSystem</code> is a runtime system registered with <code>IdleEngineRuntime</code> that:</p>
<ol>
<li class=""><strong>Loads automations</strong> from content pack during initialization</li>
<li class=""><strong>Subscribes to events</strong> during <code>setup()</code> (for event-based and threshold triggers)</li>
<li class=""><strong>Evaluates triggers</strong> on every <code>tick()</code> (interval, threshold, queue-empty checks)</li>
<li class=""><strong>Enqueues commands</strong> when triggers activate and conditions are met</li>
<li class=""><strong>Manages state</strong> (enabled flags, cooldown timers, last-fired steps) in <code>ProgressionAuthoritativeState</code></li>
</ol>
<div class="language-text codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-text codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token plain">Content Pack (automations.json)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AutomationSystem.loadAutomations()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">setup(context) → Subscribe to events</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tick(context) → Evaluate triggers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   [Trigger fires?]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ↓ yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   [Check cooldown, unlock, resources]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ↓ pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Enqueue command @ AUTOMATION priority</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CommandQueue → CommandDispatcher → Handler</span><br></span></code></pre></div></div>
<p><strong>Trigger Evaluation Flow</strong>:</p>
<div class="language-text codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-text codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token plain">Every tick:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  For each unlocked automation:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    If cooldown active → skip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    If not enabled → skip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Evaluate trigger:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      interval → elapsed &gt;= interval?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      resourceThreshold → resource comparator threshold?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      commandQueueEmpty → queue.size === 0?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      event → received event this tick?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    If triggered:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Check resource cost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Deduct resources (if cost specified)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Enqueue command</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Update last-fired step</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Start cooldown timer</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="62-detailed-design">6.2 Detailed Design<a href="#62-detailed-design" class="hash-link" aria-label="Direct link to 6.2 Detailed Design" title="Direct link to 6.2 Detailed Design" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="621-state-management">6.2.1 State Management<a href="#621-state-management" class="hash-link" aria-label="Direct link to 6.2.1 State Management" title="Direct link to 6.2.1 State Management" translate="no">​</a></h4>
<p><strong>Automation State Schema</strong> (added to <code>ProgressionAuthoritativeState</code>):</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">AutomationState</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lastFiredStep</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cooldownExpiresStep</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unlocked</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ProgressionAutomationState</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> automations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> AutomationState</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Extended ProgressionAuthoritativeState</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ProgressionAuthoritativeState</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ... existing fields</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  automationState</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ProgressionAutomationState</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Initialization</strong>:</p>
<ul>
<li class="">Automations default to <code>enabledByDefault</code> from schema</li>
<li class=""><code>lastFiredStep = -Infinity</code> (never fired)</li>
<li class=""><code>cooldownExpiresStep = 0</code> (no cooldown)</li>
<li class=""><code>unlocked</code> evaluated from <code>unlockCondition</code></li>
</ul>
<p><strong>Persistence</strong>:</p>
<ul>
<li class="">Automation state serialized in save file</li>
<li class="">Migration adds default state for old saves</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="622-trigger-evaluation-algorithms">6.2.2 Trigger Evaluation Algorithms<a href="#622-trigger-evaluation-algorithms" class="hash-link" aria-label="Direct link to 6.2.2 Trigger Evaluation Algorithms" title="Direct link to 6.2.2 Trigger Evaluation Algorithms" translate="no">​</a></h4>
<p><strong>Interval Trigger</strong>:</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateIntervalTrigger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  automation</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AutomationDefinition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AutomationState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  currentStep</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stepDurationMs</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lastFiredStep </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">Infinity</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Fire immediately on first tick</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> intervalMs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateNumericFormula</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trigger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interval</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> intervalSteps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ceil</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">intervalMs </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> stepDurationMs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> stepsSinceLastFired </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> currentStep </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lastFiredStep</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> stepsSinceLastFired </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> intervalSteps</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Resource Threshold Trigger</strong>:</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * Evaluates whether a resourceThreshold condition is currently satisfied.</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * NOTE: This returns the current state. To detect crossings, the caller must</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * track the previous state (AutomationState.lastThresholdSatisfied) and</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * fire only on transitions: currentlySatisfied &amp;&amp; !previouslySatisfied.</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateResourceThresholdTrigger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  automation</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AutomationDefinition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resourceState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ResourceState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  context</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> FormulaContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> resourceId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> comparator</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> threshold </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trigger</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> resource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> resourceState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resourceId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> thresholdValue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateNumericFormula</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">threshold</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">comparator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;gte&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> resource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">amount </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> thresholdValue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;gt&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> resource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">amount </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> thresholdValue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;lte&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> resource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">amount </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> thresholdValue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;lt&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> resource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">amount </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> thresholdValue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// In tick() loop:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> currentlySatisfied </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateResourceThresholdTrigger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resourceState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> previouslySatisfied </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lastThresholdSatisfied </span><span class="token operator" style="color:#393A34">??</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">triggered </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> currentlySatisfied </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">previouslySatisfied</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lastThresholdSatisfied </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> currentlySatisfied</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Track for next tick</span><br></span></code></pre></div></div>
<p><strong>Command Queue Empty Trigger</strong>:</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateCommandQueueEmptyTrigger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  commandQueue</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CommandQueue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> commandQueue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Event Trigger</strong>:</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// During setup():</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trigger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kind </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;event&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">events</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trigger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eventId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pendingEventTriggers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// During tick():</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateEventTrigger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  automation</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AutomationDefinition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pendingEventTriggers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Set</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> pendingEventTriggers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">has</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// After processing:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pendingEventTriggers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="623-command-enqueueing">6.2.3 Command Enqueueing<a href="#623-command-enqueueing" class="hash-link" aria-label="Direct link to 6.2.3 Command Enqueueing" title="Direct link to 6.2.3 Command Enqueueing" translate="no">​</a></h4>
<p>When a trigger fires:</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">enqueueAutomationCommand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  automation</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AutomationDefinition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  commandQueue</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CommandQueue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  currentStep</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timestamp</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> targetType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> targetId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> systemTargetId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> automation</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> commandType</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> payload</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">unknown</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">targetType </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;generator&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    commandType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">RUNTIME_COMMAND_TYPES</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">TOGGLE_GENERATOR</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> generatorId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> targetId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">targetType </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;upgrade&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    commandType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">RUNTIME_COMMAND_TYPES</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">PURCHASE_UPGRADE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> upgradeId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> targetId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> quantity</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">targetType </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;system&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// System automations require custom handling</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    commandType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> systemTargetId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// e.g., &#x27;system:prestige&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  commandQueue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">enqueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> commandType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    payload</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    priority</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CommandPriority</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">AUTOMATION</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timestamp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    step</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> currentStep </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Execute next step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="624-resource-cost-handling">6.2.4 Resource Cost Handling<a href="#624-resource-cost-handling" class="hash-link" aria-label="Direct link to 6.2.4 Resource Cost Handling" title="Direct link to 6.2.4 Resource Cost Handling" translate="no">​</a></h4>
<p>Before enqueueing:</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">canAffordAutomation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  automation</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AutomationDefinition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resourceState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ResourceState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  context</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> FormulaContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceCost</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> resourceId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rate </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceCost</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> cost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateNumericFormula</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> resource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> resourceState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resourceId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> resource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">amount </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> cost</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">deductAutomationCost</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  automation</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AutomationDefinition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resourceState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ResourceState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  context</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> FormulaContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceCost</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> resourceId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rate </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceCost</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> cost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateNumericFormula</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resourceState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">spend</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resourceId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cost</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="625-cooldown-management">6.2.5 Cooldown Management<a href="#625-cooldown-management" class="hash-link" aria-label="Direct link to 6.2.5 Cooldown Management" title="Direct link to 6.2.5 Cooldown Management" translate="no">​</a></h4>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateCooldown</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  automation</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AutomationDefinition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AutomationState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  currentStep</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stepDurationMs</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cooldown</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cooldownExpiresStep </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> cooldownSteps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ceil</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cooldown </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> stepDurationMs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// +1 accounts for command execution delay: commands enqueued at currentStep</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// execute at currentStep + 1, so cooldown must be measured from that step.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cooldownExpiresStep </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> currentStep </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> cooldownSteps </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">isCooldownActive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AutomationState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  currentStep</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> currentStep </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cooldownExpiresStep</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="626-system-implementation">6.2.6 System Implementation<a href="#626-system-implementation" class="hash-link" aria-label="Direct link to 6.2.6 System Implementation" title="Direct link to 6.2.6 System Implementation" translate="no">​</a></h4>
<p><strong>File</strong>: <code>packages/core/src/automation-system.ts</code></p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">AutomationSystemOptions</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> automations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> AutomationDefinition</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> commandQueue</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CommandQueue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> resourceState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ResourceState</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> stepDurationMs</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> initialState</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ProgressionAutomationState</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createAutomationSystem</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AutomationSystemOptions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> System </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> automationStates </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Map</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name builtin">string</span><span class="token class-name punctuation" style="color:#393A34">,</span><span class="token class-name"> AutomationState</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> pendingEventTriggers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Set</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name builtin">string</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Initialize states</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> automation </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">automations</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> existingState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">initialState</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">automations</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    automationStates</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> existingState </span><span class="token operator" style="color:#393A34">??</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">enabledByDefault</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lastFiredStep</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">Infinity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cooldownExpiresStep</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      unlocked</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Evaluated during first tick</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;automation&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">setup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Subscribe to event triggers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> automation </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">automations</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trigger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kind </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;event&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">events</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trigger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eventId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pendingEventTriggers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Subscribe to automation toggle commands</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">events</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;automation:toggled&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> automationStates</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">automationId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">enabled </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> payload</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">enabled</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">tick</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> automation </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">automations</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> automationStates</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Update unlock status</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unlocked </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateCondition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unlockCondition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          conditionContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unlocked </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">enabled</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">isCooldownActive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">step</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Evaluate trigger</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> triggered </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trigger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kind</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;interval&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            triggered </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateIntervalTrigger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              automation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">step</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stepDurationMs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;resourceThreshold&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            triggered </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateResourceThresholdTrigger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              automation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              formulaContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;commandQueueEmpty&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            triggered </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateCommandQueueEmptyTrigger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">commandQueue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;event&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            triggered </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateEventTrigger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              automation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              pendingEventTriggers</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">triggered</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Check resource cost</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">canAffordAutomation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> formulaContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Deduct cost and enqueue command</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">deductAutomationCost</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> formulaContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">enqueueAutomationCommand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          automation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">commandQueue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">step</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">events</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">timestamp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Update state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lastFiredStep </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">step</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">updateCooldown</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">step</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stepDurationMs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Clear event triggers for next tick</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pendingEventTriggers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="627-integration-with-runtime-worker">6.2.7 Integration with Runtime Worker<a href="#627-integration-with-runtime-worker" class="hash-link" aria-label="Direct link to 6.2.7 Integration with Runtime Worker" title="Direct link to 6.2.7 Integration with Runtime Worker" translate="no">​</a></h4>
<p><strong>File</strong>: <code>packages/shell-web/src/runtime.worker.ts</code></p>
<p>Add after line 166 (after <code>registerResourceCommandHandlers</code>):</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> createAutomationSystem </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;@idle-engine/core&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ... existing code ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> automationSystem </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createAutomationSystem</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  automations</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> sampleContent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">automations</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  commandQueue</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCommandQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resourceState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> progressionCoordinator</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resourceState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stepDurationMs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  initialState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> initialProgression</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">automationState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addSystem</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">automationSystem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="63-operational-considerations">6.3 Operational Considerations<a href="#63-operational-considerations" class="hash-link" aria-label="Direct link to 6.3 Operational Considerations" title="Direct link to 6.3 Operational Considerations" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="deployment">Deployment<a href="#deployment" class="hash-link" aria-label="Direct link to Deployment" title="Direct link to Deployment" translate="no">​</a></h4>
<ul>
<li class=""><strong>Feature flag</strong>: None required; automations gracefully no-op if content pack has empty <code>automations</code> array</li>
<li class=""><strong>Rollout</strong>: Deploy to all environments simultaneously (no content changes required)</li>
<li class=""><strong>Rollback</strong>: Safe to rollback; automation state ignored by older runtime versions</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="telemetry--observability">Telemetry &amp; Observability<a href="#telemetry--observability" class="hash-link" aria-label="Direct link to Telemetry &amp; Observability" title="Direct link to Telemetry &amp; Observability" translate="no">​</a></h4>
<ul>
<li class=""><strong>Metrics</strong>: Automation trigger counts, skipped triggers (cooldown/cost), average triggers per tick</li>
<li class=""><strong>Logging</strong>: Automation fires logged at debug level with automation ID and target</li>
<li class=""><strong>Diagnostics</strong>: Automation state exposed in diagnostic timeline for debugging</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="security--compliance">Security &amp; Compliance<a href="#security--compliance" class="hash-link" aria-label="Direct link to Security &amp; Compliance" title="Direct link to Security &amp; Compliance" translate="no">​</a></h4>
<ul>
<li class=""><strong>Threat model</strong>: No new attack surface; automations use existing command system</li>
<li class=""><strong>PII handling</strong>: No PII in automation state</li>
<li class=""><strong>Permissions</strong>: Automations execute at AUTOMATION priority (lower than PLAYER)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="7-work-breakdown--delivery-plan">7. Work Breakdown &amp; Delivery Plan<a href="#7-work-breakdown--delivery-plan" class="hash-link" aria-label="Direct link to 7. Work Breakdown &amp; Delivery Plan" title="Direct link to 7. Work Breakdown &amp; Delivery Plan" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="71-issue-map">7.1 Issue Map<a href="#71-issue-map" class="hash-link" aria-label="Direct link to 7.1 Issue Map" title="Direct link to 7.1 Issue Map" translate="no">​</a></h3>
<table><thead><tr><th>Issue Title</th><th>Scope Summary</th><th>Proposed Assignee/Agent</th><th>Dependencies</th><th>Acceptance Criteria</th></tr></thead><tbody><tr><td>feat(core): implement AutomationSystem core</td><td>Create <code>AutomationSystem</code> class with state management and trigger evaluation logic</td><td>Runtime Implementation Agent</td><td>Doc approval</td><td>Unit tests pass; all 4 trigger types evaluated correctly; state persisted</td></tr><tr><td>feat(core): integrate AutomationSystem into runtime</td><td>Register AutomationSystem in <code>runtime.worker.ts</code> and wire to ProgressionCoordinator</td><td>Runtime Implementation Agent</td><td>AutomationSystem core</td><td>Integration tests pass; automations fire in worker context</td></tr><tr><td>feat(core): add automation toggle command handler</td><td>Implement <code>TOGGLE_AUTOMATION</code> command and emit <code>automation:toggled</code> events</td><td>Runtime Implementation Agent</td><td>AutomationSystem core</td><td>Command toggles automation state; event published</td></tr><tr><td>test(core): property-based automation tests</td><td>Generate random automation sequences and verify trigger invariants</td><td>Testing Agent</td><td>AutomationSystem core</td><td>1000+ test cases pass; edge cases documented</td></tr><tr><td>feat(shell-web): automation state migration</td><td>Add migration for saves without automation state</td><td>Migration Agent</td><td>AutomationSystem integration</td><td>Old saves load with default automation state; tests verify</td></tr><tr><td>feat(content-sample): add example automations</td><td>Create sample automations for each trigger type in sample pack</td><td>Runtime Implementation Agent</td><td>None</td><td>Sample pack includes 4+ automations; validated against schema</td></tr><tr><td>docs(core): automation system API docs</td><td>Document AutomationSystem API and content authoring guide</td><td>Documentation Agent</td><td>AutomationSystem core</td><td>API docs published; authoring guide includes examples</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="72-milestones">7.2 Milestones<a href="#72-milestones" class="hash-link" aria-label="Direct link to 7.2 Milestones" title="Direct link to 7.2 Milestones" translate="no">​</a></h3>
<p><strong>Phase 1: Core Implementation</strong> (3-5 days)</p>
<ul>
<li class="">Deliverables: AutomationSystem implementation, trigger evaluators, state management</li>
<li class="">Gating criteria: Unit tests pass with 100% coverage</li>
</ul>
<p><strong>Phase 2: Integration</strong> (2-3 days)</p>
<ul>
<li class="">Deliverables: Runtime worker integration, command handlers, event subscriptions</li>
<li class="">Gating criteria: Integration tests pass; automations fire in worker context</li>
</ul>
<p><strong>Phase 3: Testing &amp; Polish</strong> (2 days)</p>
<ul>
<li class="">Deliverables: Property-based tests, migration tests, sample automations</li>
<li class="">Gating criteria: All tests pass; example automations validated</li>
</ul>
<p><strong>Phase 4: Documentation</strong> (1 day)</p>
<ul>
<li class="">Deliverables: API docs, authoring guide, migration notes</li>
<li class="">Gating criteria: Docs reviewed and merged</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="73-coordination-notes">7.3 Coordination Notes<a href="#73-coordination-notes" class="hash-link" aria-label="Direct link to 7.3 Coordination Notes" title="Direct link to 7.3 Coordination Notes" translate="no">​</a></h3>
<p><strong>Hand-off Package</strong>:</p>
<ul>
<li class="">This design document (all sections)</li>
<li class=""><code>packages/content-schema/src/modules/automations.ts</code> (schema reference)</li>
<li class=""><code>packages/core/src/index.ts</code> (system registration pattern)</li>
<li class=""><code>packages/shell-web/src/modules/progression-coordinator.ts</code> (state management pattern)</li>
</ul>
<p><strong>Communication Cadence</strong>:</p>
<ul>
<li class="">Daily status updates in #319 (GitHub issue)</li>
<li class="">Review checkpoint after Phase 1 completion</li>
<li class="">Escalation path: Tag engineering lead if blocked &gt;1 day</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="8-agent-guidance--guardrails">8. Agent Guidance &amp; Guardrails<a href="#8-agent-guidance--guardrails" class="hash-link" aria-label="Direct link to 8. Agent Guidance &amp; Guardrails" title="Direct link to 8. Agent Guidance &amp; Guardrails" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="context-packets">Context Packets<a href="#context-packets" class="hash-link" aria-label="Direct link to Context Packets" title="Direct link to Context Packets" translate="no">​</a></h3>
<p>Agents must load before execution:</p>
<ul>
<li class=""><code>packages/content-schema/src/modules/automations.ts</code> (automation schema)</li>
<li class=""><code>packages/core/src/index.ts</code> (runtime architecture)</li>
<li class=""><code>packages/core/src/command.ts</code> (command priority definitions)</li>
<li class=""><code>packages/core/src/events/runtime-event-catalog.ts</code> (event definitions)</li>
<li class=""><code>packages/shell-web/src/modules/progression-coordinator.ts</code> (state management patterns)</li>
<li class=""><code>docs/runtime-command-queue-design.md</code> (command queue design)</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="prompting--constraints">Prompting &amp; Constraints<a href="#prompting--constraints" class="hash-link" aria-label="Direct link to Prompting &amp; Constraints" title="Direct link to Prompting &amp; Constraints" translate="no">​</a></h3>
<p><strong>Canonical Instructions</strong>:</p>
<ul>
<li class="">Use imperative commit messages: <code>feat(core): add AutomationSystem</code> not <code>Added AutomationSystem</code></li>
<li class="">Follow existing naming: <code>evaluateTrigger()</code> not <code>checkTrigger()</code> (match <code>evaluateCondition()</code> pattern)</li>
<li class="">Maintain 100% test coverage for public APIs (use Vitest)</li>
<li class="">Export all new types from <code>packages/core/src/index.ts</code></li>
</ul>
<p><strong>Performance Requirements</strong>:</p>
<ul>
<li class="">Automation evaluation must complete in &lt;2ms per tick for 100 automations</li>
<li class="">Use memoization for expensive formula evaluations</li>
<li class="">Avoid O(n²) loops; prefer Map lookups over array scans</li>
</ul>
<p><strong>Determinism Requirements</strong>:</p>
<ul>
<li class="">Trigger evaluation must be pure (same inputs → same outputs)</li>
<li class="">No <code>Date.now()</code> or <code>Math.random()</code> in trigger logic</li>
<li class="">Use <code>context.step</code> and <code>context.timestamp</code> for timing</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="safety-rails">Safety Rails<a href="#safety-rails" class="hash-link" aria-label="Direct link to Safety Rails" title="Direct link to Safety Rails" translate="no">​</a></h3>
<p><strong>Forbidden Actions</strong>:</p>
<ul>
<li class="">NEVER reset git history or force push to main</li>
<li class="">DO NOT modify existing command priority values</li>
<li class="">DO NOT skip validation of automation schema</li>
<li class="">NEVER use <code>any</code> type; use proper TypeScript types</li>
</ul>
<p><strong>Data Privacy</strong>:</p>
<ul>
<li class="">Automation state contains no PII</li>
<li class="">Telemetry must not log resource IDs containing user data</li>
</ul>
<p><strong>Rollback Procedures</strong>:</p>
<ul>
<li class="">If automation system crashes runtime, disable via feature flag</li>
<li class="">Revert automation state migration if save corruption detected</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="validation-hooks">Validation Hooks<a href="#validation-hooks" class="hash-link" aria-label="Direct link to Validation Hooks" title="Direct link to Validation Hooks" translate="no">​</a></h3>
<p>Agents must run before marking tasks complete:</p>
<ul>
<li class=""><code>pnpm test --filter core</code> (all core tests pass)</li>
<li class=""><code>pnpm test --filter shell-web</code> (all shell-web tests pass)</li>
<li class=""><code>pnpm lint --filter core</code> (no lint errors)</li>
<li class=""><code>pnpm build</code> (TypeScript compilation succeeds)</li>
<li class="">Verify automation fires in worker context (integration test)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="9-alternatives-considered">9. Alternatives Considered<a href="#9-alternatives-considered" class="hash-link" aria-label="Direct link to 9. Alternatives Considered" title="Direct link to 9. Alternatives Considered" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="alternative-1-poll-based-trigger-evaluation">Alternative 1: Poll-Based Trigger Evaluation<a href="#alternative-1-poll-based-trigger-evaluation" class="hash-link" aria-label="Direct link to Alternative 1: Poll-Based Trigger Evaluation" title="Direct link to Alternative 1: Poll-Based Trigger Evaluation" translate="no">​</a></h3>
<p><strong>Approach</strong>: Evaluate all triggers on every tick, regardless of type.</p>
<p><strong>Rejected because</strong>:</p>
<ul>
<li class="">Wasteful for event-based triggers (polling vs. subscription)</li>
<li class="">Poor performance for large automation counts (O(n) every tick)</li>
<li class="">Misses event-based triggers between ticks</li>
</ul>
<p><strong>Trade-offs</strong>: Simpler implementation but unacceptable performance characteristics.</p>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="alternative-2-separate-automation-worker">Alternative 2: Separate Automation Worker<a href="#alternative-2-separate-automation-worker" class="hash-link" aria-label="Direct link to Alternative 2: Separate Automation Worker" title="Direct link to Alternative 2: Separate Automation Worker" translate="no">​</a></h3>
<p><strong>Approach</strong>: Run automation evaluation in dedicated web worker.</p>
<p><strong>Rejected because</strong>:</p>
<ul>
<li class="">Adds complexity (message passing, state synchronization)</li>
<li class="">No performance benefit (automation evaluation is cheap)</li>
<li class="">Increases latency (cross-worker communication overhead)</li>
</ul>
<p><strong>Trade-offs</strong>: Better isolation but unjustified complexity for current scale.</p>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="alternative-3-luajs-scripting-for-custom-triggers">Alternative 3: Lua/JS Scripting for Custom Triggers<a href="#alternative-3-luajs-scripting-for-custom-triggers" class="hash-link" aria-label="Direct link to Alternative 3: Lua/JS Scripting for Custom Triggers" title="Direct link to Alternative 3: Lua/JS Scripting for Custom Triggers" translate="no">​</a></h3>
<p><strong>Approach</strong>: Allow content authors to write custom trigger logic in scripts.</p>
<p><strong>Rejected because</strong>:</p>
<ul>
<li class="">Security risk (arbitrary code execution)</li>
<li class="">Non-deterministic (hard to validate reproducibility)</li>
<li class="">Complexity (requires sandboxing, API design)</li>
<li class="">Out of scope for MVP</li>
</ul>
<p><strong>Trade-offs</strong>: Maximum flexibility but unacceptable security/determinism trade-offs.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="10-testing--validation-plan">10. Testing &amp; Validation Plan<a href="#10-testing--validation-plan" class="hash-link" aria-label="Direct link to 10. Testing &amp; Validation Plan" title="Direct link to 10. Testing &amp; Validation Plan" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="unit-tests">Unit Tests<a href="#unit-tests" class="hash-link" aria-label="Direct link to Unit Tests" title="Direct link to Unit Tests" translate="no">​</a></h3>
<ul>
<li class=""><strong>Trigger Evaluators</strong>: Test each trigger type with edge cases<!-- -->
<ul>
<li class="">Interval: First tick, exact interval, sub-interval deltas</li>
<li class="">Resource threshold: All comparators (gte/gt/lte/lt), boundary values</li>
<li class="">Command queue empty: Empty queue, non-empty queue</li>
<li class="">Event: Event received, event not received, multiple events</li>
</ul>
</li>
<li class=""><strong>State Management</strong>: Enable/disable, cooldowns, last-fired tracking</li>
<li class=""><strong>Resource Costs</strong>: Sufficient resources, insufficient resources, no cost</li>
<li class=""><strong>Unlock Conditions</strong>: Locked automations skipped, unlock transitions</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="integration-tests">Integration Tests<a href="#integration-tests" class="hash-link" aria-label="Direct link to Integration Tests" title="Direct link to Integration Tests" translate="no">​</a></h3>
<ul>
<li class=""><strong>End-to-End Automation</strong>: Define automation in content pack → trigger fires → command executed</li>
<li class=""><strong>Multiple Automations</strong>: 10+ automations with different triggers fire correctly</li>
<li class=""><strong>Priority Ordering</strong>: Automation commands execute after PLAYER commands</li>
<li class=""><strong>Event Integration</strong>: Event triggers subscribe and fire correctly</li>
<li class=""><strong>Save/Load Cycle</strong>: Automation state persists and restores correctly</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="performance-tests">Performance Tests<a href="#performance-tests" class="hash-link" aria-label="Direct link to Performance Tests" title="Direct link to Performance Tests" translate="no">​</a></h3>
<ul>
<li class=""><strong>Benchmark</strong>: 100 automations evaluated in &lt;2ms per tick (target: &lt;1ms)</li>
<li class=""><strong>Memory</strong>: Automation state memory usage &lt;1KB per automation</li>
<li class=""><strong>Stress Test</strong>: 1000 automations do not degrade tick performance below 60 FPS</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="property-based-tests">Property-Based Tests<a href="#property-based-tests" class="hash-link" aria-label="Direct link to Property-Based Tests" title="Direct link to Property-Based Tests" translate="no">​</a></h3>
<ul>
<li class=""><strong>Random Automation Sequences</strong>: Generate random automation definitions and verify:<!-- -->
<ul>
<li class="">No crashes or exceptions</li>
<li class="">Cooldowns always enforced</li>
<li class="">Resource costs always deducted</li>
<li class="">Commands always enqueued at AUTOMATION priority</li>
</ul>
</li>
<li class=""><strong>Invariants</strong>:<!-- -->
<ul>
<li class=""><code>lastFiredStep &lt;= currentStep</code> always true</li>
<li class=""><code>cooldownExpiresStep &gt;= currentStep</code> when cooldown active</li>
<li class="">Disabled automations never fire</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="accessibility-tests">Accessibility Tests<a href="#accessibility-tests" class="hash-link" aria-label="Direct link to Accessibility Tests" title="Direct link to Accessibility Tests" translate="no">​</a></h3>
<ul>
<li class="">Not applicable (no UI in this milestone)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="11-risks--mitigations">11. Risks &amp; Mitigations<a href="#11-risks--mitigations" class="hash-link" aria-label="Direct link to 11. Risks &amp; Mitigations" title="Direct link to 11. Risks &amp; Mitigations" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="risk-performance-degradation-with-large-automation-counts">Risk: Performance Degradation with Large Automation Counts<a href="#risk-performance-degradation-with-large-automation-counts" class="hash-link" aria-label="Direct link to Risk: Performance Degradation with Large Automation Counts" title="Direct link to Risk: Performance Degradation with Large Automation Counts" translate="no">​</a></h3>
<p><strong>Impact</strong>: High (&gt;100 automations could exceed tick budget)
<strong>Likelihood</strong>: Medium (power users may create many automations)
<strong>Mitigation</strong>:</p>
<ul>
<li class="">Benchmark with 100+ automations during development</li>
<li class="">Implement lazy evaluation (skip locked/disabled automations early)</li>
<li class="">Document performance limits in content authoring guide</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="risk-infinite-trigger-loops">Risk: Infinite Trigger Loops<a href="#risk-infinite-trigger-loops" class="hash-link" aria-label="Direct link to Risk: Infinite Trigger Loops" title="Direct link to Risk: Infinite Trigger Loops" translate="no">​</a></h3>
<p><strong>Impact</strong>: High (automation triggers itself → infinite commands)
<strong>Likelihood</strong>: Low (requires specific content misconfiguration)
<strong>Mitigation</strong>:</p>
<ul>
<li class="">Cooldowns prevent rapid re-triggers</li>
<li class="">Document anti-patterns in authoring guide</li>
<li class="">Add telemetry to detect high-frequency triggers</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="risk-determinism-violations">Risk: Determinism Violations<a href="#risk-determinism-violations" class="hash-link" aria-label="Direct link to Risk: Determinism Violations" title="Direct link to Risk: Determinism Violations" translate="no">​</a></h3>
<p><strong>Impact</strong>: Critical (non-deterministic triggers break replays)
<strong>Likelihood</strong>: Low (strict testing enforces determinism)
<strong>Mitigation</strong>:</p>
<ul>
<li class="">Property-based tests verify reproducibility</li>
<li class="">Code review checklist includes determinism verification</li>
<li class="">Reject any use of <code>Date.now()</code> or <code>Math.random()</code></li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="risk-save-migration-failures">Risk: Save Migration Failures<a href="#risk-save-migration-failures" class="hash-link" aria-label="Direct link to Risk: Save Migration Failures" title="Direct link to Risk: Save Migration Failures" translate="no">​</a></h3>
<p><strong>Impact</strong>: High (players lose automation state)
<strong>Likelihood</strong>: Low (migration adds default state, no data loss)
<strong>Mitigation</strong>:</p>
<ul>
<li class="">Migration tests verify old saves load correctly</li>
<li class="">Default state (disabled) is safe fallback</li>
<li class="">Rollback plan: revert migration, automation state optional</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="12-rollout-plan">12. Rollout Plan<a href="#12-rollout-plan" class="hash-link" aria-label="Direct link to 12. Rollout Plan" title="Direct link to 12. Rollout Plan" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="milestones">Milestones<a href="#milestones" class="hash-link" aria-label="Direct link to Milestones" title="Direct link to Milestones" translate="no">​</a></h3>
<ul>
<li class=""><strong>M1: Core Implementation</strong> (Week 1): AutomationSystem and trigger evaluators</li>
<li class=""><strong>M2: Integration</strong> (Week 2): Runtime worker integration and command handlers</li>
<li class=""><strong>M3: Testing</strong> (Week 2): Property-based tests and migration validation</li>
<li class=""><strong>M4: Documentation</strong> (Week 3): API docs and content authoring guide</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="migration-strategy">Migration Strategy<a href="#migration-strategy" class="hash-link" aria-label="Direct link to Migration Strategy" title="Direct link to Migration Strategy" translate="no">​</a></h3>
<ul>
<li class=""><strong>Save Format</strong>: Add <code>automationState</code> field to <code>ProgressionAuthoritativeState</code></li>
<li class=""><strong>Migration Logic</strong>: If <code>automationState</code> missing, initialize with defaults (all disabled)</li>
<li class=""><strong>Backward Compatibility</strong>: Old runtime ignores <code>automationState</code> field</li>
<li class=""><strong>Forward Compatibility</strong>: New runtime handles missing field gracefully</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="communication">Communication<a href="#communication" class="hash-link" aria-label="Direct link to Communication" title="Direct link to Communication" translate="no">​</a></h3>
<ul>
<li class=""><strong>Release Notes</strong>: &quot;Automation system now executes automation definitions from content packs. Existing saves will have all automations disabled by default.&quot;</li>
<li class=""><strong>Content Authors</strong>: &quot;Automations are now functional! See docs/automation-authoring-guide.md for examples.&quot;</li>
<li class=""><strong>Players</strong>: No user-facing message (feature enabled by content packs)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="13-open-questions">13. Open Questions<a href="#13-open-questions" class="hash-link" aria-label="Direct link to 13. Open Questions" title="Direct link to 13. Open Questions" translate="no">​</a></h2>
<ol>
<li class="">
<p><strong>Q</strong>: Should automations fire during offline catch-up?
<strong>A</strong>: Deferred to offline progression design (#350+). For MVP, automations only fire during active ticks.</p>
</li>
<li class="">
<p><strong>Q</strong>: How should automation state be exposed to UI?
<strong>A</strong>: Deferred to automation UI design (#320+). For MVP, state exists but no dashboard.</p>
</li>
<li class="">
<p><strong>Q</strong>: Should resource threshold triggers fire every tick while threshold is met?
<strong>A</strong>: ✅ <strong>DECIDED</strong>: Fire once per threshold crossing (track <code>lastThresholdSatisfied</code> state). Implemented in <code>AutomationState.lastThresholdSatisfied</code> field. Triggers fire only on transitions from not-met to met (false → true).</p>
</li>
<li class="">
<p><strong>Q</strong>: What happens if automation target (generator/upgrade) is locked?
<strong>A</strong>: Command is enqueued but authorization fails. <strong>Recommendation</strong>: Check unlock status before enqueueing.</p>
</li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="14-follow-up-work">14. Follow-Up Work<a href="#14-follow-up-work" class="hash-link" aria-label="Direct link to 14. Follow-Up Work" title="Direct link to 14. Follow-Up Work" translate="no">​</a></h2>
<table><thead><tr><th>Task</th><th>Description</th><th>Owner</th><th>Timing</th></tr></thead><tbody><tr><td>#320</td><td>Automation dashboard UI</td><td>Shell-web team</td><td>After core implementation</td></tr><tr><td>#321</td><td>Automation telemetry and A/B testing</td><td>Analytics team</td><td>Q2 2025</td></tr><tr><td>#322</td><td>Cross-automation dependencies</td><td>Runtime team</td><td>Future milestone</td></tr><tr><td>#323</td><td>Offline automation catch-up</td><td>Runtime team</td><td>After offline progression design</td></tr><tr><td>#324</td><td>Automation priority ordering</td><td>Content team</td><td>If requested by users</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="15-references">15. References<a href="#15-references" class="hash-link" aria-label="Direct link to 15. References" title="Direct link to 15. References" translate="no">​</a></h2>
<ul>
<li class="">Issue #319: Design: Runtime automation execution system</li>
<li class="">Issue #298: feat(shell-web): resource dashboard UI (related work)</li>
<li class=""><code>packages/content-schema/src/modules/automations.ts</code> (schema)</li>
<li class=""><code>packages/core/src/index.ts:116-156</code> (system registration)</li>
<li class=""><code>packages/core/src/events/runtime-event-catalog.ts:7-22</code> (automation events)</li>
<li class=""><code>packages/core/src/command.ts:76-90</code> (command priorities)</li>
<li class=""><code>docs/runtime-command-queue-design.md</code> (command queue design)</li>
<li class=""><code>docs/content-dsl-schema-design.md</code> (content authoring)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-a--glossary">Appendix A — Glossary<a href="#appendix-a--glossary" class="hash-link" aria-label="Direct link to Appendix A — Glossary" title="Direct link to Appendix A — Glossary" translate="no">​</a></h2>
<ul>
<li class=""><strong>Automation</strong>: A content-defined rule that triggers commands without player interaction</li>
<li class=""><strong>Trigger</strong>: Condition that causes an automation to fire (interval, threshold, event, queue-empty)</li>
<li class=""><strong>Cooldown</strong>: Minimum time between automation firings</li>
<li class=""><strong>Resource Cost</strong>: Optional resource deduction when automation fires</li>
<li class=""><strong>Unlock Condition</strong>: Condition that determines if automation is available</li>
<li class=""><strong>Event Trigger</strong>: Automation that fires when a specific runtime event is published</li>
<li class=""><strong>Interval Trigger</strong>: Automation that fires periodically based on elapsed time</li>
<li class=""><strong>Resource Threshold Trigger</strong>: Automation that fires when resource amount crosses threshold</li>
<li class=""><strong>Command Queue Empty Trigger</strong>: Automation that fires when no commands are pending</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-b--change-log">Appendix B — Change Log<a href="#appendix-b--change-log" class="hash-link" aria-label="Direct link to Appendix B — Change Log" title="Direct link to Appendix B — Change Log" translate="no">​</a></h2>
<table><thead><tr><th>Date</th><th>Author</th><th>Change Summary</th></tr></thead><tbody><tr><td>2025-11-03</td><td>Claude Code</td><td>Initial draft based on issue #319 requirements</td></tr></tbody></table></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_QKxP"><a href="https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/automation-execution-system-design.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_wOWh" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_Basj"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_AUZ0 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#document-control" class="table-of-contents__link toc-highlight">Document Control</a></li><li><a href="#1-summary" class="table-of-contents__link toc-highlight">1. Summary</a></li><li><a href="#2-context--problem-statement" class="table-of-contents__link toc-highlight">2. Context &amp; Problem Statement</a><ul><li><a href="#background" class="table-of-contents__link toc-highlight">Background</a></li><li><a href="#problem" class="table-of-contents__link toc-highlight">Problem</a></li><li><a href="#forces" class="table-of-contents__link toc-highlight">Forces</a></li></ul></li><li><a href="#3-goals--non-goals" class="table-of-contents__link toc-highlight">3. Goals &amp; Non-Goals</a><ul><li><a href="#goals" class="table-of-contents__link toc-highlight">Goals</a></li><li><a href="#non-goals" class="table-of-contents__link toc-highlight">Non-Goals</a></li></ul></li><li><a href="#4-stakeholders-agents--impacted-surfaces" class="table-of-contents__link toc-highlight">4. Stakeholders, Agents &amp; Impacted Surfaces</a><ul><li><a href="#primary-stakeholders" class="table-of-contents__link toc-highlight">Primary Stakeholders</a></li><li><a href="#agent-roles" class="table-of-contents__link toc-highlight">Agent Roles</a></li><li><a href="#affected-packagesservices" class="table-of-contents__link toc-highlight">Affected Packages/Services</a></li><li><a href="#compatibility-considerations" class="table-of-contents__link toc-highlight">Compatibility Considerations</a></li></ul></li><li><a href="#5-current-state" class="table-of-contents__link toc-highlight">5. Current State</a><ul><li><a href="#existing-infrastructure" class="table-of-contents__link toc-highlight">Existing Infrastructure</a></li><li><a href="#gaps" class="table-of-contents__link toc-highlight">Gaps</a></li></ul></li><li><a href="#6-proposed-solution" class="table-of-contents__link toc-highlight">6. Proposed Solution</a><ul><li><a href="#61-architecture-overview" class="table-of-contents__link toc-highlight">6.1 Architecture Overview</a></li><li><a href="#62-detailed-design" class="table-of-contents__link toc-highlight">6.2 Detailed Design</a></li><li><a href="#63-operational-considerations" class="table-of-contents__link toc-highlight">6.3 Operational Considerations</a></li></ul></li><li><a href="#7-work-breakdown--delivery-plan" class="table-of-contents__link toc-highlight">7. Work Breakdown &amp; Delivery Plan</a><ul><li><a href="#71-issue-map" class="table-of-contents__link toc-highlight">7.1 Issue Map</a></li><li><a href="#72-milestones" class="table-of-contents__link toc-highlight">7.2 Milestones</a></li><li><a href="#73-coordination-notes" class="table-of-contents__link toc-highlight">7.3 Coordination Notes</a></li></ul></li><li><a href="#8-agent-guidance--guardrails" class="table-of-contents__link toc-highlight">8. Agent Guidance &amp; Guardrails</a><ul><li><a href="#context-packets" class="table-of-contents__link toc-highlight">Context Packets</a></li><li><a href="#prompting--constraints" class="table-of-contents__link toc-highlight">Prompting &amp; Constraints</a></li><li><a href="#safety-rails" class="table-of-contents__link toc-highlight">Safety Rails</a></li><li><a href="#validation-hooks" class="table-of-contents__link toc-highlight">Validation Hooks</a></li></ul></li><li><a href="#9-alternatives-considered" class="table-of-contents__link toc-highlight">9. Alternatives Considered</a><ul><li><a href="#alternative-1-poll-based-trigger-evaluation" class="table-of-contents__link toc-highlight">Alternative 1: Poll-Based Trigger Evaluation</a></li><li><a href="#alternative-2-separate-automation-worker" class="table-of-contents__link toc-highlight">Alternative 2: Separate Automation Worker</a></li><li><a href="#alternative-3-luajs-scripting-for-custom-triggers" class="table-of-contents__link toc-highlight">Alternative 3: Lua/JS Scripting for Custom Triggers</a></li></ul></li><li><a href="#10-testing--validation-plan" class="table-of-contents__link toc-highlight">10. Testing &amp; Validation Plan</a><ul><li><a href="#unit-tests" class="table-of-contents__link toc-highlight">Unit Tests</a></li><li><a href="#integration-tests" class="table-of-contents__link toc-highlight">Integration Tests</a></li><li><a href="#performance-tests" class="table-of-contents__link toc-highlight">Performance Tests</a></li><li><a href="#property-based-tests" class="table-of-contents__link toc-highlight">Property-Based Tests</a></li><li><a href="#accessibility-tests" class="table-of-contents__link toc-highlight">Accessibility Tests</a></li></ul></li><li><a href="#11-risks--mitigations" class="table-of-contents__link toc-highlight">11. Risks &amp; Mitigations</a><ul><li><a href="#risk-performance-degradation-with-large-automation-counts" class="table-of-contents__link toc-highlight">Risk: Performance Degradation with Large Automation Counts</a></li><li><a href="#risk-infinite-trigger-loops" class="table-of-contents__link toc-highlight">Risk: Infinite Trigger Loops</a></li><li><a href="#risk-determinism-violations" class="table-of-contents__link toc-highlight">Risk: Determinism Violations</a></li><li><a href="#risk-save-migration-failures" class="table-of-contents__link toc-highlight">Risk: Save Migration Failures</a></li></ul></li><li><a href="#12-rollout-plan" class="table-of-contents__link toc-highlight">12. Rollout Plan</a><ul><li><a href="#milestones" class="table-of-contents__link toc-highlight">Milestones</a></li><li><a href="#migration-strategy" class="table-of-contents__link toc-highlight">Migration Strategy</a></li><li><a href="#communication" class="table-of-contents__link toc-highlight">Communication</a></li></ul></li><li><a href="#13-open-questions" class="table-of-contents__link toc-highlight">13. Open Questions</a></li><li><a href="#14-follow-up-work" class="table-of-contents__link toc-highlight">14. Follow-Up Work</a></li><li><a href="#15-references" class="table-of-contents__link toc-highlight">15. References</a></li><li><a href="#appendix-a--glossary" class="table-of-contents__link toc-highlight">Appendix A — Glossary</a></li><li><a href="#appendix-b--change-log" class="table-of-contents__link toc-highlight">Appendix B — Change Log</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/contributor-handbook">Contributor Handbook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Idle Engine.</div></div></div></footer></div>
</body>
</html>