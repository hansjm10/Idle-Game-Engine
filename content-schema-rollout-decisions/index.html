<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-content-schema-rollout-decisions" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Content Schema Rollout Decisions | Idle Engine Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hansjm10.github.io/Idle-Game-Engine/content-schema-rollout-decisions"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Content Schema Rollout Decisions | Idle Engine Docs"><meta data-rh="true" name="description" content="This document captures key architectural decisions and risk mitigation strategies for the content schema system. It addresses open questions from the content schema design document and provides guidance for production rollout."><meta data-rh="true" property="og:description" content="This document captures key architectural decisions and risk mitigation strategies for the content schema system. It addresses open questions from the content schema design document and provides guidance for production rollout."><link data-rh="true" rel="icon" href="/Idle-Game-Engine/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hansjm10.github.io/Idle-Game-Engine/content-schema-rollout-decisions"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/content-schema-rollout-decisions" hreflang="en"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/content-schema-rollout-decisions" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Content Schema Rollout Decisions","item":"https://hansjm10.github.io/Idle-Game-Engine/content-schema-rollout-decisions"}]}</script><link rel="stylesheet" href="/Idle-Game-Engine/assets/css/styles.ddf7989c.css">
<script src="/Idle-Game-Engine/assets/js/runtime~main.4e2fc74c.js" defer="defer"></script>
<script src="/Idle-Game-Engine/assets/js/main.12436fc9.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Idle-Game-Engine/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_li4T" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Idle-Game-Engine/"><div class="navbar__logo"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--light_vaEm"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--dark_axH8"></div><b class="navbar__title text--truncate">Idle Engine</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Idle-Game-Engine/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle__Exw colorModeToggle_Lslw"><button class="clean-btn toggleButton_AMBK toggleButtonDisabled_p4Bd" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 lightToggleIcon_p2sk"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 darkToggleIcon_B2qX"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 systemToggleIcon_PWgn"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_RKai"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_nqaE"><div class="docsWrapper_CSLE"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sOWX" type="button"></button><div class="docRoot_qxtV"><aside class="theme-doc-sidebar-container docSidebarContainer_Xlvo"><div class="sidebarViewport_tjEA"><div class="sidebar_ubOv"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_CfkH"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/Idle-Game-Engine/"><span title="Getting Started" class="categoryLinkLabel_ebxo">Getting Started</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/"><span title="Overview" class="linkLabel_KsAJ">Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/contributor-handbook"><span title="Contributor Handbook" class="linkLabel_KsAJ">Contributor Handbook</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/role-index"><span title="Role Index" class="linkLabel_KsAJ">Role Index</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/design-document-template"><span title="Design Document Template" class="linkLabel_KsAJ">Design Document Template</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/idle-engine-design"><span title="Core Runtime" class="categoryLinkLabel_ebxo">Core Runtime</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/Idle-Game-Engine/content-dsl-schema-design"><span title="Content Pipeline" class="categoryLinkLabel_ebxo">Content Pipeline</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/content-dsl-schema-design"><span title="Content DSL Schema Design" class="linkLabel_KsAJ">Content DSL Schema Design</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/content-dsl-usage-guidelines"><span title="Content DSL Usage Guidelines" class="linkLabel_KsAJ">Content DSL Usage Guidelines</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/content-compiler-design"><span title="Content Compiler Design" class="linkLabel_KsAJ">Content Compiler Design</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Idle-Game-Engine/content-schema-rollout-decisions"><span title="Content Schema Rollout Decisions" class="linkLabel_KsAJ">Content Schema Rollout Decisions</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/content-validation-cli-design"><span title="Content Validation CLI Design" class="linkLabel_KsAJ">Content Validation CLI Design</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/accessibility-smoke-tests-design"><span title="Shell Integration" class="categoryLinkLabel_ebxo">Shell Integration</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/coverage/"><span title="Diagnostics &amp; Quality" class="categoryLinkLabel_ebxo">Diagnostics &amp; Quality</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/implementation-plan"><span title="Operations &amp; Process" class="categoryLinkLabel_ebxo">Operations &amp; Process</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_tfRv"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_hyci"><div class="docItemContainer_tcAC"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_bxbs" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/Idle-Game-Engine/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_p1A9"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Content Pipeline</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Content Schema Rollout Decisions</span></li></ul></nav><div class="tocCollapsible_WMbj theme-doc-toc-mobile tocMobile_wI3e"><button type="button" class="clean-btn tocCollapsibleButton_rjEa">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Content Schema Rollout Decisions</h1></header>
<p>This document captures key architectural decisions and risk mitigation strategies for the content schema system. It addresses open questions from the content schema design document and provides guidance for production rollout.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="document-control">Document Control<a href="#document-control" class="hash-link" aria-label="Direct link to Document Control" title="Direct link to Document Control" translate="no">​</a></h2>
<ul>
<li class=""><strong>Title</strong>: Content Schema Rollout Decisions and Risk Mitigation</li>
<li class=""><strong>Authors</strong>: Content Pipeline Team</li>
<li class=""><strong>Reviewers</strong>: N/A</li>
<li class=""><strong>Status</strong>: Approved</li>
<li class=""><strong>Last Updated</strong>: 2025-10-21</li>
<li class=""><strong>Related Issues</strong>: #137 (Parent: #11)</li>
<li class=""><strong>Execution Mode</strong>: Hybrid</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="1-summary">1. Summary<a href="#1-summary" class="hash-link" aria-label="Direct link to 1. Summary" title="Direct link to 1. Summary" translate="no">​</a></h2>
<p>This document addresses critical design decisions for the content schema system&#x27;s production rollout, including icon path generation strategy, guild perk persistence integration, scripted modifier support, and schema digest migration patterns. It also tracks mitigation status for six identified risks and provides property-based formula sanitization guidance. All decisions enable Phase 2 content DSL implementation while deferring complex features to later phases.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="2-context--problem-statement">2. Context &amp; Problem Statement<a href="#2-context--problem-statement" class="hash-link" aria-label="Direct link to 2. Context &amp; Problem Statement" title="Direct link to 2. Context &amp; Problem Statement" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="background">Background<a href="#background" class="hash-link" aria-label="Direct link to Background" title="Direct link to Background" translate="no">​</a></h3>
<p>The content schema design document (docs/content-dsl-schema-design.md) established the foundation for declarative content authoring but left several open questions in Section 10 and identified risks in Section 7 requiring resolution before production rollout.</p>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="problem">Problem<a href="#problem" class="hash-link" aria-label="Direct link to Problem" title="Direct link to Problem" translate="no">​</a></h3>
<p>Four critical design questions needed resolution:</p>
<ol>
<li class="">Should the schema expose calculated presentation defaults (e.g., auto-generated icon paths)?</li>
<li class="">How will guild perk costs interface with social-service data when live persistence lands?</li>
<li class="">Do we need additional effect types (e.g., scripted modifiers) before schema v1.0?</li>
<li class="">What is the migration strategy when schema digests change?</li>
</ol>
<p>Additionally, six identified risks required mitigation tracking and implementation validation.</p>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="forces">Forces<a href="#forces" class="hash-link" aria-label="Direct link to Forces" title="Direct link to Forces" translate="no">​</a></h3>
<ul>
<li class=""><strong>Timeline</strong>: Phase 2 implementation (Weeks 2-4) depends on these decisions</li>
<li class=""><strong>Compatibility</strong>: Must support incremental rollout across runtime versions</li>
<li class=""><strong>Performance</strong>: Validation must handle large content packs efficiently</li>
<li class=""><strong>Author Experience</strong>: Schema strictness must balance safety with usability</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="3-goals--non-goals">3. Goals &amp; Non-Goals<a href="#3-goals--non-goals" class="hash-link" aria-label="Direct link to 3. Goals &amp; Non-Goals" title="Direct link to 3. Goals &amp; Non-Goals" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="goals">Goals<a href="#goals" class="hash-link" aria-label="Direct link to Goals" title="Direct link to Goals" translate="no">​</a></h3>
<ul>
<li class="">Resolve all Section 10 open questions from content schema design</li>
<li class="">Track mitigation status for all Section 7 risks</li>
<li class="">Define clear implementation roadmap for deferred features</li>
<li class="">Provide actionable guidance for content authors and compiler implementers</li>
<li class="">Enable Phase 2 (Content DSL &amp; Sample Pack) to proceed unblocked</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="non-goals">Non-Goals<a href="#non-goals" class="hash-link" aria-label="Direct link to Non-Goals" title="Direct link to Non-Goals" translate="no">​</a></h3>
<ul>
<li class="">Implementing scripting runtime (deferred to Phase 7+)</li>
<li class="">Designing guild persistence schema (deferred to Phase 5)</li>
<li class="">Building compiler icon resolution (follow-up issue)</li>
<li class="">Creating save file format specification (Phase 4 work)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="4-stakeholders-agents--impacted-surfaces">4. Stakeholders, Agents &amp; Impacted Surfaces<a href="#4-stakeholders-agents--impacted-surfaces" class="hash-link" aria-label="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" title="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="primary-stakeholders">Primary Stakeholders<a href="#primary-stakeholders" class="hash-link" aria-label="Direct link to Primary Stakeholders" title="Direct link to Primary Stakeholders" translate="no">​</a></h3>
<ul>
<li class="">Content Pipeline Team (schema maintenance)</li>
<li class="">Runtime Implementation Team (core engine integration)</li>
<li class="">Game Design Lead (prestige/formula requirements)</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="agent-roles">Agent Roles<a href="#agent-roles" class="hash-link" aria-label="Direct link to Agent Roles" title="Direct link to Agent Roles" translate="no">​</a></h3>
<p>N/A - This is a decision document, not an implementation plan.</p>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="affected-packagesservices">Affected Packages/Services<a href="#affected-packagesservices" class="hash-link" aria-label="Direct link to Affected Packages/Services" title="Direct link to Affected Packages/Services" translate="no">​</a></h3>
<ul>
<li class=""><code>packages/content-schema</code> - Schema definitions and validation</li>
<li class=""><code>packages/core</code> - Runtime integration</li>
<li class=""><code>services/social</code> - Guild persistence (future)</li>
<li class=""><code>tools/content-schema-cli</code> - Validation and compilation tooling</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="compatibility-considerations">Compatibility Considerations<a href="#compatibility-considerations" class="hash-link" aria-label="Direct link to Compatibility Considerations" title="Direct link to Compatibility Considerations" translate="no">​</a></h3>
<p>All decisions maintain backward compatibility with existing content packs. New features use feature gates (FEATURE_GATES in runtime-compat.ts) to enable incremental adoption.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="5-current-state">5. Current State<a href="#5-current-state" class="hash-link" aria-label="Direct link to 5. Current State" title="Direct link to 5. Current State" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="schema-implementation-status">Schema Implementation Status<a href="#schema-implementation-status" class="hash-link" aria-label="Direct link to Schema Implementation Status" title="Direct link to Schema Implementation Status" translate="no">​</a></h3>
<ul>
<li class="">All core modules implemented (resources, generators, upgrades, achievements, prestige layers, guild perks)</li>
<li class="">Formula system with numeric expressions, common curves, and safe math operations</li>
<li class="">Feature gate system mapping runtime versions to schema modules</li>
<li class="">Cross-reference validation with structured error reporting</li>
<li class="">Property-based testing for formula sanitization</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="integration-points">Integration Points<a href="#integration-points" class="hash-link" aria-label="Direct link to Integration Points" title="Direct link to Integration Points" translate="no">​</a></h3>
<ul>
<li class="">Content compiler emits deterministic artifacts during <code>pnpm generate</code></li>
<li class=""><code>@idle-engine/content-sample</code> imports generated modules</li>
<li class="">Structured JSON event logging for automation</li>
<li class="">Digest verification in development mode</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="outstanding-dependencies">Outstanding Dependencies<a href="#outstanding-dependencies" class="hash-link" aria-label="Direct link to Outstanding Dependencies" title="Direct link to Outstanding Dependencies" translate="no">​</a></h3>
<ul>
<li class="">Scripting design document does not exist</li>
<li class="">Guild persistence schema not yet designed (Phase 5)</li>
<li class="">Save file format specification pending (Phase 4)</li>
<li class="">Compiler icon resolution strategy undefined</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="6-proposed-solution">6. Proposed Solution<a href="#6-proposed-solution" class="hash-link" aria-label="Direct link to 6. Proposed Solution" title="Direct link to 6. Proposed Solution" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="61-architecture-overview">6.1 Architecture Overview<a href="#61-architecture-overview" class="hash-link" aria-label="Direct link to 6.1 Architecture Overview" title="Direct link to 6.1 Architecture Overview" translate="no">​</a></h3>
<p>The solution addresses each open question with a clear decision, rationale, and implementation roadmap. Decisions prioritize:</p>
<ul>
<li class=""><strong>Separation of concerns</strong>: Schema remains presentation-agnostic</li>
<li class=""><strong>Incremental delivery</strong>: Complex features deferred to appropriate phases</li>
<li class=""><strong>Extensibility</strong>: Feature gates and versioning support evolution</li>
<li class=""><strong>Safety</strong>: Validation and migration strategies protect user data</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="62-detailed-design">6.2 Detailed Design<a href="#62-detailed-design" class="hash-link" aria-label="Direct link to 6.2 Detailed Design" title="Direct link to 6.2 Detailed Design" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="decision-1-icon-path-default-generation">Decision 1: Icon Path Default Generation<a href="#decision-1-icon-path-default-generation" class="hash-link" aria-label="Direct link to Decision 1: Icon Path Default Generation" title="Direct link to Decision 1: Icon Path Default Generation" translate="no">​</a></h4>
<p><strong>Decision</strong>: Leave icon path defaults to the compiler/presentation layer.</p>
<p><strong>Rationale</strong>:</p>
<ul>
<li class="">Schema should remain presentation-agnostic per design principles</li>
<li class="">Asset bundling and path resolution vary by deployment (Vite, Webpack, CDN)</li>
<li class="">Compiler can implement convention-based defaults when transforming packs</li>
<li class="">Allows flexibility for different presentation layers (web, mobile, terminal UI)</li>
</ul>
<p><strong>Current State</strong>:</p>
<ul>
<li class="">Icon fields are optional strings in all modules</li>
<li class="">Schema: <code>icon: z.string().trim().min(1).max(256).optional()</code></li>
<li class="">No automatic path generation or validation exists</li>
</ul>
<p><strong>Action Items</strong>:</p>
<ul>
<li class="">Document icon asset conventions in compiler specification (follow-up issue)</li>
<li class="">Add optional <code>iconPath</code> validation to check extension types (.svg, .png, .webp)</li>
<li class="">Consider adding <code>iconPathSchema</code> with URL validation when compiler spec lands</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="decision-2-guild-perk-persistence-integration">Decision 2: Guild Perk Persistence Integration<a href="#decision-2-guild-perk-persistence-integration" class="hash-link" aria-label="Direct link to Decision 2: Guild Perk Persistence Integration" title="Direct link to Decision 2: Guild Perk Persistence Integration" translate="no">​</a></h4>
<p><strong>Decision</strong>: Defer guild-specific cost modeling to Phase 5 persistence implementation.</p>
<p><strong>Rationale</strong>:</p>
<ul>
<li class="">Current <code>cost</code> schema is flexible enough for prototype phase (Issue #11, Phase 0-4)</li>
<li class="">Guild persistence design is not yet finalized (Phase 5: Weeks 5-7)</li>
<li class="">Schema can be extended with <code>GuildCostSchema</code> when social service adds persistence</li>
<li class="">FEATURE_GATES already restrict guild perks to runtime &gt;=0.5.0</li>
</ul>
<p><strong>Current State</strong>:</p>
<ul>
<li class="">Guild perk schema complete in <code>packages/content-schema/src/modules/guild-perks.ts</code></li>
<li class="">Social service has stub guild routes (<code>services/social/src/routes/guild.ts</code>)</li>
<li class="">Persistence is in-memory only (Phase 5 work per implementation plan)</li>
<li class="">No database schema exists for guild perks or guild state</li>
</ul>
<p><strong>Phase 5 Follow-up</strong> (Issue #138 recommended):</p>
<ul>
<li class="">Design guild persistence schema (Postgres tables: guilds, guild_perks, member_contributions)</li>
<li class="">Add <code>GuildResourceDefinition</code> with ownership semantics (guild-scoped vs player-scoped)</li>
<li class="">Extend cost schema with <code>scope: &#x27;player&#x27; | &#x27;guild&#x27;</code> discriminator if needed</li>
<li class="">Add validation ensuring guild perk costs only reference guild-category resources</li>
</ul>
<p><strong>Acceptance Criteria for Phase 5</strong>:</p>
<ul>
<li class="">Social service persists guild perk unlock state</li>
<li class="">Content packs can define guild-scoped currency resources</li>
<li class="">Validation ensures guild perk costs reference valid guild currencies</li>
<li class="">Documentation examples show guild contribution tracking</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="decision-3-scripted-modifiers--effect-types">Decision 3: Scripted Modifiers &amp; Effect Types<a href="#decision-3-scripted-modifiers--effect-types" class="hash-link" aria-label="Direct link to Decision 3: Scripted Modifiers &amp; Effect Types" title="Direct link to Decision 3: Scripted Modifiers &amp; Effect Types" translate="no">​</a></h4>
<p><strong>Decision</strong>: Defer scripted modifiers until scripting design document and runtime sandbox land.</p>
<p><strong>Rationale</strong>:</p>
<ul>
<li class="">Current formula system covers prototype phase needs (Phase 0-6 in implementation-plan.md)</li>
<li class="">Scripting requires security sandbox design (docs/idle-engine-design.md Section 6.3: &quot;Sandbox third-party scripts&quot;)</li>
<li class="">Feature gate model supports incremental rollout (runtime-compat.ts FEATURE_GATES)</li>
<li class="">No content pack has requested scripted modifiers yet</li>
</ul>
<p><strong>Current State</strong>:
Upgrade effects support these variants (upgrades.ts:79-124):</p>
<ul>
<li class=""><code>modifyResourceRate</code>: Formula-based resource adjustments</li>
<li class=""><code>modifyResourceCapacity</code>: Formula-based resource capacity adjustments</li>
<li class=""><code>modifyGeneratorRate</code>: Formula-based generator production</li>
<li class=""><code>modifyGeneratorCost</code>: Formula-based cost scaling</li>
<li class=""><code>grantAutomation</code>: Enable automation toggles</li>
<li class=""><code>grantFlag</code>: Set boolean flags</li>
<li class=""><code>unlockResource</code> / <code>unlockGenerator</code>: Entity unlocking</li>
<li class=""><code>alterDirtyTolerance</code>: Precision threshold adjustments</li>
<li class=""><code>emitEvent</code>: Trigger runtime events</li>
</ul>
<p>All modification effects use <code>NumericFormula</code> (formulas.ts), which supports:</p>
<ul>
<li class="">Structured expressions with typed references</li>
<li class="">Common curves (linear, exponential, polynomial, piecewise)</li>
<li class="">Safe math operations (add, sub, mul, div, pow, min, max)</li>
<li class="">Function calls against allowlist (clamp, lerp, etc.)</li>
</ul>
<p><strong>Schema v1.0 Requirements</strong> (Satisfied):</p>
<ul>
<li class="">Formula-based modifiers for common progressions</li>
<li class="">Flag/script condition hooks for extensibility</li>
<li class="">Event emission for trigger chains</li>
<li class="">Effect composition via upgrade stacking</li>
</ul>
<p><strong>Phase 7+ Follow-up</strong> (Issue #139 recommended):</p>
<ul>
<li class="">Author scripting design document (sandbox model, API surface, determinism guarantees)</li>
<li class="">Implement script runtime with deterministic execution</li>
<li class="">Add <code>scriptedEffect</code> upgrade effect type</li>
<li class="">Update FEATURE_GATES with <code>scriptedEffects</code> introduced in appropriate version</li>
<li class="">Add content-schema validation ensuring scriptId references allowlisted scripts</li>
</ul>
<p><strong>Acceptance Criteria for Scripted Modifiers</strong>:</p>
<ul>
<li class="">Scripting design doc approved and sandbox implemented</li>
<li class="">Script execution is deterministic (seeded RNG, no async)</li>
<li class="">Scripts cannot access DOM or host environment</li>
<li class="">Validation enforces script allowlists per ContentSchemaOptions</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="decision-4-schema-digest-migration-strategy">Decision 4: Schema Digest Migration Strategy<a href="#decision-4-schema-digest-migration-strategy" class="hash-link" aria-label="Direct link to Decision 4: Schema Digest Migration Strategy" title="Direct link to Decision 4: Schema Digest Migration Strategy" translate="no">​</a></h4>
<p><strong>Decision</strong>: Embed both pack version AND digest in save files (hybrid approach).</p>
<p><strong>Rationale</strong>:</p>
<ul>
<li class="">Pack version (semver) enables human-readable compatibility decisions</li>
<li class="">Digest provides cryptographic-strength change detection like event manifests</li>
<li class="">Supports offline validation (no registry lookup needed)</li>
<li class="">Enables granular migration decisions (version -&gt; which migration steps, digest -&gt; exact content state)</li>
<li class="">Aligns with runtime event manifest pattern (proven approach)</li>
</ul>
<p><strong>Current State</strong>:</p>
<p>Digest Implementation (<code>packages/content-schema/src/pack/normalize.ts</code>):</p>
<ul>
<li class="">FNV-1a hash of pack metadata + module id lists</li>
<li class="">Format: <code>{ version: number; hash: string }</code> (e.g., <code>fnv1a-a3c2f1b8</code>)</li>
<li class="">Digest version: <code>CONTENT_PACK_DIGEST_VERSION = 1</code></li>
<li class="">Computed during <code>normalizeContentPack</code>, included in <code>NormalizedContentPack.digest</code></li>
</ul>
<p>Runtime Event Manifest Approach (runtime-event-manifest-authoring.md:38-43):</p>
<ul>
<li class="">Manifest hash embedded in event frames for replay validation</li>
<li class="">Hash checked during recording and playback</li>
<li class="">Failures trigger &quot;rerun pnpm generate&quot; guidance</li>
<li class="">Deterministic hash ensures replay integrity</li>
</ul>
<p>Save System Status (implementation-plan.md Phase 4):</p>
<ul>
<li class="">Phase 4: &quot;Implement save slot manager (IndexedDB/localStorage) with migration hooks&quot;</li>
<li class="">Versioned schemas mentioned in design (docs/idle-engine-design.md Section 6.2)</li>
<li class="">No save format specification exists yet</li>
<li class="">Migration pipeline not yet designed</li>
</ul>
<p><strong>Proposed Save Format Extension</strong>:</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">SaveFileMetadata</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Save format version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  createdAt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ISO-8601 timestamp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  runtimeVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Engine version (semver)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  contentPacks</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Array</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Pack slug</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    version</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Pack version (semver)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    digest</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Digest format version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hash</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// FNV-1a hash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ... other metadata</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Migration Decision Tree</strong>:</p>
<div class="language-text codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-text codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token plain">Load save:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1. Check runtimeVersion compatibility (semver range check)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2. For each contentPacks entry:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     a. Lookup installed pack by id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     b. Compare version (semver):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Exact match -&gt; check digest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Compatible minor/patch -&gt; check for migrations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Incompatible major -&gt; error or force migration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     c. Compare digest:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Match -&gt; no migration needed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - Mismatch -&gt; run pack-specific migrations</span><br></span></code></pre></div></div>
<p><strong>Implementation Actions</strong> (Issue #140 recommended - Phase 4):</p>
<ul>
<li class="">Design save file format with content pack manifests</li>
<li class="">Implement save metadata serialization including digests</li>
<li class="">Add migration registry (packId + version range -&gt; migration functions)</li>
<li class="">Create <code>validateSaveCompatibility(save, installedPacks)</code> utility</li>
<li class="">Document migration authoring guide for content pack maintainers</li>
<li class="">Add tests for cross-version save loading</li>
</ul>
<p><strong>Edge Cases to Handle</strong>:</p>
<ul>
<li class=""><strong>Pack removed</strong>: User uninstalls pack but has save referencing it (warning + option to continue with missing content)</li>
<li class=""><strong>Digest mismatch, same version</strong>: Content changed without version bump (warn but allow, or force version bump in CI)</li>
<li class=""><strong>Multiple packs, cascading dependencies</strong>: Validate dependency graph before migration (see dependencies.ts)</li>
<li class=""><strong>Partial migration failure</strong>: Rollback or fallback strategy (atomic migration transactions)</li>
</ul>
<p><strong>Acceptance Criteria</strong>:</p>
<ul>
<li class="">Save files include content pack manifests with versions and digests</li>
<li class="">Loading a save checks compatibility before hydration</li>
<li class="">Incompatible saves trigger migration flow with user consent</li>
<li class="">Migrations can be tested independently via fixtures</li>
<li class="">Documentation includes migration authoring examples</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="63-operational-considerations">6.3 Operational Considerations<a href="#63-operational-considerations" class="hash-link" aria-label="Direct link to 6.3 Operational Considerations" title="Direct link to 6.3 Operational Considerations" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="deployment">Deployment<a href="#deployment" class="hash-link" aria-label="Direct link to Deployment" title="Direct link to Deployment" translate="no">​</a></h4>
<ul>
<li class="">Required workflow: <code>pnpm generate</code> validates every discovered pack before the compiler writes artifacts</li>
<li class="">After editing any pack JSON, schema file, or runtime event manifest, run <code>pnpm generate</code> (or <code>pnpm generate --check</code> for CI/Lefthook) and commit resulting updates</li>
<li class="">Watch mode keeps the process alive across failures while still surfacing non-zero exit codes on termination</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="telemetry--observability">Telemetry &amp; Observability<a href="#telemetry--observability" class="hash-link" aria-label="Direct link to Telemetry &amp; Observability" title="Direct link to Telemetry &amp; Observability" translate="no">​</a></h4>
<ul>
<li class="">Structured logging: CLI emits JSON events (<code>content_pack.validated</code>, <code>content_pack.validation_failed</code>, <code>content_pack.compiled</code>, <code>content_pack.pruned</code>, <code>watch.run</code>, etc.)</li>
<li class="">Summary contract: Treat <code>content/compiled/index.json</code> as the canonical record of validation and compilation outcomes</li>
<li class="">Digest verification: <code>rehydrateNormalizedPack</code> recomputes digest when <code>NODE_ENV !== &#x27;production&#x27;</code></li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="common-failures">Common Failures<a href="#common-failures" class="hash-link" aria-label="Direct link to Common Failures" title="Direct link to Common Failures" translate="no">​</a></h4>
<ul>
<li class=""><strong>Import-time warning error</strong>: Fix schema warnings surfaced in compiler log or add contextual suppressions before retrying</li>
<li class=""><strong>Digest mismatch</strong>: Ensure artifacts were regenerated (use <code>pnpm generate --clean</code>), verify custom post-processing didn&#x27;t mutate the generated module, re-run tests</li>
<li class=""><strong>Stale summary</strong>: If <code>content/compiled/index.json</code> reports outdated versions or warning counts, rerun <code>pnpm generate</code> so validation and compilation refresh the summary before committing artifacts</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="7-work-breakdown--delivery-plan">7. Work Breakdown &amp; Delivery Plan<a href="#7-work-breakdown--delivery-plan" class="hash-link" aria-label="Direct link to 7. Work Breakdown &amp; Delivery Plan" title="Direct link to 7. Work Breakdown &amp; Delivery Plan" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="71-issue-map">7.1 Issue Map<a href="#71-issue-map" class="hash-link" aria-label="Direct link to 7.1 Issue Map" title="Direct link to 7.1 Issue Map" translate="no">​</a></h3>
<table><thead><tr><th>Issue Title</th><th>Scope Summary</th><th>Proposed Assignee/Agent</th><th>Dependencies</th><th>Acceptance Criteria</th></tr></thead><tbody><tr><td>#138: Design guild persistence schema</td><td>Guild-scoped resources, cost model extension</td><td>Backend Team</td><td>Phase 5 start</td><td>Schema supports guild currencies, validation complete</td></tr><tr><td>#139: Scripting design document and scripted effect support</td><td>Sandbox model, scripted effect type</td><td>Runtime Team</td><td>Scripting design approval</td><td>Design doc approved, scripted effects implemented with security sandbox</td></tr><tr><td>#140: Save file format with content pack manifests</td><td>Save metadata, migration registry</td><td>Persistence Team</td><td>Phase 4 start</td><td>Save files include pack manifests, migrations tested</td></tr><tr><td>#141: CI schema compatibility checks</td><td>Runtime version validation</td><td>DevOps Team</td><td>None</td><td>CI blocks releases on schema drift</td></tr><tr><td>#142: Complete cycle detection for transform chains</td><td>Graph analysis for transforms</td><td>Runtime Team</td><td>None</td><td>Cycle detection tests passing</td></tr><tr><td>#143: Validation performance benchmarks</td><td>Caching, profiling</td><td>Performance Team</td><td>Phase 6</td><td>Validation under 100ms for 100+ entity packs</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="72-milestones">7.2 Milestones<a href="#72-milestones" class="hash-link" aria-label="Direct link to 7.2 Milestones" title="Direct link to 7.2 Milestones" translate="no">​</a></h3>
<ul>
<li class=""><strong>Phase 2 (Weeks 2-4)</strong>: Content DSL &amp; Sample Pack - UNBLOCKED by this document</li>
<li class=""><strong>Phase 4 (Weeks 4-5)</strong>: Save file format implementation (Issue #140)</li>
<li class=""><strong>Phase 5 (Weeks 5-7)</strong>: Guild persistence schema (Issue #138)</li>
<li class=""><strong>Phase 6</strong>: Performance optimization (Issue #143)</li>
<li class=""><strong>Phase 7+</strong>: Scripting runtime (Issue #139)</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="73-coordination-notes">7.3 Coordination Notes<a href="#73-coordination-notes" class="hash-link" aria-label="Direct link to 7.3 Coordination Notes" title="Direct link to 7.3 Coordination Notes" translate="no">​</a></h3>
<p>All decisions documented here have been reviewed and approved. Follow-up issues should reference this document for context and rationale.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="8-agent-guidance--guardrails">8. Agent Guidance &amp; Guardrails<a href="#8-agent-guidance--guardrails" class="hash-link" aria-label="Direct link to 8. Agent Guidance &amp; Guardrails" title="Direct link to 8. Agent Guidance &amp; Guardrails" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="context-packets">Context Packets<a href="#context-packets" class="hash-link" aria-label="Direct link to Context Packets" title="Direct link to Context Packets" translate="no">​</a></h3>
<ul>
<li class="">Content schema design document: <code>docs/content-dsl-schema-design.md</code></li>
<li class="">Property-based formula sanitization design: <code>docs/property-based-formula-sanitization-design.md</code></li>
<li class="">Content validation CLI design: <code>docs/content-validation-cli-design.md</code></li>
<li class="">Runtime event manifest authoring: <code>docs/runtime-event-manifest-authoring.md</code></li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="prompting--constraints">Prompting &amp; Constraints<a href="#prompting--constraints" class="hash-link" aria-label="Direct link to Prompting &amp; Constraints" title="Direct link to Prompting &amp; Constraints" translate="no">​</a></h3>
<ul>
<li class="">Always run <code>pnpm generate</code> after schema changes</li>
<li class="">Use <code>pnpm generate --check</code> in CI to detect drift</li>
<li class="">Commit compiled artifacts alongside source changes</li>
<li class="">Reference issue #11 as parent for all follow-up work</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="safety-rails">Safety Rails<a href="#safety-rails" class="hash-link" aria-label="Direct link to Safety Rails" title="Direct link to Safety Rails" translate="no">​</a></h3>
<ul>
<li class="">Never bypass digest verification in development mode</li>
<li class="">Never mutate generated modules after compilation</li>
<li class="">Always validate cross-references before committing schema changes</li>
<li class="">Never skip property-based tests when adding formula types</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="validation-hooks">Validation Hooks<a href="#validation-hooks" class="hash-link" aria-label="Direct link to Validation Hooks" title="Direct link to Validation Hooks" translate="no">​</a></h3>
<p>Schema coverage:</p>
<div class="language-bash codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-bash codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token plain">pnpm --filter @idle-engine/content-schema test -- --run createFormulaArbitrary</span><br></span></code></pre></div></div>
<p>CLI coverage:</p>
<div class="language-bash codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-bash codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token plain">pnpm --filter @idle-engine/content-validation-cli test -- --run &quot;validateContentPacks property&quot;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="9-alternatives-considered">9. Alternatives Considered<a href="#9-alternatives-considered" class="hash-link" aria-label="Direct link to 9. Alternatives Considered" title="Direct link to 9. Alternatives Considered" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="icon-path-generation-alternatives">Icon Path Generation Alternatives<a href="#icon-path-generation-alternatives" class="hash-link" aria-label="Direct link to Icon Path Generation Alternatives" title="Direct link to Icon Path Generation Alternatives" translate="no">​</a></h3>
<table><thead><tr><th>Approach</th><th>Pros</th><th>Cons</th><th>Decision</th></tr></thead><tbody><tr><td>Schema-level defaults</td><td>Consistent paths across all packs</td><td>Couples schema to presentation layer</td><td>Rejected</td></tr><tr><td>Compiler-level defaults</td><td>Flexible, deployment-aware</td><td>Requires compiler spec first</td><td><strong>Selected</strong> (deferred to compiler design)</td></tr><tr><td>No defaults</td><td>Maximum flexibility</td><td>Author friction</td><td>Rejected</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="guild-cost-model-alternatives">Guild Cost Model Alternatives<a href="#guild-cost-model-alternatives" class="hash-link" aria-label="Direct link to Guild Cost Model Alternatives" title="Direct link to Guild Cost Model Alternatives" translate="no">​</a></h3>
<table><thead><tr><th>Approach</th><th>Pros</th><th>Cons</th><th>Decision</th></tr></thead><tbody><tr><td>Extend schema now</td><td>Future-proof</td><td>No persistence design yet</td><td>Rejected</td></tr><tr><td>Generic cost schema</td><td>Works today</td><td>May need refactor later</td><td><strong>Selected</strong> (defer to Phase 5)</td></tr><tr><td>Separate guild currency type</td><td>Type-safe</td><td>Premature optimization</td><td>Rejected</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="scripted-modifier-alternatives">Scripted Modifier Alternatives<a href="#scripted-modifier-alternatives" class="hash-link" aria-label="Direct link to Scripted Modifier Alternatives" title="Direct link to Scripted Modifier Alternatives" translate="no">​</a></h3>
<table><thead><tr><th>Approach</th><th>Pros</th><th>Cons</th><th>Decision</th></tr></thead><tbody><tr><td>Add scripted effects now</td><td>Feature complete</td><td>No sandbox design</td><td>Rejected</td></tr><tr><td>Formula-only v1.0</td><td>Safe, deterministic</td><td>Limited expressiveness</td><td><strong>Selected</strong> (defer scripting to Phase 7+)</td></tr><tr><td>Hybrid (formulas + hooks)</td><td>Extensible</td><td>Complexity creep</td><td>Rejected</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="digest-embedding-alternatives">Digest Embedding Alternatives<a href="#digest-embedding-alternatives" class="hash-link" aria-label="Direct link to Digest Embedding Alternatives" title="Direct link to Digest Embedding Alternatives" translate="no">​</a></h3>
<table><thead><tr><th>Approach</th><th>Pros</th><th>Cons</th><th>Decision</th></tr></thead><tbody><tr><td>Embed digest only</td><td>Fast validation</td><td>No semantic versioning</td><td>Rejected</td></tr><tr><td>Store version only</td><td>Smaller saves</td><td>Requires registry lookup</td><td>Rejected</td></tr><tr><td>Hybrid (version + digest)</td><td>Best of both</td><td>Larger saves</td><td><strong>Selected</strong></td></tr><tr><td>No embedding</td><td>Smallest saves</td><td>Cannot detect incompatibility</td><td>Rejected</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="10-testing--validation-plan">10. Testing &amp; Validation Plan<a href="#10-testing--validation-plan" class="hash-link" aria-label="Direct link to 10. Testing &amp; Validation Plan" title="Direct link to 10. Testing &amp; Validation Plan" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="unit--integration">Unit / Integration<a href="#unit--integration" class="hash-link" aria-label="Direct link to Unit / Integration" title="Direct link to Unit / Integration" translate="no">​</a></h3>
<ul>
<li class="">Property-based tests for formula sanitization (formulas.property.test.ts)</li>
<li class="">Cross-reference validation tests (integration.test.ts)</li>
<li class="">Digest computation and verification tests</li>
<li class="">Feature gate compatibility tests</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="performance">Performance<a href="#performance" class="hash-link" aria-label="Direct link to Performance" title="Direct link to Performance" translate="no">​</a></h3>
<ul>
<li class="">Validation benchmarks: Target under 100ms for packs with 100+ entities (Issue #143)</li>
<li class="">Large test pack creation: 500+ resources, 200+ generators</li>
<li class="">Profiling: Cross-reference checks, formula walking, cycle detection</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="tooling">Tooling<a href="#tooling" class="hash-link" aria-label="Direct link to Tooling" title="Direct link to Tooling" translate="no">​</a></h3>
<ul>
<li class="">CLI validation: <code>pnpm generate --check</code> in CI</li>
<li class="">Structured event logging validation</li>
<li class="">Digest mismatch detection</li>
<li class="">Watch mode resilience</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="11-risks--mitigations">11. Risks &amp; Mitigations<a href="#11-risks--mitigations" class="hash-link" aria-label="Direct link to 11. Risks &amp; Mitigations" title="Direct link to 11. Risks &amp; Mitigations" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="risk-1-formula-explosion">Risk 1: Formula Explosion<a href="#risk-1-formula-explosion" class="hash-link" aria-label="Direct link to Risk 1: Formula Explosion" title="Direct link to Risk 1: Formula Explosion" translate="no">​</a></h3>
<p><strong>Status</strong>: IMPLEMENTED</p>
<p><strong>Risk</strong>: Recursive expression parsing may allow deeply nested structures, risking performance issues.</p>
<p><strong>Mitigation</strong>:</p>
<ul>
<li class="">Recursion limits in <code>expressionNodeSchema</code> (formulas.ts)</li>
<li class="">AST node count caps enforced during validation</li>
<li class="">Property-based tests for formula sanitization (formulas.test.ts)</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="risk-2-schema-drift-vs-runtime">Risk 2: Schema Drift vs Runtime<a href="#risk-2-schema-drift-vs-runtime" class="hash-link" aria-label="Direct link to Risk 2: Schema Drift vs Runtime" title="Direct link to Risk 2: Schema Drift vs Runtime" translate="no">​</a></h3>
<p><strong>Status</strong>: PARTIALLY IMPLEMENTED</p>
<p><strong>Risk</strong>: Runtime may evolve faster than schema updates.</p>
<p><strong>Mitigation Implemented</strong>:</p>
<ul>
<li class="">FEATURE_GATES map runtime versions to schema modules (runtime-compat.ts:3-29)</li>
<li class="">Validation checks <code>ContentSchemaOptions.runtimeVersion</code> compatibility</li>
<li class="">CI validates core against schema digest (per acceptance criteria)</li>
</ul>
<p><strong>Gaps</strong>:</p>
<ul>
<li class="">No CI check enforcing that <code>@idle-engine/core</code> validates against schema before publish</li>
<li class="">Runtime version must be manually kept in sync with FEATURE_GATES</li>
</ul>
<p><strong>Action Items</strong> (Issue #141):</p>
<ul>
<li class="">Add CI step: <code>pnpm --filter @idle-engine/core test:schema-compat</code></li>
<li class="">Create test ensuring core package.json version satisfies all feature gate ranges</li>
<li class="">Add pre-publish hook blocking core releases if schema validation fails</li>
<li class="">Document schema evolution policy</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="risk-3-author-friction">Risk 3: Author Friction<a href="#risk-3-author-friction" class="hash-link" aria-label="Direct link to Risk 3: Author Friction" title="Direct link to Risk 3: Author Friction" translate="no">​</a></h3>
<p><strong>Status</strong>: IMPLEMENTED</p>
<p><strong>Risk</strong>: Strict schemas may frustrate early adopters.</p>
<p><strong>Mitigation</strong>:</p>
<ul>
<li class="">Descriptive error messages with structured <code>SchemaWarning</code> (errors.ts)</li>
<li class="">Non-fatal warnings for soft constraints (missing translations, steep curves)</li>
<li class="">Severity levels (<code>error</code>, <code>warning</code>, <code>info</code>) allow progressive strictness</li>
<li class=""><code>safeParse</code> returns warnings alongside successful parses</li>
</ul>
<p><strong>Tracking</strong>: Monitor GitHub issues for author feedback; adjust warning thresholds if patterns emerge.</p>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="risk-4-compatibility-versioning">Risk 4: Compatibility Versioning<a href="#risk-4-compatibility-versioning" class="hash-link" aria-label="Direct link to Risk 4: Compatibility Versioning" title="Direct link to Risk 4: Compatibility Versioning" translate="no">​</a></h3>
<p><strong>Status</strong>: IMPLEMENTED</p>
<p><strong>Risk</strong>: Packs targeting older runtime versions must continue to parse.</p>
<p><strong>Mitigation</strong>:</p>
<ul>
<li class="">FEATURE_GATES enable feature-based versioning (runtime-compat.ts)</li>
<li class="">Metadata.engine field specifies runtime version range (metadata.ts)</li>
<li class="">Validation allows older packs with subset of features</li>
<li class="">Schema transforms can downgrade gracefully</li>
</ul>
<p><strong>Tracking</strong>: Add integration tests for cross-version pack loading once save migration lands (Phase 4).</p>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="risk-5-transform-loops">Risk 5: Transform Loops<a href="#risk-5-transform-loops" class="hash-link" aria-label="Direct link to Risk 5: Transform Loops" title="Direct link to Risk 5: Transform Loops" translate="no">​</a></h3>
<p><strong>Status</strong>: IMPLEMENTED</p>
<p><strong>Risk</strong>: Misconfigured transforms may create runaway production chains.</p>
<p><strong>Mitigation</strong>:</p>
<ul>
<li class="">Safety guards in transform schema (transforms.ts):<!-- -->
<ul>
<li class=""><code>maxRunsPerTick</code> caps executions per simulation step</li>
<li class=""><code>maxOutstandingBatches</code> limits queued batch transforms</li>
</ul>
</li>
<li class="">Validation ensures transform I/O references exist (validateCrossReferences)</li>
<li class="">Cycle detection for unlock conditions (integration tests pending per integration.test.ts:155)</li>
</ul>
<p><strong>Action Item</strong> (Issue #142):</p>
<ul>
<li class="">Implement full cycle detection for transform chains (extend existing unlock cycle detector)</li>
<li class="">Add integration tests for circular transform references</li>
<li class="">Document safe transform patterns in authoring guide</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="risk-6-performance">Risk 6: Performance<a href="#risk-6-performance" class="hash-link" aria-label="Direct link to Risk 6: Performance" title="Direct link to Risk 6: Performance" translate="no">​</a></h3>
<p><strong>Status</strong>: DESIGN ONLY</p>
<p><strong>Risk</strong>: Running complex validation on large content packs could be slow.</p>
<p><strong>Mitigation Planned</strong>:</p>
<ul>
<li class="">Design recommends caching normalized results</li>
<li class="">Lookup maps included in NormalizedContentPack (<code>packages/content-schema/src/pack/types.ts</code>)</li>
</ul>
<p><strong>Current Performance</strong>:</p>
<ul>
<li class="">No caching implemented yet</li>
<li class="">No performance benchmarks exist</li>
<li class="">No large content packs to test against</li>
</ul>
<p><strong>Action Items</strong> (Issue #143 - Phase 6):</p>
<ul>
<li class="">Implement validation result caching (memoize by pack id + version + digest)</li>
<li class="">Add performance benchmarks for validation (target: under 100ms for packs with 100+ entities)</li>
<li class="">Create large test pack (500+ resources, 200+ generators) for performance testing</li>
<li class="">Profile validation bottlenecks (cross-reference checks, formula walking, cycle detection)</li>
<li class="">Consider worker-based validation for large packs if main-thread blocking observed</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="12-rollout-plan">12. Rollout Plan<a href="#12-rollout-plan" class="hash-link" aria-label="Direct link to 12. Rollout Plan" title="Direct link to 12. Rollout Plan" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="milestones">Milestones<a href="#milestones" class="hash-link" aria-label="Direct link to Milestones" title="Direct link to Milestones" translate="no">​</a></h3>
<ul>
<li class=""><strong>Phase 2 (Weeks 2-4)</strong>: Content DSL &amp; Sample Pack - UNBLOCKED</li>
<li class=""><strong>Phase 4</strong>: Save file format with digest migration (Issue #140)</li>
<li class=""><strong>Phase 5</strong>: Guild persistence schema extension (Issue #138)</li>
<li class=""><strong>Phase 6</strong>: Performance optimization and caching (Issue #143)</li>
<li class=""><strong>Phase 7+</strong>: Scripting runtime and scripted effects (Issue #139)</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="migration-strategy">Migration Strategy<a href="#migration-strategy" class="hash-link" aria-label="Direct link to Migration Strategy" title="Direct link to Migration Strategy" translate="no">​</a></h3>
<ul>
<li class="">Existing content packs continue to work without changes</li>
<li class="">New features require runtime version bumps via FEATURE_GATES</li>
<li class="">Save file migration support lands in Phase 4</li>
<li class="">Backward compatibility maintained through feature detection</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="communication">Communication<a href="#communication" class="hash-link" aria-label="Direct link to Communication" title="Direct link to Communication" translate="no">​</a></h3>
<ul>
<li class="">Decision log closes Issue #137</li>
<li class="">Follow-up issues (#138-143) created and linked to #11</li>
<li class="">Implementation plan updated with new backlog items</li>
<li class="">Author documentation updated with compiler workflow guidance</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="13-open-questions">13. Open Questions<a href="#13-open-questions" class="hash-link" aria-label="Direct link to 13. Open Questions" title="Direct link to 13. Open Questions" translate="no">​</a></h2>
<p>All Section 10 open questions from the content schema design document have been resolved by this document. New questions:</p>
<table><thead><tr><th>Question</th><th>Owner</th><th>Target Resolution</th><th>Status</th></tr></thead><tbody><tr><td>Long-term maintenance of shared formula arbitraries</td><td>Content Pipeline Maintainers</td><td>Phase 2 exit (2025-11-15)</td><td>Open</td></tr><tr><td>Prestige-layer monotonicity requirements</td><td>Game Design Lead</td><td>Prestige roadmap checkpoint (2025-12-01)</td><td>Open</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="14-follow-up-work">14. Follow-Up Work<a href="#14-follow-up-work" class="hash-link" aria-label="Direct link to 14. Follow-Up Work" title="Direct link to 14. Follow-Up Work" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="new-issues-created">New Issues Created<a href="#new-issues-created" class="hash-link" aria-label="Direct link to New Issues Created" title="Direct link to New Issues Created" translate="no">​</a></h3>
<table><thead><tr><th>Issue</th><th>Title</th><th>Priority</th><th>Blocking</th></tr></thead><tbody><tr><td>#138</td><td>Design guild persistence schema and extend cost model</td><td>P2</td><td>Phase 5</td></tr><tr><td>#139</td><td>Scripting design document and scripted effect support</td><td>P3</td><td>Post-prototype</td></tr><tr><td>#140</td><td>Save file format with content pack manifests and migrations</td><td>P1</td><td>Phase 4</td></tr><tr><td>#141</td><td>CI schema compatibility checks for runtime releases</td><td>P1</td><td>Pre-v1.0</td></tr><tr><td>#142</td><td>Complete cycle detection for transform chains</td><td>P2</td><td>Phase 3</td></tr><tr><td>#143</td><td>Validation performance benchmarks and caching</td><td>P2</td><td>Phase 6</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="deferred-features">Deferred Features<a href="#deferred-features" class="hash-link" aria-label="Direct link to Deferred Features" title="Direct link to Deferred Features" translate="no">​</a></h3>
<ul>
<li class="">Compiler icon resolution strategy (follow-up to compiler design)</li>
<li class="">Guild-scoped resource ownership semantics (Phase 5)</li>
<li class="">Scripting sandbox and security model (Phase 7+)</li>
<li class="">Cross-version save migration registry (Phase 4)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="15-references">15. References<a href="#15-references" class="hash-link" aria-label="Direct link to 15. References" title="Direct link to 15. References" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="design-documents">Design Documents<a href="#design-documents" class="hash-link" aria-label="Direct link to Design Documents" title="Direct link to Design Documents" translate="no">​</a></h3>
<ul>
<li class="">Content DSL Schema Design: <code>docs/content-dsl-schema-design.md</code></li>
<li class="">Property-Based Formula Sanitization Design: <code>docs/property-based-formula-sanitization-design.md</code></li>
<li class="">Content Validation CLI Design: <code>docs/content-validation-cli-design.md</code></li>
<li class="">Runtime Event Manifest Authoring: <code>docs/runtime-event-manifest-authoring.md</code></li>
<li class="">Idle Engine Design: <code>docs/idle-engine-design.md</code></li>
<li class="">Implementation Plan: <code>docs/implementation-plan.md</code></li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="source-files">Source Files<a href="#source-files" class="hash-link" aria-label="Direct link to Source Files" title="Direct link to Source Files" translate="no">​</a></h3>
<ul>
<li class="">Schema modules: <code>packages/content-schema/src/modules/</code></li>
<li class="">Formula definitions: <code>packages/content-schema/src/base/formulas.ts</code></li>
<li class="">Formula arbitraries: <code>packages/content-schema/src/base/formulas.arbitraries.ts</code></li>
<li class="">Runtime compatibility: <code>packages/content-schema/src/base/runtime-compat.ts</code></li>
<li class="">Pack normalization: <code>packages/content-schema/src/pack/normalize.ts</code></li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="test-suites">Test Suites<a href="#test-suites" class="hash-link" aria-label="Direct link to Test Suites" title="Direct link to Test Suites" translate="no">​</a></h3>
<ul>
<li class="">Property-based formula tests: <code>packages/content-schema/src/base/formulas.property.test.ts</code></li>
<li class="">Integration tests: <code>packages/content-schema/src/__tests__/integration.test.ts</code></li>
<li class="">CLI property tests: <code>tools/content-schema-cli/src/__tests__/validation.property.test.ts</code></li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-a---glossary">Appendix A - Glossary<a href="#appendix-a---glossary" class="hash-link" aria-label="Direct link to Appendix A - Glossary" title="Direct link to Appendix A - Glossary" translate="no">​</a></h2>
<ul>
<li class=""><strong>Content Pack</strong>: Declarative game content bundle (resources, generators, upgrades, etc.)</li>
<li class=""><strong>Digest</strong>: Cryptographic hash (FNV-1a) of pack metadata and module lists</li>
<li class=""><strong>Feature Gate</strong>: Runtime version-based feature availability check</li>
<li class=""><strong>Normalized Content Pack</strong>: Validated and transformed content pack with lookup maps</li>
<li class=""><strong>Formula</strong>: Structured expression for numeric calculations (linear, exponential, piecewise, etc.)</li>
<li class=""><strong>Schema Warning</strong>: Structured validation message with severity (error, warning, info)</li>
<li class=""><strong>Transform</strong>: Batch conversion process (inputs -&gt; outputs with formulas)</li>
<li class=""><strong>Property-Based Testing</strong>: Generative testing using fast-check arbitraries</li>
<li class=""><strong>Arbitrary</strong>: fast-check generator for test data (e.g., valid formulas)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-b---change-log">Appendix B - Change Log<a href="#appendix-b---change-log" class="hash-link" aria-label="Direct link to Appendix B - Change Log" title="Direct link to Appendix B - Change Log" translate="no">​</a></h2>
<table><thead><tr><th>Date</th><th>Author</th><th>Change Summary</th></tr></thead><tbody><tr><td>2025-10-21</td><td>Content Pipeline Team</td><td>Initial decision log addressing Section 10 open questions and Section 7 risk tracking</td></tr><tr><td>2025-12-21</td><td>Migration Agent</td><td>Migrated to design document template format (Issue #194)</td></tr></tbody></table>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="property-based-formula-sanitization-guidance">Property-Based Formula Sanitization Guidance<a href="#property-based-formula-sanitization-guidance" class="hash-link" aria-label="Direct link to Property-Based Formula Sanitization Guidance" title="Direct link to Property-Based Formula Sanitization Guidance" translate="no">​</a></h2>
<p>Property-based suites now gate formula authoring across schema and CLI surfaces. Use the workflow below before submitting new packs or modifiers. Guidance complements <code>docs/property-based-formula-sanitization-design.md</code> and the CLI runbook in <code>docs/content-validation-cli-design.md</code>.</p>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="sanitization-invariants-enforced">Sanitization Invariants Enforced<a href="#sanitization-invariants-enforced" class="hash-link" aria-label="Direct link to Sanitization Invariants Enforced" title="Direct link to Sanitization Invariants Enforced" translate="no">​</a></h3>
<ul>
<li class="">Formulas generated by <code>createFormulaArbitrary</code> must parse successfully and evaluate to finite, non-negative numbers across deterministic evaluation contexts</li>
<li class="">Linear and exponential formulas are asserted to be monotonic in the <code>level</code> variable, with growth rates clamped to positive ranges even when callers provide invalid bounds</li>
<li class="">Piecewise formulas require ordered <code>untilLevel</code> thresholds and terminate with a catch-all segment so sanitizers never fall off the range of defined pieces</li>
<li class="">Expression arbitraries guard depth, root degree, and composed function usage so sanitizers keep results within <code>MAX_FORMULA_DEPTH</code> and preserve non-negative outputs via <code>max(0, ...)</code> guards</li>
<li class="">Entity references are validated against sanitized pools; the CLI suite rejects packs that point to undefined resources and emits actionable <code>content_pack.validation_failed</code> payloads</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="running-the-property-suites-locally">Running the Property Suites Locally<a href="#running-the-property-suites-locally" class="hash-link" aria-label="Direct link to Running the Property Suites Locally" title="Direct link to Running the Property Suites Locally" translate="no">​</a></h3>
<p>Schema coverage:</p>
<div class="language-bash codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-bash codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token plain">pnpm --filter @idle-engine/content-schema test -- --run createFormulaArbitrary</span><br></span></code></pre></div></div>
<p>CLI coverage:</p>
<div class="language-bash codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-bash codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token plain">pnpm --filter @idle-engine/content-validation-cli test -- --run &quot;validateContentPacks property&quot;</span><br></span></code></pre></div></div>
<p>Append <code>--watch</code> while iterating, and keep reporters quiet so the <code>vitest-llm-reporter</code> JSON summary remains the final console line for downstream agents.</p>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="troubleshooting--replay-tips">Troubleshooting &amp; Replay Tips<a href="#troubleshooting--replay-tips" class="hash-link" aria-label="Direct link to Troubleshooting &amp; Replay Tips" title="Direct link to Troubleshooting &amp; Replay Tips" translate="no">​</a></h3>
<ul>
<li class="">Both suites share <code>DEFAULT_FORMULA_PROPERTY_SEED = 177013</code> (see <code>packages/content-schema/src/base/formulas.arbitraries.ts</code>); fast-check prints the failing seed and path whenever a counterexample is found</li>
<li class="">Copy the printed <code>seed</code> and <code>path</code> back into the local <code>propertyConfig</code> helper (or temporarily override the exported constant) to replay the failing run with <code>vitest</code></li>
<li class="">Inspect CLI failures via the captured <code>content_pack.validation_failed</code> event—it contains the pack slug, manifest path, and schema issues array surfaced by <code>ContentPackValidationError</code></li>
<li class="">Schema-side failures surface the counterexample formula in the stack trace; evaluate it with <code>evaluateNumericFormula</code> in a REPL to confirm which invariant was violated</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="references-for-downstream-agents">References for Downstream Agents<a href="#references-for-downstream-agents" class="hash-link" aria-label="Direct link to References for Downstream Agents" title="Direct link to References for Downstream Agents" translate="no">​</a></h3>
<ul>
<li class="">Schema suite: <code>packages/content-schema/src/base/formulas.property.test.ts</code></li>
<li class="">Arbitrary definitions: <code>packages/content-schema/src/base/formulas.arbitraries.ts</code></li>
<li class="">CLI suite: <code>tools/content-schema-cli/src/__tests__/validation.property.test.ts</code></li>
<li class="">Design rationale: <code>docs/property-based-formula-sanitization-design.md</code></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_QKxP"><a href="https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/content-schema-rollout-decisions.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_wOWh" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_Basj"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/Idle-Game-Engine/content-compiler-design"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Content Compiler Design</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Idle-Game-Engine/content-validation-cli-design"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Content Validation CLI Design</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_AUZ0 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#document-control" class="table-of-contents__link toc-highlight">Document Control</a></li><li><a href="#1-summary" class="table-of-contents__link toc-highlight">1. Summary</a></li><li><a href="#2-context--problem-statement" class="table-of-contents__link toc-highlight">2. Context &amp; Problem Statement</a><ul><li><a href="#background" class="table-of-contents__link toc-highlight">Background</a></li><li><a href="#problem" class="table-of-contents__link toc-highlight">Problem</a></li><li><a href="#forces" class="table-of-contents__link toc-highlight">Forces</a></li></ul></li><li><a href="#3-goals--non-goals" class="table-of-contents__link toc-highlight">3. Goals &amp; Non-Goals</a><ul><li><a href="#goals" class="table-of-contents__link toc-highlight">Goals</a></li><li><a href="#non-goals" class="table-of-contents__link toc-highlight">Non-Goals</a></li></ul></li><li><a href="#4-stakeholders-agents--impacted-surfaces" class="table-of-contents__link toc-highlight">4. Stakeholders, Agents &amp; Impacted Surfaces</a><ul><li><a href="#primary-stakeholders" class="table-of-contents__link toc-highlight">Primary Stakeholders</a></li><li><a href="#agent-roles" class="table-of-contents__link toc-highlight">Agent Roles</a></li><li><a href="#affected-packagesservices" class="table-of-contents__link toc-highlight">Affected Packages/Services</a></li><li><a href="#compatibility-considerations" class="table-of-contents__link toc-highlight">Compatibility Considerations</a></li></ul></li><li><a href="#5-current-state" class="table-of-contents__link toc-highlight">5. Current State</a><ul><li><a href="#schema-implementation-status" class="table-of-contents__link toc-highlight">Schema Implementation Status</a></li><li><a href="#integration-points" class="table-of-contents__link toc-highlight">Integration Points</a></li><li><a href="#outstanding-dependencies" class="table-of-contents__link toc-highlight">Outstanding Dependencies</a></li></ul></li><li><a href="#6-proposed-solution" class="table-of-contents__link toc-highlight">6. Proposed Solution</a><ul><li><a href="#61-architecture-overview" class="table-of-contents__link toc-highlight">6.1 Architecture Overview</a></li><li><a href="#62-detailed-design" class="table-of-contents__link toc-highlight">6.2 Detailed Design</a></li><li><a href="#63-operational-considerations" class="table-of-contents__link toc-highlight">6.3 Operational Considerations</a></li></ul></li><li><a href="#7-work-breakdown--delivery-plan" class="table-of-contents__link toc-highlight">7. Work Breakdown &amp; Delivery Plan</a><ul><li><a href="#71-issue-map" class="table-of-contents__link toc-highlight">7.1 Issue Map</a></li><li><a href="#72-milestones" class="table-of-contents__link toc-highlight">7.2 Milestones</a></li><li><a href="#73-coordination-notes" class="table-of-contents__link toc-highlight">7.3 Coordination Notes</a></li></ul></li><li><a href="#8-agent-guidance--guardrails" class="table-of-contents__link toc-highlight">8. Agent Guidance &amp; Guardrails</a><ul><li><a href="#context-packets" class="table-of-contents__link toc-highlight">Context Packets</a></li><li><a href="#prompting--constraints" class="table-of-contents__link toc-highlight">Prompting &amp; Constraints</a></li><li><a href="#safety-rails" class="table-of-contents__link toc-highlight">Safety Rails</a></li><li><a href="#validation-hooks" class="table-of-contents__link toc-highlight">Validation Hooks</a></li></ul></li><li><a href="#9-alternatives-considered" class="table-of-contents__link toc-highlight">9. Alternatives Considered</a><ul><li><a href="#icon-path-generation-alternatives" class="table-of-contents__link toc-highlight">Icon Path Generation Alternatives</a></li><li><a href="#guild-cost-model-alternatives" class="table-of-contents__link toc-highlight">Guild Cost Model Alternatives</a></li><li><a href="#scripted-modifier-alternatives" class="table-of-contents__link toc-highlight">Scripted Modifier Alternatives</a></li><li><a href="#digest-embedding-alternatives" class="table-of-contents__link toc-highlight">Digest Embedding Alternatives</a></li></ul></li><li><a href="#10-testing--validation-plan" class="table-of-contents__link toc-highlight">10. Testing &amp; Validation Plan</a><ul><li><a href="#unit--integration" class="table-of-contents__link toc-highlight">Unit / Integration</a></li><li><a href="#performance" class="table-of-contents__link toc-highlight">Performance</a></li><li><a href="#tooling" class="table-of-contents__link toc-highlight">Tooling</a></li></ul></li><li><a href="#11-risks--mitigations" class="table-of-contents__link toc-highlight">11. Risks &amp; Mitigations</a><ul><li><a href="#risk-1-formula-explosion" class="table-of-contents__link toc-highlight">Risk 1: Formula Explosion</a></li><li><a href="#risk-2-schema-drift-vs-runtime" class="table-of-contents__link toc-highlight">Risk 2: Schema Drift vs Runtime</a></li><li><a href="#risk-3-author-friction" class="table-of-contents__link toc-highlight">Risk 3: Author Friction</a></li><li><a href="#risk-4-compatibility-versioning" class="table-of-contents__link toc-highlight">Risk 4: Compatibility Versioning</a></li><li><a href="#risk-5-transform-loops" class="table-of-contents__link toc-highlight">Risk 5: Transform Loops</a></li><li><a href="#risk-6-performance" class="table-of-contents__link toc-highlight">Risk 6: Performance</a></li></ul></li><li><a href="#12-rollout-plan" class="table-of-contents__link toc-highlight">12. Rollout Plan</a><ul><li><a href="#milestones" class="table-of-contents__link toc-highlight">Milestones</a></li><li><a href="#migration-strategy" class="table-of-contents__link toc-highlight">Migration Strategy</a></li><li><a href="#communication" class="table-of-contents__link toc-highlight">Communication</a></li></ul></li><li><a href="#13-open-questions" class="table-of-contents__link toc-highlight">13. Open Questions</a></li><li><a href="#14-follow-up-work" class="table-of-contents__link toc-highlight">14. Follow-Up Work</a><ul><li><a href="#new-issues-created" class="table-of-contents__link toc-highlight">New Issues Created</a></li><li><a href="#deferred-features" class="table-of-contents__link toc-highlight">Deferred Features</a></li></ul></li><li><a href="#15-references" class="table-of-contents__link toc-highlight">15. References</a><ul><li><a href="#design-documents" class="table-of-contents__link toc-highlight">Design Documents</a></li><li><a href="#source-files" class="table-of-contents__link toc-highlight">Source Files</a></li><li><a href="#test-suites" class="table-of-contents__link toc-highlight">Test Suites</a></li></ul></li><li><a href="#appendix-a---glossary" class="table-of-contents__link toc-highlight">Appendix A - Glossary</a></li><li><a href="#appendix-b---change-log" class="table-of-contents__link toc-highlight">Appendix B - Change Log</a></li><li><a href="#property-based-formula-sanitization-guidance" class="table-of-contents__link toc-highlight">Property-Based Formula Sanitization Guidance</a><ul><li><a href="#sanitization-invariants-enforced" class="table-of-contents__link toc-highlight">Sanitization Invariants Enforced</a></li><li><a href="#running-the-property-suites-locally" class="table-of-contents__link toc-highlight">Running the Property Suites Locally</a></li><li><a href="#troubleshooting--replay-tips" class="table-of-contents__link toc-highlight">Troubleshooting &amp; Replay Tips</a></li><li><a href="#references-for-downstream-agents" class="table-of-contents__link toc-highlight">References for Downstream Agents</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/contributor-handbook">Contributor Handbook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Idle Engine.</div></div></div></footer></div>
</body>
</html>