<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-progression-coordinator-design" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Progression Coordinator Pattern | Idle Engine Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hansjm10.github.io/Idle-Game-Engine/progression-coordinator-design"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Progression Coordinator Pattern | Idle Engine Docs"><meta data-rh="true" name="description" content="Document Control"><meta data-rh="true" property="og:description" content="Document Control"><link data-rh="true" rel="icon" href="/Idle-Game-Engine/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hansjm10.github.io/Idle-Game-Engine/progression-coordinator-design"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/progression-coordinator-design" hreflang="en"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/progression-coordinator-design" hreflang="x-default"><link rel="stylesheet" href="/Idle-Game-Engine/assets/css/styles.ddf7989c.css">
<script src="/Idle-Game-Engine/assets/js/runtime~main.7269e10e.js" defer="defer"></script>
<script src="/Idle-Game-Engine/assets/js/main.d4124dfc.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Idle-Game-Engine/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_li4T" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Idle-Game-Engine/"><div class="navbar__logo"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--light_vaEm"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--dark_axH8"></div><b class="navbar__title text--truncate">Idle Engine</b></a><a class="navbar__item navbar__link" href="/Idle-Game-Engine/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle__Exw colorModeToggle_Lslw"><button class="clean-btn toggleButton_AMBK toggleButtonDisabled_p4Bd" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 lightToggleIcon_p2sk"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 darkToggleIcon_B2qX"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 systemToggleIcon_PWgn"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_RKai"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_nqaE"><div class="docsWrapper_CSLE"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sOWX" type="button"></button><div class="docRoot_qxtV"><main class="docMainContainer_tfRv docMainContainerEnhanced_qAvX"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_hyci"><div class="docItemContainer_tcAC"><article><div class="tocCollapsible_WMbj theme-doc-toc-mobile tocMobile_wI3e"><button type="button" class="clean-btn tocCollapsibleButton_rjEa">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Progression Coordinator Pattern</h1></header>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="document-control">Document Control<a href="#document-control" class="hash-link" aria-label="Direct link to Document Control" title="Direct link to Document Control" translate="no">​</a></h2>
<ul>
<li class=""><strong>Title</strong>: Progression Coordinator Pattern for Hydrating Progression Snapshots</li>
<li class=""><strong>Authors</strong>: Design Documentation Agent (Retroactive Documentation)</li>
<li class=""><strong>Reviewers</strong>: Runtime Core Maintainers; Shell UX Maintainers</li>
<li class=""><strong>Status</strong>: Approved (Documenting Existing Implementation)</li>
<li class=""><strong>Last Updated</strong>: 2025-11-01</li>
<li class=""><strong>Related Issues</strong>: #302, #303</li>
<li class=""><strong>Execution Mode</strong>: N/A (Retroactive documentation of shipped code)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="1-summary">1. Summary<a href="#1-summary" class="hash-link" aria-label="Direct link to 1. Summary" title="Direct link to 1. Summary" translate="no">​</a></h2>
<p>This document describes the <strong>Progression Coordinator pattern</strong> implemented in PR #303, which centralizes progression state management for resources, generators, and upgrades. The coordinator owns authoritative progression state, evaluates unlock/visibility conditions per game step, provides purchase cost evaluators to command handlers, and supports hydration from serialized saves. This is <strong>retroactive documentation</strong> of the existing implementation in <code>packages/core/src/progression-coordinator.ts</code>.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="2-context--problem-statement">2. Context &amp; Problem Statement<a href="#2-context--problem-statement" class="hash-link" aria-label="Direct link to 2. Context &amp; Problem Statement" title="Direct link to 2. Context &amp; Problem Statement" translate="no">​</a></h2>
<ul>
<li class="">
<p><strong>Background</strong>: Prior to PR #303, the runtime worker directly managed progression state through scattered command handlers (<code>packages/core/src/resource-command-handlers.ts</code>). The worker lacked a centralized mechanism to evaluate unlock conditions, manage generator/upgrade visibility, or hydrate progression state from saves.</p>
</li>
<li class="">
<p><strong>Problem</strong>: Without a coordinator pattern, progression logic was fragmented across command handlers, making it difficult to:</p>
<ul>
<li class="">Evaluate complex unlock conditions defined in content packs</li>
<li class="">Maintain consistent state between fresh sessions and restored saves</li>
<li class="">Provide unified purchase cost quotes to the presentation layer</li>
<li class="">Update generator/upgrade visibility dynamically based on game state</li>
</ul>
</li>
<li class="">
<p><strong>Forces</strong>: The solution needed to preserve deterministic command execution, integrate with existing resource state management (<code>packages/core/src/resource-state.ts</code>), support the progression snapshot schema in <code>packages/core/src/progression.ts</code>, and enable session restoration as specified in <code>docs/resource-state-storage-design.md</code>.</p>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="3-goals--non-goals">3. Goals &amp; Non-Goals<a href="#3-goals--non-goals" class="hash-link" aria-label="Direct link to 3. Goals &amp; Non-Goals" title="Direct link to 3. Goals &amp; Non-Goals" translate="no">​</a></h2>
<p><strong>Goals</strong>:</p>
<ul>
<li class="">Centralize ownership of authoritative progression state in a single coordinator</li>
<li class="">Evaluate unlock and visibility conditions from content pack definitions</li>
<li class="">Provide purchase evaluators implementing <code>GeneratorPurchaseEvaluator</code> and <code>UpgradePurchaseEvaluator</code> interfaces</li>
<li class="">Support hydration from <code>SerializedResourceState</code> for session restoration</li>
<li class="">Maintain per-tick state updates for dynamic condition evaluation</li>
<li class="">Enable building immutable <code>ProgressionSnapshot</code> for shell consumption</li>
</ul>
<p><strong>Non-Goals</strong>:</p>
<ul>
<li class="">Modifying core resource state storage architecture (remains in <code>@idle-engine/core</code>)</li>
<li class="">Implementing new condition types beyond those in content schema</li>
<li class="">Changing command queue execution model</li>
<li class="">Adding new progression features beyond what PR #303 delivered</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="4-stakeholders-agents--impacted-surfaces">4. Stakeholders, Agents &amp; Impacted Surfaces<a href="#4-stakeholders-agents--impacted-surfaces" class="hash-link" aria-label="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" title="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" translate="no">​</a></h2>
<ul>
<li class=""><strong>Primary Stakeholders</strong>: Runtime Core maintainers; Shell UX team consuming snapshots</li>
<li class=""><strong>Agent Roles</strong>: N/A (existing implementation)</li>
<li class=""><strong>Affected Packages/Services</strong>: <code>packages/core</code> (coordinator implementation, interfaces, resource state, progression types); presentation shell integrations (archived); <code>packages/content-sample</code> (consumed by coordinator)</li>
<li class=""><strong>Compatibility Considerations</strong>: Coordinator integrates with existing command handlers; saves from pre-PR#303 require migration handled by resource state reconciliation</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="5-current-state">5. Current State<a href="#5-current-state" class="hash-link" aria-label="Direct link to 5. Current State" title="Direct link to 5. Current State" translate="no">​</a></h2>
<p><strong>As implemented in PR #303</strong> (<code>packages/core/src/progression-coordinator.ts</code>):</p>
<p>The coordinator is a facade that:</p>
<ul>
<li class="">Owns a <code>ResourceState</code> instance for managing resource amounts/capacity/flags</li>
<li class="">Maintains internal mutable records for generators and upgrades</li>
<li class="">Exposes frozen <code>ProgressionAuthoritativeState</code> to external consumers</li>
<li class="">Provides <code>GeneratorPurchaseEvaluator</code> and <code>UpgradePurchaseEvaluator</code> implementations</li>
<li class="">Evaluates content-defined conditions via <code>condition-evaluator.ts</code></li>
<li class="">Updates all progression state in <code>updateForStep()</code> called every game tick</li>
</ul>
<p><strong>Integration point</strong> (archived worker harness):</p>
<ul>
<li class="">Worker creates coordinator with <code>sampleContent</code> and optional <code>initialState</code> from saved game</li>
<li class="">Coordinator&#x27;s evaluators are registered with command handlers</li>
<li class=""><code>updateForStep()</code> is called after runtime step advances (line 225)</li>
<li class=""><code>buildProgressionSnapshot()</code> uses coordinator&#x27;s authoritative state (lines 228-232)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="6-proposed-solution">6. Proposed Solution<a href="#6-proposed-solution" class="hash-link" aria-label="Direct link to 6. Proposed Solution" title="Direct link to 6. Proposed Solution" translate="no">​</a></h2>
<blockquote>
<p><strong>Note</strong>: This section describes the <strong>existing implementation</strong> from PR #303, not future work.</p>
</blockquote>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="61-architecture-overview">6.1 Architecture Overview<a href="#61-architecture-overview" class="hash-link" aria-label="Direct link to 6.1 Architecture Overview" title="Direct link to 6.1 Architecture Overview" translate="no">​</a></h3>
<p><strong>Pattern</strong>: Facade + Dependency Injection</p>
<p>The coordinator acts as a facade over:</p>
<ul>
<li class="">Resource state (struct-of-arrays storage from <code>@idle-engine/core</code>)</li>
<li class="">Generator records (mutable internal state mapped to content definitions)</li>
<li class="">Upgrade records (mutable internal state with purchase tracking)</li>
<li class="">Condition evaluation context (provides state access for condition DSL)</li>
</ul>
<p><strong>Diagram</strong>:</p>
<div class="language-text codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-text codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   Runtime Worker                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌──────────────────────────┐   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ ProgressionCoordinator   │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                          │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  state: Authoritative    │◄──┼── buildProgressionSnapshot()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  resourceState: Mutable  │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  generatorEvaluator      │◄──┼── Command Handlers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  upgradeEvaluator        │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                          │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  updateForStep(step)     │◄──┼── Per-tick update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  hydrateResources(save)  │◄──┼── Session restore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └────────┬─────────────────┘   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│           │                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│           ▼                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌──────────────────┐           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ Condition        │           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ Evaluator        │           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └──────────────────┘           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│           │                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│           ▼                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌──────────────────────────┐   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ Content Pack             │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ (generators, upgrades,   │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  unlock conditions)      │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └──────────────────────────┘   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────┘</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="62-detailed-design">6.2 Detailed Design<a href="#62-detailed-design" class="hash-link" aria-label="Direct link to 6.2 Detailed Design" title="Direct link to 6.2 Detailed Design" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="621-public-api-contract">6.2.1 Public API Contract<a href="#621-public-api-contract" class="hash-link" aria-label="Direct link to 6.2.1 Public API Contract" title="Direct link to 6.2.1 Public API Contract" translate="no">​</a></h4>
<p><strong>Interface</strong> (<code>packages/core/src/progression-coordinator.ts</code>):</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ProgressionCoordinator</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ProgressionAuthoritativeState</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> resourceState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ResourceState</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> generatorEvaluator</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> GeneratorPurchaseEvaluator</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> upgradeEvaluator</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> UpgradePurchaseEvaluator</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// undefined if no upgrades</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">hydrateResources</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">serialized</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SerializedResourceState </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">updateForStep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">step</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Factory Function</strong> (<code>packages/core/src/progression-coordinator.ts</code>):</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createProgressionCoordinator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ProgressionCoordinatorOptions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ProgressionCoordinator</span><br></span></code></pre></div></div>
<p><strong>Options</strong>:</p>
<ul>
<li class=""><code>content: NormalizedContentPack</code> - Content definitions for resources/generators/upgrades</li>
<li class=""><code>stepDurationMs: number</code> - Game tick duration (must be non-negative)</li>
<li class=""><code>initialState?: ProgressionAuthoritativeState</code> - Optional save state to restore</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="622-state-management-strategy">6.2.2 State Management Strategy<a href="#622-state-management-strategy" class="hash-link" aria-label="Direct link to 6.2.2 State Management Strategy" title="Direct link to 6.2.2 State Management Strategy" translate="no">​</a></h4>
<p><strong>Hybrid Mutability</strong>:</p>
<p>The coordinator uses <strong>mutable internal records</strong> for performance (<code>packages/core/src/progression-coordinator.ts</code>):</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">GeneratorRecord</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> definition</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> NormalizedGenerator</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Mutable</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ProgressionGeneratorState</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">UpgradeRecord</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> definition</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> NormalizedUpgrade</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> MutableUpgradeState</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  purchases</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p><strong>Rationale</strong>: Avoiding allocation churn during per-tick <code>updateForStep()</code> calls. Mutating records in-place prevents creating new state objects every tick when conditions are re-evaluated.</p>
<p><strong>External API</strong>: The <code>state</code> property exposes a <strong>frozen view</strong> (<code>ProgressionAuthoritativeState</code>) where consumers cannot mutate progression state. This prevents accidental mutation from command handlers or snapshot builders.</p>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="623-initialization-flow">6.2.3 Initialization Flow<a href="#623-initialization-flow" class="hash-link" aria-label="Direct link to 6.2.3 Initialization Flow" title="Direct link to 6.2.3 Initialization Flow" translate="no">​</a></h4>
<p><strong>Constructor</strong> (<code>packages/core/src/progression-coordinator.ts</code>):</p>
<ol>
<li class="">
<p><strong>Convert content resources to definitions</strong> (lines 194-206):</p>
<ul>
<li class="">Maps <code>NormalizedResource</code> → <code>ResourceDefinition</code></li>
<li class="">Applies defaults (<code>startAmount</code>, <code>capacity</code>, <code>unlocked</code>, <code>visible</code>)</li>
</ul>
</li>
<li class="">
<p><strong>Create or restore resource state</strong> (lines 210-214):</p>
<ul>
<li class="">If <code>initialState?.resources?.state</code> exists, reuse it</li>
<li class="">Otherwise create fresh <code>ResourceState</code> with <code>createResourceState(definitions)</code></li>
<li class="">Call <code>hydrateResources()</code> with serialized state if available</li>
</ul>
</li>
<li class="">
<p><strong>Build generator records</strong> (lines 223-234):</p>
<ul>
<li class="">Map content generators to internal <code>GeneratorRecord</code></li>
<li class="">Restore saved generator state if <code>initialState</code> provided</li>
<li class="">Initialize unlocked/visible flags, owned count, cost arrays</li>
</ul>
</li>
<li class="">
<p><strong>Build upgrade records</strong> (lines 236-247):</p>
<ul>
<li class="">Map content upgrades to internal <code>UpgradeRecord</code></li>
<li class="">Restore saved upgrade state if <code>initialState</code> provided</li>
<li class="">Infer purchase count from status if not saved (lines 684-693)</li>
</ul>
</li>
<li class="">
<p><strong>Create condition evaluation context</strong> (lines 249-264):</p>
<ul>
<li class="">Provides closures accessing resource amounts, generator levels, upgrade purchases</li>
<li class="">Context is dependency-injected into <code>evaluateCondition()</code> calls</li>
</ul>
</li>
<li class="">
<p><strong>Instantiate evaluators</strong> (lines 266-270):</p>
<ul>
<li class=""><code>generatorEvaluator = new ContentGeneratorEvaluator(this)</code></li>
<li class=""><code>upgradeEvaluator = new ContentUpgradeEvaluator(this)</code> if upgrades exist</li>
</ul>
</li>
<li class="">
<p><strong>Assemble authoritative state</strong> (lines 272-282):</p>
<ul>
<li class="">Populate <code>ProgressionAuthoritativeState</code> with references to resource state, evaluators, and record arrays</li>
<li class="">State is reused across ticks; properties are reassigned rather than recreated</li>
</ul>
</li>
<li class="">
<p><strong>Initial update</strong> (line 284):</p>
<ul>
<li class="">Call <code>updateForStep(0)</code> to evaluate initial unlock/visibility conditions</li>
</ul>
</li>
</ol>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="624-per-tick-update-logic">6.2.4 Per-Tick Update Logic<a href="#624-per-tick-update-logic" class="hash-link" aria-label="Direct link to 6.2.4 Per-Tick Update Logic" title="Direct link to 6.2.4 Per-Tick Update Logic" translate="no">​</a></h4>
<p><strong><code>updateForStep(step)</code></strong> (<code>packages/core/src/progression-coordinator.ts</code>):</p>
<p>Called by runtime worker after step advances (archived worker harness).</p>
<p><strong>Generator update loop</strong> (lines 304-329):</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> record </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">generatorList</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Evaluate base unlock condition</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> baseUnlock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateCondition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">definition</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">baseUnlock</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conditionContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Persistent unlock semantics: once unlocked, never revert</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isUnlocked </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> baseUnlock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isUnlocked </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Visibility can toggle based on current state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> visibleCondition </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">definition</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">visibilityCondition</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isVisible </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> visibleCondition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateCondition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">visibleCondition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conditionContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isUnlocked</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Generate unlock hint for locked generators</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unlockHint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isUnlocked</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">describeCondition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">combineConditions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          visibleCondition </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isVisible</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">definition</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">baseUnlock</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> visibleCondition</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">definition</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">baseUnlock</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Initialize or update nextPurchaseReadyAtStep</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">Number</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isFinite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">nextPurchaseReadyAtStep</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">nextPurchaseReadyAtStep </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> step </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">wasUnlocked </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isUnlocked</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Reset cooldown on unlock transition</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">nextPurchaseReadyAtStep </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> step </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Clamp owned count to maxLevel if defined</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">owned </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">clampOwned</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">owned</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">definition</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">maxLevel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Critical Behavior - Persistent Unlocks</strong>:</p>
<ul>
<li class=""><code>baseUnlock</code> condition evaluated every tick</li>
<li class=""><strong>Once <code>isUnlocked</code> transitions to <code>true</code>, it NEVER reverts</strong> (line 310-312)</li>
<li class="">This ensures generators remain available after unlock conditions are met, even if conditions later fail (e.g., player spends resources below threshold)</li>
<li class=""><strong>Prestige reset exception</strong>: When a prestige layer resets a generator/resource, the prestige evaluator may re-lock unlock/visibility back to content defaults as part of the reset flow.</li>
</ul>
<p><strong>Resource update loop</strong>:</p>
<ul>
<li class="">Unlock conditions are evaluated each tick with persistent unlock semantics.</li>
<li class="">When <code>visibilityCondition</code> is omitted, an unlock transition grants visibility
for resources that start hidden.</li>
</ul>
<p><strong>Upgrade update loop</strong> (lines 331-349):</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> record </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">upgradeList</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Resolve status based on prerequisites, unlock condition, purchase count</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">resolveUpgradeStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">record</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> status</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Evaluate visibility condition</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> visibilityCondition </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">definition</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">visibilityCondition</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isVisible </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> visibilityCondition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateCondition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">visibilityCondition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conditionContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> status </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;locked&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Generate unlock hint for locked upgrades</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unlockHint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> status </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;locked&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">describeCondition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">definition</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unlockCondition </span><span class="token operator" style="color:#393A34">??</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">combineConditions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">definition</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">prerequisites</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Compute current costs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">costs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">computeUpgradeCosts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">record</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">purchases </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">purchases</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="625-hydration-from-saves">6.2.5 Hydration from Saves<a href="#625-hydration-from-saves" class="hash-link" aria-label="Direct link to 6.2.5 Hydration from Saves" title="Direct link to 6.2.5 Hydration from Saves" translate="no">​</a></h4>
<p><strong><code>hydrateResources(serialized)</code></strong> (<code>packages/core/src/progression-coordinator.ts</code>):</p>
<p>Delegates to <code>hydrateResourceState()</code> utility (lines 741-788):</p>
<ol>
<li class="">
<p><strong>Reconcile save against current definitions</strong>:</p>
<ul>
<li class="">Calls <code>reconcileSaveAgainstDefinitions(serialized, definitions)</code> from <code>@idle-engine/core</code></li>
<li class="">Returns <code>{ remap: number[] }</code> mapping saved indices to live indices</li>
<li class="">Handles added/removed resources between save and current schema</li>
</ul>
</li>
<li class="">
<p><strong>Restore resource state</strong>:</p>
<ul>
<li class="">Set capacities from <code>serialized.capacities[savedIndex]</code></li>
<li class="">Adjust amounts: add or spend to match <code>serialized.amounts[savedIndex]</code></li>
<li class="">Restore unlocked/visible flags from bitsets</li>
</ul>
</li>
<li class="">
<p><strong>Publish snapshot</strong>:</p>
<ul>
<li class="">Call <code>state.snapshot({ mode: &#x27;publish&#x27; })</code> to flush changes to published buffer</li>
</ul>
</li>
</ol>
<p><strong>Integration</strong> (archived worker harness):</p>
<ul>
<li class="">Worker receives <code>RESTORE_SESSION</code> message with <code>state: SerializedResourceState</code></li>
<li class="">Preserves coordinator&#x27;s resource metadata (line 746)</li>
<li class="">Stores serialized state for reference (line 747)</li>
<li class="">Calls <code>progressionCoordinator.hydrateResources(message.state)</code> (line 749)</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="626-purchase-evaluators">6.2.6 Purchase Evaluators<a href="#626-purchase-evaluators" class="hash-link" aria-label="Direct link to 6.2.6 Purchase Evaluators" title="Direct link to 6.2.6 Purchase Evaluators" translate="no">​</a></h4>
<p><strong>Generator Evaluator</strong> (<code>packages/core/src/progression-coordinator.ts</code>):</p>
<p>Implements <code>GeneratorPurchaseEvaluator</code> interface from <code>@idle-engine/core</code>.</p>
<p><strong><code>getPurchaseQuote(generatorId, count)</code></strong> (lines 486-549):</p>
<ul>
<li class="">Validates count is positive integer</li>
<li class="">Checks generator is unlocked and visible</li>
<li class="">Validates bulk purchase limit (<code>maxBulk</code>)</li>
<li class="">Validates not exceeding <code>maxLevel</code></li>
<li class="">Computes total costs by summing purchase costs per resource across the requested count</li>
<li class="">Returns <code>GeneratorPurchaseQuote</code> with <code>costs: [{ resourceId, amount }, ...]</code></li>
<li class="">Returns <code>undefined</code> if any validation fails</li>
</ul>
<p><strong><code>applyPurchase(generatorId, count)</code></strong> (lines 551-556):</p>
<ul>
<li class="">Increments generator owned count via <code>incrementGeneratorOwned()</code></li>
<li class="">Clamps result to <code>maxLevel</code></li>
</ul>
<p><strong>Upgrade Evaluator</strong> (<code>packages/core/src/progression-coordinator.ts</code>):</p>
<p>Implements <code>UpgradePurchaseEvaluator</code> interface from <code>@idle-engine/core</code>.</p>
<p><strong><code>getPurchaseQuote(upgradeId)</code></strong> (lines 562-599):</p>
<ul>
<li class="">Resolves upgrade status (<code>locked</code> | <code>available</code> | <code>purchased</code>)</li>
<li class="">Computes costs via <code>computeUpgradeCosts()</code></li>
<li class="">Returns quote with status and costs</li>
<li class="">For <code>locked</code> upgrades, includes costs even though purchase unavailable (for UI display)</li>
<li class="">Returns <code>undefined</code> if cost computation fails</li>
</ul>
<p><strong><code>applyPurchase(upgradeId)</code></strong> (lines 601-603):</p>
<ul>
<li class="">Increments purchase count via <code>incrementUpgradePurchases()</code></li>
<li class="">Clamps to <code>maxPurchases</code> for repeatable upgrades</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="627-cost-calculation">6.2.7 Cost Calculation<a href="#627-cost-calculation" class="hash-link" aria-label="Direct link to 6.2.7 Cost Calculation" title="Direct link to 6.2.7 Cost Calculation" translate="no">​</a></h4>
<p><strong>Generator Costs</strong> (<code>packages/core/src/progression-coordinator.ts</code>):</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">computeGeneratorCosts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">generatorId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> purchaseIndex</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> GeneratorResourceCost</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><br></span></code></pre></div></div>
<p><strong>Formula (single-currency)</strong>:
<code>amount = costMultiplier × costCurve(purchaseIndex)</code></p>
<p><strong>Formula (multi-resource)</strong>:
For each cost entry <code>i</code>:
<code>amountᵢ = costMultiplierᵢ × costCurveᵢ(purchaseIndex)</code></p>
<p><strong>Upgrade Costs</strong> (<code>packages/core/src/progression-coordinator.ts</code>):</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">computeUpgradeCosts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">record</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> UpgradeRecord</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> UpgradeResourceCost</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> purchaseLevel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">purchases</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> costMultiplier </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">definition</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cost</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">costMultiplier</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> evaluatedCost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateCostFormula</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">definition</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cost</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">costCurve</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    purchaseLevel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> amount </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> evaluatedCost </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> costMultiplier</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Apply repeatable cost curve if upgrade is repeatable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> repeatableCostCurve </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">definition</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">repeatable</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">costCurve</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">repeatableCostCurve</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> repeatableAdjustment </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">evaluateCostFormula</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">repeatableCostCurve</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> purchaseLevel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    amount </span><span class="token operator" style="color:#393A34">*=</span><span class="token plain"> repeatableAdjustment</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> resourceId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> amount </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Formula for repeatable upgrades</strong>:</p>
<div class="language-text codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-text codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token plain">amount = costMultiplier × costCurve(purchaseLevel) × repeatableCostCurve(purchaseLevel)</span><br></span></code></pre></div></div>
<p><strong>Cost formula evaluation</strong> (lines 790-798):</p>
<ul>
<li class="">Evaluates <code>NumericFormula</code> with <code>{ variables: { level: purchaseLevel } }</code></li>
<li class="">Returns <code>undefined</code> if result is not finite</li>
<li class="">Distinguishes from <strong>static threshold evaluation</strong> which uses <code>level: 0</code></li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="628-upgrade-status-resolution">6.2.8 Upgrade Status Resolution<a href="#628-upgrade-status-resolution" class="hash-link" aria-label="Direct link to 6.2.8 Upgrade Status Resolution" title="Direct link to 6.2.8 Upgrade Status Resolution" translate="no">​</a></h4>
<p><strong><code>resolveUpgradeStatus(record)</code></strong> (<code>packages/core/src/progression-coordinator.ts</code>):</p>
<p>Returns <code>&#x27;purchased&#x27; | &#x27;available&#x27; | &#x27;locked&#x27;</code> based on:</p>
<ol>
<li class=""><strong>Already purchased</strong>: <code>purchases &gt;= maxPurchases</code> → <code>&#x27;purchased&#x27;</code></li>
<li class=""><strong>Prerequisites not met</strong>: Any prerequisite condition fails → <code>&#x27;locked&#x27;</code></li>
<li class=""><strong>Unlock condition</strong>:<!-- -->
<ul>
<li class="">If <code>unlockCondition</code> defined and fails → <code>&#x27;locked&#x27;</code></li>
<li class="">If <code>unlockCondition</code> passes (or undefined) → <code>&#x27;available&#x27;</code></li>
</ul>
</li>
</ol>
<p><strong>Repeatable upgrades</strong>: For upgrades with <code>repeatable</code> config and no <code>maxPurchases</code>, <code>maxPurchases</code> defaults to <code>Infinity</code>, so status remains <code>&#x27;available&#x27;</code> after purchase (tested in <code>progression-coordinator.test.ts:203-260</code>).</p>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="63-operational-considerations">6.3 Operational Considerations<a href="#63-operational-considerations" class="hash-link" aria-label="Direct link to 6.3 Operational Considerations" title="Direct link to 6.3 Operational Considerations" translate="no">​</a></h3>
<ul>
<li class=""><strong>Deployment</strong>: Shipped in PR #303; no feature flags or rollout strategy (core infrastructure)</li>
<li class=""><strong>Telemetry &amp; Observability</strong>: Coordinator does not emit telemetry directly; telemetry handled by command handlers consuming evaluators</li>
<li class=""><strong>Security &amp; Compliance</strong>: No PII; coordinator runs in worker isolation; no security implications</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="7-work-breakdown--delivery-plan">7. Work Breakdown &amp; Delivery Plan<a href="#7-work-breakdown--delivery-plan" class="hash-link" aria-label="Direct link to 7. Work Breakdown &amp; Delivery Plan" title="Direct link to 7. Work Breakdown &amp; Delivery Plan" translate="no">​</a></h2>
<p><strong>N/A</strong> - This documents completed work from PR #303.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="8-agent-guidance--guardrails">8. Agent Guidance &amp; Guardrails<a href="#8-agent-guidance--guardrails" class="hash-link" aria-label="Direct link to 8. Agent Guidance &amp; Guardrails" title="Direct link to 8. Agent Guidance &amp; Guardrails" translate="no">​</a></h2>
<p><strong>N/A</strong> - This is retroactive documentation.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="9-alternatives-considered">9. Alternatives Considered<a href="#9-alternatives-considered" class="hash-link" aria-label="Direct link to 9. Alternatives Considered" title="Direct link to 9. Alternatives Considered" translate="no">​</a></h2>
<p><strong>Alternative 1: Direct evaluator access without coordinator</strong></p>
<p>Have command handlers directly instantiate generator/upgrade evaluators and evaluate conditions inline.</p>
<p><strong>Rejected because</strong>:</p>
<ul>
<li class="">Scatters progression logic across multiple command handlers</li>
<li class="">Duplicates condition evaluation code</li>
<li class="">Makes hydration from saves difficult (no centralized state ownership)</li>
<li class="">Complicates testing (must mock multiple handlers instead of single coordinator)</li>
</ul>
<p><strong>Alternative 2: Store progression state in ResourceState</strong></p>
<p>Extend <code>ResourceState</code> to also track generators and upgrades.</p>
<p><strong>Rejected because</strong>:</p>
<ul>
<li class=""><code>ResourceState</code> is optimized for struct-of-arrays resource storage; adding generators/upgrades would break that model</li>
<li class="">Generators/upgrades have different update semantics (unlock conditions, visibility, purchase counts)</li>
<li class="">Would bloat <code>@idle-engine/core</code> package with shell-specific concerns</li>
</ul>
<p><strong>Alternative 3: Immutable state updates</strong></p>
<p>Create new state objects every tick instead of mutating records.</p>
<p><strong>Rejected because</strong>:</p>
<ul>
<li class="">Per-tick allocation churn (every generator/upgrade creates new object)</li>
<li class="">Performance cost for large content packs</li>
<li class="">Frozen external API already prevents accidental mutation</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="10-testing--validation-plan">10. Testing &amp; Validation Plan<a href="#10-testing--validation-plan" class="hash-link" aria-label="Direct link to 10. Testing &amp; Validation Plan" title="Direct link to 10. Testing &amp; Validation Plan" translate="no">​</a></h2>
<p><strong>Existing test coverage</strong> (<code>packages/core/src/progression-coordinator.test.ts</code>):</p>
<ul>
<li class=""><strong>789 lines of integration tests</strong> covering:<!-- -->
<ul>
<li class="">Repeatable upgrade behavior (lines 203-260)</li>
<li class="">Generator unlock with persistent semantics (lines 278-362)</li>
<li class="">Visibility condition evaluation (lines 299-321)</li>
<li class="">Cost calculation for generators and upgrades</li>
<li class="">Full game loop simulations with resource accumulation</li>
</ul>
</li>
</ul>
<p><strong>Condition evaluator tests</strong> (<code>packages/core/src/condition-evaluator.test.ts</code>):</p>
<ul>
<li class=""><strong>556 lines of unit tests</strong> covering all condition types, comparators, error handling</li>
</ul>
<p><strong>Runtime worker integration tests</strong> (archived worker harness tests removed):</p>
<ul>
<li class="">Test &quot;hydrates progression snapshot from sample content state&quot; (line 202)</li>
<li class="">Test &quot;hydrates live resource state from serialized progression when reusing game state&quot; (line 327)</li>
</ul>
<p><strong>Core progression tests</strong> (<code>packages/core/src/progression.test.ts</code>):</p>
<ul>
<li class="">Test <code>nextPurchaseReadyAtStep</code> defaulting (lines 207-235)</li>
<li class="">Test upgrade cost propagation with/without evaluators (lines 237-320)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="11-risks--mitigations">11. Risks &amp; Mitigations<a href="#11-risks--mitigations" class="hash-link" aria-label="Direct link to 11. Risks &amp; Mitigations" title="Direct link to 11. Risks &amp; Mitigations" translate="no">​</a></h2>
<p><strong>Risk</strong>: Per-tick condition evaluation has O(n) cost as content scales</p>
<p><strong>Current Impact</strong>: Low (sample content has ~10 generators/upgrades)</p>
<p><strong>Mitigation</strong>: If needed in future:</p>
<ul>
<li class="">Add dirty tracking (only re-evaluate when dependencies change)</li>
<li class="">Cache condition evaluation results</li>
<li class="">Implement incremental evaluation for static conditions</li>
</ul>
<p><strong>Risk</strong>: Persistent unlock semantics could conflict with future &quot;conditional unlock reversion&quot; feature</p>
<p><strong>Impact</strong>: Medium (would require breaking change)</p>
<p><strong>Mitigation</strong>: Document persistent unlock behavior as <strong>intentional design decision</strong>. If reversion needed, add <code>revokeUnlock</code> API rather than changing <code>updateForStep()</code> behavior.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="12-rollout-plan">12. Rollout Plan<a href="#12-rollout-plan" class="hash-link" aria-label="Direct link to 12. Rollout Plan" title="Direct link to 12. Rollout Plan" translate="no">​</a></h2>
<p><strong>N/A</strong> - Shipped in PR #303 as core infrastructure.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="13-open-questions">13. Open Questions<a href="#13-open-questions" class="hash-link" aria-label="Direct link to 13. Open Questions" title="Direct link to 13. Open Questions" translate="no">​</a></h2>
<p><strong>None</strong> - This documents completed implementation.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="14-follow-up-work">14. Follow-Up Work<a href="#14-follow-up-work" class="hash-link" aria-label="Direct link to 14. Follow-Up Work" title="Direct link to 14. Follow-Up Work" translate="no">​</a></h2>
<p><strong>Potential future enhancements</strong> (not planned):</p>
<ul>
<li class=""><strong>Incremental condition evaluation</strong>: Track condition dependencies and only re-evaluate when state changes</li>
<li class=""><strong>Telemetry integration</strong>: Emit events when generators unlock or upgrades become available</li>
<li class=""><strong>Schema versioning</strong>: Add version field to <code>ProgressionAuthoritativeState</code> for future migrations</li>
<li class=""><strong>Performance profiling</strong>: Benchmark <code>updateForStep()</code> with large content packs (1000+ generators)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="15-references">15. References<a href="#15-references" class="hash-link" aria-label="Direct link to 15. References" title="Direct link to 15. References" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="implementation-files">Implementation Files<a href="#implementation-files" class="hash-link" aria-label="Direct link to Implementation Files" title="Direct link to Implementation Files" translate="no">​</a></h3>
<ul>
<li class=""><code>packages/core/src/progression-coordinator.ts</code> - Coordinator implementation</li>
<li class=""><code>packages/core/src/condition-evaluator.ts</code> - Condition evaluation system</li>
<li class=""><code>packages/core/src/progression-coordinator.test.ts</code> - Integration tests</li>
<li class="">Archived worker harness integration (removed)</li>
<li class=""><code>packages/core/src/progression.ts:1-400</code> - Snapshot builder</li>
<li class=""><code>packages/core/src/resource-state.ts</code> - Resource state storage</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="design-documents">Design Documents<a href="#design-documents" class="hash-link" aria-label="Direct link to Design Documents" title="Direct link to Design Documents" translate="no">​</a></h3>
<ul>
<li class=""><code>docs/resource-state-storage-design.md</code> §5.3 - Resource hydration mechanics</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="related-issues">Related Issues<a href="#related-issues" class="hash-link" aria-label="Direct link to Related Issues" title="Direct link to Related Issues" translate="no">​</a></h3>
<ul>
<li class="">#302 - Issue tracking progression snapshot hydration</li>
<li class="">#303 - PR implementing progression coordinator</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-a--glossary">Appendix A — Glossary<a href="#appendix-a--glossary" class="hash-link" aria-label="Direct link to Appendix A — Glossary" title="Direct link to Appendix A — Glossary" translate="no">​</a></h2>
<ul>
<li class=""><strong>Progression Coordinator</strong>: Facade pattern centralizing progression state ownership and condition evaluation</li>
<li class=""><strong>Authoritative State</strong>: Frozen view of progression state exposed to external consumers</li>
<li class=""><strong>Purchase Evaluator</strong>: Interface for calculating and applying generator/upgrade purchases</li>
<li class=""><strong>Condition Context</strong>: Dependency-injected interface providing state access for condition evaluation</li>
<li class=""><strong>Persistent Unlock</strong>: Once a generator&#x27;s <code>baseUnlock</code> condition passes, <code>isUnlocked</code> never reverts</li>
<li class=""><strong>Static Threshold</strong>: Unlock conditions evaluated with <code>level: 0</code> (constant thresholds)</li>
<li class=""><strong>Dynamic Cost Curve</strong>: Purchase costs evaluated with <code>level: purchaseIndex</code> (scaling curves)</li>
<li class=""><strong>Hydration</strong>: Restoring progression state from serialized save data</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-b--change-log">Appendix B — Change Log<a href="#appendix-b--change-log" class="hash-link" aria-label="Direct link to Appendix B — Change Log" title="Direct link to Appendix B — Change Log" translate="no">​</a></h2>
<table><thead><tr><th>Date</th><th>Author</th><th>Change Summary</th></tr></thead><tbody><tr><td>2025-11-01</td><td>Design Documentation Agent</td><td>Retroactive documentation of PR #303 implementation</td></tr></tbody></table></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_QKxP"><a href="https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/progression-coordinator-design.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_wOWh" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_Basj"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_AUZ0 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#document-control" class="table-of-contents__link toc-highlight">Document Control</a></li><li><a href="#1-summary" class="table-of-contents__link toc-highlight">1. Summary</a></li><li><a href="#2-context--problem-statement" class="table-of-contents__link toc-highlight">2. Context &amp; Problem Statement</a></li><li><a href="#3-goals--non-goals" class="table-of-contents__link toc-highlight">3. Goals &amp; Non-Goals</a></li><li><a href="#4-stakeholders-agents--impacted-surfaces" class="table-of-contents__link toc-highlight">4. Stakeholders, Agents &amp; Impacted Surfaces</a></li><li><a href="#5-current-state" class="table-of-contents__link toc-highlight">5. Current State</a></li><li><a href="#6-proposed-solution" class="table-of-contents__link toc-highlight">6. Proposed Solution</a><ul><li><a href="#61-architecture-overview" class="table-of-contents__link toc-highlight">6.1 Architecture Overview</a></li><li><a href="#62-detailed-design" class="table-of-contents__link toc-highlight">6.2 Detailed Design</a></li><li><a href="#63-operational-considerations" class="table-of-contents__link toc-highlight">6.3 Operational Considerations</a></li></ul></li><li><a href="#7-work-breakdown--delivery-plan" class="table-of-contents__link toc-highlight">7. Work Breakdown &amp; Delivery Plan</a></li><li><a href="#8-agent-guidance--guardrails" class="table-of-contents__link toc-highlight">8. Agent Guidance &amp; Guardrails</a></li><li><a href="#9-alternatives-considered" class="table-of-contents__link toc-highlight">9. Alternatives Considered</a></li><li><a href="#10-testing--validation-plan" class="table-of-contents__link toc-highlight">10. Testing &amp; Validation Plan</a></li><li><a href="#11-risks--mitigations" class="table-of-contents__link toc-highlight">11. Risks &amp; Mitigations</a></li><li><a href="#12-rollout-plan" class="table-of-contents__link toc-highlight">12. Rollout Plan</a></li><li><a href="#13-open-questions" class="table-of-contents__link toc-highlight">13. Open Questions</a></li><li><a href="#14-follow-up-work" class="table-of-contents__link toc-highlight">14. Follow-Up Work</a></li><li><a href="#15-references" class="table-of-contents__link toc-highlight">15. References</a><ul><li><a href="#implementation-files" class="table-of-contents__link toc-highlight">Implementation Files</a></li><li><a href="#design-documents" class="table-of-contents__link toc-highlight">Design Documents</a></li><li><a href="#related-issues" class="table-of-contents__link toc-highlight">Related Issues</a></li></ul></li><li><a href="#appendix-a--glossary" class="table-of-contents__link toc-highlight">Appendix A — Glossary</a></li><li><a href="#appendix-b--change-log" class="table-of-contents__link toc-highlight">Appendix B — Change Log</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/contributor-handbook">Contributor Handbook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Idle Engine.</div></div></div></footer></div>
</body>
</html>