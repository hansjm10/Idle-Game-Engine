<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-runtime-event-pubsub-design" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Runtime Event Pub/Sub Design | Idle Engine Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hansjm10.github.io/Idle-Game-Engine/runtime-event-pubsub-design"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Runtime Event Pub/Sub Design | Idle Engine Docs"><meta data-rh="true" name="description" content="Use this design document to understand the event publication and subscription system that powers cross-system signalling inside the Idle Engine runtime."><meta data-rh="true" property="og:description" content="Use this design document to understand the event publication and subscription system that powers cross-system signalling inside the Idle Engine runtime."><link data-rh="true" rel="icon" href="/Idle-Game-Engine/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hansjm10.github.io/Idle-Game-Engine/runtime-event-pubsub-design"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/runtime-event-pubsub-design" hreflang="en"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/runtime-event-pubsub-design" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Runtime Event Pub/Sub Design","item":"https://hansjm10.github.io/Idle-Game-Engine/runtime-event-pubsub-design"}]}</script><link rel="stylesheet" href="/Idle-Game-Engine/assets/css/styles.0ca8729c.css">
<script src="/Idle-Game-Engine/assets/js/runtime~main.9dde9cf7.js" defer="defer"></script>
<script src="/Idle-Game-Engine/assets/js/main.10c5d50d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Idle-Game-Engine/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_sIzO" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Idle-Game-Engine/"><div class="navbar__logo"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_yXCL themedComponent--light_m26g"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_yXCL themedComponent--dark_DQxa"></div><b class="navbar__title text--truncate">Idle Engine</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Idle-Game-Engine/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_zgE_"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_VTTy colorModeToggle_mrTp"><button class="clean-btn toggleButton_Qf8c toggleButtonDisabled_hCyI" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_j9FX lightToggleIcon_i4Ty"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_j9FX darkToggleIcon_B1fV"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_j9FX systemToggleIcon_d9Wq"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_xdO6"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_fCXc"><div class="docsWrapper_oodB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_ZUBg" type="button"></button><div class="docRoot_zYbW"><aside class="theme-doc-sidebar-container docSidebarContainer_cQjy"><div class="sidebarViewport_guUk"><div class="sidebar_flRn"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_e0X4"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_WJIo menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/Idle-Game-Engine/"><span title="Getting Started" class="categoryLinkLabel_uVix">Getting Started</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/"><span title="Overview" class="linkLabel_Hws7">Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/contributor-handbook"><span title="Contributor Handbook" class="linkLabel_Hws7">Contributor Handbook</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/role-index"><span title="Role Index" class="linkLabel_Hws7">Role Index</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/design-document-template"><span title="Design Document Template" class="linkLabel_Hws7">Design Document Template</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_WJIo menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/Idle-Game-Engine/idle-engine-design"><span title="Core Runtime" class="categoryLinkLabel_uVix">Core Runtime</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/idle-engine-design"><span title="Idle Engine Design Document" class="linkLabel_Hws7">Idle Engine Design Document</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/runtime-step-lifecycle"><span title="Runtime Step Lifecycle Alignment" class="linkLabel_Hws7">Runtime Step Lifecycle Alignment</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/runtime-command-queue-design"><span title="Runtime Command Queue Design" class="linkLabel_Hws7">Runtime Command Queue Design</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/controls-contract-design-issue-705"><span title="Controls Contract Design (Issue 705)" class="linkLabel_Hws7">Controls Contract Design (Issue 705)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/desktop-shell-webgpu-renderer-replay-design-issue-778"><span title="Desktop Shell + WebGPU Renderer + Replay (Issue 778)" class="linkLabel_Hws7">Desktop Shell + WebGPU Renderer + Replay (Issue 778)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Idle-Game-Engine/runtime-event-pubsub-design"><span title="Runtime Event Pub/Sub Design" class="linkLabel_Hws7">Runtime Event Pub/Sub Design</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/runtime-event-bus-decisions"><span title="Runtime Event Bus Follow-up Decisions" class="linkLabel_Hws7">Runtime Event Bus Follow-up Decisions</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/runtime-event-manifest-authoring"><span title="Runtime Event Manifest Authoring" class="linkLabel_Hws7">Runtime Event Manifest Authoring</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/tick-accumulator-coverage-design"><span title="Tick Accumulator Edge Case Coverage" class="linkLabel_Hws7">Tick Accumulator Edge Case Coverage</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/resource-state-storage-design"><span title="Resource State Storage Design" class="linkLabel_Hws7">Resource State Storage Design</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/diagnostic-timeline-design"><span title="Diagnostic Timeline Design Document" class="linkLabel_Hws7">Diagnostic Timeline Design Document</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_WJIo menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/content-dsl-schema-design"><span title="Content Pipeline" class="categoryLinkLabel_uVix">Content Pipeline</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_WJIo menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/coverage/"><span title="Diagnostics &amp; Quality" class="categoryLinkLabel_uVix">Diagnostics &amp; Quality</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_WJIo menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/implementation-plan"><span title="Operations &amp; Process" class="categoryLinkLabel_uVix">Operations &amp; Process</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_BJhZ"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_NkVs"><div class="docItemContainer_WMJH"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_iCU1" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/Idle-Game-Engine/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_HviJ"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Core Runtime</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Runtime Event Pub/Sub Design</span></li></ul></nav><div class="tocCollapsible_Kd7K theme-doc-toc-mobile tocMobile_Gv4l"><button type="button" class="clean-btn tocCollapsibleButton_ajnv">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Runtime Event Pub/Sub Design</h1></header>
<p>Use this design document to understand the event publication and subscription system that powers cross-system signalling inside the Idle Engine runtime.</p>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="document-control">Document Control<a href="#document-control" class="hash-link" aria-label="Direct link to Document Control" title="Direct link to Document Control" translate="no">​</a></h2>
<ul>
<li class=""><strong>Title</strong>: Introduce deterministic runtime event pub/sub system</li>
<li class=""><strong>Authors</strong>: Original design team</li>
<li class=""><strong>Reviewers</strong>: Runtime Core team</li>
<li class=""><strong>Status</strong>: Draft</li>
<li class=""><strong>Last Updated</strong>: 2025-10-14</li>
<li class=""><strong>Related Issues</strong>: #8</li>
<li class=""><strong>Execution Mode</strong>: Hybrid</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="1-summary">1. Summary<a href="#1-summary" class="hash-link" aria-label="Direct link to 1. Summary" title="Direct link to 1. Summary" translate="no">​</a></h2>
<p>The Idle Engine requires a deterministic in-process event bus to enable systems, command handlers, and integrations to react to runtime activity without tight coupling or shared mutable state. This design introduces a type-safe, bounded-allocation pub/sub system that emits immutable event payloads tagged with tick metadata, routed to both internal systems running inside the simulation worker and external observers (presentation shell, telemetry, persistence replay). The solution maintains the single-threaded simulation model while providing explicit contracts for domain events such as threshold triggers, automation toggles, and notifications.</p>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="2-context--problem-statement">2. Context &amp; Problem Statement<a href="#2-context--problem-statement" class="hash-link" aria-label="Direct link to 2. Context &amp; Problem Statement" title="Direct link to 2. Context &amp; Problem Statement" translate="no">​</a></h2>
<ul>
<li class=""><strong>Background</strong>: The engine currently relies on direct callbacks and resource polling for cross-system communication. <code>packages/core</code> exposes a command queue, dispatcher, and recorder but lacks a general event aggregation mechanism. Systems communicate via direct function calls and shared resource state (<code>resource-state.ts</code>). The <code>resource-publish-transport.ts</code> mirrors resource deltas to the presentation shell but cannot emit domain-specific events (e.g., achievement unlocked). Telemetry utilities (<code>telemetry.ts</code>) provide logging hooks but cannot subscribe to structured runtime events.</li>
<li class=""><strong>Problem</strong>: The lack of an explicit event layer creates tight coupling between systems, makes it difficult to implement reactive features (threshold triggers, automation toggles, notifications), and prevents deterministic replay validation of domain events. No test scaffolding exists to assert deterministic delivery order or to validate that subscriptions remain isolated between saves.</li>
<li class=""><strong>Forces</strong>: Must preserve the single-threaded simulation model described in <code>docs/idle-engine-design.md</code> §6.2. Must maintain 60 Hz tick cadence under typical load (≤200 events per tick). Must support offline catch-up and deterministic replay for recorded sessions. Must integrate with existing transport buffers for presentation shell communication.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="3-goals--non-goals">3. Goals &amp; Non-Goals<a href="#3-goals--non-goals" class="hash-link" aria-label="Direct link to 3. Goals &amp; Non-Goals" title="Direct link to 3. Goals &amp; Non-Goals" translate="no">​</a></h2>
<ul>
<li class="">
<p><strong>Goals</strong>:</p>
<ol>
<li class=""><strong>Deterministic ordering</strong>: Events flow through a single queue processed in a repeatable sequence per tick so offline catch-up and replays remain stable.</li>
<li class=""><strong>Type-safe contracts</strong>: Event payloads use shared discriminated unions to prevent runtime casting, mirroring the command payload strategy.</li>
<li class=""><strong>Bounded allocations</strong>: Event storage relies on recyclable buffers to avoid per-tick garbage that would erode performance over long sessions.</li>
<li class=""><strong>Scoped subscriptions</strong>: Systems register interest during initialization and receive only the event categories they declare to keep dispatch efficient.</li>
<li class=""><strong>Snapshot-ready batches</strong>: The bus emits compact frames the existing transport layer can forward to the presentation shell without bespoke wiring.</li>
</ol>
</li>
<li class="">
<p><strong>Non-Goals</strong>:</p>
<ul>
<li class="">Building cross-process or network delivery (handled later by backend integrations).</li>
<li class="">Persisting a long-lived analytics stream; the bus retains only the current tick plus the in-flight snapshot batch.</li>
<li class="">Supporting asynchronous listeners; all handlers execute within the simulation tick and may not yield control or schedule promises.</li>
<li class="">Publishing UI layout events or rendering hints (handled by the shell based on state snapshots).</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="4-stakeholders-agents--impacted-surfaces">4. Stakeholders, Agents &amp; Impacted Surfaces<a href="#4-stakeholders-agents--impacted-surfaces" class="hash-link" aria-label="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" title="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" translate="no">​</a></h2>
<ul>
<li class=""><strong>Primary Stakeholders</strong>: Runtime Core team, Content team, Tooling team</li>
<li class=""><strong>Agent Roles</strong>:<!-- -->
<ul>
<li class="">Runtime Implementation Agent: Core event bus implementation, buffer management, tick lifecycle integration</li>
<li class="">Testing Agent: Unit tests, integration tests, replay verification, performance benchmarks</li>
<li class="">Docs Agent: API documentation, event catalog tables, usage examples</li>
</ul>
</li>
<li class=""><strong>Affected Packages/Services</strong>:<!-- -->
<ul>
<li class=""><code>packages/core</code> (primary implementation)</li>
<li class=""><code>packages/core/src/events</code> (new directory)</li>
<li class=""><code>packages/core/src/command-recorder.ts</code> (replay integration)</li>
<li class="">Presentation shells (archived) (event frame consumption)</li>
<li class=""><code>resource-publish-transport.ts</code> (transport integration)</li>
</ul>
</li>
<li class=""><strong>Compatibility Considerations</strong>: Must maintain backward compatibility with existing command queue and resource state systems. Event frames must be versioned for forward compatibility as new event types are added.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="5-current-state">5. Current State<a href="#5-current-state" class="hash-link" aria-label="Direct link to 5. Current State" title="Direct link to 5. Current State" translate="no">​</a></h2>
<ul>
<li class=""><code>packages/core</code> exposes a command queue, dispatcher, and recorder but lacks a general event aggregation mechanism.</li>
<li class="">Systems communicate via direct function calls and shared resource state (<code>resource-state.ts</code>).</li>
<li class=""><code>resource-publish-transport.ts</code> mirrors resource deltas to the presentation shell yet cannot emit domain-specific events (e.g., achievement unlocked).</li>
<li class="">Telemetry utilities (<code>telemetry.ts</code>) provide logging hooks but cannot subscribe to structured runtime events.</li>
<li class="">No test scaffolding exists to assert deterministic delivery order or to validate that subscriptions remain isolated between saves.</li>
<li class="">This design pairs with the command queue design (<code>docs/runtime-command-queue-design.md</code>) and aligns with the implementation sequencing captured in <code>docs/implementation-plan.md</code> Phase 1.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="6-proposed-solution">6. Proposed Solution<a href="#6-proposed-solution" class="hash-link" aria-label="Direct link to 6. Proposed Solution" title="Direct link to 6. Proposed Solution" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="61-architecture-overview">6.1 Architecture Overview<a href="#61-architecture-overview" class="hash-link" aria-label="Direct link to 6.1 Architecture Overview" title="Direct link to 6.1 Architecture Overview" translate="no">​</a></h3>
<ul>
<li class=""><strong>Narrative</strong>: The event bus encapsulates three core concepts: (1) EventRegistry maps event types to payload validators/encoders and assigns numeric channel indices for fast lookups, (2) EventBuffer provides ring buffers storing RuntimeEvent instances for the current tick with separate buffers for internal subscribers and outbound snapshot frames, and (3) SubscriberTable maintains fixed-length arrays of subscription callbacks keyed by channel index. Events flow through a single queue during each tick, processed after command execution but before snapshot emission, ensuring state mutations precede reactions. The bus emits compact RuntimeEventFrame structures exported alongside resource deltas for the presentation shell.</li>
<li class=""><strong>Diagram</strong>: See tick lifecycle integration diagram in section 6.3.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="62-detailed-design">6.2 Detailed Design<a href="#62-detailed-design" class="hash-link" aria-label="Direct link to 6.2 Detailed Design" title="Direct link to 6.2 Detailed Design" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_pQUT" id="runtime-changes">Runtime Changes<a href="#runtime-changes" class="hash-link" aria-label="Direct link to Runtime Changes" title="Direct link to Runtime Changes" translate="no">​</a></h4>
<p><strong>Event Taxonomy &amp; Schema</strong></p>
<ul>
<li class="">Define <code>RuntimeEvent&lt;TType extends string, TPayload&gt;</code> in <code>packages/core/src/events/runtime-event.ts</code>. Each event is a readonly object:<!-- -->
<div class="language-ts codeBlockContainer_QSSF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_YGpJ"><pre tabindex="0" class="prism-code language-ts codeBlock_Ap7y thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_zA5F"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">RuntimeEvent</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name">TType </span><span class="token class-name keyword" style="color:#00009f">extends</span><span class="token class-name"> RuntimeEventType</span><span class="token class-name punctuation" style="color:#393A34">,</span><span class="token class-name"> TPayload</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TType</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> tick</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> issuedAt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// monotonic ms within session</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> payload</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Readonly</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">TPayload</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
</li>
<li class=""><code>RuntimeEventType</code> is a string literal union grouped by domains (<code>resource</code>, <code>automation</code>, <code>telemetry</code>). Runtime-owned types live in <code>packages/core</code>, while content packs contribute additional entries through an offline manifest.</li>
<li class="">Pack manifests emit <code>eventTypes</code> metadata that is sorted by <code>(packSlug, eventKey)</code> during generation so every build produces the same declaration file and replay manifests stay stable.</li>
<li class="">Export canonical payload types under <code>@idle-engine/core/events</code> (e.g., <code>ResourceThresholdReachedEvent</code>, <code>AutomationToggleEvent</code>) so command handlers and systems share definitions.</li>
</ul>
<p><strong>Event Bus Core</strong></p>
<ul>
<li class="">Introduce <code>EventBus</code> in <code>packages/core/src/events/event-bus.ts</code> exposing:<!-- -->
<div class="language-ts codeBlockContainer_QSSF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_YGpJ"><pre tabindex="0" class="prism-code language-ts codeBlock_Ap7y thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_zA5F"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">EventPublisher</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token generic-function function" style="color:#d73a49">publish</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">TType </span><span class="token generic-function generic class-name keyword" style="color:#00009f">extends</span><span class="token generic-function generic class-name"> RuntimeEventType</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eventType</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    payload</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RuntimeEventPayload</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">TType</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">EventHandler</span><span class="token class-name operator" style="color:#393A34">&lt;</span><span class="token class-name">TType </span><span class="token class-name keyword" style="color:#00009f">extends</span><span class="token class-name"> RuntimeEventType</span><span class="token class-name operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  event</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RuntimeEvent</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">TType</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  context</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> EventDispatchContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
</li>
<li class=""><code>EventDispatchContext</code> carries references to immutable runtime state snapshots needed for read-only inspection while forbidding mutation outside commands.</li>
</ul>
<p><strong>Tick Lifecycle Integration</strong></p>
<ol>
<li class=""><strong>Tick Start</strong>: Scheduler resets all event buffers, bumping the logical tick counter. Systems may register or deregister subscriptions only at this boundary (avoids mid-tick mutations to the subscriber table).</li>
<li class=""><strong>Command Execution</strong>: Command queue drains and mutates state as designed in issue #6. Command handlers can call <code>publish</code> to emit domain events.</li>
<li class=""><strong>System Update Phase</strong>: After all commands, systems execute in their deterministic order (§9 of the engine design). Systems can publish additional events and receive events emitted earlier in the same tick.</li>
<li class=""><strong>Event Dispatch</strong>: For each channel, the bus iterates events in FIFO order and invokes subscriber handlers synchronously. The dispatcher guards against re-entrant publication causing infinite loops by allowing nested publishes but enqueuing them to the tail of the current tick buffer.</li>
<li class=""><strong>Snapshot Emission</strong>: Once internal subscribers finish, the bus compacts the outbound buffers into a <code>RuntimeEventFrame</code> (typed arrays + string table) handed to <code>resource-publish-transport</code> so the presentation shell receives both state deltas and events in the same transferable payload.</li>
<li class=""><strong>Tick End</strong>: Telemetry records buffer metrics (events per channel, dropped events) and clears transient data.</li>
</ol>
<p><strong>Buffer Management &amp; Back-Pressure</strong></p>
<ul>
<li class="">Default buffer capacity per channel is 256 events. <code>EventChannelConfiguration</code> exposes an optional <code>diagnostics</code> block and <code>channelConfigs</code> allows per-channel overrides so integrators can tune <code>maxEventsPerTick</code>, <code>maxEventsPerSecond</code>, <code>cooldownTicks</code>, and <code>maxCooldownTicks</code> without rewriting the bus.</li>
<li class="">Publishing beyond the configured soft limit triggers the <code>EventDiagnostics</code> rate limiter. The first breach issues an <code>EventSoftLimitBreach</code> warning with remaining capacity and increments <code>events.soft_limited</code> alongside the per-channel <code>events.soft_limit_breaches</code> telemetry counter.</li>
<li class="">Overflowing the hard capacity throws <code>EventBufferOverflowError</code> and records <code>events.overflowed</code>, causing the tick to rewind at <code>beginTick()</code>.</li>
<li class=""><code>eventBus.getBackPressureSnapshot()</code> surfaces per-channel <code>inUse</code>, <code>remainingCapacity</code>, <code>highWaterMark</code>, <code>cooldownTicksRemaining</code>, <code>softLimitBreaches</code>, and the most recent <code>eventsPerSecond</code> sample for dashboards and transports.</li>
<li class="">Buffers use struct-of-arrays layouts mirroring resource storage for efficient transfer to the shell with minimal copying.</li>
</ul>
<p><strong>Subscription API</strong></p>
<ul>
<li class="">Systems register via:<!-- -->
<div class="language-ts codeBlockContainer_QSSF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_YGpJ"><pre tabindex="0" class="prism-code language-ts codeBlock_Ap7y thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_zA5F"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">EventSubscriptionHost</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token generic-function function" style="color:#d73a49">on</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">TType </span><span class="token generic-function generic class-name keyword" style="color:#00009f">extends</span><span class="token generic-function generic class-name"> RuntimeEventType</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eventType</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    handler</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> EventHandler</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">TType</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> EventSubscription</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
</li>
<li class=""><code>EventSubscription</code> exposes <code>unsubscribe()</code> used during system teardown (prestige resets, content unload). Teardown defers actual removal until the next tick boundary.</li>
<li class="">Convenience helpers for common patterns:<!-- -->
<ul>
<li class=""><code>onResourceThreshold(resourceId, comparator, handler)</code> to reduce boilerplate.</li>
<li class=""><code>once(eventType, handler)</code> that auto-unsubscribes after first invocation.</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_pQUT" id="data--schemas">Data &amp; Schemas<a href="#data--schemas" class="hash-link" aria-label="Direct link to Data &amp; Schemas" title="Direct link to Data &amp; Schemas" translate="no">​</a></h4>
<ul>
<li class="">Per-pack manifests authored in <code>content/event-types.json</code> files describe additional event types.</li>
<li class="">Running <code>pnpm generate</code> merges the manifests with the core catalogue, refreshes the deterministic manifest hash, and updates the <code>ContentRuntimeEventType</code> union exported by <code>@idle-engine/core</code>.</li>
<li class="">See <code>docs/runtime-event-manifest-authoring.md</code> for authoring guidance.</li>
<li class="">The generator publishes a manifest hash consumed by the recorder; replay files embed the hash and fail fast if the runtime attempts to load a different catalogue, preventing content drift across environments.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_pQUT" id="apis--contracts">APIs &amp; Contracts<a href="#apis--contracts" class="hash-link" aria-label="Direct link to APIs &amp; Contracts" title="Direct link to APIs &amp; Contracts" translate="no">​</a></h4>
<ul>
<li class="">Event frames feed into the command recorder (<code>packages/core/src/command-recorder.ts</code>) so replay files contain both commands and events. Replays validate that emitted events match recorded ones.</li>
<li class="">Presentation shells can consume event frames to trigger UI transitions (e.g., toast notifications). Client-side filtering helps avoid jank during heavy tick loads.</li>
<li class="">Persistence layer optionally stores the most recent N frames (configurable) to resume UI transitions after reload.</li>
<li class="">Scripts running inside the deterministic sandbox receive a limited proxy that only allows them to subscribe to whitelisted event types (guarded by content permissions).</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_pQUT" id="tooling--automation">Tooling &amp; Automation<a href="#tooling--automation" class="hash-link" aria-label="Direct link to Tooling &amp; Automation" title="Direct link to Tooling &amp; Automation" translate="no">​</a></h4>
<ul>
<li class="">Expose a developer-mode event inspector in the web shell that reads the transfer frame and renders the last N events for debugging, including the current soft-limit cooldown, breach counts, and per-channel rates sourced from the back-pressure snapshot.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="63-operational-considerations">6.3 Operational Considerations<a href="#63-operational-considerations" class="hash-link" aria-label="Direct link to 6.3 Operational Considerations" title="Direct link to 6.3 Operational Considerations" translate="no">​</a></h3>
<ul>
<li class=""><strong>Deployment</strong>: Integration follows Phase 1 Runtime Core sequencing: command queue integration precedes transport updates to keep merges small and reviewable.</li>
<li class=""><strong>Telemetry &amp; Observability</strong>:<!-- -->
<ul>
<li class="">Emit telemetry counters for <code>events.published</code>, <code>events.soft_limited</code>, <code>events.overflowed</code>, and <code>events.subscribers</code> per tick.</li>
<li class="">Surface per-channel gauges (<code>idle_engine_events_soft_limit_cooldown_ticks</code>) and counters (<code>idle_engine_events_soft_limit_breaches_total</code>) so dashboards can highlight channels that continue to push into the soft limit window.</li>
<li class="">Log structured warnings when handlers exceed execution time thresholds (e.g., &gt;2 ms) to surface slow subscribers.</li>
</ul>
</li>
<li class=""><strong>Security &amp; Compliance</strong>: Scripts running inside the deterministic sandbox receive limited event subscription capabilities restricted by content permissions whitelist.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="7-work-breakdown--delivery-plan">7. Work Breakdown &amp; Delivery Plan<a href="#7-work-breakdown--delivery-plan" class="hash-link" aria-label="Direct link to 7. Work Breakdown &amp; Delivery Plan" title="Direct link to 7. Work Breakdown &amp; Delivery Plan" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="71-issue-map">7.1 Issue Map<a href="#71-issue-map" class="hash-link" aria-label="Direct link to 7.1 Issue Map" title="Direct link to 7.1 Issue Map" translate="no">​</a></h3>
<table><thead><tr><th>Issue Title</th><th>Scope Summary</th><th>Proposed Assignee/Agent</th><th>Dependencies</th><th>Acceptance Criteria</th></tr></thead><tbody><tr><td>feat(core): implement event bus core</td><td>EventBus, EventRegistry, EventBuffer, SubscriberTable</td><td>Runtime Implementation Agent</td><td>Design approval</td><td>Unit tests pass; exports public API</td></tr><tr><td>feat(core): add runtime event types</td><td>RuntimeEvent, RuntimeEventType unions, payload schemas</td><td>Runtime Implementation Agent</td><td>Event bus core</td><td>TypeScript compilation; types exported</td></tr><tr><td>feat(core): integrate tick lifecycle</td><td>Wire event dispatch into scheduler phases</td><td>Runtime Implementation Agent</td><td>Event bus core, command queue #6</td><td>Integration tests validate deterministic ordering</td></tr><tr><td>feat(core): add buffer management</td><td>Back-pressure diagnostics, soft/hard limits, telemetry</td><td>Runtime Implementation Agent</td><td>Event bus core</td><td>Performance tests validate <code>&lt;100ms</code> tick budget</td></tr><tr><td>feat(core): implement subscription API</td><td>EventSubscriptionHost, convenience helpers</td><td>Runtime Implementation Agent</td><td>Event bus core</td><td>Unit tests cover subscribe/unsubscribe lifecycle</td></tr><tr><td>feat(core): integrate transport layer</td><td>RuntimeEventFrame serialization, resource-publish-transport updates</td><td>Runtime Implementation Agent</td><td>Event bus core</td><td>Shell receives event frames alongside resource deltas</td></tr><tr><td>feat(core): add replay support</td><td>Command recorder integration, manifest hash validation</td><td>Runtime Implementation Agent</td><td>Event bus core, transport layer</td><td>Replay tests validate deterministic emission</td></tr><tr><td>feat(content): add event manifest generation</td><td>Content pack event-types.json, pnpm generate integration</td><td>Tooling Agent</td><td>Event bus core</td><td>Generate produces deterministic manifest hash</td></tr><tr><td>feat(shell): add event frame consumption</td><td>Parse and display events in web shell</td><td>UI Agent</td><td>Transport layer</td><td>Shell renders toast notifications from events</td></tr><tr><td>docs(core): publish event catalog</td><td>API documentation, usage examples, event type tables</td><td>Docs Agent</td><td>All implementation complete</td><td>Docs published in runtime-step-lifecycle.md</td></tr><tr><td>test(core): performance benchmarks</td><td>Validate 10k events/tick <code>&lt;100ms</code></td><td>Testing Agent</td><td>Event bus core</td><td>CI includes performance regression suite</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="72-milestones">7.2 Milestones<a href="#72-milestones" class="hash-link" aria-label="Direct link to 7.2 Milestones" title="Direct link to 7.2 Milestones" translate="no">​</a></h3>
<ul>
<li class=""><strong>Phase 1 - Core Implementation</strong>: Land event bus with unit tests and documentation stubs. Integrate resource threshold events and confirm shell transport round-trip.</li>
<li class=""><strong>Phase 2 - Feature Expansion</strong>: Expand coverage to automation toggles and prestige resets. Enable recording/replay validation.</li>
<li class=""><strong>Phase 3 - Developer Tooling</strong>: Ship developer tooling for inspection. Update implementation plan and project board cards once early adopters integrate (saves, UI toasts, analytics).</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_pQUT" id="73-coordination-notes">7.3 Coordination Notes<a href="#73-coordination-notes" class="hash-link" aria-label="Direct link to 7.3 Coordination Notes" title="Direct link to 7.3 Coordination Notes" translate="no">​</a></h3>
<ul>
<li class=""><strong>Hand-off Package</strong>: Share <code>docs/idle-engine-design.md</code> §6.2, <code>docs/runtime-command-queue-design.md</code>, <code>docs/implementation-plan.md</code> Phase 1 with implementing agents.</li>
<li class=""><strong>Communication Cadence</strong>: Weekly sync on Runtime Core progress; flag blocking issues immediately via GitHub issue comments.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="8-agent-guidance--guardrails">8. Agent Guidance &amp; Guardrails<a href="#8-agent-guidance--guardrails" class="hash-link" aria-label="Direct link to 8. Agent Guidance &amp; Guardrails" title="Direct link to 8. Agent Guidance &amp; Guardrails" translate="no">​</a></h2>
<ul>
<li class=""><strong>Context Packets</strong>:<!-- -->
<ul>
<li class="">Required reading: <code>docs/idle-engine-design.md</code> §6.2 (single-threaded simulation model), <code>docs/runtime-command-queue-design.md</code> (command execution lifecycle)</li>
<li class="">Environment: Must run in worker contexts; no DOM or async APIs allowed in event handlers</li>
<li class="">Repository: <code>packages/core/src/events/</code> for all new event system code</li>
</ul>
</li>
<li class=""><strong>Prompting &amp; Constraints</strong>:<!-- -->
<ul>
<li class="">All event types must be readonly discriminated unions</li>
<li class="">Event handlers must be synchronous and side-effect free (read-only access to state)</li>
<li class="">Commit messages must follow conventional commits format: <code>feat(core): &lt;description&gt;</code></li>
<li class="">TypeScript strict mode required; no <code>any</code> types</li>
</ul>
</li>
<li class=""><strong>Safety Rails</strong>:<!-- -->
<ul>
<li class="">Do not mutate shared state in event handlers; pass EventDispatchContext with readonly snapshots</li>
<li class="">Do not allow unbounded buffer growth; enforce hard capacity limits with clear error messages</li>
<li class="">Do not skip telemetry instrumentation; all critical paths must emit metrics</li>
</ul>
</li>
<li class=""><strong>Validation Hooks</strong>:<!-- -->
<ul>
<li class="">Run <code>pnpm test</code> before marking tasks complete</li>
<li class="">Run <code>pnpm build</code> to validate TypeScript compilation</li>
<li class="">Run performance benchmarks (<code>pnpm bench:events</code>) to validate <code>&lt;100ms</code> tick budget</li>
<li class="">Validate replay determinism with <code>pnpm test:replay</code></li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="9-alternatives-considered">9. Alternatives Considered<a href="#9-alternatives-considered" class="hash-link" aria-label="Direct link to 9. Alternatives Considered" title="Direct link to 9. Alternatives Considered" translate="no">​</a></h2>
<ol>
<li class="">
<p><strong>External event broker (Redis pub/sub, NATS)</strong>: Rejected due to cross-process coordination overhead, network latency unpredictability, and complexity of maintaining deterministic replay across network boundaries. In-process solution keeps simulation single-threaded and deterministic.</p>
</li>
<li class="">
<p><strong>Observable/RxJS streams</strong>: Rejected due to async nature conflicting with synchronous tick model, large bundle size for web shell, and difficulty enforcing deterministic execution order with operators like <code>debounce</code> or <code>throttle</code>.</p>
</li>
<li class="">
<p><strong>Event sourcing with persistent event log</strong>: Rejected as over-engineering for current requirements. The bus only needs current tick + snapshot batch; full event sourcing would require database integration and increase complexity without clear benefit. May revisit for analytics workloads.</p>
</li>
<li class="">
<p><strong>Priority-based event channels</strong>: Rejected in favor of single FIFO dispatch order. Publishers control sequencing by when they emit events rather than via priority tiers. Simplifies implementation and reasoning about deterministic behavior. Documented in <code>docs/runtime-event-bus-decisions.md</code> (issue #87).</p>
</li>
<li class="">
<p><strong>Object arrays vs struct-of-arrays serialization</strong>: Chose struct-of-arrays as default for memory efficiency and transfer performance, with feature-flagged fallback to object arrays when rolling density metrics show sparse workloads. Both formats share a <code>format</code> discriminator for safe downstream branching.</p>
</li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="10-testing--validation-plan">10. Testing &amp; Validation Plan<a href="#10-testing--validation-plan" class="hash-link" aria-label="Direct link to 10. Testing &amp; Validation Plan" title="Direct link to 10. Testing &amp; Validation Plan" translate="no">​</a></h2>
<ul>
<li class=""><strong>Unit / Integration</strong>:<!-- -->
<ul>
<li class="">Validate publish/subscribe order, handler isolation, buffer limits, and nested publication semantics in <code>packages/core/src/events/event-bus.test.ts</code>.</li>
<li class="">Simulate a multi-system tick (resource system + automation system) to confirm deterministic playback across multiple ticks.</li>
<li class="">Extend <code>command-recorder.test.ts</code> to assert that recorded event frames match live emissions when re-running the same command sequence.</li>
</ul>
</li>
<li class=""><strong>Performance</strong>:<!-- -->
<ul>
<li class="">Benchmark publishing 10k events per tick to ensure the bus respects the 100ms budget, mirroring the profiling harness planned in the implementation plan.</li>
<li class="">Validate zero observable impact on tick cadence at 60 Hz under typical load (≤200 events per tick).</li>
<li class="">Profile buffer allocation patterns to confirm bounded allocations without per-tick garbage collection pressure.</li>
</ul>
</li>
<li class=""><strong>Tooling / A11y</strong>: Developer-mode event inspector in web shell must render events with clear visual hierarchy and support screen readers.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="11-risks--mitigations">11. Risks &amp; Mitigations<a href="#11-risks--mitigations" class="hash-link" aria-label="Direct link to 11. Risks &amp; Mitigations" title="Direct link to 11. Risks &amp; Mitigations" translate="no">​</a></h2>
<table><thead><tr><th>Risk</th><th>Impact</th><th>Likelihood</th><th>Mitigation</th></tr></thead><tbody><tr><td>Runaway publishers exceeding event limits</td><td>Tick time starvation, degraded UX</td><td>Medium</td><td>Channel-level soft/hard thresholds with telemetry alerts and exponential backoff on warnings</td></tr><tr><td>Subscriber handlers mutating shared state</td><td>Breaks determinism, corrupts replays</td><td>Medium</td><td>Pass read-only EventDispatchContext; audit tests for unauthorized mutations; runtime checks in dev mode</td></tr><tr><td>Event frame transport bloat</td><td>Increased network payload, shell lag</td><td>Low</td><td>Compress string tables; allow shell to opt into specific channels; monitor payload size metrics</td></tr><tr><td>Content manifest hash mismatches during replay</td><td>Replay fails to load, bad user experience</td><td>Low</td><td>Fail fast with clear error message; version manifest schema; document upgrade path in migration guide</td></tr><tr><td>Performance regression from event overhead</td><td>Cannot maintain 60 Hz tick rate</td><td>Low</td><td>Continuous performance benchmarking in CI; profile event dispatch critical path; buffer pooling to minimize GC</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="12-rollout-plan">12. Rollout Plan<a href="#12-rollout-plan" class="hash-link" aria-label="Direct link to 12. Rollout Plan" title="Direct link to 12. Rollout Plan" translate="no">​</a></h2>
<ul>
<li class=""><strong>Milestones</strong>:<!-- -->
<ol>
<li class=""><strong>Week 1-2</strong>: Land the core event bus with unit tests and documentation stubs.</li>
<li class=""><strong>Week 3</strong>: Integrate resource threshold events and confirm shell transport round-trip.</li>
<li class=""><strong>Week 4-5</strong>: Expand coverage to automation toggles and prestige resets.</li>
<li class=""><strong>Week 6</strong>: Enable recording/replay validation and ship developer tooling for inspection.</li>
<li class=""><strong>Week 7+</strong>: Update implementation plan and project board cards once early adopters integrate (saves, UI toasts, analytics).</li>
</ol>
</li>
<li class=""><strong>Migration Strategy</strong>: No breaking changes to existing systems. Event bus is additive; systems opt-in to publishing/subscribing. Existing command queue and resource state mechanisms remain unchanged.</li>
<li class=""><strong>Communication</strong>:<!-- -->
<ul>
<li class="">Publish API documentation and usage examples in <code>docs/runtime-step-lifecycle.md</code> once initial channels ship.</li>
<li class="">Update project board to reflect completion of issue #8.</li>
<li class="">Announce availability to content team for event manifest authoring.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="13-open-questions">13. Open Questions<a href="#13-open-questions" class="hash-link" aria-label="Direct link to 13. Open Questions" title="Direct link to 13. Open Questions" translate="no">​</a></h2>
<p>All deferred decisions from the draft have been finalized in <code>docs/runtime-event-bus-decisions.md</code> (issue #87). No open questions remain.</p>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="14-follow-up-work">14. Follow-Up Work<a href="#14-follow-up-work" class="hash-link" aria-label="Direct link to 14. Follow-Up Work" title="Direct link to 14. Follow-Up Work" translate="no">​</a></h2>
<ul>
<li class=""><strong>Cross-process event delivery</strong>: Build network transport for backend integrations (deferred to Phase 2).</li>
<li class=""><strong>Long-lived analytics stream</strong>: Investigate persistent event storage for analytics workloads beyond current tick + snapshot batch (deferred pending analytics requirements).</li>
<li class=""><strong>Advanced subscription patterns</strong>: Explore filtered subscriptions (e.g., subscribe to specific resource IDs) if common patterns emerge (deferred until usage data available).</li>
<li class=""><strong>Event replay UI</strong>: Build dedicated replay viewer with timeline scrubbing and event filtering (deferred to tooling roadmap).</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="15-references">15. References<a href="#15-references" class="hash-link" aria-label="Direct link to 15. References" title="Direct link to 15. References" translate="no">​</a></h2>
<ul>
<li class=""><code>docs/idle-engine-design.md</code> §6.2: Single-threaded simulation model</li>
<li class=""><code>docs/runtime-command-queue-design.md</code>: Command execution lifecycle and dispatcher integration</li>
<li class=""><code>docs/implementation-plan.md</code> Phase 1: Runtime Core task sequencing</li>
<li class=""><code>docs/runtime-event-bus-decisions.md</code> (issue #87): Resolved design decisions on content-defined events, priority channels, back-pressure strategy, serialization format</li>
<li class=""><code>docs/runtime-event-manifest-authoring.md</code>: Content pack event type authoring guidance</li>
<li class=""><code>docs/runtime-step-lifecycle.md</code>: Target location for event catalog tables documentation</li>
<li class=""><code>packages/core/src/events/</code>: Event system implementation directory</li>
<li class=""><code>packages/core/src/command-recorder.ts</code>: Replay integration point</li>
<li class="">Archived presentation shell implementation (removed)</li>
<li class=""><code>resource-publish-transport.ts</code>: Transport layer integration point</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="appendix-a--glossary">Appendix A — Glossary<a href="#appendix-a--glossary" class="hash-link" aria-label="Direct link to Appendix A — Glossary" title="Direct link to Appendix A — Glossary" translate="no">​</a></h2>
<ul>
<li class=""><strong>Event Bus</strong>: In-process pub/sub system for routing domain events between runtime systems</li>
<li class=""><strong>RuntimeEvent</strong>: Immutable event payload tagged with tick metadata and event type</li>
<li class=""><strong>RuntimeEventType</strong>: String literal union discriminating event categories (resource, automation, telemetry)</li>
<li class=""><strong>EventPublisher</strong>: Interface for publishing events during command execution or system updates</li>
<li class=""><strong>EventHandler</strong>: Synchronous callback invoked when subscribed event is dispatched</li>
<li class=""><strong>EventDispatchContext</strong>: Read-only runtime state snapshot passed to event handlers</li>
<li class=""><strong>EventBuffer</strong>: Ring buffer storing RuntimeEvent instances for the current tick</li>
<li class=""><strong>EventRegistry</strong>: Maps event types to payload validators/encoders with numeric channel indices</li>
<li class=""><strong>SubscriberTable</strong>: Fixed-length array of subscription callbacks keyed by channel index</li>
<li class=""><strong>RuntimeEventFrame</strong>: Compact serialization of tick events using typed arrays and string table</li>
<li class=""><strong>Back-pressure</strong>: Rate limiting mechanism when event volume exceeds configured thresholds</li>
<li class=""><strong>Soft limit</strong>: Configurable threshold triggering diagnostic warnings with exponential backoff</li>
<li class=""><strong>Hard limit</strong>: Maximum capacity causing tick rewind when exceeded</li>
<li class=""><strong>Deterministic replay</strong>: Ability to reproduce exact event sequence given same command stream</li>
<li class=""><strong>Manifest hash</strong>: Cryptographic hash of event type catalogue for replay validation</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_pQUT" id="appendix-b--change-log">Appendix B — Change Log<a href="#appendix-b--change-log" class="hash-link" aria-label="Direct link to Appendix B — Change Log" title="Direct link to Appendix B — Change Log" translate="no">​</a></h2>
<table><thead><tr><th>Date</th><th>Author</th><th>Change Summary</th></tr></thead><tbody><tr><td>2025-10-14</td><td>Original design team</td><td>Initial draft</td></tr><tr><td>2025-12-21</td><td>Claude Opus 4.5</td><td>Migrated to design document template format (issue #205)</td></tr></tbody></table></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_zkN7"><a href="https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/runtime-event-pubsub-design.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_URLU" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_DCA4"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/Idle-Game-Engine/desktop-shell-webgpu-renderer-replay-design-issue-778"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Desktop Shell + WebGPU Renderer + Replay (Issue 778)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Idle-Game-Engine/runtime-event-bus-decisions"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Runtime Event Bus Follow-up Decisions</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_7BTH thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#document-control" class="table-of-contents__link toc-highlight">Document Control</a></li><li><a href="#1-summary" class="table-of-contents__link toc-highlight">1. Summary</a></li><li><a href="#2-context--problem-statement" class="table-of-contents__link toc-highlight">2. Context &amp; Problem Statement</a></li><li><a href="#3-goals--non-goals" class="table-of-contents__link toc-highlight">3. Goals &amp; Non-Goals</a></li><li><a href="#4-stakeholders-agents--impacted-surfaces" class="table-of-contents__link toc-highlight">4. Stakeholders, Agents &amp; Impacted Surfaces</a></li><li><a href="#5-current-state" class="table-of-contents__link toc-highlight">5. Current State</a></li><li><a href="#6-proposed-solution" class="table-of-contents__link toc-highlight">6. Proposed Solution</a><ul><li><a href="#61-architecture-overview" class="table-of-contents__link toc-highlight">6.1 Architecture Overview</a></li><li><a href="#62-detailed-design" class="table-of-contents__link toc-highlight">6.2 Detailed Design</a></li><li><a href="#63-operational-considerations" class="table-of-contents__link toc-highlight">6.3 Operational Considerations</a></li></ul></li><li><a href="#7-work-breakdown--delivery-plan" class="table-of-contents__link toc-highlight">7. Work Breakdown &amp; Delivery Plan</a><ul><li><a href="#71-issue-map" class="table-of-contents__link toc-highlight">7.1 Issue Map</a></li><li><a href="#72-milestones" class="table-of-contents__link toc-highlight">7.2 Milestones</a></li><li><a href="#73-coordination-notes" class="table-of-contents__link toc-highlight">7.3 Coordination Notes</a></li></ul></li><li><a href="#8-agent-guidance--guardrails" class="table-of-contents__link toc-highlight">8. Agent Guidance &amp; Guardrails</a></li><li><a href="#9-alternatives-considered" class="table-of-contents__link toc-highlight">9. Alternatives Considered</a></li><li><a href="#10-testing--validation-plan" class="table-of-contents__link toc-highlight">10. Testing &amp; Validation Plan</a></li><li><a href="#11-risks--mitigations" class="table-of-contents__link toc-highlight">11. Risks &amp; Mitigations</a></li><li><a href="#12-rollout-plan" class="table-of-contents__link toc-highlight">12. Rollout Plan</a></li><li><a href="#13-open-questions" class="table-of-contents__link toc-highlight">13. Open Questions</a></li><li><a href="#14-follow-up-work" class="table-of-contents__link toc-highlight">14. Follow-Up Work</a></li><li><a href="#15-references" class="table-of-contents__link toc-highlight">15. References</a></li><li><a href="#appendix-a--glossary" class="table-of-contents__link toc-highlight">Appendix A — Glossary</a></li><li><a href="#appendix-b--change-log" class="table-of-contents__link toc-highlight">Appendix B — Change Log</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/contributor-handbook">Contributor Handbook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_zgE_"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_zgE_"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Idle Engine.</div></div></div></footer></div>
</body>
</html>