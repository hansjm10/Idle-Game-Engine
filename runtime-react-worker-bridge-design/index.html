<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-runtime-react-worker-bridge-design" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Implement Runtime-&gt;React Worker Bridge | Idle Engine Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hansjm10.github.io/Idle-Game-Engine/runtime-react-worker-bridge-design"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Implement Runtime-&gt;React Worker Bridge | Idle Engine Docs"><meta data-rh="true" name="description" content="Issue: #16 (implementation) / #251 (design doc) - Presentation Shell Workstream"><meta data-rh="true" property="og:description" content="Issue: #16 (implementation) / #251 (design doc) - Presentation Shell Workstream"><link data-rh="true" rel="icon" href="/Idle-Game-Engine/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hansjm10.github.io/Idle-Game-Engine/runtime-react-worker-bridge-design"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/runtime-react-worker-bridge-design" hreflang="en"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/runtime-react-worker-bridge-design" hreflang="x-default"><link rel="stylesheet" href="/Idle-Game-Engine/assets/css/styles.ddf7989c.css">
<script src="/Idle-Game-Engine/assets/js/runtime~main.c08d0969.js" defer="defer"></script>
<script src="/Idle-Game-Engine/assets/js/main.267f9d33.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Idle-Game-Engine/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_li4T" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Idle-Game-Engine/"><div class="navbar__logo"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--light_vaEm"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--dark_axH8"></div><b class="navbar__title text--truncate">Idle Engine</b></a><a class="navbar__item navbar__link" href="/Idle-Game-Engine/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle__Exw colorModeToggle_Lslw"><button class="clean-btn toggleButton_AMBK toggleButtonDisabled_p4Bd" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 lightToggleIcon_p2sk"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 darkToggleIcon_B2qX"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 systemToggleIcon_PWgn"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_RKai"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_nqaE"><div class="docsWrapper_CSLE"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sOWX" type="button"></button><div class="docRoot_qxtV"><main class="docMainContainer_tfRv docMainContainerEnhanced_qAvX"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_hyci"><div class="docItemContainer_tcAC"><article><div class="tocCollapsible_WMbj theme-doc-toc-mobile tocMobile_wI3e"><button type="button" class="clean-btn tocCollapsibleButton_rjEa">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Implement Runtime-&gt;React Worker Bridge</h1></header>
<p>Issue: #16 (implementation) / #251 (design doc) - Presentation Shell Workstream</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="document-control">Document Control<a href="#document-control" class="hash-link" aria-label="Direct link to Document Control" title="Direct link to Document Control" translate="no">​</a></h2>
<ul>
<li class=""><strong>Title</strong>: Implement runtime-&gt;React Worker bridge</li>
<li class=""><strong>Authors</strong>: Idle Engine Design Authoring Agent (AI)</li>
<li class=""><strong>Reviewers</strong>: TODO (Presentation Shell Lead)</li>
<li class=""><strong>Status</strong>: Approved</li>
<li class=""><strong>Last Updated</strong>: 2025-11-11</li>
<li class=""><strong>Related Issues</strong>: <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/16" target="_blank" rel="noopener noreferrer" class="">#16</a>, <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/251" target="_blank" rel="noopener noreferrer" class="">#251</a></li>
<li class=""><strong>Operational Runbook</strong>: <a class="" href="/Idle-Game-Engine/runtime-worker-bridge-runbook">Runtime-&gt;React Worker Bridge Operational Runbook</a></li>
<li class=""><strong>Execution Mode</strong>: AI-led</li>
<li class=""><strong>Schema Package</strong>: <code>@idle-engine/runtime-bridge-contracts</code></li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="1-summary">1. Summary<a href="#1-summary" class="hash-link" aria-label="Direct link to 1. Summary" title="Direct link to 1. Summary" translate="no">​</a></h2>
<p>Responding to the directive &quot;Create a design document for issue #16, use gh to find more about it,&quot; this plan formalises how we deliver a resilient Worker-mediated bridge from the deterministic runtime to the React presentation shell. Issue #16 (&quot;Create Worker bridge for runtime -&gt; React&quot;) requires hardened message contracts, lifecycle management, and diagnostics propagation so the shell can safely emit player commands and render authoritative state snapshots without compromising the runtime loop. The proposed architecture refines the existing worker prototype, codifies command and telemetry flows (READY/ERROR handshake, diagnostics toggles), and documents the session snapshot protocol to reach production readiness.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="2-context--problem-statement">2. Context &amp; Problem Statement<a href="#2-context--problem-statement" class="hash-link" aria-label="Direct link to 2. Context &amp; Problem Statement" title="Direct link to 2. Context &amp; Problem Statement" translate="no">​</a></h2>
<ul>
<li class=""><strong>Background</strong>: The implementation plan highlights the Presentation Shell workstream&#x27;s dependency on a Worker channel to consume runtime snapshots (<code>docs/implementation-plan.md:18</code>). Prototype wiring already instantiates <code>IdleEngineRuntime</code> inside a dedicated worker (<code>packages/shell-web/src/runtime.worker.ts:74</code>) and exposes a hook-based bridge for React (<code>packages/shell-web/src/modules/worker-bridge.ts:181</code>). Architecture notes confirm the importance of keeping command stamping consistent with the fixed-step lifecycle (<code>docs/runtime-step-lifecycle.md:19</code>).</li>
<li class=""><strong>Problem</strong>: Issue #16 lacks an approved design describing the Worker bridge contract, error handling, diagnostics handshake, and React integration boundaries. The current bridge prototype (<code>packages/shell-web/src/modules/worker-bridge.ts:63</code>) is functional but undocumented, omits replay protection, and hardcodes payload shapes that downstream agents cannot rely on. Without a sanctioned design, AI agents risk diverging implementations and UI regressions.</li>
<li class=""><strong>Forces</strong>: The bridge must preserve runtime determinism, remain Vite/React compatible, expose diagnostics for performance tuning, and sustain long-lived sessions without memory leaks. Presentation increments depend on a stable API, while runtime owners require guardrails that prevent untrusted UI code from mutating engine state directly.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="3-goals--non-goals">3. Goals &amp; Non-Goals<a href="#3-goals--non-goals" class="hash-link" aria-label="Direct link to 3. Goals &amp; Non-Goals" title="Direct link to 3. Goals &amp; Non-Goals" translate="no">​</a></h2>
<ul>
<li class=""><strong>Goals</strong>
<ul>
<li class="">Publish an authoritative Worker message contract for issue #16 covering command, state, diagnostics, session snapshot, and lifecycle envelopes.</li>
<li class="">Establish a canonical schema package: <code>@idle-engine/runtime-bridge-contracts</code> for all worker bridge message types and constants (e.g., <code>WORKER_MESSAGE_SCHEMA_VERSION</code>).</li>
<li class="">Ship a reusable React-facing bridge that enforces disposal, subscription control, and monotonic timestamps.</li>
<li class="">Provide diagnostics opt-in wiring so shell agents can enable the runtime timeline without polluting baseline runs.</li>
<li class="">Document operational runbooks for bundling, error surfacing, snapshot restore, and testing under Vite-driven dev/CI workflows.</li>
</ul>
</li>
<li class=""><strong>Non-Goals</strong>
<ul>
<li class="">Redesigning the IdleEngineRuntime scheduler or command queue internals (covered elsewhere).</li>
<li class="">Delivering final presentation components beyond the thin shell required to validate the bridge.</li>
<li class="">Integrating social-service or content-pack APIs; those will follow once the bridge is proven.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="4-stakeholders-agents--impacted-surfaces">4. Stakeholders, Agents &amp; Impacted Surfaces<a href="#4-stakeholders-agents--impacted-surfaces" class="hash-link" aria-label="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" title="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" translate="no">​</a></h2>
<ul>
<li class=""><strong>Primary Stakeholders</strong>
<ul>
<li class="">Presentation Shell workstream coordinating issue #16 delivery.</li>
<li class="">Runtime Core maintainers ensuring Worker boundary safety.</li>
<li class="">Developer Experience owners who uphold build/test ergonomics.</li>
</ul>
</li>
<li class=""><strong>Agent Roles</strong>
<ul>
<li class="">Runtime Worker Implementation Agent: owns worker harness, message schemas, and diagnostics delta logic.</li>
<li class="">React Bridge Integration Agent: owns TypeScript bridge, React hooks, and UI consumption patterns.</li>
<li class="">Quality &amp; Diagnostics Agent: owns test coverage, telemetry assertions, and lint/test automation updates.</li>
</ul>
</li>
<li class=""><strong>Affected Packages/Services</strong>
<ul>
<li class=""><code>packages/shell-web/src/runtime.worker.ts</code></li>
<li class=""><code>packages/shell-web/src/modules/worker-bridge.ts</code></li>
<li class=""><code>packages/core/src/index.ts</code></li>
<li class=""><code>packages/shell-web/src/modules/App.tsx</code></li>
</ul>
</li>
<li class=""><strong>Compatibility Considerations</strong>
<ul>
<li class="">Maintain backward compatibility for command queue priorities and step stamping defined in <code>IdleEngineRuntime</code> (<code>packages/core/src/index.ts:82</code>). Honor <code>WORKER_MESSAGE_SCHEMA_VERSION</code> negotiation.</li>
<li class="">Ensure Worker bundling remains ES module compliant for Vite and future React upgrades.</li>
<li class="">Guard against API changes that could invalidate diagnostics consumers or content packs waiting on snapshot schemas.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="5-current-state">5. Current State<a href="#5-current-state" class="hash-link" aria-label="Direct link to 5. Current State" title="Direct link to 5. Current State" translate="no">​</a></h2>
<p>Issue #16 currently relies on a minimal Worker harness that exposes state snapshots and diagnostics updates but lacks formal documentation. The worker bootstrap constructs a runtime, handles messages, and emits state deltas (<code>packages/shell-web/src/runtime.worker.ts:74</code>). The React hook lazily instantiates <code>WorkerBridgeImpl</code>, subscribes to worker messages, and disposes on unmount (<code>packages/shell-web/src/modules/worker-bridge.ts:181</code>). The shell&#x27;s <code>App</code> component consumes this hook to push commands and render simple diagnostics (<code>packages/shell-web/src/modules/App.tsx:14</code>). Architecture docs confirm alignment with the runtime lifecycle but do not specify failure handling or contract versioning (<code>docs/runtime-step-lifecycle.md:19</code>). Tests cover core bridging scenarios, including gating diagnostics updates behind a subscription handshake (<code>packages/shell-web/src/runtime.worker.test.ts:186</code>), yet they do not address reconnection resilience or malformed message rejection.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="6-proposed-solution">6. Proposed Solution<a href="#6-proposed-solution" class="hash-link" aria-label="Direct link to 6. Proposed Solution" title="Direct link to 6. Proposed Solution" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="61-architecture-overview">6.1 Architecture Overview<a href="#61-architecture-overview" class="hash-link" aria-label="Direct link to 6.1 Architecture Overview" title="Direct link to 6.1 Architecture Overview" translate="no">​</a></h3>
<ul>
<li class="">
<p><strong>Narrative</strong></p>
<ul>
<li class="">Dedicated Worker hosts <code>IdleEngineRuntime</code> and orchestrates command queue execution, pushing deterministic state snapshots to the UI. The React bridge encapsulates Worker lifecycle, exposes subscription hooks, and ensures commands cross the thread boundary with consistent metadata.</li>
<li class="">Message envelopes are versioned and validated before entering the runtime queue, safeguarding the runtime from malformed UI input. Diagnostics remain opt-in to avoid unnecessary load.</li>
</ul>
</li>
<li class="">
<p><strong>Diagram</strong></p>
<p>Runtime worker ↔ React bridge message flow covering READY, COMMAND, STATE_UPDATE, and DIAGNOSTICS envelopes. Source: <code>docs/assets/diagrams/runtime-react-worker-bridge.mmd</code> (keep in sync).</p>
<div class="language-mermaid codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-mermaid codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token plain">%% Source of truth also stored at docs/assets/diagrams/runtime-react-worker-bridge.mmd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sequenceDiagram</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  autonumber</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  participant React as React Shell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  participant Bridge as WorkerBridge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  participant Worker as Runtime Worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  participant Runtime as IdleEngineRuntime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  React-&gt;&gt;Bridge: instantiate WorkerBridge &amp; awaitReady()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Bridge-&gt;&gt;Worker: create worker(module)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Worker--&gt;&gt;Bridge: READY {handshakeId}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Bridge--&gt;&gt;React: resolve awaitReady()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  React-&gt;&gt;Bridge: sendCommand(type, payload)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Note right of Bridge: Wraps payload with requestId,&lt;br/&gt;source, issuedAt (performance.now())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Bridge-&gt;&gt;Worker: COMMAND {schemaVersion, requestId, source, command}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Worker-&gt;&gt;Runtime: enqueue(command)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Worker--&gt;&gt;Bridge: STATE_UPDATE {state snapshot}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Bridge--&gt;&gt;React: onStateUpdate(state)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  React-&gt;&gt;Bridge: enableDiagnostics()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Bridge-&gt;&gt;Worker: DIAGNOSTICS_SUBSCRIBE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Worker-&gt;&gt;Runtime: enableDiagnostics()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Runtime--&gt;&gt;Worker: diagnostics delta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Worker--&gt;&gt;Bridge: DIAGNOSTICS_UPDATE {timeline}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Bridge--&gt;&gt;React: onDiagnosticsUpdate(diagnostics)</span><br></span></code></pre></div></div>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="62-detailed-design">6.2 Detailed Design<a href="#62-detailed-design" class="hash-link" aria-label="Direct link to 6.2 Detailed Design" title="Direct link to 6.2 Detailed Design" translate="no">​</a></h3>
<ul>
<li class=""><strong>Runtime Changes</strong>
<ul>
<li class="">Extend <code>initializeRuntimeWorker</code> to include an optional <code>handshakeId</code> and emit a <code>READY</code> message after registering listeners, allowing the React bridge to wait for readiness before sending commands (<code>packages/shell-web/src/runtime.worker.ts:74</code>).</li>
<li class="">Harden message validation by rejecting commands missing <code>type</code>, <code>payload</code>, or non-monotonic <code>timestamp</code>; log structured errors to aid diagnostics.</li>
<li class="">Add replay protection by tracking the last processed UI command timestamp and dropping stale commands.</li>
</ul>
</li>
<li class=""><strong>Data &amp; Schemas</strong>
<ul>
<li class="">Formalise Worker message types:<!-- -->
<ul>
<li class=""><code>COMMAND</code> (UI-&gt;Worker): <code>{type, payload, requestId, source, issuedAt}</code></li>
<li class=""><code>STATE_UPDATE</code> (Worker-&gt;UI): <code>{currentStep, events[], backPressure}</code></li>
<li class=""><code>DIAGNOSTICS_UPDATE</code> (Worker-&gt;UI): timeline delta snapshot</li>
<li class=""><code>RESTORE_SESSION</code> (UI-&gt;Worker): <code>{state?, elapsedMs?, resourceDeltas?}</code> session resume payload</li>
<li class=""><code>SESSION_RESTORED</code> (Worker-&gt;UI): acknowledgement that queueing may resume</li>
<li class=""><code>DIAGNOSTICS_SUBSCRIBE</code> / <code>DIAGNOSTICS_UNSUBSCRIBE</code></li>
<li class=""><code>READY</code>, <code>ERROR</code>, and <code>TERMINATE</code> control messages</li>
</ul>
</li>
<li class="">Maintain schema definitions in <code>packages/shell-web/src/modules/worker-bridge.ts</code> with TypeScript discriminated unions for agent reuse (<code>packages/shell-web/src/modules/worker-bridge.ts:55</code>).</li>
</ul>
</li>
<li class=""><strong>APIs &amp; Contracts</strong>
<ul>
<li class="">Expand <code>WorkerBridge</code> interface to expose <code>awaitReady()</code>, <code>restoreSession()</code>, <code>disableDiagnostics()</code>, and <code>onError</code> callbacks while keeping existing <code>sendCommand</code>, <code>onStateUpdate</code>, and diagnostics observers (<code>packages/shell-web/src/modules/worker-bridge.ts:14</code>).</li>
<li class="">Queue outbound traffic while a session restore is pending so UI code can emit user commands without racing the worker handshake.</li>
<li class="">Provide typed event emitters so React components receive strongly typed snapshots (<code>RuntimeStateSnapshot</code>) and diagnostics payloads.</li>
<li class="">Surface worker errors through the optional <code>__IDLE_ENGINE_TELEMETRY__</code> facade so hosts can forward incidents without bundling server-only dependencies.</li>
<li class="">Document contract versioning in <code>/docs</code> with change log entries referencing issue #16.</li>
</ul>
</li>
<li class=""><strong>Tooling &amp; Automation</strong>
<ul>
<li class="">Update Vitest suites to cover handshake, replay protection, diagnostics gating, and disposal semantics (<code>packages/shell-web/src/runtime.worker.test.ts:1</code>).</li>
<li class="">Add lint rule exceptions or ESLint configuration updates if Worker globals require adjustments.</li>
<li class="">Ensure <code>pnpm test --filter shell-web</code> becomes the canonical validation command for agents, aligning with doc guidance.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="63-operational-considerations">6.3 Operational Considerations<a href="#63-operational-considerations" class="hash-link" aria-label="Direct link to 6.3 Operational Considerations" title="Direct link to 6.3 Operational Considerations" translate="no">​</a></h3>
<p>Full build, rollout, and troubleshooting procedures live in the <a class="" href="/Idle-Game-Engine/runtime-worker-bridge-runbook">Runtime-&gt;React Worker Bridge Operational Runbook</a>; keep that guide updated alongside the contract changes described below.</p>
<ul>
<li class=""><strong>Deployment</strong>
<ul>
<li class="">Incorporate Worker bundle into Vite build pipeline, verifying production builds include hashed worker assets. Document <code>pnpm build --filter shell-web</code> as the release artifact generator.</li>
</ul>
</li>
<li class=""><strong>Telemetry &amp; Observability</strong>
<ul>
<li class="">Expose console warnings when commands are dropped or diagnostics are disabled by policy, guiding agents during debugging.</li>
<li class="">Forward runtime diagnostics deltas downstream without flooding logs; implement throttling if the UI main thread lags.</li>
</ul>
</li>
<li class=""><strong>Security &amp; Compliance</strong>
<ul>
<li class="">Restrict Worker context to treat all UI-originating commands as <code>CommandPriority.PLAYER</code>, preventing privilege escalation (<code>packages/shell-web/src/runtime.worker.ts:170</code>).</li>
<li class="">Ensure no PII crosses the bridge; payloads should remain gameplay data scoped to the local session. Clarify that the Worker runs in-browser only, limiting exposure.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="7-work-breakdown--delivery-plan">7. Work Breakdown &amp; Delivery Plan<a href="#7-work-breakdown--delivery-plan" class="hash-link" aria-label="Direct link to 7. Work Breakdown &amp; Delivery Plan" title="Direct link to 7. Work Breakdown &amp; Delivery Plan" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="71-issue-map">7.1 Issue Map<a href="#71-issue-map" class="hash-link" aria-label="Direct link to 7.1 Issue Map" title="Direct link to 7.1 Issue Map" translate="no">​</a></h3>
<table><thead><tr><th>Issue Title</th><th>Scope Summary</th><th>Proposed Assignee/Agent</th><th>Dependencies</th><th>Acceptance Criteria</th></tr></thead><tbody><tr><td>feat(shell-web): harden runtime worker handshake</td><td>Implement READY/ERROR control flow, command validation, replay protection</td><td>Runtime Worker Implementation Agent</td><td>Design approval (this doc)</td><td>Vitest coverage proves handshake, queue stamping, replay guard</td></tr><tr><td>feat(shell-web): expand React worker bridge API</td><td>Extend bridge with awaitReady, error surface, diagnostics toggles; update hook</td><td>React Bridge Integration Agent</td><td>Handshake issue</td><td>Bridge unit tests updated; App consumes new API without regressions</td></tr><tr><td>test(shell-web): diagnostics and lifecycle coverage</td><td>Add tests for diagnostics subscribe/unsubscribe, disposal, throttled logs</td><td>Quality &amp; Diagnostics Agent</td><td>React bridge update</td><td>Tests cover DIAGNOSTICS_SUBSCRIBE and disposal; CI green</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="72-milestones">7.2 Milestones<a href="#72-milestones" class="hash-link" aria-label="Direct link to 7.2 Milestones" title="Direct link to 7.2 Milestones" translate="no">​</a></h3>
<ul>
<li class=""><strong>Phase 1</strong>: Finalise Worker message contract and handshake, including READY/ERROR flow; target completion within three working days of design approval.</li>
<li class=""><strong>Phase 2</strong>: Update React bridge and UI integration to consume new contract; target completion two days after Phase 1, contingent on green tests.</li>
<li class=""><strong>Phase 3</strong>: Diagnostics and lifecycle hardening, including documentation updates; finalise within two days after Phase 2.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="73-coordination-notes">7.3 Coordination Notes<a href="#73-coordination-notes" class="hash-link" aria-label="Direct link to 7.3 Coordination Notes" title="Direct link to 7.3 Coordination Notes" translate="no">​</a></h3>
<ul>
<li class=""><strong>Hand-off Package</strong>: Provide agents with references to <code>packages/shell-web/src/runtime.worker.ts:74</code>, <code>packages/shell-web/src/modules/worker-bridge.ts:63</code>, and <code>docs/runtime-step-lifecycle.md:19</code>.</li>
<li class=""><strong>Communication Cadence</strong>: Daily async status ping via project board comments; escalate blockers immediately to Presentation Shell lead.</li>
<li class=""><strong>Escalation Path</strong>: Runtime Core maintainers adjudicate disputes about command queue invariants; Dev Experience ensures bundler compatibility.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="8-agent-guidance--guardrails">8. Agent Guidance &amp; Guardrails<a href="#8-agent-guidance--guardrails" class="hash-link" aria-label="Direct link to 8. Agent Guidance &amp; Guardrails" title="Direct link to 8. Agent Guidance &amp; Guardrails" translate="no">​</a></h2>
<ul>
<li class=""><strong>Context Packets</strong>
<ul>
<li class="">Load <code>docs/runtime-step-lifecycle.md:1</code> and <code>docs/implementation-plan.md:18</code> before coding.</li>
<li class="">Cache TypeScript typings from <code>packages/core</code> to align command structures.</li>
</ul>
</li>
<li class=""><strong>Prompting &amp; Constraints</strong>
<ul>
<li class="">Agents must reference issue #16 and this design doc in commit messages.</li>
<li class="">Follow Conventional Commit syntax; example: <code>feat(shell-web): implement worker READY handshake</code>.</li>
</ul>
</li>
<li class=""><strong>Safety Rails</strong>
<ul>
<li class="">Do not bypass Worker boundary by importing runtime directly into React components.</li>
<li class="">Avoid modifying <code>packages/core</code> unless explicitly approved; prefer adapter changes in shell-web.</li>
<li class="">Never disable diagnostics safeguards when writing tests; use provided toggles.</li>
</ul>
</li>
<li class=""><strong>Validation Hooks</strong>
<ul>
<li class="">Run <code>pnpm lint</code> and <code>pnpm test --filter shell-web</code> locally before completion.</li>
<li class="">For diagnostics changes, run <code>pnpm test --filter &quot;runtime.worker&quot;</code> to target integration tests.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="9-alternatives-considered">9. Alternatives Considered<a href="#9-alternatives-considered" class="hash-link" aria-label="Direct link to 9. Alternatives Considered" title="Direct link to 9. Alternatives Considered" translate="no">​</a></h2>
<ul>
<li class=""><strong>Main-thread runtime execution</strong>: Rejected because it violates determinism guarantees and blocks UI responsiveness.</li>
<li class=""><strong>Service Worker or SharedWorker</strong>: Discarded due to increased complexity and limited browser support relative to dedicated Worker simplicity for issue #16.</li>
<li class=""><strong>postMessage-based RPC library</strong>: Unnecessary; custom discriminated unions give tighter control over payload validation and reduce bundle size.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="10-testing--validation-plan">10. Testing &amp; Validation Plan<a href="#10-testing--validation-plan" class="hash-link" aria-label="Direct link to 10. Testing &amp; Validation Plan" title="Direct link to 10. Testing &amp; Validation Plan" translate="no">​</a></h2>
<ul>
<li class=""><strong>Unit / Integration</strong>
<ul>
<li class="">Extend Vitest suites for worker harness and bridge to cover handshake, replay guard, diagnostics enablement, and disposal.</li>
<li class="">Mock Worker context to assert messages emitted on error and termination.</li>
</ul>
</li>
<li class=""><strong>Performance</strong>
<ul>
<li class="">Benchmark tick loop under simulated high-frequency commands to confirm no regression beyond current <code>RAF_INTERVAL_MS</code> budget.</li>
<li class="">Validate diagnostics throttling to ensure UI thread remains responsive during stress tests.</li>
</ul>
</li>
<li class=""><strong>Tooling / A11y</strong>
<ul>
<li class="">After bridge integration, run <code>pnpm test:a11y</code> if UI surfaces change.</li>
<li class="">Confirm Vite build outputs include worker bundle without warnings.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="11-risks--mitigations">11. Risks &amp; Mitigations<a href="#11-risks--mitigations" class="hash-link" aria-label="Direct link to 11. Risks &amp; Mitigations" title="Direct link to 11. Risks &amp; Mitigations" translate="no">​</a></h2>
<ul>
<li class=""><strong>Bundler compatibility</strong>: Vite upgrades or React 19 changes could destabilise Worker imports; mitigation is to pin versions and run smoke builds per milestone.</li>
<li class=""><strong>Command drift</strong>: If runtime command contracts evolve, UI could break; mitigate by centralising TypeScript types and adding compile-time checks.</li>
<li class=""><strong>Diagnostics overload</strong>: High-frequency diagnostics may overwhelm UI; enforce throttling and optional subscription.</li>
<li class=""><strong>Resource leaks</strong>: Failure to dispose Worker on navigation could leak memory; ensure <code>useWorkerBridge</code> always calls <code>dispose()</code> and add regression tests.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="12-rollout-plan">12. Rollout Plan<a href="#12-rollout-plan" class="hash-link" aria-label="Direct link to 12. Rollout Plan" title="Direct link to 12. Rollout Plan" translate="no">​</a></h2>
<ul>
<li class=""><strong>Milestones</strong>
<ul>
<li class="">Milestone 1: Merge worker handshake updates behind feature guard.</li>
<li class="">Milestone 2: Enable new React bridge in dev builds; monitor for regressions.</li>
<li class="">Milestone 3: Promote to production build once tests and manual smoke pass.</li>
</ul>
</li>
<li class=""><strong>Migration Strategy</strong>
<ul>
<li class="">Introduce the <code>VITE_ENABLE_WORKER_BRIDGE</code> (<code>ENABLE_WORKER_BRIDGE</code>) flag so shells can fall back to the inline legacy bridge until confidence is established; leave it disabled by default and retire it after Phase 3 sign-off.</li>
<li class="">Provide migration notes for agents touching UI components.</li>
</ul>
</li>
<li class=""><strong>Communication</strong>
<ul>
<li class="">Announce bridge availability in weekly status report; include testing commands.</li>
<li class="">Update onboarding documentation to reference new bridge once rollout completes.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="13-decisions-since-draft">13. Decisions Since Draft<a href="#13-decisions-since-draft" class="hash-link" aria-label="Direct link to 13. Decisions Since Draft" title="Direct link to 13. Decisions Since Draft" translate="no">​</a></h2>
<ul>
<li class=""><strong>Telemetry routing</strong> <em>(Owner: Presentation Shell analytics lead)</em> — Worker-side errors publish through the shell analytics pipeline via the global <code>__IDLE_ENGINE_TELEMETRY__</code> facade (<code>packages/shell-web/src/modules/worker-bridge.ts:126</code>). Implementation completed in <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/267" target="_blank" rel="noopener noreferrer" class="">#267</a> installs the browser shell analytics facade (<code>packages/shell-web/src/modules/shell-analytics.ts</code>), wiring worker bridge telemetry into dashboards and exposing the <code>VITE_SHELL_ANALYTICS_ENDPOINT</code> fallback for hosts that rely on sendBeacon/fetch delivery.</li>
<li class=""><strong>Content pack messaging</strong> <em>(Owner: Content Systems integration lead)</em> — Presentation shells continue to consume pack-provided events exclusively through the <code>STATE_UPDATE.state.events</code> array; no additional message envelopes are required. We verified this against existing pack samples and worker emission logic, so downstream agents can rely on the current contract without schema changes.</li>
<li class=""><strong>Resumable session handshake</strong> <em>(Owner: Runtime Core liaison)</em> — The <code>RESTORE_SESSION</code> / <code>SESSION_RESTORED</code> sequence and <code>WorkerBridge.restoreSession()</code> helper are considered ready for rollout. Coordination with the persistence work in <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/258" target="_blank" rel="noopener noreferrer" class="">#258</a> will cover storage handoff requirements before enabling offline progression in production.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="14-follow-up-work">14. Follow-Up Work<a href="#14-follow-up-work" class="hash-link" aria-label="Direct link to 14. Follow-Up Work" title="Direct link to 14. Follow-Up Work" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="141-workershell-persistence-handoff-issue-258">14.1 Worker↔Shell Persistence Handoff (Issue #258)<a href="#141-workershell-persistence-handoff-issue-258" class="hash-link" aria-label="Direct link to 14.1 Worker↔Shell Persistence Handoff (Issue #258)" title="Direct link to 14.1 Worker↔Shell Persistence Handoff (Issue #258)" translate="no">​</a></h3>
<p><strong>Goals</strong></p>
<ul>
<li class="">Persist authoritative runtime state so the shell can restore sessions without violating determinism or the existing <code>RESTORE_SESSION</code> contract.</li>
<li class="">Support offline catch-up by capturing wall-clock metadata alongside the serialized state.</li>
<li class="">Keep persistence infrastructure reusable across shells (web, native wrappers) and tolerant of future content pack migrations.</li>
</ul>
<p><strong>Constraints</strong></p>
<ul>
<li class="">The worker must remain deterministic and cannot touch DOM-only APIs such as <code>localStorage</code>; all storage I/O runs on the shell side.</li>
<li class="">Existing validation in <code>runtime.worker.ts:200</code> expects <code>SerializedResourceState</code> payloads that pass <code>reconcileSaveAgainstDefinitions</code>; storage must never mutate those structures.</li>
<li class="">Autosave cadence cannot interfere with the simulation tick loop—snapshot requests must be explicit and queued through the bridge.</li>
</ul>
<p><strong>Storage Evaluation</strong></p>
<table><thead><tr><th>Option</th><th>Pros</th><th>Cons</th><th>Notes</th></tr></thead><tbody><tr><td>IndexedDB (Recommended)</td><td>Available in dedicated workers and windows, async, structured-clone friendly, ~50 MB quota in most browsers</td><td>Needs promise-based wrapper, requires schema/version bookkeeping</td><td>Use a single <code>idle-engine.sessions</code> database with version upgrades handled by the shell</td></tr><tr><td>Cache API</td><td>Streams suited to HTTP responses, versioned caches</td><td>Cannot store arbitrary structured data without manual serialization, unclear worker support for our use case</td><td>Rejected; better for asset caching than game state</td></tr><tr><td>localStorage</td><td>Simple API</td><td>Not accessible inside workers, synchronous (janks UI), ~5 MB quota</td><td>Rejected; fails worker requirement and risks deadlocks</td></tr></tbody></table>
<p><strong>Chosen Strategy: Shell-managed IndexedDB</strong></p>
<ul>
<li class="">Introduce a <code>SessionPersistenceAdapter</code> in the React shell that owns all IndexedDB access. The worker exposes a new <code>SESSION_SNAPSHOT</code> outbound message and <code>REQUEST_SESSION_SNAPSHOT</code> inbound command so snapshot requests travel over the existing bridge.</li>
<li class="">Persisted entries store raw <code>SerializedResourceState</code>, offline metadata, and runtime/content digests. The worker never performs I/O; it only marshals deterministic data.</li>
<li class="">Provide a thin abstraction (<code>PersistenceDriver</code>) so native shells can swap in filesystem-backed implementations while reusing message flow and schema.</li>
</ul>
<p><strong>Message Flow</strong></p>
<p><strong>Save / Autosave</strong></p>
<ol>
<li class="">Shell calls <code>WorkerBridge.requestSessionSnapshot(reason)</code> (new API) when autosave timers, user actions, or shutdown events fire. The bridge enqueues a <code>REQUEST_SESSION_SNAPSHOT</code> message after <code>awaitReady()</code> and outside <code>restoreSession</code> windows.</li>
<li class="">Worker captures deterministic data: <code>SerializedResourceState</code> via <code>resourceState.exportForSave()</code>, pending commands via <code>commandQueue.exportForSave()</code>, current tick step, and monotonic clock reference. It responds with <code>SESSION_SNAPSHOT { requestId, capturedAt, state, commandQueue, step, monotonicNow }</code>.</li>
<li class="">Shell adapter normalises metadata (e.g., converts <code>capturedAt</code> to UTC, clamps offline caps) and writes the entry to the <code>sessions</code> object store within a single IndexedDB transaction. On error it surfaces telemetry through the existing <code>WorkerBridge</code> error channel.</li>
</ol>
<p><strong>Restore</strong></p>
<ol>
<li class="">Shell reads the latest slot at startup (or when the user selects a save) and validates it against current content definitions using <code>reconcileSaveAgainstDefinitions</code>.</li>
<li class="">Shell computes offline elapsed time as <code>min(now - capturedAt, OFFLINE_CAP_MS)</code> and derives optional <code>resourceDeltas</code> if migrations supply them.</li>
<li class="">Shell calls <code>WorkerBridge.restoreSession({ state, commandQueue, elapsedMs, resourceDeltas })</code>. The worker follows the existing restore path, emitting either <code>SESSION_RESTORED</code> or <code>ERROR { code: &#x27;RESTORE_FAILED&#x27; }</code>.</li>
<li class="">On success the shell resumes normal command flow; on failure it records telemetry, surfaces UI prompts, and may retry after running migrations.</li>
</ol>
<p><strong>Stored Payload (v1)</strong></p>
<ul>
<li class=""><code>schemaVersion</code>: number (start at <code>1</code> to decouple from <code>WORKER_MESSAGE_SCHEMA_VERSION</code>).</li>
<li class=""><code>slotId</code>: string (<code>&quot;default&quot;</code> initially; enables future multi-slot UI).</li>
<li class=""><code>capturedAt</code>: ISO timestamp.</li>
<li class=""><code>workerStep</code>: number (runtime <code>currentStep</code> for diagnostics).</li>
<li class=""><code>monotonicMs</code>: number captured from worker to help derive elapsed time safely.</li>
<li class=""><code>state</code>: <code>SerializedResourceState</code> (immutable snapshot).</li>
<li class=""><code>commandQueue</code>: <code>SerializedCommandQueue</code> (optional pending commands captured at snapshot time).</li>
<li class=""><code>runtimeVersion</code>: semver string of <code>@idle-engine/core</code>.</li>
<li class=""><code>contentDigest</code>: <code>ResourceDefinitionDigest</code> for compatibility checks.</li>
<li class=""><code>flags</code>: <code>{ pendingMigration?: boolean; abortedRestore?: boolean }</code>.</li>
</ul>
<p><strong>Migration Considerations</strong></p>
<ul>
<li class="">Content packs publish digests; the adapter compares stored <code>contentDigest</code> against the live pack before restore. When digests diverge but a pack-supplied migration exists, the adapter runs it prior to calling <code>restoreSession</code>.</li>
<li class="">Schema upgrades use IndexedDB version migrations. Each bump records a deterministic transform function so older saves can be rewritten in place without loading them into the worker.</li>
<li class="">Record <code>runtimeVersion</code> and <code>persistenceSchemaVersion</code> to gate restores when the runtime introduces breaking changes. Future workers can advertise supported versions via <code>READY { supportedPersistence }</code>.</li>
<li class="">For detailed guidance on authoring migrations, see <a class="" href="/Idle-Game-Engine/persistence-migration-guide">Persistence Migration Guide</a>.</li>
</ul>
<p><strong>Risks &amp; Mitigations</strong></p>
<ul>
<li class=""><em>Quota exhaustion</em>: add size guards (e.g., trim history to <code>MAX_SNAPSHOTS_PER_SLOT</code>) and surface telemetry when writes fail. Provide user-facing guidance to clear space.</li>
<li class=""><em>Cross-tab conflicts</em>: namespace keys by <code>profileId</code> and use IndexedDB transactions with <code>versionchange</code> listeners to detect concurrent schema upgrades. Future enhancement: advisory locking via BroadcastChannel.</li>
<li class=""><em>Snapshot cost</em>: snapshot export is synchronous in the worker; autosave cadence must respect frame budgets. Default schedule is every 60 s or on significant events; shells throttle additional requests during high back-pressure.</li>
<li class=""><em>Data corruption</em>: persist a checksum (e.g., SHA-256 over the serialized payload) and verify before restore; fallback to previous snapshot when verification fails.</li>
</ul>
<p><strong>Testing &amp; Telemetry</strong></p>
<ul>
<li class="">Add Vitest suites with mocked <code>IDBFactory</code> to cover happy-path save/restore, schema upgrades, and corruption fallbacks.</li>
<li class="">Integration tests should spin up the worker harness, request a snapshot, round-trip through an in-memory IndexedDB polyfill, and assert the worker accepts the restored session.</li>
<li class="">Extend telemetry to record <code>PersistenceSaveFailed</code>, <code>PersistenceRestoreFailed</code>, and <code>PersistenceMigrationApplied</code> events routed through <code>__IDLE_ENGINE_TELEMETRY__</code>.</li>
</ul>
<p><strong>Follow-Up Tasks</strong></p>
<ol>
<li class="">Extend <code>@idle-engine/runtime-bridge-contracts</code> with <code>REQUEST_SESSION_SNAPSHOT</code> / <code>SESSION_SNAPSHOT</code> message definitions and update runtime.worker harness.</li>
<li class="">Implement <code>SessionPersistenceAdapter</code> and autosave controller inside <code>packages/shell-web</code>, including IndexedDB schema management (<code>sessions</code> store keyed by slot/profile).</li>
<li class="">Ship shell UI affordances for manual save/load, error reporting, and migration prompts (flagged behind dev toggle until persistence stabilises).</li>
<li class=""><del>Document migration authoring guidelines for content pack maintainers alongside updated CLI scaffolding.</del> <strong>Completed</strong>: See <a class="" href="/Idle-Game-Engine/persistence-migration-guide">Persistence Migration Guide</a> (Issue <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/273" target="_blank" rel="noopener noreferrer" class="">#273</a>).</li>
</ol>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="1411-troubleshooting--operations">14.1.1 Troubleshooting &amp; Operations<a href="#1411-troubleshooting--operations" class="hash-link" aria-label="Direct link to 14.1.1 Troubleshooting &amp; Operations" title="Direct link to 14.1.1 Troubleshooting &amp; Operations" translate="no">​</a></h4>
<ul>
<li class="">
<p>Resetting saves (Web):</p>
<ul>
<li class="">Open DevTools → Application → IndexedDB.</li>
<li class="">Expand <code>idle-engine.sessions</code> → <code>sessions</code> and delete records, or delete the entire database.</li>
<li class="">The shell UI also exposes “Clear Data” in the Persistence panel which calls <code>SessionPersistenceAdapter.deleteSlot(...)</code> for the active slot.</li>
</ul>
</li>
<li class="">
<p>Inspecting IndexedDB (Web):</p>
<ul>
<li class="">Keys are <code>{slotId}:{timestamp}</code>. Values include <code>schemaVersion</code>, <code>capturedAt</code>, <code>workerStep</code>, <code>contentDigest</code>, and a checksum.</li>
<li class="">Corrupted snapshots (checksum mismatch) are skipped automatically; the adapter falls back to the next newest snapshot and emits telemetry.</li>
</ul>
</li>
<li class="">
<p>Common errors and remedies:</p>
<ul>
<li class=""><code>DB_OPEN_FAILED</code>: IndexedDB unavailable/blocked. Avoid private mode and ensure storage isn’t disabled.</li>
<li class=""><code>DB_UPGRADE_BLOCKED</code>: Another tab holds the DB during upgrade. Close other tabs or refresh.</li>
<li class=""><code>SNAPSHOT_FAILED</code>: Worker export failed; snapshot requests are blocked during restoration. Retry after <code>SESSION_RESTORED</code>.</li>
<li class=""><code>SNAPSHOT_VALIDATION_FAILED</code>: All snapshots failed checksum verification. Delete the DB and start fresh.</li>
<li class=""><code>RESTORE_FAILED</code>: Worker rejected restore payload. Check <code>flags.pendingMigration</code>, digests, and migration availability.</li>
</ul>
</li>
<li class="">
<p>CI determinism:</p>
<ul>
<li class="">Use <code>fake-indexeddb</code> to stub IndexedDB in Vitest. See <code>packages/shell-web/src/modules/session-persistence-integration.test.ts</code> for worker ↔ bridge ↔ persistence coverage.</li>
</ul>
</li>
<li class="">
<p>Extending for native shells:</p>
<ul>
<li class="">Swap <code>SessionPersistenceAdapter</code> with a platform adapter (filesystem/SQLite/MMKV) that preserves the <code>StoredSessionSnapshot</code> contract and checksum semantics, then reuse the same wiring in the shell integration.</li>
</ul>
</li>
</ul>
<p><strong>Open Questions</strong></p>
<ul>
<li class="">Do we need encryption or obfuscation for competitive modes? (Out of scope for v1, document in security backlog.)</li>
<li class="">Should command replay logs be persisted alongside resource snapshots for richer debugging? (Candidate for follow-up issue once save slots land.)</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="142-remaining-items">14.2 Remaining Items<a href="#142-remaining-items" class="hash-link" aria-label="Direct link to 14.2 Remaining Items" title="Direct link to 14.2 Remaining Items" translate="no">​</a></h3>
<ul>
<li class="">Integrate social-service command hooks after bridge stabilises. Owner: Social Services Lead.</li>
<li class="">Produce developer tutorial documenting how to extend the bridge for custom commands. Owner: React Bridge Integration Agent (post-delivery).</li>
<li class="">Implement shell analytics sink for worker bridge telemetry routing. Owner: Presentation Shell analytics lead. <strong>Status</strong>: Completed via <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/267" target="_blank" rel="noopener noreferrer" class="">#267</a>; configure hosts with <code>VITE_SHELL_ANALYTICS_ENDPOINT</code> (or <code>SHELL_ANALYTICS_ENDPOINT</code>) when routing through custom collectors.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="15-references">15. References<a href="#15-references" class="hash-link" aria-label="Direct link to 15. References" title="Direct link to 15. References" translate="no">​</a></h2>
<ul>
<li class=""><code>docs/implementation-plan.md:18</code></li>
<li class=""><code>docs/runtime-step-lifecycle.md:19</code></li>
<li class=""><code>packages/shell-web/src/runtime.worker.ts:74</code></li>
<li class=""><code>packages/shell-web/src/modules/worker-bridge.ts:63</code></li>
<li class=""><code>packages/shell-web/src/modules/App.tsx:14</code></li>
<li class=""><code>packages/core/src/index.ts:82</code></li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-a---glossary">Appendix A - Glossary<a href="#appendix-a---glossary" class="hash-link" aria-label="Direct link to Appendix A - Glossary" title="Direct link to Appendix A - Glossary" translate="no">​</a></h2>
<ul>
<li class=""><strong>Worker bridge</strong>: The communication layer transporting commands, state, and diagnostics between the IdleEngine runtime Worker and the React shell for issue #16.</li>
<li class=""><strong>Diagnostics timeline</strong>: Runtime-produced stream of performance entries sampling slow ticks and system budgets, accessible via the worker bridge.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-b---change-log">Appendix B - Change Log<a href="#appendix-b---change-log" class="hash-link" aria-label="Direct link to Appendix B - Change Log" title="Direct link to Appendix B - Change Log" translate="no">​</a></h2>
<ul>
<li class="">2025-11-11 (Fixes #379): Promote status to Approved, align spec with live implementation including READY/ERROR handshake and session snapshot protocol, and extract the message schema into <code>@idle-engine/runtime-bridge-contracts</code>. Updated Mermaid diagram (<code>docs/assets/diagrams/runtime-react-worker-bridge.mmd</code>) and linked consumers to the schema package.
| Date       | Author | Change Summary |
|------------|--------|----------------|
| 2025-10-27 | Idle Engine Design Authoring Agent (AI) | Initial draft for issue #16 bridge design |
| 2025-10-28 | Codex Agent (AI) | Added worker↔shell persistence handoff mini-spec (Fixes #258) |</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="diagnostics-overlay-and-headless-simulation-issue-383">Diagnostics Overlay and Headless Simulation (Issue #383)<a href="#diagnostics-overlay-and-headless-simulation-issue-383" class="hash-link" aria-label="Direct link to Diagnostics Overlay and Headless Simulation (Issue #383)" title="Direct link to Diagnostics Overlay and Headless Simulation (Issue #383)" translate="no">​</a></h2>
<p>This increment adds a dev-facing diagnostics overlay and a headless runtime simulator that share the same data shapes to keep consumption consistent across surfaces.</p>
<ul>
<li class="">UI overlay subscribes to diagnostics only when visible and throttles updates for responsiveness. See <code>packages/shell-web/src/modules/DiagnosticsPanel.tsx</code>.</li>
<li class="">Shared helpers for summarizing and evaluating diagnostics live in <code>@idle-engine/core</code> at <code>src/diagnostics/format.ts</code> and are exported via the package index.</li>
<li class="">A headless CLI (<code>pnpm core:tick-sim</code>) advances the runtime for N ticks and prints the diagnostics JSON (single-line, no trailing text), with optional failure on configured thresholds.
These align with the bridge design: opt-in subscriptions, consistent schema (<code>DiagnosticTimelineResult</code>), and no baseline overhead when diagnostics are disabled.</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_QKxP"><a href="https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/runtime-react-worker-bridge-design.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_wOWh" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_Basj"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_AUZ0 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#document-control" class="table-of-contents__link toc-highlight">Document Control</a></li><li><a href="#1-summary" class="table-of-contents__link toc-highlight">1. Summary</a></li><li><a href="#2-context--problem-statement" class="table-of-contents__link toc-highlight">2. Context &amp; Problem Statement</a></li><li><a href="#3-goals--non-goals" class="table-of-contents__link toc-highlight">3. Goals &amp; Non-Goals</a></li><li><a href="#4-stakeholders-agents--impacted-surfaces" class="table-of-contents__link toc-highlight">4. Stakeholders, Agents &amp; Impacted Surfaces</a></li><li><a href="#5-current-state" class="table-of-contents__link toc-highlight">5. Current State</a></li><li><a href="#6-proposed-solution" class="table-of-contents__link toc-highlight">6. Proposed Solution</a><ul><li><a href="#61-architecture-overview" class="table-of-contents__link toc-highlight">6.1 Architecture Overview</a></li><li><a href="#62-detailed-design" class="table-of-contents__link toc-highlight">6.2 Detailed Design</a></li><li><a href="#63-operational-considerations" class="table-of-contents__link toc-highlight">6.3 Operational Considerations</a></li></ul></li><li><a href="#7-work-breakdown--delivery-plan" class="table-of-contents__link toc-highlight">7. Work Breakdown &amp; Delivery Plan</a><ul><li><a href="#71-issue-map" class="table-of-contents__link toc-highlight">7.1 Issue Map</a></li><li><a href="#72-milestones" class="table-of-contents__link toc-highlight">7.2 Milestones</a></li><li><a href="#73-coordination-notes" class="table-of-contents__link toc-highlight">7.3 Coordination Notes</a></li></ul></li><li><a href="#8-agent-guidance--guardrails" class="table-of-contents__link toc-highlight">8. Agent Guidance &amp; Guardrails</a></li><li><a href="#9-alternatives-considered" class="table-of-contents__link toc-highlight">9. Alternatives Considered</a></li><li><a href="#10-testing--validation-plan" class="table-of-contents__link toc-highlight">10. Testing &amp; Validation Plan</a></li><li><a href="#11-risks--mitigations" class="table-of-contents__link toc-highlight">11. Risks &amp; Mitigations</a></li><li><a href="#12-rollout-plan" class="table-of-contents__link toc-highlight">12. Rollout Plan</a></li><li><a href="#13-decisions-since-draft" class="table-of-contents__link toc-highlight">13. Decisions Since Draft</a></li><li><a href="#14-follow-up-work" class="table-of-contents__link toc-highlight">14. Follow-Up Work</a><ul><li><a href="#141-workershell-persistence-handoff-issue-258" class="table-of-contents__link toc-highlight">14.1 Worker↔Shell Persistence Handoff (Issue #258)</a></li><li><a href="#142-remaining-items" class="table-of-contents__link toc-highlight">14.2 Remaining Items</a></li></ul></li><li><a href="#15-references" class="table-of-contents__link toc-highlight">15. References</a></li><li><a href="#appendix-a---glossary" class="table-of-contents__link toc-highlight">Appendix A - Glossary</a></li><li><a href="#appendix-b---change-log" class="table-of-contents__link toc-highlight">Appendix B - Change Log</a></li><li><a href="#diagnostics-overlay-and-headless-simulation-issue-383" class="table-of-contents__link toc-highlight">Diagnostics Overlay and Headless Simulation (Issue #383)</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/contributor-handbook">Contributor Handbook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Idle Engine.</div></div></div></footer></div>
</body>
</html>