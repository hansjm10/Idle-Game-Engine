<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-shell-state-provider-readiness-design-issue-394" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Deterministic Shell State Readiness Contract for ShellStateProvider | Idle Engine Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hansjm10.github.io/Idle-Game-Engine/shell-state-provider-readiness-design-issue-394"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Deterministic Shell State Readiness Contract for ShellStateProvider | Idle Engine Docs"><meta data-rh="true" name="description" content="Use this document to define and implement a deterministic async boundary for Shell state initialisation and telemetry in the web shell, replacing the historical flushMicrotasks-based workaround in ShellStateProvider tests (GitHub issue #394)."><meta data-rh="true" property="og:description" content="Use this document to define and implement a deterministic async boundary for Shell state initialisation and telemetry in the web shell, replacing the historical flushMicrotasks-based workaround in ShellStateProvider tests (GitHub issue #394)."><link data-rh="true" rel="icon" href="/Idle-Game-Engine/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hansjm10.github.io/Idle-Game-Engine/shell-state-provider-readiness-design-issue-394"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/shell-state-provider-readiness-design-issue-394" hreflang="en"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/shell-state-provider-readiness-design-issue-394" hreflang="x-default"><link rel="stylesheet" href="/Idle-Game-Engine/assets/css/styles.ddf7989c.css">
<script src="/Idle-Game-Engine/assets/js/runtime~main.bf1eddb7.js" defer="defer"></script>
<script src="/Idle-Game-Engine/assets/js/main.131b727c.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Idle-Game-Engine/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_li4T" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Idle-Game-Engine/"><div class="navbar__logo"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--light_vaEm"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--dark_axH8"></div><b class="navbar__title text--truncate">Idle Engine</b></a><a class="navbar__item navbar__link" href="/Idle-Game-Engine/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle__Exw colorModeToggle_Lslw"><button class="clean-btn toggleButton_AMBK toggleButtonDisabled_p4Bd" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 lightToggleIcon_p2sk"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 darkToggleIcon_B2qX"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 systemToggleIcon_PWgn"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_RKai"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_nqaE"><div class="docsWrapper_CSLE"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sOWX" type="button"></button><div class="docRoot_qxtV"><main class="docMainContainer_tfRv docMainContainerEnhanced_qAvX"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_hyci"><div class="docItemContainer_tcAC"><article><div class="tocCollapsible_WMbj theme-doc-toc-mobile tocMobile_wI3e"><button type="button" class="clean-btn tocCollapsibleButton_rjEa">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Deterministic Shell State Readiness Contract for ShellStateProvider</h1></header>
<p>Use this document to define and implement a deterministic async boundary for Shell state initialisation and telemetry in the web shell, replacing the historical <code>flushMicrotasks</code>-based workaround in <code>ShellStateProvider</code> tests (GitHub issue #394).</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="document-control">Document Control<a href="#document-control" class="hash-link" aria-label="Direct link to Document Control" title="Direct link to Document Control" translate="no">​</a></h2>
<ul>
<li class=""><strong>Title</strong>: Introduce deterministic Shell state readiness contract for ShellStateProvider</li>
<li class=""><strong>Authors</strong>: Idle Engine Design-Authoring Agent (Shell Web)</li>
<li class=""><strong>Reviewers</strong>: Shell Web Maintainer(s); Runtime/Bridge Maintainer(s)</li>
<li class=""><strong>Status</strong>: Implemented</li>
<li class=""><strong>Last Updated</strong>: 2025-11-16</li>
<li class=""><strong>Related Issues</strong>: <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/394" target="_blank" rel="noopener noreferrer" class="">#394</a></li>
<li class=""><strong>Execution Mode</strong>: AI-led</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="1-summary">1. Summary<a href="#1-summary" class="hash-link" aria-label="Direct link to 1. Summary" title="Direct link to 1. Summary" translate="no">​</a></h2>
<p>This design defines a deterministic Shell state readiness contract for <code>ShellStateProvider</code> in <code>shell-web</code> and replaces the brittle <code>flushMicrotasks</code> test helper with an explicit, documented async boundary. Historically, Shell tests relied on chained microtasks and <code>setTimeout(0)</code> to “hope” the provider had completed its initial async work; this resulted in non-obvious coupling to the event loop and potential flakiness. The implemented solution introduces a canonical readiness condition, exposed via Shell state and a dedicated test helper, so tests (and future automation) can await <code>ShellStateProvider</code> initialisation and telemetry wiring without relying on event-loop timing. The change is scoped to <code>shell-web</code> and preserves existing progression and telemetry behaviour while enabling AI-led agents to update tests and implementation safely.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="2-context--problem-statement">2. Context &amp; Problem Statement<a href="#2-context--problem-statement" class="hash-link" aria-label="Direct link to 2. Context &amp; Problem Statement" title="Direct link to 2. Context &amp; Problem Statement" translate="no">​</a></h2>
<ul>
<li class="">
<p><strong>Background</strong></p>
<ul>
<li class=""><code>ShellStateProvider</code> wraps the runtime worker bridge and exposes Shell state, progression, diagnostics, and social APIs to the web shell UI.<!-- -->
<ul>
<li class="">Provider implementation: <code>packages/shell-web/src/modules/ShellStateProvider.tsx</code> (e.g., readiness/restore effects at <code>:308</code> and <code>:448</code>).</li>
<li class="">Shell state reducer: <code>packages/shell-web/src/modules/shell-state-store.ts:30</code>–<code>:189</code>.</li>
</ul>
</li>
<li class="">The provider already:<!-- -->
<ul>
<li class="">Awaits <code>bridge.awaitReady()</code> and dispatches a <code>bridge-ready</code> action (<code>ShellStateProvider.tsx:308</code>–<code>:329</code>, <code>shell-state-store.tsx:149</code>–<code>:163</code>).</li>
<li class="">Orchestrates restore via <code>bridge.awaitReady()</code> followed by <code>restoreSession</code>, with telemetry on failure (<code>ShellStateProvider.tsx:448</code>–<code>:486</code>).</li>
</ul>
</li>
<li class="">Prior to PR #396, tests for Shell state and telemetry defined local <code>flushMicrotasks</code> helpers that relied on multiple microtask and macrotask hops before making assertions about progression APIs and telemetry events in the Shell environment:<!-- -->
<ul>
<li class=""><code>packages/shell-web/src/modules/ShellStateProvider.test.tsx</code>.</li>
<li class=""><code>packages/shell-web/src/modules/ShellStateProvider.telemetry.test.tsx</code>.</li>
</ul>
</li>
<li class="">Those helpers have since been removed in favour of an explicit readiness helper and targeted <code>waitFor</code>-based assertions.</li>
</ul>
</li>
<li class="">
<p><strong>Problem</strong></p>
<ul>
<li class="">Tests have no explicit, semantic contract for “Shell state is ready”; they instead depend on:<!-- -->
<ul>
<li class="">Two <code>await Promise.resolve()</code> calls plus <code>setTimeout(0)</code> to flush effects and timers.</li>
<li class="">Implicit coupling to the timing of React effects and the worker bridge’s internal scheduling.</li>
</ul>
</li>
<li class="">This leads to:<!-- -->
<ul>
<li class="">Fragile tests that may break when React’s scheduling, bridge behaviour, or effect structure changes, even if user-facing behaviour is unchanged.</li>
<li class="">Inability for AI agents to reason about the readiness boundary in a first-class way; they must treat <code>flushMicrotasks</code> as a magic incantation.</li>
<li class="">No reusable or documented mechanism for other Shell tests to await readiness.</li>
</ul>
</li>
<li class="">The absence of a deterministic async boundary contradicts the goal of a deterministic, simulation-driven engine and makes it harder to reason about telemetry failures (e.g., <code>ShellStateProviderAwaitReadyFailed</code>, <code>ShellStateProviderRestoreEffectFailed</code>).</li>
</ul>
</li>
<li class="">
<p><strong>Forces</strong></p>
<ul>
<li class=""><strong>Determinism</strong>
<ul>
<li class="">Test runs must remain deterministic and not rely on arbitrary timing delays.</li>
<li class="">Readiness should be described in terms of state/contract, not discrete microtasks.</li>
</ul>
</li>
<li class=""><strong>Compatibility</strong>
<ul>
<li class="">The current UI contract (e.g., loading behaviour based on <code>bridge.isReady</code> and <code>lastUpdateAt</code>) must be preserved:<!-- -->
<ul>
<li class=""><code>ResourceDashboard</code>: <code>packages/shell-web/src/modules/ResourceDashboard.tsx:242</code>.</li>
<li class=""><code>GeneratorPanel</code>: <code>packages/shell-web/src/modules/GeneratorPanel.tsx:124</code>.</li>
</ul>
</li>
</ul>
</li>
<li class=""><strong>React &amp; StrictMode</strong>
<ul>
<li class=""><code>ShellStateProvider</code> is already written to be StrictMode-safe (e.g., <code>lastAwaitedBridgeRef</code>, payload/bridge tracking).</li>
<li class="">Any new readiness handling must avoid double-dispatch bugs and work under StrictMode double-mount.</li>
</ul>
</li>
<li class=""><strong>Scope &amp; Velocity</strong>
<ul>
<li class="">The primary initiative is to support GitHub issue #394: deterministic Shell state readiness and removal of <code>flushMicrotasks</code>.</li>
<li class="">The design should be implementable by AI-led agents with minimal human intervention and clear guardrails.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="3-goals--non-goals">3. Goals &amp; Non-Goals<a href="#3-goals--non-goals" class="hash-link" aria-label="Direct link to 3. Goals &amp; Non-Goals" title="Direct link to 3. Goals &amp; Non-Goals" translate="no">​</a></h2>
<ul>
<li class="">
<p><strong>Goals</strong></p>
<ol>
<li class="">Define a clear, documented readiness contract for <code>ShellStateProvider</code> initialisation (“Shell state readiness contract for ShellStateProvider”).</li>
<li class="">Provide a deterministic, awaitable test helper (or helpers) that encode this contract without reliance on microtask/macrotask flushing.</li>
<li class="">Migrate <code>ShellStateProvider</code> and telemetry tests to the new contract, fully removing inline <code>flushMicrotasks</code> helpers.</li>
<li class="">Maintain existing Shell progression and telemetry behaviour, including error telemetry for <code>awaitReady</code> and restore failures.</li>
<li class="">Enable AI-led agents to safely extend the readiness contract to new tests or Shell surfaces using consistent patterns.</li>
</ol>
</li>
<li class="">
<p><strong>Non-Goals</strong></p>
<ul>
<li class="">Redesign the underlying worker bridge protocol or <code>@idle-engine/core</code> runtime.</li>
<li class="">Change production loading UX, including how <code>ResourceDashboard</code> and <code>GeneratorPanel</code> compute <code>isLoading</code>.</li>
<li class="">Generalise readiness semantics to all subsystems (e.g., social backend, content loading) beyond what is necessary for Shell state initialisation and telemetry.</li>
<li class="">Introduce cross-package synchronization primitives outside <code>shell-web</code> for this initiative.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="4-stakeholders-agents--impacted-surfaces">4. Stakeholders, Agents &amp; Impacted Surfaces<a href="#4-stakeholders-agents--impacted-surfaces" class="hash-link" aria-label="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" title="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" translate="no">​</a></h2>
<ul>
<li class="">
<p><strong>Primary Stakeholders</strong></p>
<ul>
<li class="">Shell Web maintainers (owners of <code>packages/shell-web</code>).</li>
<li class="">Runtime/Bridge maintainers (owners of <code>worker-bridge</code> integration).</li>
<li class="">Testing &amp; CI maintainers (owners of <code>@idle-engine/config-vitest</code> and test flakiness triage).</li>
</ul>
</li>
<li class="">
<p><strong>Agent Roles</strong></p>
<ul>
<li class=""><strong>Design-Authoring Agent (this document)</strong>
<ul>
<li class="">Produces and maintains this design document.</li>
<li class="">Ensures alignment with existing code and testing patterns.</li>
</ul>
</li>
<li class=""><strong>Shell-Web Implementation Agent</strong>
<ul>
<li class="">Implements readiness helpers and any necessary provider changes in <code>packages/shell-web</code>.</li>
<li class="">Refactors tests to the new pattern.</li>
</ul>
</li>
<li class=""><strong>Test &amp; Tooling Agent</strong>
<ul>
<li class="">Validates test stability post-change.</li>
<li class="">Adjusts any shared test utilities or Vitest configuration if needed.</li>
</ul>
</li>
<li class=""><strong>Review &amp; Governance Agent</strong>
<ul>
<li class="">Monitors adherence to agent guardrails and coding standards.</li>
<li class="">Ensures changes are linked to <code>Fixes #394</code> and documented.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Affected Packages/Services</strong></p>
<ul>
<li class=""><code>packages/shell-web</code>
<ul>
<li class=""><code>src/modules/ShellStateProvider.tsx:308</code>–<code>:339</code>, <code>:448</code>–<code>:486</code>.</li>
<li class=""><code>src/modules/shell-state-store.ts:30</code>–<code>:189</code>.</li>
<li class=""><code>src/modules/ShellStateProvider.test.tsx:80</code>–<code>:220</code>, <code>:364</code>–<code>:399</code>.</li>
<li class=""><code>src/modules/ShellStateProvider.telemetry.test.tsx:575</code>–<code>:638</code>.</li>
</ul>
</li>
<li class="">No direct changes expected in <code>packages/core</code> or backend services for this initiative.</li>
</ul>
</li>
<li class="">
<p><strong>Compatibility Considerations</strong></p>
<ul>
<li class="">The readiness contract should:<!-- -->
<ul>
<li class="">Be backwards compatible in production: UI components should continue to rely on <code>bridge.isReady</code> and <code>lastUpdateAt</code> semantics.</li>
<li class="">Avoid breaking <code>ShellBridgeApi</code> consumers (e.g., <code>useShellBridge</code> usage patterns).</li>
</ul>
</li>
<li class="">Any new test-only exports must not be inadvertently used in production code.</li>
<li class="">The contract should be robust to future changes in <code>ShellStateProvider</code> internals (e.g., additional effects).</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="5-current-state">5. Current State<a href="#5-current-state" class="hash-link" aria-label="Direct link to 5. Current State" title="Direct link to 5. Current State" translate="no">​</a></h2>
<ul>
<li class="">
<p><strong>Provider &amp; State</strong></p>
<ul>
<li class=""><code>ShellStateProvider</code>:<!-- -->
<ul>
<li class="">Creates Shell state via <code>createInitialShellState</code> and <code>createShellStateReducer</code> (<code>ShellStateProvider.tsx:40</code>–<code>:55</code>, <code>shell-state-store.ts:64</code>–<code>:96</code>).</li>
<li class="">Tracks bridge readiness via a <code>useEffect</code> that calls <code>bridge.awaitReady()</code> and dispatches a <code>bridge-ready</code> action (<code>ShellStateProvider.tsx:308</code>–<code>:329</code>).</li>
<li class="">Orchestrates restore when <code>restorePayload</code> or the bridge changes:<!-- -->
<ul>
<li class="">Awaits <code>bridge.awaitReady()</code> and then <code>restoreSession(restorePayload)</code>.</li>
<li class="">Emits telemetry on failure: <code>ShellStateProviderRestoreEffectFailed</code> (<code>ShellStateProvider.tsx:448</code>–<code>:486</code>).</li>
</ul>
</li>
</ul>
</li>
<li class=""><code>ShellState</code>:<!-- -->
<ul>
<li class="">Includes <code>bridge.isReady</code>, <code>bridge.isRestoring</code>, and <code>runtime.lastSnapshot</code> (<code>shell-state-store.ts:103</code>–<code>:131</code>).</li>
<li class="">Sets <code>isReady: true</code> on <code>bridge-ready</code> (<code>shell-state-store.ts:149</code>–<code>:163</code>).</li>
<li class="">Uses <code>restore-started</code>/<code>restore-complete</code> to track restore status (<code>shell-state-store.ts:177</code>–<code>:201</code>).</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>UI Consumption</strong></p>
<ul>
<li class=""><code>ResourceDashboard</code> and <code>GeneratorPanel</code> derive loading state from Shell bridge state:<!-- -->
<ul>
<li class=""><code>isLoading = !bridge.isReady || bridge.lastUpdateAt === null</code> (<code>ResourceDashboard.tsx:242</code>, <code>GeneratorPanel.tsx:124</code>).</li>
</ul>
</li>
<li class="">This implies an implicit contract: the Shell is “ready” for UI when <code>bridge.isReady === true</code> and at least one state update has occurred (<code>lastUpdateAt !== null</code>), though tests currently do not wait on this combination semantically.</li>
</ul>
</li>
<li class="">
<p><strong>Test Behaviour</strong></p>
<ul>
<li class=""><code>ShellStateProvider.test.tsx</code>:<!-- -->
<ul>
<li class="">Defines an inline <code>async function flushMicrotasks()</code> that awaits two microtasks plus a <code>setTimeout(0)</code> before assertions (<code>ShellStateProvider.test.tsx:80</code>–<code>:99</code>).</li>
<li class="">Uses <code>flushMicrotasks</code> across multiple test cases to wait for:<!-- -->
<ul>
<li class=""><code>useShellProgression</code> to return a non-null API.</li>
<li class="">Restore effects to fire when bridge or payload changes.</li>
<li class="">State update handlers to be registered (<code>ShellStateProvider.test.tsx:191</code>–<code>:200</code>).</li>
</ul>
</li>
</ul>
</li>
<li class=""><code>ShellStateProvider.telemetry.test.tsx</code>:<!-- -->
<ul>
<li class="">Defines a similar <code>flushMicrotasks</code> helper (<code>ShellStateProvider.telemetry.test.tsx:587</code>–<code>:593</code>).</li>
<li class="">Relies on it to:<!-- -->
<ul>
<li class="">Allow restore effects to fail and be reported via telemetry (<code>ShellStateProvider.telemetry.test.tsx:192</code>–<code>:212</code>).</li>
<li class="">Allow <code>awaitReady</code> failures to be reported (<code>ShellStateProvider.telemetry.test.tsx:208</code>–<code>:216</code>).</li>
<li class="">Ensure bridge error handling and telemetry are wired before unmount.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Gaps</strong></p>
<ul>
<li class="">No explicit “Shell state readiness contract for ShellStateProvider” is defined in code or docs.</li>
<li class="">Tests depend on the incidental timing of React effects and worker bridge behaviour via <code>flushMicrotasks</code>.</li>
<li class="">There is no reusable or documented helper for other tests to await readiness; each suite reimplements a microtask flusher.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="6-proposed-solution">6. Proposed Solution<a href="#6-proposed-solution" class="hash-link" aria-label="Direct link to 6. Proposed Solution" title="Direct link to 6. Proposed Solution" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="61-architecture-overview">6.1 Architecture Overview<a href="#61-architecture-overview" class="hash-link" aria-label="Direct link to 6.1 Architecture Overview" title="Direct link to 6.1 Architecture Overview" translate="no">​</a></h3>
<ul>
<li class="">
<p><strong>Narrative</strong></p>
<ul>
<li class="">Define a formal readiness contract for <code>ShellStateProvider</code> based on Shell state:<!-- -->
<ul>
<li class="">Shell is considered <em>ready</em> when:<!-- -->
<ol>
<li class="">The worker bridge has reported readiness (<code>bridge.isReady === true</code>).</li>
<li class="">The provider is not currently restoring (<code>bridge.isRestoring === false</code>).</li>
<li class="">At least one runtime snapshot has been processed and recorded:<!-- -->
<ul>
<li class=""><code>bridge.lastUpdateAt !== null</code></li>
<li class=""><code>runtime.lastSnapshot !== undefined</code></li>
<li class=""><code>state.runtime.progression.snapshot !== null</code></li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
<li class="">Expose this contract in two ways:<!-- -->
<ol>
<li class=""><strong>State-Level Contract</strong>: Document these invariants as the official readiness definition, accessible via <code>useShellState</code>.</li>
<li class=""><strong>Test-Level Helper</strong>: Introduce a dedicated test helper <code>awaitShellStateReady</code> in <code>packages/shell-web/src/modules/__tests__/shell-state-ready.ts</code> (or similar test-only module) that:<!-- -->
<ul>
<li class="">Consumes <code>useShellState</code> (or a provided getter) and <code>waitFor</code> from <code>@testing-library/react</code>.</li>
<li class="">Awaits the readiness condition above with a bounded timeout.</li>
</ul>
</li>
</ol>
</li>
<li class="">Update <code>ShellStateProvider</code> tests to:<!-- -->
<ul>
<li class="">Replace <code>flushMicrotasks</code> with <code>awaitShellStateReady</code>.</li>
<li class="">Use the helper wherever they currently “wait for things to settle”.</li>
</ul>
</li>
<li class="">Keep production API and UI semantics unchanged while providing agents and developers a clear readiness boundary.</li>
</ul>
</li>
<li class="">
<p><strong>Diagram (conceptual)</strong></p>
<ul>
<li class=""><strong>Initialisation flow</strong>
<ul>
<li class=""><code>ShellStateProvider</code> mount
→ <code>useWorkerBridge</code> obtains <code>bridge</code>
→ Effect A: <code>bridge.awaitReady()</code> → dispatch <code>bridge-ready</code>
→ Effect B: <code>bridge.awaitReady()</code> → <code>restoreSession(restorePayload)</code> (if configured)
→ Effects: state update listeners, diagnostics, error listeners
→ <code>ShellState</code> transitions to:<!-- -->
<ul>
<li class=""><code>bridge.isReady === true</code></li>
<li class=""><code>bridge.isRestoring === false</code></li>
<li class=""><code>bridge.lastUpdateAt !== null</code></li>
<li class=""><code>runtime.lastSnapshot !== undefined</code> (after first snapshot)</li>
<li class=""><code>state.runtime.progression.snapshot !== null</code> (first progression snapshot)
→ <code>awaitShellStateReady</code> resolves.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="62-detailed-design">6.2 Detailed Design<a href="#62-detailed-design" class="hash-link" aria-label="Direct link to 6.2 Detailed Design" title="Direct link to 6.2 Detailed Design" translate="no">​</a></h3>
<ul>
<li class="">
<p><strong>Runtime Changes</strong></p>
<ul>
<li class="">
<p>No changes to the underlying worker runtime or <code>@idle-engine/core</code>.</p>
</li>
<li class="">
<p>Minimal internal changes to <code>ShellStateProvider</code>:</p>
<ul>
<li class="">Ensure that:<!-- -->
<ul>
<li class=""><code>bridge-ready</code> is always dispatched after <code>bridge.awaitReady()</code> resolves.</li>
<li class=""><code>restore-started</code> and <code>restore-complete</code> correctly bracket restore operations.</li>
</ul>
</li>
<li class="">Confirm invariants:<!-- -->
<ul>
<li class="">After a successful <code>restoreSession</code> in the restore effect, <code>bridge.isRestoring</code> is <code>false</code>.</li>
<li class="">On a best-effort basis, at least one <code>state-update</code> has been dispatched following readiness (existing behaviour should already satisfy this).</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p>Optionally, small internal refactoring to make readiness criteria easier to read for future maintainers (e.g., a derived boolean used only within tests and documentation).</p>
</li>
<li class="">
<p><strong>Data &amp; Schemas</strong></p>
<ul>
<li class="">No changes to runtime data schemas or worker messages.</li>
<li class="">Clarify semantics of existing state fields:<!-- -->
<ul>
<li class=""><code>ShellBridgeState.isReady</code>: “<code>bridge.awaitReady()</code> has successfully completed at least once for the current bridge instance.”</li>
<li class=""><code>ShellBridgeState.isRestoring</code>: “A restore operation started by the provider is currently in-flight.”</li>
<li class=""><code>ShellRuntimeState.lastSnapshot</code>: “The latest runtime snapshot received; omitted / <code>undefined</code> indicates no snapshot has been processed yet (type <code>RuntimeStateSnapshot | undefined</code>).”</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>APIs &amp; Contracts</strong></p>
<ul>
<li class=""><strong>Readiness Contract (logical)</strong>
<ul>
<li class="">Define <code>ShellStateProvider</code> readiness as the following predicate evaluated over <code>ShellState</code>:<!-- -->
<ul>
<li class=""><code>bridge.isReady === true</code></li>
<li class=""><code>bridge.isRestoring === false</code></li>
<li class=""><code>bridge.lastUpdateAt !== null</code></li>
<li class=""><code>runtime.lastSnapshot !== undefined</code></li>
<li class=""><code>state.runtime.progression.snapshot !== null</code></li>
</ul>
</li>
<li class="">This contract is:<!-- -->
<ul>
<li class="">The canonical definition used by <code>awaitShellStateReady</code>.</li>
<li class="">A documented expectation for future tests that need a ready Shell.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Test Helper API</strong></p>
<ul>
<li class="">
<p>Implement a test-only helper module at <code>packages/shell-web/src/modules/__tests__/shell-state-ready.ts</code>, exporting:</p>
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ShellReadyOptions</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> timeoutMs</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">awaitShellStateReady</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">getShellState</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> ShellState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ShellReadyOptions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>Implementation sketch:</p>
<ul>
<li class="">Uses <code>waitFor</code> from <code>@testing-library/react</code> with a default timeout (e.g. 1–2 seconds) to poll <code>getShellState()</code> until the readiness predicate holds.</li>
<li class="">Throws a descriptive error if the timeout elapses, including partial state for debugging.</li>
</ul>
</li>
<li class="">
<p>Usage patterns:</p>
<ul>
<li class="">For <code>renderHook</code> tests:<!-- -->
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> result </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">renderHook</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useShellState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> wrapper </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">awaitShellStateReady</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
</li>
<li class="">For integration tests using container probes:<!-- -->
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> shellStateRef </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> current</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> ShellState </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Probe component sets shellStateRef.current from context</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">awaitShellStateReady</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">shellStateRef</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Shell state not yet attached&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> shellStateRef</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Test Refactoring</strong></p>
<ul>
<li class=""><code>ShellStateProvider.test.tsx</code>:<!-- -->
<ul>
<li class="">Remove the inline <code>flushMicrotasks</code> helper.</li>
<li class="">Introduce a focused “readiness helper” test that uses <code>awaitShellStateReady</code> together with a mocked <code>state-update</code> to verify the readiness predicate over <code>ShellState</code>.</li>
<li class="">For other cases, where tests rely on specific observable effects rather than full readiness (e.g. progression selector shapes, diagnostics toggling), use <code>waitFor</code> with local predicates.</li>
</ul>
</li>
<li class=""><code>ShellStateProvider.telemetry.test.tsx</code>:<!-- -->
<ul>
<li class="">Remove its local <code>flushMicrotasks</code> helper.</li>
<li class="">Use <code>waitFor</code> to observe telemetry calls in response to restore and <code>awaitReady</code> failures, and to diagnostics enable/disable behaviour.</li>
<li class="">For diagnostics unsubscribe cleanup, rely on fake timers plus <code>vi.runAllTimers()</code> wrapped in <code>act</code> to flush the provider’s deferred reconciliation without introducing new timing helpers.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Tooling &amp; Automation</strong></p>
<ul>
<li class="">Maintain Vitest-based tests; no new frameworks introduced.</li>
<li class="">Update any existing shared test utilities that may benefit from the readiness helper (optional but recommended).</li>
<li class="">Ensure the helper module is not imported into production bundles:<!-- -->
<ul>
<li class="">Place it under a <code>__tests__</code> or clearly test-only path.</li>
<li class="">Avoid exporting it from main <code>modules/index.ts</code>.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="63-operational-considerations">6.3 Operational Considerations<a href="#63-operational-considerations" class="hash-link" aria-label="Direct link to 6.3 Operational Considerations" title="Direct link to 6.3 Operational Considerations" translate="no">​</a></h3>
<ul>
<li class="">
<p><strong>Deployment</strong></p>
<ul>
<li class="">No special deployment changes; this is a test-focused improvement with minor provider internals clarification.</li>
<li class="">Merged as part of regular <code>shell-web</code> changes, gated by CI:<!-- -->
<ul>
<li class=""><code>pnpm test --filter shell-web</code></li>
<li class=""><code>pnpm lint --filter shell-web</code></li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Telemetry &amp; Observability</strong></p>
<ul>
<li class="">Maintain existing telemetry events:<!-- -->
<ul>
<li class=""><code>ShellStateProviderAwaitReadyFailed</code>.</li>
<li class=""><code>ShellStateProviderRestoreEffectFailed</code>.</li>
<li class="">Social and diagnostics-related telemetry.</li>
</ul>
</li>
<li class="">Optionally log additional context in tests when readiness fails to be reached within timeout, but avoid production logging changes.</li>
</ul>
</li>
<li class="">
<p><strong>Security &amp; Compliance</strong></p>
<ul>
<li class="">No changes to PII handling or permissions.</li>
<li class="">Test helper must not expose additional secrets or environment details.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="7-work-breakdown--delivery-plan">7. Work Breakdown &amp; Delivery Plan<a href="#7-work-breakdown--delivery-plan" class="hash-link" aria-label="Direct link to 7. Work Breakdown &amp; Delivery Plan" title="Direct link to 7. Work Breakdown &amp; Delivery Plan" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="71-issue-map">7.1 Issue Map<a href="#71-issue-map" class="hash-link" aria-label="Direct link to 7.1 Issue Map" title="Direct link to 7.1 Issue Map" translate="no">​</a></h3>
<p>Populate the table as the canonical source for downstream GitHub issues.</p>
<table><thead><tr><th>Issue Title</th><th>Scope Summary</th><th>Proposed Assignee/Agent</th><th>Dependencies</th><th>Acceptance Criteria</th></tr></thead><tbody><tr><td>feat(shell-web): define ShellStateProvider readiness contract</td><td>Document and validate the logical readiness predicate over <code>ShellState</code> and ensure provider effects maintain it</td><td>Shell-Web Implementation Agent</td><td>This design approved</td><td>Predicate is captured in code comments and/or docstrings; unit tests assert readiness invariants via reducer/state tests</td></tr><tr><td>test(shell-web): add awaitShellStateReady helper</td><td>Implement <code>awaitShellStateReady</code> test helper and initial unit tests for the helper</td><td>Test &amp; Tooling Agent</td><td>Readiness predicate defined</td><td>Helper module exists under <code>packages/shell-web/src/modules/__tests__/</code>; tests pass; helper is not exported into production bundles</td></tr><tr><td>test(shell-web): migrate ShellStateProvider tests off flushMicrotasks</td><td>Refactor <code>ShellStateProvider.test.tsx</code> to use readiness helper and targeted <code>waitFor</code> instead of <code>flushMicrotasks</code></td><td>Shell-Web Implementation Agent</td><td>Helper implemented</td><td>No <code>flushMicrotasks</code> function remains in <code>ShellStateProvider.test.tsx</code>; tests pass and remain deterministic</td></tr><tr><td>test(shell-web): migrate ShellStateProvider telemetry tests off flushMicrotasks</td><td>Refactor telemetry tests to await readiness and specific telemetry events without microtask flushing</td><td>Shell-Web Implementation Agent</td><td>Helper implemented</td><td>No <code>flushMicrotasks</code> function remains in <code>ShellStateProvider.telemetry.test.tsx</code>; telemetry assertions are stable</td></tr><tr><td>chore(shell-web): remove legacy microtask helpers &amp; document readiness</td><td>Remove any remaining microtask-based helpers in Shell state tests; add a short section to docs or test README summarising the readiness contract</td><td>Shell-Web Implementation Agent</td><td>All migrations completed</td><td><code>flushMicrotasks</code> no longer appears in the repo; docs/tests reference the readiness helper and contract; CI is green</td></tr><tr><td>meta: drive Fixes #394 PR</td><td>Integrate all work on a dedicated branch, run tests, and open a PR referencing <code>Fixes #394</code></td><td>Review &amp; Governance Agent</td><td>All above issues closed</td><td>PR merged with message and description including <code>Fixes #394</code>; GitHub issue auto-closes</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="72-milestones">7.2 Milestones<a href="#72-milestones" class="hash-link" aria-label="Direct link to 7.2 Milestones" title="Direct link to 7.2 Milestones" translate="no">​</a></h3>
<ul>
<li class="">
<p><strong>Phase 1: Contract &amp; Helper (1–2 days)</strong></p>
<ul>
<li class="">Finalise readiness predicate in code comments.</li>
<li class="">Implement <code>awaitShellStateReady</code>.</li>
<li class="">Add unit tests for the helper using simple mocked <code>ShellState</code> transitions.</li>
</ul>
</li>
<li class="">
<p><strong>Phase 2: Test Migration (1–2 days)</strong></p>
<ul>
<li class="">Refactor <code>ShellStateProvider.test.tsx</code> and telemetry tests to the new helper.</li>
<li class="">Remove <code>flushMicrotasks</code> definitions.</li>
<li class="">Validate tests locally and in CI.</li>
</ul>
</li>
<li class="">
<p><strong>Phase 3: Documentation &amp; Cleanup (≤1 day)</strong></p>
<ul>
<li class="">Add short documentation snippet (either within test files or a <code>docs/</code> note) describing the readiness contract.</li>
<li class="">Confirm no other tests rely on <code>flushMicrotasks</code> or similar patterns.</li>
<li class="">Land PR with <code>Fixes #394</code>.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="73-coordination-notes">7.3 Coordination Notes<a href="#73-coordination-notes" class="hash-link" aria-label="Direct link to 7.3 Coordination Notes" title="Direct link to 7.3 Coordination Notes" translate="no">​</a></h3>
<ul>
<li class="">
<p><strong>Hand-off Package</strong></p>
<ul>
<li class="">This design document.</li>
<li class="">Relevant source files:<!-- -->
<ul>
<li class=""><code>packages/shell-web/src/modules/ShellStateProvider.tsx</code>.</li>
<li class=""><code>packages/shell-web/src/modules/shell-state-store.ts</code>.</li>
<li class=""><code>packages/shell-web/src/modules/ShellStateProvider.test.tsx</code>.</li>
<li class=""><code>packages/shell-web/src/modules/ShellStateProvider.telemetry.test.tsx</code>.</li>
</ul>
</li>
<li class="">Commands:<!-- -->
<ul>
<li class=""><code>pnpm test --filter shell-web</code>.</li>
<li class=""><code>pnpm lint --filter shell-web</code>.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Communication Cadence</strong></p>
<ul>
<li class="">Agents should:<!-- -->
<ul>
<li class="">Update the GitHub issue #394 with progress notes per phase.</li>
<li class="">Request human review once tests are migrated and passing.</li>
</ul>
</li>
<li class="">Escalation path:<!-- -->
<ul>
<li class="">Shell Web maintainer for design ambiguities.</li>
<li class="">Runtime/Bridge maintainer for questions about <code>awaitReady</code> guarantees.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="8-agent-guidance--guardrails">8. Agent Guidance &amp; Guardrails<a href="#8-agent-guidance--guardrails" class="hash-link" aria-label="Direct link to 8. Agent Guidance &amp; Guardrails" title="Direct link to 8. Agent Guidance &amp; Guardrails" translate="no">​</a></h2>
<ul>
<li class="">
<p><strong>Context Packets</strong></p>
<ul>
<li class="">Agents must load:<!-- -->
<ul>
<li class="">This design document.</li>
<li class=""><code>packages/shell-web/src/modules/ShellStateProvider.tsx</code>.</li>
<li class=""><code>packages/shell-web/src/modules/shell-state-store.ts</code>.</li>
<li class=""><code>packages/shell-web/src/modules/ShellStateProvider.test.tsx</code>.</li>
<li class=""><code>packages/shell-web/src/modules/ShellStateProvider.telemetry.test.tsx</code>.</li>
</ul>
</li>
<li class="">Environment assumptions:<!-- -->
<ul>
<li class="">Node ≥ 20.10.</li>
<li class=""><code>pnpm</code> ≥ 8.</li>
<li class=""><code>pnpm install</code> has been run at repo root.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Prompting &amp; Constraints</strong></p>
<ul>
<li class="">Agents should follow:<!-- -->
<ul>
<li class="">Repository coding conventions in <code>AGENTS.md</code> and <code>eslint.config.mjs</code>.</li>
<li class="">TypeScript style guidelines:<!-- -->
<ul>
<li class="">Use <code>import type { ... }</code> for type-only imports.</li>
<li class="">Co-locate test helpers with tests when appropriate.</li>
</ul>
</li>
<li class="">Commit/PR conventions:<!-- -->
<ul>
<li class="">Use Conventional Commits; final PR must include <code>Fixes #394</code> in description.</li>
</ul>
</li>
</ul>
</li>
<li class="">Example agent prompt snippet:<!-- -->
<ul>
<li class="">“Update <code>ShellStateProvider</code> tests to replace the <code>flushMicrotasks</code> helper with the <code>awaitShellStateReady</code> helper, using the readiness contract defined in <code>docs/deterministic-shell-state-readiness.md</code> (or this design). Ensure tests remain deterministic and do not rely on <code>setTimeout(0)</code>.”</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Safety Rails</strong></p>
<ul>
<li class="">Forbidden actions:<!-- -->
<ul>
<li class="">Do not modify <code>dist/</code> outputs.</li>
<li class="">Do not change core runtime semantics in <code>packages/core</code> as part of this initiative.</li>
<li class="">Do not disable or bypass tests; fix them.</li>
<li class="">Do not introduce arbitrary sleeps (<code>setTimeout</code>-based waits) in tests.</li>
</ul>
</li>
<li class="">Rollback procedures:<!-- -->
<ul>
<li class="">If readiness helper introduces new flakiness:<!-- -->
<ul>
<li class="">Revert the helper and test changes in a dedicated revert commit.</li>
<li class="">File a follow-up issue documenting observed failures and logs.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Validation Hooks</strong></p>
<ul>
<li class="">Before marking tasks complete, agents must run:<!-- -->
<ul>
<li class=""><code>pnpm test --filter shell-web</code>.</li>
<li class=""><code>pnpm lint --filter shell-web</code>.</li>
</ul>
</li>
<li class="">Optionally:<!-- -->
<ul>
<li class=""><code>pnpm test:a11y</code> when Shell UI flows are affected (should not be necessary for this test-focused change but can be run as a safety check).</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="9-alternatives-considered">9. Alternatives Considered<a href="#9-alternatives-considered" class="hash-link" aria-label="Direct link to 9. Alternatives Considered" title="Direct link to 9. Alternatives Considered" translate="no">​</a></h2>
<ul>
<li class="">
<p><strong>Alternative A: Extend ShellBridgeApi with a public <code>ready</code> Promise</strong></p>
<ul>
<li class="">Description:<!-- -->
<ul>
<li class="">Add a <code>ready: Promise&lt;void&gt;</code> property to <code>ShellBridgeApi</code>, backed by <code>bridge.awaitReady()</code>, and have tests await <code>useShellBridge().ready</code>.</li>
</ul>
</li>
<li class="">Pros:<!-- -->
<ul>
<li class="">Simple consumption from tests and potentially application code.</li>
</ul>
</li>
<li class="">Cons:<!-- -->
<ul>
<li class="">Introduces new public API with ambiguous semantics relative to <code>awaitReady()</code>.</li>
<li class="">Does not directly capture restore completion or initial snapshot availability.</li>
<li class="">Risks encouraging production code to block on readiness in ways that might hurt UX.</li>
</ul>
</li>
<li class="">Reason rejected:<!-- -->
<ul>
<li class="">The problem is primarily test-facing; adding a production API is unnecessary scope.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Alternative B: Deterministic “tick” API in the runtime</strong></p>
<ul>
<li class="">Description:<!-- -->
<ul>
<li class="">Add a “tick” or “drain” API to the worker/runtime, allowing tests to advance the simulation deterministically.</li>
</ul>
</li>
<li class="">Pros:<!-- -->
<ul>
<li class="">Strong deterministic semantics across many subsystems.</li>
</ul>
</li>
<li class="">Cons:<!-- -->
<ul>
<li class="">Requires changes to <code>@idle-engine/core</code> and worker protocols.</li>
<li class="">Overkill for the narrow goal of Shell state readiness in <code>shell-web</code>.</li>
</ul>
</li>
<li class="">Reason rejected:<!-- -->
<ul>
<li class="">Too large and cross-cutting for issue #394; may be revisited for broader deterministic testing.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Alternative C: Keep <code>flushMicrotasks</code> but share it as a utility</strong></p>
<ul>
<li class="">Description:<!-- -->
<ul>
<li class="">Refactor the existing microtask-based helper into a shared test util and document it.</li>
</ul>
</li>
<li class="">Pros:<!-- -->
<ul>
<li class="">Minimal code changes.</li>
</ul>
</li>
<li class="">Cons:<!-- -->
<ul>
<li class="">Retains brittle reliance on event-loop details.</li>
<li class="">Fails to provide a semantic readiness contract.</li>
</ul>
</li>
<li class="">Reason rejected:<!-- -->
<ul>
<li class="">Does not meet the acceptance criteria of deterministic, contract-based readiness.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="10-testing--validation-plan">10. Testing &amp; Validation Plan<a href="#10-testing--validation-plan" class="hash-link" aria-label="Direct link to 10. Testing &amp; Validation Plan" title="Direct link to 10. Testing &amp; Validation Plan" translate="no">​</a></h2>
<ul>
<li class="">
<p><strong>Unit / Integration</strong></p>
<ul>
<li class="">Add tests for readiness helper:<!-- -->
<ul>
<li class="">Simulate <code>ShellState</code> transitions and assert that <code>awaitShellStateReady</code> resolves when the predicate is satisfied and times out otherwise.</li>
</ul>
</li>
<li class="">Update and re-run:<!-- -->
<ul>
<li class=""><code>ShellStateProvider.test.tsx</code>:<!-- -->
<ul>
<li class="">Verify all existing scenarios (progression API, restore behaviour, error handling) using the new helper.</li>
</ul>
</li>
<li class=""><code>ShellStateProvider.telemetry.test.tsx</code>:<!-- -->
<ul>
<li class="">Ensure telemetry events (<code>RestoreEffectFailed</code>, <code>AwaitReadyFailed</code>, social failures) still fire as expected.</li>
</ul>
</li>
</ul>
</li>
<li class="">Use Vitest filters for targeted runs:<!-- -->
<ul>
<li class=""><code>pnpm test --filter shell-web -- ShellStateProvider</code>.</li>
<li class=""><code>pnpm test --filter shell-web -- ShellStateProvider.telemetry</code>.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Performance</strong></p>
<ul>
<li class="">No explicit performance benchmarks required; however:<!-- -->
<ul>
<li class="">Ensure readiness helper timeout is reasonable and does not materially slow tests.</li>
<li class="">Monitor test duration regressions in CI runs.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Tooling / A11y</strong></p>
<ul>
<li class="">No direct impact on Playwright or accessibility tests.</li>
<li class="">Optionally run:<!-- -->
<ul>
<li class=""><code>pnpm test:a11y</code> after changes to guard against unexpected UI regressions from provider tweaks.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="11-risks--mitigations">11. Risks &amp; Mitigations<a href="#11-risks--mitigations" class="hash-link" aria-label="Direct link to 11. Risks &amp; Mitigations" title="Direct link to 11. Risks &amp; Mitigations" translate="no">​</a></h2>
<ul>
<li class="">
<p><strong>Risk 1: Mis-specified readiness predicate</strong></p>
<ul>
<li class="">Impact:<!-- -->
<ul>
<li class="">Tests may hang or fail if readiness is never reached, or assert too early if predicate is too weak.</li>
</ul>
</li>
<li class="">Mitigations:<!-- -->
<ul>
<li class="">Derive predicate from existing UI semantics (<code>isLoading</code> usage).</li>
<li class="">Add focused tests that assert the relationship between <code>bridge-ready</code>, <code>restore</code> actions, and readiness.</li>
<li class="">Include state snapshots in error messages on timeout to aid debugging.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Risk 2: StrictMode interactions</strong></p>
<ul>
<li class="">Impact:<!-- -->
<ul>
<li class="">Double-mount behaviour may cause multiple <code>awaitReady</code> / restore sequences and subtle ordering issues.</li>
</ul>
</li>
<li class="">Mitigations:<!-- -->
<ul>
<li class="">The provider already guards against duplicate awaits (<code>lastAwaitedBridgeRef</code>, <code>lastRestorePayloadRef</code>, <code>lastRestoreBridgeRef</code>).</li>
<li class="">Ensure readiness predicate does not depend on transient intermediate states and is idempotent.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Risk 3: Hidden consumers of <code>flushMicrotasks</code></strong></p>
<ul>
<li class="">Impact:<!-- -->
<ul>
<li class="">Other tests may implicitly rely on <code>flushMicrotasks</code> or similar patterns; removal could cause regressions.</li>
</ul>
</li>
<li class="">Mitigations:<!-- -->
<ul>
<li class="">Search the codebase (<code>rg &quot;flushMicrotasks&quot; -n</code>) before removal.</li>
<li class="">Migrate or explicitly document any remaining usage; if unavoidable, keep such usage narrowly scoped and justified.</li>
</ul>
</li>
</ul>
</li>
<li class="">
<p><strong>Risk 4: Overfitting to current provider implementation</strong></p>
<ul>
<li class="">Impact:<!-- -->
<ul>
<li class="">Future changes to <code>ShellStateProvider</code> effects may unintentionally break the readiness helper.</li>
</ul>
</li>
<li class="">Mitigations:<!-- -->
<ul>
<li class="">Keep readiness defined in terms of <code>ShellState</code>, not internal effect order.</li>
<li class="">Revisit the helper and tests when provider internals change; update references accordingly.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="12-rollout-plan">12. Rollout Plan<a href="#12-rollout-plan" class="hash-link" aria-label="Direct link to 12. Rollout Plan" title="Direct link to 12. Rollout Plan" translate="no">​</a></h2>
<ul>
<li class="">
<p><strong>Milestones</strong></p>
<ul>
<li class="">M1: Helper implemented and validated locally.</li>
<li class="">M2: <code>ShellStateProvider</code> tests migrated and passing.</li>
<li class="">M3: Telemetry tests migrated; <code>flushMicrotasks</code> removed.</li>
<li class="">M4: PR merged with <code>Fixes #394</code>.</li>
</ul>
</li>
<li class="">
<p><strong>Migration Strategy</strong></p>
<ul>
<li class="">Implement helper and migrate tests within the same feature branch (<code>issue-394</code>).</li>
<li class="">Avoid partial migration where tests mix <code>flushMicrotasks</code> and readiness helper in confusing ways.</li>
<li class="">Maintain backwards compatibility with runtime and UI by not changing public APIs.</li>
</ul>
</li>
<li class="">
<p><strong>Communication</strong></p>
<ul>
<li class="">Document the readiness contract at the top of the helper module and in a brief comment in <code>ShellStateProvider.test.tsx</code>.</li>
<li class="">Mention the new pattern and helper in the PR description and link to this design document.</li>
<li class="">If test flakiness is discovered, note it in the GitHub issue and consider a follow-up design for broader deterministic testing.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="13-open-questions">13. Open Questions<a href="#13-open-questions" class="hash-link" aria-label="Direct link to 13. Open Questions" title="Direct link to 13. Open Questions" translate="no">​</a></h2>
<ol>
<li class="">Should the readiness helper be exported from a central <code>test-utils</code> module (<code>packages/shell-web/src/test-utils.ts</code>) instead of a <code>__tests__</code>-local file to encourage reuse?<!-- -->
<ul>
<li class=""><strong>Decision</strong>: Keep the readiness helper out of the shared worker harness utilities and scope it to React-only test modules (e.g., <code>packages/shell-web/src/modules/test-helpers.ts</code> or a <code>modules/__tests__/shell-state-ready.ts</code>-style helper).</li>
<li class=""><strong>Rationale</strong>: <code>packages/shell-web/src/test-utils.ts</code> is imported by worker-centric suites such as <code>packages/shell-web/src/runtime.worker.test.ts</code> and <code>packages/shell-web/src/modules/session-persistence-integration.test.ts</code>, which deliberately avoid React or DOM-specific dependencies so they can run in the Node-based worker harness. Exporting a React Testing Library–based readiness helper from that module would force those suites to pull in unnecessary DOM tooling and could break worker-only runs.</li>
<li class=""><strong>Owner</strong>: Shell Web Maintainer — <strong>CLOSED</strong>.</li>
</ul>
</li>
<li class="">Do any other Shell tests (beyond <code>ShellStateProvider*</code>) need to await the same readiness boundary?<!-- -->
<ul>
<li class=""><strong>Decision</strong>: The readiness helper only needs to replace the local <code>flushMicrotasks</code> helpers in <code>packages/shell-web/src/modules/ShellStateProvider.test.tsx</code> and <code>packages/shell-web/src/modules/ShellStateProvider.telemetry.test.tsx</code>.</li>
<li class=""><strong>Rationale</strong>: A repository search shows that only these two suites currently rely on the implicit provider readiness boundary; other Shell UI tests either mock shell hooks or remain synchronous and do not need to await the provider. Keeping the helper’s usage limited to these suites keeps the migration small and avoids touching unrelated tests.</li>
<li class=""><strong>Owner</strong>: Test &amp; Tooling Agent — <strong>CLOSED</strong>.</li>
</ul>
</li>
<li class="">Should we treat “first snapshot received” as mandatory for readiness, or is <code>bridge.isReady &amp;&amp; !isRestoring</code> sufficient?<!-- -->
<ul>
<li class=""><strong>Decision</strong>: Readiness is defined as the canonical predicate described in <strong>Readiness Contract (logical)</strong>: <code>bridge.isReady === true</code>, <code>bridge.isRestoring === false</code>, <code>bridge.lastUpdateAt !== null</code>, <code>state.runtime.lastSnapshot !== undefined</code>, and <code>state.runtime.progression.snapshot !== null</code>.</li>
<li class=""><strong>Rationale</strong>: UI components such as <code>packages/shell-web/src/modules/ResourceDashboard.tsx</code> and <code>packages/shell-web/src/modules/GeneratorPanel.tsx</code> already treat readiness as “bridge ready plus at least one snapshot,” blocking on <code>progression.select*()</code> returning data while gating their loading indicators on <code>!bridge.isReady || bridge.lastUpdateAt === null</code>. Waiting for both <code>lastSnapshot</code> to become defined and <code>progression.snapshot</code> to become non-null keeps the helper aligned with real UI semantics and with the sentinel values used in <code>shell-state-store.ts</code>.</li>
<li class=""><strong>Owner</strong>: Runtime/Bridge Maintainer — <strong>CLOSED</strong>.</li>
</ul>
</li>
<li class="">Is there value in exposing a limited, public <code>useShellReady</code> hook for application code, or should readiness remain test-only for now?<!-- -->
<ul>
<li class=""><strong>Decision</strong>: Readiness remains a test-only concern; no public <code>useShellReady</code> hook will be added at this stage.</li>
<li class=""><strong>Rationale</strong>: Production components that care about readiness (e.g., <code>ResourceDashboard</code>, <code>GeneratorPanel</code>) already consume <code>useShellState()</code> and check <code>bridge.isReady</code> / <code>bridge.lastUpdateAt</code> directly while handling <code>progression</code> selectors that may be <code>null</code>. Introducing a dedicated hook would expand the public API surface without current production consumers or clear benefit; it can be revisited when a concrete application use case emerges.</li>
<li class=""><strong>Owner</strong>: Shell Web Maintainer — <strong>CLOSED</strong>.</li>
</ul>
</li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="14-follow-up-work">14. Follow-Up Work<a href="#14-follow-up-work" class="hash-link" aria-label="Direct link to 14. Follow-Up Work" title="Direct link to 14. Follow-Up Work" translate="no">​</a></h2>
<ul>
<li class="">Consider a broader deterministic testing strategy:<!-- -->
<ul>
<li class="">Example: a general “simulation tick” helper for worker-driven components.</li>
<li class=""><strong>Owner</strong>: Runtime/Bridge Maintainer — <strong>Timing</strong>: Post-#394.</li>
</ul>
</li>
<li class="">Audit other microtask-based test helpers across the monorepo and align them with similar contract-based patterns.<!-- -->
<ul>
<li class=""><strong>Owner</strong>: Test &amp; Tooling Agent — <strong>Timing</strong>: After Shell readiness stabilises.</li>
</ul>
</li>
<li class="">Evaluate whether readiness semantics should be shared with any backend or social features (e.g., <code>services/social</code>).<!-- -->
<ul>
<li class=""><strong>Owner</strong>: Social Service Maintainer — <strong>Timing</strong>: As needed.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="15-references">15. References<a href="#15-references" class="hash-link" aria-label="Direct link to 15. References" title="Direct link to 15. References" translate="no">​</a></h2>
<ul>
<li class=""><code>packages/shell-web/src/modules/ShellStateProvider.tsx:308</code> — Bridge readiness effect using <code>awaitReady</code>.</li>
<li class=""><code>packages/shell-web/src/modules/ShellStateProvider.tsx:448</code> — Restore effect and telemetry on failure.</li>
<li class=""><code>packages/shell-web/src/modules/shell-state-store.ts:103</code> — Initial Shell bridge state including <code>isReady</code> and <code>isRestoring</code>.</li>
<li class=""><code>packages/shell-web/src/modules/shell-state-store.ts:149</code> — Reducer handling <code>bridge-ready</code> action.</li>
<li class=""><code>packages/shell-web/src/modules/__tests__/shell-state-ready.ts:1</code> — Test-only <code>awaitShellStateReady</code> helper implementing the readiness predicate.</li>
<li class=""><code>packages/shell-web/src/modules/ShellStateProvider.test.tsx:264</code> — Readiness helper integration test exercising the contract over <code>ShellState</code>.</li>
<li class=""><code>packages/shell-web/src/modules/ShellStateProvider.telemetry.test.tsx:187</code> — Telemetry tests using <code>waitFor</code> to observe restore and readiness failures without microtask flushing.</li>
<li class=""><code>packages/shell-web/src/modules/ResourceDashboard.tsx:242</code> — UI loading state based on <code>bridge.isReady</code>.</li>
<li class=""><code>packages/shell-web/src/modules/GeneratorPanel.tsx:124</code> — UI loading state based on <code>bridge.isReady</code>.</li>
<li class="">GitHub issue <code>#394</code> — “Investigate flushMicrotasks test helper and async boundaries”.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-a--glossary">Appendix A — Glossary<a href="#appendix-a--glossary" class="hash-link" aria-label="Direct link to Appendix A — Glossary" title="Direct link to Appendix A — Glossary" translate="no">​</a></h2>
<ul>
<li class=""><strong>Shell state readiness contract for ShellStateProvider</strong>: The formal predicate over <code>ShellState</code> that defines when the Shell is considered initialised and stable for tests and UI (bridge ready, not restoring, snapshot received).</li>
<li class=""><strong><code>flushMicrotasks</code> helper</strong>: A legacy test-only function (removed in PR #396) that chained <code>Promise.resolve()</code> and <code>setTimeout(0)</code> calls to approximate completion of pending microtasks and macrotasks.</li>
<li class=""><strong>Worker bridge</strong>: The abstraction that connects the web shell to the deterministic runtime worker, providing <code>awaitReady</code>, state updates, telemetry, and social commands.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-b--change-log">Appendix B — Change Log<a href="#appendix-b--change-log" class="hash-link" aria-label="Direct link to Appendix B — Change Log" title="Direct link to Appendix B — Change Log" translate="no">​</a></h2>
<table><thead><tr><th>Date</th><th>Author</th><th>Change Summary</th></tr></thead><tbody><tr><td>2025-11-16</td><td>Idle Engine Design-Authoring Agent</td><td>Initial draft of deterministic Shell state readiness contract for ShellStateProvider and test migration plan (targets <code>Fixes #394</code>).</td></tr><tr><td>2025-11-16</td><td>Shell-Web Implementation Agent</td><td>Document updated to reflect implemented <code>awaitShellStateReady</code> helper, removal of <code>flushMicrotasks</code> from tests, and alignment with PR #396 (<code>Fixes #394</code>).</td></tr></tbody></table></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_QKxP"><a href="https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/shell-state-provider-readiness-design-issue-394.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_wOWh" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_Basj"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_AUZ0 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#document-control" class="table-of-contents__link toc-highlight">Document Control</a></li><li><a href="#1-summary" class="table-of-contents__link toc-highlight">1. Summary</a></li><li><a href="#2-context--problem-statement" class="table-of-contents__link toc-highlight">2. Context &amp; Problem Statement</a></li><li><a href="#3-goals--non-goals" class="table-of-contents__link toc-highlight">3. Goals &amp; Non-Goals</a></li><li><a href="#4-stakeholders-agents--impacted-surfaces" class="table-of-contents__link toc-highlight">4. Stakeholders, Agents &amp; Impacted Surfaces</a></li><li><a href="#5-current-state" class="table-of-contents__link toc-highlight">5. Current State</a></li><li><a href="#6-proposed-solution" class="table-of-contents__link toc-highlight">6. Proposed Solution</a><ul><li><a href="#61-architecture-overview" class="table-of-contents__link toc-highlight">6.1 Architecture Overview</a></li><li><a href="#62-detailed-design" class="table-of-contents__link toc-highlight">6.2 Detailed Design</a></li><li><a href="#63-operational-considerations" class="table-of-contents__link toc-highlight">6.3 Operational Considerations</a></li></ul></li><li><a href="#7-work-breakdown--delivery-plan" class="table-of-contents__link toc-highlight">7. Work Breakdown &amp; Delivery Plan</a><ul><li><a href="#71-issue-map" class="table-of-contents__link toc-highlight">7.1 Issue Map</a></li><li><a href="#72-milestones" class="table-of-contents__link toc-highlight">7.2 Milestones</a></li><li><a href="#73-coordination-notes" class="table-of-contents__link toc-highlight">7.3 Coordination Notes</a></li></ul></li><li><a href="#8-agent-guidance--guardrails" class="table-of-contents__link toc-highlight">8. Agent Guidance &amp; Guardrails</a></li><li><a href="#9-alternatives-considered" class="table-of-contents__link toc-highlight">9. Alternatives Considered</a></li><li><a href="#10-testing--validation-plan" class="table-of-contents__link toc-highlight">10. Testing &amp; Validation Plan</a></li><li><a href="#11-risks--mitigations" class="table-of-contents__link toc-highlight">11. Risks &amp; Mitigations</a></li><li><a href="#12-rollout-plan" class="table-of-contents__link toc-highlight">12. Rollout Plan</a></li><li><a href="#13-open-questions" class="table-of-contents__link toc-highlight">13. Open Questions</a></li><li><a href="#14-follow-up-work" class="table-of-contents__link toc-highlight">14. Follow-Up Work</a></li><li><a href="#15-references" class="table-of-contents__link toc-highlight">15. References</a></li><li><a href="#appendix-a--glossary" class="table-of-contents__link toc-highlight">Appendix A — Glossary</a></li><li><a href="#appendix-b--change-log" class="table-of-contents__link toc-highlight">Appendix B — Change Log</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/contributor-handbook">Contributor Handbook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Idle Engine.</div></div></div></footer></div>
</body>
</html>