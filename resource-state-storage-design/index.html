<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-resource-state-storage-design" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Resource State Storage Design | Idle Engine Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hansjm10.github.io/Idle-Game-Engine/resource-state-storage-design"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Resource State Storage Design | Idle Engine Docs"><meta data-rh="true" name="description" content="Use this template when authoring new design proposals or retrofitting existing notes. Fill out every section or state explicitly why it is not applicable. Replace bracketed guidance with project-specific detail before submitting for review. The structure is optimised for an AI-first delivery model where work is decomposed into issues and executed by autonomous agents under human orchestration."><meta data-rh="true" property="og:description" content="Use this template when authoring new design proposals or retrofitting existing notes. Fill out every section or state explicitly why it is not applicable. Replace bracketed guidance with project-specific detail before submitting for review. The structure is optimised for an AI-first delivery model where work is decomposed into issues and executed by autonomous agents under human orchestration."><link data-rh="true" rel="icon" href="/Idle-Game-Engine/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hansjm10.github.io/Idle-Game-Engine/resource-state-storage-design"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/resource-state-storage-design" hreflang="en"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/resource-state-storage-design" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Resource State Storage Design","item":"https://hansjm10.github.io/Idle-Game-Engine/resource-state-storage-design"}]}</script><link rel="stylesheet" href="/Idle-Game-Engine/assets/css/styles.ddf7989c.css">
<script src="/Idle-Game-Engine/assets/js/runtime~main.9824e02d.js" defer="defer"></script>
<script src="/Idle-Game-Engine/assets/js/main.9fc2d0e7.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Idle-Game-Engine/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_li4T" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Idle-Game-Engine/"><div class="navbar__logo"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--light_vaEm"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--dark_axH8"></div><b class="navbar__title text--truncate">Idle Engine</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Idle-Game-Engine/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle__Exw colorModeToggle_Lslw"><button class="clean-btn toggleButton_AMBK toggleButtonDisabled_p4Bd" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 lightToggleIcon_p2sk"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 darkToggleIcon_B2qX"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 systemToggleIcon_PWgn"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_RKai"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_nqaE"><div class="docsWrapper_CSLE"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sOWX" type="button"></button><div class="docRoot_qxtV"><aside class="theme-doc-sidebar-container docSidebarContainer_Xlvo"><div class="sidebarViewport_tjEA"><div class="sidebar_ubOv"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_CfkH"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/Idle-Game-Engine/"><span title="Getting Started" class="categoryLinkLabel_ebxo">Getting Started</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/"><span title="Overview" class="linkLabel_KsAJ">Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/contributor-handbook"><span title="Contributor Handbook" class="linkLabel_KsAJ">Contributor Handbook</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/role-index"><span title="Role Index" class="linkLabel_KsAJ">Role Index</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/design-document-template"><span title="Design Document Template" class="linkLabel_KsAJ">Design Document Template</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/Idle-Game-Engine/idle-engine-design"><span title="Core Runtime" class="categoryLinkLabel_ebxo">Core Runtime</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/idle-engine-design"><span title="Idle Engine Design Document" class="linkLabel_KsAJ">Idle Engine Design Document</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/runtime-step-lifecycle"><span title="Runtime Step Lifecycle Alignment" class="linkLabel_KsAJ">Runtime Step Lifecycle Alignment</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/runtime-command-queue-design"><span title="Runtime Command Queue Design" class="linkLabel_KsAJ">Runtime Command Queue Design</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/controls-contract-design-issue-705"><span title="Controls Contract Design (Issue 705)" class="linkLabel_KsAJ">Controls Contract Design (Issue 705)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/desktop-shell-webgpu-renderer-replay-design-issue-778"><span title="Desktop Shell + WebGPU Renderer + Replay (Issue 778)" class="linkLabel_KsAJ">Desktop Shell + WebGPU Renderer + Replay (Issue 778)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/runtime-event-pubsub-design"><span title="Runtime Event Pub/Sub Design" class="linkLabel_KsAJ">Runtime Event Pub/Sub Design</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/runtime-event-bus-decisions"><span title="Runtime Event Bus Follow-up Decisions" class="linkLabel_KsAJ">Runtime Event Bus Follow-up Decisions</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/runtime-event-manifest-authoring"><span title="Runtime Event Manifest Authoring" class="linkLabel_KsAJ">Runtime Event Manifest Authoring</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/tick-accumulator-coverage-design"><span title="Tick Accumulator Edge Case Coverage" class="linkLabel_KsAJ">Tick Accumulator Edge Case Coverage</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Idle-Game-Engine/resource-state-storage-design"><span title="Resource State Storage Design" class="linkLabel_KsAJ">Resource State Storage Design</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Idle-Game-Engine/diagnostic-timeline-design"><span title="Diagnostic Timeline Design Document" class="linkLabel_KsAJ">Diagnostic Timeline Design Document</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/content-dsl-schema-design"><span title="Content Pipeline" class="categoryLinkLabel_ebxo">Content Pipeline</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/coverage/"><span title="Diagnostics &amp; Quality" class="categoryLinkLabel_ebxo">Diagnostics &amp; Quality</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_ziOL menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/Idle-Game-Engine/implementation-plan"><span title="Operations &amp; Process" class="categoryLinkLabel_ebxo">Operations &amp; Process</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_tfRv"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_hyci"><div class="docItemContainer_tcAC"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_bxbs" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/Idle-Game-Engine/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_p1A9"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Core Runtime</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Resource State Storage Design</span></li></ul></nav><div class="tocCollapsible_WMbj theme-doc-toc-mobile tocMobile_wI3e"><button type="button" class="clean-btn tocCollapsibleButton_rjEa">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Resource State Storage Design</h1></header>
<p>Use this template when authoring new design proposals or retrofitting existing notes. Fill out every section or state explicitly why it is not applicable. Replace bracketed guidance with project-specific detail before submitting for review. The structure is optimised for an AI-first delivery model where work is decomposed into issues and executed by autonomous agents under human orchestration.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="document-control">Document Control<a href="#document-control" class="hash-link" aria-label="Direct link to Document Control" title="Direct link to Document Control" translate="no">​</a></h2>
<ul>
<li class=""><strong>Title</strong>: Introduce struct-of-arrays resource storage for deterministic runtime state</li>
<li class=""><strong>Authors</strong>: Original design team</li>
<li class=""><strong>Reviewers</strong>: N/A</li>
<li class=""><strong>Status</strong>: Design</li>
<li class=""><strong>Last Updated</strong>: 2025-10-12</li>
<li class=""><strong>Related Issues</strong>: #7</li>
<li class=""><strong>Execution Mode</strong>: AI-led</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="1-summary">1. Summary<a href="#1-summary" class="hash-link" aria-label="Direct link to 1. Summary" title="Direct link to 1. Summary" translate="no">​</a></h2>
<p>This document defines the struct-of-arrays resource storage that anchors the runtime state model described in <code>docs/idle-engine-design.md</code> §6.2. Issue #7 tracks the initial <code>ResourceState</code> container responsible for storing all mutable resource quantities at runtime. The design focuses on deterministic updates, cache-friendly iteration, and snapshot ergonomics so downstream systems (production, upgrades, offline catch-up, UI diffing) can evolve without revisiting the underlying layout. A data-oriented, struct-of-arrays layout keeps iteration costs bounded as content packs scale and aligns with the performance strategy in <code>docs/idle-engine-design.md</code> §6.2.</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="2-context--problem-statement">2. Context &amp; Problem Statement<a href="#2-context--problem-statement" class="hash-link" aria-label="Direct link to 2. Context &amp; Problem Statement" title="Direct link to 2. Context &amp; Problem Statement" translate="no">​</a></h2>
<ul>
<li class=""><strong>Background</strong>: The <code>packages/core</code> exposes <code>setGameState</code>/<code>getGameState</code> helpers (<code>packages/core/src/runtime-state.ts</code>) but lacks an opinionated resource container. Commands targeting resources (<code>COLLECT_RESOURCE</code>, <code>PURCHASE_GENERATOR</code>) are defined but have no backing storage APIs. No snapshot contract exists for resource quantities; UI and persistence cannot consume structured deltas. Prior design docs commit to struct-of-arrays (<code>docs/idle-engine-design.md</code> §6.2) yet no implementation details exist.</li>
<li class=""><strong>Problem</strong>: The runtime needs a deterministic, cache-friendly storage solution for resource quantities that supports efficient mutation, aggregation, snapshotting, and serialization. Without this foundation, downstream systems cannot evolve independently.</li>
<li class=""><strong>Forces</strong>: Performance targets require cache-friendly iteration. Deterministic replay and save/restore require snapshot-friendly data structures. Content pack scaling requires O(1) lookups and bounded iteration costs.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="3-goals--non-goals">3. Goals &amp; Non-Goals<a href="#3-goals--non-goals" class="hash-link" aria-label="Direct link to 3. Goals &amp; Non-Goals" title="Direct link to 3. Goals &amp; Non-Goals" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="goals">Goals<a href="#goals" class="hash-link" aria-label="Direct link to Goals" title="Direct link to Goals" translate="no">​</a></h3>
<ul>
<li class=""><strong>Deterministic mutations:</strong> All adjustments flow through typed helpers that enforce caps, prevent negative balances, and emit telemetry on violations.</li>
<li class=""><strong>Struct-of-arrays layout:</strong> Store resource attributes in typed arrays to minimize cache misses during systems iteration and to simplify snapshotting.</li>
<li class=""><strong>Stable indexing:</strong> Provide a canonical resource index map shared by systems, command handlers, and serialization so lookups remain O(1).</li>
<li class=""><strong>Incremental deltas:</strong> Track per-tick changes so the runtime can publish minimal deltas to the presentation shell and replay logs.</li>
<li class=""><strong>Persistence-ready:</strong> Expose immutable snapshots compatible with the existing <code>CommandRecorder</code> structured clone workflow for deterministic save/restore.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="non-goals">Non-Goals<a href="#non-goals" class="hash-link" aria-label="Direct link to Non-Goals" title="Direct link to Non-Goals" translate="no">​</a></h3>
<ul>
<li class="">Implementing generator logic, upgrade modifiers, or automation scheduling.</li>
<li class="">Designing the content pipeline that emits resource/generator definitions.</li>
<li class="">Persisting save data to disk (handled by the snapshot and migration workstream).</li>
<li class="">Rendering UI views or formatting resource values for presentation.</li>
<li class="">Optimizing for multi-threaded mutation; the runtime remains single-threaded.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="4-stakeholders-agents--impacted-surfaces">4. Stakeholders, Agents &amp; Impacted Surfaces<a href="#4-stakeholders-agents--impacted-surfaces" class="hash-link" aria-label="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" title="Direct link to 4. Stakeholders, Agents &amp; Impacted Surfaces" translate="no">​</a></h2>
<ul>
<li class=""><strong>Primary Stakeholders</strong>: Runtime Core workstream</li>
<li class=""><strong>Agent Roles</strong>: Runtime Implementation Agent (responsible for implementing the storage layer), Docs Agent (for documentation updates)</li>
<li class=""><strong>Affected Packages/Services</strong>: <code>packages/core</code></li>
<li class=""><strong>Compatibility Considerations</strong>: Backward compatibility required for save file formats; API stability promises for public <code>ResourceState</code> interface.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="5-current-state">5. Current State<a href="#5-current-state" class="hash-link" aria-label="Direct link to 5. Current State" title="Direct link to 5. Current State" translate="no">​</a></h2>
<ul>
<li class=""><code>packages/core</code> exposes <code>setGameState</code>/<code>getGameState</code> helpers (<code>packages/core/src/runtime-state.ts</code>) but lacks an opinionated resource container.</li>
<li class="">Commands targeting resources (<code>COLLECT_RESOURCE</code>, <code>PURCHASE_GENERATOR</code>) are defined but have no backing storage APIs.</li>
<li class="">No snapshot contract exists for resource quantities; UI and persistence cannot consume structured deltas.</li>
<li class="">Prior design docs commit to struct-of-arrays (<code>docs/idle-engine-design.md</code> §6.2) yet no implementation details exist.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="6-proposed-solution">6. Proposed Solution<a href="#6-proposed-solution" class="hash-link" aria-label="Direct link to 6. Proposed Solution" title="Direct link to 6. Proposed Solution" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="61-architecture-overview">6.1 Architecture Overview<a href="#61-architecture-overview" class="hash-link" aria-label="Direct link to 6.1 Architecture Overview" title="Direct link to 6.1 Architecture Overview" translate="no">​</a></h3>
<p>The solution introduces a <code>ResourceState</code> façade that owns struct-of-arrays typed buffers internally while providing mutation and query helpers. The storage uses a double-buffered publish pattern to enable zero-copy snapshots while maintaining cache-friendly iteration performance. All mutations flow through the façade, ensuring capacity enforcement, dirty tracking, and telemetry emission.</p>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="62-detailed-design">6.2 Detailed Design<a href="#62-detailed-design" class="hash-link" aria-label="Direct link to 6.2 Detailed Design" title="Direct link to 6.2 Detailed Design" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="data-layout">Data Layout<a href="#data-layout" class="hash-link" aria-label="Direct link to Data Layout" title="Direct link to Data Layout" translate="no">​</a></h4>
<p>Introduce a <code>ResourceStateBuffers</code> struct encapsulating the underlying ArrayBuffers and typed arrays:</p>
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ResourcePublishBuffers</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> amounts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> capacities</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> incomePerSecond</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> expensePerSecond</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> netPerSecond</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> tickDelta</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> flags</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Uint8Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> dirtyTolerance</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> dirtyIndices</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Uint32Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dirtyCount</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ResourceStateBuffers</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> ids</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> indexById</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ImmutableMapSnapshot</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Live, mutating views</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> amounts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> capacities</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> incomePerSecond</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> expensePerSecond</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> netPerSecond</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> tickDelta</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> flags</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Uint8Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> dirtyTolerance</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Double-buffered publish views (ping-pong)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> publish</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ResourcePublishBuffers</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ResourcePublishBuffers</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> dirtyIndexScratch</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Uint32Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> dirtyIndexPositions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Int32Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ul>
<li class=""><code>ids</code>: canonical resource ordering derived from the active content pack.</li>
<li class=""><code>indexById</code>: <code>ImmutableMapSnapshot</code> for O(1) lookup that throws on any attempt to mutate it post-initialization.</li>
<li class=""><code>amounts</code>: current balances (double precision for cumulative accuracy).</li>
<li class=""><code>capacities</code>: hard caps enforced on mutation; populated from definitions and upgrade modifiers.</li>
<li class=""><code>incomePerSecond</code> / <code>expensePerSecond</code>: running totals populated by systems each tick to support production diagnostics and UI stat panels. These values are mirrored into the publish buffers before <code>resetPerTickAccumulators</code> clears the live arrays so rate changes survive the publish/reset cycle.</li>
<li class=""><code>netPerSecond</code>: derived buffer updated whenever rate accumulators change (and recomputed during <code>finalizeTick</code>) to avoid recomputing <code>income - expense</code> during reads.</li>
<li class=""><code>tickDelta</code>: tracks the signed delta applied during the current tick, enabling compact state diffs for the presentation layer and recorder.</li>
<li class=""><code>flags</code>: bit field storing boolean metadata. Bits are allocated as <code>VISIBLE = 1 &lt;&lt; 0</code>, <code>UNLOCKED = 1 &lt;&lt; 1</code>, and <code>DIRTY_THIS_TICK = 1 &lt;&lt; 2</code>. Mutation helpers set the dirty bit only when they apply a substantive change (amount, capacity, visibility, or net rates). Follow-up operations that restore parity with the published state clear the bit via <code>unmarkIfClean</code>, keeping the dirty list minimal heading into publish.</li>
<li class=""><code>dirtyTolerance</code>: per-resource tolerance ceiling (defaults to <code>DIRTY_EPSILON_CEILING</code>). When a resource definition supplies <code>dirtyTolerance</code>, the factory writes the normalized value (clamped to <code>&gt;= DIRTY_EPSILON_ABSOLUTE</code> and <code>&lt;= DIRTY_EPSILON_OVERRIDE_MAX</code>) into this buffer and <code>epsilonEquals</code> reads it instead of the default ceiling so prestige-scale resources can relax their tolerance without mutating global constants. The runtime treats these tolerances as immutable metadata outside initialization, hydration, or content reload flows, so dirty tracking deliberately ignores the field during per-tick mutation.</li>
<li class=""><code>publish</code>: pair of <code>ResourcePublishBuffers</code> used in a ping-pong pattern. Each buffer owns read-only copies of amounts, caps, per-second diagnostics, deltas, flags, tolerance ceilings, and the filtered list of dirty indices that back the most recent snapshot. <code>snapshot({ mode: &#x27;publish&#x27; })</code> writes into the inactive publish buffer and then flips the active pointer. Because only two publish buffers exist, the previous snapshot (the one created immediately before the current publish) remains isolated, but snapshots retained for more than one publish must deep-clone their data if they need to remain immutable. To keep clean resources aligned when buffers swap without replaying the entire buffer, the publish path replays the prior frame&#x27;s dirty indices into the inactive buffer before applying the new tick&#x27;s updates. The steps are:<!-- -->
<ol>
<li class="">Zero <code>targetPublish.tickDelta</code> only for indices recorded in either the previous publish&#x27;s dirty list or the current tick&#x27;s scratch union to avoid <code>O(resourceCount)</code> work when the dirty set is small.</li>
<li class="">Iterate the prefix of <code>sourcePublish.dirtyIndices</code> up to <code>sourcePublish.dirtyCount</code> and copy the corresponding slots (amounts, caps, rates, flags, tolerance) from <code>sourcePublish</code> into the inactive buffer so everything that moved last tick is already correct while leaving <code>tickDelta</code> at zero.</li>
<li class="">Apply the current tick&#x27;s dirty updates.
Resources that stay clean for two consecutive ticks never move, keeping the copy cost proportional to the union of the previous and current dirty sets instead of <code>O(resourceCount)</code>. Each publish buffer maintains a mutable <code>dirtyCount</code> that records how much of its <code>dirtyIndices</code> array is populated; the snapshot path zeroes this value before repopulating the list for the current tick.</li>
</ol>
</li>
<li class=""><code>dirtyIndexScratch</code>: reusable scratch space sized to <code>resourceCount</code>. The data structure stores a compact list of mutated indices during the tick without allocating new arrays.</li>
<li class=""><code>dirtyIndexPositions</code>: <code>Int32Array</code> mapping resource index → position inside the scratch prefix (or <code>-1</code> when absent). <code>markDirty</code> and <code>unmarkIfClean</code> consult this map to append and remove indices in O(1) while keeping the prefix densely packed. During publish passes the map may temporarily hold the sentinel value <code>-2</code> (<code>SCRATCH_VISITED</code>) while unioned loops are running; the loop restores the entry to <code>-1</code> before exiting so steady-state semantics remain unchanged.</li>
<li class=""><code>definitionDigest</code>: frozen record <code>{ ids, version, hash }</code> cached alongside the immutable id array so save systems can quickly confirm compatibility prior to hydration.</li>
</ul>
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ResourceDefinitionDigest</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> ids</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> version</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> hash</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>All live numeric buffers share a single <code>ArrayBuffer</code> per numeric width to improve serialization locality while keeping independent views disjoint. The Float64 views (<code>amounts</code>, <code>capacities</code>, <code>incomePerSecond</code>, <code>expensePerSecond</code>, <code>netPerSecond</code>, <code>tickDelta</code>, <code>dirtyTolerance</code>) are carved out of a backing buffer sized as <code>Float64Array.BYTES_PER_ELEMENT * 7 * resourceCount</code>. Each publish buffer owns its own Float64 <code>ArrayBuffer</code> sized for the copied views (covering all seven slices) so the runtime can flip between <code>publish[0]</code> and <code>publish[1]</code> without invalidating previously issued snapshots. Typed arrays are constructed with an offset stride where <code>stride = resourceCount * Float64Array.BYTES_PER_ELEMENT</code> (<code>amounts</code> at offset <code>0</code>, <code>capacities</code> at <code>1 * stride</code>, etc.). The scratch and position maps use dedicated <code>ArrayBuffer</code>s, as do the Uint8 flag bits for both live and publish views.</p>
<p>Comparisons between live and publish buffers run through <code>epsilonEquals(a, b)</code>, which treats two values as equivalent when</p>
<div class="language-text codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-text codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token plain">const magnitude = Math.max(Math.abs(a), Math.abs(b));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const tolerance = Math.max(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DIRTY_EPSILON_ABSOLUTE,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Math.min(toleranceCeiling, DIRTY_EPSILON_RELATIVE * magnitude),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return Math.abs(a - b) &lt;= tolerance;</span><br></span></code></pre></div></div>
<p>Comparisons short-circuit when operands are already identical (including matching <code>Infinity</code> sentinels) so resources that return to their prior state do not remain marked dirty after reconciliation.</p>
<p><code>toleranceCeiling</code> resolves per resource from the mutable <code>dirtyTolerance</code> buffer (defaulting to <code>DIRTY_EPSILON_CEILING</code> but allowed to grow up to <code>DIRTY_EPSILON_OVERRIDE_MAX</code>), ensuring the epsilon never exceeds the ceiling stored for that index.</p>
<p>Default constants:</p>
<ul>
<li class=""><code>DIRTY_EPSILON_ABSOLUTE = 1e-9</code> collapses near-zero jitter.</li>
<li class=""><code>DIRTY_EPSILON_RELATIVE = 1e-9</code> scales tolerance in proportion to value size.</li>
<li class=""><code>DIRTY_EPSILON_CEILING = 1e-3</code> serves as the default per-resource ceiling.</li>
<li class=""><code>DIRTY_EPSILON_OVERRIDE_MAX = 5e-1</code> bounds definition-supplied overrides so they can relax tolerance for prestige-scale resources without letting massive deltas slip through unchecked while still covering magnitude ranges up to approximately <code>1e15</code> without keeping resources perpetually dirty.</li>
</ul>
<p>If specific resources require looser tolerances (e.g., prestige currencies with huge exponential growth), the content definition may optionally supply a <code>dirtyTolerance</code> override that the factory stores alongside the resource index; <code>epsilonEquals</code> then reads the per-resource ceiling (capped only by <code>DIRTY_EPSILON_OVERRIDE_MAX</code>). Telemetry records the raw comparisons whenever the override saturates so balancing can adjust the configuration before release. When this occurs the runtime emits <code>ResourceDirtyToleranceSaturated</code> with <code>{ resourceId, field, difference, toleranceCeiling, relativeTolerance, magnitude }</code> so analytics and balancing pipelines have the full context.</p>
<p><code>ImmutableMapSnapshot</code> is already provided by <code>packages/core/src/immutable-snapshots.ts</code> and proxies mutation methods so the lookup table cannot be altered after the state is created.</p>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="runtime-api-surface">Runtime API Surface<a href="#runtime-api-surface" class="hash-link" aria-label="Direct link to Runtime API Surface" title="Direct link to Runtime API Surface" translate="no">​</a></h4>
<p>Expose a <code>ResourceState</code> façade that owns the buffers internally while providing mutation and query helpers:</p>
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ResourceState</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">getIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">requireIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">getAmount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">getCapacity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">getNetPerSecond</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">isUnlocked</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">isVisible</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">grantVisibility</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">setCapacity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> capacity</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">addAmount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> amount</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">spendAmount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    amount</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ResourceSpendAttemptContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">applyIncome</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> amountPerSecond</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">applyExpense</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> amountPerSecond</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">finalizeTick</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">deltaMs</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">resetPerTickAccumulators</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">forceClearDirtyState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">clearDirtyScratch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">snapshot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> mode</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;publish&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;recorder&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ResourceStateSnapshot</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">exportForSave</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SerializedResourceState</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">getDefinitionDigest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ResourceDefinitionDigest</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ul>
<li class="">The module retains the <code>ResourceStateBuffers</code> reference inside a closure so external callers can only mutate state through the façade. Instrumentation or diagnostics that need raw access live in the same module and never receive a public reference to the mutable typed arrays.</li>
<li class="">Mutation helpers return the actual delta applied to support downstream bookkeeping.</li>
<li class=""><code>requireIndex(id)</code> wraps <code>getIndex</code> with an invariant check that throws and emits telemetry when presented with an unknown id. Index-based helpers call an internal <code>assertValidIndex(index)</code> guard so typed arrays never absorb silent out-of-bounds writes.</li>
<li class="">A private <code>markDirty(index: number)</code> helper ensures each index is tracked only once per tick. It consults the <code>DIRTY_THIS_TICK</code> bit and <code>dirtyIndexPositions</code> map before pushing into the scratch prefix, then records the assigned slot so future checks stay O(1). Every entry in <code>dirtyIndexPositions</code> is initialized to <code>-1</code>; the first call to <code>markDirty</code> writes the index into <code>dirtyIndexScratch</code> at position <code>dirtyIndexCount</code>, persists that position inside the map, and increments the count. The helper is invoked only after confirming the live state and the active publish buffer fail <code>epsilonEquals</code> for any tracked field (amount, capacity, income, expense, net, or flags). If a later mutation restores parity and <code>epsilonEquals</code> returns true again, <code>unmarkIfClean(index)</code> reads the stored slot, swaps the tail entry into place, updates both impacted <code>dirtyIndexPositions</code> entries (the restored index and the swapped tail), clears the dirty bit, and writes <code>-1</code> back into the map. The publish pass introduces a second sentinel (<code>SCRATCH_VISITED = -2</code>) while it performs unioned work over previous/current dirty sets, then restores the map to <code>-1</code> afterward. Zero-delta work therefore never leaks into the publish pipeline and the scratch prefix always remains densely packed without allocations.</li>
<li class="">To prevent callers from skipping the epsilon/dirty bookkeeping, every façade helper routes writes through <code>updateFloatField(index, field, nextValue)</code> and <code>updateFlagField(index, mask, shouldSet)</code> utilities defined inside the module. These helpers centralize the <code>epsilonEquals</code> comparison, dirty bit toggling, and <code>dirtyIndexPositions</code> maintenance so individual mutators cannot drift out of sync.</li>
<li class="">Internal maintenance code uses <code>writeAmountDirect(index, amount)</code> to bypass capacity clamping during save restore or migrations. The helper is not part of the public façade and is only callable from privileged modules in the same file so gameplay code must go through <code>addAmount</code>. For tooling, the module exposes an opt-in escape hatch <code>__unsafeWriteAmountDirect(state, index, amount)</code> that routes through the same helper; callers are expected to guard their inputs and remain confined to hydration/migration flows.</li>
<li class=""><code>finalizeTick(deltaMs)</code> converts accumulated per-second rates into a proposed delta, clamps amounts to capacities/zero, recomputes <code>netPerSecond</code>, and relies on <code>markDirty</code> + <code>unmarkIfClean</code> to ensure only indices with meaningful divergence remain dirty at the end of the tick (cancelling incomes/expenses do not surface spurious deltas). The conversion uses <code>deltaSeconds = deltaMs / 1_000</code>, computes <code>incomeDelta = incomePerSecond * deltaSeconds</code>, <code>expenseDelta = expensePerSecond * deltaSeconds</code>, and derives a tentative <code>appliedDelta = incomeDelta - expenseDelta</code>. After clamping the live amount into <code>[0, capacity]</code>, we recompute the <code>actualDelta = clampedAmount - previousAmount</code> and calculate <code>nextTickDelta = tickDelta[index] + actualDelta</code>. When <code>epsilonEquals(nextTickDelta, 0)</code> succeeds we reset <code>tickDelta[index] = 0</code>; otherwise we assign the computed <code>nextTickDelta</code>. We never clear an existing non-zero <code>tickDelta</code> unless the combined value reconciles to ~0 so earlier frame work (e.g., capacity adjustments or direct grants) survives the finalize pass. Dirty bookkeeping and telemetry always use <code>actualDelta</code> so resources that hit their cap/zero do not remain in the dirty set indefinitely. Callers must pass a finite, non-negative <code>deltaMs</code>; otherwise telemetry emits <code>ResourceFinalizeInvalidDelta</code> and the helper throws before mutating any buffers, preventing clock drift or <code>NaN</code> propagation from corrupting state.</li>
<li class=""><code>resetPerTickAccumulators()</code> clears the live <code>incomePerSecond</code>, <code>expensePerSecond</code>, and <code>tickDelta</code> arrays after publish while leaving the publish buffers untouched thanks to the ping-pong double buffering. It does <strong>not</strong> zero <code>netPerSecond</code>; that value remains valid until the next <code>finalizeTick</code> so systems sampling immediately after publish observe the most recent rates. The helper asserts that <code>snapshot({ mode: &#x27;publish&#x27; })</code> has already executed during the current tick (tracked via an internal boolean toggled by the snapshot path); calling it out of order throws and logs telemetry because clearing the accumulators before publish would erase the tick delta that the UI expects to consume.</li>
<li class=""><code>clearDirtyScratch()</code> clears residual dirty metadata and associated flag bits after authoritative calls to <code>snapshot({ mode: &#x27;publish&#x27; })</code> complete (the snapshot path itself resets the scratch length to zero). For rare flows that intentionally skip publish (e.g. deterministic test harnesses comparing recorder snapshots) the module exposes <code>forceClearDirtyState()</code> which performs the same scratch reset and clears <code>incomePerSecond</code>, <code>expensePerSecond</code>, and <code>tickDelta</code> under an internal &quot;publish skipped&quot; guard. Callers must invoke <code>forceClearDirtyState()</code> instead of <code>resetPerTickAccumulators()</code> in that scenario so rate accumulators do not desynchronise. Production code relies on <code>snapshot({ mode: &#x27;publish&#x27; })</code> instead of calling either helper directly.</li>
<li class=""><code>getDefinitionDigest()</code> returns the frozen <code>{ ids, version, hash }</code> payload recorded during initialization so save serializers can embed it and hydration routines can check compatibility before replaying data.</li>
<li class=""><code>snapshot(options)</code> defaults to <code>{ mode: &#x27;publish&#x27; }</code>. Callers opt into recorder mode explicitly so accidental captures do not skip the publish reset.</li>
</ul>
<p>The façade tracks the active length in a <code>dirtyIndexCount</code> field; the valid portion of <code>dirtyIndexScratch</code> lives in <code>[0, dirtyIndexCount)</code>. Mutations append indices only when the dirty bit transitions from clear to set, guaranteeing that each index appears at most once per tick without extra allocations. Whenever the list changes, <code>dirtyIndexPositions</code> keeps the index ↔ position mapping in sync so removals and parity-driven unmarks stay constant time even in the hot path.</p>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="initialization--lifecycle">Initialization &amp; Lifecycle<a href="#initialization--lifecycle" class="hash-link" aria-label="Direct link to Initialization &amp; Lifecycle" title="Direct link to Initialization &amp; Lifecycle" translate="no">​</a></h4>
<p>Provide a factory <code>createResourceState(defs: readonly ResourceDefinition[])</code> that:</p>
<ol>
<li class="">Validates incoming definitions without reordering so designer-authored order is preserved and surfaces deterministically in presentation. The content pack compiler guarantees a stable array order; the factory verifies uniqueness by inserting ids into a <code>Set</code> and throws on duplicates.</li>
<li class="">Allocates typed arrays sized to the resource count. Initialization passes each definition through <code>sanitizeInitialResourceValues</code>, which clamps <code>startAmount</code> into <code>[0, capacity]</code>, rejects <code>NaN</code>/non-finite input with a telemetry event and thrown error, and logs + clamps negative values to <code>0</code> or overshoot values down to the capacity. The sanitized amounts populate both the live <code>amounts</code> array and the mirrored publish buffers. Capacities default to <code>Number.POSITIVE_INFINITY</code> when unspecified (and populate both publish views) so the initial snapshot requires no additional copying. The retainers track the active publish buffer index (<code>0</code> at bootstrap) and mark the standby buffer ready for the next tick, clearing each publish buffer&#x27;s <code>dirtyCount</code> to <code>0</code>. The save serializer treats <code>Number.POSITIVE_INFINITY</code> as <code>null</code> to avoid lossy JSON round-trips.</li>
<li class="">Initializes <code>flags</code> with <code>VISIBLE | UNLOCKED</code> for starting resources and zero for locked ones.</li>
<li class="">Populates <code>dirtyTolerance[index]</code> with the sanitized tolerance from the definition (if provided) or <code>DIRTY_EPSILON_CEILING</code>. Sanitization clamps the tolerance between <code>DIRTY_EPSILON_ABSOLUTE</code> and <code>DIRTY_EPSILON_OVERRIDE_MAX</code>, and each publish buffer stores the same scalar so comparison logic receives a per-resource ceiling regardless of which buffer is active. Overrides that land above the default ceiling but within the max let prestige-scale resources relax their noise floor deterministically.</li>
<li class="">Wraps <code>ids</code> in <code>Object.freeze</code> and converts the <code>indexById</code> lookup table into an <code>ImmutableMapSnapshot</code> via the existing <code>enforceImmutable(...)</code> helper so any attempt to mutate it throws at runtime.</li>
<li class="">Seeds the <code>dirtyIndexScratch</code> array with a sentinel length counter of <code>0</code> (tracked separately inside the façade) and fills <code>dirtyIndexPositions</code> with <code>-1</code> so the first mutation appends in-place without additional setup.</li>
<li class="">Emits a <code>ResourceDefinitionDigest</code> record <code>{ ids, version, hash }</code> so save restores can verify content compatibility before hydrating. When hydrating a save the runtime invokes <code>reconcileSaveAgainstDefinitions(savedIds, defs)</code> which produces a mapping from save index → live index, reports removed/added ids, and throws if a referenced id no longer exists. Mismatches surface telemetry (<code>ResourceHydrationMismatch</code>) and fail fast instead of silently dropping data; future migrations can hook into this reconciliation step to map old ids onto new ones.</li>
</ol>
<p>On content reload or save restore, callers reuse the factory with definitions and then hydrate numeric buffers from persisted data. <code>reconcileSaveAgainstDefinitions</code> drives the process: it verifies payload array lengths, produces a remapping from save indices to live indices, and rejects any out-of-band data. Hydration iterates the remapping, writes restored amount/capacity values and flag bits into both the live and publish typed arrays, zeros <code>incomePerSecond</code>, <code>expensePerSecond</code>, <code>netPerSecond</code>, and <code>tickDelta</code> in both views, and clears the dirty scratch counter so the next <code>snapshot({ mode: &#x27;publish&#x27; })</code> immediately reflects the restored state without forcing a full-tick recomputation. Until the first post-restore tick runs the UI should expect rate diagnostics to read as zero; the follow-up finalize recomputes rates deterministically. The runtime stores the <code>ResourceState</code> inside the broader game state object managed by <code>setGameState(...)</code>; systems recompute per-second rates on the very next tick using the hydrated amounts. Save restore and migration utilities invoke the internal <code>writeAmountDirect</code> helper during this process so they can place values that temporarily exceed caps before the relevant upgrades reapply. Immediately after hydration the engine reapplies content-defined capacities/upgrades and only then schedules the next <code>finalizeTick</code>. This ordering ensures overshoot values survive long enough for upgrade modifiers to recreate the higher caps; if no modifier reinstates a wider cap before finalize executes, the clamp (and corresponding telemetry) makes the data loss explicit to designers.</p>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="mutation-semantics">Mutation Semantics<a href="#mutation-semantics" class="hash-link" aria-label="Direct link to Mutation Semantics" title="Direct link to Mutation Semantics" translate="no">​</a></h4>
<ul>
<li class=""><strong>Additions:</strong> <code>addAmount</code> increases <code>amounts[index]</code> while always clamping to capacity. Negative input throws to catch misuse; callers use <code>spendAmount</code> for decrements. If the applied delta resolves to zero (e.g. already at cap or the caller adds <code>0</code>), the helper returns <code>0</code> and avoids calling <code>markDirty</code>. When the applied delta is non-zero, it accumulates into <code>tickDelta[index]</code> and <code>markDirty</code> tracks the index exactly once for the tick. Internal maintenance utilities (migrations, save restore) use a private <code>writeAmountDirect</code> helper that bypasses the clamp, never the public façade, so gameplay code cannot accidentally overshoot capacities.</li>
<li class=""><strong>Spending:</strong> <code>spendAmount</code> verifies <code>amounts[index] &gt;= amount</code> before subtracting. It returns <code>true/false</code> to signal insufficient resources and never allows negative balances. Successful spends subtract from both <code>amounts[index]</code> and <code>tickDelta[index]</code>, then call <code>markDirty</code>. If the spend later gets cancelled by a compensating <code>addAmount</code> before publish, the helper calls <code>unmarkIfClean</code> once the live values satisfy <code>epsilonEquals</code> with the publish buffer, dropping the index from the scratch list. When spending fails, telemetry records a <code>ResourceSpendFailed</code> event with the offending command/system id (when supplied via <code>ResourceSpendAttemptContext</code>) and the guard throws if the caller attempts to subtract a negative amount.</li>
<li class=""><strong>Per-second accumulation:</strong> Systems call <code>applyIncome</code> / <code>applyExpense</code> during their tick. Inputs must be finite (<code>Number.isFinite</code>) and non-negative; attempts to submit negative, <code>NaN</code>, or infinite rates log telemetry and throw. Each helper adds to (<code>+=</code>) <code>incomePerSecond[index]</code> and <code>expensePerSecond[index]</code>, allowing multiple systems to compose within a single frame. The helpers also keep <code>netPerSecond[index]</code> in sync immediately so shells can read <code>getNetPerSecond</code> without requiring <code>finalizeTick</code> in integrations that want to display live rates. Systems that queue rates (for example, <code>createProductionSystem({ applyViaFinalizeTick: true })</code>) rely on <code>finalizeTick</code> to roll accumulated income/expense into balances. Helpers ignore zero-valued inputs and mark the resource dirty only when the accumulator fails <code>epsilonEquals</code> against the most recent publish buffer. If opposing calls cancel each other within the same tick, <code>unmarkIfClean</code> clears the dirty flag once the accumulators drift back inside the epsilon band and the previously published buffer retains the prior rates. Because the per-second fields are additive, publish flows must call <code>resetPerTickAccumulators()</code> once per tick after <code>snapshot({ mode: &#x27;publish&#x27; })</code> to avoid rates accumulating across ticks.</li>
<li class=""><strong>Capacity updates:</strong> <code>setCapacity</code> validates the requested capacity (must be <code>&gt;= 0</code>, not <code>NaN</code>; <code>Infinity</code> is permitted to represent uncapped resources) before writing into the buffer. Invalid values log telemetry and throw. On success the helper clamps the current amount if it now exceeds the cap (recording that clamp as a delta in <code>tickDelta</code>), calls <code>markDirty</code>, and returns the applied cap so command handlers can publish diffs. The subsequent publish copies the new cap into the active publish buffer.</li>
<li class=""><strong>Visibility/unlock:</strong> <code>grantVisibility</code> and <code>unlock</code> set bits inside the flag buffer and mark the resource dirty so the UI is notified.</li>
</ul>
<p>Dirty tracking (flag bit <code>0b100</code>) is cleared inside <code>snapshot({ mode: &#x27;publish&#x27; })</code> only after the live values and flag bits have been copied into the publish buffers. The same loop clears the bit in both the live flag array (so subsequent mutations have to re-mark the resource) and the publish copy (by masking the bit before exposure). Clearing the bit at this point keeps the underlying live buffers mutable while guaranteeing the published snapshot remains immutable.</p>
<p>Every index-based helper calls <code>assertValidIndex(index)</code>, which verifies <code>index &gt;= 0 &amp;&amp; index &lt; resourceCount</code>, logs a <code>ResourceIndexViolation</code> telemetry event, and throws when the guard fails. Command handlers invoke <code>requireIndex</code> so the guard fires at lookup time rather than after a mutation attempt.</p>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="snapshot--persistence">Snapshot &amp; Persistence<a href="#snapshot--persistence" class="hash-link" aria-label="Direct link to Snapshot &amp; Persistence" title="Direct link to Snapshot &amp; Persistence" translate="no">​</a></h4>
<ul>
<li class=""><code>snapshot({ mode: &#x27;publish&#x27; })</code> returns a read-only-by-contract view (<code>ResourceStateSnapshot</code>) containing:<!-- -->
<ul>
<li class=""><code>ids</code> (frozen array).</li>
<li class="">Direct references to the publish buffer&#x27;s typed arrays. To keep cache-friendly hot reads intact we still hand out the live views, but the runtime installs a lightweight <code>createImmutableTypedArrayView(...)</code> wrapper over each view in non-production builds. The wrapper traps mutators, forwards safe reads, and throws when a consumer attempts to write. Production builds may disable the guard by clearing <code>SNAPSHOT_GUARDS</code>, but tests and development builds force it on by default so accidental mutations cannot corrupt determinism. The flag now supports three modes: <code>&#x27;auto&#x27;</code> (default; enabled for <code>NODE_ENV !== &#x27;production&#x27;</code>), <code>&#x27;force-on&#x27;</code>, and <code>&#x27;force-off&#x27;</code>, giving automation harnesses explicit control. Guarded views share their backing buffer with the publish arrays so the check costs a single proxy allocation per field rather than deep cloning; structured cloning paths use recorder mode instead.</li>
<li class="">The typed arrays surface only to same-thread consumers. Cross-thread transport happens through the <code>ResourcePublishTransport</code> (see below); attempting to <code>postMessage</code> a <code>ResourceStateSnapshot</code> is unsupported and intentionally undocumented in the runtime API.</li>
<li class="">A compact list of dirty indices for the current tick. Consumers read the shared <code>Uint32Array</code> prefix <code>[0, dirtyCount)</code> and must ignore unused capacity beyond that point; the array remains read-only by contract just like the other typed views.</li>
<li class="">Flag bits encoded as a read-only <code>Uint8Array</code> snapshot sourced from <code>targetPublish.flags</code>.</li>
</ul>
</li>
</ul>
<p>The publish snapshot type is therefore:</p>
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ResourceStateSnapshot</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> ids</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> amounts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> capacities</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> incomePerSecond</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> expensePerSecond</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> netPerSecond</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> tickDelta</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> flags</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Uint8Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> dirtyTolerance</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Float64Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> dirtyIndices</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Uint32Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> dirtyCount</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>The TypeScript surface marks these arrays as <code>readonly</code> to call out the contract. In <code>&#x27;auto&#x27;</code>/<code>&#x27;force-on&#x27;</code> guard modes the runtime swaps each typed array reference for the immutable proxy returned by <code>createImmutableTypedArrayView(...)</code>, keeping the same underlying buffer while disallowing writes in development and test environments. Recorder mode returns the same interface, but the arrays are deep-cloned and own their backing buffers regardless of guard configuration so structured cloning cannot observe shared state.</p>
<ul>
<li class="">
<p><code>snapshot({ mode: &#x27;recorder&#x27; })</code> returns the same shape but clones its data into ephemeral typed arrays owned by the recorder call site (amount, capacity, income, expense, net, tick delta, flags, tolerance). This mode does not touch dirty bookkeeping, publish mirrors, or per-tick accumulators, allowing pre/post-command captures without interfering with the presentation pipeline. The full-clone approach is <code>O(resourceCount)</code> per capture; for now we accept the overhead because command executions are infrequent in deterministic tests. If the workload proves heavier, future work can explore reusing the inactive publish buffer with reference counting or capturing only the dirty indices plus a shared frozen baseline. Recorder-mode clones remain structured-clone friendly, so tooling can persist them or ship them across worker boundaries without additional conversion.</p>
</li>
<li class="">
<p><code>exportForSave()</code> returns a POJO suitable for persistence:</p>
</li>
</ul>
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">SerializedResourceState</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> ids</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> amounts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> capacities</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">number</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> unlocked</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> visible</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> flags</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> definitionDigest</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ResourceDefinitionDigest</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> automationState</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> SerializedAutomationState</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ResourceSpendAttemptContext</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> commandId</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> systemId</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Offline catch-up consumes <code>SerializedResourceState</code>, rehydrates the live typed arrays, and continues deterministic execution. The save payload intentionally omits per-second income/expense data because they are tick-scoped diagnostics; the runtime zeros those buffers (both live and publish views) on restore and regenerates fresh rates during the next tick.</p>
<p><code>flags</code> mirrors the raw bit mask so future toggle bits survive round-trips even when older clients do not understand them. The optional <code>unlocked</code> and <code>visible</code> arrays remain for ergonomic access in content tooling; when provided they must stay in sync with the bit mask. <code>reconcileSaveAgainstDefinitions</code> validates that every array matches the <code>ids.length</code> (<code>flags.length</code> must also match) and throws <code>ResourceSaveLengthMismatch</code> when they do not; telemetry captures the offending metadata. During rehydration the module trusts <code>flags</code> as the single source of truth, rebuilding the convenience arrays from the mask so the emitted snapshot always reflects the authoritative bits.</p>
<p><strong>Automation State Serialization:</strong></p>
<p>The <code>automationState</code> field contains serialized automation state entries. Each entry uses <code>SerializedAutomationState</code> format where <code>lastFiredStep</code> is <code>number | null</code> (null represents <code>-Infinity</code> for JSON compatibility). During <code>exportForSave()</code>, the runtime converts <code>AutomationState.lastFiredStep</code> values of <code>-Infinity</code> to <code>null</code>. During restoration via <code>restoreState()</code>, <code>null</code> values are converted back to <code>-Infinity</code>.</p>
<p>See <code>docs/automation-system-api.md</code> for details on <code>SerializedAutomationState</code> and <code>restoreState()</code>.</p>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="dual-mode-progression-snapshot-support-existing-implementation">Dual-Mode Progression Snapshot Support (Existing Implementation)<a href="#dual-mode-progression-snapshot-support-existing-implementation" class="hash-link" aria-label="Direct link to Dual-Mode Progression Snapshot Support (Existing Implementation)" title="Direct link to Dual-Mode Progression Snapshot Support (Existing Implementation)" translate="no">​</a></h4>
<blockquote>
<p><strong>Note</strong>: This subsection documents <strong>existing progression snapshot behavior</strong> as shipped in PR #303 (<code>packages/core/src/progression.ts:138-214</code>). This is retroactive documentation of production code.</p>
</blockquote>
<p>The <code>buildProgressionSnapshot()</code> function supports <strong>dual-mode snapshot generation</strong>, consuming either live <code>ResourceState</code> or serialized <code>SerializedResourceState</code> to build UI-ready <code>ProgressionSnapshot</code> data. This enables both runtime snapshot publishing and save file preview.</p>
<p><strong>Live State Mode</strong>:</p>
<p>When <code>ProgressionAuthoritativeState.resources.state</code> contains a live <code>ResourceState</code> instance:</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> snapshot </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">snapshot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> mode</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;publish&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> resourceView </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> resourceId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  displayName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> metadata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resourceId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">displayName </span><span class="token operator" style="color:#393A34">??</span><span class="token plain"> resourceId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  amount</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> snapshot</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">amounts</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  capacity</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> snapshot</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">capacities</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  isUnlocked</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">snapshot</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UNLOCKED_BIT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  isVisible</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">snapshot</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VISIBLE_BIT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  perSecond</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getNetPerSecond</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  perTick</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getNetPerSecond</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stepDurationMs </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Live rate data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p><strong>Serialized State Mode</strong>:</p>
<p>When <code>ProgressionAuthoritativeState.resources.serialized</code> contains <code>SerializedResourceState</code> (during save preview or session restore):</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> serialized </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resources</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serialized</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> resourceView </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> serialized</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ids</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  displayName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> metadata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">serialized</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ids</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">displayName </span><span class="token operator" style="color:#393A34">??</span><span class="token plain"> serialized</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ids</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  amount</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> serialized</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">amounts</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  capacity</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> serialized</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">capacities</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">??</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">Infinity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  isUnlocked</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> serialized</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unlocked</span><span class="token operator" style="color:#393A34">?.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">??</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  isVisible</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> serialized</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">visible</span><span class="token operator" style="color:#393A34">?.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">??</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  perSecond</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// No rate data in serialized state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  perTick</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// No rate data in serialized state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p><strong>Key Differences</strong>:</p>
<table><thead><tr><th>Aspect</th><th>Live State Mode</th><th>Serialized State Mode</th></tr></thead><tbody><tr><td><strong>Data Source</strong></td><td><code>ResourceState.snapshot({ mode: &#x27;publish&#x27; })</code></td><td><code>SerializedResourceState</code> from save file</td></tr><tr><td><strong>Rate Data</strong></td><td><code>perSecond</code> from <code>getNetPerSecond()</code>, <code>perTick = perSecond * (stepDurationMs / 1000)</code></td><td><code>perSecond = 0</code>, <code>perTick = 0</code> (rates not persisted)</td></tr><tr><td><strong>Flag Access</strong></td><td>Bit masks from <code>snapshot.flags</code> typed array</td><td>Boolean arrays <code>unlocked</code>/<code>visible</code></td></tr><tr><td><strong>Capacity</strong></td><td>Live typed array value</td><td>POJO number array with <code>null</code> → <code>Infinity</code></td></tr><tr><td><strong>Use Case</strong></td><td>Runtime worker snapshot publishing</td><td>Save file preview, session hydration</td></tr></tbody></table>
<p><strong>Implementation</strong>:</p>
<p>The snapshot builder detects which mode to use by checking for live state first:</p>
<div class="language-typescript codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-typescript codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// packages/core/src/progression.ts:146-211</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> liveState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resources</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> serializedState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resources</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">serialized</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">liveState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Live mode: use ResourceState snapshot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> snapshot </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> liveState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">snapshot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> mode</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;publish&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Build resource views from typed arrays...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">serializedState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Serialized mode: use save file data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Build resource views from POJO arrays...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Rationale</strong>:</p>
<p>Dual-mode support enables:</p>
<ul>
<li class=""><strong>Runtime publishing</strong>: Worker emits progression snapshots every tick using live state</li>
<li class=""><strong>Save preview</strong>: UI can display save file contents without loading into live runtime</li>
<li class=""><strong>Session restoration</strong>: Initial snapshot after hydration uses serialized state before first tick</li>
<li class=""><strong>Consistent UI contract</strong>: Both modes produce identical <code>ProgressionSnapshot</code> structure</li>
</ul>
<p><strong>Integration</strong>:</p>
<ol>
<li class=""><strong>Worker Runtime</strong>: Calls <code>buildProgressionSnapshot()</code> with live coordinator state after each tick (archived worker harness behavior)</li>
<li class=""><strong>Session Restore</strong>: Initial snapshot uses serialized state from save file before coordinator rehydrates (archived worker harness behavior)</li>
<li class=""><strong>Save Preview</strong> (future): Tooling can display save file contents by passing <code>SerializedResourceState</code> directly</li>
</ol>
<p><strong>Implementation Reference</strong>:</p>
<ul>
<li class="">Dual-mode snapshot builder: <code>packages/core/src/progression.ts:138-214</code></li>
<li class="">Live state path: <code>packages/core/src/progression.ts:146-176</code></li>
<li class="">Serialized state path: <code>packages/core/src/progression.ts:178-211</code></li>
<li class="">Integration in worker (archived)</li>
</ul>
<p>Consumers should continue to respect the dirty index list when emitting deltas, and because the publish path zeros <code>targetPublish.tickDelta</code> only for the explicitly dirty candidates (step 1 below), a resource that resolves to clean state never exposes a stale delta. Comparisons reuse the shared <code>epsilonEquals</code> helper, meaning near-zero differences neither propagate into the publish buffer nor keep indices marked dirty.</p>
<p>During <code>snapshot({ mode: &#x27;publish&#x27; })</code> the runtime selects the inactive publish buffer (<code>targetPublish</code>) and records the current active buffer as <code>sourcePublish</code>. Rather than cloning the entire snapshot, the runtime reapplies just the slots that may have diverged while <code>targetPublish</code> sat idle:</p>
<ol>
<li class="">Visit the prior publish&#x27;s dirty list and the current tick&#x27;s scratch prefix in turn, zeroing <code>targetPublish.tickDelta</code> for each unique index. We reuse <code>dirtyIndexPositions</code> to skip duplicates: before the pass we write a sentinel (<code>SCRATCH_VISITED = -2</code>) into <code>dirtyIndexPositions[index]</code> for every index we touch, and we skip further work whenever an index already equals that sentinel. After the pass the loop restores <code>dirtyIndexPositions[index] = -1</code>, so the map is ready for the copy stage without allocating additional sets or arrays. No concatenation or temporary buffers are required and the work remains proportional to the dirty set.</li>
<li class="">Compute <code>previousDirtyCount = sourcePublish.dirtyCount</code> and iterate the prefix <code>sourcePublish.dirtyIndices[0..previousDirtyCount)</code>, copying the corresponding amount/capacity/rate/flag entries from <code>sourcePublish</code> into <code>targetPublish</code> while leaving their <code>tickDelta</code> at zero. This guarantees the inactive buffer matches the authoritative snapshot for everything that changed last tick.</li>
<li class="">Reset <code>targetPublish.dirtyCount = 0</code> and capture the current <code>dirtyIndexCount</code> into a local <code>scratchCount</code>; the scratch array contents remain intact until the loop finishes.</li>
<li class="">Iterate the first <code>scratchCount</code> entries in <code>dirtyIndexScratch</code>, compare each candidate against <code>sourcePublish</code> using the epsilon test, and write the live values (amount, capacity, income, expense, net, tick delta, flags, tolerance) into <code>targetPublish</code> when they diverge. <code>dirtyTolerance</code> only changes during initialization, hydration, or content reload flows; the tick loop never mutates it, so the comparison normally short-circuits unless a tooling action explicitly updates the buffer. The flag copy masks out the engine-only <code>DIRTY_THIS_TICK</code> bit so consumers never observe internal bookkeeping. Slots that converge leave the live <code>tickDelta</code> untouched so recorder snapshots captured immediately after publish still observe the accumulated delta; they simply skip the dirty list. <code>resetPerTickAccumulators()</code> (or <code>forceClearDirtyState()</code>) remains responsible for clearing the live accumulator once consumers finish reading it.</li>
</ol>
<p>For each surviving index we write it into <code>targetPublish.dirtyIndices[targetPublish.dirtyCount++]</code> and mark <code>dirtyIndexPositions[index] = -1</code> so the next tick appends from a clean slate. After the loop the runtime flips <code>activePublishIndex</code>, exposes the read-only views, sets <code>dirtyIndexCount = 0</code>, and walks both the <code>previousDirtyCount</code> and <code>scratchCount</code> ranges to ensure every corresponding <code>dirtyIndexPositions</code> entry is <code>-1</code> (debug builds may also zero the scratch slots for readability). Because consumers read from the now-active publish buffer only, later mutations operate on the live arrays and the alternate publish buffer without affecting the snapshot in circulation. <code>clearDirtyScratch()</code> remains an escape hatch for test harnesses that need to force-reset live buffers without emitting a snapshot.</p>
<h4 class="anchor anchorTargetStickyNavbar_EdDC" id="integration-points">Integration Points<a href="#integration-points" class="hash-link" aria-label="Direct link to Integration Points" title="Direct link to Integration Points" translate="no">​</a></h4>
<ul>
<li class=""><strong>Command handlers:</strong> <code>COLLECT_RESOURCE</code> routes through <code>addAmount</code>, <code>PURCHASE_GENERATOR</code> and future <code>APPLY_MODIFIER</code> commands use <code>spendAmount</code> and <code>setCapacity</code>. All handlers include resource ids to translate into indices via <code>requireIndex</code>, ensuring invalid content references surface as telemetry.</li>
<li class=""><strong>Systems:</strong> Production, automation, and prestige systems receive the shared <code>ResourceState</code> instance on registration. Each system operates on indices rather than ids for tight loops; helper utilities resolve ids only during initialization.</li>
<li class=""><strong>Telemetry:</strong> The resource module records events via the existing <code>telemetry</code> facade (<code>TelemetryEventData</code>) for invalid operations, capacity clamping, overflow detection, and comparisons that saturate a resource&#x27;s dirty tolerance ceiling. Metrics aggregate per-second income/expense totals for diagnostics dashboards.</li>
<li class=""><strong>Presentation bridge:</strong> When publishing state to the UI, the runtime emits either the full snapshot (initial load) or a delta referencing dirty indices with updated <code>amount</code>, <code>capacity</code>, per-second rates, <code>netPerSecond</code>, and <code>visibility</code> flags. Before calling <code>worker.postMessage</code> the bridge converts the immutable typed-array views into a <code>ResourcePublishTransport</code> built from a pooled set of transferable slabs sized exactly to <code>dirtyCount</code>. Each field is copied with a tight <code>Float64Array</code>/<code>Uint8Array</code> whose length equals the number of dirty indices, meaning the transport cost grows with the delta rather than <code>resourceCount</code>. Slabs come from a <code>TransportBufferPool</code> so the runtime reuses <code>ArrayBuffer</code>s across frames; the pool guarantees buffers are detached only after the worker acknowledges receipt.</li>
</ul>
<p>The transport contract is versioned (<code>version: 2</code>) and self-describing:</p>
<div class="language-ts codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-ts codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">TransportComponent</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amounts&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;capacities&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;incomePerSecond&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;expensePerSecond&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;netPerSecond&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;tickDelta&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;flags&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;dirtyTolerance&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">TransportBufferDescriptor</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> component</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TransportComponent</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> ctor</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Float64Array&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Uint8Array&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> buffer</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ArrayBuffer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> byteOffset</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> length</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ResourcePublishTransport</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> version</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> ids</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> dirtyIndices</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Uint32Array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> buffers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> TransportBufferDescriptor</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Every descriptor includes the typed-array constructor string, length, and byte offset so consumers can rebuild deterministic views without hard-coded assumptions. Single-threaded presentation (no worker) still goes through the transport builder, but instead of transferring the buffers we hand the pooled typed arrays directly to the UI diff routine, keeping the zero-copy path.</p>
<ul>
<li class=""><strong>Command recorder:</strong> The recorder uses <code>snapshot({ mode: &#x27;recorder&#x27; })</code> before/after command execution to capture deterministic replays; this mode deep-clones the live view so structured cloning succeeds without disturbing the dirty tracking that the presentation layer relies on.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="63-operational-considerations">6.3 Operational Considerations<a href="#63-operational-considerations" class="hash-link" aria-label="Direct link to 6.3 Operational Considerations" title="Direct link to 6.3 Operational Considerations" translate="no">​</a></h3>
<ul>
<li class=""><strong>Deployment</strong>: No specific CI/CD updates required; implementation will be integrated through standard PR workflow.</li>
<li class=""><strong>Telemetry &amp; Observability</strong>: Telemetry events will be emitted for invalid operations, capacity clamping, overflow detection, and dirty tolerance saturation. Metrics will aggregate per-second income/expense totals for diagnostics dashboards.</li>
<li class=""><strong>Security &amp; Compliance</strong>: No security or compliance impacts; all data remains in-memory and under player control.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="7-work-breakdown--delivery-plan">7. Work Breakdown &amp; Delivery Plan<a href="#7-work-breakdown--delivery-plan" class="hash-link" aria-label="Direct link to 7. Work Breakdown &amp; Delivery Plan" title="Direct link to 7. Work Breakdown &amp; Delivery Plan" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="71-issue-map">7.1 Issue Map<a href="#71-issue-map" class="hash-link" aria-label="Direct link to 7.1 Issue Map" title="Direct link to 7.1 Issue Map" translate="no">​</a></h3>
<table><thead><tr><th>Issue Title</th><th>Scope Summary</th><th>Proposed Assignee/Agent</th><th>Dependencies</th><th>Acceptance Criteria</th></tr></thead><tbody><tr><td>feat(core): implement ResourceState struct-of-arrays storage</td><td>Scaffold buffer structs, factory, and façade in <code>packages/core/src/resource-state.ts</code></td><td>Runtime Implementation Agent</td><td>None</td><td>Module checked in with TypeScript interfaces and factory function</td></tr><tr><td>feat(core): add snapshot guard helpers</td><td>Implement <code>createImmutableTypedArrayView</code> wrapper and <code>SNAPSHOT_GUARDS</code> configuration</td><td>Runtime Implementation Agent</td><td>ResourceState scaffolding</td><td>Vitest coverage for guarded and unguarded modes</td></tr><tr><td>feat(core): implement transport buffer pool</td><td>Add <code>TransportBufferPool</code> and <code>ResourcePublishTransport</code> builder</td><td>Runtime Implementation Agent</td><td>ResourceState scaffolding</td><td>Unit tests for pooled buffer reuse and worker/non-worker paths</td></tr><tr><td>feat(core): add save reconciliation helpers</td><td>Implement <code>reconcileSaveAgainstDefinitions</code> and digest emission</td><td>Runtime Implementation Agent</td><td>ResourceState scaffolding</td><td>Unit tests for id matching, version validation, and telemetry</td></tr><tr><td>test(core): comprehensive ResourceState coverage</td><td>Add Vitest tests for all mutation semantics, dirty tracking, and snapshots</td><td>Runtime Implementation Agent</td><td>All ResourceState implementation</td><td>All acceptance criteria pass</td></tr><tr><td>docs: update runtime-command-queue-design references</td><td>Add references to ResourceState contract</td><td>Docs Agent</td><td>ResourceState implementation complete</td><td>Documentation links updated</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="72-milestones">7.2 Milestones<a href="#72-milestones" class="hash-link" aria-label="Direct link to 7.2 Milestones" title="Direct link to 7.2 Milestones" translate="no">​</a></h3>
<ul>
<li class=""><strong>Phase 1</strong>: Core ResourceState implementation (issues 1-4) - 2 weeks</li>
<li class=""><strong>Phase 2</strong>: Testing and documentation (issues 5-6) - 1 week</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="73-coordination-notes">7.3 Coordination Notes<a href="#73-coordination-notes" class="hash-link" aria-label="Direct link to 7.3 Coordination Notes" title="Direct link to 7.3 Coordination Notes" translate="no">​</a></h3>
<ul>
<li class=""><strong>Hand-off Package</strong>: Access to <code>packages/core</code> source code, existing <code>CommandRecorder</code> and <code>immutable-snapshots.ts</code> utilities, design document.</li>
<li class=""><strong>Communication Cadence</strong>: Daily standup updates, PR reviews within 24 hours, escalation path through Runtime Core workstream lead.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="8-agent-guidance--guardrails">8. Agent Guidance &amp; Guardrails<a href="#8-agent-guidance--guardrails" class="hash-link" aria-label="Direct link to 8. Agent Guidance &amp; Guardrails" title="Direct link to 8. Agent Guidance &amp; Guardrails" translate="no">​</a></h2>
<ul>
<li class=""><strong>Context Packets</strong>: Must review <code>docs/idle-engine-design.md</code> §6.2, <code>packages/core/src/runtime-state.ts</code>, <code>packages/core/src/immutable-snapshots.ts</code> before implementation.</li>
<li class=""><strong>Prompting &amp; Constraints</strong>:<!-- -->
<ul>
<li class="">Use conventional commit messages: <code>feat(core): &lt;description&gt;</code></li>
<li class="">All public APIs must include JSDoc comments</li>
<li class="">TypeScript strict mode required</li>
<li class="">No <code>any</code> types permitted</li>
</ul>
</li>
<li class=""><strong>Safety Rails</strong>:<!-- -->
<ul>
<li class="">Do not modify existing save file formats without migration path</li>
<li class="">Do not expose mutable typed arrays through public API</li>
<li class="">Do not skip telemetry emission for validation failures</li>
</ul>
</li>
<li class=""><strong>Validation Hooks</strong>:<!-- -->
<ul>
<li class="">Run <code>npm test</code> before marking task complete</li>
<li class="">Verify no TypeScript errors: <code>npm run type-check</code></li>
<li class="">Ensure coverage threshold maintained: <code>npm run test:coverage</code></li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="9-alternatives-considered">9. Alternatives Considered<a href="#9-alternatives-considered" class="hash-link" aria-label="Direct link to 9. Alternatives Considered" title="Direct link to 9. Alternatives Considered" translate="no">​</a></h2>
<p><strong>Alternative 1: Array-of-structs layout</strong></p>
<ul>
<li class="">Rejected because it would cause poor cache locality during systems iteration</li>
<li class="">Would require full object cloning for snapshots instead of typed array slicing</li>
<li class="">Less friendly to serialization and cross-thread transport</li>
</ul>
<p><strong>Alternative 2: Single-buffered snapshots with deep cloning</strong></p>
<ul>
<li class="">Rejected because <code>O(resourceCount)</code> clones every tick would not scale</li>
<li class="">Would eliminate zero-copy benefits for presentation layer</li>
<li class="">Double buffering provides better performance characteristics</li>
</ul>
<p><strong>Alternative 3: Mutable snapshots with copy-on-read</strong></p>
<ul>
<li class="">Rejected because accidental mutations would corrupt determinism</li>
<li class="">Debugging mutation bugs would be harder than with immutable-by-contract approach</li>
<li class="">Proxy-based guards provide better developer experience</li>
</ul>
<p><strong>Alternative 4: BigInt for resource amounts</strong></p>
<ul>
<li class="">Rejected for initial implementation due to serialization complexity</li>
<li class="">Float64 provides sufficient precision for current content scale</li>
<li class="">Can be reconsidered in future if balance tuning requires larger magnitudes</li>
<li class="">Would require significant changes to math operations and serialization</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="10-testing--validation-plan">10. Testing &amp; Validation Plan<a href="#10-testing--validation-plan" class="hash-link" aria-label="Direct link to 10. Testing &amp; Validation Plan" title="Direct link to 10. Testing &amp; Validation Plan" translate="no">​</a></h2>
<ul>
<li class=""><strong>Unit / Integration</strong>:<!-- -->
<ul>
<li class="">Deterministic preservation of definition-supplied resource order</li>
<li class="">Duplicate id detection and telemetry</li>
<li class="">Initial amount sanitization and capacity clamping</li>
<li class="">Spending failure paths and balance integrity</li>
<li class=""><code>requireIndex</code> and <code>assertValidIndex</code> guards</li>
<li class=""><code>finalizeTick</code> rate conversion and epsilon suppression</li>
<li class=""><code>applyIncome</code>/<code>applyExpense</code> input validation</li>
<li class=""><code>dirtyTolerance</code> override clamping and round-trip</li>
<li class="">Zero-value income/expense handling</li>
<li class="">Dirty index tracking and position map maintenance</li>
<li class="">Snapshot immutability guards</li>
<li class="">Transport buffer pooling and reconstruction</li>
<li class="">Save reconciliation and rehydration</li>
<li class="">Property-based tests (future) for additive/subtractive symmetry</li>
</ul>
</li>
<li class=""><strong>Performance</strong>:<!-- -->
<ul>
<li class="">Benchmark dirty tracking overhead vs full-buffer iteration</li>
<li class="">Profile snapshot generation with varying dirty set sizes</li>
<li class="">Measure transport buffer pooling allocation savings</li>
</ul>
</li>
<li class=""><strong>Tooling / A11y</strong>: N/A (server-side runtime module)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="11-risks--mitigations">11. Risks &amp; Mitigations<a href="#11-risks--mitigations" class="hash-link" aria-label="Direct link to 11. Risks &amp; Mitigations" title="Direct link to 11. Risks &amp; Mitigations" translate="no">​</a></h2>
<table><thead><tr><th>Risk</th><th>Impact</th><th>Probability</th><th>Mitigation</th></tr></thead><tbody><tr><td><strong>Precision drift &amp; magnitude ceiling</strong></td><td>High - Values above 2^53 lose integer precision</td><td>Medium</td><td>Monitor growth curves, plan fixed-point/logarithmic representation for future</td></tr><tr><td><strong>Serialization cost</strong></td><td>Medium - Large typed arrays inflate save size</td><td>Low</td><td>Implement delta-encoding or compression in follow-up</td></tr><tr><td><strong>Publish diff cost</strong></td><td>Medium - Worst-case churn degenerates to full-buffer copies</td><td>Low</td><td>Track telemetry on publish duration, revisit strategy if content scales dramatically</td></tr><tr><td><strong>Content churn</strong></td><td>Medium - New resources require reinitialization</td><td>Medium</td><td>Define migration utilities for save compatibility</td></tr><tr><td><strong>Future threading needs</strong></td><td>Low - Shared buffers would require atomics</td><td>Low</td><td>Document invariants for future extension</td></tr><tr><td><strong>Proxy guard complexity</strong></td><td>Low - Zero-copy proxies must replicate immutability</td><td>Low</td><td>Exhaustive tests for mutator trapping</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="12-rollout-plan">12. Rollout Plan<a href="#12-rollout-plan" class="hash-link" aria-label="Direct link to 12. Rollout Plan" title="Direct link to 12. Rollout Plan" translate="no">​</a></h2>
<ul>
<li class=""><strong>Milestones</strong>:<!-- -->
<ul>
<li class="">Week 1-2: Core implementation (Phase 1)</li>
<li class="">Week 3: Testing and documentation (Phase 2)</li>
<li class="">Week 4: Integration with existing command handlers and systems</li>
</ul>
</li>
<li class=""><strong>Migration Strategy</strong>: No migration required for new implementation; future command handlers will adopt ResourceState API</li>
<li class=""><strong>Communication</strong>: Update team wiki with ResourceState API documentation, announce availability in weekly engineering sync</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="13-open-questions">13. Open Questions<a href="#13-open-questions" class="hash-link" aria-label="Direct link to 13. Open Questions" title="Direct link to 13. Open Questions" translate="no">​</a></h2>
<ul>
<li class="">Should we implement property-based tests for additive/subtractive symmetry in Phase 2 or defer to follow-up?</li>
<li class="">What telemetry aggregation period should be used for per-second income/expense summaries?</li>
<li class="">Should <code>SNAPSHOT_GUARDS</code> default to <code>&#x27;auto&#x27;</code> or <code>&#x27;force-on&#x27;</code> in production builds?</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="14-follow-up-work">14. Follow-Up Work<a href="#14-follow-up-work" class="hash-link" aria-label="Direct link to 14. Follow-Up Work" title="Direct link to 14. Follow-Up Work" translate="no">​</a></h2>
<ul>
<li class="">Implement property-based tests for resource mutation symmetry (deferred from Phase 2)</li>
<li class="">Design fixed-point or logarithmic representation for high-magnitude resources (tracked separately)</li>
<li class="">Implement delta-encoding or compression for save serialization (tracked separately)</li>
<li class="">Update command handlers to use ResourceState API (separate workstream)</li>
<li class="">Extend documentation in <code>docs/runtime-command-queue-design.md</code> with ResourceState references</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="15-references">15. References<a href="#15-references" class="hash-link" aria-label="Direct link to 15. References" title="Direct link to 15. References" translate="no">​</a></h2>
<ul>
<li class=""><code>docs/idle-engine-design.md</code> §6.2 - Original struct-of-arrays commitment</li>
<li class=""><code>packages/core/src/runtime-state.ts</code> - Existing state management helpers</li>
<li class=""><code>packages/core/src/immutable-snapshots.ts</code> - Immutable snapshot utilities</li>
<li class=""><code>docs/automation-system-api.md</code> - Automation state serialization details</li>
<li class=""><code>packages/core/src/progression.ts:138-214</code> - Dual-mode progression snapshot implementation (PR #303)</li>
<li class="">Archived worker harness integration (removed)</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-a--glossary">Appendix A — Glossary<a href="#appendix-a--glossary" class="hash-link" aria-label="Direct link to Appendix A — Glossary" title="Direct link to Appendix A — Glossary" translate="no">​</a></h2>
<table><thead><tr><th>Term</th><th>Definition</th></tr></thead><tbody><tr><td><strong>Struct-of-arrays (SoA)</strong></td><td>Data layout pattern where each attribute is stored in a separate array, improving cache locality for iteration</td></tr><tr><td><strong>Double buffering</strong></td><td>Technique using two buffers (ping-pong) to enable reading from one while writing to the other</td></tr><tr><td><strong>Dirty tracking</strong></td><td>Optimization tracking which resources have changed since last snapshot to minimize delta size</td></tr><tr><td><strong>Epsilon comparison</strong></td><td>Floating-point comparison using tolerance threshold to handle rounding errors</td></tr><tr><td><strong>Typed array</strong></td><td>JavaScript array types (Float64Array, Uint8Array, etc.) providing direct memory access</td></tr><tr><td><strong>Immutable snapshot</strong></td><td>Read-only view of state guaranteed not to change after creation</td></tr><tr><td><strong>Façade pattern</strong></td><td>Structural design pattern providing simplified interface to complex subsystem</td></tr><tr><td><strong>Resource index</strong></td><td>Integer offset into typed arrays for O(1) resource lookup</td></tr><tr><td><strong>Publish buffer</strong></td><td>Double-buffered typed array snapshot exposed to presentation layer</td></tr><tr><td><strong>Recorder mode</strong></td><td>Snapshot mode that deep-clones data for deterministic replay without affecting publish pipeline</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="appendix-b--change-log">Appendix B — Change Log<a href="#appendix-b--change-log" class="hash-link" aria-label="Direct link to Appendix B — Change Log" title="Direct link to Appendix B — Change Log" translate="no">​</a></h2>
<table><thead><tr><th>Date</th><th>Author</th><th>Change Summary</th></tr></thead><tbody><tr><td>2025-10-12</td><td>Original design team</td><td>Initial design document</td></tr><tr><td>2025-12-21</td><td>Claude Opus 4.5</td><td>Migrated to design document template format</td></tr></tbody></table></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_QKxP"><a href="https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/resource-state-storage-design.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_wOWh" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_Basj"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/Idle-Game-Engine/tick-accumulator-coverage-design"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Tick Accumulator Edge Case Coverage</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Idle-Game-Engine/diagnostic-timeline-design"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Diagnostic Timeline Design Document</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_AUZ0 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#document-control" class="table-of-contents__link toc-highlight">Document Control</a></li><li><a href="#1-summary" class="table-of-contents__link toc-highlight">1. Summary</a></li><li><a href="#2-context--problem-statement" class="table-of-contents__link toc-highlight">2. Context &amp; Problem Statement</a></li><li><a href="#3-goals--non-goals" class="table-of-contents__link toc-highlight">3. Goals &amp; Non-Goals</a><ul><li><a href="#goals" class="table-of-contents__link toc-highlight">Goals</a></li><li><a href="#non-goals" class="table-of-contents__link toc-highlight">Non-Goals</a></li></ul></li><li><a href="#4-stakeholders-agents--impacted-surfaces" class="table-of-contents__link toc-highlight">4. Stakeholders, Agents &amp; Impacted Surfaces</a></li><li><a href="#5-current-state" class="table-of-contents__link toc-highlight">5. Current State</a></li><li><a href="#6-proposed-solution" class="table-of-contents__link toc-highlight">6. Proposed Solution</a><ul><li><a href="#61-architecture-overview" class="table-of-contents__link toc-highlight">6.1 Architecture Overview</a></li><li><a href="#62-detailed-design" class="table-of-contents__link toc-highlight">6.2 Detailed Design</a></li><li><a href="#63-operational-considerations" class="table-of-contents__link toc-highlight">6.3 Operational Considerations</a></li></ul></li><li><a href="#7-work-breakdown--delivery-plan" class="table-of-contents__link toc-highlight">7. Work Breakdown &amp; Delivery Plan</a><ul><li><a href="#71-issue-map" class="table-of-contents__link toc-highlight">7.1 Issue Map</a></li><li><a href="#72-milestones" class="table-of-contents__link toc-highlight">7.2 Milestones</a></li><li><a href="#73-coordination-notes" class="table-of-contents__link toc-highlight">7.3 Coordination Notes</a></li></ul></li><li><a href="#8-agent-guidance--guardrails" class="table-of-contents__link toc-highlight">8. Agent Guidance &amp; Guardrails</a></li><li><a href="#9-alternatives-considered" class="table-of-contents__link toc-highlight">9. Alternatives Considered</a></li><li><a href="#10-testing--validation-plan" class="table-of-contents__link toc-highlight">10. Testing &amp; Validation Plan</a></li><li><a href="#11-risks--mitigations" class="table-of-contents__link toc-highlight">11. Risks &amp; Mitigations</a></li><li><a href="#12-rollout-plan" class="table-of-contents__link toc-highlight">12. Rollout Plan</a></li><li><a href="#13-open-questions" class="table-of-contents__link toc-highlight">13. Open Questions</a></li><li><a href="#14-follow-up-work" class="table-of-contents__link toc-highlight">14. Follow-Up Work</a></li><li><a href="#15-references" class="table-of-contents__link toc-highlight">15. References</a></li><li><a href="#appendix-a--glossary" class="table-of-contents__link toc-highlight">Appendix A — Glossary</a></li><li><a href="#appendix-b--change-log" class="table-of-contents__link toc-highlight">Appendix B — Change Log</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/contributor-handbook">Contributor Handbook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Idle Engine.</div></div></div></footer></div>
</body>
</html>