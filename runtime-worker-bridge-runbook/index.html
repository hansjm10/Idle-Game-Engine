<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-runtime-worker-bridge-runbook" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Runtime-&gt;React Worker Bridge Operational Runbook | Idle Engine Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hansjm10.github.io/Idle-Game-Engine/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hansjm10.github.io/Idle-Game-Engine/runtime-worker-bridge-runbook"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Runtime-&gt;React Worker Bridge Operational Runbook | Idle Engine Docs"><meta data-rh="true" name="description" content="Issue: #261"><meta data-rh="true" property="og:description" content="Issue: #261"><link data-rh="true" rel="icon" href="/Idle-Game-Engine/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hansjm10.github.io/Idle-Game-Engine/runtime-worker-bridge-runbook"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/runtime-worker-bridge-runbook" hreflang="en"><link data-rh="true" rel="alternate" href="https://hansjm10.github.io/Idle-Game-Engine/runtime-worker-bridge-runbook" hreflang="x-default"><link rel="stylesheet" href="/Idle-Game-Engine/assets/css/styles.ddf7989c.css">
<script src="/Idle-Game-Engine/assets/js/runtime~main.870228b8.js" defer="defer"></script>
<script src="/Idle-Game-Engine/assets/js/main.f7253bbf.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Idle-Game-Engine/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_li4T" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Idle-Game-Engine/"><div class="navbar__logo"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--light_vaEm"><img src="/Idle-Game-Engine/img/logo.svg" alt="Idle Engine Logo" class="themedComponent_wqtB themedComponent--dark_axH8"></div><b class="navbar__title text--truncate">Idle Engine</b></a><a class="navbar__item navbar__link" href="/Idle-Game-Engine/">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle__Exw colorModeToggle_Lslw"><button class="clean-btn toggleButton_AMBK toggleButtonDisabled_p4Bd" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 lightToggleIcon_p2sk"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 darkToggleIcon_B2qX"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_uZx1 systemToggleIcon_PWgn"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_RKai"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_nqaE"><div class="docsWrapper_CSLE"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sOWX" type="button"></button><div class="docRoot_qxtV"><main class="docMainContainer_tfRv docMainContainerEnhanced_qAvX"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_hyci"><div class="docItemContainer_tcAC"><article><div class="tocCollapsible_WMbj theme-doc-toc-mobile tocMobile_wI3e"><button type="button" class="clean-btn tocCollapsibleButton_rjEa">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Runtime-&gt;React Worker Bridge Operational Runbook</h1></header>
<p>Issue: <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/261" target="_blank" rel="noopener noreferrer" class="">#261</a><br>
<!-- -->Design Source: <a class="" href="/Idle-Game-Engine/runtime-react-worker-bridge-design">runtime-react-worker-bridge-design.md</a> §§3, 6.3, 12</p>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="1-purpose--scope">1. Purpose &amp; Scope<a href="#1-purpose--scope" class="hash-link" aria-label="Direct link to 1. Purpose &amp; Scope" title="Direct link to 1. Purpose &amp; Scope" translate="no">​</a></h2>
<ul>
<li class="">Stabilise day-to-day build, deployment, and troubleshooting for the runtime worker bridge delivered by issues <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/253" target="_blank" rel="noopener noreferrer" class="">#253</a> and <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/254" target="_blank" rel="noopener noreferrer" class="">#254</a>. The implementation lives in <code>packages/shell-web/src/runtime.worker.ts</code> and <code>packages/shell-web/src/modules/worker-bridge.ts</code>.</li>
<li class="">Reinforce the design goals in §3 (deterministic messaging, diagnostics gating, lifecycle hygiene) and the operational guardrails from §6.3 (deployment, observability, security).</li>
<li class="">Provide a single checklist that Presentation Shell and Runtime Core leads can approve before enabling or rolling back the worker bridge.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="2-ownership--review-path">2. Ownership &amp; Review Path<a href="#2-ownership--review-path" class="hash-link" aria-label="Direct link to 2. Ownership &amp; Review Path" title="Direct link to 2. Ownership &amp; Review Path" translate="no">​</a></h2>
<ul>
<li class=""><strong>Primary contacts</strong>: Runtime Core maintainers (command queue invariants) and Presentation Shell lead (React integration). Tag both parties for every runbook or bridge code change—this satisfies the “Guidance reviewed by Runtime Core and Presentation Shell leads” acceptance criterion.</li>
<li class=""><strong>Escalation</strong>: file incidents in the project board (<code>Presentation Shell</code> workstream) and page Runtime Core if determinism or command sequencing is in doubt.</li>
<li class=""><strong>Telemetry routing</strong>: the worker surfaces incidents through <code>globalThis.__IDLE_ENGINE_TELEMETRY__</code> (<code>packages/shell-web/src/modules/worker-bridge.ts:41</code>); coordinate with analytics before mutating that facade.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="3-build--rollout-workflow">3. Build &amp; Rollout Workflow<a href="#3-build--rollout-workflow" class="hash-link" aria-label="Direct link to 3. Build &amp; Rollout Workflow" title="Direct link to 3. Build &amp; Rollout Workflow" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="31-local-build-matrix">3.1 Local build matrix<a href="#31-local-build-matrix" class="hash-link" aria-label="Direct link to 3.1 Local build matrix" title="Direct link to 3.1 Local build matrix" translate="no">​</a></h3>
<ol>
<li class=""><code>pnpm install</code> (repository root) – ensures Vite and shared configs are present.</li>
<li class=""><code>pnpm --filter shell-web dev</code> – spins up the worker-enabled shell at <a href="http://localhost:5173" target="_blank" rel="noopener noreferrer" class="">http://localhost:5173</a> for interactive validation.</li>
<li class=""><code>pnpm build --filter shell-web</code> – produces the production bundle under <code>packages/shell-web/dist/</code>. The build emits a hashed worker artifact (for example <code>dist/assets/runtime.worker-*.js</code>) alongside the main entrypoint; confirm both files exist before promoting a release.</li>
<li class=""><code>pnpm preview --filter shell-web -- --open</code> – optional smoke of the built assets via Vite’s preview server.</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="32-feature-flag-rollout">3.2 Feature flag rollout<a href="#32-feature-flag-rollout" class="hash-link" aria-label="Direct link to 3.2 Feature flag rollout" title="Direct link to 3.2 Feature flag rollout" translate="no">​</a></h3>
<ul>
<li class=""><strong>Release staging</strong>: publish the built assets to your CDN under a canary prefix (e.g. <code>/shell/worker-canary/</code>). Keep the previous non-worker build available so flips are instant.</li>
<li class=""><strong>Flag control</strong>: flip <code>VITE_ENABLE_WORKER_BRIDGE</code> (or <code>ENABLE_WORKER_BRIDGE</code> in non-Vite Node environments) to <code>true</code> to instantiate the worker-backed bridge inside the React shell. Leave the variable unset/<code>false</code> to fall back to the inline legacy bridge implemented in <code>packages/shell-web/src/modules/inline-runtime-worker.ts</code>. Hosts can layer a deployment-level flag such as <code>presentationShell.workerBridge.enabled</code> on top when orchestrating asset rollouts.</li>
<li class=""><strong>Rollback</strong>: disable the flag to fall back to the legacy artifact, or redeploy the last known-good bundle. No code change is required provided both builds remain in storage.</li>
<li class=""><strong>Environment parity</strong>: enable the flag progressively (dev → staging → canary → production). Each promotion should include the validation checklist in Section 5 and sign-off from both leads.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="33-configuration-knobs">3.3 Configuration knobs<a href="#33-configuration-knobs" class="hash-link" aria-label="Direct link to 3.3 Configuration knobs" title="Direct link to 3.3 Configuration knobs" translate="no">​</a></h3>
<ul>
<li class=""><code>VITE_ENABLE_WORKER_BRIDGE</code> / <code>ENABLE_WORKER_BRIDGE</code> – default <code>false</code>. When <code>true</code>, <code>useWorkerBridge</code> spins up the worker in a dedicated thread; when <code>false</code>, it runs the inline legacy runtime.</li>
<li class=""><code>VITE_ENABLE_SOCIAL_COMMANDS</code> / <code>VITE_SOCIAL_SERVICE_BASE_URL</code> – opt-in to social-worker calls; default is disabled (see <code>packages/shell-web/src/modules/social-config.ts</code>).</li>
<li class=""><code>VITE_SHELL_ANALYTICS_ENDPOINT</code> / <code>SHELL_ANALYTICS_ENDPOINT</code> – optional HTTPS endpoint for browser telemetry. When present, the shell analytics facade posts worker errors via <code>navigator.sendBeacon</code> (or fetch fallback); omit to rely on local console output and the <code>idle-engine:telemetry</code> DOM event stream.</li>
<li class=""><code>__IDLE_ENGINE_TELEMETRY__</code> – optional global injected by hosts for telemetry forwarding (errors surfaced through the bridge call this automatically).</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="34-rollout-phases--notes">3.4 Rollout phases &amp; notes<a href="#34-rollout-phases--notes" class="hash-link" aria-label="Direct link to 3.4 Rollout phases &amp; notes" title="Direct link to 3.4 Rollout phases &amp; notes" translate="no">​</a></h3>
<ul>
<li class=""><strong>Phase 1 – Dev canary</strong>: enable <code>VITE_ENABLE_WORKER_BRIDGE=true</code> in local/dev builds, run <code>pnpm lint</code>, <code>pnpm test --filter shell-web</code>, and <code>pnpm build --filter shell-web</code>. Capture results plus owners (Presentation Shell lead, Runtime Core maintainer) in the weekly status update.</li>
<li class=""><strong>Phase 2 – Staging/canary</strong>: promote the worker bundle behind a staging flag, execute the validation checklist in Section 5, and monitor diagnostics/telemetry dashboards for 48 hours. Document contact points for on-call coverage in the rollout notes.</li>
<li class=""><strong>Phase 3 – Production enablement</strong>: flip the production flag, announce availability in the weekly status update, and note the rollback plan (disable <code>VITE_ENABLE_WORKER_BRIDGE</code>) alongside escalation contacts.</li>
<li class="">When drafting rollout notes, include the commands executed above, current flag state, and the runtime/presentation contacts listed in Section 2 so downstream agents can coordinate escalation.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="4-operational-procedures">4. Operational Procedures<a href="#4-operational-procedures" class="hash-link" aria-label="Direct link to 4. Operational Procedures" title="Direct link to 4. Operational Procedures" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="41-worker-lifecycle">4.1 Worker lifecycle<a href="#41-worker-lifecycle" class="hash-link" aria-label="Direct link to 4.1 Worker lifecycle" title="Direct link to 4.1 Worker lifecycle" translate="no">​</a></h3>
<ul>
<li class=""><strong>Instantiation</strong>: <code>useWorkerBridge()</code> (React hook) spins up the worker via <code>new Worker(new URL(&#x27;../runtime.worker.ts&#x27;, import.meta.url), { type: &#x27;module&#x27; })</code> and returns a singleton bridge (<code>packages/shell-web/src/modules/worker-bridge.ts:604-623</code>).</li>
<li class=""><strong>Handshake</strong>: the worker posts a <code>READY</code> message once initialised (<code>packages/shell-web/src/runtime.worker.ts:877</code>). Clients must <code>await bridge.awaitReady()</code> before sending commands; messages issued earlier are queued.</li>
<li class=""><strong>Session restore</strong>: <code>bridge.restoreSession()</code> forwards a <code>RESTORE_SESSION</code> envelope and defers command flush until <code>SESSION_RESTORED</code> arrives. Commands sent during restore are stored and replayed automatically (<code>runtime.worker.ts:195-223</code>, <code>worker-bridge.ts:150-188</code>).</li>
<li class=""><strong>Disposal</strong>: the hook’s <code>useEffect</code> unregisters listeners and calls <code>bridge.dispose()</code> on unmount, preventing worker leaks (<code>worker-bridge.ts:614-622</code>). Always unmount providers during route transitions to avoid stray workers.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="42-command-channel">4.2 Command channel<a href="#42-command-channel" class="hash-link" aria-label="Direct link to 4.2 Command channel" title="Direct link to 4.2 Command channel" translate="no">​</a></h3>
<ul>
<li class="">Commands must include a monotonic <code>issuedAt</code> (usually <code>performance.now()</code>). The worker drops stale envelopes and emits <code>STALE_COMMAND</code> errors (<code>runtime.worker.ts:712-735</code>). React clients should reuse <code>bridge.sendCommand</code> which stamps the fields correctly.</li>
<li class="">The worker enqueues everything at <code>CommandPriority.PLAYER</code>, guarding against privilege escalation across the bridge (<code>runtime.worker.ts:759-770</code>).</li>
<li class="">Social commands remain behind <code>VITE_ENABLE_SOCIAL_COMMANDS</code> and proxy through fetch helpers (<code>runtime.worker.ts:240-520</code>). Unsupported kinds throw <code>WorkerBridgeSocialCommandError</code>.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="43-diagnostics-opt-in">4.3 Diagnostics opt-in<a href="#43-diagnostics-opt-in" class="hash-link" aria-label="Direct link to 4.3 Diagnostics opt-in" title="Direct link to 4.3 Diagnostics opt-in" translate="no">​</a></h3>
<ul>
<li class="">Call <code>bridge.enableDiagnostics()</code> to subscribe; pair it with <code>bridge.onDiagnosticsUpdate(handler)</code> to receive <code>DiagnosticTimelineResult</code> deltas. Updates throttle automatically and include dropped-entry counters (<code>runtime.worker.ts:90-118</code>).</li>
<li class="">Disable streaming via <code>bridge.disableDiagnostics()</code> and <code>bridge.offDiagnosticsUpdate(handler)</code> to reduce noise. Diagnostics are opt-in by default to preserve the main-thread budget (§6.3).</li>
<li class="">The shell now auto-installs <code>packages/shell-web/src/modules/shell-analytics.ts</code>, wiring <code>__IDLE_ENGINE_TELEMETRY__.recordError</code> to the configured analytics transport and dispatching the <code>idle-engine:telemetry</code> DOM event. Hosts can still override the global to fan out or enrich telemetry; when doing so, delegate back to the default facade to keep dashboards in sync.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="44-readyerror-signalling">4.4 READY/ERROR signalling<a href="#44-readyerror-signalling" class="hash-link" aria-label="Direct link to 4.4 READY/ERROR signalling" title="Direct link to 4.4 READY/ERROR signalling" translate="no">​</a></h3>
<ul>
<li class="">Monitor the console for <code>[runtime.worker]</code> warnings. Errors propagate through <code>bridge.onError</code> callbacks with typed detail (<code>RuntimeWorkerErrorDetails</code>) and request IDs for social commands.</li>
<li class="">Common codes:<!-- -->
<ul>
<li class=""><code>INVALID_COMMAND_PAYLOAD</code> – schema/version mismatch or malformed payload.</li>
<li class=""><code>SCHEMA_VERSION_MISMATCH</code> – client bundle using different <code>WORKER_MESSAGE_SCHEMA_VERSION</code> (currently <code>3</code>).</li>
<li class=""><code>RESTORE_FAILED</code> – session payload rejected; inspect <code>.details</code> for reconciliation logs.</li>
<li class=""><code>STALE_COMMAND</code> – command <code>issuedAt</code> &lt; last accepted; ensure callers use the bridge helpers.</li>
<li class=""><code>SNAPSHOT_FAILED</code> – session snapshot capture failed; see §4.5 for details.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_EdDC" id="45-session-snapshots">4.5 Session snapshots<a href="#45-session-snapshots" class="hash-link" aria-label="Direct link to 4.5 Session snapshots" title="Direct link to 4.5 Session snapshots" translate="no">​</a></h3>
<ul>
<li class=""><strong>Capture performance</strong>: Snapshot serialization is <strong>synchronous</strong> and blocks the worker tick loop. The worker captures the current runtime state via <code>exportForSave()</code> and emits a <code>SESSION_SNAPSHOT</code> message with the complete payload (state, metadata, content digest).</li>
<li class=""><strong>Expected snapshot sizes</strong>:<!-- -->
<ul>
<li class="">Small games (~10 resources): <strong>1-5 KB</strong></li>
<li class="">Medium games (~50 resources): <strong>5-25 KB</strong></li>
<li class="">Large games (~200+ resources): <strong>25-100 KB</strong></li>
<li class="">Resource count is the primary driver of snapshot size. Monitor <code>worker.session_snapshot_captured</code> telemetry events for <code>snapshotBytes</code> and <code>resourceCount</code> to track growth trends.</li>
</ul>
</li>
<li class=""><strong>Capture duration</strong>: Typically <strong>&lt;5ms</strong> for small-to-medium games. Snapshots blocking longer than <strong>&gt;10ms</strong> may indicate state bloat or serialization bottlenecks; consider profiling <code>exportForSave()</code>.</li>
<li class=""><strong>Concurrency behavior</strong>:<!-- -->
<ul>
<li class="">Multiple snapshot requests are processed <strong>sequentially</strong> in message order. Each snapshot captures the state at its processing time (same <code>workerStep</code> if no ticks occur between requests).</li>
<li class="">Snapshots are <strong>gated during session restoration</strong> (<code>RESTORE_IN_PROGRESS</code> check at <code>runtime.worker.ts:816</code>) to avoid capturing inconsistent state. Requests during restore fail immediately with <code>SNAPSHOT_FAILED</code> error code and <code>details.reason: &#x27;RESTORE_IN_PROGRESS&#x27;</code>. Wait for <code>SESSION_RESTORED</code> before requesting snapshots.</li>
</ul>
</li>
<li class=""><strong>Telemetry monitoring</strong>:<!-- -->
<ul>
<li class=""><strong>Success</strong>: <code>worker.session_snapshot_captured</code> events include <code>snapshotBytes</code>, <code>snapshotKB</code>, <code>workerStep</code>, <code>reason</code>, <code>requestId</code>, <code>resourceCount</code>. Use these metrics to establish baselines and detect anomalies (e.g., sudden size spikes).</li>
<li class=""><strong>Failure</strong>: <code>worker.session_snapshot_failed</code> events include <code>reason</code> (<code>&#x27;EXPORT_FAILED&#x27;</code>), <code>errorMessage</code>, <code>workerStep</code>, <code>requestId</code>. Investigate export failures for corrupted state or serialization bugs.</li>
<li class=""><strong>Blocked</strong>: <code>worker.session_snapshot_blocked</code> warnings fire when snapshots are requested during restoration (<code>reason: &#x27;RESTORE_IN_PROGRESS&#x27;</code>). This is expected behavior; ensure callers wait for <code>SESSION_RESTORED</code>.</li>
</ul>
</li>
<li class=""><strong>Error details structure</strong>:<!-- -->
<ul>
<li class=""><code>SNAPSHOT_FAILED</code> errors include structured <code>details</code>:<!-- -->
<ul>
<li class=""><code>reason</code>: <code>&#x27;RESTORE_IN_PROGRESS&#x27;</code> (blocked during restore) or <code>&#x27;EXPORT_FAILED&#x27;</code> (serialization error)</li>
<li class=""><code>workerStep</code>: Current runtime step when the error occurred</li>
<li class="">Additional fields from the underlying error (via <code>extractErrorDetails()</code>)</li>
</ul>
</li>
</ul>
</li>
<li class=""><strong>Troubleshooting</strong>:<!-- -->
<ul>
<li class="">If snapshots consistently fail with <code>&#x27;EXPORT_FAILED&#x27;</code>, check for circular references or non-serializable objects in game state.</li>
<li class="">If snapshot sizes grow unexpectedly, audit resource definitions for memory leaks (e.g., unbounded arrays in modifiers).</li>
<li class="">If snapshots block the tick loop (&gt;10ms), consider deferring capture to idle periods or implementing incremental serialization.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="5-validation-checklist">5. Validation Checklist<a href="#5-validation-checklist" class="hash-link" aria-label="Direct link to 5. Validation Checklist" title="Direct link to 5. Validation Checklist" translate="no">​</a></h2>
<p>Run these commands from the repository root before promoting or flipping the feature flag:</p>
<div class="language-bash codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-bash codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token plain">pnpm lint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pnpm test --filter shell-web</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pnpm build --filter shell-web</span><br></span></code></pre></div></div>
<ul>
<li class="">Attach logs (including the final <code>vitest-llm-reporter</code> JSON) to the release note.</li>
<li class="">If UI flows change (e.g., diagnostics panel, social tooling), run <code>pnpm test:a11y</code> and capture any residual gaps in the deployment summary.</li>
<li class="">Verify <code>packages/shell-web/dist/index.html</code> references the hashed worker asset; mismatches indicate a stale build.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="6-troubleshooting-playbook">6. Troubleshooting Playbook<a href="#6-troubleshooting-playbook" class="hash-link" aria-label="Direct link to 6. Troubleshooting Playbook" title="Direct link to 6. Troubleshooting Playbook" translate="no">​</a></h2>
<table><thead><tr><th>Symptom</th><th>Likely Cause</th><th>Checks &amp; Fix</th></tr></thead><tbody><tr><td>No <code>READY</code> message, <code>awaitReady()</code> never resolves</td><td>Worker asset missing or blocked by CSP</td><td>Confirm <code>dist/assets/runtime.worker-*.js</code> exists and is served with <code>Content-Type: text/javascript</code>; inspect network panel for 404/blocked requests.</td></tr><tr><td><code>RESTORE_FAILED</code> errors on boot</td><td>Serialized state incompatible with runtime or corrupted payload</td><td>Capture <code>error.details</code> and rerun <code>pnpm test --filter shell-web --runInBand</code> to reproduce with fixture saves. Validate content digests before calling <code>restoreSession</code>.</td></tr><tr><td>Commands silently dropped</td><td>Non-monotonic <code>issuedAt</code> or commands queued during restore</td><td>Ensure callers await <code>bridge.awaitReady()</code> and reuse <code>sendCommand</code>. Monitor worker warnings for <code>Dropping stale command</code>.</td></tr><tr><td>Diagnostics callbacks never fire</td><td><code>enableDiagnostics</code> not invoked or subscription removed</td><td>Confirm subscription sequence (enable → onDiagnosticsUpdate) and ensure diagnostics remains enabled in the worker. Remember diagnostics are disabled if the bridge disposes between renders.</td></tr><tr><td>Worker leaks after navigation</td><td>Hook unmounted without disposing or multiple bridges instantiated</td><td>Verify only one <code>useWorkerBridge</code> consumer is active; ensure providers unmount on route changes. Use React DevTools to confirm no lingering bridge instance.</td></tr><tr><td>Social commands reject with <code>&quot;Social commands are disabled in this shell&quot;</code> / worker error code <code>SOCIAL_COMMANDS_DISABLED</code></td><td><code>VITE_ENABLE_SOCIAL_COMMANDS</code> not set in the build environment</td><td>Enable the env var (or launch flag) and redeploy; social command support stays off by default.</td></tr><tr><td><code>SNAPSHOT_FAILED</code> with <code>reason: &#x27;RESTORE_IN_PROGRESS&#x27;</code></td><td>Snapshot requested during active session restoration</td><td>Wait for <code>SESSION_RESTORED</code> message before requesting snapshots. Check telemetry for <code>worker.session_snapshot_blocked</code> warnings. Normal behavior when snapshots race with restore operations.</td></tr><tr><td><code>SNAPSHOT_FAILED</code> with <code>reason: &#x27;EXPORT_FAILED&#x27;</code></td><td>State serialization error (circular refs, non-serializable objects)</td><td>Inspect <code>error.details</code> for the underlying cause. Check for circular references in game state or modifiers. Review resource definitions for objects that can&#x27;t be JSON-serialized.</td></tr><tr><td>Snapshot sizes unexpectedly large (&gt;100 KB)</td><td>State bloat or memory leaks in resource modifiers</td><td>Monitor <code>worker.session_snapshot_captured</code> telemetry for <code>snapshotBytes</code> and <code>resourceCount</code>. Audit resource definitions for unbounded arrays or large data structures. Profile <code>exportForSave()</code> to identify serialization bottlenecks.</td></tr><tr><td>Snapshots block worker tick loop (&gt;10ms)</td><td>Large game state or slow serialization</td><td>Check <code>worker.session_snapshot_captured</code> telemetry for capture duration. Consider deferring snapshots to idle periods or implementing incremental serialization. Profile <code>exportForSave()</code> for performance bottlenecks.</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="7-verification-artifacts">7. Verification Artifacts<a href="#7-verification-artifacts" class="hash-link" aria-label="Direct link to 7. Verification Artifacts" title="Direct link to 7. Verification Artifacts" translate="no">​</a></h2>
<ul>
<li class="">Automated coverage: <code>packages/shell-web/src/runtime.worker.test.ts</code> (handshake, diagnostics, command validation) and <code>packages/shell-web/src/modules/worker-bridge.test.ts</code> (bridge queueing, disposal, social command gating). These correspond to implementations expected by issues #253 and #254.</li>
<li class="">Manual smoke (record in release notes):<!-- -->
<ol>
<li class="">Launch <code>pnpm --filter shell-web dev</code>, open <a href="http://localhost:5173" target="_blank" rel="noopener noreferrer" class="">http://localhost:5173</a>, and confirm commands increment the runtime step counter.</li>
<li class="">Toggle diagnostics via DevTools snippet (run after the shell mounts):<!-- -->
<div class="language-js codeBlockContainer_b5Q5 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_yI8N"><pre tabindex="0" class="prism-code language-js codeBlock_DEW9 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_eNcQ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> bridge </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">__IDLE_WORKER_BRIDGE__</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">bridge</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Worker bridge has not initialised yet&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> bridge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">awaitReady</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bridge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">enableDiagnostics</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bridge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">onDiagnosticsUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">log</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<!-- -->Ensure console prints deltas and no dropped-entry spikes after idling 30s. Call <code>bridge.disableDiagnostics()</code> when finished.</li>
<li class="">Toggle <code>VITE_ENABLE_WORKER_BRIDGE</code> (or deployment-level equivalent) off/on in staging to validate both the worker path and the inline fallback before promoting to production.</li>
</ol>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_EdDC" id="8-follow-up--assumptions">8. Follow-Up &amp; Assumptions<a href="#8-follow-up--assumptions" class="hash-link" aria-label="Direct link to 8. Follow-Up &amp; Assumptions" title="Direct link to 8. Follow-Up &amp; Assumptions" translate="no">​</a></h2>
<ul>
<li class=""><strong>Flag retirement</strong>: plan to remove <code>VITE_ENABLE_WORKER_BRIDGE</code> once rollout Phase 3 completes and production monitoring stays green; track the cleanup under issue #262 and delete the inline fallback at the same time.</li>
<li class=""><strong>Persistence integration</strong>: coordinate with issue #258 (Worker↔Shell persistence handoff) before enabling offline progression; the runbook will require updates once snapshot flows ship.</li>
<li class=""><strong>Telemetry completeness</strong>: telemetry sink delivered in issue <a href="https://github.com/hansjm10/Idle-Game-Engine/issues/267" target="_blank" rel="noopener noreferrer" class="">#267</a>. Configure <code>VITE_SHELL_ANALYTICS_ENDPOINT</code> (or <code>SHELL_ANALYTICS_ENDPOINT</code>) per environment and monitor the <code>idle-engine:telemetry</code> event stream for local validation before flipping production flags.</li>
</ul>
<p>Maintain this runbook alongside bridge code changes—update sections 3–6 whenever the worker protocol, diagnostics behaviour, or deployment strategy evolves. Tag both leads for review to keep operational guidance authoritative.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_QKxP"><a href="https://github.com/hansjm10/Idle-Game-Engine/edit/main/docs/../../docs/runtime-worker-bridge-runbook.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_wOWh" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_Basj"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_AUZ0 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-purpose--scope" class="table-of-contents__link toc-highlight">1. Purpose &amp; Scope</a></li><li><a href="#2-ownership--review-path" class="table-of-contents__link toc-highlight">2. Ownership &amp; Review Path</a></li><li><a href="#3-build--rollout-workflow" class="table-of-contents__link toc-highlight">3. Build &amp; Rollout Workflow</a><ul><li><a href="#31-local-build-matrix" class="table-of-contents__link toc-highlight">3.1 Local build matrix</a></li><li><a href="#32-feature-flag-rollout" class="table-of-contents__link toc-highlight">3.2 Feature flag rollout</a></li><li><a href="#33-configuration-knobs" class="table-of-contents__link toc-highlight">3.3 Configuration knobs</a></li><li><a href="#34-rollout-phases--notes" class="table-of-contents__link toc-highlight">3.4 Rollout phases &amp; notes</a></li></ul></li><li><a href="#4-operational-procedures" class="table-of-contents__link toc-highlight">4. Operational Procedures</a><ul><li><a href="#41-worker-lifecycle" class="table-of-contents__link toc-highlight">4.1 Worker lifecycle</a></li><li><a href="#42-command-channel" class="table-of-contents__link toc-highlight">4.2 Command channel</a></li><li><a href="#43-diagnostics-opt-in" class="table-of-contents__link toc-highlight">4.3 Diagnostics opt-in</a></li><li><a href="#44-readyerror-signalling" class="table-of-contents__link toc-highlight">4.4 READY/ERROR signalling</a></li><li><a href="#45-session-snapshots" class="table-of-contents__link toc-highlight">4.5 Session snapshots</a></li></ul></li><li><a href="#5-validation-checklist" class="table-of-contents__link toc-highlight">5. Validation Checklist</a></li><li><a href="#6-troubleshooting-playbook" class="table-of-contents__link toc-highlight">6. Troubleshooting Playbook</a></li><li><a href="#7-verification-artifacts" class="table-of-contents__link toc-highlight">7. Verification Artifacts</a></li><li><a href="#8-follow-up--assumptions" class="table-of-contents__link toc-highlight">8. Follow-Up &amp; Assumptions</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/Idle-Game-Engine/contributor-handbook">Contributor Handbook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/hansjm10/Idle-Game-Engine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_cYRj"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Idle Engine.</div></div></div></footer></div>
</body>
</html>